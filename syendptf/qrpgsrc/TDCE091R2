********************************************************************
      * RETTINGER I DETTE PROGRAM:
PTFnr:*Sek Sig Vers  Beskrivelse...........................
""""""*"""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""
12XXX * 01 CB  PTF12  Divide by zero
12XXX * 02 YBC PTF12  Mulighet for ikke slå samme linjer fra fortolling
12XXX * 03 YBC PTF12  Test dato ved henting av kurs
12XXX * 04 YBC PTF12  Oppdater antall kolli fra DKEH til DKXH
********************************************************************
      *********************************************************************
      *
CRTPG+*  CRTPGM SYSPED/TDCE091R2 MODULE(*LIBL/TDCE091R2 *LIBL/INCGI)
CRTPGM*        ACTGRP(*NEW) AUT(*USE)
      *
      *********************************************************************
      /copy SYSPEDS/qrpgsrcpy,hspecs
      /copy SYSPEDS/qrpgsrcpy,hspecsbnd
N04  FDKXH      UF   E           K DISK
     FDKEH      IF   E           K DISK
     F                                     PREFIX(Y)
     FDKEV      IF   E           K DISK
     FDKXV      IF A E           K DISK
     F                                     PREFIX(X)
     FDKXV01    IF   E           K DISK
     F                                     PREFIX(Z)
     F                                     RENAME(DKXVR:DKXVR2)
     FDKXVAM    IF A E             DISK
     F                                     PREFIX(X)
     FDKTARD    IF   E           K DISK
     FDKTVK     IF   E           K DISK
      *--------------------------------------------------------------------
      * Variables common to all CGIs
      *--------------------------------------------------------------------
      /copy SYSPEDS/qrpgsrcpy,prototypeb
      /copy SYSPEDS/qrpgsrcpy,usec
      /copy SYSPEDS/qrpgsrcpy,variables3
     D TVAVD           S              4S 0
     D TVTDN           S              7S 0
     D DKEH_SYAV       S              4S 0
     D DKEH_SYOP       S              7S 0
     D W70             S              7S 0
     D W74             S              7S 4

     D                 DS
     D  W10                    1     10
     D  W10B                   9     10
     D  W8                     1      8
     D  W6                     1      6

     C                   EXSR      INIT

     C                   EXSR      TEST
     C                   EVAL      *INLR=*ON
      *********************************************************
     C     INIT          BEGSR
      *********************************************************
     C     *ENTRY        PLIST
     C                   PARM                    A                 4
     C                   PARM                    B                 7
     C                   PARM                    C                 4
     C                   PARM                    D                 7
     C                   EVAL      TVAVD     = c2n2(A)
     C                   EVAL      TVTDN     = c2n2(B)
     C                   EVAL      DKEH_SYAV = c2n2(C)
     C                   EVAL      DKEH_SYOP = c2n2(D)

     C     DKXVKEY       KLIST
     C                   KFLD                    TVAVD
     C                   KFLD                    TVTDN
     C     DKXVKEY2      KLIST
     C                   KFLD                    TVAVD
     C                   KFLD                    TVTDN
     C                   KFLD                    TVLI
     C     *LIKE         DEFINE    XTVLI         TVLI
     C                   EVAL      TVLI=1
     C     DKEHKEY       KLIST
     C                   KFLD                    DKEH_SYAV
     C                   KFLD                    DKEH_SYOP

N03  C                   CALL      'SYGE15C'
N03  C                   PARM                    WDT               8
N03  C                   PARM                    WTM               6
N03  C                   MOVEL     WDT           XDATO             8 0

     C                   ENDSR
      *______________________________________________________
      * TEST                                             TEST
      *""""""""""""""""""""""""""""""""""""""""""""""""""""""
     C     TEST          BEGSR
     C     DKEHKEY       CHAIN     DKEH                               55
     C  N55              EXSR      SRA
     C                   ENDSR
      *______________________________________________________
      * Add                                               SRA
      *""""""""""""""""""""""""""""""""""""""""""""""""""""""
     C     SRA           BEGSR
      * Hitta høgsta linjenummret i NCTS export varuposter
     C                   EVAL      *IN51=*OFF
     C                   EVAL      TVLI=0
     C     DKXVKEY2      SETLL     DKXV01
     C     DKXVKEY       READE     DKXV01                                 51
N04   *
N04  C     DKXVKEY       CHAIN     DKXH                               33
N04  C                   IF        *IN33 = *OFF
N04  C                   IF        *IN51
N04   * INGEN NCTS-LINJE -> OPPDATER KOLLI FRA EKSPORT TIL NCTS
N04  C                   EVAL      THNTK = YDKEH_06
N04  C                   ELSE
N04   * NCTS-LINJE -> LEGG KOLLI FRA EKSPORT TIL NCTS
N04  C                   EVAL      THNTK = THNTK + YDKEH_06
N04  C                   END
N04  C                   UPDATE    DKXHR
N04  C                   END
N04   *
     C     *IN51         DOWEQ     *OFF
     C                   IF        ZTVLI > TVLI
     C                   EVAL      TVLI=ZTVLI
     C                   ENDIF
     C     DKXVKEY       READE     DKXV01                                 51
     C                   ENDDO
     C                   ADD       1             TVLI
      * Læs færsta varuposten från exportangivelsen før att få varekode
     C                   EVAL      *IN52=*OFF
     C     DKEHKEY       SETLL     DKEV
     C     DKEHKEY       READE     DKEV                                   52
      * Skriv till huvudfil
     C                   CLEAR                   DKXVR
     C                   CLEAR                   DKXVAMR

     C                   EVAL      XTVAVD    = TVAVD
     C                   EVAL      XTVTDN    = TVTDN
     C                   EVAL      XTVLI     = TVLI

     C                   EVAL      XDKXV_331 = DKEV_331
     C                   EVAL      W8        = DKEV_331
     C                   MOVE      W6            XTVVNT
     C                   EVAL      XTVVT     = DKEV_315

     C                   EVAL      XTVALK    = 'DK'
     C                   EVAL      XTVBLK    = YDKEH_17A
     C                   EVAL      XTVDTY    = '830'
     C                   EVAL      XTVDREF   = YDKEH_MRN
     C                   EVAL      XTVAVD2   = DKEH_SYAV
     C                   EVAL      XTVTDN2   = DKEH_SYOP
     C                   EVAL      XTVMN     = DKEV_311
     C                   EVAL      XTVEH     = DKEV_314
     C                   EVAL      XTVNT     = YDKEH_06
     C                   EVAL      XTVLN     = TVLI

     C                   IF        XTVLI=1
     C                   EVAL      XTVTLO = 'DG2  '
     C                   ENDIF
N02
N02  C     DKEHKEY       READE     DKEV                                   52
N02  C                   IF        *IN52 = *OFF                                 Flere linjer
N02  C*                  IF        *IN52 AND *IN52 = *OFF                       Av/på sammenslåing
N02  C                   EXSR      SRB
N02  C                   GOTO      SLSRA
N02  C*                  END
N02  C                   END

     C                   EVAL      XDKXV_221 =YDKEH_221
     C                   EVAL      XDKXV_222 =YDKEH_222
     C                   EVAL      *IN52=*OFF
     C                   EVAL      *IN31=*OFF
     C     DKEHKEY       SETLL     DKEV
     C     DKEHKEY       READE     DKEV                                   52
     C     *IN52         DOWEQ     *OFF
     C                   ADD       DKEV_35       XTVVKTB
     C                   ADD       DKEV_38       XTVVKTN
     C                   IF        DKEV_37 <> '1000000'
     C                   EVAL      *IN31=*ON
     C                   ENDIF
     C     DKEHKEY       READE     DKEV                                   52
     C                   ENDDO
     C                   IF        *IN31
     C                   EVAL      XTVDK=*BLANKS
     C                   ELSE
     C                   EVAL      XTVDK='T2   '
     C                   ENDIF
     C                   EXSR      SRAA
     C                   WRITE     DKXVR
      * Skriv till tillæggsfil
     C                   EVAL      XTVKNS   = YDKEH_AVKN
     C                   EVAL      XTVNAS   = YDKEH_02B
     C                   EVAL      XTVADS1  = YDKEH_02C
     C                   EVAL      XTVPNS   = YDKEH_02D
     C                   EVAL      XTVPSS   = YDKEH_02E
     C                   EVAL      XTVLKS   = 'DK'
     C                   EVAL      XTVTINS  = YDKEH_02A

     C                   EVAL      XTVKNK   = YDKEH_MOKN
     C                   EVAL      XTVNAK   = YDKEH_08B
     C                   EVAL      XTVADK1  = YDKEH_08C
     C                   EVAL      XTVPNK   = YDKEH_08D
     C                   EVAL      XTVPSK   = YDKEH_08E
     C                   EVAL      XTVLKK   = YDKEH_17A
     C                   EVAL      XTVTINK  = YDKEH_08A
     C                   WRITE     DKXVAMR
N02  C     SLSRA         TAG
     C                   ENDSR
      *______________________________________________________
      * Regn ut avgifter                                SRAA
      *""""""""""""""""""""""""""""""""""""""""""""""""""""""
     C     SRAA          BEGSR
     C                   EVAL      W10B='00'
     C                   MOVE      W10           B10              10
     C     B10           CHAIN     DKTARD                             61
     C  N61XDKXV_221     CHAIN     DKTVK                              62
N03  C                   IF        *IN61 = *OFF
N03  C                   DOW       *IN62 = *OFF
N03  C                   IF        DKVK_DTS <= XDATO AND DKVK_DTE >= XDATO
N03  C                   LEAVE
N03  C                   END
N03  C     XDKXV_221     READE     DKTVK                                  62
N03  C                   ENDDO
N03  C                   END
N03   *
     C                   IF        *IN61=*OFF

     C                   EVAL      W70 = *ZEROS
     C                   IF        *IN62=*OFF
     C                   EVAL      W70 = c2n2(DKTARD05)
     C                   ENDIF
     C                   IF        W70 > 0
     C                   EVAL      W74 = W70 / 10000
     C                   ENDIF

     C*                  IF        W74 > 0

     C                   EVAL      XDKXV_221B=DKVK_KRS
     C                   EVAL      XDKXV_221C=DKVK_OMR
S01  C*                  EVAL      XDKXV_222B=(XDKXV_222*XDKXV_221C)/XDKXV_221C
N01  C     XDKXV_221C    ifne      0
S02  C*                  EVAL      XDKXV_222B=(XDKXV_222*XDKXV_221C)/XDKXV_221C
N02  C                   EVAL      XDKXV_222B=(XDKXV_222*XDKXV_221B)/XDKXV_221C
N01  c                   else
N01  c                   eval      XDKXV_222B=0
N01  c                   end
     C                   EVAL      XDKXV_46=XDKXV_222B * W74
     C                   EVAL      XDKXV_42B=XDKXV_46 * 0,25
     C                   EVAL      XDKXV_42C=XDKXV_222B + XDKXV_46 + XDKXV_42B

     C*                  ENDIF

     C                   ENDIF
     C                   ENDSR
N02   *______________________________________________________
N02   * Add                                               SRB
N02   *""""""""""""""""""""""""""""""""""""""""""""""""""""""
N02  C     SRB           BEGSR
N02
N02   * Skriv till tillæggsfil
N02  C                   EVAL      XTVKNS   = YDKEH_AVKN
N02  C                   EVAL      XTVNAS   = YDKEH_02B
N02  C                   EVAL      XTVADS1  = YDKEH_02C
N02  C                   EVAL      XTVPNS   = YDKEH_02D
N02  C                   EVAL      XTVPSS   = YDKEH_02E
N02  C                   EVAL      XTVLKS   = 'DK'
N02  C                   EVAL      XTVTINS  = YDKEH_02A
N02
N02  C                   EVAL      XTVKNK   = YDKEH_MOKN
N02  C                   EVAL      XTVNAK   = YDKEH_08B
N02  C                   EVAL      XTVADK1  = YDKEH_08C
N02  C                   EVAL      XTVPNK   = YDKEH_08D
N02  C                   EVAL      XTVPSK   = YDKEH_08E
N02  C                   EVAL      XTVLKK   = YDKEH_17A
N02  C                   EVAL      XTVTINK  = YDKEH_08A
N02
N02  C                   EVAL      XDKXV_221 = YDKEH_221
N02
N02  C     DKEHKEY       SETLL     DKEV
N02  C     DKEHKEY       READE     DKEV                                   52
N02  C     *IN52         DOWEQ     *OFF
N02  C                   EVAL      XDKXV_331 = DKEV_331
N02  C                   EVAL      W8        = DKEV_331
N02  C                   MOVE      W6            XTVVNT
N02  C                   EVAL      XTVVT     = DKEV_315
N02  C                   EVAL      XDKXV_222 = DKEV_42
N02  C                   EVAL      XTVVKTB = DKEV_35
N02  C                   EVAL      XTVVKTN = DKEV_38
N02  C                   EVAL      XTVMN = DKEV_311
N02  C                   EVAL      XTVEH = DKEV_314
N02  C                   EVAL      XTVNT = DKEV_313
N02  C                   IF        DKEV_37 <> '1000000'
N02  C                   EVAL      XTVDK=*BLANKS
N02  C                   ELSE
N02  C                   EVAL      XTVDK='T2   '
N02  C                   ENDIF
N02  C                   EXSR      SRBB
N02  C                   WRITE     DKXVR
N02  C                   WRITE     DKXVAMR
N02  C                   ADD       1             TVLI
N02  C                   EVAL      XTVLI = TVLI
N02  C     DKEHKEY       READE     DKEV                                   52
N02  C                   ENDDO
N02   *
N02  C                   ENDSR
N02   *______________________________________________________
N02   * Regn ut avgifter                                SRBB
N02   *""""""""""""""""""""""""""""""""""""""""""""""""""""""
N02  C     SRBB          BEGSR
N02
N02  C                   EVAL      W10B='00'
N02  C                   MOVE      W10           B10              10
N02  C     B10           CHAIN     DKTARD                             61
N02  C  N61XDKXV_221     CHAIN     DKTVK                              62
N03  C                   IF        *IN61 = *OFF
N03  C                   DOW       *IN62 = *OFF
N03  C                   IF        DKVK_DTS <= XDATO AND DKVK_DTE >= XDATO
N03  C                   LEAVE
N03  C                   END
N03  C     XDKXV_221     READE     DKTVK                                  62
N03  C                   ENDDO
N03  C                   END
N03   *
N02  C                   IF        *IN61=*OFF
N02
N02  C                   EVAL      W70 = *ZEROS
N02  C                   IF        *IN62=*OFF
N02  C                   EVAL      W70 = c2n2(DKTARD05)
N02  C                   ENDIF
N02  C                   IF        W70 > 0
N02  C                   EVAL      W74 = W70 / 10000
N02  C                   ENDIF
N02
N02  C                   EVAL      XDKXV_221B=DKVK_KRS
N02  C                   EVAL      XDKXV_221C=DKVK_OMR
N02  C     XDKXV_221C    ifne      0
N02  C                   EVAL      XDKXV_222B=(DKEV_42*XDKXV_221B)/XDKXV_221C
N02  C                   else
N02  C                   eval      XDKXV_222B=0
N02  C                   end
N02  C                   EVAL      XDKXV_46=XDKXV_222B * W74
N02  C                   EVAL      XDKXV_42B=XDKXV_46 * 0,25
N02  C                   EVAL      XDKXV_42C=XDKXV_222B + XDKXV_46 + XDKXV_42B
N02   *
N02  C                   ELSE
N02  C                   EVAL      XDKXV_221B = 0
N02  C                   EVAL      XDKXV_221C = 0
N02  C                   EVAL      XDKXV_222B = 0
N02  C                   EVAL      XDKXV_46   = 0
N02  C                   EVAL      XDKXV_42B  = 0
N02  C                   EVAL      XDKXV_42C  = 0
N02  C                   ENDIF
N02   *
N02  C                   ENDSR
