      *********************************************************************
      *
CRTPG+*  CRTPGM SYSPED/TDCI005R MODULE(*LIBL/TDCI005R *LIBL/INCGI)
CRTPGM*        ACTGRP(CGI) AUT(*USE)
      *
      *********************************************************************
      /copy SYSPEDS/qrpgsrcpy,hspecs
      /copy SYSPEDS/qrpgsrcpy,hspecsbnd
      *********************************************************************
     FBRIDF     IF   E           K DISK    USROPN
     FDKNH      IF   E           K DISK    USROPN
     FDKNHFS    IF   E           K DISK    USROPN
     FDKNHPK    IF   E           K DISK    USROPN
     FEDIM4     IF   E           K DISK    USROPN
      *--------------------------------------------------------------------
      * Variables common to all CGIs
      *--------------------------------------------------------------------
      /copy SYSPEDS/qrpgsrcpy,prototypeb
      /copy SYSPEDS/qrpgsrcpy,usec
      /copy SYSPEDS/qrpgsrcpy,variables3
      *
      * Varible for
     D WSUSER          S             10
     D AVD             S              4
     D AVDN            S              4  0
     D OPD             S              7
     D OPDN            S              7  0
     D JSONstring      s          32000
     D Error           S            150
     D AntLest         S              9  0
     D                 DS
     D  TIDFKD                 1     20
     D  TIDFSK                21     22
     D  NIDFKD                23     42
     D  NIDFSK                43     44
     D  FSORG                  1     44
     D                 DS
     D  TIDFKD1                1     20
     D  TIDFSK1               21     22
     D  NIDFKD1               23     42
     D  NIDFSK1               43     44
     D  TIDFKD2               45     64
     D  TIDFSK2               65     66
     D  NIDFKD2               67     86
     D  NIDFSK2               87     88
     D  TIDFKD3               89    108
     D  TIDFSK3              109    110
     D  NIDFKD3              111    130
     D  NIDFSK3              131    132
     D  TIDFKD4              133    152
     D  TIDFSK4              153    154
     D  NIDFKD4              155    174
     D  NIDFSK4              175    176
     D  FS                     1    176    DIM(4)
     D                 DS
     D  NICTP                  1     35
     D  NICTNV                36     50
     D  PKORG                  1     44
     D                 DS
     D  NICTP1                 1     35
     D  NICTNV1               36     50
     D  NICTP2                51     85
     D  NICTNV2               86    100
     D  NICTP3               101    135
     D  NICTNV3              136    150
     D  NICTP4               151    185
     D  NICTNV4              186    200
     D  PK                     1    200    DIM(4)

      *get input-string
      /copy syspeds/qrpgsrcpy,prolog3

      * Parse input
     C                   exsr      Parse
      * Open files etc
     C                   EXSR      INIT
      *
     c                   callp     gethtmlifs(
     C                             '/syspeddev/html/JSON.html':
     C                             '/CGITAG/')
     C                   callp     wrtsection('top')
      *
      * ............................................................................................
      * skriv JSON-Object start..(alltid '{' + x ant param. m/komma mellom (IKKE komma etter siste))
      * ............................................................................................
      *
      /free
        JSONstring='{'
        +'¬user¬ : ¬'+%trim(WSUSER)+'¬, '
        +'¬avd¬ : ¬'+%trim(%editc(AVDN:'Z'))+'¬, '
        +'¬opd¬ : ¬'+%trim(%editc(OPDN:'Z'))+'¬, '
        +'¬errMsg¬ : ¬'+%trim(Error)+'¬, ';
      /end-free
      * JSONfix escaper " i tekst,  for deretter å bytte ¬->"
     c                   call      'JSONFIX'
     c                   parm                    JSONstring
     C                   CALLP     updHTMLvar2('JSONstring'
     C                                         :%addr(JSONstring)
     C                                         :%len(JSONstring))
     C                   callp     wrtsection('JSONlin')
      *
      * ............................................................................................
      * Skriv JSON-LISTE Start (en liste er EN parameter(fra [ til   )
      * ............................................................................................
     C                   eval      JSONstring ='"oneorder" : ['
     C                   CALLP     updHTMLvar2('JSONstring'
     C                                         :%addr(JSONstring)
     C                                         :%len(JSONstring))
     C                   callp     wrtsection('JSONlin')
      *
      * Hæmta detta ena ærendet.
      *
     c     Error         ifeq      *blanks
     C                   MOVE      *BLANKS       FS
     C                   MOVE      *BLANKS       PK
     C     DKNhKey       CHAIN     DKNH                               55
     C                   MOVE      FSORG         FS(1)
     C                   Z-ADD     1             XN                3 0
     C     DKNhKey       SETLL     DKNHFS
     C     DKNhKey       READE     DKNHFS                                 33
     C                   DOW       *IN33 = *OFF
     C                   ADD       1             XN
     C                   MOVE      FSORG         FS(XN)
     C     DKNhKey       READE     DKNHFS                                 33
     C                   ENDDO
     C                   MOVE      PKORG         PK(1)
     C                   Z-ADD     1             XN                3 0
     C     DKNhKey       SETLL     DKNHPK
     C     DKNhKey       READE     DKNHPK                                 33
     C                   DOW       *IN33 = *OFF
     C                   ADD       1             XN
     C                   MOVE      PKORG         PK(XN)
     C     DKNhKey       READE     DKNHPK                                 33
     C                   ENDDO
     C     *IN55         IFEQ      '0'
      * Har 043 tagits emot ?
     C                   EXSR      SR043
      * ............................................................................................
      * Skriv en JSON-Array-linje pr menypunkt - komma før hvert nytt element
      * ............................................................................................
      /free
          JSONstring=*blanks;
       JSONstring=%trim(JSONstring)+'{'
          +'¬tiavd¬ : ¬'+%trim(%editc(TIAVD:'Z'))+'¬, '
          +'¬titdn¬ : ¬'+%trim(%editc(TITDN:'Z'))+'¬, '
          +'¬tisg¬ : ¬'+%trim(TISG)+'¬, '
          +'¬tist¬ : ¬'+%trim(TIST)+'¬, '
          +'¬tst¬ : ¬'+%trim(DKNH_0035)+'¬, '
          +'¬tienkl¬ : ¬'+%trim(TIENKL)+'¬, '
          +'¬titrnr¬ : ¬'+%trim(TITRNR)+'¬, '
          +'¬tign¬ : ¬'+%trim(TIGN)+'¬, '
          +'¬tidk¬ : ¬'+%trim(TIDK)+'¬, '
          +'¬tikna¬ : ¬'+%trim(%editc(TIKNA:'Z'))+'¬, '
          +'¬tinaa¬ : ¬'+%trim(TINAA)+'¬, '
          +'¬tiada1¬ : ¬'+%trim(TIADA1)+'¬, '
          +'¬tipna¬ : ¬'+%trim(TIPNA)+'¬, '
          +'¬tipsa¬ : ¬'+%trim(TIPSA)+'¬, '
          +'¬tilka¬ : ¬'+%trim(TILKA)+'¬, '
          +'¬titina¬ : ¬'+%trim(TITINA)+'¬, '
          +'¬tikns¬ : ¬'+%trim(%editc(TIKNS:'Z'))+'¬, '
          +'¬tinas¬ : ¬'+%trim(TINAS)+'¬, '
          +'¬tiads1¬ : ¬'+%trim(TIADS1)+'¬, '
          +'¬tipns¬ : ¬'+%trim(TIPNS)+'¬, '
          +'¬tipss¬ : ¬'+%trim(TIPSS)+'¬, '
          +'¬tilks¬ : ¬'+%trim(TILKS)+'¬, '
          +'¬titins¬ : ¬'+%trim(TITINS)+'¬, '
          +'¬tiknk¬ : ¬'+%trim(%editc(TIKNK:'Z'))+'¬, '
          +'¬tinak¬ : ¬'+%trim(TINAK)+'¬, '
          +'¬tiadk1¬ : ¬'+%trim(TIADK1)+'¬, '
          +'¬tipnk¬ : ¬'+%trim(TIPNK)+'¬, '
          +'¬tipsk¬ : ¬'+%trim(TIPSK)+'¬, '
          +'¬tilkk¬ : ¬'+%trim(TILKK)+'¬, '
          +'¬titink¬ : ¬'+%trim(TITINK)+'¬, '
          +'¬tiblk¬ : ¬'+%trim(TIBLK)+'¬, '
          +'¬tialk¬ : ¬'+%trim(TIALK)+'¬, '
          +'¬titaid¬ : ¬'+%trim(TITAID)+'¬, '
          +'¬titask¬ : ¬'+%trim(TITASK)+'¬, '
          +'¬titalk¬ : ¬'+%trim(TITALK)+'¬, '
          +'¬tikdc¬ : ¬'+%trim(TIKDC)+'¬, '
          +'¬titrdt¬ : ¬'+%trim(%editc(TITRDT:'Z'))+'¬, '
          +'¬tilstl¬ : ¬'+%trim(%editc(TILSTL:'Z'))+'¬, '
          +'¬tivpos¬ : ¬'+%trim(%editc(TIVPOS:'Z'))+'¬, '
          +'¬tivkb¬ : ¬'+%trim(%editc(TIVKB:'4'))+'¬, '
          +'¬ticats¬ : ¬'+%trim(TICATS)+'¬, '
          +'¬tictl¬ : ¬'+%trim(TICTL)+'¬, '
          +'¬tidant¬ : ¬'+%trim(%editc(TIDANT:'Z'))+'¬, '
          +'¬tidfkd¬ : ¬'+%trim(TIDFKD1)+'¬, '
          +'¬tidfsk¬ : ¬'+%trim(TIDFSK1)+'¬, '
          +'¬tidfkd2¬ : ¬'+%trim(TIDFKD2)+'¬, '
          +'¬tidfsk2¬ : ¬'+%trim(TIDFSK2)+'¬, '
          +'¬tidfkd3¬ : ¬'+%trim(TIDFKD3)+'¬, '
          +'¬tidfsk3¬ : ¬'+%trim(TIDFSK3)+'¬, '
          +'¬tidfkd4¬ : ¬'+%trim(TIDFKD4)+'¬, '
          +'¬tidfsk4¬ : ¬'+%trim(TIDFSK4)+'¬, '
          +'¬nivpos¬ : ¬'+%trim(%editc(NIVPOS:'Z'))+'¬, '
          +'¬nivkb¬ : ¬'+%trim(%editc(NIVKB:'4'))+'¬, '
          +'¬nidfst¬ : ¬'+%trim(NIDFST)+'¬, '
          +'¬nidant¬ : ¬'+%trim(%editc(NIDANT:'Z'))+'¬, '
          +'¬nidfkd¬ : ¬'+%trim(NIDFKD1)+'¬, '
          +'¬nidfsk¬ : ¬'+%trim(NIDFSK1)+'¬, '
          +'¬nidfkd2¬ : ¬'+%trim(NIDFKD2)+'¬, '
          +'¬nidfsk2¬ : ¬'+%trim(NIDFSK2)+'¬, '
          +'¬nidfkd3¬ : ¬'+%trim(NIDFKD3)+'¬, '
          +'¬nidfsk3¬ : ¬'+%trim(NIDFSK3)+'¬, '
          +'¬nidfkd4¬ : ¬'+%trim(NIDFKD4)+'¬, '
          +'¬nidfsk4¬ : ¬'+%trim(NIDFSK4)+'¬, '
          +'¬nimn1¬ : ¬'+%trim(NIMN1)+'¬, '
          +'¬nimn2¬ : ¬'+%trim(NIMN2)+'¬, '
          +'¬nimnsk¬ : ¬'+%trim(NIMNSK)+'¬, '
          +'¬nikonf¬ : ¬'+%trim(%editc(NIKONF:'Z'))+'¬, '
          +'¬nifulf¬ : ¬'+%trim(%editc(NIFULF:'Z'))+'¬, '
          +'¬nidtl¬ : ¬'+%trim(%editc(NIDTL:'Z'))+'¬, '
          +'¬nictb¬ : ¬'+%trim(NICTB)+'¬, '
          +'¬nictb2¬ : ¬'+%trim(NICTB2)+'¬, '
          +'¬nictsk¬ : ¬'+%trim(NICTSK)+'¬, '
          +'¬nictp¬ : ¬'+%trim(NICTP1)+'¬, '
          +'¬nictnv¬ : ¬'+%trim(NICTNV1)+'¬, '
          +'¬nictp2¬ : ¬'+%trim(NICTP2)+'¬, '
          +'¬nictnv2¬ : ¬'+%trim(NICTNV2)+'¬, '
          +'¬nictp3¬ : ¬'+%trim(NICTP3)+'¬, '
          +'¬nictnv3¬ : ¬'+%trim(NICTNV3)+'¬, '
          +'¬nictp4¬ : ¬'+%trim(NICTP4)+'¬, '
          +'¬jn043¬ : ¬'+%trim(JN043)+'¬, '
          +'¬nictnv4¬ : ¬'+%trim(NICTNV4)+'¬}';
      /end-free
     C                   call      'JSONFIX'
     C                   parm                    JSONstring
     C                   CALLP     updHTMLvar2('JSONstring'
     C                                         :%addr(JSONstring)
     C                                         :%len(JSONstring))
     C                   callp     wrtsection('JSONlin')
      *
     C                   ENDIF
     c                   endif
     c                   eval      JSONstring =']'
     C                   CALLP     updHTMLvar2('JSONstring'
     C                                         :%addr(JSONstring)
     C                                         :%len(JSONstring))
     C                   callp     wrtsection('JSONlin')
      * ............................................................................................
      * Skriv JSON-string Avsluttning
      * ............................................................................................
     c                   eval      JSONstring ='}'
     C                   CALLP     updHTMLvar2('JSONstring'
     C                                         :%addr(JSONstring)
     C                                         :%len(JSONstring))
     C                   callp     wrtsection('JSONlin')
      *
      * Quit
     C                   exsr      Exit


      *=====================================================================
      * Close output html and quit
      *=====================================================================
     C     Exit          begsr
      * Lukk fil
     C                   CLOSE     BRIDF
     C  N50              CLOSE     DKNH
     C  N50              CLOSE     DKNHFS
     C  N50              CLOSE     DKNHPK
     C  N50              CLOSE     EDIM4

      * Do not delete the call to wrtsection with section name *fini.  It is needed
      * to ensure that all output html that has been buffered gets output.
     C                   callp     wrtsection('*fini')
      * Quit
     C                   MOVE      *ON           *INLR
     C                   return
     C                   endsr
      *
      *********************************************************
     C     Parse         Begsr
      *********************************************************
      * Get input
     C                   EVAL      WSUSER  = zhbgetvar('USER')
     C                   EVAL      AVD     = zhbgetvar('AVD')
     C                   eval      AVDN    = c2n2(AVD)
     C                   EVAL      OPD     = zhbgetvar('OPD')
     C                   eval      OPDN    = c2n2(OPD)
     c                   endsr
      *
      *********************************************************
     C     INIT          Begsr
      *********************************************************
     C                   OPEN      BRIDF
      * Test innlogging
     C     WSUSER        CHAIN     BRIDF                              50
     C     BILIBL        ifeq      *blanks
     C                   callb     'INCGI'
     C                   parm                    BISTDL
     C                   else
     C                   call      BILIBL
     C                   end
      *
     C     DKNhKey       klist
     C                   kfld                    AVDN
     C                   kfld                    OPDN
     C     EDIMKEY       KLIST
     C                   KFLD                    WMSR
     C                   KFLD                    AVDN
     C                   KFLD                    OPDN
     C     *LIKE         DEFINE    MSR           WMSR
     C                   EVAL      WMSR   = 'R'
      *
     C   50              eval      Error = 'Invalid userID'
     C  N50              OPEN      DKNH
     C  N50              OPEN      DKNHFS
     C  N50              OPEN      DKNHPK
     C  N50              OPEN      EDIM4

     c                   endsr
      *
      *********************************************************
     C     SR043         BEGSR
      *********************************************************
     C                   MOVE      'N'           JN043             1
     C     EDIMKEY       SETLL     EDIM4                              51
     C     EDIMKEY       READE     EDIM4                                  51
     C     *IN51         DOWEQ     *OFF
     C                   IF        M1N07='043'
     C                   EVAL      JN043='J'
     C                   EVAL      *IN51=*ON
     C                   ENDIF
     C     EDIMKEY       READE     EDIM4                                  51
     C                   ENDDO
     C                   ENDSR
