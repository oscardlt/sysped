********************************************************************
      * RETTINGER I DETTE PROGRAM:
PTFnr:*Sek Sig Vers  Beskrivelse...........................
""""""*"""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""
11XXX * 01 SH  PTF11 brukeroversyring av printfil
11105 * 02 YBC PTF11 SEND EPOST
12XXX * 03 YBC PTF12 RETT FEIL I ENDRING 02
12XXX * 04 SH  PTF12 skriv dokumentkontroll til arkiv
12158 * 05 YBC PTF12 Ny status N for feil sendte ny versjon uten TVINN be om
12XXX * 06 YBC PTF12 Kall arkivprogram ved "lagt til manuellt behandl" og direktefortolling
********************************************************************
      *
N04  FARKTXT    IF   E           K DISK
N04  FFIRMARC   IF   E           K DISK
S06  F*arkivl03  UF A E           K DISK
N06  FARKIVL03  UF A E           K DISK    USROPN
N04  FARKEXT    IF   E           K DISK
     FFRISOK    IF   E           K DISK
     FKODTP     IF   E           K DISK
N01  FKODTPUSR  IF   E           K DISK
N02  FKODTSI    IF   E           K DISK
     FKODTFM    IF   E           K DISK
S05  F*SADH      UF   E           K DISK
N05  FSADH      UF   E           K DISK    USROPN
     FSADH8     IF   E           K DISK    RENAME(SADHR:SADH8R)
     FEDIM4     IF   E           K DISK
     F*VINF   IF  E           K        DISK
     FTVINF     UF   E           K DISK
     FTVINME    O    E             PRINTER OFLIND(*IN51)
N01  F                                     USROPN
N04  D                SDS
N04  D  ZUSER                254    263
N04  D                 DS
N04  D  XULTID                 1     14  0
N04  D  XULTM                  1      6  0
N04  D  XULDD                  7      8  0
N04  D  XULMM                  9     10  0
N04  D  XULÅÅ                 11     14  0
N04  D                 DS
N04  D  ULÅÅ                   1      4  0
N04  D  ULMM                   5      6  0
N04  D  ULDD                   7      8  0
N04  D  ULDT                   1      8  0
N01  D XCMD11          C                   CONST('OVRPRTF -
N01  D                                     FILE(TVINME) -
N01  D                                     OUTQ(')
N01  D XCMD21          C                   CONST('PAGESIZE(70 80) -
N01  D                                     CPI(10) -
N01  D                                     OVRSCOPE(*JOB) -
N01  D                                     OVRFLW(70)')
N02  D XCMD31          C                   CONST('OVRPRTF -
N02  D                                     FILE(TVINME) -
N02  D                                     PAGESIZE(72 80) -
N02  D                                     OVRFLW(66) -
N02  D                                     FORMTYPE(*STD) -
N02  D                                     HOLD(*YES) -
N02  D                                     OUTQ(OUTMAIL)')
N01  D UCMD            DS          1024
      *//////////////
      *  Hodelogikk /
      *//////////////
     C                   EXSR      SRINIT
     C                   EXSR      SRHOVE
N01  C                   CLOSE     TVINME
     C                   SETON                                        LR
      *
      *
      **********************************************************************
     C     SRINIT        BEGSR
      **********************************************************************
      *  Initiering                                        SRINIT /
      *
      * Input parametrer
      *"""""""""""""""""
     C     *ENTRY        PLIST
     C     UAVD          PARM                    UAVD              4 0
     C     UWS           PARM                    UWS              10
N02  C                   PARM                    USLUTT            1
N02  C                   PARM                    UEP              70
N02  C                   PARM                    UEMNE            40
N02  C                   EVAL      USLUTT = 'N'
N02  C                   EVAL      UEP    = *BLANKS
N02  C                   EVAL      UEMNE  = *BLANKS
      *
N01  C                   OPEN      TVINME
      *__________________
      * Definiere Nøkkler
      *""""""""""""""""""
     C     KEYSH         KLIST
     C                   KFLD                    SIAVD
     C                   KFLD                    SITDN
     C     FRIKEY        KLIST
     C                   KFLD                    SIAVD
     C                   KFLD                    SITDN
     C                   KFLD                    WSKODE
     C                   move      '*CR'         WSKODE            3
     C     KEYSH8        KLIST
     C                   KFLD                    UWS
     C                   KFLD                    WST               1
     C     KEYTM4        KLIST
     C                   KFLD                    WSR               1
     C                   KFLD                    WAVD              4 0
     C                   KFLD                    WTDN              7 0
     C                   KFLD                    W0068A            8 0
     C     KEYTF         KLIST
     C                   KFLD                    MMN
     C     KODTPK        KLIST
     C                   KFLD                    KOPUNI
     C                   KFLD                    UAVD
     C                   KFLD                    KOPLNR
     C                   MOVE      'P'           KOPUNI
     C                   Z-ADD     87            KOPLNR
N01  C     KEYUSER       KLIST
N01  C                   KFLD                    SISG
N01  C                   KFLD                    KOPLNR
N02  C     KODTSIK       KLIST
N02  C                   KFLD                    KSIUNI
N02  C                   KFLD                    SISG
N02  C                   EVAL      KSIUNI = 'SI'
      *___________________
      * Initiere faste nøkkelfelt
      *_________________
     C                   MOVE      'R'           WSR
     C                   MOVE      UAVD          WAVD
     C                   MOVE      99999999      W0068A
     C                   MOVE      'Å'           WST
     C                   MOVEA     '00'          *IN(38)
     C     KODTPK        CHAIN     KOPR                               33
     C  N33KOPFM         IFNE      *BLANKS
     C     KOPFM         SETLL     KODTFM
     C     KOPFM         READE     KODTFM                                 33
     C                   END
      *_____________
      * Sett nøkkel for å hente alle ME ('EDIRE     Å')
      *"""""""""""""
     C     KEYSH8        SETLL     SADH8
     C                   ENDSR
      *************************************************************************
     C     SRHOVE        BEGSR
      *************************************************************************
      *  Behandl alle Å-oppdrag,                           SRHOVE /
      *___________________
      * Hent alle SAD- med EDIRE/Å. finn siste Recievemelding
      * via meldingsnr skriv  FRITEKST/ oppdater status i sadh
      *"""""""""""""""""
     C                   SETOFF                                           33
S03  C*                  MOVE      'J'           XSNDEP            1
     C     FLERSH        TAG
N03  C                   MOVE      'J'           XSNDEP            1
     C     KEYSH8        READE     SADH8                                  33
N02  C   33              EVAL      USLUTT = 'J'
     C  N33              DO
N02  C     KODTSIK       CHAIN     KODTSI                             33
N02  C                   IF        *IN33 = *ON OR KSIXXX = *BLANKS
N01  C     KEYUSER       CHAIN     KODTPUSR                           44
N01  C  N44              EXSR      OVR
N02  C                   EVAL      XSNDEP = 'N'
N02  C                   ELSE
N02  C                   IF        XSNDEP = 'N'
N02  C                   GOTO      SLHOVE
N02  C                   END
N02  C                   EXSR      OVR2
N02  C                   END
     C     SIAVD         CABNE     UAVD          FLERSH
     C                   MOVE      SITDN         WTDN
     C                   SETOFF                                           34
     C                   MOVE      '1'           *IN51
     C                   MOVE      '1'           *IN52
     C     KEYTM4        SETLL     EDIM4
     C     FLEREM        TAG
     C                   READP     EDIM4                                  34
     C  N34SIAVD         COMP      MAVD                               3434
     C  N34SITDN         COMP      MTDN                               3434
     C  N34M1001         IFNE      '929'
     C                   GOTO      FLEREM
     C                   END
     C  N34              EXSR      SRSKRI
     C  N34              GOTO      FLEREM
     C  N52              WRITE     TVINMEØ
N02  C                   IF        XSNDEP = 'J'
N02  C                   EVAL      UEP = KSIXXX
N02  C                   EVAL      UEMNE = 'Melding fra TVINN: '
N02  C                             + %TRIM(%EDITC(WAVD:'Z')) + '/'
N02  C                             + %TRIM(%EDITC(WTDN:'Z'))
N02  C                   GOTO      SLHOVE
N02  C                   END
     C                   GOTO      FLERSH
     C                   END
N02   *
N02  C     SLHOVE        TAG
N02   *
     C                   ENDSR
      *******************************************************************
     C     SRSKRI        BEGSR
      *******************************************************************
      *  Skriv en melding (en post i TVINF)                SRSKRI /
     C                   MOVE      '0'           *IN52
      * Oppdatere tolldeklarasjon med ny status (Behold C ved DMK)
     C                   MOVE      *BLANKS       FSSOK
     C     FRIKEY        CHAIN     FRISOK                             20
N05  C                   OPEN      SADH
     C     KEYSH         CHAIN     SADH                               20
     C     SIST          IFEQ      'Å'
     C     SI0035        IFEQ      '6'                                          DOK.KONTROLL
     C                   MOVE      'D'           SIST
n04  c                   EXSR      ARKIVSR
N05   * Slett evt. oppbevarte opprinnelig fortolling pga. ny versjon uten be om
N05  C                   MOVE      '2'           UMOD              1
N05  C                   CALL      'SAD061X'
N05  C                   PARM                    SIAVD
N05  C                   PARM                    SITDN
N05  C                   PARM                    UMOD
     C                   ELSE
     C     SI0035        IFEQ      '5'                                          VAREKONTROLL
     C                   MOVE      'V'           SIST
N05   * Slett evt. oppbevarte opprinnelig fortolling pga. ny versjon uten be om
N05  C                   MOVE      '2'           UMOD              1
N05  C                   CALL      'SAD061X'
N05  C                   PARM                    SIAVD
N05  C                   PARM                    SITDN
N05  C                   PARM                    UMOD
     C                   ELSE
     C     SI0035        IFEQ      '9'                                          TVINN INFO.
     C                   MOVE      'T'           SIST
N06  C                   EXSR      ARKIVSR2
N05   * Slett evt. oppbevarte opprinnelig fortolling pga. ny versjon uten be om
N05  C                   MOVE      '2'           UMOD              1
N05  C                   CALL      'SAD061X'
N05  C                   PARM                    SIAVD
N05  C                   PARM                    SITDN
N05  C                   PARM                    UMOD
     C                   ELSE
N05  C     SI0035        IFEQ      '7'                                          TVINN INFO.
N05   * Flytt oppbevarte opprinnelig fortolling tilbake
N05  C                   UPDATE    SADHR
N05  C                   CLOSE     SADH
N05  C                   MOVE      '3'           UMOD              1
N05  C                   CALL      'SAD061X'
N05  C                   PARM                    SIAVD
N05  C                   PARM                    SITDN
N05  C                   PARM                    UMOD
N05  C                   OPEN      SADH
N05  C     KEYSH         CHAIN     SADH                               20
N05  C                   IF        SIKDV = 'D' OR SIKDV = 'V'
N05  C                   EVAL      SIST = SIKDV
N05  C                   ELSE
N05  C                   MOVE      'N'           SIST
N05  C                   END
N05  C                   ELSE
     C                   MOVE      'M'           SIST
N05  C                   END
     C                   END
     C                   END
     C                   END
     C                   END
N05  C                   EVAL      SIKDV = ' '
     C                   MOVE      ' '           SI0035
     C                   UPDATE    SADHR
N05  C                   CLOSE     SADH
      * Les alle på samme meldingsnr
     C     KEYTF         SETLL     TVINF
     C     FLEREF        TAG
     C     KEYTF         READE     TVINF                                  35
     C  N35F4815         IFEQ      'JA'
      * Skriv ut melding.
     C  N35
     CAN 51              DO                                                     OVERFLOW
     C                   WRITE     TVINMEA
     C                   SETOFF                                       51
     C                   END
     C     F0078B        COMP      *BLANKS                                41
     C     F0078C        COMP      *BLANKS                                42
     C     F0078D        COMP      *BLANKS                                43
     C     F0078E        COMP      *BLANKS                                44
     C                   WRITE     TVINMEB
     C                   MOVE      'PP'          F4815
     C                   END
     C  N35              UPDATE    TVINFF
     C  N35              GOTO      FLEREF
      *
     C                   ENDSR
N01   **********************************************************************************
N01  c     ovr           begsr
N01   **********************************************************************************
N01  C                   CLOSE     TVINME
N01  C                   Z-ADD     1024          UCMDL            15 5
N01  C                   MOVE      *BLANKS       UCMD
N01  C     XCMD11        CAT       KOPNVN:0      UCMD
N01  C                   CAT       ')':0         UCMD
N01  C                   CAT       XCMD21:1      UCMD
N01  C                   CALL      'QCMDEXC'                            33
N01  C                   PARM                    UCMD
N01  C                   PARM                    UCMDL
N01  C                   OPEN      TVINME
N01  C                   ENDSR
N02   **********************************************************************************
N02  c     ovr2          begsr
N02   **********************************************************************************
N02  C                   CLOSE     TVINME
N02  C                   Z-ADD     1024          UCMDL            15 5
N02  C                   EVAL      UCMD = XCMD31
N02  C                   CALL      'QCMDEXC'                            33
N02  C                   PARM                    UCMD
N02  C                   PARM                    UCMDL
N02  C                   OPEN      TVINME
N02  C                   ENDSR
N04   **********************************************************************************
N04  c     ARKIVSR       begsr
N04   **********************************************************************************
N04  c     arktxtk       klist
N04  c                   kfld                    artype
N04  c                   move      'sd'          artype
N04  C                   READ      FIRMARC                                88
N04  C     *IN88         IFEQ      '0'
n04  C     arktxtk       chain     arktxt                             88
N04  C     *IN88         IFEQ      '0'
N04  c     arkjn         andeq     'J'
N04  C     keyark        KLIST
n04  c                   kfld                    artype
N04  c                   kfld                    aravd
N04  c                   kfld                    aropd
N04  C**                 kfld                    ARUNDE
N04  c                   movel     mmn           arunde
N04  C                   eval      aravd=siavd
N04  C                   eval      aropd=sitdn
N04  C                   TIME                    XULTID
N04  C                   MOVE      XULDD         ULDD
N04  C                   MOVE      XULMM         ULMM
N04  C                   MOVE      XULÅÅ         ULÅÅ
n04  C*
N06  C                   OPEN      ARKIVL03
N04  C     keyark        chain     arkivl03                           88
N04  C     *in88         ifeq      '1'
N04  c                   move      ARCFIR        arfirm
N04  C                   MOVE      ULDT          ARDATE
N04  C                   MOVE      XULTM         ARTIME
n04  C                   MOVE      ZUSER         ARUSER
N04  C                   MOVE      *BLANKS       ARSTAT
N04  c                   move      siknk         ARKUND
N04  C                   WRITE     arkivr
N04  C                   END
N06  C                   CLOSE     ARKIVL03
N04  C                   END
N04  C                   END
N04  C                   ENDSR
N06   *
N06   **********************************************************************************
N06  C     ARKIVSR2      BEGSR
N06   **********************************************************************************
N06   * Lag forhåndssendt arkivdokument ved direktefortolling
N06  C                   IF        SITDN > 0 AND SIST = 'T'
N06  C                   IF        %SUBST(SIGN:5:2) >= '01' AND
N06  C                             %SUBST(SIGN:5:2) <= '12' AND
N06  C                             %SUBST(SIGN:7:1) = 'D' AND
N06  C                             %SUBST(SIGN:8:8) = *BLANKS
N06  C                   READ      FIRMARC                                33
N06  C                   OPEN      ARKIVL03
N06  C     ARKIVL03K     KLIST
N06  C                   KFLD                    ARTYPE
N06  C                   KFLD                    SIAVD
N06  C                   KFLD                    SITDN
N06  C                   EVAL      ARTYPE = 'sl'
N06  C     ARKIVL03K     CHAIN     ARKIVL03                           33
N06  C                   IF        *IN33
N06  C                   CLEAR                   ARKIVR
N06  C                   EVAL      ARFIRM = ARCFIR
N06  C                   EVAL      ARTYPE = 'sl'
N06  C                   EVAL      ARAVD  = MAVD
N06  C                   EVAL      AROPD  = MTDN
N06  C                   EVAL      ARUSER = ZUSER
N06  C                   WRITE     ARKIVR
N06  C                   CLOSE     ARKIVL03
N06  C                   EVAL      U_FINS = 'N'
N06  C                   CALL      'ARC002CL'
N06  C                   PARM                    ARTYPE
N06  C                   PARM                    ARUSER
N06  C                   PARM                    U_FINS            1
N06  C                   END
N06  C                   END
N06  C                   END
N06   *
N06  C                   ENDSR
N06   *
