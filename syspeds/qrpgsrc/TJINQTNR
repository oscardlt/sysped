      *********************************************************************
      *
CRTPG+*  CRTPGM SYSPED/TJINQTNR MODULE(*LIBL/TJINQTNR *LIBL/INCGI)
CRTPGM*        ACTGRP(CGI) AUT(*USE)
      *
      *********************************************************************
      /copy SYSPEDS/qrpgsrcpy,hspecs
      /copy SYSPEDS/qrpgsrcpy,hspecsbnd
      *********************************************************************
     FBRIDF     IF   E           K DISK    USROPN
     FTRAN      IF   E           K DISK    USROPN
     FTRANL01   IF   E           K DISK    USROPN
     F                                     RENAME(TRANR:TRANR01)
      /copy SYSPEDS/qrpgsrcpy,prototypeb
      /copy SYSPEDS/qrpgsrcpy,usec
      /copy SYSPEDS/qrpgsrcpy,variables3
     D SOKTNR          s              8
     D SOKTNRN         s              8  0
     D SOKNVN          s             10
     D USER            s             10
     D JSONstring      S          32000
     D Error           S            150
     D AntLest         S              9  0
      *get input-string
      /copy syspeds/qrpgsrcpy,prolog3
     C                   EXSR      PARSE

     C                   EXSR      INIT

     c                   callp     gethtmlifs(
     C                             '/syspeddev/html/JSON.html':
     C                             '/CGITAG/')
     C                   callp     wrtsection('top')

      /free
        JSONstring='{'
        +'¬user¬ : ¬'+%trim(USER)+'¬, '
        +'¬soktnr¬ : ¬'+%trim(SOKTNR)+'¬, '
        +'¬soknvn¬ : ¬'+%trim(SOKNVN)+'¬, '
        +'¬error¬ : ¬'+%trim(ERROR)+'¬, ';
      /end-free
      * JSONfix escaper " i tekst,  for deretter å bytte ¬->"
     c                   call      'JSONFIX'
     c                   parm                    JSONstring
     C                   CALLP     updHTMLvar2('JSONstring'
     C                                         :%addr(JSONstring)
     C                                         :%len(JSONstring))
     C                   callp     wrtsection('JSONlin')
      * Find/send lines
     c     Error         IFEQ      *blanks
     C                   EXSR      LINES
     C                   ENDIF

     c                   eval      JSONstring ='}'
     C                   CALLP     updHTMLvar2('JSONstring'
     C                                         :%addr(JSONstring)
     C                                         :%len(JSONstring))
     C                   callp     wrtsection('JSONlin')
      * Quit
     C                   EXSR      EXIT
      *=====================================================================
      * Parse input / cvt to numeric
      *=====================================================================
     C     Parse         BEGSR
     C                   EVAL      USER = zhbgetvar('USER')
     C                   EVAL      SOKTNR  = zhbgetvar('SOKTNR')
     C                   EVAL      SOKTNRN = c2n2(SOKTNR)
     C                   EVAL      SOKNVN  = zhbgetvar('SOKNVN')
     C                   EVAL      SOKNVN  = uppify(SOKNVN)
     C                   IF        SOKTNR=*BLANKS
     C                   EVAL      SOKTNRN=*ZEROS
     C                   ENDIF
     C                   ENDSR
      *=====================================================================
      * Close output html and quit
      *=====================================================================
     C     Exit          BEGSR
     C                   callp     wrtsection('*fini')
      * Quit
     C                   CLOSE     BRIDF
     C  N50              CLOSE     TRAN
     C  N50              CLOSE     TRANL01
     C                   MOVE      *ON           *INLR
     C                   RETURN
     C                   ENDSR
      *=====================================================================
      * Fine lins - sEND to browser
      *=====================================================================
     C     Lines         BEGSR
     c                   EVAL      JSONstring ='"translist" : ['
     C                   CALLP     updHTMLvar2('JSONstring'
     C                                         :%addr(JSONstring)
     C                                         :%len(JSONstring))
     C                   CALLP     wrtsection('JSONlin')

     C*    SOKTNRN       IFEQ      *ZEROS
     C*    SOKNVN        ANDEQ     *BLANKS
     C*                  GOTO      UTLES
     C*                  END

     C     SOKTNRN       IFNE      *ZEROS
     C     TNRKEY        SETLL     TRAN
     C     BIFIRM        READE     TRAN                                   33
     C                   ELSE
     C     NVNKEY        SETLL     TRANL01
     C     BIFIRM        READE     TRANL01                                33
     C*    SOKNVN        SCAN      VMALFA                                 34
     C*    *IN34         CABEQ     *OFF          UtLes
     C                   END
     C     *IN33         DOWEQ     *OFF

     C                   ADD       1             ANTLEST
      /free
       if AntLest=1;
          JSONstring=*blanks;
          else;
          JSONstring=', ';
          endif;
       JSONstring=%trim(JSONstring)+'{'
          +'¬vmtran¬ : ¬'+%trim(%editc(VMTRAN:'Z'))+'¬, '
          +'¬navn¬ : ¬'+%trim(VMNAVN)+'¬}';
      /end-free
     C                   CALL      'JSONFIX'
     C                   PARM                    JSONstring
     C                   CALLP     updHTMLvar2('JSONstring'
     C                                         :%addr(JSONstring)
     C                                         :%len(JSONstring))
     C                   CALLP     wrtsection('JSONlin')

     C     ANTLEST       CABGE     100           UTLES
     C     SOKTNRN       IFNE      *ZEROS
     C*    BIFIRM        READE     TRAN                                   33
     C                   GOTO      UTLES
     C                   ELSE
     C     BIFIRM        READE     TRANL01                                33
     C*    SOKNVN        SCAN      VMNAVN                                 34
     C*    *IN34         CABEQ     *OFF          UTLES
     C                   END
     C                   END

     C     UTLES         TAG
     c                   EVAL      JSONstring =']'
     C                   CALLP     updHTMLvar2('JSONstring'
     C                                         :%addr(JSONstring)
     C                                         :%len(JSONstring))
     C                   CALLP     wrtsection('JSONlin')

     C                   ENDSR
      *=====================================================================******
      *  INITIER
      *=====================================================================******
     C     INIT          BEGSR
     C                   OPEN      BRIDF
     C     USER          CHAIN     BRIDF                              50
      * En "standardvariant" libl: CALL bound (INCGI=*MODULE) med parameter.
     C     BILIBL        IFEQ      *blanks
     C                   CALLB     'INCGI'
     C                   PARM                    BISTDL
     C                   ELSE
      * Helt egen bibl.liste satt på user - normal CALL (BILIBL er "*pgm")
     C                   CALL      BILIBL
     C                   END

OddEv * hent Parametre som går igjen i mange prog:
OddEv *      Odd/Even/Rowhead-farger,Logobilde,Språk,Intern/Ekstern bruker,  mm
OddEvC                   CALL      'ESGETPAR'
OddEvC                   PARM                    BIBRID
OddEvC                   PARM                    BIFIRM
OddEvC                   PARM                    BIKUNR
OddEvC                   PARM                    BIKNG
OddEvC                   PARM                    RowHead          10
OddEvC                   PARM                    Odd              10
OddEvC                   PARM                    Even             10
OddEvC                   PARM                    LogoImg          50
OddEvC                   PARM                    XSPRÅK            2
OddEvC                   PARM                    XINTERN           1
OddEvC                   PARM                    PARMDS1        1024
OddEvC                   PARM                    PARMDS2        1024
OddEvC                   PARM                    PARMDS3        1024

     C   50              eval      Error = 'Invalid userID'
     C  N50              OPEN      TRAN
     C  N50              OPEN      TRANL01
      * Key for CUNDL01
     C     TNRKEY        KLIST
     C                   KFLD                    BIFIRM
     C                   KFLD                    SOKTNRN
      * Key for CUNDL01
     C     NVNKEY        KLIST
     C                   KFLD                    BIFIRM
     C                   KFLD                    SOKNVN
     C                   ENDSR
