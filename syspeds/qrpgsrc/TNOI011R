      *********************************************************************
      *
CRTPG+*  CRTPGM SYSPED/TNOI011R MODULE(*LIBL/TNOI011R *LIBL/INCGI)
CRTPGM*        ACTGRP(CGI) AUT(*USE)
      *
      *********************************************************************
      /copy SYSPEDS/qrpgsrcpy,hspecs
      /copy SYSPEDS/qrpgsrcpy,hspecsbnd
      *********************************************************************
      * I WEB varianten av SAD Import brukes kun fullskjermmodus for vareposter.
      * D.v.s. linjenr fra web er ALLTID hovedlinjenummer og så må jeg returnere
      * alle tillegslinjer som felt med repetisjoner.
      * WA1 - WA7  =  7 Repetisjoner av SVFT
      * WB1 - WB7  =  7 Repetisjoner av SVNT
      * WC1 - WC7  =  7 Repetisjoner av SVEH
      * WD1 - WD5  =  5 Repetisjoner av SVVT
      * WE1 - WE10 = 10 Repetisjoner av SVCREF
      * WF1 - WF10 = 10 Repetisjoner av SVTOA
      * WG1 - WG8  =  8 Repetisjoner av SVKDAÆ
      * WH1 - WH8  =  8 Repetisjoner av SVKDSÆ
      * WI1 - WI8  =  8 Repetisjoner av SVBLÆ
      * WJ1 - WJ8  =  8 Repetisjoner av SVBLGÆ
      * WK1 - WK8  =  8 Repetisjoner av SVBLSÆ
     FBRIDF     IF   E           K DISK    USROPN
     FSADV      IF   E           K DISK    USROPN
      *--------------------------------------------------------------------
      * Variables common to all CGIs
      *--------------------------------------------------------------------
      /copy SYSPEDS/qrpgsrcpy,prototypeb
      /copy SYSPEDS/qrpgsrcpy,usec
      /copy SYSPEDS/qrpgsrcpy,variables3
      *
      * Varible for
     D WSUSER          S             10
     D AVD             S              4
     D AVDN            S              4  0
     D OPD             S              7
     D OPDN            S              7  0
     D LIN             S              5
     D LINN            S              5  0
     D JSONstring      s          32000
     D Error           S            150
     D AntLest         S              9  0

      * Array for SVFT
     D                 DS
     D  WA1                    1     28
     D  WA2                   29     56
     D  WA3                   57     84
     D  WA4                   85    112
     D  WA5                  113    140
     D  WA6                  141    168
     D  WA7                  169    196
     D  WA                     1    196    DIM(7)
     D  SVFT01                 1     28
     D  SVFT02                29     56
     D  SVFT03                57     84
     D  SVFT04                85    112
     D  SVFT05               113    140
     D  SVFT06               141    168
     D  SVFT07               169    196

      * Array for SVNT
     D                 DS
     D  WB1                    1      6S 0
     D  WB2                    7     12S 0
     D  WB3                   13     18S 0
     D  WB4                   19     24S 0
     D  WB5                   25     30S 0
     D  WB6                   31     36S 0
     D  WB7                   37     42S 0
     D  WB                     1     42S 0 DIM(7)
     D  SVNT01                 1      6S 0
     D  SVNT02                 7     12S 0
     D  SVNT03                13     18S 0
     D  SVNT04                19     24S 0
     D  SVNT05                25     30S 0
     D  SVNT06                31     36S 0
     D  SVNT07                37     42S 0

      * Array for SVEH
     D                 DS
     D  WC1                    1      4
     D  WC2                    5      8
     D  WC3                    9     12
     D  WC4                   13     16
     D  WC5                   17     20
     D  WC6                   21     24
     D  WC7                   25     28
     D  WC                     1     28    DIM(7)
     D  SVEH01                 1      4
     D  SVEH02                 5      8
     D  SVEH03                 9     12
     D  SVEH04                13     16
     D  SVEH05                17     20
     D  SVEH06                21     24
     D  SVEH07                25     28

      * Array for SVVT
     D                 DS
     D  WD1                    1     30
     D  WD2                   31     60
     D  WD3                   61     90
     D  WD4                   91    120
     D  WD5                  121    150
     D  WD                     1    150    DIM(5)
     D  SVVT01                 1     30
     D  SVVT02                31     60
     D  SVVT03                61     90
     D  SVVT04                91    120
     D  SVVT05               121    150

      * Array for SVCREF
     D                 DS
     D  WE1                    1      3
     D  WE2                    4      6
     D  WE3                    7      9
     D  WE4                   10     12
     D  WE5                   13     15
     D  WE6                   16     18
     D  WE7                   19     21
     D  WE8                   22     24
     D  WE9                   25     27
     D  WE10                  28     30
     D  WE                     1     30    DIM(10)
     D  SVCRE1                 1      3
     D  SVCRE2                 4      6
     D  SVCRE3                 7      9
     D  SVCRE4                10     12
     D  SVCRE5                13     15
     D  SVCRE6                16     18
     D  SVCRE7                19     21
     D  SVCRE8                22     24
     D  SVCRE9                25     27
     D  SVCRE10               28     30

      * Array for SVTOP
     D                 DS
     D  WF1                    1     17
     D  WF2                   18     34
     D  WF3                   35     51
     D  WF4                   52     68
     D  WF5                   69     85
     D  WF6                   86    102
     D  WF7                  103    119
     D  WF8                  120    136
     D  WF9                  137    153
     D  WF10                 154    170
     D  WF                     1    170    DIM(10)
     D  SVTOP1                 1     17
     D  SVTOP2                18     34
     D  SVTOP3                35     51
     D  SVTOP4                52     68
     D  SVTOP5                69     85
     D  SVTOP6                86    102
     D  SVTOP7               103    119
     D  SVTOP8               120    136
     D  SVTOP9               137    153
     D  SVTOP10              154    170

      * Array for SVAKD
     D                 DS
     D  WG1                    1      2
     D  WG2                    3      4
     D  WG3                    5      6
     D  WG4                    7      8
     D  WG5                    9     10
     D  WG6                   11     12
     D  WG7                   13     14
     D  WG8                   15     16
     D  WG                     1     16    DIM(8)
     D  SVAKD1                 1      2
     D  SVAKD2                 3      4
     D  SVAKD3                 5      6
     D  SVAKD4                 7      8
     D  SVAKD5                 9     10
     D  SVAKD6                11     12
     D  SVAKD7                13     14
     D  SVAKD8                15     16

      * Array for SVASV
     D                 DS
     D  WH1                    1      3
     D  WH2                    4      6
     D  WH3                    7      9
     D  WH4                   10     12
     D  WH5                   13     15
     D  WH6                   16     18
     D  WH7                   19     21
     D  WH8                   22     24
     D  WH                     1     24    DIM(8)
     D  SVASV1                 1      3
     D  SVASV2                 4      6
     D  SVASV3                 7      9
     D  SVASV4                10     12
     D  SVASV5                13     15
     D  SVASV6                16     18
     D  SVASV7                19     21
     D  SVASV8                22     24

      * Array for SVABL
     D                 DS
     D  WI1                    1     11S 2
     D  WI2                   12     22S 2
     D  WI3                   23     33S 2
     D  WI4                   34     44S 2
     D  WI5                   45     55S 2
     D  WI6                   56     66S 2
     D  WI7                   67     77S 2
     D  WI8                   78     88S 2
     D  WI                     1     88S 2 DIM(8)
     D  SVABL1                 1     11S 2
     D  SVABL2                12     22S 2
     D  SVABL3                23     33S 2
     D  SVABL4                34     44S 2
     D  SVABL5                45     55S 2
     D  SVABL6                56     66S 2
     D  SVABL7                67     77S 2
     D  SVABL8                78     88S 2

      * Array for SVAGR
     D                 DS
     D  WJ1                    1     11S 2
     D  WJ2                   12     22S 2
     D  WJ3                   23     33S 2
     D  WJ4                   34     44S 2
     D  WJ5                   45     55S 2
     D  WJ6                   56     66S 2
     D  WJ7                   67     77S 2
     D  WJ8                   78     88S 2
     D  WJ                     1     88S 2 DIM(8)
     D  SVAGR1                 1     11S 2
     D  SVAGR2                12     22S 2
     D  SVAGR3                23     33S 2
     D  SVAGR4                34     44S 2
     D  SVAGR5                45     55S 2
     D  SVAGR6                56     66S 2
     D  SVAGR7                67     77S 2
     D  SVAGR8                78     88S 2

      * Array for SVASA
     D                 DS
     D  WK1                    1      7S 2
     D  WK2                    8     14S 2
     D  WK3                   15     21S 2
     D  WK4                   22     28S 2
     D  WK5                   29     35S 2
     D  WK6                   36     42S 2
     D  WK7                   43     49S 2
     D  WK8                   50     56S 2
     D  WK                     1     56S 2 DIM(8)
     D  SVASA1                 1      7S 2
     D  SVASA2                 8     14S 2
     D  SVASA3                15     21S 2
     D  SVASA4                22     28S 2
     D  SVASA5                29     35S 2
     D  SVASA6                36     42S 2
     D  SVASA7                43     49S 2
     D  SVASA8                50     56S 2
     D                 DS
     D  SVVNT                  1      8S 0
     D  SVVNTA                 1      8

      *get input-string
      /copy syspeds/qrpgsrcpy,prolog3

      * Parse input
     C                   EXSR      Parse
      * Open files etc
     C                   EXSR      INIT

     C                   CALLP     gethtmlifs(
     C                             '/syspeddev/html/JSON.html':
     C                             '/CGITAG/')
     C                   CALLP     wrtsection('top')
      * ............................................................................................
      * skriv JSON-Object start..(alltid '{' + x ant param. m/komma mellom (IKKE komma etter siste))
      * ............................................................................................
      /free
        JSONstring='{'
        +'¬user¬ : ¬'+%trim(WSUSER)+'¬, '
        +'¬avd¬ : ¬'+%trim(%editc(AVDN:'Z'))+'¬, '
        +'¬opd¬ : ¬'+%trim(%editc(OPDN:'Z'))+'¬, '
        +'¬lin¬ : ¬'+%trim(%editc(LINN:'Z'))+'¬, '
        +'¬errMsg¬ : ¬'+%trim(Error)+'¬, ¬oneline¬ : [';
      /end-free
      * JSONfix escaper " i tekst,  for deretter å bytte ¬->"
     C                   CALL      'JSONFIX'
     C                   PARM                    JSONstring
     C                   CALLP     updHTMLvar2('JSONstring'
     C                                         :%addr(JSONstring)
     C                                         :%len(JSONstring))
     C                   CALLP     wrtsection('JSONlin')
      * Hæmta detta ena ærendet.

     C     Error         IFEQ      *blanks
     C     DKIVKey       CHAIN     SADV                               55
     C     *IN55         IFEQ      '0'
      * ............................................................................................
      * Skriv en JSON-Array-linje pr menypunkt - komma før hvert nytt element
      * ............................................................................................
      /free
          JSONstring=*blanks;
       JSONstring=%trim(JSONstring)+'{'
          +'¬sv01¬ : ¬'+%trim(sv01)+'¬, '
          +'¬svavd¬ : ¬'+%trim(%editc(svavd:'Z'))+'¬, '
          +'¬svtdn¬ : ¬'+%trim(%editc(svtdn:'Z'))+'¬, '
          +'¬svli¬ : ¬'+%trim(%editc(svli:'Z'))+'¬, '
          +'¬svlk¬ : ¬'+%trim(svlk)+'¬, '
          +'¬svvnt¬ : ¬'+%trim(svvnta)+'¬, '
          +'¬svtn¬ : ¬'+%trim(svtn)+'¬, '
          +'¬svpre¬ : ¬'+%trim(svpre)+'¬, '
          +'¬svas¬ : ¬'+%trim(%editc(svas:'4'))+'¬, '
          +'¬svpva¬ : ¬'+%trim(svpva)+'¬, '
          +'¬svmfr¬ : ¬'+%trim(svmfr)+'¬, '
          +'¬svvf¬ : ¬'+%trim(svvf)+'¬, '
          +'¬svvktb¬ : ¬'+%trim(%editc(svvktb:'4'))+'¬, '
          +'¬svntm¬ : ¬'+%trim(%editc(svntm:'Z'))+'¬, '
          +'¬svbelt¬ : ¬'+%trim(%editc(svbelt:'4'))+'¬, '
          +'¬svbels¬ : ¬'+%trim(%editc(svbels:'4'))+'¬, '
          +'¬svvktn¬ : ¬'+%trim(%editc(svvktn:'4'))+'¬, '
          +'¬sveh21¬ : ¬'+%trim(sveh21)+'¬, '
          +'¬svpreae¬ : ¬'+%trim(svpreÆ)+'¬, '
          +'¬sveh2ae¬ : ¬'+%trim(sveh2Æ)+'¬, '
          +'¬svln¬ : ¬'+%trim(%editc(svln:'Z'))+'¬, '
          +'¬svrefl¬ : ¬'+%trim(%editc(svrefl:'Z'))+'¬, '
          +'¬svexr01¬ : ¬'+%trim(svexr01)+'¬, '
          +'¬svexr02¬ : ¬'+%trim(svexr02)+'¬, '
          +'¬svexr03¬ : ¬'+%trim(svexr03)+'¬, '
          +'¬svexr04¬ : ¬'+%trim(%editc(svexr04:'4'))+'¬, '
          +'¬svexr05¬ : ¬'+%trim(%editc(svexr05:'4'))+'¬, '
          +'¬svexr06¬ : ¬'+%trim(svexr06)+'¬, '
          +'¬svexr07¬ : ¬'+%trim(%editc(svexr07:'4'))+'¬, '
          +'¬sverr¬ : ¬'+%trim(sverr)+'¬, '
          +'¬wa1¬ : ¬'+%trim(WA1)+'¬, '
          +'¬wa2¬ : ¬'+%trim(WA2)+'¬, '
          +'¬wa3¬ : ¬'+%trim(WA3)+'¬, '
          +'¬wa4¬ : ¬'+%trim(WA4)+'¬, '
          +'¬wa5¬ : ¬'+%trim(WA5)+'¬, '
          +'¬wa6¬ : ¬'+%trim(WA6)+'¬, '
          +'¬wa7¬ : ¬'+%trim(WA7)+'¬, '
          +'¬wb1¬ : ¬'+%trim(%editc(WB1:'4'))+'¬, '
          +'¬wb2¬ : ¬'+%trim(%editc(WB2:'4'))+'¬, '
          +'¬wb3¬ : ¬'+%trim(%editc(WB3:'4'))+'¬, '
          +'¬wb4¬ : ¬'+%trim(%editc(WB4:'4'))+'¬, '
          +'¬wb5¬ : ¬'+%trim(%editc(WB5:'4'))+'¬, '
          +'¬wb6¬ : ¬'+%trim(%editc(WB6:'4'))+'¬, '
          +'¬wb7¬ : ¬'+%trim(%editc(WB7:'4'))+'¬, '
          +'¬wc1¬ : ¬'+%trim(WC1)+'¬, '
          +'¬wc2¬ : ¬'+%trim(WC2)+'¬, '
          +'¬wc3¬ : ¬'+%trim(WC3)+'¬, '
          +'¬wc4¬ : ¬'+%trim(WC4)+'¬, '
          +'¬wc5¬ : ¬'+%trim(WC5)+'¬, '
          +'¬wc6¬ : ¬'+%trim(WC6)+'¬, '
          +'¬wc7¬ : ¬'+%trim(WC7)+'¬, '
          +'¬wd1¬ : ¬'+%trim(WD1)+'¬, '
          +'¬wd2¬ : ¬'+%trim(WD2)+'¬, '
          +'¬wd3¬ : ¬'+%trim(WD3)+'¬, '
          +'¬wd4¬ : ¬'+%trim(WD4)+'¬, '
          +'¬wd5¬ : ¬'+%trim(WD5)+'¬, '
          +'¬we1¬ : ¬'+%trim(WE1)+'¬, '
          +'¬we2¬ : ¬'+%trim(WE2)+'¬, '
          +'¬we3¬ : ¬'+%trim(WE3)+'¬, '
          +'¬we4¬ : ¬'+%trim(WE4)+'¬, '
          +'¬we5¬ : ¬'+%trim(WE5)+'¬, '
          +'¬we6¬ : ¬'+%trim(WE6)+'¬, '
          +'¬we7¬ : ¬'+%trim(WE7)+'¬, '
          +'¬we8¬ : ¬'+%trim(WE8)+'¬, '
          +'¬we9¬ : ¬'+%trim(WE9)+'¬, '
          +'¬we10¬ : ¬'+%trim(WE10)+'¬, '
          +'¬wf1¬ : ¬'+%trim(WF1)+'¬, '
          +'¬wf2¬ : ¬'+%trim(WF2)+'¬, '
          +'¬wf3¬ : ¬'+%trim(WF3)+'¬, '
          +'¬wf4¬ : ¬'+%trim(WF4)+'¬, '
          +'¬wf5¬ : ¬'+%trim(WF5)+'¬, '
          +'¬wf6¬ : ¬'+%trim(WF6)+'¬, '
          +'¬wf7¬ : ¬'+%trim(WF7)+'¬, '
          +'¬wf8¬ : ¬'+%trim(WF8)+'¬, '
          +'¬wf9¬ : ¬'+%trim(WF9)+'¬, '
          +'¬wf10¬ : ¬'+%trim(WF10)+'¬, '
          +'¬wg1¬ : ¬'+%trim(WG1)+'¬, '
          +'¬wg2¬ : ¬'+%trim(WG2)+'¬, '
          +'¬wg3¬ : ¬'+%trim(WG3)+'¬, '
          +'¬wg4¬ : ¬'+%trim(WG4)+'¬, '
          +'¬wg5¬ : ¬'+%trim(WG5)+'¬, '
          +'¬wg6¬ : ¬'+%trim(WG6)+'¬, '
          +'¬wg7¬ : ¬'+%trim(WG7)+'¬, '
          +'¬wg8¬ : ¬'+%trim(WG8)+'¬, '
          +'¬wh1¬ : ¬'+%trim(WH1)+'¬, '
          +'¬wh2¬ : ¬'+%trim(WH2)+'¬, '
          +'¬wh3¬ : ¬'+%trim(WH3)+'¬, '
          +'¬wh4¬ : ¬'+%trim(WH4)+'¬, '
          +'¬wh5¬ : ¬'+%trim(WH5)+'¬, '
          +'¬wh6¬ : ¬'+%trim(WH6)+'¬, '
          +'¬wh7¬ : ¬'+%trim(WH7)+'¬, '
          +'¬wh8¬ : ¬'+%trim(WH8)+'¬, '
          +'¬wi1¬ : ¬'+%trim(%editc(WI1:'4'))+'¬, '
          +'¬wi2¬ : ¬'+%trim(%editc(WI2:'4'))+'¬, '
          +'¬wi3¬ : ¬'+%trim(%editc(WI3:'4'))+'¬, '
          +'¬wi4¬ : ¬'+%trim(%editc(WI4:'4'))+'¬, '
          +'¬wi5¬ : ¬'+%trim(%editc(WI5:'4'))+'¬, '
          +'¬wi6¬ : ¬'+%trim(%editc(WI6:'4'))+'¬, '
          +'¬wi7¬ : ¬'+%trim(%editc(WI7:'4'))+'¬, '
          +'¬wi8¬ : ¬'+%trim(%editc(WI8:'4'))+'¬, '
          +'¬wj1¬ : ¬'+%trim(%editc(WJ1:'4'))+'¬, '
          +'¬wj2¬ : ¬'+%trim(%editc(WJ2:'4'))+'¬, '
          +'¬wj3¬ : ¬'+%trim(%editc(WJ3:'4'))+'¬, '
          +'¬wj4¬ : ¬'+%trim(%editc(WJ4:'4'))+'¬, '
          +'¬wj5¬ : ¬'+%trim(%editc(WJ5:'4'))+'¬, '
          +'¬wj6¬ : ¬'+%trim(%editc(WJ6:'4'))+'¬, '
          +'¬wj7¬ : ¬'+%trim(%editc(WJ7:'4'))+'¬, '
          +'¬wj8¬ : ¬'+%trim(%editc(WJ8:'4'))+'¬, '
          +'¬wk1¬ : ¬'+%trim(%editc(WK1:'4'))+'¬, '
          +'¬wk2¬ : ¬'+%trim(%editc(WK2:'4'))+'¬, '
          +'¬wk3¬ : ¬'+%trim(%editc(WK3:'4'))+'¬, '
          +'¬wk4¬ : ¬'+%trim(%editc(WK4:'4'))+'¬, '
          +'¬wk5¬ : ¬'+%trim(%editc(WK5:'4'))+'¬, '
          +'¬wk6¬ : ¬'+%trim(%editc(WK6:'4'))+'¬, '
          +'¬wk7¬ : ¬'+%trim(%editc(WK7:'4'))+'¬, '
          +'¬wk8¬ : ¬'+%trim(%editc(WK8:'4'))+'¬}';
      /end-free
     C                   CALL      'JSONFIX'
     C                   PARM                    JSONstring
     C                   CALLP     updHTMLvar2('JSONstring'
     C                                         :%addr(JSONstring)
     C                                         :%len(JSONstring))
     C                   CALLP     wrtsection('JSONlin')

     C                   ENDIF
     C                   ENDIF
      * ............................................................................................
      * Skriv JSON-string Avsluttning
      * ............................................................................................
     C                   EVAL      JSONstring =']}'
     C                   CALLP     updHTMLvar2('JSONstring'
     C                                         :%addr(JSONstring)
     C                                         :%len(JSONstring))
     C                   CALLP     wrtsection('JSONlin')
      * Quit
     C                   EXSR      EXIT
      *=====================================================================
      * Close output html and quit
      *=====================================================================
     C     EXIT          BEGSR
      * Lukk fil
     C                   CLOSE     BRIDF
     C  N50              CLOSE     SADV

      * Do not delete the CALL to wrtsection with section name *fini.  It is needed
      * to ensure that all output html that has been buffered gets output.
     C                   CALLP     wrtsection('*fini')
      * Quit
     C                   MOVE      *ON           *INLR
     C                   RETURN
     C                   ENDSR
      *********************************************************
     C     Parse         BEGSR
      *********************************************************
      * Get input
     C                   EVAL      WSUSER  = zhbgetvar('USER')
     C                   EVAL      AVD     = zhbgetvar('AVD')
     C                   EVAL      AVDN    = c2n2(AVD)
     C                   EVAL      OPD     = zhbgetvar('OPD')
     C                   EVAL      OPDN    = c2n2(OPD)
     C                   EVAL      LIN     = zhbgetvar('LIN')
     C                   EVAL      LINN    = c2n2(LIN)
     C                   ENDSR
      *********************************************************
     C     INIT          BEGSR
      *********************************************************
     C                   OPEN      BRIDF
      * Test innlogging
     C     WSUSER        CHAIN     BRIDF                              50
     C     BILIBL        IFEQ      *blanks
     C                   CALLb     'INCGI'
     C                   PARM                    BISTDL
     C                   else
     C                   CALL      BILIBL
     C                   end

     C     DKIVKey       klist
     C                   kfld                    AVDN
     C                   kfld                    OPDN
     C                   kfld                    LINN

     C   50              EVAL      Error = 'Invalid userID'
     C  N50              OPEN      SADV

     C                   ENDSR
