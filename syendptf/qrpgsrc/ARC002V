********************************************************************
      * RETTINGER I DETTE PROGRAM:
PTFnr:*Sek Sig Vers  Beskrivelse...........................
""""""*"""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""
10XXX * 01 SH  PTF10 kunde må stemme på vedlegg av faktura/sad
10XXX * 02 SH  PTF10 kundnivå  avvik
10XXX * 03 SH  PTF10 indikatorfeil
10XXX * 04 SH  PTF10 feil ved lenke
10XXX * 05 SH  PTF11 vedlegg ved clive=' '
      *----------------------------------------------------
      *      PTF  11
      *----------------------------------------------------
10XXX * 06 SH  PTF11 sjekker at vedlegg eksisterer
10XXX * 07 SH  PTF11 NYE FELT I WORKFIILE
10XXX * 08 SH  PTF11 spesial cs  CMR SAMLE kun 1 pr kunde
10XXX * 09 SH  PTF11 legg på T-dokument ** STORE ENDRINGER UTEN MERKING ****
      *----------------------------------------------------
      *      PTF  12
      *----------------------------------------------------
10XXX * 10 SH  PTF12 bane historikk
10XXX * 11 SH  PTF12 tester arkund for kode sd  dokumentkontroll
10XXX * 12 SH  PTF12 legg også link ved vedlegg
10XXX * 13 SH  PTF12 http rettelse
10XXX * 14 SH  PTF12 google
10XXX * 15 SH  PTF12 mer google
12XXX * 16 YBC PTF12 Sjekk låsing på nedlastingsfil fra Google
12XXX * 17 SH  PTF12 trenger ikke laste ned sk/sg
     H DECEDIT(',') debug(*yes)
      ***********************************************************
      *** PROGRAM for arkivering
      ***********************************************************
n14  Ffirmgoog  IF   E           K DISK
     Fheadf     IF   E           K DISK
     FARKIVL06  IF   E           K DISK
     F                                     RENAME(arkivr:arkivr06)
N02  FARKVEDK   IF   E           K DISK
     Ffirm      IF   E           K DISK
     Ffirmarc   IF   E           K DISK
     FARKEXT    IF   E           K DISK
     FARKTXT    IF   E           K DISK
     FARUSERL1  IF   E           K DISK
     FARKEPO    UF A E           K DISK
     FARKEPOL1  IF   E           K DISK
     F                                     RENAME(arkepor:arkepor1)
N14  FARKEPOL2  UF   E           K DISK
N14  F                                     RENAME(arkepor:arkepor2)
s08  F*RKIVL02  IF   E           K DISK
n08  FARKIVL02  UF   E           K DISK
     D                SDS
     D  UUSR                 254    263
     D                 DS
     D  uuvedl                 1     60
     D  V01                    1      2
     D  V02                    3      4
     D  V03                    5      6
     D  V04                    7      8
     D  V05                    9     10
     D  V06                   11     12
     D  V07                   13     14
     D  V08                   15     16
     D  V09                   17     18
     D  V10                   19     20
     D  V11                   21     22
     D  V12                   23     24
     D  V13                   25     26
     D  V14                   27     28
     D  V15                   29     30
     D  V16                   31     32
     D  V17                   33     34
     D  V18                   35     36
     D  V19                   37     38
     D  V20                   39     40
     D  V21                   41     42
     D  V22                   43     44
     D  V23                   45     46
     D  V24                   47     48
     D  V25                   49     50
     D  V26                   51     52
     D  V27                   53     54
     D  V28                   55     56
     D  V29                   57     58
     D  V30                   59     60
     D  ako                    1     60
     D                                     DIM(30)
      *
     c                   exsr      init
     c                   exsr      les
N14  C     google        ifeq      'J'
N14  c                   exsr      goog
N14  c                   end
     c                   seton                                        lr
     c                   return
     C***********************************************
     C     init          BEGSR
     C***********************************************
     C*
     C     *ENTRY        PLIST
     c                   parm                    utype             2
     c                   parm                    uavd              4
     c                   parm                    uopd              7
     c                   parm                    uved             60
     c                   parm                    clive             1
     c                   parm                    arinek            1
n01  c                   parm                    ukunde            8 0
     c*                  dump
N02  C     KEYVED        KLIST
N02  C                   KFLD                    FIFIRM
N02  C                   KFLD                    AVKUND
N02  C                   KFLD                    AVTYPE
N02  c                   read      firm                                   37
N02  C                   MOVE      UKUNDE        AVKUND
N02  C                   MOVE      UTYPE         AVTYPE
N02  C     KEYVED        CHAIN     ARKVEDK                            33
      *
      *
N02  C     *IN(33)       IFEQ      '1'
     c                   move      uved          uuvedl
N02  C                   ELSE
N02  c                   move      AVKVED        uuvedl
N02  C                   END
N09   * ved cs må godslister utelates
N09  C     utype         ifeq      'cs'
N09  c                   move      'go'          utype
N09  c                   end
     c     key           klist
     c                   kfld                    ustat             1
     c                   kfld                    aravd
     c                   kfld                    aropd
     c                   move      'A'           ustat
N07  c                   move      'N'           EPMAIN
N07  c                   move      uavd          EPAVD
N07  c                   move      uopd          EPOPD
     c                   move      uavd          aravd
     c                   move      uopd          aropd
     c     key2          klist
     c                   kfld                    epuser
     c                   kfld                    eplink
     C*
     c     key3          klist
     c                   kfld                    epuser
     c                   kfld                    epbane
     C*
     C     arklagk       KLIST
     C                   KFLD                    fifirm
     C                   KFLD                    arklag
     C*
S02  c*                  read      firm                                   37
     c                   move      uusr          epuser
n14  c     fifirm        chain     firmgoog                           33
n14  c  n33              move      'J'           google            1
     c                   endsr
     C***********************************************
     C     les           BEGSR
     C***********************************************
N03  c                   setoff                                       33
     c     key           setll     arkivl02
     c     *in(33)       doweq     '0'
N08  c     lesny         tag
     c     key           reade     arkivl02                               33
     c     *in(33)       ifeq      '0'
      * ikke skrive egen dokumenttype
N08  c     artype        ifeq      'cs'
N08  c     arfri         andne     'NY'
N08  c                   update    arkivr
N08  c                   goto      lesny
N08  c                   else
N08  c                   move      *blanks       arfri
N08  c                   update    arkivr
N08  c                   end
     c     artype        ifne      utype
     c     utype         ifeq      'fs'
     c     artype        andne     'fx'
     c                   exsr      test
     c                   else
     c                   exsr      test
     c                   end
     c                   end
     c                   end
     c                   end
     c                   endsr
     C***********************************************
     C     test          BEGSR
     C***********************************************
n01   * ved faktura og sad må kundenr stemme og ved cs=CMRSAMLE
      *
n01  C     artype        ifeq      'fa'
n01  c     artype        oreq      'fs'
n01  c     artype        oreq      'fx'
n01  c     artype        oreq      'si'
n01  c     artype        oreq      'se'
n01  c     artype        oreq      'sf'
n01  c     artype        oreq      'sg'
n01  c     artype        oreq      'si'
n01  c     artype        oreq      'sj'
n01  c     artype        oreq      'sk'
n06  c     artype        oreq      'cs'
n11  c     artype        oreq      'sd'
n01  c     ukunde        ifne      arkund
n01  c                   goto      avbryt
n01  c                   end
n01  c                   end
     c                   sorta     ako
     c                   setoff                                       30
     C     artype        LOOKUP    ako                                    30
     C  N30              DO
     C     ARTYPE        IFEQ      'sk'
     C     'si'          lookup    ako                                    30
     C                   end
     C     ARTYPE        IFEQ      'sg'
     C     'se'          lookup    ako                                    30
     C                   end
     C                   end
      *
     c     *in(30)       ifeq      '1'
      * finner bane
     c     artype        chain     ARKTXT                             35
      *
      * intern eksternlager
      *
     C     ARKLAG        IFNE      *blanks
     c     arklagk       chain     arkext
     c                   else
     c     fifirm        chain     firmarc                            35
     c                   end
      *
     c                   move      *blanks       ubane            50
     c                   move      *blanks       ubanel           76
      *
      * ved vedlegg
      *
     c     clive         ifeq      'V'
n05  c     clive         oreq      ' '
     c                   exsr      vedlegg
     c                   else
     c                   exsr      link
     c                   end
     c                   end
s01  c*                  endsr
n01  c     avbryt        endsr
     C***********************************************
     C     vedlegg       BEGSR
     C***********************************************
     C                   exsr      fixbane
      * ikke finnes fra før
     c     key3          chain     arkepol1                           31
     c     *in(31)       ifeq      '1'
N15   * tester hvis ikke google
N15  c     google        ifne      'J'
      * tester om vedlegg finnes
n06  C                   move      *blanks       nyobj            50
n06  C                   move      *blanks       ubanet          256
n06  c                   eval      ubanet=ubane
n06  C                   eval      nyobj=arlink
n06  C     '.'           SCAN      nyobj                                  44
n06  c  N44nyobj         CAT       '.pdf':0      nyobj
N06  c                   call      'SYGE98CL'
N06  C                   PARM                    ubanet
N06  C                   PARM                    nyobj
N06  c                   parm                    fins              1
n15   * test hvis google
n15  c                   else
N15   *          Sysped-genererte dokumenter mangler .pdf- Hvis ARLINK mangler . legg på .pdf
N15  c                   move      *blanks       ARLINK_X         50
N15  c                   eval      nyobj = ARLINK
N15  C     '.'           SCAN      nyobj                                  33
N15  C  N33              eval      nyobj = %trim(nyobj)+'.pdf'
N15   * finens dokument i Google cloud
N15  c                   eval      GC_url=%trim(GOLENK)+%trim(nyobj)
N15  c                   call      'ARC99WSE1'
N15  c                   parm                    GC_url          256
N15  c                   parm                    fins              1
N15  c                   end
N08  c                   move      'N'           epmain
N06  c     fins          ifeq      'J'
N08  c     artype        ifeq      'cs'
N08  c                   move      'J'           epmain
N08  c                   end
N12  c                   exsr      fixlink2
     c                   write     arkepor
N08  c     artype        ifeq      'cs'
N09  c                   exsr      tdoksr
N08  c                   end
n06  c                   end
     c                   end
      *
     c                   endsr
      *
     C***********************************************
     C     link          BEGSR
     C***********************************************
      *
     c                   exsr      fixlink
      *
      *
     C     ubanel        CAT       arlink:0      ubanel
     C     ARKLAG        IFeq      *blanks
N04  C     '.'           SCAN      ubanel                                 44
s04  C*    ubanel        CAT       '.pdf':0      ubanel
n04  C  N44ubanel        CAT       '.pdf':0      ubanel
     c                   end
     c                   movel     ubanel        eplink
     c                   movel     ubanel        epline
      * ikke finnes fra før
     c     key2          chain     arkepo                             31
     c     *in(31)       ifeq      '1'
N08  c                   move      'N'           epmain
N08  c     artype        ifeq      'cs'
N08  c                   move      'J'           epmain
N08  c                   end
     c                   write     arkepor
     c                   end
     c                   endsr
      *
N09  C***********************************************
N09  C     tdoksr        BEGSR
N09  C***********************************************
N09  c     keyhea        klist
N09  c                   kfld                    aravd
N09  c                   kfld                    aropd
N09  c     keya06        klist
N09  c                   kfld                    arfirm
N09  c                   kfld                    type              2
N09  c                   kfld                    trund            10
N09  c                   move      'te'          type
N09  c     keyhea        chain     headf
N09  c     hepro         ifne      0
N09   *
N09   * først hoveddokumentet
N09   *
N09  c                   movel     hepro         trund
N09  c     trund         cat       'J':1         trund
N09  c     keya06        setll     arkivl06
N09  c                   setoff                                       34
N09  c     *in34         doweq     '0'
N09  c     keya06        reade     arkivl06                               34
N09  c     *in34         ifeq      '0'
N09  c                   exsr      fixbane
N09   *
N09   * ikke finnes fra før
N09  c     key3          chain     arkepol1                           31
N09  c     *in(31)       ifeq      '1'
N09  c                   move      'N'           epmain
N09  c                   write     arkepor
N09  c                   end
N09  c                   end
N09  c                   end
N09   *
N09   * deretter vareliste transitt
N09   *
N09  c                   move      'tf'          type
N09  c     keya06        setll     arkivl06
N09  c                   setoff                                       34
N09  c     *in34         doweq     '0'
N09  c     keya06        reade     arkivl06                               34
N09  c     *in34         ifeq      '0'
N09  c                   exsr      fixbane
N09   * ikke finnes fra før
N09  c     key3          chain     arkepol1                           31
N09  c     *in(31)       ifeq      '1'
N09  c                   move      'N'           epmain
N09  c                   write     arkepor
N09  c                   end
N09  c                   end
N09  c                   end
N09  c                   end
N09   * tilbakestill
N09  c                   move      uavd          EPAVD
N09  c                   move      uopd          EPOPD
N09  c                   move      uavd          aravd
N09  c                   move      uopd          aropd
N09  c                   endsr
      **********************************************************************************
     c     fixlink       begsr
      **********************************************************************************
N10  c     arbhis        ifne      *blanks
N10  c                   eval      arcane=arbhis
N10  c                   end
      *
      * intern
      *
     c                   move      *blanks       ubanel
     c     arinek        ifeq      'I'
     c     arinek        oreq      ' '
     c                   movel     'http://'     ubanel
N13  c                   if        ARCPSI='J'
N13  c                   eval      ubanel = 'https://'
N13  c                   endif
     C     ubanel        CAT       arcpad:0      ubanel
     C     ubanel        CAT       '/':0         ubanel
     C     ubanel        CAT       arcane:0      ubanel
     C     ubanel        CAT       '/':0         ubanel
      *
      * ekstern
      *
     c                   else
     C                   move      *blanks       ubanel           76
     c                   movel     'http://'     ubanel
N13  c                   if        ARCPSE='J'
N13  c                   eval      ubanel = 'https://'
N13  c                   endif
     C     ubanel        CAT       arcpae:0      ubanel
     C     ubanel        CAT       '/':0         ubanel
     C     ubanel        CAT       arcane:0      ubanel
     C     ubanel        CAT       '/':0         ubanel
      *
     c                   end
      *
     c                   endsr
      **********************************************************************************
N12  c     fixlink2      begsr
n12   **********************************************************************************
N12  c     arbhis        ifne      *blanks
N12  c                   eval      arcane=arbhis
N12  c                   end
N12   *
n12   * intern
N12   *
N12  c                   move      *blanks       eplink
N12  c                   move      *blanks       epline
      *
N12  c                   movel     'http://'     eplink
N13  c                   if        ARCPSI='J'
N13  c                   eval      eplink = 'https://'
N13  c                   endif
N12  C     eplink        CAT       arcpad:0      eplink
N12  C     eplink        CAT       '/':0         eplink
n12  C     eplink        CAT       arcane:0      eplink
N12  C     eplink        CAT       '/':0         eplink
n12  C     eplink        cat       arlink:0      eplink
n06  C     '.'           SCAN      eplink                                 44
n06  c  N44eplink        CAT       '.pdf':0      eplink
N12   *
N12   * ekstern
N12   *
N12  c                   movel     'http://'     epline
N13  c                   if        ARCPSE='J'
N13  c                   eval      epline = 'https://'
N13  c                   endif
N12  C     epline        CAT       arcpae:0      epline
N12  C     epline        CAT       '/':0         epline
n12  C     epline        CAT       arcane:0      epline
N12  C     epline        CAT       '/':0         epline
n12  C     epline        cat       arlink:0      epline
n06  C     '.'           SCAN      epline                                 44
n06  c  N44epline        CAT       '.pdf':0      epline
N12   *
      *
     c                   endsr
      **********************************************************************************
     c     fixbane       begsr
      **********************************************************************************
N10  c     arbhis        ifne      *blanks
N10  c                   eval      arcane=arbhis
N10  c                   end
     c                   move      *blanks       ubane
     c                   movel     '/'           ubane
     c     arcane        ifne      *blanks
     C     ubane         CAT       arcane:0      ubane
     C     ubane         CAT       '/':0         ubane
     c                   end
     C     ubane         CAT       arlink:0      ubane
     C     ARKLAG        IFeq      *blanks
     c
     C     '.'           SCAN      ubane                                  44
     c  N44ubane         CAT       '.pdf':0      ubane
     c                   end
     c                   eval      epbane=ubane
     c                   endsr
n14   ****************************************************************************
n14  c     goog          begsr
n14   ****************************************************************************
n14  c     keyusr        klist
N14  C                   KFLD                    EPUSER
n14  c                   setoff                                       33
n14  c     keyusr        setll     arkepol2
n14  c     *in(33)       doweq     '0'
n14  c     keyusr        reade     arkepol2                               33
n14  c     *in(33)       ifeq      '0'
n14  c                   z-add     1             pos               3 0
n14  c                   z-add     0             str               3 0
n14  c                   move      *blanks       DOKFRA           60
n14  c                   move      *blanks       BANEFRA         100
n14   * finn dokumentnavn i epbane
n14  c                   dow       Pos<> 0
n14  c                   eval      Pos= %SCAN ('/' : EPBANE: Str+1)
n14  c                   if        Pos<> 0
n14  c                   eval      Str= Pos
n14  c                   endif
n14  c                   enddo
n14  c                   eval      DOKFRA    = %subst(EPBANE:Str+1)
N14  c                   moveL     DOKFRA        WRKTYP            2
N14  c                   eval      BANEFRA   = %subst(EPBANE:1:Str)
n14   * tempmappe
n14  c                   eval      gotmpf100=gotmpf
n14  c                   eval      epbane=%trim(gotmpf) + %trim(dokfra)
n14   * fikser eplink epline
n14  c                   eval      eplink=%trim(golenk) + %trim(dokfra)
n14  c                   eval      epline=%trim(golene) + %trim(dokfra)
     c                   eval      uNewFile=*blanks
n14   * last ned fil til temp
n14   * hoveddokument er allerede i tempmappen
N14  c     WRKTYP        ifne      utype
n17  c*tilleggsark er allerede i tempmappern
n17  c     utype         ifeq      'si'
n17  c     wrktyp        andeq     'sk'
n17  c                   goto      ikkelast
n17  c                   end
n17  c     utype         ifeq      'se'
n17  c     wrktyp        andeq     'sg'
n17  c                   goto      ikkelast
n17  c                   end
n14  c                   call      'ARC99WSD1'
n14  c                   parm                    gobuid           10
n14  c                   parm                    gotmpf100       100
n14  c                   parm                    dokfra           60
     c                   parm                    uNewFile         60
n14  c                   parm                    uok               1
n14  c     uok           ifeq      'J'
n14  c                   update    arkepor2
N16   * SJEKK OM FIL ER LÅST. HVIS JA, VENT INNTIL 20 GANGER 1 SEKUND
N16  C                   EVAL      X_IFS = epbane
N16  C     1             DO        20
N16  C                   CALL      'SYGE140CL'
N16  C                   PARM                    X_IFS           256
N16  C                   PARM                    UOK
N16  C                   Z-ADD     1             USEC              3 0
N16  C                   CALL      'DLYJBSEC'
N16  C                   PARM                    USEC
N16  C                   IF        UOK = '0'
N16  C                   LEAVE
N16  C                   END
N16  C                   ENDDO
N16   *
N14  c                   else
n14  c*                  delete    arkepor2
n14  c                   end
n14   * allerede i tmp mappen
n14  c                   else
n17  c     ikkelast      tag
n14  c                   update    arkepor2
n14  c                   end
n14  c                   endif
n14  c                   enddo
n14  C                   endsr
