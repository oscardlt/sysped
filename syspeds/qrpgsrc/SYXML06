      *
      ***********************************************************
      *** PROGRAM SKAL SENDE XML-FAKTURA DNB-NOR              ***
      *** OBS! <ClientId> er hardkort !!!!!!!!!!!!!!!!!       ***
      *** INDIKATORER 01 - 26 KUN CMD-TASTER / ROLL TASTER    ***
      *** LEDIGE INDIKATORER 01-26                            ***
      *** LEDIGE INDIKATORER 27-32 34-49 51-99                ***
      ***********************************************************
     FFIRM      IF   E           K DISK
     FTELLGE    UF A E           K DISK
     FXMLUFL1   UF   E           K DISK
     FXMLTP1K   O  A E           K DISK    USROPN
     FECMSG     IF   E           K DISK
     FKODWL01   IF   E           K DISK    USROPN
     FKODTA     IF   E           K DISK
     FKODTFR    IF   E           K DISK
     FKODTGE    IF   E           K DISK
     FKODTG2    IF   E           K DISK
     FCUNDL01   IF   E           K DISK    USROPN
     FFAIN      IF   E           K DISK    USROPN
     FHEADF     IF   E           K DISK    USROPN
     FFAK8      IF   E           K DISK    USROPN
     FFAKTXT    IF   E           K DISK    USROPN
     FFRISOK    IF   E           K DISK    USROPN
     FFIRMARC   IF   E           K DISK
     FSORT      UF A E           K DISK
     FEDIC      UF A E             DISK    USROPN
     FEDIS      O  A E             DISK    USROPN
     FEDIM      O  A E             DISK    USROPN
     FEDISE1K   O  A E             DISK    USROPN
     FSYXML06P  O    E             PRINTER USROPN
     F                                     OFLIND(*IN27)
     D                 DS
     D  XDATA                  1   2048
     D  XDATA1                 1   1024
     D  XDATA2              1025   2048
     D  XDATAX                 1   1024    DIM(1024)
     D                 DS
     D  XTXT2561               1    300
     D  XT2561                 1    300    DIM(300)
     D                 DS
     D  XTXT2562               1    300
     D  XT2562                 1    300    DIM(300)
     D                 DS
     D  XMBR                   1     10
     D  XMBRA                  1      1
     D  XMBRB                  2     10S 0
     D                 DS
     D  WDT                    1      8
     D  WDTÅ                   1      4
     D  WDTM                   5      6
     D  WDTD                   7      8
     D                 DS
     D  WTM                    1      6
     D  WTMH                   1      2
     D  WTMM                   3      4
     D  WTMS                   5      6
     D                 DS
     D  HEAVD                  1      4  0
     D  XXSTREKK1              5      5
     D  HEOPD                  6     12  0
     D  XXSTREKK2             13     13
     D  HESG                  14     16
     D  SYSPEDREF              1     16
     D  XXSTREKK3             17     17
     D  XXLNR                 18     22  0
     D  SYSPEDREFS             1     22
     D                 DS
     D  HEDTOP                 1      8  0
     D  HEDTOPÅ                1      4
     D  HEDTOPM                5      6
     D  HEDTOPD                7      8
     D                 DS
     D  FADATO                 1      8  0
     D  FADATOÅ                1      4
     D  FADATOM                5      6
     D  FADATOD                7      8
     D                 DS
     D  FADAFF                 1      8  0
     D  FADAFFÅ                1      4
     D  FADAFFM                5      6
     D  FADAFFD                7      8
     D                 DS
     D  XMLT1                  1     44  2 DIM(11)
     D  XFMS01                 1      4  2
     D  XFMS02                 5      8  2
     D  XFMS03                 9     12  2
     D  XFMS04                13     16  2
     D  XFMS05                17     20  2
     D  XFMS06                21     24  2
     D  XFMS07                25     28  2
     D  XFMS08                29     32  2
     D  XFMS09                33     36  2
     D  XFMS10                37     40  2
     D  XFMS11                41     44  2
     D                 DS
     D  XMLT2                  1     33    DIM(11)
     D  XFMV01                 1      3
     D  XFMV02                 4      6
     D  XFMV03                 7      9
     D  XFMV04                10     12
     D  XFMV05                13     15
     D  XFMV06                16     18
     D  XFMV07                19     21
     D  XFMV08                22     24
     D  XFMV09                25     27
     D  XFMV10                28     30
     D  XFMV11                31     33
     D                 DS
     D  XMLT3                  1    143  2 DIM(11)
     D  XFMGN1                 1     13  2
     D  XFMGN2                14     26  2
     D  XFMGN3                27     39  2
     D  XFMGN4                40     52  2
     D  XFMGN5                53     65  2
     D  XFMGN6                66     78  2
     D  XFMGN7                79     91  2
     D  XFMGN8                92    104  2
     D  XFMGN9               105    117  2
     D  XFMGNA               118    130  2
     D  XFMGNB               131    143  2
     D                 DS
     D  XMLT4                  1    143  2 DIM(11)
     D  XFMGV1                 1     13  2
     D  XFMGV2                14     26  2
     D  XFMGV3                27     39  2
     D  XFMGV4                40     52  2
     D  XFMGV5                53     65  2
     D  XFMGV6                66     78  2
     D  XFMGV7                79     91  2
     D  XFMGV8                92    104  2
     D  XFMGV9               105    117  2
     D  XFMGVA               118    130  2
     D  XFMGVB               131    143  2
     D                 DS
     D  SYKT8                  1      8
     D  SYFR02                 1      1
     D  SYKT7                  2      7
     D  SYKONT                 2      8  0
     D                 DS
     D  SYRG                   1     14
     D  SYRG9                  1      9
     D                 DS
     D  SOLNR                  1      3  0
     D  KG2SRT                 1      3  0
     D                 DS
     D  SOAVD                  4      7  0
     D  FAAVD                  4      7  0
     D  SOOPD                  8     14  0
     D  FAOPD                  8     14  0
     D  SOSK                  15     15
     D  FASK                  15     15
     D  SOVK                  16     18
     D  FAVK                  16     18
     D  SOVT                  19     38
     D  FAVT                  19     38
     D  FAVT01                19     19
     D  FAVT02                20     38
     D  XFAVT1                19     19
     D  XFAVT2                20     38
     D  SOVAL                 39     41
     D  FAVAL                 39     41
     D  SOBELV                42     54  2
     D  FABELV                42     54  2
     D  SOKDM                 55     55
     D  FAKDM                 55     55
     D  SOBELN                56     68  2
     D  FABELN                56     68  2
     D  SOSAMM                69     69
     D  FACD11                69     69
     D  SOLI                  70     74  0
     D  FALI                  70     74  0
     D  SOFBNR                75     77  0
     D  FAFRBN                75     77  0
      *
     C                   EXSR      INIT
      *
      * Teller antall fakturaer
     C     START         TAG
     C                   MOVE      ' '           XXST
     C                   MOVE      ' '           XXSAML            1
     C                   MOVE      *BLANKS       XDATA
     C                   MOVE      *ZEROS        S0036
     C     XMLUFL1K      SETLL     XMLUFL1
     C     XMLUFL1K      READE     XMLUFL1                                50
     C   50              GOTO      SLUTT
     C                   MOVE      XFKN          XXKN              8 0
     C                   MOVE      XFVAL         XXVAL             3
     C                   MOVE      'N'           XXOK              1
     C                   MOVE      *ZEROS        XSFTOT1          13 2          TOTAL FAKTURA
     C                   MOVE      *ZEROS        XSFTOT2          13 2          TOTAL CREDITNOTA
     C                   DOW       *IN50 = *OFF
     C                   IF         XFVAL  = XXVAL
     C                   SELECT
     C                   WHEN      ((XFSAML = 'N') AND (XXSAML = ' '))
     C                   MOVE      'N'           XXSAML
     C                   WHEN      ((XFSAML = 'J') AND (XXSAML = ' '))
     C                   MOVE      'J'           XXSAML
     C                   WHEN      ((XFSAML = 'J') AND (XXSAML = 'N'))
     C                   GOTO      XNESTEFAK
     C                   END
     C     ECMSGK        CHAIN     ECMSG                              33
     C   33ECMSGK2       CHAIN     ECMSG                              33
     C                   IF        *IN33 = *OFF
     C                   ADD       1             S0036
     C                   MOVE      'A'           XFST
     C                   MOVE      'J'           XXOK
     C                   END
     C                   END
     C     XNESTEFAK     TAG
     C                   UPDATE    XMLUFFR
      *
     C                   IF        XXSAML = 'J'
     C                   MOVE      *ON           *IN50
     C                   END
     C  N50XMLUFL1K      READE     XMLUFL1                                50
     C                   ENDDO
     C     XXOK          CABEQ     'N'           SLUTT
      *
      *
     C                   EXSR      SRBYGGF
     C                   EXSR      SRSNDST
     C                   EXSR      SRENVELOP
      *
     C                   MOVE      'A'           XXST
     C     XMLUFL1K      SETLL     XMLUFL1
     C     XMLUFL1K      READE     XMLUFL1                                50
     C                   DOW       *IN50 = *OFF
      *
     C                   EXSR      SRINVOICE
      * Oppdate EDIM
     C                   EXSR      OPDEDIM
      * Oppdater XMLUFF
     C                   MOVE      'C'           XFST
     C                   MOVE      WDT           XFDTS
     C                   MOVE      WTM           XFTDS
     C                   UPDATE    XMLUFFR
      *
     C     XMLUFL1K      READE     XMLUFL1                                50
     C                   ENDDO
      *
     C                   EXSR      SRSNDSL
     C                   EXSR      SRCLOSE
     C                   GOTO      START
      *
     C     SLUTT         TAG
     C                   MOVE      *ON           *INLR
     C                   RETURN
      *
      ***********************************************
     C     SRBYGGF       BEGSR
      ***********************************************
     C                   CALL      'SYXML06B'
     C                   OPEN      XMLTP1K
      *
     C                   ENDSR
      *
      ***********************************************
     C     SRSNDST       BEGSR
      ***********************************************
     C                   OPEN      KODWL01
     C                   OPEN      CUNDL01
     C                   OPEN      FAIN
     C                   OPEN      HEADF
     C                   OPEN      FAK8
     C                   OPEN      FAKTXT
     C                   OPEN      FRISOK
     C                   OPEN      EDIC
     C                   OPEN      EDIS
     C                   OPEN      EDIM
     C                   OPEN      EDISE1K
     C                   OPEN      SYXML06P
      *
     C     ECMSGK        CHAIN     ECMSG                              33
     C     1             CHAIN     EDIC                               33
     C                   ADD       1             CSN
     C                   UPDATE    EDICR
      *
     C                   MOVE      *BLANKS       XMBR
     C                   MOVE      'F'           XMBRA
     C                   MOVE      CSN           XMBRB
     C                   MOVE      XMBR          SEMBR
     C                   MOVE      *BLANKS       SDATA
     C                   CALL      'SYGE15C'
     C                   PARM                    WDT
     C                   PARM                    WTM
      *
     C                   EVAL      S0004 = ECIIDI
     C                   EVAL      S0010 = ECIIDC
     C                   EVAL      S0020 = SEMBR
     C                   EVAL      SSN   = CSN
     C                   EVAL      SSR   = 'S'
     C                   EVAL      SST   = 'X'
     C                   MOVE      WDT           SDT
     C                   MOVE      WTM           STM
     C                   EVAL      S0026 = 'XML-INV. DNB'
     C                   EVAL      SLIB  = '*LIBL'
     C                   EVAL      SFILE = 'EDISE1K'
     C                   EVAL      SMBR  = SEMBR
     C                   EVAL      SMBRS  = 0
     C                   WRITE     EDISR
      *
     C                   MOVE      *ZEROS        XANTMSG           5 0
     C                   MOVE      *ZEROS        XXANTF
     C                   MOVE      *ZEROS        XXANTK
     C                   MOVE      *ON           *IN27
      *
      /free
       XDATA1K =
         '<?xml version="1.0" encoding="ISO-8859-1" ?>'
       + '<BatchCollection xmlns="http://www.dnbnorfinans.no/Factoring/2004" '
       + 'xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" '
       + 'xsi:schemaLocation="http://www.dnbnorfinans.no/Factoring/2004 '
       + 'FACTINV-2-2.XSD" Version="2.2" DefinedBy="DnB NOR Finans">'
       + '<TransferDateTime>'+WDTÅ+'-'+WDTM+'-'+WDTD+'T'+WTMH+':'+WTMM+':'+WTMS
       + '</TransferDateTime>';
      /end-free
      *
     C                   EXSR      TILFIL
      *
     C                   ENDSR
      *
      ***********************************************
     C     SRENVELOP     BEGSR
      ***********************************************
      *
     C     KODTAK        CHAIN     KODTA                              33
     C                   MOVE      KOAKNR        KUNDNR
     C     CUNDL01K      CHAIN     CUNDL01                            33
     C                   EVAL      XTXT2561 = KNAVN
     C                   EXSR      KNVST
     C                   MOVEL     XTXT2562      XKNAVN          256
      *
     C                   MOVE      'SYS0001'     XMSGNR            7            MELDING-ID
     C                   Z-ADD     3             XLEVEL            1 0          NIVÅ
     C                   Z-ADD     0             XRETUR            1 0          RETURKODE
     C                   Z-ADD     10            XMSGL             4 0          LENGDE PÅ MELDING
     C                   CALL      'SUBR23R3'
     C                   PARM                    XMSGNR
     C                   PARM                    XMSG             10
     C                   PARM                    XLEVEL
     C                   PARM                    XRETUR
     C                   PARM                    XMSGL
      *
     C     'DNB-NOR '    CHAIN     TELLGE                             33
     C                   IF        *IN33
     C                   EVAL      GECO = 'DNB-NOR'
     C                   Z-ADD     2             GENO
     C                   Z-ADD     1             XBATCHNR          3 0
     C                   WRITE     TELLGER
     C                   ELSE
     C                   EVAL      XBATCHNR = GENO
     C                   ADD       1             GENO
     C                   UPDATE    TELLGER
     C                   END
      *
      /free
       XDATA1K =
         '<Batch>'
       +  '<ClientId>' + '1234' + '</ClientId>'
       +  '<ClientName>' + %TRIM(XKNAVN) + '</ClientName>'
       +  '<BatchDate>' + WDTÅ + '-' + WDTM + '-' + WDTD + '</BatchDate>'
       +  '<BatchNbr>' + %TRIM(%EDITC(XBATCHNR:'Z')) + '</BatchNbr>'
       +  '<BatchCcy>' + XXVAL + '</BatchCcy>'
       +  '<InvSys>SYSPED</InvSys>'
       +  '<InvSysVer>' + XMSG + '</InvSysVer>';
      /end-free
      *
     C                   EXSR      TILFIL
      *
     C                   ENDSR
      *
      ***********************************************
     C     SRINVOICE     BEGSR
      ***********************************************
     C                   MOVE      XFKN          XXKN              8 0
     C                   MOVE      XXKN          KUNDNR
     C     CUNDL01K      CHAIN     CUNDL01                            33
     C                   IF        SYLAND = *BLANKS
     C                   EVAL      SYLAND = 'NO'
     C                   END
     C                   EVAL      XTXT2561 = KNAVN
     C                   EXSR      KNVST
     C                   MOVEL     XTXT2562      XKNAVN          256
     C                   EVAL      XTXT2561 = ADR1
     C                   EXSR      KNVST
     C                   MOVEL     XTXT2562      XADR1           256
     C                   EVAL      XTXT2561 = ADR2
     C                   EXSR      KNVST
     C                   MOVEL     XTXT2562      XADR2           256
     C                   EVAL      XTXT2561 = ADR3
     C                   EXSR      KNVST
     C                   MOVEL     XTXT2562      XADR3           256
     C                   IF        SYPOGE = *BLANKS
     C                   MOVE      *BLANKS       XPOSTNR           9
     C                   MOVEL     POSTNR        XPOSTNR
     C                   ELSE
     C                   MOVEL     SYPOGE        XPOSTNR
     C                   END
      *
     C                   IF        XFFK = 'F'
     C                   EVAL      XINVTYP = 'Invoice'
     C                   ELSE
     C                   EVAL      XINVTYP = 'CreditNote'
     C                   END
      *
     C     XFFN          CHAIN     FAIN                               33
     C     HEADFK        CHAIN     HEADF                              33
      *
     C     FAK8K         SETLL     FAK8
     C     FAK8K         READE     FAK8                                   33
     C                   IF        XXSAML = 'N'
     C                   DOW       *IN33 = *OFF
     C                   IF        FAOPKO <> 'D'
     C     KODTG2K       CHAIN     KODTG2                             33
     C     SOSAMM        IFNE      *BLANKS
     C                   Z-SUB     1             SOLNR
     C     SOVT          IFNE      *BLANKS
     C                   Z-SUB     2             SOLNR
     C                   MOVE      *BLANKS       SOSAMM
     C                   END
     C                   END
     C                   WRITE     SORTR
     C                   END
     C     FAK8K         READE     FAK8                                   33
     C  N33              ENDDO
     C                   END
      *
     C                   MOVE      *BLANKS       XCONTNR          20
     C                   MOVEL     HETRC         XCONTNR
     C                   CAT       HETRCN:1      XCONTNR
      *
     C                   EVAL      XTXT2561 = HENAS
     C                   EXSR      KNVST
     C                   MOVEL     XTXT2562      XHENAS          256
      *
     C                   EVAL      XTXT2561 = HEADS1
     C                   EXSR      KNVST
     C                   MOVEL     XTXT2562      XHEADS1         256
      * Invoice start, InvType og Debtor
      * <FactorDebtorNbr>: HVIS BRUKER BENYTTER DNB-NOR SITT KUNDENUMMERSERIE.
      * <ClientDebtorNbr>: HVIS BRUKER BENYTTER EGET KUNDENUMMERSERIE.
      /free
       XDATA1K =
         '<Invoice>'
       +   '<InvType>' + %TRIM(XINVTYP) + '</InvType>'
       +   '<Debtor>'
       +     '<DebtorName>' + %TRIM(XKNAVN) + '</DebtorName>'
       +     '<ClientDebtorNbr>'+%TRIM(%EDITC(KUNDNR:'Z'))+'</ClientDebtorNbr>'
       +     '<DebtorVATNbr>'+%TRIM(SYRG)+'</DebtorVATNbr>'
       +     '<DebtorPostalAddr>'+%TRIM(XADR1)+'</DebtorPostalAddr>'
       +     '<DebtorSuplAddr>'+%TRIM(XADR2)+'</DebtorSuplAddr>'
       +     '<DebtorPostalCode>'+%TRIM(XPOSTNR)+'</DebtorPostalCode>'
       +     '<DebtorCity>'+%TRIM(XADR3)+'</DebtorCity>'
       +     '<DebtorCtryCode>'+%TRIM(SYLAND)+'</DebtorCtryCode>'
       +     '<DebtorRef>' + %TRIM(XHENAS) + '</DebtorRef>'
       +     '<DebtorMisc1>' + %TRIM(XCONTNR) + '</DebtorMisc1>'
       +   '</Debtor>';
      /end-free
      *
     C                   EXSR      TILFIL
      *
      * DeliveryDetails
     C     KODTFRK       CHAIN     KODTFR                             33
     C                   SELECT
     C                   WHEN      HEKNSF = XFKN
     C     ' '           SCAN      HEADS3        XPOS              3 0    33
     C                   EVAL      XPOSTNR = %SUBST(HEADS3:1:XPOS)
     C                   ADD       1             XPOS
     C                   EVAL      XADR3 = %SUBST(HEADS3:XPOS:31-XPOS)
      /free
       XDATA1K =
           '<DeliveryDetails>'
       +     '<DeliveryName>' + %TRIM(XHENAS) + '</DeliveryName>'
       +     '<DeliveryAddr>' + %TRIM(XHEADS1) + '</DeliveryAddr>'
       +     '<DeliveryPostalCode>' + %TRIM(XPOSTNR) + '</DeliveryPostalCode>'
       +     '<DeliveryTerms>' + %TRIM(KFRNTX) + '</DeliveryTerms>'
       +   '</DeliveryDetails>';
      /end-free
      *
     C                   EXSR      TILFIL
      *
     C                   WHEN      HEKNKF = XFKN
     C     ' '           SCAN      HEADK3        XPOS              3 0    33
     C                   EVAL      XPOSTNR = %SUBST(HEADK3:1:XPOS)
     C                   ADD       1             XPOS
     C                   EVAL      XADR3 = %SUBST(HEADK3:XPOS:31-XPOS)
      *
     C                   EVAL      XTXT2561 = HENAK
     C                   EXSR      KNVST
     C                   MOVEL     XTXT2562      XHENAK          256
      *
     C                   EVAL      XTXT2561 = HEADK1
     C                   EXSR      KNVST
     C                   MOVEL     XTXT2562      XHEADK1         256
      /free
       XDATA1K =
           '<DeliveryDetails>'
       +     '<DeliveryName>' + %TRIM(XHENAK) + '</DeliveryName>'
       +     '<DeliveryAddr>' + %TRIM(XHEADK1) + '</DeliveryAddr>'
       +     '<DeliveryPostalCode>' + %TRIM(XPOSTNR) + '</DeliveryPostalCode>'
       +     '<DeliveryTerms>' + %TRIM(KFRNTX) + '</DeliveryTerms>'
       +   '</DeliveryDetails>';
      /end-free
      *
     C                   EXSR      TILFIL
     C                   ENDSL
      *
     C                   IF        XXSAML = 'J'
     C                   MOVE      HEGN          XXGN             15
     C                   MOVE      SYSPEDREF     XXSYSREF         16
     C                   MOVE      *BLANKS       HEGN
     C                   MOVE      *BLANKS       SYSPEDREF
     C                   END
      *
      * InvoiceHeader
      /free
       XDATA1K =
           '<InvoiceHeader>'
       +     '<InvNbr>' + %TRIM(%EDITC(XFFN:'Z')) + '</InvNbr>'
       +     '<InvDate>'+FADATOÅ+'-'+FADATOM+'-'+FADATOD+'</InvDate>'
       +     '<DueDate>'+FADAFFÅ+'-'+FADAFFM+'-'+FADAFFD+'</DueDate>'
       +     '<PmtTerms>'
       +       '<PmtTermsText>' + %TRIM(XFBBT) + '</PmtTermsText>'
       +     '</PmtTerms>'
       +     '<OrderRef>' + %TRIM(HEGN) + '</OrderRef>'
       +     '<SellerRef>' + %TRIM(SYSPEDREF) + '</SellerRef>'
       +     '<Kid>' + %TRIM(XFKID) + '</Kid>'
       +   '</InvoiceHeader>';
      /end-free
      *
     C                   EXSR      TILFIL
      *
     C                   IF        XXSAML = 'J'
     C                   MOVE      XXGN          HEGN
     C                   MOVE      XXSYSREF      SYSPEDREF
     C                   END
      *
      * FAKTURALINJE
     C                   IF        XXSAML = 'N'
     C                   EXSR      SRINVDET
     C                   ELSE
     C                   EXSR      SRINVDETS
     C                   END
      *
      * FAKTURATOTAL
     C                   MOVE      *ZEROS        XXMVAT           13 2
     C     1             DO        11            XN01              3 0
     C                   IF        XMLT1(XN01) > 0
     C                   IF        XMLT2(XN01) = *BLANKS
     C                   EVAL      XMLT2(XN01) = FICURR
     C                   END
     C                   SELECT
     C                   WHEN      XFVAL = XMLT2(XN01)
     C                   EVAL(H)   XXMVAT = XXMVAT+XMLT1(XN01)*XMLT4(XN01)/100
     C                   WHEN      XFVAL = FICURR
     C                   EVAL(H)   XXMVAT = XXMVAT+XMLT1(XN01)*XMLT3(XN01)/100
     C                   WHEN      XMLT2(XN01) = FICURR
     C                   EVAL(H)   XXMVAT = XXMVAT+XMLT1(XN01)*XMLT3(XN01)/100
     C                   OTHER
     C                   EVAL(H)   XXMVAT = XXMVAT+XMLT1(XN01)*XMLT4(XN01)/100
     C                   ENDSL
     C                   END
     C                   ENDDO
      *
     C                   IF        XFFK = 'F'
     C                   ADD       XFTOT         XSFTOT1
     C                   ELSE
     C                   ADD       XFTOT         XSFTOT2
     C                   END
      *
     C                   MOVE      *BLANKS       XFTEGN            1
     C                   MOVE      XFTOT         XFTOT2           13 2
     C                   IF        XFFK = 'F'
     C                   IF        XFTOT2 < 0
     C                   MOVE      '-'           XFTEGN
     C                   Z-SUB     XFTOT2        XFTOT2
     C                   END
     C                   ELSE
     C                   IF        XFTOT2 > 0
     C                   MOVE      '-'           XFTEGN
     C                   ELSE
     C                   Z-SUB     XFTOT2        XFTOT2
     C                   END
     C                   END
      *
     C                   MOVE      *BLANKS       XFTEGN2           1
     C     XFTOT         SUB       XXMVAT        XNETTOT          13 2
     C                   IF        XFFK = 'F'
     C                   IF        XNETTOT < 0
     C                   MOVE      '-'           XFTEGN2
     C                   Z-SUB     XNETTOT       XNETTOT
     C                   END
     C                   ELSE
     C                   IF        XNETTOT > 0
     C                   MOVE      '-'           XFTEGN2
     C                   ELSE
     C                   Z-SUB     XNETTOT       XNETTOT
     C                   END
     C                   END
      *
     C                   IF        XXMVAT < 0
     C                   Z-SUB     XXMVAT        XXMVAT
     C                   END
      *
      * Invoice Total og end
      /free

       XOTXTNO = 'Fordringer etter nærværende faktura er overdratt DnB NOR '
       +   'Finans AS , Postboks 6579, Etterstad, 0601 Oslo, til eiendom og '
       +   'befriende betaling kan kun skje til DNB Factoring. Bankgiro '
       +   '7032.05.16038 Ved betaling vennligst oppgi '
       +   'fakturanummer og leverandør.';

       XOTXTSE = 'Vår fordran enligt denne faktura har överlåtits til DnB NOR '
       +   'Finans AS, Postboks 6579 Etterstad, NO-0607 Oslo, och skall därför '
       +   'betalas direkt til DnB NOR Finans AS. Bankgiro i SEK: 5397-0612. '
       +   'I DnB NOR Bank ASA filial Sverige, Box 3041, S-103 63 Stockholm '
       +   'med angivande av leverantör och fakturanummer.';

       XOTXTEN = 'This invoice is irrevocably assigned to DnB NOR Finans AS,'
       +   'P.O.Box 6579 Etterstad, NO-0607 Oslo, Norway, to whom payment is '
       +   'to be made in the currency of the invoice and who alone is '
       +   'alone is authorized to give valid discharge for payment of the '
       +   'amount due. Payment must be made to DnB NOR Finans AS BIC: DNBANOKK'
       +   ' For invoices in USD, account NO39 7002 0444 752'
       +   ' For invoices in EUR, account NO76 7002 0447 093 '
       +   'at DnB NOR Bank ASA, Oslo. DnB NOR Finans AS is authorized by Bank '
       +   'of Norway to collect payment in foreign  currency. When remitting, '
       +   'please quote supplier and invoice number ';

      /end-free
      *
     C                   SELECT
     C                   WHEN      XXVAL = 'NOK'
     C                   EVAL      XOTXT = XOTXTNO
     C                   WHEN      XXVAL = 'SEK'
     C                   EVAL      XOTXT = XOTXTSE
     C                   OTHER
     C                   EVAL      XOTXT = XOTXTEN
     C                   END
      *
      /free
       XDATA1K =
           '<Total>'
       +     '<NetAmt>'+%TRIM(XFTEGN2)+%TRIM(%EDITC(XNETTOT:'3'))+'</NetAmt>'
       +     '<VATAmt>'+%TRIM(%EDITC(XXMVAT:'3'))+'</VATAmt>'
       +     '<TotalAmt>'+%TRIM(XFTEGN)+%TRIM(%EDITC(XFTOT2:'3'))+'</TotalAmt>'
       +   '</Total>'
       +   '<AssignClause>' + %TRIM(XOTXT) + '</AssignClause>'
       + '</Invoice>';
      /end-free
      *
     C                   EXSR      TILFIL
      *
     C   27              WRITE     SYXML6P1
     C   27              MOVE      *OFF          *IN27
     C                   WRITE     SYXML6P2
     C                   IF        XFFK = 'F'
     C                   ADD       1             XXANTF
     C                   ELSE
     C                   ADD       1             XXANTK
     C                   END
      *
     C                   ENDSR
      *
      ***********************************************
     C     SRINVDET      BEGSR
      ***********************************************
      *
      * Items
      /free
       XDATA1K =
           '<Items>';
      /end-free
      *
     C                   EXSR      TILFIL
      *
     C     *LOVAL        SETLL     SORT
     C                   READ      SORT                                   33
     C                   MOVE      *ZEROS        XXLNR
     C                   DOW       *IN33 = *OFF                                 1<-B
     C                   DELETE    SORTR
      *
     C                   IF        FAOPKO <> 'D'                                 2<-B
     C                   IF        ((XFVAL = FICURR) OR (XFVAL = *BLANKS))        3<-B
     C                   EVAL      XXBEL = FABELN
     C                   ELSE                                                     3
     C                   EVAL      XXBEL = FABELV
     C                   END                                                      3<-E
      * Fortegn
     C                   MOVE      ' '           XFORTEGN          1
     C                   IF        XFFK = 'F'
     C                   IF        XXBEL < 0
     C                   MOVE      '-'           XFORTEGN
     C                   Z-SUB     XXBEL         XXBEL
     C                   END
     C                   ELSE
     C                   IF        XXBEL > 0
     C                   MOVE      '-'           XFORTEGN
     C                   ELSE
     C                   Z-SUB     XXBEL         XXBEL
     C                   END
     C                   END
     C                   ADD       1             XXLNR
      *
     C                   EVAL      XTXT = *BLANKS
     C                   IF        FAVT01 = 'X'                                   3<-B
      * KUN TEST FRA FAVT
     C                   EVAL      XTXT2561 = FAVT02
     C                   EXSR      KNVST
     C                   EVAL      XTXT = XTXT2562
     C                   ELSE                                                     3
     C                   IF        FAVT <> *BLANKS                                 4<-B
     C                   EVAL      XTXT2561 = FAVT
     C                   EXSR      KNVST
     C                   EVAL      XTXT = XTXT2562 + ','
     C                   END                                                       4<-E
     C     KODTGEK       CHAIN     KODTGE                             33
     C     KODTG2K       CHAIN     KODTG2                             33
     C                   SELECT                                                    4<-B
     C                   WHEN      SPRAAK = 'E'
     C                   EVAL      XTXT2561 = KGEENT
     C                   WHEN      SPRAAK = 'T'
     C                   EVAL      XTXT2561 = KG2TYT
     C                   OTHER
     C                   EVAL      XTXT2561 = KGENOT
     C                   ENDSL                                                     4<-E
     C                   EXSR      KNVST
     C                   CAT       XTXT2562:0    XTXT
     C                   END                                                      3<-E
      *
     C                   SELECT                                                   3<-B
     C                   WHEN      FAKDM = 'N'
     C                   EVAL      MVAAVI = 0
     C                   WHEN      FAKDM = 'J'
     C                   EVAL      MVAAVI = FITAX * 100
     C                   OTHER
     C     KODWL01K      CHAIN     KODWL01                            33
     C   33              EVAL      MVAAVI = 0
     C                   ENDSL                                                    3<-E
      *
      * <ItemId> skal være tom. e-post fra DnB-Nor 15.02.2008
      *+     '<ItemId>' + %TRIM(%EDITC(XXLNR:'Z')) + '</ItemId>'
      /free
       XDATA1K =
           '<Item>'
       +     '<ItemId/>'
       +     '<ItemDescr>' + %TRIM(XTXT) + '</ItemDescr>'
       +     '<NbrOfUnits>1</NbrOfUnits>'
       +     '<UnitPrice>' + %TRIM(%EDITC(XXBEL:'3')) + '</UnitPrice>'
       +     '<Amt>' + %TRIM(XFTEGN) + %TRIM(%EDITC(XXBEL:'3')) + '</Amt>'
       +     '<VATPct>' + %TRIM(%EDITC(MVAAVI:'3')) + '</VATPct>'
       +   '</Item>';
      /end-free
      *
     C                   EXSR      TILFIL
     C                   END                                                     2<-E
      *
     C                   READ      SORT                                   33
     C                   ENDDO                                                  1<-E
      * Slutt på Items
      /free
       XDATA1K =
           '</Items>';
      /end-free
      *
     C                   EXSR      TILFIL
      *
     C                   ENDSR
      *
      ***********************************************
     C     SRINVDETS     BEGSR
      ***********************************************
      *
      * Items
      /free
       XDATA1K =
           '<Items>';
      /end-free
      *
     C                   EXSR      TILFIL
      *
     C     *LOVAL        SETLL     SORT
     C                   READ      SORT                                   33
     C                   DOW       *IN33 = *OFF                                 1<-B
     C                   DELETE    SORTR
     C                   READ      SORT                                   33
     C                   ENDDO                                                  1<-E
     C     XFFN          SETLL     FAIN
     C     STINVDETS     TAG
     C     XFFN          READE     FAIN                                   33
     C     *IN33         CABEQ     *ON           SLINVDETS
     C     HEADFK        CHAIN     HEADF                              33
     C     FAK8K         SETLL     FAK8
     C     FAK8K         READE     FAK8                                   33
     C                   DOW       *IN33 = *OFF
     C                   IF        FAOPKO <> 'D'
     C     KODTG2K       CHAIN     KODTG2                             33
     C     SOSAMM        IFNE      *BLANKS
     C                   Z-SUB     1             SOLNR
     C     SOVT          IFNE      *BLANKS
     C                   Z-SUB     2             SOLNR
     C                   MOVE      *BLANKS       SOSAMM
     C                   END
     C                   END
     C                   WRITE     SORTR
     C                   END
     C     FAK8K         READE     FAK8                                   33
     C  N33              ENDDO
      *
      *
     C     *LOVAL        SETLL     SORT
     C                   READ      SORT                                   33
     C                   MOVE      *ZEROS        XXLNR
     C                   DOW       *IN33 = *OFF                                 1<-B
     C                   DELETE    SORTR
      *
     C                   IF        FAOPKO <> 'D'                                 2<-B
     C                   IF        ((XFVAL = FICURR) OR (XFVAL = *BLANKS))        3<-B
     C                   EVAL      XXBEL = FABELN
     C                   ELSE                                                     3
     C                   EVAL      XXBEL = FABELV
     C                   END                                                      3<-E
      * Fortegn
     C                   MOVE      ' '           XFORTEGN          1
     C                   IF        XFFK = 'F'
     C                   IF        XXBEL < 0
     C                   MOVE      '-'           XFORTEGN
     C                   Z-SUB     XXBEL         XXBEL
     C                   END
     C                   ELSE
     C                   IF        XXBEL > 0
     C                   MOVE      '-'           XFORTEGN
     C                   ELSE
     C                   Z-SUB     XXBEL         XXBEL
     C                   END
     C                   END
     C                   ADD       1             XXLNR
      *
     C                   IF        SOSK = 'K'
     C                   EVAL      XTXT2561 = HENAS
     C                   ELSE
     C                   EVAL      XTXT2561 = HENAK
     C                   END
     C                   EXSR      KNVST
     C                   EVAL      XTXT = XTXT2562
      *
     C                   SELECT                                                   3<-B
     C                   WHEN      FAKDM = 'N'
     C                   EVAL      MVAAVI = 0
     C                   WHEN      FAKDM = 'J'
     C                   EVAL      MVAAVI = FITAX * 100
     C                   OTHER
     C     KODWL01K      CHAIN     KODWL01                            33
     C   33              EVAL      MVAAVI = 0
     C                   ENDSL                                                    3<-E
      *
      * <ItemId> skal være tom. e-post fra DnB-Nor 15.02.2008
      *+     '<ItemId>' + %TRIM(%EDITC(XXLNR:'Z')) + '</ItemId>'
      /free
       XDATA1K =
           '<Item>'
       +     '<ItemId>' + %TRIM(HERFA) + '</ItemId>'
       +     '<ItemDescr>' + %TRIM(XTXT) + '</ItemDescr>'
       +     '<NbrOfUnits>1</NbrOfUnits>'
       +     '<UnitPrice>' + %TRIM(%EDITC(XXBEL:'3')) + '</UnitPrice>'
       +     '<MiscTxt1>' + %TRIM(SYSPEDREFS) + '</MiscTxt1>'
       +     '<MiscTxt2>' + %TRIM(%EDITW(HEDTOP:'    .  .  ')) + '</MiscTxt2>'
       +     '<Amt>' + %TRIM(XFTEGN) + %TRIM(%EDITC(XXBEL:'3')) + '</Amt>'
       +     '<VATPct>' + %TRIM(%EDITC(MVAAVI:'3')) + '</VATPct>'
       +   '</Item>';
      /end-free
      *
     C                   EXSR      TILFIL
     C                   END                                                     2<-E
      *
     C                   READ      SORT                                   33
     C                   ENDDO                                                  1<-E
     C                   GOTO      STINVDETS
     C     SLINVDETS     TAG
      * Slutt på Items
      /free
       XDATA1K =
           '</Items>';
      /end-free
      *
     C                   EXSR      TILFIL
      *
     C                   ENDSR
      *
      ***********************************************
     C     SRCLOSE       BEGSR
      ***********************************************
     C                   CLOSE     KODWL01
     C                   CLOSE     CUNDL01
     C                   CLOSE     FAIN
     C                   CLOSE     HEADF
     C                   CLOSE     FAK8
     C                   CLOSE     FAKTXT
     C                   CLOSE     FRISOK
     C                   CLOSE     EDIC
     C                   CLOSE     EDIS
     C                   CLOSE     EDIM
     C                   CLOSE     EDISE1K
     C                   CLOSE     SYXML06P
      *
     C                   ENDSR
      *
      ***********************************************
     C     SRSNDSL       BEGSR
      ***********************************************
      * SENDINGSTOTAL
      /free
       XDATA1K =
           '<TotalBatchAmtInv>'+%TRIM(%EDITC(XSFTOT1:'3'))+'</TotalBatchAmtInv>'
       +   '<TotalBatchAmtCrN>'+%TRIM(%EDITC(XSFTOT2:'3'))+'</TotalBatchAmtCrN>'
       +  '</Batch>'
       + '</BatchCollection>';
      /end-free
      *
     C                   EXSR      TILFIL
     C                   IF        XDATA2 <> *BLANKS
     C                   EVAL      XDATA1K = *BLANKS
     C                   EXSR      TILFIL
     C                   END
     C                   IF        XDATA1 <> *BLANKS
     C                   EVAL      XDATA2 = 'X'
     C                   EXSR      TILFIL
     C                   END
      *
     C   27              WRITE     SYXML6P1
     C   27              MOVE      *OFF          *IN27
     C                   WRITE     SYXML6P3
      *
     C                   CLOSE     XMLTP1K
      *
      /free
       UKAT = '/' + %TRIM(FILIBF) + 'X/' + %TRIM(S0010) + '/EDISE1K';
       UFIL = %TRIM(UKAT) + '/TEMP/' + %TRIM(SEMBR) + '.xml';
      /end-free
      *
     C                   CALL      'SYXML06S'
     C                   PARM                    SEMBR
     C                   PARM                    UFIL
     C                   PARM                    UKAT
      *
     C                   ENDSR
      *
      ***********************************************
     C     OPDEDIM       BEGSR
      ***********************************************
     C     1             CHAIN     EDIC                               33
     C                   ADD       1             CMN
     C                   UPDATE    EDICR
      *
     C                   EVAL      M0004 = S0004
     C                   EVAL      M0010 = S0010
     C                   MOVEL     CMN           M0062
     C                   EVAL      M0065 = 'INVXML'
     C                   MOVEL     XFFN          M0068
     C                   IF        XFFK = 'F'
     C                   MOVEL     '380'         M1001
     C                   ELSE
     C                   MOVEL     '381'         M1001
     C                   END
     C                   MOVEL     XFFN          M1004
     C                   IF        XFSAML = 'N'
     C                   MOVE      'SIN'         M1225
     C                   ELSE
     C                   MOVE      'SAM'         M1225
     C                   END
     C                   EVAL      MSN = SSN
     C                   EVAL      MMN = CMN
     C                   EVAL      MSR = 'S'
     C                   EVAL      MST = 'C'
     C                   MOVE      WDT           MDT
     C                   MOVE      WTM           MTM
     C                   IF        XFSAML = 'N'
     C                   EVAL      MAVD = FIAVD
     C                   EVAL      MTDN = FIOPD
     C                   ELSE
     C                   EVAL      MAVD = 0
     C                   EVAL      MTDN = 0
     C                   END
     C                   WRITE     EDIMR
      *
     C                   ENDSR
      *
      ***********************************************
     C     TILFIL        BEGSR
      ***********************************************
     C                   IF        XDATA2 <> *BLANKS
     C                   Z-ADD     1024          XN                4 0
     C                   DOW       ((XDATAX(XN) <> '<') AND (XDATAX(XN) <> '>'))
     C                   SUB       1             XN
     C                   END
     C                   IF        XDATAX(XN) = '<'
     C                   SUB       1             XN
     C                   END
     C                   EVAL      SDATA = %SUBST(XDATA1:1:XN)
     C                   WRITE     EDISER
     C                   IF        XN < 1024
     C                   ADD       1             XN
     C     1025          SUB       XN            XN2               4 0
     C                   EVAL      XDATA1 = %SUBST(XDATA1:XN:XN2)
     C                   ELSE
     C                   EVAL      XDATA1 = *BLANKS
     C                   END
      *
     C                   EVAL      XTPDTA = SDATA
     C                   WRITE     XMLTILPR
     C                   EVAL      XDATA1 = %TRIM(XDATA1) + %TRIM(XDATA2)
     C                   EVAL      XDATA2 = *BLANKS
     C                   END
     C                   CAT       XDATA1K:0     XDATA
      *
     C                   ENDSR
      *
      ***********************************************
     C     KNVST         BEGSR
      ***********************************************
     C                   MOVE      *BLANKS       XTXT2562
     C                   Z-ADD     0             XN52              3 0
     C     1             DO        256           XN51              3 0
     C                   ADD       1             XN52
     C                   SELECT
     C                   WHEN      XT2561(XN51) = '&'
     C                   MOVEA     '&amp;'       XT2562(XN52)
     C                   ADD       4             XN52
     C                   WHEN      XT2561(XN51) = '"'
     C                   MOVEA     '&quot;'      XT2562(XN52)
     C                   ADD       5             XN52
     C                   WHEN      XT2561(XN51) = XAPS
     C                   MOVEA     '&apos;'      XT2562(XN52)
     C                   ADD       5             XN52
     C                   WHEN      XT2561(XN51) = '>'
     C                   MOVEA     '&gt;'        XT2562(XN52)
     C                   ADD       3             XN52
     C                   WHEN      XT2561(XN51) = '<'
     C                   MOVEA     '&lt;'        XT2562(XN52)
     C                   ADD       3             XN52
     C                   OTHER
     C                   MOVE      XT2561(XN51)  XT2562(XN52)
     C                   ENDSL
     C                   ENDDO
      *
     C                   ENDSR
      *
      ***********************************************
     C     INIT          BEGSR
      ***********************************************
     C     XMLUFL1K      KLIST
     C                   KFLD                    XXST
     C                   KFLD                    FIFIRM
     C                   KFLD                    XXTYPE
     C     ECMSGK        KLIST
     C                   KFLD                    FIFIRM
     C                   KFLD                    XXKN
     C                   KFLD                    ECSR
     C                   KFLD                    EC0065
     C     ECMSGK2       KLIST
     C                   KFLD                    FIFIRM
     C                   KFLD                    XXKN2
     C                   KFLD                    ECSR
     C                   KFLD                    EC0065
     C     HEADFK        KLIST
     C                   KFLD                    FIAVD
     C                   KFLD                    FIOPD
     C     FAK8K         KLIST
     C                   KFLD                    FIAVD
     C                   KFLD                    FIOPD
     C                   KFLD                    FIFN
     C     FAKTXTK       KLIST
     C                   KFLD                    FAAVD
     C                   KFLD                    FAOPD
     C                   KFLD                    FALI
     C     KODWL01K      KLIST
     C                   KFLD                    FIFIRM
     C                   KFLD                    MOMSTW
     C                   KFLD                    FAKDM
     C     KODTAK        KLIST
     C                   KFLD                    KOAUNI
     C                   KFLD                    XFAVD
     C     KODTFRK       KLIST
     C                   KFLD                    KFRUNI
     C                   KFLD                    HEFR
     C     KODTGEK       KLIST
     C                   KFLD                    KGEUNI
     C                   KFLD                    FAVK
     C     KODTG2K       KLIST
     C                   KFLD                    KG2UNI
     C                   KFLD                    FAVK
     C     CUNDL01K      KLIST
     C                   KFLD                    FIFIRM
     C                   KFLD                    KUNDNR
     C     FRISOKK       KLIST
     C                   KFLD                    HEAVD
     C                   KFLD                    HEOPD
     C                   KFLD                    XFSKODE           3
      *
     C     *LOVAL        SETLL     FIRM
     C                   READ      FIRM                                   33
      *
     C                   Z-ADD     0             ØX                2 0
     C                   MOVE      *BLANKS       ØAN              12
     C                   MOVE      *ZEROS        XXBEL            13 2
     C                   MOVE      *BLANKS       XTXT            256
     C                   MOVE      *BLANKS       XINVTYP          10
     C                   MOVE      ' '           XXST              1
     C                   MOVE      'DNB  '       XXTYPE            5
     C                   MOVE      99999999      XXKN2             8 0
     C                   MOVE      'A'           KOAUNI
     C                   MOVEL     'FR'          KFRUNI
     C                   MOVEL     'GE'          KGEUNI
     C                   MOVEL     'G2'          KG2UNI
     C                   MOVE      'PO '         XFSKODE
     C                   MOVEL     'S'           ECSR
     C                   MOVEL     'INVXML'      EC0065
     C                   MOVE      '/'           XXSTREKK1
     C                   MOVE      '/'           XXSTREKK2
     C                   MOVE      '/'           XXSTREKK3
     C                   MOVE      *BLANKS       UFIL             70
     C                   MOVE      *BLANKS       UKAT             70
     C                   MOVE      *BLANKS       XDATA1K        1024
     C                   MOVE      *BLANKS       XOTXT           700
     C                   MOVE      *BLANKS       XOTXTNO         700
     C                   MOVE      *BLANKS       XOTXTSE         700
     C                   MOVE      *BLANKS       XOTXTEN         700
     C                   BITON     '123457'      XAPS              1
     C                   BITOFF    '06'          XAPS
      *
     C                   ENDSR
      *
