********************************************************************
      * RETTINGER I DETTE PROGRAM:
PTFnr:*Sek Sig Vers  Beskrivelse...........................
""""""*"""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""
10XXX * 01 YBC PTF10 NY KATALOGSTRUKTUR
10XXX * 02 YBC PTF10 VEDLEGG, MYE ENDRING OG INGNE MERKING
10XXX * 03 YBC PTF10 SPESIELLE TEGN
10XXX * 04 YBC PTF10 SEND FLERE VEDLEGG
10XXX * 05 YBC PTF10 OPPDATER MBR PÅ EDIS
10XXX * 06 YBC PTF10 SAMLEFAKTURA STARTER FOR HVER FAKTURA
10XXX * 07 YBC PTF10 TEST OM SENDING FINNES ETTER GÅTT GJENNOM BLANK STATUS
10XXX * 08 YBC PTF10 HOPP OVER ALLE KOSTNADS LINJER
10XXX * 09 YBC PTF10 OPPDATER STATUS=V PÅ POSTER SOM IKKE SKAL SENDES
xxxxxx*xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
11XXX * 10 YBC PTF11 TransportDetails
11XXX * 11 YBC PTF11 Send frisøkevei på samlefaktura
11XXX * 12 YBC PTF11 LENGDE PÅ SENDINGSNR ER ØKT TIL 9.0
11XXX * 13 YBC PTF11 UTVEKSLINGSREF. SKAL INNEHOLDE FAKTURANR
11XXX * 14 YBC PTF11 LOWERCASE FEIL
11XXX * 15 YBC PTF11 FEILRETTING PÅ ENDRING 10
11XXX * 16 YBC PTF11 LANDKODE PÅ TRANSPORT DETALJE
11XXX * 17 YBC PTF11 VEDLEGG TESTES PÅ X1/X2
11XXX * 18 YBC PTF11 IKKE <InvoiceDetails> ved samlefakt. og transportdet.
11XXX * 19 YBC PTF11 TEGNSETT 850. DIREKTE TIL IFS
11XXX * 20 YBC LOGG I TRACKF
11XXX * 21 YBC VALUTA INFO PÅ LINJE (ExchangeInformation)
11XXX * 22 YBC FLERE KJØRER SAMMEN PROGRAM SAMMENTIDIG. KUN TA EGEN KUNDE
11XXX * 23 YBC VALUTAKODE PÅ FAKTURA
11XXX * 24 YBC Hop over kunde som ikke er definert edi-melding
11XXX * 25 YBC <Buyer><PartyId> ved singel faktura
11XXX * 26 YBC Send fraktbrevnr på <Ref> med <Code> = IFB
11XXX * 27 YBC RETT FEIL I ENDRING 21
11XXX * 28 YBC FEIL FORTEGN PÅ MOMS OG SEND SINGELFAKTURA EN AV GANG
11XXX * 29 YBC REKKEFØLGER PÅ <Address>
********************************************************************
N19  H DFTACTGRP(*NO)
      *
      ***********************************************************
      *** PROGRAM SKAL SENDE XML-FAKTURA E2B                  ***
      *** INDIKATORER 01 - 26 KUN CMD-TASTER / ROLL TASTER    ***
      *** LEDIGE INDIKATORER 01-26                            ***
      *** LEDIGE INDIKATORER 27-32 34-49 51-99                ***
      ***********************************************************
     FFIRM      IF   E           K DISK
     FXMLUFL1   UF   E           K DISK
     FECMSG     IF   E           K DISK
     FKODWL01   IF   E           K DISK    USROPN
     FKODTA     IF   E           K DISK    USROPN
     FKODTGE    IF   E           K DISK    USROPN
     FKODTG2    IF   E           K DISK    USROPN
     FKODTFR    IF   E           K DISK    USROPN
     FKODTOTY   IF   E           K DISK    USROPN
N29  FSTED2D    IF   E           K DISK
N21  FVALUL01   IF   E           K DISK    USROPN
     FCUNDL01   IF   E           K DISK    USROPN
     FFAIN      IF   E           K DISK    USROPN
     FHEADF     IF   E           K DISK    USROPN
N10  FDOKUF     IF   E           K DISK    USROPN
N10  FDOKUFM    IF   E           K DISK    USROPN
N10  FTRACKT    IF   E           K DISK    USROPN
     FFAK8      IF   E           K DISK    USROPN
     FFAKTXT    IF   E           K DISK    USROPN
     FFRISOK    IF   E           K DISK    USROPN
     FKODFRI    IF   E           K DISK    USROPN
     FFREETXT2  IF   E           K DISK
     FFIRMARC   IF   E           K DISK
     FARKIVL02  IF   E           K DISK
     FARKTXT    IF   E           K DISK
     FARKEXT    IF   E           K DISK
N04  FARKVEDK   IF   E           K DISK
     FEDIC      UF A E             DISK    USROPN
     FEDIS      UF A E           K DISK    USROPN
     FEDIM      O  A E             DISK    USROPN
N20  FTRACKF    O  A E             DISK    USROPN
S19  F*EDISE1K   O  A E             DISK    USROPN
N19   /copy ifsio_h
E19  D TXT             S             80    DIM(179) CTDATA PERRCD(1)
     D VEDL            S             70    DIM(900)
S12  D*XSNV            S              7  0 DIM(100)
N12  D XSNV            S              9  0 DIM(100)
     D                 DS
     D  XTXT05                 1      5
     D  XT05                   1      5    DIM(5)
     D                 DS
     D  XTXT40                 1     40
     D  XT40                   1     40    DIM(40)
     D                 DS
     D  XTXT801                1     80
     D  XT801                  1     80    DIM(80)
     D                 DS
     D  XTXT802                1     80
     D  XT802                  1     80    DIM(80)
     D                 DS
     D  ØN152                  1     15  2
     D  ØA152H                 1     13
     D  ØA152X                 5     13
     D  ØA152D                14     15
     D                 DS
     D  ØA12                   1     12
     D  Ø12                    1     12
     D                                     DIM(12)                              Num edit
     D                 DS
     D  XMBR                   1     10
     D  XMBRA                  1      1
     D  XMBRB                  2     10S 0
     D                 DS
     D  WDT                    1      8
     D  WDTÅ                   1      4
     D  WDTM                   5      6
     D  WDTD                   7      8
     D                 DS
     D  WTM                    1      6
     D  WTMH                   1      2
     D  WTMM                   3      4
     D  WTMS                   5      6
     D                 DS
     D  HEAVD                  1      4  0
     D  XXSTREKK1              5      5
     D  HEOPD                  6     12  0
     D  XXSTREKK2             13     13
     D  HESG                  14     16
     D  SYSPEDREF              1     16
     D                 DS
     D  HEDTOP                 1      8  0
     D  HEDTOPÅ                1      4
     D  HEDTOPM                5      6
     D  HEDTOPD                7      8
     D                 DS
     D  FADATO                 1      8  0
     D  FADATOÅ                1      4
     D  FADATOM                5      6
     D  FADATOD                7      8
     D                 DS
     D  FADAFF                 1      8  0
     D  FADAFFÅ                1      4
     D  FADAFFM                5      6
     D  FADAFFD                7      8
     D                 DS
     D  FAVT                   1     20
     D  FAVT01                 1      1
     D  FAVT02                 2     20
     D                 DS
     D  SYKT8                  1      8
     D  SYFR02                 1      1
     D  SYKT7                  2      7
     D  SYKONT                 2      8  0
     D                 DS
     D  XMLT1                  1     44  2 DIM(11)
     D  XFMS01                 1      4  2
     D  XFMS02                 5      8  2
     D  XFMS03                 9     12  2
     D  XFMS04                13     16  2
     D  XFMS05                17     20  2
     D  XFMS06                21     24  2
     D  XFMS07                25     28  2
     D  XFMS08                29     32  2
     D  XFMS09                33     36  2
     D  XFMS10                37     40  2
     D  XFMS11                41     44  2
     D                 DS
     D  XMLT2                  1     33    DIM(11)
     D  XFMV01                 1      3
     D  XFMV02                 4      6
     D  XFMV03                 7      9
     D  XFMV04                10     12
     D  XFMV05                13     15
     D  XFMV06                16     18
     D  XFMV07                19     21
     D  XFMV08                22     24
     D  XFMV09                25     27
     D  XFMV10                28     30
     D  XFMV11                31     33
     D                 DS
     D  XMLT3                  1    143  2 DIM(11)
     D  XFMGN1                 1     13  2
     D  XFMGN2                14     26  2
     D  XFMGN3                27     39  2
     D  XFMGN4                40     52  2
     D  XFMGN5                53     65  2
     D  XFMGN6                66     78  2
     D  XFMGN7                79     91  2
     D  XFMGN8                92    104  2
     D  XFMGN9               105    117  2
     D  XFMGNA               118    130  2
     D  XFMGNB               131    143  2
     D                 DS
     D  XMLT4                  1    143  2 DIM(11)
     D  XFMGV1                 1     13  2
     D  XFMGV2                14     26  2
     D  XFMGV3                27     39  2
     D  XFMGV4                40     52  2
     D  XFMGV5                53     65  2
     D  XFMGV6                66     78  2
     D  XFMGV7                79     91  2
     D  XFMGV8                92    104  2
     D  XFMGV9               105    117  2
     D  XFMGVA               118    130  2
     D  XFMGVB               131    143  2
     D                 DS
     D  FSDOKK                 1     10
     D  DFS                    1     10    DIM(10)
     D                 DS
     D  SYRG                   1     14
     D  SYRG9                  1      9
N04  D                 DS
N04  D  AVKVED                 1     60
N04  D  AVK                    1     60    DIM(30)
N10  D                 DS
N10  D  TRSDFD                 1      8  0
N10  D  TRSDFDAA               1      4
N10  D  TRSDFDMM               5      6
N10  D  TRSDFDDD               7      8
N10  D                 DS
N10  D  TRSDTD                 1      8  0
N10  D  TRSDTDAA               1      4
N10  D  TRSDTDMM               5      6
N10  D  TRSDTDDD               7      8
N19   *
N19  D FILE_o          s             10I 0
N19  D String          s            512a
N19  D rc              s             10i 0
N19  D Idx             s              5u 0
N19  D FILNAM          s            100A
N19  D LF              c                   x'25'
N19  D XCHGAUT         s            200A
N19  D RunCmd          PR                  EXTPGM('QCMDEXC')
N19  D  Cmd                         200A   CONST
N19  D  Len                          15P 5 CONST
N20  D                SDS
N20  D  ZUSER                254    263
      *
     C                   EXSR      INIT
      *
      * Teller antall fakturaer
     C     START         TAG
     C                   MOVE      *ZEROS        S0036
     C     XMLUFL1K      SETLL     XMLUFL1
     C     XMLUFL1K      READE     XMLUFL1                                50
     C   50              GOTO      SLUTT
     C                   MOVE      XFKN          XXKN              8 0
     C                   MOVE      ' '           XSINGEL           1
N09  C                   MOVE      'N'           XOK               1
     C                   DOW       *IN50 = *OFF
     C                   IF        XFKN = XXKN
     C     ECMSGK        CHAIN     ECMSG                              33
     C                   IF        *IN33 = *OFF
N09  C                   MOVE      'J'           XOK
      *
     C                   SELECT
     C                   WHEN      XSINGEL = ' '
     C                   IF        XFSAML = 'J'
     C                   MOVE      'N'           XSINGEL
     C                   ELSE
     C                   MOVE      'J'           XSINGEL
     C                   END
     C                   WHEN      XSINGEL = 'J'
     C     XFSAML        CABEQ     'J'           XNESTE
     C                   OTHER
     C     XFSAML        CABEQ     'N'           XNESTE
     C                   ENDSL
      *
     C                   ADD       1             S0036
     C                   MOVE      'A'           XFST
N09  C                   ELSE
N09  C                   MOVE      'V'           XFST
N24  C                   MOVE      *ZEROS        XXKN
     C                   END
     C                   END
     C     XNESTE        TAG
     C                   UPDATE    XMLUFFR
      *
S28  C*                  IF        XSINGEL = 'N'
N28  C                   IF        XFST = 'A'
     C                   LEAVE
     C                   END
      *
     C     XMLUFL1K      READE     XMLUFL1                                50
N24  C  N50              IF        XXKN = 0
N24  C                   EVAL      XXKN = XFKN
N24  C                   END
     C                   ENDDO
N09  C     XOK           CABNE     'J'           START
N07   *
N07   * TEST OM DET FINNES SENDING.
N07   * ÅRSAK KAN VÆRE KUNDE IKKE ER DEFINERT I ECMSG.
N07  C                   MOVE      'A'           XXST
N07  C     XMLUFL1K      CHAIN     XMLUFL1                            50
N07  C   50              GOTO      SLUTT
      *
     C                   EXSR      SRSNDST
     C                   EXSR      SRENVELOP
      *
     C                   MOVE      'A'           XXST
     C     XMLUFL1K      SETLL     XMLUFL1
     C     START1        TAG
     C     XMLUFL1K      READE     XMLUFL1                                50
     C                   IF        *IN50
     C                   EXSR      SRSNDSL
N06  C                   EXSR      SRCLOSE
     C                   MOVE      ' '           XXST
     C                   GOTO      START
N22  C                   ELSE
N22  C                   IF        XFKN <> XXKN
N22  C                   UPDATE    XMLUFFR
N22  C                   GOTO      START1
N22  C                   END
     C                   END
      *
     C                   EXSR      SRINVOICE
      * Oppdate EDIM
     C                   IF        XFSAML = 'N'
     C                   EXSR      OPDEDIM
     C                   END
      * Oppdater XMLUFF
     C                   MOVE      'C'           XFST
     C                   MOVE      WDT           XFDTS
     C                   MOVE      WTM           XFTDS
     C                   UPDATE    XMLUFFR
      *
     C                   GOTO      START1
      *
     C     SLUTT         TAG
     C                   MOVE      *ON           *INLR
     C                   RETURN
      *
      ***********************************************
     C     SRSNDST       BEGSR
      ***********************************************
     C                   OPEN      KODWL01
     C                   OPEN      KODTA
     C                   OPEN      KODTGE
     C                   OPEN      KODTG2
     C                   OPEN      KODTFR
     C                   OPEN      KODTOTY
N21  C                   OPEN      VALUL01
     C                   OPEN      CUNDL01
     C                   OPEN      FAIN
     C                   OPEN      HEADF
N10  C                   OPEN      DOKUF
N10  C                   OPEN      DOKUFM
N10  C                   OPEN      TRACKT
     C                   OPEN      FAK8
     C                   OPEN      FAKTXT
     C                   OPEN      FRISOK
     C                   OPEN      KODFRI
     C                   OPEN      EDIC
     C                   OPEN      EDIS
     C                   OPEN      EDIM
N20  C                   OPEN      TRACKF
S19  C*                  OPEN      EDISE1K
N04  C                   MOVE      *ZEROS        XSNV
N04  C                   MOVE      *ZEROS        XSNVN             3 0
      *
     C     ECMSGK        CHAIN     ECMSG                              33
     C     1             CHAIN     EDIC                               33
     C                   ADD       1             CSN
     C                   UPDATE    EDICR
      *
     C                   MOVE      *BLANKS       XMBR
     C                   MOVE      'F'           XMBRA
     C                   MOVE      CSN           XMBRB
S19  C*                  MOVE      XMBR          SEMBR
S19  C*                  MOVE      *BLANKS       SDATA
     C                   CALL      'SYGE15C'
     C                   PARM                    WDT
     C                   PARM                    WTM
      *
     C                   EVAL      S0004 = ECIIDI
     C                   EVAL      S0010 = ECIIDC
S13  C*                  EVAL      S0020 = SEMBR
N13  C                   MOVE      XFFN          XFFNALFA          7
N13  C                   IF        XFFK = 'F'
N13  C                   EVAL      S0020 = 'F' + XFFNALFA
N13  C                   ELSE
N13  C                   EVAL      S0020 = 'K' + XFFNALFA
N13  C                   END
     C                   EVAL      SSN   = CSN
     C                   EVAL      SSR   = 'S'
     C                   EVAL      SST   = 'X'
     C                   MOVE      WDT           SDT
     C                   MOVE      WTM           STM
S19  C*                  EVAL      SLIB  = '*LIBL'
S19  C*                  EVAL      SFILE = 'EDISE1K'
N19  C                   EVAL      SFILE = '*IFS'
S19  C*                  EVAL      SMBR  = SEMBR
N19  C                   EVAL      SMBR  = XMBR
     C                   EVAL      SMBRS  = 0
S19  C*                  EVAL      SIFS   = '.xml'
N19  C                   EVAL      SIFS   = '/' + %TRIM(FILIBF) + 'X/'
N19  C                             + %TRIM(S0010) + '/EDISE1K/BACKUP/'
N19  C                             + %TRIM(SMBR) + '.xml'
     C                   WRITE     EDISR
N19   *
N19  C                   EVAL      FILNAM = SIFS
N19   * TO STEDER MÅ HA DENNE TESTEN
N19  C                   IF        XFKN = -1
N19   * 1208 = UTF-8
N19  C                   eval      FILE_o = open( %TrimR( FILNAM )
N19  C                               : O_CREAT+O_TRUNC+O_WRONLY
N19  C                                + O_TEXT_CREAT+O_CCSID+O_TEXTDATA
N19  C                               : S_IRUSR + S_IWUSR
N19  C                               : 1208
N19  C                               : 0)
N19  C                   ELSE
N19   * 850 = ISO 8859-1
N19  C                   eval      FILE_o = open( %TrimR( FILNAM )
N19  C                               : O_CREAT+O_TRUNC+O_WRONLY
N19  C                                + O_TEXT_CREAT+O_CCSID+O_TEXTDATA
N19  C                               : S_IRUSR + S_IWUSR
N19  C                               : 850
N19  C                               : 0)
N19  C                   END
      *
     C                   EVAL      XSSN = SSN
     C                   MOVE      *ZEROS        XANTMSG           5 0
      *
N19  C                   IF        XFFN = -1
N19  C                   EVAL      SDATA = TXT(179)
N19  C                   ELSE
     C                   EVAL      SDATA = TXT(001)
N19  C                   END
     C                   EXSR      TILFIL
     C                   EVAL      SDATA = %TRIM(TXT(002)) + ' '
     C                             + %TRIM(TXT(003)) + ' '
     C                             + %TRIM(TXT(004)) + ' '
     C                             + %TRIM(TXT(005))
     C                   EXSR      TILFIL
      *
     C                   ENDSR
      *
      ***********************************************
     C     SRENVELOP     BEGSR
      ***********************************************
      * Envelop start
     C                   EVAL      SDATA = TXT(007)
     C                   EXSR      TILFIL
      * InterchangeId
     C                   EVAL      SDATA = %TRIM(TXT(009))
S19  C*                            + %TRIM(SEMBR) + %TRIM(TXT(010))
N19  C                             + %TRIM(S0020) + %TRIM(TXT(010))
     C                   EXSR      TILFIL
      * From
     C                   EVAL      SDATA = %TRIM(TXT(011))
     C                             + %TRIM(S0004) + %TRIM(TXT(012))
     C                   EXSR      TILFIL
      * To
     C                   EVAL      SDATA = %TRIM(TXT(013))
     C                             + %TRIM(S0010) + %TRIM(TXT(014))
     C                   EXSR      TILFIL
      * Date
     C                   EVAL      SDATA = %TRIM(TXT(015))
     C                             + %TRIM(WDTÅ) + '-'
     C                             + %TRIM(WDTM) + '-'
     C                             + %TRIM(WDTD) + %TRIM(TXT(016))
     C                   EXSR      TILFIL
      * Time
     C                   EVAL      SDATA = %TRIM(TXT(017))
     C                             + %TRIM(WTMH) + ':'
     C                             + %TRIM(WTMM) + ':'
     C                             + %TRIM(WTMS) + %TRIM(TXT(018))
     C                   EXSR      TILFIL
      * NumberOfMessages
     C                   Z-ADD     S0036         ØN152
     C                   MOVE      'N'           XBELØP
     C                   EXSR      SRNE
     C                   EVAL      SDATA = %TRIM(TXT(163))
     C                             + %TRIM(ØAN) + %TRIM(TXT(164))
     C                   EXSR      TILFIL
      * Envelop slutt
     C                   EVAL      SDATA = TXT(008)
     C                   EXSR      TILFIL
      *
     C                   ENDSR
      *
      ***********************************************
     C     SRINVOICE     BEGSR
      ***********************************************
     C                   MOVE      XXKN          KUNDNR
     C     CUNDL01K      CHAIN     CUNDL01                            33
      * Invoice start
     C                   IF        SPRAAK = *BLANKS
     C                   MOVEL     'NO'          XAN02             2
     C                   ELSE
     C                   MOVEL     SPRAAK        XAN02
     C                   END
     C                   EVAL      SDATA = %TRIM(TXT(019)) + ' '
     C                             + 'MessageVersion="3.2" MessageOwner="e2b" '
     C                             + 'MessageType="Invoice"'
N03  C                             + ' language="' + %TRIM(XAN02) + '">'
S03  C*                            + 'language="' + %TRIM(XAN02) + '">'
     C                   EXSR      TILFIL
      * MessageNumber
     C                   ADD       1             XANTMSG
     C                   Z-ADD     XANTMSG       ØN152
     C                   MOVE      'N'           XBELØP            1
     C                   EXSR      SRNE
     C                   EVAL      SDATA = %TRIM(TXT(021))
     C                             + %TRIM(ØAN) + %TRIM(TXT(022))
     C                   EXSR      TILFIL
      * MessageTimestamp
     C                   EVAL      SDATA = %TRIM(TXT(023))
     C                             + %TRIM(WDTÅ) + '-'
     C                             + %TRIM(WDTM) + '-'
     C                             + %TRIM(WDTD) + 'T'
     C                             + %TRIM(WTMH) + ':'
     C                             + %TRIM(WTMM) + ':'
     C                             + %TRIM(WTMS) + '.0Z' + %TRIM(TXT(024))
     C                   EXSR      TILFIL
      * NumberOfLines
     C                   EVAL      SDATA = %TRIM(TXT(025))
     C                   IF        XFSAML = 'N'
     C                   Z-ADD     XFANTL        ØN152
     C                   MOVE      'N'           XBELØP
     C                   EXSR      SRNE
     C                   CAT       ØAN:0         SDATA
     C                   ELSE
     C                   CAT       '1':0         SDATA
     C                   END
     C                   CAT       TXT(026):0    SDATA
     C                   EXSR      TILFIL
      *
     C                   MOVE      XFFN          FIFN
     C     FIFN          SETLL     FAIN
N08  C     STSRINV1      TAG
     C     FIFN          READE     FAIN                                   33
N08  C                   IF        *IN33 = *OFF
N08  C     FAK8K         SETLL     FAK8
N08  C     FAK8K         READE     FAK8                                   33
N08  C  N33              DOW       FAOPKO = 'D' OR FAKDA = 'K'
N08  C     FAK8K         READE     FAK8                                   33
N08  C  N33              ENDDO
N08  C   33              GOTO      STSRINV1
N08  C                   END
      * InvoiceHeader
     C                   Z-ADD     1             XLEVEL            1 0
     C                   EXSR      SRINVHEAD
      *
      * InvoiceDetails
     C                   IF        XFSAML = 'J'
     C                   EXSR      SRINVDETS
     C                   ELSE
N10  C                   IF        XTRDETAILS = 'J'
N10  C                   EXSR      SRTRDETAILS
N10  C                   ELSE
     C                   EXSR      SRINVDET
N10  C                   END
     C                   END
      * InvoiceSummary
     C                   EXSR      SRINVSUM
      *
      * Invoice slutt
     C                   EVAL      SDATA = TXT(020)
     C                   EXSR      TILFIL
      *
     C                   ENDSR
      *
      ***********************************************
     C     SRINVHEAD     BEGSR
      ***********************************************
     C     HEADFK        CHAIN     HEADF                              33
     C     FAK8K         SETLL     FAK8
     C     FAK8K         READE     FAK8                                   33
     C  N33              DOW       FAOPKO = 'D'
     C     FAK8K         READE     FAK8                                   33
     C  N33              ENDDO
      *
     C                   IF        ((XFSAML = 'N') OR (XLEVEL = 1))
      *
      * InvoiceHeader start
     C                   EVAL      SDATA = TXT(027)
     C                   EXSR      TILFIL
      * InvoiceType
     C                   EVAL      SDATA = TXT(029)
     C                   IF        XFFK = 'F'
     C                   CAT       '380':0       SDATA
     C                   ELSE
     C                   CAT       '381':0       SDATA
     C                   END
     C                   CAT       TXT(030):0    SDATA
     C                   EXSR      TILFIL
      * InvoiceStatus
     C                   EVAL      SDATA = %TRIM(TXT(031)) +'9'+ %TRIM(TXT(032))
     C                   EXSR      TILFIL
      * InvoiceNumber
     C                   MOVEL     XFFN          XAN07             7
     C                   EVAL      SDATA = %TRIM(TXT(033))
     C                             + %TRIM(XAN07) + %TRIM(TXT(034))
     C                   EXSR      TILFIL
      * InvoiceDate
     C                   EVAL      SDATA = %TRIM(TXT(035))
     C                             + %TRIM(FADATOÅ) + '-'
     C                             + %TRIM(FADATOM) + '-'
     C                             + %TRIM(FADATOD) + %TRIM(TXT(036))
     C                   EXSR      TILFIL
      *
     C                   ELSE
      *
     C                   EVAL      SDATA = TXT(167)
     C                   EXSR      TILFIL
      *
     C                   END
      *
      * Supplier
     C                   EVAL      SDATA = TXT(037)
     C                   EXSR      TILFIL
     C     KODTAK        CHAIN     KODTA                              33
     C                   MOVE      KOAKNR        KUNDNR
     C     CUNDL01K      CHAIN     CUNDL01                            33
     C                   MOVE      'J'           XXLEV             1
     C                   EXSR      SRKUN1
     C                   EVAL      SDATA = TXT(038)
     C                   EXSR      TILFIL
      * Buyer
      *
     C                   IF        ((XFSAML = 'N') OR (XLEVEL = 2))
      *
     C                   EVAL      SDATA = TXT(089)
     C                   EXSR      TILFIL
     C                   IF        HEKNK <> 0
     C                   MOVE      HEKNK         KUNDNR
     C     CUNDL01K      CHAIN     CUNDL01                            33
     C                   IF        ((HEADK1 = ADR1) AND (HEADK2 = ADR2))
     C                   MOVE      'N'           XDELPART          1
     C                   ELSE
     C                   MOVE      'J'           XDELPART
     C                   END
     C                   ELSE
     C                   MOVE      'N'           XDELPART
     C                   MOVE      HENAK         KNAVN
     C                   MOVE      HEADK1        ADR1
     C                   MOVE      HEADK2        ADR2
     C                   MOVEL     HEADK3        XXA04             4
     C                   TESTN                   XXA04                33
     C                   IF        *IN33
     C                   MOVE      XXA04         POSTNR
     C                   MOVE      HEADK3        XXA24            24
     C                   EVAL      ADR3 = XXA24
     C                   ELSE
     C                   MOVE      *ZEROS        POSTNR
     C                   EVAL      ADR3 = HEADK3
     C                   END
     C                   MOVE      *BLANKS       TLF
     C                   MOVE      *BLANKS       TFAXNR
     C                   MOVE      *BLANKS       SYEPOS
     C                   END
     C                   EXSR      SRKUN2
     C                   EVAL      SDATA = TXT(090)
     C                   EXSR      TILFIL
      *
     C                   END
      *
      * Invoicee
     C                   MOVE      XXKN          KUNDNR
     C     CUNDL01K      CHAIN     CUNDL01                            33
     C                   IF        ((XFSAML = 'J') AND (XLEVEL = 1))
     C                   EVAL      SDATA = TXT(089)
     C                   ELSE
     C                   EVAL      SDATA = TXT(091)
     C                   END
     C                   EXSR      TILFIL
     C                   MOVE      'N'           XXLEV             1
     C                   EXSR      SRKUN1
     C                   IF        ((XFSAML = 'J') AND (XLEVEL = 1))
     C                   EVAL      SDATA = TXT(090)
     C                   ELSE
     C                   EVAL      SDATA = TXT(092)
     C                   END
     C                   EXSR      TILFIL
      * DeliveryPart
      *
     C                   IF        ((XFSAML = 'N') OR (XLEVEL = 2))
      *
     C                   IF        XDELPART = 'J'
     C                   EVAL      SDATA = TXT(093)
     C                   EXSR      TILFIL
     C                   MOVE      HENAK         KNAVN
     C                   MOVE      HEADK1        ADR1
     C                   MOVE      HEADK2        ADR2
     C                   MOVEL     HEADK3        XXA04             4
     C                   TESTN                   XXA04                33
     C                   IF        *IN33
     C                   MOVE      XXA04         POSTNR
     C                   MOVE      HEADK3        XXA24            24
     C                   EVAL      ADR3 = XXA24
     C                   ELSE
     C                   MOVE      *ZEROS        POSTNR
     C                   EVAL      ADR3 = HEADK3
     C                   END
     C                   EXSR      SRKUN2
     C                   EVAL      SDATA = TXT(094)
     C                   EXSR      TILFIL
     C                   END
      *
     C                   END
      *
      * InvoiveReference
     C                   IF        ((XFSAML = 'N') OR (XLEVEL = 2))
     C                   EVAL      SDATA = TXT(095)
     C                   EXSR      TILFIL
     C                   EXSR      SRINVREF
     C                   EVAL      SDATA = TXT(096)
     C                   EXSR      TILFIL
      *
     C                   END
      *
     C                   IF        ((XFFK = 'F') AND (XLEVEL = 1))
      * Payment
     C                   EVAL      SDATA = TXT(113)
     C                   EXSR      TILFIL
     C                   EXSR      SRINVPAY
     C                   EVAL      SDATA = TXT(114)
     C                   EXSR      TILFIL
      *
     C                   END
      * Attachment
     C                   IF        ((XLEVEL = 1) OR (XFSAML = 'N'))
      *
     C                   IF        XFSAML = 'J'
     C                   MOVE      'fs'          ARTYPE
N04  C                   MOVE      'fs'          AVTYPE
     C                   ELSE
     C                   MOVE      'fa'          ARTYPE
N04  C                   MOVE      'fa'          AVTYPE
     C                   END
N17  C                   IF        XFSAML = 'J'
N17  C                   MOVE      'X1'          X_AVTYPE
N17  C                   ELSE
N17  C                   MOVE      'X2'          X_AVTYPE
N17  C                   END
N04  C     ARKVEDKK      CHAIN     ARKVEDK                            33
N04  C   33              MOVE      *BLANKS       AVKVED
N04  C                   IF        XFSAML = 'J'
N04  C                   MOVE      'fs'          AVTYPE
N04  C                   ELSE
N04  C                   MOVE      'fa'          AVTYPE
N04  C                   END
     C                   MOVEL     FIFN          ARUNDE
     C     ARKIVL02K     CHAIN     ARKIVL02                           33
     C                   IF        *IN33 = *OFF
     C     TAGATTACH     TAG
N04  C                   IF        ((ARTYPE = AVTYPE) OR (ARTYPE = 'fx'))
N04  C                   MOVEL     ARUNDE        XFN               7 0
N04  C     XFN           CABNE     FIFN          NESTEVEDL
N04  C                   ELSE
N04  C     1             DO        30            XN                3 0
N04  C                   SELECT
N04  C                   WHEN      AVK(XN) = ARTYPE
N04  C                   LEAVE
N04  C                   WHEN      AVK(XN) = *BLANKS
N04  C                   GOTO      NESTEVEDL
N04  C                   ENDSL
N04  C                   ENDDO
N04  C                   END
N04   *
     C     ARTYPE        CHAIN     ARKTXT                             33
     C                   IF        ARKLAG <> *BLANKS
     C     ARKLAGK       CHAIN     ARKEXT                             33
     C                   ELSE
     C     FIFIRM        CHAIN     FIRMARC                            33
     C                   END
      * SEND VEDLEGG
N04  C     '.'           SCAN      ARLINK                                 33
N04  C                   IF        *IN33
N04  C                   EVAL      SDATA = %TRIM(TXT(165))
N04  C                             + %TRIM(ARLINK) + %TRIM(TXT(166))
N04  C                   ELSE
     C                   EVAL      SDATA = %TRIM(TXT(165))
     C                             + %TRIM(ARLINK) + '.pdf' + %TRIM(TXT(166))
N04  C                   END
     C                   EXSR      TILFIL
      * OPPDATERE SENDINGSFIL
     C     ECMSGK        CHAIN     ECMSG                              33
     C     1             CHAIN     EDIC                               33
     C                   ADD       1             CSN
     C                   UPDATE    EDICR
     C                   EVAL      SSN      = CSN
S04  C*                  EVAL      XSSNVEDL = CSN
N04  C                   EVAL      XSNVN    = XSNVN + 1
N04  C                   EVAL      XSNV(XSNVN) = CSN
     C                   EVAL      S0020 = ARLINK
     C                   EVAL      SLIB  = *BLANKS
     C                   EVAL      SFILE = '*IFS'
S05  C*                  EVAL      SMBR  = *BLANKS
N05  C                   MOVE      SSN           XAN09             9
N05  C                   EVAL      SMBR  = 'F' + %TRIM(XAN09)
     C                   EVAL      SMBRS  = 0
N04  C     '.'           SCAN      ARLINK                                 33
N04  C                   IF        *IN33
N04  C                   EVAL      SIFS   = '/' + %TRIM(ARCANE) + '/'
N04  C                             + %TRIM(ARLINK)
N04  C                   ELSE
     C                   EVAL      SIFS   = '/' + %TRIM(ARCANE) + '/'
     C                             + %TRIM(ARLINK) + '.pdf'
N04  C                   END
     C                   WRITE     EDISR
      *
     C                   EVAL      SDATA = %TRIM(TXT(165))
     C                             + 'http://' + %TRIM(ARCPAE) + '/'
     C                   IF        ARCANE <> *BLANKS
     C                   CAT       ARCANE:0      SDATA
     C                   CAT       '/':0         SDATA
     C                   END
     C                   CAT       ARLINK:0      SDATA
N04  C     '.'           SCAN      ARLINK                                 33
N04  C                   IF        *IN33 = *OFF
     C                   CAT       '.pdf':0      SDATA
N04  C                   END
     C                   CAT       TXT(166):0    SDATA
     C                   EXSR      TILFIL
N04  C     NESTEVEDL     TAG
S04  C*                  IF        ARTYPE = 'fs'
S04  C*                  MOVE      'fx'          ARTYPE
S04  C*    ARKIVL02K     CHAIN     ARKIVL02                           33
N04  C     ARKIVL02K     READE     ARKIVL02                               33
     C  N33              GOTO      TAGATTACH
S04  C*                  END
     C                   END
      *
     C                   END
      *
S12  C*                  IF        XFSAML = 'N'
N12  C                   IF        XFSAML = 'N' OR XLEVEL = 2
      * Ref
     C                   EXSR      SRORDREF
      * Freetext
     C                   EXSR      SRORDFT
      *
     C                   END
      *
     C                   IF        ((XFSAML = 'N') OR (XLEVEL = 1))
      *
      * InvoiceHeader start
     C                   EVAL      SDATA = TXT(028)
     C                   EXSR      TILFIL
      *
     C                   ELSE
      *
     C                   EVAL      SDATA = TXT(168)
     C                   EXSR      TILFIL
      *
     C                   END
      *
     C                   ENDSR
      *
      ***********************************************
     C     SRKUN1        BEGSR
      ***********************************************
      * PartyId
     C                   EVAL      SDATA = %TRIM(TXT(039))
     C                             + %TRIM(%EDITC(KUNDNR:'Z'))
     C                             + %TRIM(TXT(040))
     C                   EXSR      TILFIL
N03   * LocationId
N03  C                   EVAL      SDATA = %TRIM(TXT(041))
N03  C                             + %TRIM(S0004) + %TRIM(TXT(042))
N03  C                   EXSR      TILFIL
      * Name
N03  C                   EVAL      XTXT801 = KNAVN
N03  C                   Z-ADD     30            XN53              3 0
N03  C                   EXSR      KNVST
     C                   EVAL      SDATA = %TRIM(TXT(043))
N03  C                             + %TRIM(XTXT802) + %TRIM(TXT(044))
S03  C*                            + %TRIM(KNAVN) + %TRIM(TXT(044))
     C                   EXSR      TILFIL
      *
     C                   IF        ((TLF <> *BLANKS) OR (TFAXNR <> *BLANKS))
      * ContactInformation start
     C                   EVAL      SDATA = TXT(045)
     C                   EXSR      TILFIL
      * PhoneNumber
     C                   IF        TLF <> *BLANKS
N03  C                   EVAL      XTXT801 = TLF
N03  C                   Z-ADD     15            XN53              3 0
N03  C                   EXSR      KNVST
     C                   EVAL      SDATA = %TRIM(TXT(047))
N03  C                             + %TRIM(XTXT802) + %TRIM(TXT(048))
S03  C*                            + %TRIM(TLF) + %TRIM(TXT(048))
     C                   EXSR      TILFIL
     C                   END
      * FaxNumber
     C                   IF        TFAXNR <> *BLANKS
N03  C                   EVAL      XTXT801 = TFAXNR
N03  C                   Z-ADD     15            XN53              3 0
N03  C                   EXSR      KNVST
     C                   EVAL      SDATA = %TRIM(TXT(049))
N03  C                             + %TRIM(XTXT802) + %TRIM(TXT(050))
S03  C*                            + %TRIM(TFAXNR) + %TRIM(TXT(050))
     C                   EXSR      TILFIL
     C                   END
      * EmailAddress
     C                   IF        SYEPOS <> *BLANKS
     C                   EVAL      SDATA = %TRIM(TXT(051))
     C                             + %TRIM(SYEPOS) + %TRIM(TXT(052))
     C                   EXSR      TILFIL
     C                   END
      * WebAddress
      * ContactInformation slutt
     C                   EVAL      SDATA = TXT(046)
     C                   EXSR      TILFIL
      *
     C                   END
      * StreetAddress start
     C                   EVAL      SDATA = TXT(055)
     C                   EXSR      TILFIL
      * Address1
N03  C                   EVAL      XTXT801 = ADR1
N03  C                   Z-ADD     30            XN53              3 0
N03  C                   EXSR      KNVST
     C                   EVAL      SDATA = %TRIM(TXT(057))
N03  C                             + %TRIM(XTXT802) + %TRIM(TXT(058))
S03  C*                            + %TRIM(ADR1) + %TRIM(TXT(058))
     C                   EXSR      TILFIL
      * Address2
     C                   IF        ADR2 <> *BLANKS
N03  C                   EVAL      XTXT801 = ADR2
N03  C                   Z-ADD     30            XN53              3 0
N03  C                   EXSR      KNVST
     C                   EVAL      SDATA = %TRIM(TXT(059))
N03  C                             + %TRIM(XTXT802) + %TRIM(TXT(060))
S03  C*                            + %TRIM(ADR2) + %TRIM(TXT(060))
     C                   EXSR      TILFIL
     C                   END
      * PostalCode
     C                   EVAL      SDATA = %TRIM(TXT(063))
     C                   IF        POSTNR = 0
     C                   CAT       SYPOGE:0      SDATA
     C                   ELSE
     C                   MOVE      POSTNR        XXA04
     C                   CAT       XXA04:0       SDATA
     C                   END
     C                   CAT       TXT(064):0    SDATA
     C                   EXSR      TILFIL
      * PostalDistrict
N03  C                   EVAL      XTXT801 = ADR3
N03  C                   Z-ADD     30            XN53              3 0
N03  C                   EXSR      KNVST
     C                   EVAL      SDATA = %TRIM(TXT(065))
N03  C                             + %TRIM(XTXT802) + %TRIM(TXT(066))
S03  C*                            + %TRIM(ADR3) + %TRIM(TXT(066))
     C                   EXSR      TILFIL
      * CountryCode
     C                   EVAL      SDATA = %TRIM(TXT(067))
     C                   IF        SYLAND = *BLANKS
     C                   CAT       'NO':0        SDATA
     C                   ELSE
     C                   CAT       SYLAND:0      SDATA
     C                   END
     C                   CAT       TXT(068):0    SDATA
     C                   EXSR      TILFIL
      * StreetAddress slutt
     C                   EVAL      SDATA = TXT(056)
     C                   EXSR      TILFIL
      *
      * ContactPerson
      *
      * OrgNumber
     C                   EVAL      SDATA = %TRIM(TXT(079))
     C                             + %TRIM(SYRG) + %TRIM(TXT(080))
     C                   EXSR      TILFIL
      * VatId
     C                   EVAL      SDATA = %TRIM(TXT(081))
     C                             + 'MVA' + %TRIM(SYRG) + 'NO'
     C                             + %TRIM(TXT(082))
     C                   EXSR      TILFIL
      * Department
      *
     C                   IF        XXLEV = 'J'
      * AccountInformation start
     C                   EVAL      SDATA = TXT(083)
     C                   EXSR      TILFIL
      * AccountNumber
     C                   EVAL      SDATA = %TRIM(TXT(085))
     C                             + %TRIM(XFKT) + %TRIM(TXT(086))
     C                   EXSR      TILFIL
      * AccountInformation slutt
     C                   EVAL      SDATA = TXT(084)
     C                   EXSR      TILFIL
      *
     C                   END
      * ProjectRef
      *
     C                   ENDSR
      *
      ***********************************************
     C     SRKUN2        BEGSR
      ***********************************************
N25   * PartyId
N25  C                   EVAL      SDATA = %TRIM(TXT(039))
N25  C                             + %TRIM(%EDITC(KUNDNR:'Z'))
N25  C                             + %TRIM(TXT(040))
N25  C                   EXSR      TILFIL
N03   * LocationId
N03  C                   EVAL      SDATA = %TRIM(TXT(041))
N03  C                             + %TRIM(S0010) + %TRIM(TXT(042))
N03  C                   EXSR      TILFIL
      * Name
N03  C                   EVAL      XTXT801 = KNAVN
N03  C                   Z-ADD     30            XN53              3 0
N03  C                   EXSR      KNVST
     C                   EVAL      SDATA = %TRIM(TXT(043))
N03  C                             + %TRIM(XTXT802) + %TRIM(TXT(044))
S03  C*                            + %TRIM(KNAVN) + %TRIM(TXT(044))
     C                   EXSR      TILFIL
      *
     C                   IF        ((TLF <> *BLANKS) OR (TFAXNR <> *BLANKS))
      * ContactInformation start
     C                   EVAL      SDATA = TXT(045)
     C                   EXSR      TILFIL
      * PhoneNumber
     C                   IF        TLF <> *BLANKS
N03  C                   EVAL      XTXT801 = TLF
N03  C                   Z-ADD     15            XN53              3 0
N03  C                   EXSR      KNVST
     C                   EVAL      SDATA = %TRIM(TXT(047))
N03  C                             + %TRIM(XTXT802) + %TRIM(TXT(048))
S03  C*                            + %TRIM(TLF) + %TRIM(TXT(048))
     C                   EXSR      TILFIL
     C                   END
      * FaxNumber
     C                   IF        TFAXNR <> *BLANKS
N03  C                   EVAL      XTXT801 = TFAXNR
N03  C                   Z-ADD     15            XN53              3 0
N03  C                   EXSR      KNVST
     C                   EVAL      SDATA = %TRIM(TXT(049))
N03  C                             + %TRIM(XTXT802) + %TRIM(TXT(050))
S03  C*                            + %TRIM(TFAXNR) + %TRIM(TXT(050))
     C                   EXSR      TILFIL
     C                   END
      * EmailAddress
     C                   IF        SYEPOS <> *BLANKS
     C                   EVAL      SDATA = %TRIM(TXT(051))
     C                             + %TRIM(SYEPOS) + %TRIM(TXT(052))
     C                   EXSR      TILFIL
     C                   END
      * WebAddress
      * ContactInformation slutt
     C                   EVAL      SDATA = TXT(046)
     C                   EXSR      TILFIL
      *
     C                   END
      * StreetAddress start
     C                   EVAL      SDATA = TXT(055)
     C                   EXSR      TILFIL
      * Address1
N03  C                   EVAL      XTXT801 = ADR1
N03  C                   Z-ADD     30            XN53              3 0
N03  C                   EXSR      KNVST
     C                   EVAL      SDATA = %TRIM(TXT(057))
N03  C                             + %TRIM(XTXT802) + %TRIM(TXT(058))
S03  C*                            + %TRIM(ADR1) + %TRIM(TXT(058))
     C                   EXSR      TILFIL
      * Address2
     C                   IF        ADR2 <> *BLANKS
N03  C                   EVAL      XTXT801 = ADR2
N03  C                   Z-ADD     30            XN53              3 0
N03  C                   EXSR      KNVST
     C                   EVAL      SDATA = %TRIM(TXT(059))
N03  C                             + %TRIM(XTXT802) + %TRIM(TXT(060))
S03  C*                            + %TRIM(ADR2) + %TRIM(TXT(060))
     C                   EXSR      TILFIL
     C                   END
      * PostalCode
     C                   EVAL      SDATA = %TRIM(TXT(063))
     C                   IF        POSTNR = 0
     C                   CAT       SYPOGE:0      SDATA
     C                   ELSE
     C                   MOVE      POSTNR        XXA04
     C                   CAT       XXA04:0       SDATA
     C                   END
     C                   CAT       TXT(064):0    SDATA
     C                   EXSR      TILFIL
      * PostalDistrict
N03  C                   EVAL      XTXT801 = ADR3
N03  C                   Z-ADD     30            XN53              3 0
N03  C                   EXSR      KNVST
     C                   EVAL      SDATA = %TRIM(TXT(065))
N03  C                             + %TRIM(XTXT802) + %TRIM(TXT(066))
S03  C*                            + %TRIM(ADR3) + %TRIM(TXT(066))
     C                   EXSR      TILFIL
      * CountryCode
     C                   EVAL      SDATA = %TRIM(TXT(067))
     C                   IF        SYLAND = *BLANKS
     C                   CAT       'NO':0        SDATA
     C                   ELSE
     C                   CAT       SYLAND:0      SDATA
     C                   END
     C                   CAT       TXT(068):0    SDATA
     C                   EXSR      TILFIL
      * StreetAddress slutt
     C                   EVAL      SDATA = TXT(056)
     C                   EXSR      TILFIL
      *
     C                   ENDSR
      *
      ***********************************************
     C     SRINVREF      BEGSR
      ***********************************************
      * BuyersOrderNumber
N03  C                   EVAL      XTXT801 = HERFA
N03  C                   Z-ADD     15            XN53              3 0
N03  C                   EXSR      KNVST
     C                   EVAL      SDATA = %TRIM(TXT(097))
S03  C*                            + %TRIM(HERFA) + %TRIM(TXT(098))
N03  C                             + %TRIM(XTXT802) + %TRIM(TXT(098))
     C                   EXSR      TILFIL
      * BuyersOrderDate
      *
      * SuppliersOrderNumber
     C                   EVAL      SDATA = %TRIM(TXT(101))
     C                             + %TRIM(SYSPEDREF) + %TRIM(TXT(102))
     C                   EXSR      TILFIL
      * DeliveryTerms
     C     KODTFRK       CHAIN     KODTFR                             33
     C                   IF        SPRAAK = ' '
     C                   EVAL      XTXT801 = KFRTTX
     C                   ELSE
     C                   EVAL      XTXT801 = KFRNTX
     C                   END
     C                   Z-ADD     38            XN53              3 0
     C                   EXSR      KNVST
     C                   EVAL      SDATA = %TRIM(TXT(103))
     C                             + %TRIM(XTXT802) + %TRIM(TXT(104))
     C                   EXSR      TILFIL
      * DeliveryTermsCode
     C                   EVAL      SDATA = %TRIM(TXT(105))
     C                             + %TRIM(HEFR) + %TRIM(TXT(106))
     C                   EXSR      TILFIL
      * DeliveryPlace
      * DeliveryNoteNumber
      * DeliveryDate
      *
     C                   ENDSR
      *
      ***********************************************
     C     SRINVPAY      BEGSR
      ***********************************************
      * DueDate
     C                   EVAL      SDATA = %TRIM(TXT(115))
     C                             + %TRIM(FADAFFÅ) + '-'
     C                             + %TRIM(FADAFFM) + '-'
     C                             + %TRIM(FADAFFD) + %TRIM(TXT(116))
     C                   EXSR      TILFIL
      * Currency
     C                   EVAL      SDATA = %TRIM(TXT(117))
S23  C*                  IF        VALKOD = *BLANKS
N23  C                   IF        XFVAL  = *BLANKS
     C                   CAT       'NOK':0       SDATA
     C                   ELSE
S23  C*                  CAT       VALKOD:0      SDATA
N23  C                   CAT       XFVAL:0       SDATA
     C                   END
     C                   CAT       TXT(118):0    SDATA
     C                   EXSR      TILFIL
      * KidNumber
     C                   EVAL      SDATA = %TRIM(TXT(119))
     C                             + %TRIM(XFKID) + %TRIM(TXT(120))
     C                   EXSR      TILFIL
      *
     C                   ENDSR
      *
      ***********************************************
     C     SRORDFT       BEGSR
      ***********************************************
     C     FREETK        SETLL     FREETXT2
     C     FREETK        READE     FREETXT2                               33
      *
     C                   DOW       *IN33 = *OFF                                 1<-B
     C                   IF        FRTKOD = FASK                                 2<-B
      * Fritekst
     C                   EVAL      XTXT801 = FRTTXT
     C                   Z-ADD     80            XN53              3 0
     C                   EXSR      KNVST
     C                   EVAL      SDATA = %TRIM(TXT(125))
     C                             + %TRIM(XTXT802) + %TRIM(TXT(126))
     C                   EXSR      TILFIL
     C                   END                                                     2<-E
      *
     C     FREETK        READE     FREETXT2                               33
     C  N33              ENDDO                                                  1<-E
      *
     C                   ENDSR
      *
      ***********************************************
     C     SRINVDET      BEGSR
      ***********************************************
     C     FAK8K         SETLL     FAK8
     C     FAK8K         READE     FAK8                                   33
     C                   MOVE      *ZEROS        XXLNR             5 0
     C                   DOW       *IN33 = *OFF                                 1<-B
      *
     C                   IF        FAOPKO <> 'D'                                 2<-B
     C                   IF        ((XFVAL = FICURR) OR (XFVAL = *BLANKS))        3<-B
     C                   EVAL      XXBEL = FABELN
     C                   ELSE                                                     3
     C                   EVAL      XXBEL = FABELV
     C                   END                                                      3<-E
      * Fortegn
     C                   MOVE      ' '           XFORTEGN          1
     C                   IF        XFFK = 'F'
     C                   IF        XXBEL < 0
     C                   MOVE      '-'           XFORTEGN
     C                   Z-SUB     XXBEL         XXBEL
     C                   END
     C                   ELSE
     C                   IF        XXBEL > 0
     C                   MOVE      '-'           XFORTEGN
     C                   ELSE
     C                   Z-SUB     XXBEL         XXBEL
     C                   END
     C                   END
      *
     C                   IF        XFSAML = 'N'
      * InvoiceDetails start
     C                   EVAL      SDATA = TXT(123)
     C                   EXSR      TILFIL
      *
     C                   ELSE
      *
     C                   EVAL      SDATA = TXT(169)
     C                   EXSR      TILFIL
      *
     C                   END
      *
      * Freetext
     C*                  EXSR      SRFRITXT
      *
      * BaseItemDetails
     C                   EXSR      SRITEMDET
      *
     C                   IF        XFSAML = 'N'
      * InvoiceDetails slutt
     C                   EVAL      SDATA = TXT(124)
     C                   EXSR      TILFIL
      *
     C                   ELSE
      *
     C                   EVAL      SDATA = TXT(170)
     C                   EXSR      TILFIL
      *
     C                   END
      *
     C                   END                                                     2<-E
      *
     C     FAK8K         READE     FAK8                                   33
     C                   ENDDO                                                  1<-E
      *
     C                   ENDSR
      *
      ***********************************************
     C     SRINVDETS     BEGSR
      ***********************************************
     C                   Z-ADD     2             XLEVEL
      * InvoiceDetails start
     C                   EVAL      SDATA = TXT(123)
     C                   EXSR      TILFIL
      *
     C                   DOU       *IN33
      * BaseItemDetails start
     C                   EVAL      SDATA = TXT(127)
     C                   EXSR      TILFIL
      * SubInvoice start
     C                   EVAL      SDATA = TXT(129)
     C                   EXSR      TILFIL
      *
N10  C                   IF        XTRDETAILS = 'J'
N10  C                   EXSR      SRTRDETAILS
N10  C                   ELSE
     C                   EXSR      SRINVHEAD
     C                   EXSR      SRINVDET
N10  C                   END
      * SubInvoice slutt
     C                   EVAL      SDATA = TXT(130)
     C                   EXSR      TILFIL
      * BaseItemDetails slutt
     C                   EVAL      SDATA = TXT(128)
     C                   EXSR      TILFIL
      * Oppdate EDIM
     C                   IF        XFSAML = 'J'
     C                   EXSR      OPDEDIM
     C                   END
      *
N08  C     STSRINVD1     TAG
     C     FIFN          READE     FAIN                                   33
N08  C                   IF        *IN33 = *OFF
N08  C     FAK8K         SETLL     FAK8
N08  C     FAK8K         READE     FAK8                                   33
N08  C  N33              DOW       FAOPKO = 'D' OR FAKDA = 'K'
N08  C     FAK8K         READE     FAK8                                   33
N08  C  N33              ENDDO
N08  C   33              GOTO      STSRINVD1
N08  C                   END
     C                   ENDDO
      *
      * InvoiceDetails slutt
     C                   EVAL      SDATA = TXT(124)
     C                   EXSR      TILFIL
      *
     C                   ENDSR
      *
      ***********************************************
     C     SRORDREF      BEGSR
      ***********************************************
N26   * Send fraktbrevnr
N26  C                   IF        HXSNDN <> *BLANKS
N26   * Ref start
N26  C                   EVAL      SDATA = '<Ref>'
N26  C                   EXSR      TILFIL
N26   * Code
N26  C                   EVAL      SDATA = '<Code>IFB</Code>'
N26  C                   EXSR      TILFIL
N26   * Text
N26  C                   IF        %SUBST(HXSNDN:1:3) = '401' AND
N26  C                             %SUBST(HXSNDN:20:1) <> ' '
N26  C                   EVAL      XTXT801 = %SUBST(HXSNDN:4:17)
N26  C                   ELSE
N26  C                   EVAL      XTXT801 = HXSNDN
N26  C                   END
N26  C                   Z-ADD     25            XN53              3 0
N26  C                   EXSR      KNVST
N26  C                   EVAL      SDATA = '<Text>' + %TRIM(XTXT802) + '</Text>'
N26  C                   EXSR      TILFIL
N26   * Ref Slutt
N26  C                   EVAL      SDATA = '</Ref>'
N26  C                   EXSR      TILFIL
N26   *
N26  C                   MOVE      'N'           XIFB              1
N26  C                   ELSE
N26  C                   MOVE      'J'           XIFB
N26  C                   END
      * Frisøkevei legges til Ref
     C     HEADFK        SETLL     FRISOK
     C     HEADFK        READE     FRISOK                                 33
     C                   DOW       *IN33 = *OFF                                 1<-B
     C                   IF        FSSOK <> *BLANKS                              2<-b
     C                   SORTA     DFS
     C     DFS(10)       IFNE      ' '                                            3<-B
     C                   MOVE      '0'           *IN34
N26  C                   IF        FSKODE <> 'IFB' OR XIFB = 'J'
     C     FASK          LOOKUP    DFS                                    34
S12  C* N34'B'           LOOKUP    DFS                                    33
N12  C  N34'B'           LOOKUP    DFS                                    34
N26  C                   END
     C                   IF        *IN34                                           4<-B
      * Ref start
     C                   EVAL      SDATA = TXT(173)
     C                   EXSR      TILFIL
      * Code
     C     FSKODE        CHAIN     KODFRI                             34
     C                   EVAL      XTXT801 = FSKODE
     C                   CAT       '/':0         XTXT801
     C                   CAT       KFSOTX:0      XTXT801
     C                   Z-ADD     45            XN53              3 0
     C                   EXSR      KNVST
     C                   EVAL      SDATA = %trim(TXT(175))
     C                             + %TRIM(XTXT802) + %TRIM(TXT(176))
     C                   EXSR      TILFIL
      * Text
     C                   EVAL      XTXT801 = FSSOK
     C                   Z-ADD     45            XN53              3 0
     C                   EXSR      KNVST
     C                   EVAL      SDATA = %TRIM(TXT(177))
     C                             + %TRIM(XTXT802) + %TRIM(TXT(178))
     C                   EXSR      TILFIL
      * Ref Slutt
     C                   EVAL      SDATA = TXT(174)
     C                   EXSR      TILFIL
      *
     C                   END                                                       4<-E
     C                   END                                                      3<-E
     C                   END                                                     2<-E
     C     HEADFK        READE     FRISOK                                 33
     C  N33              ENDDO                                                  1<-E
      *
S26   *
S26   * DOBBELT. SE SUBRUTINE SRORDFT
S26  C*    FREETK        SETLL     FREETXT2
S26  C*    FREETK        READE     FREETXT2                               33
S26   *
S26  C*                  DOW       *IN33 = *OFF                                 1<-B
S26  C*                  IF        FRTKOD = FASK                                 2<-B
S26   * Fritekst
S26  C*                  EVAL      XTXT801 = FRTTXT
S26  C*                  Z-ADD     80            XN53              3 0
S26  C*                  EXSR      KNVST
S26  C*                  EVAL      SDATA = %TRIM(TXT(125))
S26  C*                            + %TRIM(XTXT802) + %TRIM(TXT(126))
S26  C*                  EXSR      TILFIL
S26  C*                  END                                                     2<-E
S26   *
S26  C*    FREETK        READE     FREETXT2                               33
S26  C* N33              ENDDO                                                  1<-E
      *
     C                   ENDSR
      *
      ***********************************************
     C     SRITEMDET     BEGSR
      ***********************************************
      * BaseItemDetails  start
     C                   IF        XFSAML = 'N'
     C                   EVAL      SDATA = TXT(127)
     C                   EXSR      TILFIL
     C                   END
      * LineItemNum
     C                   ADD       1             XXLNR
     C                   EVAL      SDATA = %TRIM(TXT(131))
     C                             + %TRIM(%EDITC(XXLNR:'Z'))
     C                             + %TRIM(TXT(132))
     C                   EXSR      TILFIL
      * Level
     C                   IF        XFSAML = 'J'
     C                   EVAL      SDATA = %TRIM(TXT(171))
     C                             + 'ORDER' + %TRIM(TXT(172))
     C                   EXSR      TILFIL
     C                   END
      * Description
     C                   EVAL      SDATA = %TRIM(TXT(133))
     C                   IF        FAVT01 = 'X'                                   3<-B
      * KUN TEST FRA FAVT
     C                   EVAL      XTXT801 = FAVT02
     C                   Z-ADD     40            XN53              3 0
     C                   EXSR      KNVST
     C                   CAT       XTXT802:0     SDATA
     C                   ELSE                                                     3
     C                   IF        FAVT <> *BLANKS                                 4<-B
     C                   EVAL      XTXT801 = FAVT
     C                   Z-ADD     40            XN53              3 0
     C                   EXSR      KNVST
     C                   CAT       XTXT802:0     SDATA
     C                   CAT       ',':0         SDATA
     C                   END                                                       4<-E
     C     KODTGEK       CHAIN     KODTGE                             33
     C     KODTG2K       CHAIN     KODTG2                             33
     C                   SELECT                                                    4<-B
     C                   WHEN      SPRAAK = 'E'
     C                   EVAL      XTXT801 = KGEENT
     C                   WHEN      SPRAAK = 'T'
     C                   EVAL      XTXT801 = KG2TYT
     C                   OTHER
     C                   EVAL      XTXT801 = KGENOT
     C                   ENDSL                                                     4<-E
     C                   Z-ADD     40            XN53              3 0
     C                   EXSR      KNVST
     C                   CAT       XTXT802:0     SDATA
     C                   END                                                      3<-E
     C                   MOVE      XAN13BLANK    SDATA
     C                   CAT       TXT(134):0    SDATA
     C                   EXSR      TILFIL
      * Extra Description
     C     FAKTXTK       SETLL     FAKTXT
     C     FAKTXTK       READE     FAKTXT                                 33
     C                   DOW       *IN33 = *OFF
     C                   EVAL      XTXT801 = FXVT
     C                   Z-ADD     40            XN53              3 0
     C                   EXSR      KNVST
     C                   EVAL      SDATA = %TRIM(TXT(133))
     C                             + %TRIM(XTXT802) + %TRIM(TXT(134))
     C                   EXSR      TILFIL
     C     FAKTXTK       READE     FAKTXT                                 33
     C                   ENDDO
      * UnitPrice
     C                   EVAL      SDATA = %TRIM(TXT(135))
     C                             + %TRIM(%EDITC(XXBEL:'4'))
     C                             + %TRIM(TXT(136))
     C                   EXSR      TILFIL
      * PriceType
     C                   EVAL      SDATA = %TRIM(TXT(137))
     C                             + 'AAA' + %TRIM(TXT(138))
     C                   EXSR      TILFIL
      * LineItemAmount
     C                   EVAL      SDATA = %TRIM(TXT(139))
     C                             + %TRIM(XFORTEGN)
     C                             + %TRIM(%EDITC(XXBEL:'4'))
     C                             + %TRIM(TXT(140))
     C                   EXSR      TILFIL
      * QuantityInvoiced
     C                   EVAL      SDATA = %TRIM(TXT(141))
     C                             + '1' + %TRIM(TXT(142))
     C                   EXSR      TILFIL
      * UnitOfMeasure
     C                   EVAL      SDATA = %TRIM(TXT(143))
     C                             + 'Stk' + %TRIM(TXT(144))
     C                   EXSR      TILFIL
N21   *
N21  C                   IF        FAVAL <> FACURI AND FACURI <> *BLANKS
N21  C                             AND FAVAL <> XFVAL
N21  C                             AND *IN33 AND *IN33 = *OFF
N21   * ExchangeInformation Start
N21  C                   EVAL      SDATA = '<ExchangeInformation>'
N21  C                   EXSR      TILFIL
N21   * Currency
N21  C                   EVAL      SDATA = '<Currency>'
N21  C                             + %TRIM(FAVAL) + '</Currency>'
N21  C                   EXSR      TILFIL
N21   * ExchangeRate
N21  C                   IF        FAEXRA = 0
N21  C     VALUL01K      CHAIN     VALUL01                            33
N21  C                   EVAL(H)   FAEXRA = FABELN / FABELV * OMRFAK
N21  C                   END
N21  C                   EVAL      SDATA = '<ExchangeRate>'
N21  C                             + %TRIM(%EDITC(FAEXRA:'3'))
N21  C                             + '</ExchangeRate>'
N21  C                   EXSR      TILFIL
N21   * ExchangeInformation Slutt
N21  C                   EVAL      SDATA = '</ExchangeInformation>'
N21  C                   EXSR      TILFIL
N21  C                   END
      * VatInfo start
     C                   EVAL      SDATA = TXT(145)
     C                   EXSR      TILFIL
      * VatPercent
     C                   EVAL      SDATA = TXT(147)
     C                   SELECT                                                   3<-B
     C                   WHEN      FAKDM = 'N'
     C                   EVAL      MVAAVI = 0
     C                   WHEN      FAKDM = 'J'
     C                   EVAL      MVAAVI = FITAX * 100
     C                   OTHER
     C     KODWL01K      CHAIN     KODWL01                            33
     C   33              EVAL      MVAAVI = 0
     C                   ENDSL                                                    3<-E
     C                   EVAL      ØN152 = MVAAVI
     C                   MOVE      'N'           XBELØP
     C                   EXSR      SRNE
     C                   CAT       ØAN:0         SDATA
     C                   CAT       TXT(148):0    SDATA
     C                   EXSR      TILFIL
      * VatBaseAmount
     C                   EVAL      SDATA = TXT(149)
     C                   EVAL      ØN152 = XXBEL
     C                   MOVE      'J'           XBELØP
     C                   EXSR      SRNE
     C                   CAT       ØAN:0         SDATA
     C                   CAT       TXT(150):0    SDATA
     C                   EXSR      TILFIL
      * VatAmount
     C                   EVAL      SDATA = TXT(151)
     C                   EVAL      XXMVA = XXBEL * MVAAVI / 100
     C                   EVAL      ØN152 = XXMVA
     C                   MOVE      'J'           XBELØP
     C                   EXSR      SRNE
     C                   CAT       ØAN:0         SDATA
     C                   CAT       TXT(152):0    SDATA
     C                   EXSR      TILFIL
      * VatInfo slutt
     C                   EVAL      SDATA = TXT(146)
     C                   EXSR      TILFIL
      *
      * BaseItemDetails  slutt
     C                   IF        XFSAML = 'N'
     C                   EVAL      SDATA = TXT(128)
     C                   EXSR      TILFIL
     C                   END
      *
     C                   ENDSR
      *
N10   ***********************************************
N10  C     SRTRDETAILS   BEGSR
N10   ***********************************************
N15  C     HEADFK        CHAIN     HEADF                              33
N10  C     DOKUFK        CHAIN     DOKUF                              33
N10  C                   IF        *IN33
N10   * INGEN TRANSPORTDETALJE
N10  C                   IF        XFSAML = 'J'
N10  C                   EXSR      SRINVHEAD
N10  C                   END
N10  C                   EXSR      SRINVDET
N10  C                   GOTO      SLSRTRDET
N10  C                   END
N18   *
N18  C                   IF        XFSAML = 'N'
N10   * InvoiceDetails  start
N10  C                   EVAL      SDATA = '<InvoiceDetails>'
N10  C                   EXSR      TILFIL
N10   * BaseItemDetails  start
S18  C*                  IF        XFSAML = 'N'
N10  C                   EVAL      SDATA = '<BaseItemDetails>'
N10  C                   EXSR      TILFIL
N10  C                   END
N10   * TransportDetails  start
N10  C                   EVAL      SDATA = '<TransportDetails>'
N10  C                   EXSR      TILFIL
N10   * ConsignmentStructure start
N10  C                   EVAL      SDATA = '<ConsignmentStructure>'
N10  C                   EXSR      TILFIL
N10   * Consignment start
N10  C                   EVAL      SDATA = '<Consignment '
N10  C                             + 'consignmentID="' + %TRIM(DF1004)
N10  C                             + '" idType="EANSSCC">'
N10  C                   EXSR      TILFIL
N10   * GoodsDescription
N10  C                   EVAL      XTXT801 = %TRIM(DFVS) + ', ' + %TRIM(DFVS2)
N10  C                   Z-ADD     60            XN53              3 0
N10  C                   EXSR      KNVST
N10  C                   EVAL      SDATA = '<GoodsDescription>'
N10  C                             + %TRIM(XTXT802)
N10  C                             + '</GoodsDescription>'
N10  C                   EXSR      TILFIL
N10   * TotalGrossWeight
N10  C                   EVAL      SDATA = '<TotalGrossWeight '
N10  C                             + 'unitCode="KGM">'
N10  C                             + %TRIM(%EDITC(DFVKT:'Z'))
N10  C                             + '</TotalGrossWeight>'
N10  C                   EXSR      TILFIL
E29   * TotalVolume
N10  C                   IF        DFM3 <> 0
E29  C                   EVAL      SDATA = '<TotalVolume '
N10  C                             + 'unitCode="MTQ">'
N10  C                             + %TRIM(%EDITC(DFM3:'4'))
E29  C                             + '</TotalVolume>'
N10  C                   EXSR      TILFIL
N10  C                   END
N10   * LoadingMetres
N10  C                   IF        DFLM <> 0
N10  C                   EVAL      SDATA = '<LoadingMetres>'
N10  C                             + %TRIM(%EDITC(DFLM:'4'))
N10  C                             + '</LoadingMetres>'
N10  C                   EXSR      TILFIL
N10  C                   END
N10   * TotalPayableWeight
S14  C*                  EVAL      SDATA = '<TotalPayableweight '
N14  C                   EVAL      SDATA = '<TotalPayableWeight '
N10  C                             + 'unitCode="KGM">'
N10  C                             + %TRIM(%EDITC(DFVKTF:'Z'))
N10  C                             + '</TotalPayableWeight>'
N10  C                   EXSR      TILFIL
N10   * Marking
N10  C     DOKUFK        CHAIN     DOKUFM                             33
N10  C                   IF        *IN33
N10  C                   EVAL      XTXT801 = %TRIM(DFGM) + ', ' + %TRIM(DFGM2)
N10  C                   Z-ADD     60            XN53              3 0
N10  C                   EXSR      KNVST
N10  C                   EVAL      SDATA = '<Marking>'
N10  C                             + %TRIM(XTXT802)
N10  C                             + '</Marking>'
N10  C                   EXSR      TILFIL
N10  C                   ELSE
N29  C                   MOVE      *BLANKS       XAN2000        2000
N10  C                   DOW       *IN33 = *OFF
N10  C                   EVAL      XTXT801 = %TRIM(FMMRK1)
N10  C                   Z-ADD     60            XN53              3 0
N10  C                   EXSR      KNVST
N29  C                   IF        XAN2000 = *BLANKS
N29  C                   EVAL      XAN2000 = %TRIM(XTXT802)
N29  C                   ELSE
N29  C                   EVAL      XAN2000 = %TRIM(XAN2000)+', '+%TRIM(XTXT802)
N29  C                   END
S29  C*                  EVAL      SDATA = '<Marking>'
S29  C*                            + %TRIM(XTXT802)
S29  C*                            + '</Marking>'
S29  C*                  EXSR      TILFIL
N10  C     DOKUFK        READE     DOKUFM                                 33
N10  C                   ENDDO
N29  C                   IF        XAN2000 <> *BLANKS
N29  C                   EVAL      SDATA = '<Marking>'
N29  C                             + %TRIM(XAN2000)
N29  C                             + '</Marking>'
N29  C                   EXSR      TILFIL
N29  C                   END
N10  C                   END
N10   * NumberOfPackages
N10  C                   EVAL      SDATA = '<NumberOfPackages>'
N10  C                             + %TRIM(%EDITC(DFNT:'Z'))
N10  C                             + '</NumberOfPackages>'
N10  C                   EXSR      TILFIL
N10   * Reference
N10  C                   EXSR      SRTRTRREF
N10   * Party
N10  C                   EXSR      SRTRPARTY
N10   * TransportLeg
N10  C                   EXSR      SRTRTRLEG
N10   * TermsOfDelivery
N10  C                   EXSR      SRTRTERMS
N10   * DateAndTimes
N10  C                   EXSR      SRTRDATTIM
N10   * Consignment slutt
N10  C                   EVAL      SDATA = '</Consignment>'
N10  C                   EXSR      TILFIL
N10   * ConsignmentStructure slutt
N10  C                   EVAL      SDATA = '</ConsignmentStructure>'
N10  C                   EXSR      TILFIL
N10   * ChargeItems
N10  C                   EXSR      SRTRCHITEM
N10   * TransportDetails  slutt
N10  C                   EVAL      SDATA = '</TransportDetails>'
N10  C                   EXSR      TILFIL
N10   * LineItemNum start
N10  C                   ADD       1             XXLNR
N10  C                   EVAL      SDATA = '<LineItemNum>'
N10  C                             + %TRIM(%EDITC(XXLNR:'Z'))
N10  C                             + '</LineItemNum>'
N10  C                   EXSR      TILFIL
N10   * Description
N10  C                   EVAL      SDATA = '<Description>'
N10  C                             + %TRIM(DF1004)
N10  C                             + '</Description>'
N10  C                   EXSR      TILFIL
N10   * LineItemAmount
N10   * Fortegn
N10  C                   MOVE      ' '           XFORTEGN          1
N10  C                   IF        XFFK = 'F'
N10  C                   IF        XXBELTR < 0
N10  C                   MOVE      '-'           XFORTEGN
S29  C*                  Z-SUB     XXBELTR       XXBEL
N29  C                   Z-SUB     XXBELTR       XXBELTR
N10  C                   END
N10  C                   ELSE
N10  C                   IF        XXBELTR > 0
N10  C                   MOVE      '-'           XFORTEGN
N10  C                   ELSE
N10  C                   Z-SUB     XXBELTR       XXBELTR
N10  C                   END
N10  C                   END
N10  C                   EVAL      SDATA = '<LineItemAmount>'
N10  C                             + %TRIM(XFORTEGN)
N10  C                             + %TRIM(%EDITC(XXBELTR:'4'))
N10  C                             + '</LineItemAmount>'
N10  C                   EXSR      TILFIL
N21   *
S27  C*                  IF        FAVAL <> FACURI AND FACURI <> *BLANKS
S27  C*                            AND FAVAL <> XFVAL
N27  C                   IF        XFVAL <> FICURR AND XFVAL <> *BLANKS
N21  C                             AND *IN33 AND *IN33 = *OFF
N21   * ExchangeInformation Start
N21  C                   EVAL      SDATA = '<ExchangeInformation>'
N21  C                   EXSR      TILFIL
N21   * Currency
N21  C                   EVAL      SDATA = '<Currency>'
S27  C*                            + %TRIM(FAVAL) + '</Currency>'
N27  C                             + %TRIM(XFVAL) + '</Currency>'
N21  C                   EXSR      TILFIL
N21   * ExchangeRate
S27  C*                  IF        FAEXRA = 0
N21  C     VALUL01K      CHAIN     VALUL01                            33
N27  C                   EVAL(H)   FAEXRA = XXBELTRN / XXBELTR * OMRFAK
S27  C*                  EVAL(H)   FAEXRA = FABELN / FABELV * OMRFAK
S27  C*                  END
N21  C                   EVAL      SDATA = '<ExchangeRate>'
N21  C                             + %TRIM(%EDITC(FAEXRA:'3'))
N21  C                             + '</ExchangeRate>'
N21  C                   EXSR      TILFIL
N21   * ExchangeInformation Slutt
N21  C                   EVAL      SDATA = '</ExchangeInformation>'
N21  C                   EXSR      TILFIL
N21  C                   END
N10   * BaseItemDetails  slutt
N10  C                   IF        XFSAML = 'N'
N10  C                   EVAL      SDATA = '</BaseItemDetails>'
N10  C                   EXSR      TILFIL
S18  C*                  END
N10   * InvoiceDetails  slutt
N10  C                   EVAL      SDATA = '</InvoiceDetails>'
N10  C                   EXSR      TILFIL
S18  C                   END
N10   *
N10  C     SLSRTRDET     ENDSR
N10   *
N10   ***********************************************
N10  C     SRTRTRREF     BEGSR
N10   ***********************************************
N10   * Frisøkevei legges til Ref
N10  C     HEADFK        SETLL     FRISOK
N10  C     HEADFK        READE     FRISOK                                 33
N10  C                   DOW       *IN33 = *OFF                                 1<-B
N10  C                   IF        FSSOK <> *BLANKS                              2<-b
N10  C                   SORTA     DFS
N10  C     DFS(10)       IFNE      ' '                                            3<-B
N10  C                   MOVE      '0'           *IN34
N10  C     FASK          LOOKUP    DFS                                    34
N10  C  N34'B'           LOOKUP    DFS                                    33
N10  C                   IF        *IN34                                           4<-B
N10   * Reference start
N10  C                   EVAL      SDATA = '<Reference>'
N10  C                   EXSR      TILFIL
N10   * ReferenceNo
N10  C     FSKODE        CHAIN     KODFRI                             34
N10  C                   EVAL      XTXT801 = FSSOK
N10  C                   Z-ADD     45            XN53              3 0
N10  C                   EXSR      KNVST
N10  C                   EVAL      SDATA = '<ReferenceNo>'
N10  C                             + %TRIM(XTXT802) + '</ReferenceNo>'
N10  C                   EXSR      TILFIL
N10   * ReferenceType
N10  C                   EVAL      XTXT801 = FSKODE
N10  C                   Z-ADD     45            XN53              3 0
N10  C                   EXSR      KNVST
N10  C                   EVAL      SDATA = '<ReferenceType>'
N10  C                             + %TRIM(XTXT802) + '</ReferenceType>'
N10  C                   EXSR      TILFIL
N10   * Reference slutt
N10  C                   EVAL      SDATA = '</Reference>'
N10  C                   EXSR      TILFIL
N10   *
N10  C                   END                                                       4<-E
N10  C                   END                                                      3<-E
N10  C                   END                                                     2<-E
N10  C     HEADFK        READE     FRISOK                                 33
N10  C  N33              ENDDO                                                  1<-E
N10   *
N10  C                   ENDSR
N10   *
N10   ***********************************************
N10  C     SRTRPARTY     BEGSR
N10   ***********************************************
N10   * AVSENDER
N10   * Party start
N10  C                   IF        DFSREF = *BLANKS
N10  C                   EVAL      SDATA = '<Party subClass="Consignor">'
N10  C                   ELSE
N10  C                   EVAL      SDATA = '<Party partyId="' + %TRIM(DFSREF)
N10  C                             + '" idType="91" subClass="Consignor">'
N10  C                   END
N10  C                   EXSR      TILFIL
N10   * Name
N10  C                   EVAL      XTXT801 = %TRIM(DFNAVS)
N10  C                   Z-ADD     50            XN53              3 0
N10  C                   EXSR      KNVST
N10  C                   EVAL      SDATA = '<Name>'
N10  C                             + %TRIM(XTXT802) + '</Name>'
N10  C                   EXSR      TILFIL
N10   * Address start
N10  C                   EVAL      SDATA = '<Address '
S10YBC*                            + 'Address subClass="PhysicalAddress">'
N10YBC                             + 'subClass="PhysicalAddress">'
N10  C                   EXSR      TILFIL
S29   * Street
S29  C*                  EVAL      XTXT801 = %TRIM(DFAD1S)
S29  C*                  Z-ADD     50            XN53              3 0
S29  C*                  EXSR      KNVST
S29  C*                  EVAL      SDATA = '<Street>'
S29  C*                            + %TRIM(XTXT802) + '</Street>'
S29  C*                  EXSR      TILFIL
S29   * StreetNo
S29  C*                  IF        DFAD2S <> *BLANKS
S29  C*                  EVAL      XTXT801 = %TRIM(DFAD2S)
S29  C*                  Z-ADD     50            XN53              3 0
S29  C*                  EXSR      KNVST
S29  C*                  EVAL      SDATA = '<StreetNo>'
S29  C*                            + %TRIM(XTXT802) + '</StreetNo>'
S29  C*                  EXSR      TILFIL
S29  C*                  END
N10   * PostalCode
N10  C                   IF        DFPNUS = *BLANKS
N10  C                   MOVE      DFPNLS        XAN04             4
N10  C                   EVAL      SDATA = '<PostalCode>'
N10  C                             + %TRIM(XAN04) + '</PostalCode>'
N10  C                   ELSE
N10  C                   EVAL      XTXT801 = %TRIM(DFPNUS)
N10  C                   Z-ADD     50            XN53              3 0
N10  C                   EXSR      KNVST
N10  C                   EVAL      SDATA = '<PostalCode>'
N10  C                             + %TRIM(XTXT802) + '</PostalCode>'
N10  C                   END
N10  C                   EXSR      TILFIL
N10   * City
N10  C                   EVAL      XTXT801 = %TRIM(DFAD3S)
N10  C                   Z-ADD     50            XN53              3 0
N10  C                   EXSR      KNVST
N10  C                   EVAL      SDATA = '<City>'
N10  C                             + %TRIM(XTXT802) + '</City>'
N10  C                   EXSR      TILFIL
N16   * CountryCode
N16  C                   SELECT
N16  C                   WHEN      DFLKS = *BLANKS AND HELKS = *BLANKS
N16  C                   EVAL      SDATA = '<CountryCode>' + %TRIM(HELKA)
N16  C                             + '</CountryCode>'
N16  C                   WHEN      DFLKS = *BLANKS AND HELKS <> *BLANKS
N16  C                   EVAL      SDATA = '<CountryCode>' + %TRIM(HELKS)
N16  C                             + '</CountryCode>'
N16  C                   OTHER
N16  C                   EVAL      SDATA = '<CountryCode>' + %TRIM(DFLKS)
N16  C                             + '</CountryCode>'
N16  C                   ENDSL
N16  C                   EXSR      TILFIL
N29   * Street
N29  C                   EVAL      XTXT801 = %TRIM(DFAD1S)
N29  C                   Z-ADD     50            XN53              3 0
N29  C                   EXSR      KNVST
N29  C                   EVAL      SDATA = '<Street>'
N29  C                             + %TRIM(XTXT802) + '</Street>'
N29  C                   EXSR      TILFIL
N29   * StreetNo
N29  C                   IF        DFAD2S <> *BLANKS
N29  C                   EVAL      XTXT801 = %TRIM(DFAD2S)
N29  C                   Z-ADD     50            XN53              3 0
N29  C                   EXSR      KNVST
N29  C                   EVAL      SDATA = '<StreetNo>'
N29  C                             + %TRIM(XTXT802) + '</StreetNo>'
N29  C                   EXSR      TILFIL
N29  C                   END
N10   * Address slutt
N10  C                   EVAL      SDATA = '</Address>'
N10  C                   EXSR      TILFIL
N10   * Party slutt
N10  C                   EVAL      SDATA = '</Party>'
N10  C                   EXSR      TILFIL
N10   *
N10   * MOTTAKER
N10   * Party start
N10  C                   IF        DFMREF = *BLANKS
N10  C                   EVAL      SDATA = '<Party subClass="Consignee">'
N10  C                   ELSE
N10  C                   EVAL      SDATA = '<Party partyId="' + %TRIM(DFMREF)
N10  C                             + '" idType="91" subClass="Consignee">'
N10  C                   END
N10  C                   EXSR      TILFIL
N10   * Name
N10  C                   EVAL      XTXT801 = %TRIM(DFNAVM)
N10  C                   Z-ADD     50            XN53              3 0
N10  C                   EXSR      KNVST
N10  C                   EVAL      SDATA = '<Name>'
N10  C                             + %TRIM(XTXT802) + '</Name>'
N10  C                   EXSR      TILFIL
N10   * Address start
N10  C                   EVAL      SDATA = '<Address '
S10YBC*                            + 'Address subClass="PhysicalAddress">'
N10YBC                             + 'subClass="PhysicalAddress">'
N10  C                   EXSR      TILFIL
N10   * Street
N10  C                   EVAL      XTXT801 = %TRIM(DFAD1M)
N10  C                   Z-ADD     50            XN53              3 0
N10  C                   EXSR      KNVST
N10  C                   EVAL      SDATA = '<Street>'
N10  C                             + %TRIM(XTXT802) + '</Street>'
N10  C                   EXSR      TILFIL
N10   * StreetNo
N10  C                   IF        DFAD2M <> *BLANKS
N10  C                   EVAL      XTXT801 = %TRIM(DFAD2M)
N10  C                   Z-ADD     50            XN53              3 0
N10  C                   EXSR      KNVST
N10  C                   EVAL      SDATA = '<StreetNo>'
N10  C                             + %TRIM(XTXT802) + '</StreetNo>'
N10  C                   EXSR      TILFIL
N10  C                   END
N10   * PostalCode
N10  C                   IF        DFPNUM = *BLANKS
N10  C                   MOVEL     DFAD3M        XAN04             4
N10  C                   EVAL      SDATA = '<PostalCode>'
N10  C                             + %TRIM(XAN04) + '</PostalCode>'
N10  C                   ELSE
N10  C                   EVAL      XTXT801 = %TRIM(DFPNUM)
N10  C                   Z-ADD     50            XN53              3 0
N10  C                   EXSR      KNVST
N10  C                   EVAL      SDATA = '<PostalCode>'
N10  C                             + %TRIM(XTXT802) + '</PostalCode>'
N10  C                   END
N10  C                   EXSR      TILFIL
N10   * City
N10  C                   EVAL      XTXT801 = %TRIM(DFAD3M)
N10  C                   Z-ADD     50            XN53              3 0
N10  C                   EXSR      KNVST
N10  C                   EVAL      SDATA = '<City>'
N10  C                             + %TRIM(XTXT802) + '</City>'
N10  C                   EXSR      TILFIL
N16   * CountryCode
N16  C                   SELECT
N16  C                   WHEN      DFLKM = *BLANKS AND HELKK = *BLANKS
N16  C                   EVAL      SDATA = '<CountryCode>' + %TRIM(HETRI)
N16  C                             + '</CountryCode>'
N16  C                   WHEN      DFLKM = *BLANKS AND HELKK <> *BLANKS
N16  C                   EVAL      SDATA = '<CountryCode>' + %TRIM(HELKK)
N16  C                             + '</CountryCode>'
N16  C                   OTHER
N16  C                   EVAL      SDATA = '<CountryCode>' + %TRIM(DFLKM)
N16  C                             + '</CountryCode>'
N16  C                   ENDSL
N16  C                   EXSR      TILFIL
N10   * Address slutt
N10  C                   EVAL      SDATA = '</Address>'
N10  C                   EXSR      TILFIL
N10   * Party slutt
N10  C                   EVAL      SDATA = '</Party>'
N10  C                   EXSR      TILFIL
N10   *
N10  C                   ENDSR
N10   *
N10   ***********************************************
N10  C     SRTRTRLEG     BEGSR
N10   ***********************************************
N10   * TransportLeg start
N10  C                   EVAL      SDATA = '<TransportLeg>'
N10  C                   EXSR      TILFIL
N10   * Location fra-sted
N10  C                   EVAL      SDATA = '<Location '
N10  C                             + 'subClass="StartLocation" '
N10  C                             + 'locationId="' + %TRIM(HESDF)
N10  C                             + '" idType="140"/>'
N10  C                   EXSR      TILFIL
N10   * Location til-sted
N10  C                   EVAL      SDATA = '<Location '
N10  C                             + 'subClass="EndLocation" '
N10  C                             + 'locationId="' + %TRIM(HESDT)
N10  C                             + '" idType="140"/>'
N10  C                   EXSR      TILFIL
N10   * TransportLeg slutt
N10  C                   EVAL      SDATA = '</TransportLeg>'
N10  C                   EXSR      TILFIL
N10   *
N10  C                   ENDSR
N10   *
N10   ***********************************************
N10  C     SRTRTERMS     BEGSR
N10   ***********************************************
N10   * TermsOfDelivery start
N10  C                   EVAL      SDATA = '<TermsOfDelivery>'
N10  C                   EXSR      TILFIL
S29   * TermsOfDeliveryCode
S29  C*                  EVAL      SDATA = '<TermsOfDeliveryCode>'
S29  C*                            + %TRIM(HEFR) + '</TermsOfDeliveryCode>'
N29   * TODConditionCode
N29  C                   EVAL      SDATA = '<TODConditionCode>'
N29  C                             + %TRIM(HEFR) + '</TODConditionCode>'
N10  C                   EXSR      TILFIL
N29   * TODConditionCodeList
N29  C                   EVAL      SDATA = '<TODConditionCodeList>'
N29  C                             + 'Incoterms' + '</TODConditionCodeList>'
N29  C                   EXSR      TILFIL
N29   * TODLocation
N29  C                   IF        KFRCP = 'CC'
N29  C     STED2DK1      CHAIN     STED2D                             34
N29  C                   ELSE
N29  C     STED2DK2      CHAIN     STED2D                             34
N29  C                   END
N29  C                   EVAL      SDATA = '<TODLocation>'
N29  C                             + %TRIM(ST2NVN) + '</TODLocation>'
N29  C                   EXSR      TILFIL
N10   * TermsOfDelivery slutt
N10  C                   EVAL      SDATA = '</TermsOfDelivery>'
N10  C                   EXSR      TILFIL
N10   *
N10  C                   ENDSR
N10   *
N10   ***********************************************
N10  C     SRTRDATTIM    BEGSR
N10   ***********************************************
N10  C     TRACKTK       CHAIN     TRACKT                             33
N10  C  N33              EVAL      TRSDFD = TXATDD
N10  C  N33              EVAL      TRSDTD = TXATAD
N10  C                   IF        TRSDFD = 0
N10  C                   EVAL      TRSDFD = HEDTOP
N10  C                   END
N10  C                   IF        TRSDTD = 0
N10  C                   EVAL      TRSDTD = HEDTOP
N10  C                   END
N10   * ATD
N10   * DateAndTimes start
N10  C                   EVAL      SDATA = '<DateAndTimes '
S29  C*                            + 'subClass="DepartureDate">'
N29  C                             + 'subClass="LoadingDate">'
N10  C                   EXSR      TILFIL
N10   * Year
N10  C                   EVAL      SDATA = '<Year>'
N10  C                             + %TRIM(TRSDFDAA) + '</Year>'
N10  C                   EXSR      TILFIL
N10   * Month
N10  C                   EVAL      SDATA = '<Month>'
N10  C                             + %TRIM(TRSDFDMM) + '</Month>'
N10  C                   EXSR      TILFIL
N10   * Day
N10  C                   EVAL      SDATA = '<Day>'
N10  C                             + %TRIM(TRSDFDDD) + '</Day>'
N10  C                   EXSR      TILFIL
N10   * DateAndTimes slutt
N10  C                   EVAL      SDATA = '</DateAndTimes>'
N10  C                   EXSR      TILFIL
N10   * ATA
N10   * DateAndTimes start
N10  C                   EVAL      SDATA = '<DateAndTimes '
N10  C                             + 'subClass="ArrivalDate">'
N10  C                   EXSR      TILFIL
N10   * Year
N10  C                   EVAL      SDATA = '<Year>'
N10  C                             + %TRIM(TRSDTDAA) + '</Year>'
N10  C                   EXSR      TILFIL
N10   * Month
N10  C                   EVAL      SDATA = '<Month>'
N10  C                             + %TRIM(TRSDTDMM) + '</Month>'
N10  C                   EXSR      TILFIL
N10   * Day
N10  C                   EVAL      SDATA = '<Day>'
N10  C                             + %TRIM(TRSDTDDD) + '</Day>'
N10  C                   EXSR      TILFIL
N10   * DateAndTimes slutt
N10  C                   EVAL      SDATA = '</DateAndTimes>'
N10  C                   EXSR      TILFIL
N10   *
N10  C                   ENDSR
N10   *
N10   ***********************************************
N10  C     SRTRCHITEM    BEGSR
N10   ***********************************************
N10  C                   Z-ADD     0             XXBELTR          13 2
N27  C                   Z-ADD     0             XXBELTRN         13 2
N10  C                   Z-ADD     0             XXLNRTR           5 0
N10   * ChargeItems start
N10  C                   EVAL      SDATA = '<ChargeItems>'
N10  C                   EXSR      TILFIL
N10   *
N10  C     FAK8K         SETLL     FAK8
N10  C     FAK8K         READE     FAK8                                   33
N10  C                   DOW       *IN33 = *OFF                                 1<-B
N10   *
N10  C                   IF        FAOPKO <> 'D'                                 2<-B
N10  C                   ADD       1             XXLNRTR
N10  C                   IF        ((XFVAL = FICURR) OR (XFVAL = *BLANKS))        3<-B
N10  C                   EVAL      XXBEL = FABELN
N10  C                   ELSE                                                     3
N10  C                   EVAL      XXBEL = FABELV
N10  C                   END                                                      3<-E
N27  C                   ADD       FABELN        XXBELTRN
N10  C                   ADD       XXBEL         XXBELTR
N10   * Fortegn
N10  C                   MOVE      ' '           XFORTEGN          1
N10  C                   IF        XFFK = 'F'
N10  C                   IF        XXBEL < 0
N10  C                   MOVE      '-'           XFORTEGN
N10  C                   Z-SUB     XXBEL         XXBEL
N10  C                   END
N10  C                   ELSE
N10  C                   IF        XXBEL > 0
N10  C                   MOVE      '-'           XFORTEGN
N10  C                   ELSE
N10  C                   Z-SUB     XXBEL         XXBEL
N10  C                   END
N10  C                   END
N10   *
N10   * Details start
N10  C                   EVAL      SDATA = '<Details>'
N10  C                   EXSR      TILFIL
N10   * LineItemNum
N10  C                   EVAL      SDATA = '<LineItemNum>'
N10  C                             + %TRIM(%EDITC(XXLNRTR:'Z'))
N10  C                             + '</LineItemNum>'
N10  C                   EXSR      TILFIL
N10   * Description
N10  C                   EVAL      SDATA = '<Description>'
N10  C                   IF        FAVT01 = 'X'                                   3<-B
N10   * KUN TEST FRA FAVT
N10  C                   EVAL      XTXT801 = FAVT02
N10  C                   Z-ADD     40            XN53              3 0
N10  C                   EXSR      KNVST
N10  C                   CAT       XTXT802:0     SDATA
N10  C                   ELSE                                                     3
N10  C                   IF        FAVT <> *BLANKS                                 4<-B
N10  C                   EVAL      XTXT801 = FAVT
N10  C                   Z-ADD     40            XN53              3 0
N10  C                   EXSR      KNVST
N10  C                   CAT       XTXT802:0     SDATA
N10  C                   CAT       ',':0         SDATA
N10  C                   END                                                       4<-E
N10  C     KODTGEK       CHAIN     KODTGE                             33
N10  C     KODTG2K       CHAIN     KODTG2                             33
N10  C                   SELECT                                                    4<-B
N10  C                   WHEN      SPRAAK = 'E'
N10  C                   EVAL      XTXT801 = KGEENT
N10  C                   WHEN      SPRAAK = 'T'
N10  C                   EVAL      XTXT801 = KG2TYT
N10  C                   OTHER
N10  C                   EVAL      XTXT801 = KGENOT
N10  C                   ENDSL                                                     4<-E
N10  C                   Z-ADD     40            XN53              3 0
N10  C                   EXSR      KNVST
N10  C                   CAT       XTXT802:0     SDATA
N10  C                   END                                                      3<-E
N10  C                   MOVE      XAN13BLANK    SDATA
N10  C                   EVAL      SDATA = %TRIM(SDATA) + '</Description>'
N10  C                   EXSR      TILFIL
N10   * Extra Description
N10  C     FAKTXTK       SETLL     FAKTXT
N10  C     FAKTXTK       READE     FAKTXT                                 33
N10  C                   DOW       *IN33 = *OFF
N10  C                   EVAL      XTXT801 = FXVT
N10  C                   Z-ADD     40            XN53              3 0
N10  C                   EXSR      KNVST
N10  C                   EVAL      SDATA = '<Description>'
N10  C                             + %TRIM(XTXT802) + '</Description>'
N10  C                   EXSR      TILFIL
N10  C     FAKTXTK       READE     FAKTXT                                 33
N10  C                   ENDDO
N10   * LineItemAmount
N10  C                   EVAL      SDATA = '<LineItemAmount>'
N10  C                             + %TRIM(XFORTEGN)
N10  C                             + %TRIM(%EDITC(XXBEL:'4'))
N10  C                             + '</LineItemAmount>'
N10  C                   EXSR      TILFIL
N10   * VatInfo start
N10  C                   EVAL      SDATA = '<VatInfo>'
N10  C                   EXSR      TILFIL
N10   * VatPercent
N10  C                   EVAL      SDATA = '<VatPercent>'
N10  C                   SELECT                                                   3<-B
N10  C                   WHEN      FAKDM = 'N'
N10  C                   EVAL      MVAAVI = 0
N10  C                   WHEN      FAKDM = 'J'
N10  C                   EVAL      MVAAVI = FITAX * 100
N10  C                   OTHER
N10  C     KODWL01K      CHAIN     KODWL01                            33
N10  C   33              EVAL      MVAAVI = 0
N10  C                   ENDSL                                                    3<-E
N10  C                   EVAL      ØN152 = MVAAVI
N10  C                   MOVE      'N'           XBELØP
N10  C                   EXSR      SRNE
N10  C                   CAT       ØAN:0         SDATA
N10  C                   EVAL      SDATA = %TRIM(SDATA) + '</VatPercent>'
N10  C                   EXSR      TILFIL
N10   * VatBaseAmount
N10  C                   EVAL      SDATA = '<VatBaseAmount>'
N10  C                   EVAL      ØN152 = XXBEL
N10  C                   MOVE      'J'           XBELØP
N10  C                   EXSR      SRNE
N28  C                   IF        XFORTEGN = '-'
N28  C                   CAT       '-':0         SDATA
N28  C                   END
N10  C                   CAT       ØAN:0         SDATA
N10  C                   EVAL      SDATA = %TRIM(SDATA) + '</VatBaseAmount>'
N10  C                   EXSR      TILFIL
N10   * VatAmount
N10  C                   EVAL      SDATA = '<VatAmount>'
N10  C                   EVAL      XXMVA = XXBEL * MVAAVI / 100
N10  C                   EVAL      ØN152 = XXMVA
N10  C                   MOVE      'J'           XBELØP
N10  C                   EXSR      SRNE
N28  C                   IF        XFORTEGN = '-'
N28  C                   CAT       '-':0         SDATA
N28  C                   END
N10  C                   CAT       ØAN:0         SDATA
N10  C                   EVAL      SDATA = %TRIM(SDATA) + '</VatAmount>'
N10  C                   EXSR      TILFIL
N10   * VatInfo slutt
N10  C                   EVAL      SDATA = '</VatInfo>'
N10  C                   EXSR      TILFIL
N10   *
N10   * Details slutt
N10  C                   EVAL      SDATA = '</Details>'
N10  C                   EXSR      TILFIL
N10   *
N10  C                   END                                                     2<-E
N10   *
N10  C     FAK8K         READE     FAK8                                   33
N10  C                   ENDDO                                                  1<-E
N10   * ChargeItems slutt
N10  C                   EVAL      SDATA = '</ChargeItems>'
N10  C                   EXSR      TILFIL
N10   *
N10  C                   ENDSR
N10   *
      ***********************************************
     C     SRINVSUM      BEGSR
      ***********************************************
      * InvoiceSummary start
     C                   EVAL      SDATA = TXT(153)
     C                   EXSR      TILFIL
      *
      * InvoiceTotals
     C                   EXSR      SRINVTOT
      *
      * VatTotalsInfo
     C                   EXSR      SRVATTOT
      *
      * InvoiceSummary slutt
     C                   EVAL      SDATA = TXT(154)
     C                   EXSR      TILFIL
      *
     C                   ENDSR
      *
      ***********************************************
     C     SRINVTOT      BEGSR
      ***********************************************
     C                   MOVE      *ZEROS        XXMVAT           13 2
     C     1             DO        11            XN01              3 0
     C                   IF        XMLT1(XN01) > 0
     C                   IF        XMLT2(XN01) = *BLANKS
     C                   EVAL      XMLT2(XN01) = FICURR
     C                   END
     C                   IF        XMLT2(XN01) = FICURR
     C                   EVAL(H)   XXMVAT = XXMVAT+XMLT1(XN01)*XMLT3(XN01)/100
     C                   ELSE
     C                   EVAL(H)   XXMVAT = XXMVAT+XMLT1(XN01)*XMLT4(XN01)/100
     C                   END
     C                   END
     C                   ENDDO
     C     XFTOT         SUB       XXMVAT        XX0MVAGR         13 2
      *
      * InvoiceTotals  start
     C                   EVAL      SDATA = TXT(155)
     C                   EXSR      TILFIL
      *
      * GrossAmount (Total inkluderer MVA)
     C                   EVAL      SDATA = TXT(157)
     C                   MOVE      XFTOT         XFTOT2           13 2
     C                   IF        XFFK = 'F'
     C                   IF        XFTOT2 < 0
     C                   CAT       '-':0         SDATA
     C                   Z-SUB     XFTOT2        XFTOT2
     C                   END
     C                   ELSE
     C                   IF        XFTOT2 > 0
     C                   CAT       '-':0         SDATA
     C                   ELSE
     C                   Z-SUB     XFTOT2        XFTOT2
     C                   END
     C                   END
     C                   EVAL      ØN152 = XFTOT2
     C                   MOVE      'J'           XBELØP
     C                   EXSR      SRNE
     C                   CAT       ØAN:0         SDATA
     C                   CAT       TXT(158):0    SDATA
     C                   EXSR      TILFIL
      *
      * VatTotalsAmount
     C                   EVAL      SDATA = TXT(159)
     C                   IF        XXMVAT < 0
     C                   Z-SUB     XXMVAT        XXMVAT
     C                   END
     C                   EVAL      ØN152 = XXMVAT
     C                   MOVE      'J'           XBELØP
     C                   EXSR      SRNE
     C                   CAT       ØAN:0         SDATA
     C                   CAT       TXT(160):0    SDATA
     C                   EXSR      TILFIL
      *
      * NetAmount (Total uten MVA)
     C                   EVAL      SDATA = TXT(161)
     C                   EVAL      ØN152 = XFTOT2 - XXMVAT
     C                   MOVE      'J'           XBELØP
     C                   EXSR      SRNE
     C                   CAT       ØAN:0         SDATA
     C                   CAT       TXT(162):0    SDATA
     C                   EXSR      TILFIL
      *
      * InvoiceTotals  start
     C                   EVAL      SDATA = TXT(156)
     C                   EXSR      TILFIL
      *
     C                   ENDSR
      *
      ***********************************************
     C     SRVATTOT      BEGSR
      ***********************************************
      *
     C                   ENDSR
      *
      ***********************************************
     C     SRCLOSE       BEGSR
      ***********************************************
     C                   CLOSE     KODWL01
     C                   CLOSE     KODTA
     C                   CLOSE     KODTGE
     C                   CLOSE     KODTG2
     C                   CLOSE     KODTFR
     C                   CLOSE     KODTOTY
N21  C                   CLOSE     VALUL01
     C                   CLOSE     CUNDL01
     C                   CLOSE     FAIN
     C                   CLOSE     HEADF
N10  C                   CLOSE     DOKUF
N10  C                   CLOSE     DOKUFM
N10  C                   CLOSE     TRACKT
     C                   CLOSE     FAK8
     C                   CLOSE     FAKTXT
     C                   CLOSE     FRISOK
     C                   CLOSE     KODFRI
     C                   CLOSE     EDIC
     C                   CLOSE     EDIS
     C                   CLOSE     EDIM
N20  C                   CLOSE     TRACKF
S19  C*                  CLOSE     EDISE1K
N19  C                   callp     close( FILE_o )
N19  C                   EVAL      XCHGAUT = 'CHGAUT OBJ(' + XAPS
N19  C                             + %TRIM(FILNAM) + XAPS
N19  C                             + ') USER(*PUBLIC) DTAAUT(*RWX) OBJAUT(*ALL)'
N19  C                   CALLP     RUNCMD(XCHGAUT:200)
      *
     C                   ENDSR
      *
      ***********************************************
     C     SRSNDSL       BEGSR
      ***********************************************
     C                   EVAL      SDATA = TXT(006)
     C                   EXSR      TILFIL
      *
     C     XSSN          CHAIN     EDIS                               33
     C* N33              MOVE      'A'           SST
     C  N33              UPDATE    EDISR
S04  C*    XSSNVEDL      CHAIN     EDIS                               33
N04  C     1             DO        100           XSNVN
N04  C     XSNV(XSNVN)   CHAIN     EDIS                               33
     C* N33              MOVE      'A'           SST
     C  N33              UPDATE    EDISR
N04  C                   ENDDO
      *
     C                   ENDSR
      *
      ***********************************************
     C     OPDEDIM       BEGSR
      ***********************************************
     C     1             CHAIN     EDIC                               33
     C                   ADD       1             CMN
     C                   UPDATE    EDICR
      *
     C                   EVAL      M0004 = S0004
     C                   EVAL      M0010 = S0010
     C                   MOVEL     CMN           M0062
     C                   EVAL      M0065 = 'INVXML'
     C                   MOVEL     XFFN          M0068
     C                   IF        XFFK = 'F'
     C                   MOVEL     '380'         M1001
     C                   ELSE
     C                   MOVEL     '381'         M1001
     C                   END
     C                   MOVEL     XFFN          M1004
     C                   IF        XFSAML = 'N'
     C                   MOVE      'SIN'         M1225
     C                   ELSE
     C                   MOVE      'SAM'         M1225
     C                   END
     C                   EVAL      MSN = SSN
     C                   EVAL      MMN = CMN
     C                   EVAL      MSR = 'S'
     C                   EVAL      MST = 'C'
     C                   MOVE      WDT           MDT
     C                   MOVE      WTM           MTM
     C                   IF        XFSAML = 'N'
     C                   EVAL      MAVD = FIAVD
     C                   EVAL      MTDN = FIOPD
     C                   ELSE
     C                   EVAL      MAVD = 0
     C                   EVAL      MTDN = 0
     C                   END
     C                   WRITE     EDIMR
N20   *
N20  C                   EVAL      TTAVD  = MAVD
N20  C                   EVAL      TTOPD  = MTDN
N20  C                   EVAL      TTACTI = 'E2B'
N20  C                   EVAL      TTDATE = MDT
N20  C                   EVAL      TTTIME = MTM
N20  C                   EVAL      TTUSER = ZUSER
N20  C                   EVAL      TTDATL = MDT
N20  C                   EVAL      TTTIML = MTM
N20  C                   EVAL      TTMANU = 'E'
N20  C                   EVAL      TTTEXT = 'E2B-invoice (' + %TRIM(M0068)
N20  C                             + ') is created and sent to receiver'
N20  C                   EVAL      TTTEXL = 'E2B-faktura (' + %TRIM(M0068)
N20  C                             + ') er laget og sendt til mottaker)'
N20  C                   WRITE     TRACKFR
      *
     C                   ENDSR
      *
      *////////////////////////////////////////////////////////////
      *  Venstrestill numeriske verdier                      SRNE /
      *////////////////////////////////////////////////////////////
     C     SRNE          BEGSR
     C                   IF        ØN152 < 0
     C                   MOVE      '-'           XAN01             1
     C                   Z-SUB     ØN152         ØN152
     C                   ELSE
     C                   MOVE      ' '           XAN01
     C                   END
      * Flytte in rett verdi i Alfa 12-felt
     C                   MOVE      *ZEROS        ØA12
     C     ØA152D        IFEQ      '00'                                         <-------------I
     C     XBELØP        ANDEQ     'N'                                                        I
     C                   MOVE      ØA152H        ØA12                                         I
     C                   ELSE                                                   <-------------I
     C                   MOVEL     ØA152X        ØA12                                         I
     C                   MOVE      '.  '         ØA12                                         I
     C                   MOVE      ØA152D        ØA12                                         I
     C     XBELØP        IFEQ      'N'
     C     Ø12(12)       IFEQ      '0'
     C                   MOVE      ' '           Ø12(12)
     C     Ø12(11)       IFEQ      '0'
     C                   MOVE      ' '           Ø12(11)
     C                   END
     C                   END
     C                   END
     C                   END                                                    <-------------I
      * lete fra venstre og finn foerste siffer over 0
     C     1             DO        11            ØX                             <-------------I
     C     Ø12(ØX)       IFNE      '0'                                           <-----------II
     C                   GOTO      SRNE1                                                     II
     C                   END                                                     <-----------II
     C                   END                                                    <-------------I
     C     SRNE1         TAG
      * Venstrestill til et nytt felt
     C                   MOVE      *BLANKS       XXA12            12
     C     Ø12(ØX)       IFEQ      '.'
     C                   SUB       1             ØX
     C                   END
     C                   MOVEA     Ø12(ØX)       XXA12
     C                   IF        XAN01 = '-'
     C                   EVAL      ØAN = XAN01
     C                   CAT       XXA12:0       ØAN
     C                   ELSE
     C                   EVAL      ØAN = XXA12
     C                   END
      *
     C                   ENDSR
      ***********************************************
     C     TILFIL        BEGSR
      ***********************************************
S19  C*                  WRITE     EDISER
N19  C                   EVAL      SDATA=(%trimr(SDATA))+ LF
N19  C                   callp     write(File_o : %addr(Sdata)
N19  C                                : %len(%trimr(Sdata)) )
      *
     C                   ENDSR
      *
      ***********************************************
     C     KNVST         BEGSR
      ***********************************************
     C     XN53          SUB       4             XN54              3 0
     C     XN53          SUB       5             XN55              3 0
     C     XN53          SUB       6             XN56              3 0
     C                   Z-ADD     0             XN52              3 0
     C                   MOVE      *BLANKS       XTXT802
     C     1             DO        80            XN51              3 0
     C                   IF        (((((XT801(XN51) = '&') OR
     C                                 (XT801(XN51) = '"')) OR
     C                                 (XT801(XN51) = XAPS)) OR
     C                                 (XT801(XN51) = '<')) OR
     C                                 (XT801(XN51) = '>'))
     C                   IF        XN52 < XN53
     C                   ADD       1             XN52
     C                   SELECT
     C                   WHEN      XT801(XN51) = '&'
     C                   IF        XN51 < XN55
     C                   MOVEA     '&amp;'       XT802(XN52)
     C                   ADD       4             XN52
     C                   ELSE
     C                   SUB       1             XN52
     C                   END
     C                   WHEN      XT801(XN51) = '"'
     C                   IF        XN51 < XN56
     C                   MOVEA     '&quot;'      XT802(XN52)
     C                   ADD       5             XN52
     C                   ELSE
     C                   SUB       1             XN52
     C                   END
     C                   WHEN      XT801(XN51) = XAPS
     C                   IF        XN51 < XN56
     C                   MOVEA     '&apos;'      XT802(XN52)
     C                   ADD       5             XN52
     C                   ELSE
     C                   SUB       1             XN52
     C                   END
     C                   WHEN      XT801(XN51) = '>'
     C                   IF        XN51 < XN54
     C                   MOVEA     '&gt;'        XT802(XN52)
     C                   ADD       3             XN52
     C                   ELSE
     C                   SUB       1             XN52
     C                   END
     C                   WHEN      XT801(XN51) = '<'
     C                   IF        XN51 < XN54
     C                   MOVEA     '&lt;'        XT802(XN52)
     C                   ADD       3             XN52
     C                   ELSE
     C                   SUB       1             XN52
     C                   END
     C                   ENDSL
     C                   END
     C                   ELSE
     C                   IF        XN52 < XN53
     C                   ADD       1             XN52
     C                   MOVE      XT801(XN51)   XT802(XN52)
     C                   ELSE
     C                   LEAVE
     C                   END
     C                   END
     C                   ENDDO
      *
     C                   ENDSR
      *
      ***********************************************
     C     INIT          BEGSR
      ***********************************************
     C     XMLUFL1K      KLIST
     C                   KFLD                    XXST
     C                   KFLD                    FIFIRM
     C                   KFLD                    XXTYPE
     C     ECMSGK        KLIST
     C                   KFLD                    FIFIRM
     C                   KFLD                    XXKN
     C                   KFLD                    ECSR
     C                   KFLD                    EC0065
     C     HEADFK        KLIST
     C                   KFLD                    FIAVD
     C                   KFLD                    FIOPD
N10  C     DOKUFK        KLIST
N10  C                   KFLD                    DFRI
N10  C                   KFLD                    HEAVD
N10  C                   KFLD                    HEOPD
N10  C     TRACKTK       KLIST
N10  C                   KFLD                    HEAVD
N10  C                   KFLD                    HEOPD
     C     FAK8K         KLIST
     C                   KFLD                    FIAVD
     C                   KFLD                    FIOPD
     C                   KFLD                    FIFN
     C     FAKTXTK       KLIST
     C                   KFLD                    FAAVD
     C                   KFLD                    FAOPD
     C                   KFLD                    FALI
     C     KODWL01K      KLIST
     C                   KFLD                    FIFIRM
     C                   KFLD                    MOMSTW
     C                   KFLD                    FAKDM
     C     KODTAK        KLIST
     C                   KFLD                    KOAUNI
     C                   KFLD                    FIAVD
     C     KODTAKX       KLIST
     C                   KFLD                    KOAUNI
     C                   KFLD                    XFAVD
     C     KODTGEK       KLIST
     C                   KFLD                    KGEUNI
     C                   KFLD                    FAVK
     C     KODTG2K       KLIST
     C                   KFLD                    KG2UNI
     C                   KFLD                    FAVK
     C     KODTFRK       KLIST
     C                   KFLD                    KFRUNI
     C                   KFLD                    HEFR
     C     KODTOTYK      KLIST
     C                   KFLD                    KO1UNI
     C                   KFLD                    HEOT
N29  C     STED2DK1      KLIST
N29  C                   KFLD                    HELKS
N29  C                   KFLD                    HESDF
N29  C     STED2DK2      KLIST
N29  C                   KFLD                    HELKK
N29  C                   KFLD                    HESDT
N21  C     VALUL01K      KLIST
N21  C                   KFLD                    FIFIRM
S27  C*                  KFLD                    FAVAL
N27  C                   KFLD                    XFVAL
     C     CUNDL01K      KLIST
     C                   KFLD                    FIFIRM
     C                   KFLD                    KUNDNR
     C     FREETK        KLIST
     C                   KFLD                    HEAVD
     C                   KFLD                    HEOPD
     C                   KFLD                    FASK
     C                   KFLD                    FIFN
     C     FRISOKK       KLIST
     C                   KFLD                    HEAVD
     C                   KFLD                    HEOPD
     C                   KFLD                    XFSKODE           3
     C     ARKIVL02K     KLIST
     C                   KFLD                    ARSTAT
     C                   KFLD                    FIAVD
     C                   KFLD                    FIOPD
N04  C*                  KFLD                    ARTYPE
N04  C*                  KFLD                    ARUNDE
N04  C     ARKVEDKK      KLIST
N04  C                   KFLD                    FIFIRM
N04  C                   KFLD                    XXKN
S17  C*                  KFLD                    AVTYPE
N17  C                   KFLD                    X_AVTYPE
     C     ARKLAGK       KLIST
     C                   KFLD                    FIFIRM
     C                   KFLD                    ARKLAG
      *
     C     *LOVAL        SETLL     FIRM
     C                   READ      FIRM                                   33
      *
     C     *LIKE         DEFINE    SSN           XSSN
     C     *LIKE         DEFINE    SSN           XSSNVEDL
N17  C     *LIKE         DEFINE    AVTYPE        X_AVTYPE
N10  C                   MOVE      'J'           XTRDETAILS        1
     C                   Z-ADD     0             ØX                2 0
     C                   MOVE      *BLANKS       ØAN              12
     C                   MOVE      *ZEROS        XXBEL            13 2
     C                   MOVE      *ZEROS        XXMVA            13 2
     C                   MOVE      *BLANKS       XAN13BLANK       13
     C                   MOVE      ' '           XXST              1
     C                   MOVE      'E2B  '       XXTYPE            5
N10  C                   MOVE      'F'           DFRI
     C                   MOVE      'A'           KOAUNI
     C                   MOVEL     'GE'          KGEUNI
     C                   MOVEL     'G2'          KG2UNI
     C                   MOVEL     'FR'          KFRUNI
     C                   MOVEL     'OTY'         KO1UNI
     C                   MOVE      'PO '         XFSKODE
     C                   MOVE      'A'           ARSTAT
     C                   MOVEL     'S'           ECSR
     C                   MOVEL     'INVXML'      EC0065
     C                   MOVE      '/'           XXSTREKK1
     C                   MOVE      '/'           XXSTREKK2
     C                   MOVE      *BLANKS       UFIL             70
     C                   MOVE      *BLANKS       UKAT             70
     C                   BITON     '123457'      XAPS              1
     C                   BITOFF    '06'          XAPS
N19  C                   MOVE      *BLANKS       SDATA          1024
      *
     C                   ENDSR
      *
** TXT
<?xml version="1.0" encoding="ISO-8859-1"?>                                     001
<Interchange xmlns="http://www.e2b.no/XMLSchema"                                002
xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"                           003
xsi:schemaLocation="http://www.e2b.no/XMLSchema e2b_Invoice_Interchange_V3p2.xsd004
">                                                                              005
</Interchange>                                                                  006
<Envelope>                                                                      007
</Envelope>                                                                     008
<InterchangeId>                                                                 009
</InterchangeId>                                                                010
<From>                                                                          011
</From>                                                                         012
<To>                                                                            013
</To>                                                                           014
<Date>                                                                          015
</Date>                                                                         016
<Time>                                                                          017
</Time>                                                                         018
<Invoice                                                                        019
</Invoice>                                                                      020
<MessageNumber>                                                                 021
</MessageNumber>                                                                022
<MessageTimestamp>                                                              023
</MessageTimestamp>                                                             024
<NumberOfLines>                                                                 025
</NumberOfLines>                                                                026
<InvoiceHeader>                                                                 027
</InvoiceHeader>                                                                028
<InvoiceType codetext="Invoice">                                                029
</InvoiceType>                                                                  030
<InvoiceStatus codetext="Original">                                             031
</InvoiceStatus>                                                                032
<InvoiceNumber>                                                                 033
</InvoiceNumber>                                                                034
<InvoiceDate>                                                                   035
</InvoiceDate>                                                                  036
<Supplier>                                                                      037
</Supplier>                                                                     038
<PartyId>                                                                       039
</PartyId>                                                                      040
<LocationId>                                                                    041
</LocationId>                                                                   042
<Name>                                                                          043
</Name>                                                                         044
<ContactInformation>                                                            045
</ContactInformation>                                                           046
<PhoneNumber>                                                                   047
</PhoneNumber>                                                                  048
<FaxNumber>                                                                     049
</FaxNumber>                                                                    050
<EmailAddress>                                                                  051
</EmailAddress>                                                                 052
<WebAddress>                                                                    053
</WebAddress>                                                                   054
<StreetAddress>                                                                 055
</StreetAddress>                                                                056
<Address1>                                                                      057
</Address1>                                                                     058
<Address2>                                                                      059
</Address2>                                                                     060
<Address3>                                                                      061
</Address3>                                                                     062
<PostalCode>                                                                    063
</PostalCode>                                                                   064
<PostalDistrict>                                                                065
</PostalDistrict>                                                               066
<CountryCode>                                                                   067
</CountryCode>                                                                  068
<PostalAddress>                                                                 069
</PostalAddress>                                                                070
<ContactPerson>                                                                 071
</ContactPerson>                                                                072
<Name>                                                                          073
</Name>                                                                         074
<Function>                                                                      075
</Function>                                                                     076
<Department>                                                                    077
</Department>                                                                   078
<OrgNumber>                                                                     079
</OrgNumber>                                                                    080
<VatId>                                                                         081
</VatId>                                                                        082
<AccountInformation>                                                            083
</AccountInformation>                                                           084
<AccountNumber>                                                                 085
</AccountNumber>                                                                086
<ProjectRef>                                                                    087
</ProjectRef>                                                                   088
<Buyer>                                                                         089
</Buyer>                                                                        090
<Invoicee>                                                                      091
</Invoicee>                                                                     092
<DeliveryPart>                                                                  093
</DeliveryPart>                                                                 094
<InvoiceReferences>                                                             095
</InvoiceReferences>                                                            096
<BuyersOrderNumber>                                                             097
</BuyersOrderNumber>                                                            098
<BuyersOrderDate>                                                               099
</BuyersOrderDate>                                                              100
<SuppliersOrderNumber>                                                          101
</SuppliersOrderNumber>                                                         102
<DeliveryTerms>                                                                 103
</DeliveryTerms>                                                                104
<DeliveryTermsCode>                                                             105
</DeliveryTermsCode>                                                            106
<DeliveryTermsPlace>                                                            107
</DeliveryTermsPlace>                                                           108
<DeliveryNoteNumber>                                                            109
</DeliveryNoteNumber>                                                           110
<DeliveryDate>                                                                  111
</DeliveryDate>                                                                 112
<Payment>                                                                       113
</Payment>                                                                      114
<DueDate>                                                                       115
</DueDate>                                                                      116
<Currency>                                                                      117
</Currency>                                                                     118
<KidNumber>                                                                     119
</KidNumber>                                                                    120
<Attachment>                                                                    121
</Attachment>                                                                   122
<InvoiceDetails>                                                                123
</InvoiceDetails>                                                               124
<FreeText>                                                                      125
</FreeText>                                                                     126
<BaseItemDetails>                                                               127
</BaseItemDetails>                                                              128
<SubInvoice>                                                                    129
</SubInvoice>                                                                   130
<LineItemNum>                                                                   131
</LineItemNum>                                                                  132
<Description>                                                                   133
</Description>                                                                  134
<UnitPrice>                                                                     135
</UnitPrice>                                                                    136
<PriceType>                                                                     137
</PriceType>                                                                    138
<LineItemAmount>                                                                139
</LineItemAmount>                                                               140
<QuantityInvoiced>                                                              141
</QuantityInvoiced>                                                             142
<UnitOfMeasure>                                                                 143
</UnitOfMeasure>                                                                144
<VatInfo>                                                                       145
</VatInfo>                                                                      146
<VatPercent>                                                                    147
</VatPercent>                                                                   148
<VatBaseAmount>                                                                 149
</VatBaseAmount>                                                                150
<VatAmount>                                                                     151
</VatAmount>                                                                    152
<InvoiceSummary>                                                                153
</InvoiceSummary>                                                               154
<InvoiceTotals>                                                                 155
</InvoiceTotals>                                                                156
<GrossAmount>                                                                   157
</GrossAmount>                                                                  158
<VatTotalsAmount>                                                               159
</VatTotalsAmount>                                                              160
<NetAmount>                                                                     161
</NetAmount>                                                                    162
<NumberOfMessages>                                                              163
</NumberOfMessages>                                                             164
<Attachments>                                                                   165
</Attachments>                                                                  166
<Header>                                                                        167
</Header>                                                                       168
<Details>                                                                       169
</Details>                                                                      170
<Level>                                                                         171
</Level>                                                                        172
<Ref>                                                                           173
</Ref>                                                                          174
<Code>                                                                          175
</Code>                                                                         176
<Text>                                                                          177
</Text>                                                                         178
<?xml version="1.0" encoding="UTF-8"?>                                          179
