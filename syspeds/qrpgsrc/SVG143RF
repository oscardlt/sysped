     fedim      if   e           k disk
     feerc96b   if   e           k disk
     feerp96b   if   e           k disk
     fsvterr    if   e           k disk
     fsvih      uf   e           k disk
     fsveh      uf   e           k disk
     fsviv      uf   e           k disk
     fsvev      uf   e           k disk
     fsvihh     o  a e             disk
     fsvehh     o  a e             disk
N01  ftvinf     o  a e             disk
     d a               s              1    dim(79)
     d b               s              1    dim(18)
     ‚*________________________
     ‚* DS for decimal handling
     ‚*""""""""""""""""""""""""
     d                 ds
     d wmn2                           9  0
     ‚*  Prototype for svg143rf
     d svg143rf        pr
     d wmn1_                               like(wmn1)
     ‚*  Prototype for 'SVI012R'
     d svi012r         pr                  extpgm('SVI012R')
     d svih_syav_                          like(svih_syav)
     d svih_syop_                          like(svih_syop)
     d svihh_dth_                          like(svihh_dth)
     d svihh_tmh_                          like(svihh_tmh)
     ‚*  Prototype for 'SVE012R'
     d sve012r         pr                  extpgm('SVE012R')
     d sveh_syav_                          like(sveh_syav)
     d sveh_syop_                          like(sveh_syop)
     d svehh_dth_                          like(svehh_dth)
     d svehh_tmh_                          like(svehh_tmh)
     ‚*  *ENTRY Interface for Main Procedure
     d svg143rf        pi
     d wmn1                           9
     ‚*----------------------------------------------------------------------
     ‚* Stand Alone Fields - TOP
     ‚*----------------------------------------------------------------------
     d m0062b          s              7
     d wver_kod        s                   like(sver_kod)
     d wvih_syav       s                   like(svih_syav)
     d wvih_syli       s                   like(sviv_syli)
     d wvih_syop       s                   like(svih_syop)
     d zgn0            s                   like(egn)
     d zgn1            s                   like(egn)
     d zmn             s                   like(emn)
     d zrepb0          s                   like(erep0)
     ‚*----------------------------------------------------------------------
     ‚* Stand Alone Fields - BOTTOM
     ‚*----------------------------------------------------------------------
     ‚*/////////////
     ‚* MAIN LOGIC /
     ‚*/////////////
     ‚*___________
     ‚* Initiering
     ‚*"""""""""""
      /free
       exsr init;
       //________
       // CONVERT
       //""""""""
       if *in51 = *off;
         exsr sra;
       endif;

       *inlr = *on;
       //////////////////////////////////////////////////////////////
       //                                                      INIT /
       //////////////////////////////////////////////////////////////
       begsr init;
      /end-free

     ‚* INIT WORKFIELDS

     c                   movel     wmn1          wmn2
      /free
         zmn = wmn2;
         // Definiere Nøkkler
      /end-free
     c     svih_key      klist
     c                   kfld                    wvih_syav
     c                   kfld                    wvih_syop
     ‚* Get msg and interchange values
      /free
         chain zmn edim;
         *in51 = not %found;

       endsr;
       //////////////////////////////////////////////////////////////
       // Vilken typ av svar ?                                  SRA /
       //////////////////////////////////////////////////////////////
       begsr sra;
         //_________________
         // Finnes ærendet ?
         //"""""""""""""""""
      /end-free
     c                   movel     m0062         wvih_syav
      /free
         %subst(m0062b:1:7) = %subst(m0062:5:7);
      /end-free
     c                   move      m0062b        wvih_syop
      /free
         chain(n) ( wvih_syav : wvih_syop ) svih;
         if %found;
           exsr srai;
         else;
           chain(n) ( wvih_syav : wvih_syop ) sveh;
           if %found;
             exsr srae;
           endif;
         endif;
       endsr;
       //////////////////////////////////////////////////////////////
       // Import                                               SRAI /
       //////////////////////////////////////////////////////////////
       begsr srai;
         //_______________________
         // Læs alla fel ERP + ERC
         //"""""""""""""""""""""""
         *in51 = *off;
         zgn0 = 4;
         setll ( zmn : zgn0 ) eerp96b;
         reade ( zmn : zgn0 ) eerp96b;
         *in51 = %eof;
         dow *in51 = *off;

           exsr erci;

           reade ( zmn : zgn0 ) eerp96b;
           *in51 = %eof;
      /end-free
     c  n51              enddo
     ‚*__________________
     ‚* Uppdatera ærendet
     ‚*""""""""""""""""""
      /free
         chain ( wvih_syav : wvih_syop ) svih;
         *in61 = not %found;
         if *in61 = *off;
           svih_syst='M';
           update svihr;
         endif;
         //__________________________________________
         // Skriv ut ærendet (felmeddelande lista A4)
         //""""""""""""""""""""""""""""""""""""""""""
         svi012r ( svih_syav : svih_syop :
         svihh_dth : svihh_tmh );

       endsr;
       //////////////////////////////////////////////////////////////
       // Export                                               SRAE /
       //////////////////////////////////////////////////////////////
       begsr srae;
         //_______________________
         // Læs alla fel ERP + ERC
         //"""""""""""""""""""""""
         *in51 = *off;
         zgn0 = 4;
         setll ( zmn : zgn0 ) eerp96b;
         reade ( zmn : zgn0 ) eerp96b;
         *in51 = %eof;
         dow *in51 = *off;

           exsr erce;

           reade ( zmn : zgn0 ) eerp96b;
           *in51 = %eof;
      /end-free
     c  n51              enddo
     ‚*__________________
     ‚* Uppdatera ærendet
     ‚*""""""""""""""""""
      /free
         chain ( wvih_syav : wvih_syop ) sveh;
         if %found;
           sveh_syst='M';
           update svehr;
         endif;
         //__________________________________________
         // Skriv ut ærendet (felmeddelande lista A4)
         //""""""""""""""""""""""""""""""""""""""""""
         sve012r ( sveh_syav : sveh_syop :
         svehh_dth : svehh_tmh );

       endsr;
       //////////////////////////////////////////////////////////////
       // Læs ERC - Felinformation Import                      ERCI /
       //////////////////////////////////////////////////////////////
       begsr erci;
         zrepb0 = erep0;
         zgn1 = 4;
         setll ( zmn : zgn1 : zrepb0 ) eerc96b;
         reade ( zmn : zgn1 : zrepb0 ) eerc96b;
         dow not %eof;

           // Skriv til historikfil
           clear svihhr;
           svihh_sya = svih_syav;
           svihh_syo = svih_syop;
           %subst(svihh_dth:1:8) = %editc(mdt:'X');
           svihh_tmh = %editc(mtm:'X');
           svihh_sr  = 'R';
           svihh_txh  = 'CUSRES-KV FEL';
           svihh_txh = %trimr(svihh_txh) + ' ' +
           e1049;
           svihh_txh = %trimr(svihh_txh) + ' ' +
           e1052;
           wver_kod = %trimr(e1131) + e9321;
           chain wver_kod svterr;
           *in53 = not %found;
      /end-free
     c     e1131         cat       e9321:0       svihh_tx1
      /free
           if *in53 = *off;
             svihh_tx1 = %trimr(svihh_tx1) + ' ' +
             sver_txt;
           endif;
           write svihhr;
N01        // Skriv til TVINF
N01        clear tvinff;
N01        fmn = zmn;
N01        fln = 1;
N01        f0078a = svihh_txh;
N01        f0078b = svihh_tx1;
N01        write tvinff;
           // Uppdatera varuposten med statuskod=M

           monitor;
             wvih_syli = %dec(e1052:5:0);
           on-error 105;
           endmon;

           if wvih_syli > 0;
             chain (wvih_syav : wvih_syop: wvih_syli) sviv;
             if %found;
               sviv_err='M';
               update svivr %fields(sviv_err);
             endif;
           endif;


             reade ( zmn : zgn1 : zrepb0 ) eerc96b;
           endif;
        enddo;

      /free
       endsr;
       //////////////////////////////////////////////////////////////
       // Læs ERC - Felinformation Export                      ERCE /
       //////////////////////////////////////////////////////////////
      /free
       begsr erce;
         zrepb0 = erep0;
         zgn1 = 4;
         setll ( zmn : zgn1 : zrepb0 ) eerc96b;
         reade ( zmn : zgn1 : zrepb0 ) eerc96b;
         dow not %eof;

           // Skriv til historikfil
           clear svehhr;
           svehh_sya = sveh_syav;
           svehh_syo = sveh_syop;
           %subst(svehh_dth:1:8) = %editc(mdt:'X');
           svehh_tmh = %editc(mtm:'X');
           svehh_sr  = 'R';
           svehh_txh  = 'CUSRES-KV FEL';
           svehh_txh = %trimr(svehh_txh) + ' ' +
           e1049;
           svehh_txh = %trimr(svehh_txh) + ' ' +
           e1052;
           wver_kod = %trimr(e1131) + e9321;
           chain wver_kod svterr;
      /free
           *in53 = not %found;
     c     e1131         cat       e9321:0       svehh_tx1
      /free
           if *in53 = *off;
             svehh_tx1 = %trimr(svehh_tx1) + ' ' +
             sver_txt;
           endif;
           write svehhr;
N01        // Skriv til TVINF
N01        clear tvinff;
N01        fmn = zmn;
N01        fln = 1;
N01        f0078a = svehh_txh;
N01        f0078b = svehh_tx1;
N01        write tvinff;
           // Uppdatera varuposten med statuskod=M

           monitor;
             wvih_syli = %dec(e1052:5:0);
           on-error 105;
           endmon;

           if wvih_syli > 0;
             chain (wvih_syav : wvih_syop: wvih_syli) svev;
             if %found;
               svev_err='M';
               update svevr %fields(svev_err);
             endif;
           endif;


             reade ( zmn : zgn1 : zrepb0 ) eerc96b;
           endif;
         enddo;

       endsr;
      /end-free
