      *********************************************************************
      *
CRTPG+*  CRTPGM SYSPED/TJETUR07B MODULE(*LIBL/TJETUR07B *LIBL/INCGI)
CRTPGM*        ACTGRP(*NEW) AUT(*USE)
      *
********************************************************************
      * RETTINGER I DETTE PROGRAM:
PTFnr:*Sek Sig Vers  Beskrivelse...........................
""""""*"""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""
11XXX * 01 JOV PTF11 utvide for å takle også oppdragsupload
11XXX * 02 JOV PTF11 HVIS ZP=POD - loggfør i T&T - kopier til moroppdrag (dersom VF)
11XXX * 03 JOV PTF11 BYTTER UT INTYERN MOVE MED CL - TILLAT LANGE FILNAVN
11XXX * 04 JOV PTF11 dato/tid ved ZP/POD - BringMetode for filflytt(nasprobl) - ACTGRP(*NEW)
      *********************************************************************
      /copy SYSPEDS/qrpgsrcpy,hspecs
      /copy SYSPEDS/qrpgsrcpy,hspecsbnd
      *********************************************************************
     FBRIDF     IF   E           K DISK    USROPN
     FFIRM      IF   E           K DISK    USROPN
     FFIRMARC   IF   E           K DISK    USROPN
     FARKTXT    IF   E           K DISK    USROPN
     FARKEXT    IF   E           K DISK    USROPN
     FARKIVP    O  A E             DISK    USROPN
N02  FHEADF     IF   E           K DISK    USROPN
      *--------------------------------------------------------------------
      * Variables common to all CGIs
      *--------------------------------------------------------------------
      /copy SYSPEDS/qrpgsrcpy,prototypeb
      /copy SYSPEDS/qrpgsrcpy,usec
      /copy SYSPEDS/qrpgsrcpy,variables3
      *
      * Varible for
     D WSUSER          S             10
     D WSTYPE          S              2
     D WSTUR           S              8
     D WBTUR           S              8S 0
N01  D WSAVD           S              7
N01  D WBAVD           S              7S 0
N01  D WSOPD           S              7
N01  D WBOPD           S              7S 0
N04  D WSDATE          S              8
N04  D WBDATE          S              8S 0
N04  D WSTIME          S              4
N04  D WBTIME          S              6S 0
     D WSDOKN          S            512A
     D FIL             S             40A
     D SUF             S             10A
     D JSONSTRING      S          32000
     D ERROR           S            150
     D CmdLine         S            512
     D CmdLen          S             15  5

      *get input-string
      /copy syspeds/qrpgsrcpy,prolog3

      * Parse input
     C                   EXSR      Parse
      * Open files etc
     C                   EXSR      INIT
      *
     C                   CALLP     gethtmlifs(
     C                             '/syspeddev/html/JSON.html':
     C                             '/CGITAG/')
     C                   CALLP     wrtsection('top')
      * Teste input og utfør
     C                   IF        ERROR=*BLANKS
     C                   EXSR      TEST
     C                   ENDIF

      * ............................................................................................
      * skriv JSON-Object start..(alltid '{' + x ant param. m/komma mellom (IKKE komma etter siste))
      * ............................................................................................
      *
      /free
        JSONSTRING='{'
        +'¬user¬ : ¬'+%trim(WSUSER)+'¬, '
        +'¬wstur¬ : ¬'+%trim(WSTUR)+'¬, '
        +'¬wsavd¬ : ¬'+%trim(WSAVD)+'¬, '
        +'¬wsopd¬ : ¬'+%trim(WSOPD)+'¬, '
        +'¬wsdokn¬ : ¬'+%trim(WSDOKN)+'¬, '
        +'¬errMsg¬ : ¬'+%trim(ERROR)+'¬, ';
      /end-free
      * JSONfix escaper " i tekst,  for deretter å bytte ¬->"
     C                   CALL      'JSONFIX'
     C                   PARM                    JSONSTRING
     C                   CALLP     updHTMLvar('JSONSTRING':JSONSTRING)
     C                   CALLP     wrtsection('JSONlin')
      *
      * ............................................................................................
      * Skriv JSON-LISTE Start (en liste er EN parameter(fra [ til   )
      * ............................................................................................
     C                   EVAL      JSONSTRING ='"movupload" : ['
     C                   CALLP     updHTMLvar('JSONSTRING':JSONSTRING)
     C                   CALLP     wrtsection('JSONlin')
      * ............................................................................................
      * Skriv JSON-Liste/Array  Avslutning
      * ............................................................................................
     C                   EVAL      JSONSTRING =']'
     C                   CALLP     updHTMLvar('JSONSTRING':JSONSTRING)
     C                   CALLP     wrtsection('JSONlin')
      * ............................................................................................
      * Skriv JSON-string Avsluttning
      * ............................................................................................
     C                   EVAL      JSONSTRING ='}'
     C                   CALLP     updHTMLvar('JSONSTRING':JSONSTRING)
     C                   CALLP     wrtsection('JSONlin')

      * Quit
     C                   EXSR      Exit
      *=====================================================================
      * Close output html and quit
      *=====================================================================
     C     Exit          BEGSR
      * Lukk fil
     C                   CLOSE     BRIDF
     C  N50              CLOSE     FIRM
     C  N50              CLOSE     FIRMARC
     C  N50              CLOSE     ARKTXT
     C  N50              CLOSE     ARKEXT
     C  N50              CLOSE     ARKIVP
N02  C  N50              CLOSE     HEADF

      * Do not delete the CALL to wrtsection with section name *fini.  It is needed
      * to ensure that all output html that has been buffered gets output.
     C                   CALLP     wrtsection('*fini')
      * Quit
     C                   MOVE      *ON           *INLR
     C                   RETURN
     C                   ENDSR
      *
      *********************************************************
     C     Parse         BEGSR
      *********************************************************
      * Get input
     C                   EVAL      WSUSER  = zhbgetvar('USER')
N01  C                   EVAL      WSTYPE  = zhbgetvar('WSTYPE')
N01  C                   IF        WSTYPE = *BLANKS
N01  C                   EVAL      WSTYPE = 'ZO'
N01  C                   ENDIF
     C                   EVAL      WSTUR  = zhbgetvar('WSTUR')
     C                   EVAL      WBTUR  = c2n2(WSTUR)
N01  C                   EVAL      WSAVD  = zhbgetvar('WSAVD')
N01  C                   EVAL      WBAVD  = c2n2(WSAVD)
N01  C                   EVAL      WSOPD  = zhbgetvar('WSOPD')
N01  C                   EVAL      WBOPD  = c2n2(WSOPD)
     C                   EVAL      WSDOKN  = zhbgetvar('WSDOKN')
N04  C                   EVAL      WSDATE = zhbgetvar('WSDATE')
N04  C                   EVAL      WBDATE = c2n2(WSDATE)
N04  C                   EVAL      WSTIME = zhbgetvar('WSTIME')
N04  C                   EVAL      WBTIME = c2n2(WSTIME)*100
     C                   ENDSR
      *********************************************************
     C     INIT          BEGSR
      *********************************************************
     C                   OPEN      BRIDF
      * Test innlogging
     C     WSUSER        CHAIN     BRIDF                              50
     C     BILIBL        IFEQ      *blanks
     C                   CALLB     'INCGI'
     C                   PARM                    BISTDL
     C                   else
     C                   CALL      BILIBL
     C                   end

     C     ARKLAGK       KLIST
     C                   KFLD                    FIFIRM
     C                   KFLD                    ARKLAG

N02  C     HeaKey        KLIST
N02  C                   KFLD                    ARAVD
N02  C                   KFLD                    AROPD

     C     Qcmdexc       PLIST
     C                   PARM                    CmdLine
     C                   PARM                    Cmdlen

     C   50              EVAL      ERROR = 'Invalid userID'
     C  N50              OPEN      FIRM
     C  N50              OPEN      FIRMARC
     C  N50              OPEN      ARKTXT
     C  N50              OPEN      ARKEXT
     C  N50              OPEN      ARKIVP
N02  C  N50              OPEN      HEADF
     C                   IF        *IN50=*OFF
     C     *LOVAL        SETLL     FIRM
     C                   READ      FIRM                                   33
S01  C*    'ZO'          CHAIN     ARKTXT                             33
N01  C     WSTYPE        CHAIN     ARKTXT                             33
     C                   IF        ARKLAG = *BLANKS
     C     FIFIRM        CHAIN     FIRMARC                            33
     C                   ELSE
     C     ARKLAGK       CHAIN     ARKEXT                             33
     C                   ENDIF
     C                   IF        *IN33
     C                   EVAL      *IN50=*ON
     C   50              EVAL      ERROR = 'Company record not found'
     C                   ENDIF
     C                   ENDIF
      * hent tid
     C                   CALL      'SYGE15C'
     C                   PARM                    WDT               8
     C                   PARM                    WTM               6

     C                   ENDSR
      *______________________________________________________
      * TEST                                             TEST
      *""""""""""""""""""""""""""""""""""""""""""""""""""""""
     C     TEST          BEGSR
      * Extraher filnavn uten katalogsti
     C                   EXSR      FINNFIL
      * Extraher suffix
     C                   EXSR      FINNSUFF
      * Hent random nummer
     C                   CALL      'ARCRAN'
     C                   PARM                    NEWRAN           10
      * Init av arkivpost
     C                   CLEAR                   ARKIVR
     C                   MOVE      'A'           ARSTAT
S01  C*                  EVAL      ARTYPE = 'ZO'
N01  C                   EVAL      ARTYPE = WSTYPE
     C                   EVAL      ARFIRM = BIFIRM
     C                   EVAL      ARUSER = WSUSER
     C                   MOVE      WDT           ARDATE
     C                   MOVE      WTM           ARTIME
S01  C*                  EVAL      ARLINK = 'ZO'
N01  C                   EVAL      ARLINK = WSTYPE
     C                   MOVEL     WDT           XAN04             4
     C                   CAT       XAN04:0       ARLINK
N01  c     WBOPD         IFNE      *ZEROS
N01  C                   MOVE      WBAVD         ARAVD
N01  C                   MOVE      WBOPD         AROPD
N01  C                   CAT       WSAVD:0       ARLINK
N01  C                   CAT       WSOPD:0       ARLINK
N01  C                   ELSE
     C                   MOVE      *ZEROS        ARAVD
     C                   MOVE      *ZEROS        AROPD
     C                   MOVEL     'T:'          ARUNDE
     C                   MOVE      WSTUR         ARUNDE
     C*                  MOVE      WSTUR         XAN08             8
     C*                  CAT       XAN08:0       ARLINK
N01  C                   CAT       WSTUR:0       ARLINK
N01  C                   ENDIF
     C                   CAT       NEWRAN:0      ARLINK
     C     SUF           IFNE      *BLANKS
     C                   CAT       '.':0         ARLINK
     C                   CAT       SUF:0         ARLINK
     C                   ENDIF
     C                   EVAL      ARRFK = FIL
     C                   WRITE     ARKIVR
N02   *
N02   * Hvis ZP = POD - loggfør i T&T  - kopier også til moroppdrag dersom utkjøring
N02  c                   IF        ARTYPE = 'ZP'
N02   * bør pgså ta hensyn til om det er tidsoppfølging/avvikende kode mm (se ARCA003R..)
N02  C                   MOVE      ' '           TidsOppf
N02  c                   move      'POD'         TTACTI
N02  C                   MOVE      *BLANKS       TTEDRE
N04  C                   IF        WBDATE <> *ZEROS
N04  C                   eval      ARDATE = WBDATE
N04  C                   eval      ARTIME = WBTIME
N04  C                   ENDIF
N02  C                   call      'ARCAPOD'
N02  C                   parm                    ARAVD
N02  C                   parm                    AROPD
N02  C                   parm                    ARDATE
N02  C                   parm                    ARTIME
N02  C                   parm                    ARUSER
N02  C                   parm                    TTACTI            3
N02  C                   parm                    TTEDRE            3
N02  C                   parm                    TidsOppf          1
N02   * Oppdater med kopi av POD på OVERORDNET - dersom dette er utkjøringsoppdrag
N02  C                   MOVE      'KOP'         TTEDRE
N02  c     Heakey        chain     Headf                              33
N02  c     *in33         ifeq      *off
N02  c     TRSLAG        andeq     'VF'
N02  c     TROPD0        andne     *zeros
N02  C                   Movel     TRAVD0        ARAVD
N02  C                   Move      TROPD0        AROPD
N02  C                   WRITE     ARKIVR
N02  C                   call      'ARCAPOD'
N02  C                   parm                    ARAVD
N02  C                   parm                    AROPD
N02  C                   parm                    ARDATE
N02  C                   parm                    ARTIME
N02  C                   parm                    ARUSER
N02  C                   parm                    TTACTI            3
N02  C                   parm                    TTEDRE            3
N02  C                   parm                    TidsOppf          1
N02  C                   endif
N02  c                   ENDIF
      *
      * Flytt fil fra tmp til prod
     C                   EXSR      MOVFIL
      *
     C                   ENDSR
      *______________________________________________________
      * FINNFIL                                       FINNFIL
      *""""""""""""""""""""""""""""""""""""""""""""""""""""""
     C     FINNFIL       BEGSR
     C                   Z-ADD     1             X                 3 0
     C     NEXT          TAG
     C     '/'           SCAN      WSDOKN:X      Y                 3 0    33
     C   33Y             ADD       1             X
     C   33              GOTO      NEXT
     C                   EVAL      FIL = %SUBST(WSDOKN:X)
     C                   ENDSR
      *______________________________________________________
      * FINNSUFF                                     FINNSUFF
      *""""""""""""""""""""""""""""""""""""""""""""""""""""""
     C     FINNSUFF      BEGSR
     C                   EVAL      X=*ZEROS
     C     '.'           SCAN      WSDOKN:1      X                        33
     C   33              ADD       1             X
     C                   EVAL      SUF = %SUBST(WSDOKN:X)
     C                   ENDSR
      *______________________________________________________
      * MOVFIL                                         MOVFIL
      *""""""""""""""""""""""""""""""""""""""""""""""""""""""
     C     MOVFIL        BEGSR
      * Katalogstien for tmp ligger i variabel WSDOKN
      * Flytt
S04   * (kun merkingen ny i PTF 4 - var tatt inn i 26.11.2015  )
S04  C*                  BITON     '123457'      XAPS              1
S04  C*                  BITOFF    '06'          XAPS
S04  C*                  EVAL      CmdLine = 'MOV OBJ(' + XAPS
S04  C*                            + %TRIM(WSDOKN) + XAPS
S04  C*                            + ') TOOBJ(' + XAPS
S04  C*                            + '/' + %TRIM(ARCANE)
S04  C*                            + '/' + %TRIM(ARLINK) + XAPS + ')'
S04  C*                            + ' FROMCCSID(*JOBCCSID) TOCCSID(*JOBCCSID)'
S04  C*                  EVAL      CmdLen = %len(%trim(CmdLine))
S04  C*                  CALL      'QCMDEXC'     Qcmdexc                33
S04  C*
n04  C                   MOVE      'J'           OkMov             1
n04  C                   MOVEl     WSDOKN        FRA             512
n04  C                   MOVE      *BLANKS       Til             512
n04  C                   EVAL      TIL = '/'+%TRIM(ARCANE)+'/'+ %TRIM(ARLINK)
n04  C                   CALL      'ARCAMOVCT'
n04  C                   PARM                    FRA
n04  C                   PARM                    TIL
n04  C                   PARM                    OkMov
     C                   ENDSR
