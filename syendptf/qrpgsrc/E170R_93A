OBS!! * OBS HARKODET!!!!!   - søk etter obs 1 pos 1.
OBS!! *      (TOL / MVA ) Leverandørnummer, Bilagskode, Skal inntekstlinjer skapes
********************************************************************
      * RETTINGER I DETTE PROGRAM:
PTFnr:*Sek Sig Vers  Beskrivelse...........................
""""""*"""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""
10XXX * 01 YBC PTF10 NEGATIVT BELØP
10XXX * 02 SH  PTF10 FEIL OMREGNINGSFAKTOR
10XXX * 03 YBC PTF10 ARKIVER UTSKRIFT
10XXX * 04 YBC PTF10 IKKE SUMMERE SLETTET FAKTURALINJER
10XXX * 05 YBC PTF10 IKKE SKRIV UT HVIS UTKØ IKKE ER DEFINERT
10XXX * 06 YBC PTF10 NEGATIVT BELØP PÅ UTSKRIFT, OPPDATERING PÅ KOSTB
10XXX * 07 YBC PTF10 SNU FORTEGN VED UTSKRIFT AV TOTALSUM
10XXX * 08 SH  PTF10 SPESIAL FORENKLET PROSEDYRE
10XXX * 09 SH  PTF10 ekspedisjonssted og løpenummer til KBBILT
10XXX * 10 SH  PTF10 hvis headfpost mangler skriv 9 i kbnØkk = feil
10XXX * 11 SH  PTF10 liten korreksjon til
10XXX * 12 SH  PTF10 ny kbøkk stopp
10XXX * 13 SH  PTF10 legger nad du i fritekst på kostb
10XXX * 14 SH  PTF10 Attestasjonskode er nå fleksibel
10XXX * 15 SH  PTF10 PERIODE FLEKSIBILITET
10XXX * 16 SH  PTF10 summerer fasum og diff
10XXX * 17 SH  PTF10 kolonnelinje toll på faktura
10XXX * 18 SH  PTF10 STJERNE VED UFAKTURERT
10XXX * 19 SH  PTF10 logger dato tid i kosta
10XXX * 20 YBC PTF10 BLANK FELTER NÅR OPPDRAG IKKE FINNES
10XXX * 21 SH  PTF10 flyttet litt på stjernen ved ufakturert
      *------------------------------------------------------
11XXX * 22 SH  PTF11 ptf 08 tatt bort da fortollet ikke er på undeoppdrag
11XXX * 23 SH  PTF11 fordeler ved forenklet prosedyre
11XXX * 24 SH  PTF11 stjerne flyttet igjen
11XXX * 25 SH  PTF11 endret fordeling av FP
11XXX * 26 SH  PTF11 restbeløp skal ha kode 9
11XXX * 27 SH  PTF11 omberegning negativt oppdragsnummer
11XXX * 28 SH  PTF11 tatt bort ptf 25
11XXX * 29 SH  PTF11 omberegning negativt oppdragsnummer
11XXX * 30 SH  PTF12 28 delvis tatt inn igjen
********************************************************************
     H DATEDIT(*YMD)
     FFPXREF    IF   E           K DISK
n23  F                                     RENAME(FPXREFR:FPXREF0)
n23  FFPXREF1   IF   E           K DISK
n23  FSADH      IF   E           K DISK
n23  F                                     RENAME(SADHR:SADHRX)
     FFIRM      IF   E           K DISK
     FFIRMDAG   IF   E           K DISK
N03  FFIRMARC   IF   E           K DISK
N03  FARKIVP    O  A E             DISK
N03  FARKTXT    IF   E           K DISK
N03  FARKEXT    IF   E           K DISK
     FEUNH      IF   E           K DISK
     FEDIM      UF   E           K DISK
     FECOM93A   IF   E           K DISK
     FEDTM93A   IF   E           K DISK
     FEFII93A   IF   E           K DISK
     FELIN93A   IF   E           K DISK
     FEMOA93A   IF   E           K DISK
     FENAD93A   IF   E           K DISK
     FERFF93A   IF   E           K DISK
     FSADH12B   IF   E           K DISK
     FSAEH12B   IF   E           K DISK
     FHEADF     IF   E           K DISK
     FFAKT      IF   E           K DISK
     FFRISOK    IF A E           K DISK
     FKOSTT     UF   E           K DISK
     FKOSTA     O  A E             DISK
     FKOSTB     O  A E             DISK
N03  FE170PAARK O    E             PRINTER OFLIND(*IN37)
N03  F                                     RENAME(E170PA1:E170PA1A)
N03  F                                     RENAME(E170PA2:E170PA2A)
N03  F                                     RENAME(E170PA3:E170PA3A)
N03  FE170PBARK O    E             PRINTER OFLIND(*IN38)
N03  F                                     RENAME(E170PB1:E170PB1A)
N03  F                                     RENAME(E170PB2:E170PB2A)
N03  F                                     RENAME(E170PB3:E170PB3A)
     FE170PA    O    E             PRINTER OFLIND(*IN27)
     FE170PB    O    E             PRINTER OFLIND(*IN28)
     FE170F     IF A E           K DISK
     D A               S              1    DIM(79)
     D B               S              1    DIM(18)
N03  D                SDS
N03  D  UUSR                 254    263
     D                 DS
     D  SIDT                   1      8  0
     D  SIDTÅ                  3      4  0
     D  SIDTM                  5      6  0
     D  SIDTD                  7      8  0
     D                 DS
     D  KABDT                  1      8  0
     D  KABA                   3      4  0
     D  KABM                   5      6  0
     D  KABD                   7      8  0
     D                 DS
     D  KAFDT                  1      8  0
     D  KAFA                   1      4  0
     D  KAFM                   5      6  0
     D  KAFD                   7      8  0
     D                 DS
     D  XKAFDT                 1      8  0
     D  XKAFD                  1      2  0
     D  XKAFM                  3      4  0
     D  XKAFA                  5      8  0
     D                 DS
     D  KAFFDT                 1      8  0
     D  KAFFA                  1      4  0
     D  KAFFM                  5      6  0
     D  KAFFD                  7      8  0
     D                 DS
     D  XKAFFDT                1      8  0
     D  XKAFFD                 1      2  0
     D  XKAFFM                 3      4  0
     D  XKAFFA                 5      8  0
     D                 DS
     D  KABL                   1     13  2
     D  KABL1                  3     13  2
     D                 DS
     D  KBBLHB                 1     13  2
     D  KBBLHB1                3     13  2
      *________________________
      * DS for decimal handling
      *""""""""""""""""""""""""
     D                 DS
     D  ZDEC                   1      7  6
     D  ZDEC6                  2      7
     D  ZHEL                  11     22  0
     D                 DS
     D  R1154                  1     35
     D  R11540                 1     10
     D                 DS
     D  F1                     1     13    DIM(13)                              KAFNR I KOSTA
     D  KAFNR                  1     13
     D                 DS
     D  F2                     1     13    DIM(13)                              KRNR  I POSTB0
     D  KAFNRN                 1     13
N15  D                 DS
N15  D  HEDTOP                 1      8  0
N15  D  HEDTCC                 1      2  0
N15  D  HEDTAA                 3      4  0
N15  D  HEDTMM                 5      6  0
     D                 DS            10
     D DIGITS          C                   CONST('0123456789')
     IEDIMR
     I              MMN                         TVIMMN
      */////////////
      * MAIN LOGIC /
      */////////////
      *___________
      * Initiering
      *"""""""""""
     C                   EXSR      INIT
     C                   IF        *IN20 = *OFF
      *________
      * CONVERT
      *""""""""
     C                   EXSR      RTVD
      *___________
      * UPDATE LOG
      *"""""""""""
     C                   MOVE      'C'           MST
     C                   UPDATE    EDIMR
     C                   END
      *
     C                   SETON                                        LR
     C                   RETURN
      *
      *////////////////////////////////////////////////////////////
      *                                                      INIT /
      *////////////////////////////////////////////////////////////
     C     INIT          BEGSR
     C     KEYMS0        KLIST
     C                   KFLD                    ZMN
     C                   KFLD                    ZGN0
     C     KEYMS1        KLIST
     C                   KFLD                    ZMN
     C                   KFLD                    ZGN1
     C                   KFLD                    ZREPB0
     C     KEYMS2        KLIST
     C                   KFLD                    ZMN
     C                   KFLD                    ZGN2
     C                   KFLD                    ZREPC0
     C                   KFLD                    ZREPC1
     C     KEYMS3        KLIST
     C                   KFLD                    ZMN
     C                   KFLD                    ZGN3
     C                   KFLD                    ZREPD0
     C                   KFLD                    ZREPD1
     C                   KFLD                    ZREPD2
     C     KEYMS4        KLIST
     C                   KFLD                    ZMN
     C                   KFLD                    ZGN4
     C                   KFLD                    ZREPE0
     C                   KFLD                    ZREPE1
     C                   KFLD                    ZREPE2
     C                   KFLD                    ZREPE3
     C     KEYMS5        KLIST
     C                   KFLD                    ZMN
     C                   KFLD                    ZGN5
     C                   KFLD                    ZREPF0
     C                   KFLD                    ZREPF1
     C                   KFLD                    ZREPF2
     C                   KFLD                    ZREPF3
     C                   KFLD                    ZREPF4
     C     E170FK        KLIST
     C                   KFLD                    E170AR
     C                   KFLD                    E170FN
     C     SADH12BK      KLIST
     C                   KFLD                    SITLE
     C                   KFLD                    SITLL
     C     HEADFK        KLIST
     C                   KFLD                    KBAVD
     C                   KFLD                    KBOPD
     C     FRISOKK       KLIST
     C                   KFLD                    KBAVD
     C                   KFLD                    KBOPD
     C                   KFLD                    FSKODE
     C                   KFLD                    FSSOK
N03  C     ARKEXTK       KLIST
N03  C                   KFLD                    FIFIRM
N03  C                   KFLD                    ARKLAG
     C     FPKEY         KLIST
     C                   KFLD                    SIAVD
     C                   KFLD                    SITDN
n23  C     FPKEY1        KLIST
n23  C                   KFLD                    sta
n23  C                   KFLD                    KBAVD
n23  C                   KFLD                    KBOPD
n23  C     FPKEY2        KLIST
n23  C                   KFLD                    sta
n23  C                   KFLD                    FPAVDH
n23  C                   KFLD                    FPOPDH
n23  c                   move      'O'           sta               1
n23  C     FPKEYN        KLIST
n23  C                   KFLD                    FPAVD
n23  C                   KFLD                    FPOPD
     C     *LIKE         DEFINE    TVIMMN        ZMMN
     C     *LIKE         DEFINE    NMN           ZMN
     C     *LIKE         DEFINE    NGN           ZGN0
     C     *LIKE         DEFINE    NGN           ZGN1
     C     *LIKE         DEFINE    NGN           ZGN2
     C     *LIKE         DEFINE    NGN           ZGN3
     C     *LIKE         DEFINE    NGN           ZGN4
     C     *LIKE         DEFINE    NGN           ZGN5
     C     *LIKE         DEFINE    NREP0         ZREPB0
     C     *LIKE         DEFINE    NREP0         ZREPC0
     C     *LIKE         DEFINE    NREP1         ZREPC1
     C     *LIKE         DEFINE    NREP0         ZREPD0
     C     *LIKE         DEFINE    NREP1         ZREPD1
     C     *LIKE         DEFINE    NREP2         ZREPD2
     C     *LIKE         DEFINE    NREP0         ZREPE0
     C     *LIKE         DEFINE    NREP1         ZREPE1
     C     *LIKE         DEFINE    NREP2         ZREPE2
     C     *LIKE         DEFINE    NREP3         ZREPE3
     C     *LIKE         DEFINE    NREP0         ZREPF0
     C     *LIKE         DEFINE    NREP1         ZREPF1
     C     *LIKE         DEFINE    NREP2         ZREPF2
     C     *LIKE         DEFINE    NREP3         ZREPF3
     C     *LIKE         DEFINE    NREP4         ZREPF4
     C     *LIKE         DEFINE    NREP0         ZREPG0
     C     *LIKE         DEFINE    NREP1         ZREPG1
     C     *LIKE         DEFINE    NREP2         ZREPG2
     C     *LIKE         DEFINE    NREP3         ZREPG3
     C     *LIKE         DEFINE    NREP4         ZREPG4
     C     *LIKE         DEFINE    NREP5         ZREPG5
     C     *LIKE         DEFINE    NREP0         ZREPH0
     C     *LIKE         DEFINE    NREP1         ZREPH1
     C     *LIKE         DEFINE    NREP2         ZREPH2
     C     *LIKE         DEFINE    NREP3         ZREPH3
     C     *LIKE         DEFINE    NREP4         ZREPH4
     C     *LIKE         DEFINE    NREP5         ZREPH5
     C     *LIKE         DEFINE    NREP6         ZREPH6
     C     *LIKE         DEFINE    NREP0         ZREPI0
     C     *LIKE         DEFINE    NREP1         ZREPI1
     C     *LIKE         DEFINE    NREP2         ZREPI2
     C     *LIKE         DEFINE    NREP3         ZREPI3
     C     *LIKE         DEFINE    NREP4         ZREPI4
     C     *LIKE         DEFINE    NREP5         ZREPI5
     C     *LIKE         DEFINE    NREP6         ZREPI6
     C     *LIKE         DEFINE    NREP7         ZREPI7
     C     *LIKE         DEFINE    NREP0         ZREPJ0
     C     *LIKE         DEFINE    NREP1         ZREPJ1
     C     *LIKE         DEFINE    NREP2         ZREPJ2
     C     *LIKE         DEFINE    NREP3         ZREPJ3
     C     *LIKE         DEFINE    NREP4         ZREPJ4
     C     *LIKE         DEFINE    NREP5         ZREPJ5
     C     *LIKE         DEFINE    NREP6         ZREPJ6
     C     *LIKE         DEFINE    NREP7         ZREPJ7
     C     *LIKE         DEFINE    NREP8         ZREPJ8
     C                   MOVE      *ZEROS        SIDT
N15  C                   MOVE      *ZEROS        HEDTOP
      *
     C     *ENTRY        PLIST
     C                   PARM                    UMNA              9
N03  C                   PARM                    UINFOP            1
N03  C                   PARM                    UBANEA           70
N03  C                   PARM                    UBANEB           70
      *
     C                   MOVE      UMNA          E170MN
     C                   Z-ADD     E170MN        ZMN
     C     ZMN           CHAIN     EUNH                               20
     C  N20              Z-ADD     ZMN           ZMMN
     C  N20ZMMN          CHAIN     EDIM                               20
     C                   MOVE      '*TV'         FSKODE
      * DGFAKD  = 'N' --> IKKE LAGE KREDITT AV DIFF MELLOM INNTEKT OG KOSTNAD
     C*****              MOVE      'N'           DGFAKD            1
      *DELAY THIS JOB
     C*                  MOVEL(P)  'DLYJOB D'    QCMDR            15
     C*                  CAT       'LY(060':0    QCMDR
     C*                  CAT       ')':0         QCMDR
     C*                  Z-ADD     15            QCMDLE           15 5
     C*                  CALL      'QCMDEXC'                            3131
     C*                  PARM                    QCMDR
     C*                  PARM                    QCMDLE
      *
     c                   read      firm                                   33
     c     fifirm        chain     firmdag                            33
N03  C     FIFIRM        CHAIN     FIRMARC                            33
N03  C  N33              IF        ((DGDTDO <> *BLANKS) OR (DGDTKL <> *BLANKS))
N03   * DAGSOPPGJØR
N03  C                   IF        DGDTDO <> *BLANKS
N03  C                   MOVE      DGDTDO        XARTYPEDO         2
N03  C     XARTYPEDO     CHAIN     ARKTXT                             33
N03  C                   IF        ARKLAG <> *BLANKS
N03  C     ARKEXTK       CHAIN     ARKEXT                             33
N03  C                   END
N03  C                   MOVE      ARCANE        XARCANEDO        30
N03  C                   END
N03   * KONTROLLISTE
N03  C                   IF        DGDTKL <> *BLANKS
N03  C                   MOVE      DGDTKL        XARTYPEKL         2
N03  C     XARTYPEKL     CHAIN     ARKTXT                             33
N03  C                   IF        ARKLAG <> *BLANKS
N03  C     ARKEXTK       CHAIN     ARKEXT                             33
N03  C                   END
N03  C                   MOVE      ARCANE        XARCANEKL        30
N03  C                   END
N03   *
N03  C                   EVAL      UINFOP = ARCINF
N03  C                   EVAL      ARSTAT = 'A'
N03  C                   EVAL      ARFIRM = FIFIRM
N03  C                   EVAL      ARUNDE = 'KL:'
N03  C                   EVAL      ARUSER = UUSR
N03  C                   CALL      'SYGE15C'
N03  C                   PARM                    WDT               8
N03  C                   PARM                    WTM               6
N03  C                   MOVE      WDT           ARDATE
N03  C                   MOVE      WTM           ARTIME
N03  C                   END
N03   *
     C                   ENDSR
      *
      *////////////////////////////////////////////////////////////
      * RETREIVE INFO FROM EDIFACT DATABASE TO SYSPED400     RTVD /
      *////////////////////////////////////////////////////////////
     C     RTVD          BEGSR
      *___________________________
      * INIT AV FELT I PRINTERFILE
      *"""""""""""""""""""""""""""
     C                   CLEAR                   E170PA1
N03  C                   CLEAR                   E170PA1A
      *______________
      * INIT AV KOSTA
      *""""""""""""""
     C                   CLEAR                   KOSTAR
     C                   MOVE      'NOK'         KAVAL
     C                   Z-ADD     100           KAVKU
     C                   Z-ADD     100           KAOMRF
S02  C*                  MOVE      DGGEB1        KAOMRF
      * FAKTURANUMMER
     C                   MOVEL     U1004         E170FN
     C                   MOVEL     U1004         KAFNR
     C                   MOVEL     U1004         FSSOK
     C                   MOVE      *BLANKS       KAFNRN
     C                   Z-ADD     1             N1                2 0
     C                   Z-ADD     1             N2                2 0
     C     N1            DOWNE     13
     C     F1(N1)        IFNE      '0'
     C     KAFNRN        ORNE      *BLANKS
     C                   MOVE      F1(N1)        F2(N2)                          * F2=KRNR
     C                   ADD       1             N2
     C                   END
     C                   ADD       1             N1
     C                   END
     C                   MOVEL     KAFNRN        KAFNR
S14  C*                  MOVE      'EDI'         KASG
N14  C                   MOVE      DGATT         KASG
N19  c                   movel     dgatt         KAUSER
N19  c                   movel     WDT           KADTR
N19  c                   movel     WTM           KATDR
     C                   MOVE      'F'           KAMVA
     C                   MOVE      DGGEB1        KAVK
      *___________________
      * READ MAIN SEGMENTS
      *"""""""""""""""""""
      * DTM00
     C                   Z-ADD     0             KAFDT
     C                   Z-ADD     0             KAFFDT
     C                   Z-ADD     0             XKAFDT
     C                   Z-ADD     0             XKAFFDT
     C                   MOVE      '0'           *IN51
     C                   Z-ADD     0             ZGN0
     C     KEYMS0        SETLL     EDTM93A                                20
     C     *IN20         IFEQ      '1'
     C     KEYMS0        READE     EDTM93A                                51
     C     *IN51         DOWEQ     '0'
      *
     C                   MOVEA     D2380         A
     C                   EXSR      GETNUM
     C                   SELECT
     C     D2005         WHENEQ    '3  '                                        FAKTURADATO
     C                   Z-ADD     ZNUM          KAFDT
     C                   Z-ADD     ZNUM          KABDT
     C                   Z-ADD     20            KAPCC
     C                   Z-ADD     KABM          KAPMN
     C                   Z-ADD     KABA          KAPÅR
     C                   MOVEL     KAFDT         E170AR
     C     D2005         WHENEQ    '13 '                                        FORFALLSDATO
     C                   Z-ADD     ZNUM          KAFFDT
     C                   ENDSL
      *
     C     KEYMS0        READE     EDTM93A                                51
     C  N51              ENDDO
     C                   ENDIF
     C                   MOVE      KAFA          XKAFA
     C                   MOVE      KAFM          XKAFM
     C                   MOVE      KAFD          XKAFD
     C                   MOVE      KAFFA         XKAFFA
     C                   MOVE      KAFFM         XKAFFM
     C                   MOVE      KAFFD         XKAFFD
      * RFF01
     C                   MOVE      '0'           *IN51
     C                   Z-ADD     1             ZGN0
     C     KEYMS0        SETLL     ERFF93A                                20
     C     *IN20         IFEQ      '1'
     C     KEYMS0        READE     ERFF93A                                51
     C     *IN51         DOWEQ     '0'
      *
     C                   SELECT
     C     R1153         WHENEQ    'SS '
     C                   MOVEL     R1154         KALKID
     C                   ENDSL
      *
     C     KEYMS0        READE     ERFF93A                                51
     C  N51              ENDDO
     C                   ENDIF
      * NAD02
     C                   MOVE      '0'           *IN51
     C                   Z-ADD     2             ZGN0
     C     KEYMS0        SETLL     ENAD93A                                20
     C     *IN20         IFEQ      '1'
     C     KEYMS0        READE     ENAD93A                                51
     C     *IN51         DOWEQ     '0'
      *
     C                   SELECT
     C     N3035         WHENEQ    'SE '                                        AVSENDER
     C                   Z-ADD     DGLEVN        KALNR
     C                   MOVEL     N3039         XTRG
     C                   MOVEL     N3036A        XTNAVN
     C                   MOVEL     N3036B        XTADR1
     C                   MOVEL     N3042B        XTADR2
     C                   MOVEL     N3164         XTPS
     C                   MOVEA     N3251         A
     C                   EXSR      GETNUM
     C                   Z-ADD     ZNUM          XTPN
     C     N3035         WHENEQ    'BY '                                        AVSENDER
      *
     C                   MOVEL     N3039         XMRG
     C                   MOVEL     N3036A        XMNAVN
     C                   MOVEL     N3036B        XMADR1
     C                   MOVEL     N3042B        XMADR2
     C                   MOVEL     N3164         XMPS
     C                   MOVEA     N3251         A
     C                   EXSR      GETNUM
     C                   Z-ADD     ZNUM          XMPN
     C                   ENDSL
      *
     C     KEYMS0        READE     ENAD93A                                51
     C  N51              ENDDO
     C                   ENDIF
      *___________________
      * READ FII-SEGMENTS
      *"""""""""""""""""""
      * FII00
     C                   MOVE      '0'           *IN51
     C                   Z-ADD     2             ZGN0
     C     KEYMS0        SETLL     EFII93A                                20
     C     *IN20         IFEQ      '1'
     C     KEYMS0        READE     EFII93A                                51
     C     *IN51         DOWEQ     '0'
      *
     C                   SELECT
     C     F3035         WHENEQ    'BF '                                        BANKKONTONR
     C                   MOVEL     F3194         XTBANK
     C                   LEAVE
     C                   ENDSL
      *
     C     KEYMS0        READE     EFII93A                                51
     C  N51              ENDDO
     C                   ENDIF
      *___________________
      * READ COM-SEGMENTS
      *"""""""""""""""""""
      * COM00
     C                   MOVE      '0'           *IN51
     C                   Z-ADD     5             ZGN0
     C     KEYMS0        SETLL     ECOM93A                                20
     C     *IN20         IFEQ      '1'
     C     KEYMS0        READE     ECOM93A                                51
     C     *IN51         DOWEQ     '0'
      *
     C                   SELECT
     C     C3155         WHENEQ    'TE '                                        TELEFONNR
     C                   MOVEL     C3148         XTTLF
     C                   LEAVE
     C                   ENDSL
      *
     C     KEYMS0        READE     ECOM93A                                51
     C  N51              ENDDO
     C                   ENDIF
      * MOA45
     C                   MOVE      '0'           *IN51
     C                   Z-ADD     45            ZGN0
     C     KEYMS0        SETLL     EMOA93A                                20
     C     *IN20         IFEQ      '1'
     C     KEYMS0        READE     EMOA93A                                51
     C     *IN51         DOWEQ     '0'
      *
     C                   MOVEA     M5004         A
     C                   EXSR      GETNUM
     C                   SELECT
     C     M5025         WHENEQ    '9  '
     C                   Z-SUB     ZNUM          KABL
     C                   LEAVE
     C                   ENDSL
      *
     C     KEYMS0        READE     EMOA93A                                51
     C  N51              ENDDO
     C                   ENDIF
      * MOA47
     C                   Z-ADD     0             XTOTMV1
     C                   Z-ADD     0             XTOTMV2
     C                   MOVE      '0'           *IN51
     C                   Z-ADD     47            ZGN0
     C     KEYMS0        SETLL     EMOA93A                                20
     C     *IN20         IFEQ      '1'
     C     KEYMS0        READE     EMOA93A                                51
     C     *IN51         DOWEQ     '0'
      *
     C                   MOVEA     M5004         A
     C                   EXSR      GETNUM
     C                   SELECT
     C     M5025         WHENEQ    '124'
     C                   Z-ADD     ZNUM          XTOTMV1
     C                   Z-ADD     ZNUM          XTOTMV2
     C                   LEAVE
     C                   ENDSL
      *
     C     KEYMS0        READE     EMOA93A                                51
     C  N51              ENDDO
     C                   ENDIF
      *
      * SJEKK OM FAKTURA FINNES FRA FØR
     C     E170FK        CHAIN     E170F                              33
     C                   IF        *IN33
     C                   MOVE      *BLANKS       XKOPI
     C                   ELSE
     C                   MOVE      '(KOPI)'      XKOPI
     C                   END
      *___________
      * LAGE KOSTA
      *"""""""""""
     C                   IF        XKOPI <> '(KOPI)'
      *___________________
      * HENTE INNREGNR
      *"""""""""""""""""""
     C     'Ø'           CHAIN     KOSTT                              20
     C     *IN20         IFEQ      '0'
     C                   Z-ADD     KTNR          KABNR
     C                   Z-ADD     KTNR          E170BN
     C                   ADD       1             KTNR
     C                   UPDATE    KOSTTR
     C                   ENDIF
      *___________________
      * HENTE BILAGSNUMMER
      *"""""""""""""""""""
     C     DGSERI        CHAIN     KOSTT                              20
     C     *IN20         IFEQ      '0'
     C                   Z-ADD     KTNR          KABNR2
     C                   ADD       1             KTNR
     C                   UPDATE    KOSTTR
     C                   ENDIF
      *
     C                   WRITE     KOSTAR
     C                   ELSE
     C                   Z-ADD     E170BN        KABNR
     C                   Z-ADD     E170BN        E170BN
     C                   Z-ADD     0             KABNR2
     C                   END
     C                   WRITE     E170FR
      *______________________
      * SKRIV FAKTURA HEADING
      *""""""""""""""""""""""
     C                   Z-ADD     1             XSIDE
     C                   Z-ADD     1             XPAG1
     C                   Z-ADD     0             XLIN              2 0
N03  C                   IF        XARTYPEDO <> *BLANKS
N03  C                   WRITE     E170PA1A
N03  C                   END
N03  C                   IF        XARTYPEKL <> *BLANKS
N03  C                   WRITE     E170PB1A
N03  C                   END
N05  C                   IF        DGPRIN <> *BLANKS
     C                   WRITE     E170PA1
     C                   WRITE     E170PB1
N05  C                   END
      *_________
      * READ LIN
      *"""""""""
     C                   MOVE      '0'           *IN51
     C                   Z-ADD     22            ZGN0
     C     KEYMS0        SETLL     ELIN93A                                20
     C     *IN20         IFEQ      '1'
     C     KEYMS0        READE     ELIN93A                                51
     C     *IN51         DOWEQ     '0'
      *
     C                   EXSR      RTVDB
      *
     C     KEYMS0        READE     ELIN93A                                51
     C  N51              ENDDO
     C                   ENDIF
      *
N07  C                   EVAL      KABL = KABL * -1
N03   * DAGSOPPGJØR
N03  C                   IF        XARTYPEDO <> *BLANKS
N03  C                   WRITE     E170PA3A
N03  C                   EVAL      ARAVD = KBAVD
N03  C                   EVAL      AROPD = KBOPD
N03  C                   MOVE      KABNR         ARUNDE
N03  C                   EVAL      ARTYPE = XARTYPEDO
N03  C                   EVAL      ARLINK = XARTYPEDO
N03  C                   MOVEL     ARDATE        AAR               4
N03  C                   CAT       AAR:0         ARLINK
N03  C                   MOVE      KABNR         XAN07             7
N03  C                   CAT       XAN07:0       ARLINK
N03  C                   CALL      'ARCRAN'
N03  C                   PARM                    XAN10            10
N03  C                   CAT       XAN10:0       ARLINK
N03  C                   CAT       '.pdf':0      ARLINK
N03  C                   WRITE     ARKIVR
N03  C                   EVAL      UBANEA = '/'
N03  C                             + %TRIM(XARCANEDO) + '/'
N03  C                             + %TRIM(ARLINK)
N03  C                   END
N03   * KONTROLLISTE
N03  C                   IF        XARTYPEKL <> *BLANKS
N03  C                   EVAL      ARAVD = KBAVD
N03  C                   EVAL      AROPD = KBOPD
N03  C                   MOVE      KABNR         ARUNDE
N03  C                   WRITE     E170PB3A
N03  C                   EVAL      ARTYPE = XARTYPEKL
N03  C                   EVAL      ARLINK = XARTYPEKL
N03  C                   MOVEL     ARDATE        AAR               4
N03  C                   CAT       AAR:0         ARLINK
N03  C                   MOVE      KABNR         XAN07             7
N03  C                   CAT       XAN07:0       ARLINK
N03  C                   CALL      'ARCRAN'
N03  C                   PARM                    XAN10            10
N03  C                   CAT       XAN10:0       ARLINK
N03  C                   CAT       '.pdf':0      ARLINK
N03  C                   WRITE     ARKIVR
N03  C                   EVAL      UBANEB = '/'
N03  C                             + %TRIM(XARCANEKL) + '/'
N03  C                             + %TRIM(ARLINK)
N03  C                   END
N03   *
N05  C                   IF        DGPRIN <> *BLANKS
     C                   WRITE     E170PA3
     C                   WRITE     E170PB3
N05  C                   END
N07  C                   EVAL      KABL = KABL * -1
      *
     C                   ENDSR
      *
      *////////////////////////////////////////////////////////////
      * RETREIVE INFO FROM EDIFACT DATABASE TO SYSPED400    RTVDB /
      *////////////////////////////////////////////////////////////
     C     RTVDB         BEGSR
      * LINJENR
     C                   MOVEA     L1082         A
     C                   EXSR      GETNUM
     C                   Z-ADD     ZNUM          XLNR
      *__________
      * INZ KOSTB
      *""""""""""
     C                   CLEAR                   KOSTBR
N27  C                   MOVE      'N'           KBKDMV
     C                   Z-ADD     KABNR         KBBNR
     C                   MOVE      DGGEB2        KBVK
     C                   MOVE      'F'           KBKDPF
     C                   Z-ADD     0             KBKDM
      *__________________
      * READ ALL SEGMENTS
      *""""""""""""""""""
     C                   Z-ADD     LREP0         ZREPB0
     C                   EXSR      DTM22
     C                   EXSR      MOA23
     C                   EXSR      RFF26
     C                   EXSR      MOA30
     C                   EXSR      NAD31
      *___________________
      * WRITE TO SYSPED400
      *"""""""""""""""""""
     C                   IF        ((KBAVD <> 0) AND (KBOPD <> 0))
n23  C                   move      ' '           fp                1
n23  C     FPKEY1        CHAIN     FPXREF1                            33
n23  c  N33              move      'J'           fp
     C     FRISOKK       CHAIN     FRISOK                             33
     C                   IF        *IN33
      * FINNES IKKE FRA FØR OPPDATER FIRSØKEVEI
     C                   MOVE      KBAVD         FSAVD
     C                   MOVE      KBOPD         FSOPD
     C                   MOVE      SIDT          FSDTOP
     C                   WRITE     FRISOKR
     C                   END
     C                   END
      *
s11  C*                  Z-ADD     9             KBNØKK
s11  C*    KBAVD         IFNE      *ZEROS
s11  C*    KBOPD         ANDNE     *ZEROS
s11  C*                  Z-ADD     0             KBNØKK
s11  C*                  END
      * TOLL
     C                   MOVE      KBBLHB        XKBBLHB          11 2
     C                   EVAL      KBBLHB = KBBLHB - XLINMV
S06  C*                  IF        KBBLHB > 0
N06  C                   IF        KBBLHB <> 0
     C                   EXSR      SRFAKT
     C                   IF        XKOPI <> '(KOPI)'
     C                   IF        KBBLF < KBBLHB
     C                   EVAL      KBBLF = KBBLHB - KBBLF
     C                   ELSE
     C                   EVAL      KBBLF = 0
     C                   END
     C                   IF        DGFAKD = 'N'
     C                   EVAL      KBBLF = 0
     C                   END
n23  c     fp            ifeq      'J'
n23  c                   z-add     kbblhb        forbel           11 2
n23  c                   move      'T'           fpgeby            1
n23  c                   exsr      fordel
n23  c                   else
     C                   WRITE     KOSTBR
n33  c                   end
     C                   END
     C                   END
      * MVA
S06  C*                  IF        XLINMV > 0
N06  C                   IF        XLINMV <> 0
     C                   MOVE      DGGEB3        KBVK
     C                   EVAL      KBBLHB = XLINMV
     C                   EXSR      SRFAKT
     C                   IF        XKOPI <> '(KOPI)'
     C                   IF        KBBLF < KBBLHB
     C                   EVAL      KBBLF = KBBLHB - KBBLF
     C                   ELSE
     C                   EVAL      KBBLF = 0
     C                   END
     C                   IF        DGFAKD = 'N'
     C                   EVAL      KBBLF = 0
     C                   END
n23  c     fp            ifeq      'J'
n23  c                   z-add     kbblhb        forbel           11 2
n23  c                   move      'M'           fpgeby            1
n23  c                   exsr      fordel
n23  c                   else
     C                   WRITE     KOSTBR
n23  c                   end
     C                   END
     C                   END
     C                   MOVE      XKBBLHB       KBBLHB
     C                   EVAL      DIFF = FASUM - KBBLHB
      *____________________
      * SKRIV FAKTURA LINJE
      *""""""""""""""""""""
N05   * LISTE HEAING FOR DAGOPPGJØR
N05  C                   IF        *IN27 OR *IN37
N05  C                   ADD       1             XSIDE
N05  C                   IF        DGPRIN <> *BLANKS
N05  C                   EVAL      *IN27 = *ON
N05  C                   END
N05  C                   IF        XARTYPEDO <> *BLANKS
N05  C                   EVAL      *IN37 = *ON
N05  C                   END
N05  C                   END
     C                   IF        *IN27
S05  C*                  ADD       1             XSIDE
S05  C*                  IF        XARTYPEDO <> *BLANKS
S05  C*                  WRITE     E170PA1A
S05  C*                  MOVE      *OFF          *IN37
S05  C*                  END
     C                   WRITE     E170PA1
     C                   MOVE      *OFF          *IN27
     C                   END
N05  C                   IF        *IN37
N05  C                   WRITE     E170PA1A
N05  C                   MOVE      *OFF          *IN37
N05  C                   END
N05   *
N05   * LISTE HEADING FOR KONTROLL
N05  C                   IF        *IN28 OR *IN38
N05  C                   ADD       1             XPAG1
N05  C                   IF        DGPRIN <> *BLANKS
N05  C                   EVAL      *IN28 = *ON
N05  C                   END
N05  C                   IF        XARTYPEKL <> *BLANKS
N05  C                   EVAL      *IN38 = *ON
N05  C                   END
N05  C                   END
     C                   IF        *IN28
S05  C*                  ADD       1             XPAG1
S05  C*                  IF        XARTYPEKL <> *BLANKS
S05  C*                  WRITE     E170PB1A
S05  C*                  MOVE      *OFF          *IN38
S05  C*                  END
     C                   WRITE     E170PB1
     C                   MOVE      *OFF          *IN28
     C                   END
N05  C                   IF        *IN38
N05  C                   WRITE     E170PB1A
N05  C                   MOVE      *OFF          *IN38
N05  C                   END
N05   * beregner herav toll
n17  C     KBBLHB1       sub       xlinmv        xlinto
n17  c                   add       xlinto        xtotto1
N05   *
N05   * LINJE FOR DAGSOPPGJØR
N03  C                   IF        XARTYPEDO <> *BLANKS
N03  C                   WRITE     E170PA2A
N03  C                   END
N05   * LINJE FOR KONTROLL
N03  C                   IF        XARTYPEKL <> *BLANKS
N03  C                   WRITE     E170PB2A
N03  C                   END
N05  C                   IF        DGPRIN <> *BLANKS
     C                   WRITE     E170PA2
     C                   WRITE     E170PB2
N16  C                   ADD       FASUM         FASUMT
N16  C                   ADD       DIFF          DIFFT
N05  C                   END
      *
     C                   CLEAR                   E170PA2
     C                   CLEAR                   E170PB2
N03  C                   CLEAR                   E170PA2A
N03  C                   CLEAR                   E170PB2A
      *
     C                   ENDSR
      *
      *////////////////////////////////////////////////////////////
      * DTM22                                               DTM22 /
      *////////////////////////////////////////////////////////////
     C     DTM22         BEGSR
     C                   MOVE      '0'           *IN52
     C                   Z-ADD     22            ZGN1
     C     KEYMS1        SETLL     EDTM93A                                20
     C     *IN20         IFEQ      '1'
     C     KEYMS1        READE     EDTM93A                                52
     C     *IN52         DOWEQ     '0'
      *
     C                   SELECT
     C     D2005         WHENEQ    '58 '
     C                   MOVEL     D2380         XDTG             10            GODKJENINGSDATO
     C                   LEAVE
     C                   ENDSL
      *
     C     KEYMS1        READE     EDTM93A                                52
     C  N52              ENDDO
     C                   ENDIF
      *
     C                   ENDSR
      *
      *////////////////////////////////////////////////////////////
      * MOA23                                               MOA23 /
      *////////////////////////////////////////////////////////////
     C     MOA23         BEGSR
     C                   MOVE      '0'           *IN52
     C                   Z-ADD     23            ZGN1
     C     KEYMS1        SETLL     EMOA93A                                20
     C     *IN20         IFEQ      '1'
     C     KEYMS1        READE     EMOA93A                                52
     C     *IN52         DOWEQ     '0'
      *
     C                   MOVEA     M5004         A
     C                   EXSR      GETNUM
     C                   SELECT
     C     M5025         WHENEQ    '203'
     C                   Z-ADD     ZNUM          KBBLHB
     C                   LEAVE
     C                   ENDSL
      *
     C     KEYMS1        READE     EMOA93A                                52
     C  N52              ENDDO
     C                   ENDIF
      *
     C                   ENDSR
      *
      *////////////////////////////////////////////////////////////
      * RFF26                                               RFF26 /
      *////////////////////////////////////////////////////////////
     C     RFF26         BEGSR
     C                   MOVE      *ZEROS        FASUM
     C                   MOVE      '0'           *IN52
     C                   Z-ADD     26            ZGN1
     C     KEYMS1        SETLL     ERFF93A                                20
     C     *IN20         IFEQ      '1'
     C     KEYMS1        READE     ERFF93A                                52
     C     *IN52         DOWEQ     '0'
      *
      * TESTER PÅ FRAKTBREVNUMMER
      *
     C                   SELECT
     C     R1153         WHENEQ    'ABT'
     C                   MOVEL     R1154         XAN16            16
     C                   MOVEL     XAN16         SITLE
     C                   MOVE      XAN16         SITLL
s09  C*                  EVAL      KBBILT = 'MOMS FRA TVINN'
n09  C                   MOVE      *blanks       KBBILT
n09  C                   MOVEL     SITLE         KBBILT
n09  C                   MOVE      SITLL         SITLL8            8
n09  C                   MOVE      SITLL8        KBBILT
     C     SADH12BK      CHAIN     SADH12B                            41
      * omberegning
N29  c  N41SITDN         iflt      0
N29  c                   z-sub     sitdn         sitdn
N29  c                   end
n25   *
n25   * sjekk om forenklet prosedyre
n25   * først hvis dette er underoppdrag får da tilslag her
n25   * og må overstye med hovedoppdrag og chain på nytt
n25   *
s28  C*    *in41         ifeq      '0'
n30  C     *in41         ifeq      '0'
      * omberegning
s28  c*    SITDN         iflt      0
s28  c*                  z-sub     sitdn         sitdn
s28  c*                  end
S25* C*    SIST          ANDEQ     'F'
s28  C*    FPKEY         CHAIN     FPXREF                             42
s28  C* N42              MOVE      FPAVDH        SIAVD
s28  C* N42              MOVE      FPOPDH        SITDN
s28  C* N42FPKEY         CHAIN     SADH                               42
s28  C*                  END
      * omberegning
n30  c     SITDN         iflt      0
n30  c                   z-sub     sitdn         sitdn
n30  c                   end
n30  C     SIST          ifeq      'F'
s28  C     FPKEY         CHAIN     FPXREF                             42
s28  C  N42              MOVE      FPAVDH        SIAVD
n30  C  N42              MOVE      FPOPDH        SITDN
n30  C  N42FPKEY         CHAIN     SADH                               42
n30  C                   END
n30  C                   END
     C     *in41         ifeq      '1'
     c     SADH12BK      CHAIN     SAEH12B                            41
     C  N41              MOVE      SEAVD         SIAVD
      * omberegning
N27  c  N41SETDN         iflt      0
N27  c                   z-sub     setdn         setdn
N27  c                   end
     C  N41              MOVE      SETDN         SITDN
     C  N41              MOVE      SEDT          SIDT
N20  C  N41              MOVE      SEDTG         SIDTG
N20  C   41              MOVE      *ZEROS        SIDT
N20  C   41              MOVE      *BLANKS       SIDTG
     C                   END
     C     *IN41         IFEQ      '0'
     C                   MOVE      SIAVD         KBAVD
     C                   MOVE      SITDN         KBOPD
     C     HEADFK        CHAIN     HEADF                              20
     C                   IF        *IN20 = *OFF
N15  C     DGPER         IFEQ      'J'
N15  C                   MOVE      HEDTCC        KBPCC
N15  C                   MOVE      HEDTAA        KBPÅR
N15  C                   MOVE      HEDTMM        KBPMN
N15  C                   END
      *
     C     HEKDFK        IFNE      'X'
     C                   MOVE      HEKNKF        KBKN
     C                   ELSE
     C                   MOVE      HEKNSF        KBKN
     C                   END
N11  C                   Z-ADD     0             KBNØKK
     C*                  EXSR      SRFAKT
N10   * headfpost mangler
N10  C                   ELSE
N10  C                   Z-ADD     9             KBNØKK
N10  C                   Z-add     SIKNK         KBKN
     C                   END
     C                   ELSE
N12   * sadhpost mangler
N12  C                   Z-ADD     9             KBNØKK
     C                   MOVE      *ZEROS        SIAVD
     C                   MOVE      *ZEROS        SITDN
N20  C                   MOVE      *ZEROS        KBAVD
N20  C                   MOVE      *ZEROS        KBOPD
     C                   ENDIF
     C                   ENDSL
      *
     C     KEYMS1        READE     ERFF93A                                52
     C  N52              ENDDO
     C                   ENDIF
      *
     C                   ENDSR
      *
      *////////////////////////////////////////////////////////////
      * MOA30                                               MOA30 /
      *////////////////////////////////////////////////////////////
     C     MOA30         BEGSR
     C                   MOVE      '0'           *IN52
     C                   Z-ADD     30            ZGN1
     C     KEYMS1        SETLL     EMOA93A                                20
     C     *IN20         IFEQ      '1'

     C     *IN52         DOWEQ     '0'
      *
     C                   MOVEA     M5004         A
     C                   EXSR      GETNUM
     C                   SELECT
     C     M5025         WHENEQ    '124'
     C                   Z-ADD     ZNUM          XLINMV
     C                   LEAVE
     C                   ENDSL
      *
     C     KEYMS1        READE     EMOA93A                                52
     C  N52              ENDDO
     C                   ENDIF
      *
     C                   ENDSR
      *
      *////////////////////////////////////////////////////////////
      * NAD31                                               NAD31 /
      *////////////////////////////////////////////////////////////
     C     NAD31         BEGSR
N13  C                   move      *blanks       KBFREE           37
     C                   MOVE      '0'           *IN52
     C                   Z-ADD     31            ZGN1
     C     KEYMS1        SETLL     ENAD93A                                20
     C     *IN20         IFEQ      '1'
     C     KEYMS1        READE     ENAD93A                                52
     C     *IN52         DOWEQ     '0'
      *
     C                   SELECT
     C     N3035         WHENEQ    'DU '
     C                   MOVEL     N3124A        XKNAVN
N17  C                   MOVEL     N3124A        XKNAVNN
N13  C                   movel     N3124A        KBFREE
     C                   ENDSL
      *
     C     KEYMS1        READE     ENAD93A                                52
     C  N52              ENDDO
     C                   ENDIF
      *
     C                   ENDSR
      *
      *////////////////////////////////////////////////////////////
      *  Get numerical value                               GETNUM /
      *////////////////////////////////////////////////////////////
     C     GETNUM        BEGSR
     C                   MOVE      *ZEROS        ZHEL
     C                   MOVE      *ZEROS        ZDEC
     C                   MOVE      *ZEROS        B
N01  C                   IF        A(1) = '-'
N01  C                   Z-SUB     1             XFORTEGN
N01  C                   Z-ADD     2             AX
N01  C                   ELSE
N01  C                   Z-ADD     1             XFORTEGN          1 0
     C                   Z-ADD     1             AX                2 0
N01  C                   END
     C                   Z-ADD     1             BX                2 0
      * Get Integer
     C     A(AX)         DOWGE     '0'
     C     ZHEL          MULT      10            ZHEL
     C                   MOVE      A(AX)         ZHEL
     C                   ADD       1             AX
     C                   ENDDO
      * Decimal point ?
     C     A(AX)         IFEQ      '.'
     C     A(AX)         OREQ      ','
     C                   ADD       1             AX
     C     A(AX)         DOWGE     '0'
     C                   MOVE      A(AX)         B(BX)
     C                   ADD       1             AX
     C                   ADD       1             BX
     C                   ENDDO
     C                   MOVEA     B             ZDEC6
     C                   ENDIF
      * Concatenate
     C                   Z-ADD     ZHEL          ZNUM             18 6
     C                   ADD       ZDEC          ZNUM
N01  C                   EVAL      ZNUM = ZNUM * XFORTEGN
      *
     C                   ENDSR
      *
      *////////////////////////////////////////////////////////////
      * SRFAKT                                             SRFAKT /
      *////////////////////////////////////////////////////////////
     c     srfakt        begsr
n18  c                   move      ' '           star              1
     C                   MOVE      'N'           KBKDMV
     C                   MOVE      *ZEROS        KBBLF
     C     HEADFK        SETLL     FAKT
     C     HEADFK        READE     FAKT                                   33
     C                   DOW       *IN33 = *OFF
S04  C*                  IF        ((FAKDA <> 'K') AND
S04  C*                             (FAVK = KBVK))
N04  C                   IF        (((FAKDA <> 'K') AND
N04  C                               (FAKDA <> 'D')) AND
N04  C                               (FAVK = KBVK))
     C                   ADD       FABELN        KBBLF
     C                   ADD       FABELN        FASUM
n18  c     faopko        iflt      'D'
n18  c                   move      '*'           star
N18  C                   END
     C                   END
     C     HEADFK        READE     FAKT                                   33
     C                   ENDDO
      *
     C                   ENDSR
      *
      *
N23   ***************************************************************
N23  c     fordel        begsr
N23   ***************************************************************
N23   *
N23  c                   setoff                                       35
N23  c     FPKEY2        setll     fpxref1
N23  c     *in(35)       doweq     '0'
N23  c     FPKEY2        READE     fpxref1                                35
N23  c     *in(35)       IFEQ      '0'
N23   *
N23  C     FPKEYN        CHAIN     SADH                               34
N23   *
N13  C  N34              eval      kbfree=sinak
N13   * legger avd opd på kostb posten
N23  C     FPKEYN        CHAIN     HEADF                              34
n23  c                   z-add     siavd         kbavd
n23  c                   z-add     sitdn         kbopd
N10  C                   Z-ADD     0             KBNØKK
N12  C   34              Z-ADD     9             KBNØKK
N23   *
N23   *
      * toll
N23  C     FPGEBY        IFEQ      'T'
N23  c     sibel7        sub       sibel6        toll             11 0
N23  C                   Z-ADD     TOLL          kbblhb
N23  C                   ELSE
      * mva
N23  C                   Z-ADD     SIBEL6        MOMS             11 0
N23  C                   Z-ADD     MOMS          KBBLHB
N23  c                   END
      *
N23  C                   WRITE     KOSTBR
n23   * reduser fordelingssum
n23  c                   sub       kbblhb        forbel
n23  c                   end
n23  c                   end
N23  C     FORBEL        IFNE      0
N23  C                   z-add     forbel        kbblhb
n23  c                   z-add     FPAVDH        kbavd
n23  c                   z-add     FPOPDH        kbopd
N23  C
N13  C                   eval      kbfree='**RESTBELØP**'
n26  C                   Z-ADD     9             KBNØKK
N23  C                   WRITE     KOSTBR
n23  c                   end
s26  C*                  Z-ADD     9             KBNØKK
n23  c                   endsr
