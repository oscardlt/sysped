CB    * Fjernet kall på SYTR12A etter diskusjon med Svein
      *********************************************************************
      *
CRTPG+*  CRTPGM SYSPED/TJETUR02 MODULE(*LIBL/TJETUR02 *LIBL/INCGI)
CRTPGM*        ACTGRP(*NEW) AUT(*USE)
      *
      *********************************************************************
      /copy SYSPEDS/qrpgsrcpy,hspecs
      /copy SYSPEDS/qrpgsrcpy,hspecsbnd
      *********************************************************************
     FBRIDF     IF   E           K DISK    USROPN
     FTURER     IF   E           K DISK    USROPN
     FHEAD11    IF   E           K DISK    USROPN
     FFAK2      IF   E           K DISK    USROPN
     FFIRM      IF   E           K DISK    USROPN
     FKODTV     IF   E           K DISK    USROPN
     FVALUL01   IF   E           K DISK    USROPN
     FKOSBU2    IF   E           K DISK    USROPN
     FKODTGE    IF   E           K DISK    USROPN
     FTRAVH1    IF   E           K DISK    USROPN
     FTRAN      IF   E           K DISK    USROPN
      *--------------------------------------------------------------------
      * Variables common to all CGIs
      *--------------------------------------------------------------------
      /copy SYSPEDS/qrpgsrcpy,prototypeb
      /copy SYSPEDS/qrpgsrcpy,usec
      /copy SYSPEDS/qrpgsrcpy,variables3
      *
      * Varible for
     D WSUSER          S             10
     D WA              S             15
     D JSONstring      s          32000
     D Error           S            150
     D AntLest         S              9  0
      *
     D AVRTXT          C                   CONST('AVREGNING HOVEDTRANS')
     D AVRTXD          C                   CONST('*AVR*DIREKTE KOSTN. ')
     D AVRTXF          C                   CONST('*AVF*FORDELT KOSTN. ')
     D AVRTGD          C                   CONST('*AGD*GODSKR DIREKTE ')
     D AVRTGF          C                   CONST('*AGF*GODSKR FORDELT ')
     D                 DS
     D  FAVT                   1     20
     D  FAVTX                  1     19
     D  FAVTXX                13     15
      *get input-string
      /copy syspeds/qrpgsrcpy,prolog3

      * Parse input
     C                   EXSR      Parse
      * Open files etc
     C                   EXSR      INIT

     C                   CALLP     gethtmlifs(
     C                             '/syspeddev/html/JSON.html':
     C                             '/CGITAG/')
     C                   CALLP     wrtsection('top')
      * ............................................................................................
      * skriv JSON-Object start..(alltid '{' + x ant param. m/komma mellom (IKKE komma etter siste))
      * ............................................................................................
      /free
        JSONstring='{'
        +'¬user¬ : ¬'+%trim(WSUSER)+'¬, '
        +'¬tuavd¬ : ¬'+%trim(%editc(WTUAVD:'Z'))+'¬, '
        +'¬tupro¬ : ¬'+%trim(%editc(WTUPRO:'Z'))+'¬, '
        +'¬errMsg¬ : ¬'+%trim(Error)+'¬, ¬getonetrip¬ : [';
      /end-free
      * JSONfix escaper " i tekst,  for deretter å bytte ¬->"
     C                   CALL      'JSONFIX'
     C                   PARM                    JSONstring
     C                   CALLP     updHTMLvar2('JSONstring'
     C                                         :%addr(JSONstring)
     C                                         :%len(JSONstring))
     C                   CALLP     wrtsection('JSONlin')
      * Hæmta detta ena ærendet.

     C     Error         IFEQ      *blanks
     C     TURKEY        CHAIN     TURER                              55
     C     *IN55         IFEQ      '0'
     C                   EXSR      FIXVAR
      * ............................................................................................
      * Skriv en JSON-Array-linje pr menypunkt - komma før hvert nytt element
      * ............................................................................................
      /free
          JSONstring=*blanks;
       JSONstring=%trim(JSONstring)+'{'
          +'¬tust¬ : ¬'+%trim(TUST)+'¬, '
          +'¬tuavd¬ : ¬'+%trim(%editc(TUAVD:'Z'))+'¬, '
          +'¬tupro¬ : ¬'+%trim(%editc(TUPRO:'Z'))+'¬, '
          +'¬tudt¬ : ¬'+%trim(%editc(TUDT:'Z'))+'¬, '
          +'¬tukna¬ : ¬'+%trim(%editc(TUKNA:'Z'))+'¬, '
          +'¬tuknt¬ : ¬'+%trim(%editc(TUKNT:'Z'))+'¬, '
               +'¬tunat¬ : ¬'+%trim(TUNAT)+'¬, '
               +'¬tuad1t¬ : ¬'+%trim(TUAD1T)+'¬, '
               +'¬tuad2t¬ : ¬'+%trim(TUAD2T)+'¬, '
               +'¬tuad3t¬ : ¬'+%trim(TUAD3T)+'¬, '
               +'¬tubiln¬ : ¬'+%trim(TUBILN)+'¬, '
               +'¬tutarf¬ : ¬'+%trim(TUTARF)+'¬, '
               +'¬tulk¬ : ¬'+%trim(TULK)+'¬, '
               +'¬tuxxx1¬ : ¬'+%trim(TUXXX1)+'¬, '
               +'¬tusdf¬ : ¬'+%trim(TUSDF)+'¬, '
               +'¬tusdt¬ : ¬'+%trim(TUSDT)+'¬, '
               +'¬tuao¬ : ¬'+%trim(%editc(TUAO:'Z'))+'¬, '
N01            +'¬tuts¬ : ¬'+%trim(%editc(TUTS:'Z'))+'¬, '
N01            +'¬tutvkt¬ : ¬'+%trim(%editc(TUTVKT:'Z'))+'¬, '
               +'¬tutlm¬ : ¬'+%trim(%editc(TUTLM:'4'))+'¬, '
N01            +'¬tutm3¬ : ¬'+%trim(%editc(TUTM3:'4'))+'¬, '
               +'¬tulast¬ : ¬'+%trim(%editc(TULAST:'Z'))+'¬, '
               +'¬tubusj¬ : ¬'+%trim(%editc(TUBUSJ:'Z'))+'¬, '
               +'¬tuxxx2¬ : ¬'+%trim(TUXXX2)+'¬, '
               +'¬tutst1¬ : ¬'+%trim(TUTST1)+'¬, '
               +'¬tutst2¬ : ¬'+%trim(TUTST2)+'¬, '
               +'¬tutst3¬ : ¬'+%trim(TUTST3)+'¬, '
               +'¬tutst4¬ : ¬'+%trim(TUTST4)+'¬, '
               +'¬tutst5¬ : ¬'+%trim(TUTST5)+'¬, '
               +'¬tuavre¬ : ¬'+%trim(TUAVRE)+'¬, '
               +'¬tuavnr¬ : ¬'+%trim(%editc(TUAVNR:'Z'))+'¬, '
               +'¬turund¬ : ¬'+%trim(%editc(TURUND:'Z'))+'¬, '
               +'¬turacc¬ : ¬'+%trim(%editc(TURACC:'Z'))+'¬, '
               +'¬turaar¬ : ¬'+%trim(%editc(TURAAR:'Z'))+'¬, '
               +'¬turmnd¬ : ¬'+%trim(%editc(TURMND:'Z'))+'¬, '
               +'¬tuopdt¬ : ¬'+%trim(TUOPDT)+'¬, '
               +'¬tutrma¬ : ¬'+%trim(%editc(TUTRMA:'Z'))+'¬, '
               +'¬tuheng¬ : ¬'+%trim(TUHENG)+'¬, '
               +'¬tulkh¬ : ¬'+%trim(TULKH)+'¬, '
               +'¬tucon1¬ : ¬'+%trim(TUCON1)+'¬, '
               +'¬tulkc1¬ : ¬'+%trim(TULKC1)+'¬, '
               +'¬tucon2¬ : ¬'+%trim(TUCON2)+'¬, '
               +'¬tulkc2¬ : ¬'+%trim(TULKC2)+'¬, '
               +'¬tutara¬ : ¬'+%trim(%editc(TUTARA:'Z'))+'¬, '
               +'¬tubilk¬ : ¬'+%trim(TUBILK)+'¬, '
               +'¬tuknt2¬ : ¬'+%trim(%editc(TUKNT2:'Z'))+'¬, '
               +'¬tusja1¬ : ¬'+%trim(%editc(TUSJA1:'Z'))+'¬, '
               +'¬tusjn1¬ : ¬'+%trim(TUSJN1)+'¬, '
               +'¬tusja2¬ : ¬'+%trim(%editc(TUSJA2:'Z'))+'¬, '
               +'¬tusjn2¬ : ¬'+%trim(TUSJN2)+'¬, '
               +'¬tustef¬ : ¬'+%trim(TUSTEF)+'¬, '
               +'¬tusonf¬ : ¬'+%trim(TUSONF)+'¬, '
               +'¬tudtt¬ : ¬'+%trim(%editc(TUDTT:'Z'))+'¬, '
              // +'¬tutm¬ : ¬'+%trim(%editc(TUTM:'Z'))+'¬, '
               +'¬tutm¬ : ¬'+%trim(TUTMA)+'¬, '
              // +'¬tutmt¬ : ¬'+%trim(%editc(TUTMT:'Z'))+'¬, '
               +'¬tutmt¬ : ¬'+%trim(TUTMTA)+'¬, '
               +'¬tustet¬ : ¬'+%trim(TUSTET)+'¬, '
               +'¬tusont¬ : ¬'+%trim(TUSONT)+'¬, '
N01            +'¬tukvkt¬ : ¬'+%trim(%editc(TUKVKT:'Z'))+'¬, '
N01            +'¬tukam3¬ : ¬'+%trim(%editc(TUKAM3:'4'))+'¬, '
               +'¬tukalM¬ : ¬'+%trim(%editc(TUKALM:'4'))+'¬, '
               +'¬tuto1a¬ : ¬'+%trim(TUTO1A)+'¬, '
               +'¬tuto1b¬ : ¬'+%trim(TUTO1B)+'¬, '
               +'¬tutval¬ : ¬'+%trim(TUTVAL)+'¬, '
               +'¬tutako¬ : ¬'+%trim(TUTAKO)+'¬, '
               +'¬tutbel¬ : ¬'+%trim(%editc(TUTBEL:'4'))+'¬, '
               +'¬tutref¬ : ¬'+%trim(%editc(TUTREF:'Z'))+'¬, '
               +'¬tuhoyb¬ : ¬'+%trim(%editc(TUHØYB:'4'))+'¬, '
               +'¬tuhoyh¬ : ¬'+%trim(%editc(TUHØYH:'4'))+'¬, '
               +'¬tusg¬ : ¬'+%trim(TUSG)+'¬, '
               +'¬tuant1¬ : ¬'+%trim(%editc(TUANT1:'Z'))+'¬, '
               +'¬tuenh1¬ : ¬'+%trim(TUENH1)+'¬, '
               +'¬tuant2¬ : ¬'+%trim(%editc(TUANT2:'4'))+'¬, '
               +'¬tuenh2¬ : ¬'+%trim(TUENH2)+'¬, '
               +'¬tukm¬ : ¬'+%trim(%editc(TUKM:'Z'))+'¬, '
               +'¬tublnr¬ : ¬'+%trim(TUBLNR)+'¬, '
               +'¬tubkd¬ : ¬'+%trim(TUBKD)+'¬, '
               +'¬tubnv¬ : ¬'+%trim(TUBNV)+'¬, '
               +'¬tuetd¬ : ¬'+%trim(%editc(TUETD:'Z'))+'¬, '
               +'¬tueta¬ : ¬'+%trim(%editc(TUETA:'Z'))+'¬, '
               +'¬tuatd¬ : ¬'+%trim(%editc(TUATD:'Z'))+'¬, '
               +'¬tuata¬ : ¬'+%trim(%editc(TUATA:'Z'))+'¬, '
               +'¬tuckd1¬ : ¬'+%trim(TUCKD1)+'¬, '
               +'¬tuckd2¬ : ¬'+%trim(TUCKD2)+'¬, '
TMS            +'¬tupoen¬ : ¬'+%trim(%editc(TUPOEN:'Z'))+'¬, '
TMS            +'¬tutlm2¬ : ¬'+%trim(%editc(TUTLM2:'4'))+'¬, '
TMS            +'¬tustn1¬ : ¬'+%trim(TUSTN1)+'¬, '
TMS            +'¬tustn2¬ : ¬'+%trim(TUSTN2)+'¬, '
TMS            +'¬tustn3¬ : ¬'+%trim(TUSTN3)+'¬, '
TMS            +'¬tustn4¬ : ¬'+%trim(TUSTN4)+'¬, '
TMS            +'¬tustn5¬ : ¬'+%trim(TUSTN5)+'¬, '
TMS            +'¬tustn6¬ : ¬'+%trim(TUSTN6)+'¬, '
TMS            +'¬tustn7¬ : ¬'+%trim(TUSTN7)+'¬, '
TMS            +'¬tustn8¬ : ¬'+%trim(TUSTN8)+'¬, '
               +'¬tustn9¬ : ¬'+%trim(TUSTN9)+'¬, '
               +'¬tulkf¬ : ¬'+%trim(TULKF)+'¬, '
               +'¬tulkt¬ : ¬'+%trim(TULKT)+'¬, '
               +'¬simlm¬ : ¬'+%trim(%editc(SIMLM:'4'))+'¬, '
               +'¬simm3¬ : ¬'+%trim(%editc(SIMM3:'4'))+'¬, '
               +'¬berbud¬ : ¬'+%trim(%editc(BERBUD:'Q'))+'¬, '
               +'¬totiaa¬ : ¬'+%trim(%editc(TOXIÅA:'Q'))+'¬, '
               +'¬totioa¬ : ¬'+%trim(%editc(TOXIOA:'Q'))+'¬, '
               +'¬totisa¬ : ¬'+%trim(%editc(TOXISA:'Q'))+'¬, '
               +'¬totiag¬ : ¬'+%trim(%editc(TOXIÅG:'Q'))+'¬, '
               +'¬totiog¬ : ¬'+%trim(%editc(TOXIOG:'Q'))+'¬, '
               +'¬totisg¬ : ¬'+%trim(%editc(TOXISG:'Q'))+'¬, '
               +'¬totkaa¬ : ¬'+%trim(%editc(TOXKÅA:'Q'))+'¬, '
               +'¬totkoa¬ : ¬'+%trim(%editc(TOXKOA:'Q'))+'¬, '
               +'¬totksa¬ : ¬'+%trim(%editc(TOXKSA:'Q'))+'¬, '
               +'¬totkao¬ : ¬'+%trim(%editc(TOXKÅØ:'Q'))+'¬, '
               +'¬totkoo¬ : ¬'+%trim(%editc(TOXKOØ:'Q'))+'¬, '
               +'¬totkso¬ : ¬'+%trim(%editc(TOXKSØ:'Q'))+'¬, '
               +'¬totopn¬ : ¬'+%trim(%editc(TOXÅ:'Q'))+'¬, '
               +'¬totovf¬ : ¬'+%trim(%editc(TOXO:'Q'))+'¬, '
               +'¬totsum¬ : ¬'+%trim(%editc(TOXS:'Q'))+'¬, '
               +'¬tures¬ : ¬'+%trim(%editc(TURES:'3'))+'¬}';
      /end-free
     C                   CALL      'JSONFIX'
     C                   PARM                    JSONstring
     C                   CALLP     updHTMLvar2('JSONstring'
     C                                         :%addr(JSONstring)
     C                                         :%len(JSONstring))
     C                   CALLP     wrtsection('JSONlin')

     C                   ENDIF
     C                   ENDIF
      * ............................................................................................
      * Skriv JSON-string Avsluttning
      * ............................................................................................
     C                   EVAL      JSONstring =']}'
     C                   CALLP     updHTMLvar2('JSONstring'
     C                                         :%addr(JSONstring)
     C                                         :%len(JSONstring))
     C                   CALLP     wrtsection('JSONlin')
      * Quit
     C                   EXSR      EXIT
      *=====================================================================
      * Close output html and quit
      *=====================================================================
     C     EXIT          BEGSR
      * Lukk fil
     C                   CLOSE     BRIDF
     C  N50              CLOSE     TURER
     C  N50              CLOSE     HEAD11
     C  N50              CLOSE     FAK2
     C  N50              CLOSE     FIRM
     C  N50              CLOSE     KODTV
     C  N50              CLOSE     VALUL01
     C  N50              CLOSE     KOSBU2
     C  N50              CLOSE     KODTGE
     C  N50              CLOSE     TRAVH1
     C  N50              CLOSE     TRAN

      * Do not delete the CALL to wrtsection with section name *fini.  It is needed
      * to ensure that all output html that has been buffered gets output.
     C                   CALLP     wrtsection('*fini')
      * Quit
     C                   MOVE      *ON           *INLR
     C                   RETURN
     C                   ENDSR
      *********************************************************
     C     Parse         BEGSR
      *********************************************************
      * Get input
     C                   EVAL      WSUSER  = zhbgetvar('USER')
     C                   EVAL      WA      = zhbgetvar('TUAVD')
     C                   EVAL      WTUAVD  = c2n2(WA)
     C                   EVAL      WA      = zhbgetvar('TUPRO')
     C                   EVAL      WTUPRO  = c2n2(WA)
     C                   ENDSR
      *********************************************************
     C     INIT          BEGSR
      *********************************************************
     C                   OPEN      BRIDF
      * Test innlogging
     C     WSUSER        CHAIN     BRIDF                              50
     C     BILIBL        IFEQ      *blanks
     C                   CALLb     'INCGI'
     C                   PARM                    BISTDL
     C                   else
     C                   CALL      BILIBL
     C                   end

     C     TURKEY        klist
     C                   KFLD                    WTUAVD
     C                   KFLD                    WTUPRO
     C     *LIKE         DEFINE    TUAVD         WTUAVD
     C     *LIKE         DEFINE    TUPRO         WTUPRO
     C     FAK2KI        KLIST
     C                   KFLD                    TRAVD1
     C                   KFLD                    TROPD1
     C     KOSBK2        KLIST
     C                   KFLD                    XXST
     C                   KFLD                    TUPRO
     C                   MOVE      ' '           XXST              1
N01  C     KODTVK        KLIST
N04  C                   KFLD                    YVUNI
N01  C                   KFLD                    TUAVD
N04  C                   MOVE      'V'           YVUNI             1
     C     KODGEK        KLIST
     C                   KFLD                    YGEUNI
     C                   KFLD                    FAVK
     C                   MOVE      'GE'          YGEUNI            2
     C     VALKEY        KLIST
     C                   KFLD                    FIFIRM
     C                   KFLD                    TUTVAL
     C     FAK2K         KLIST
     C                   KFLD                    HEAVD
     C                   KFLD                    HEOPD
     C     FAK2KU        KLIST
     C                   KFLD                    TRAVD2
     C                   KFLD                    TROPD2

     C   50              EVAL      Error = 'Invalid userID'
     C  N50              OPEN      TURER
     C  N50              OPEN      HEAD11
     C  N50              OPEN      FAK2
     C  N50              OPEN      FIRM
     C  N50              OPEN      KODTV
     C  N50              OPEN      VALUL01
     C  N50              OPEN      KOSBU2
     C  N50              OPEN      KODTGE
     C  N50              OPEN      TRAVH1
     C  N50              OPEN      TRAN

     C  N50*LOVAL        SETLL     FIRM
     C  N50              READ      FIRM
     C                   ENDSR
      *********************************************************
     C     FIXVAR        BEGSR
      *********************************************************
     C                   MOVE      TUPRO         TUPRO2            8
N04  c                   if        TUBILN = '.' and TUHENG<>' '
N04  c                   eval      TUBILN = TUHENG
N04  c                   endif
     C                   MOVEL     TUSONF        TULKF             2
     C                   MOVEL     TUSONT        TULKT             2

n15  C                   Z-ADD     0             TURES             5 2
N01  C     KODTVK        CHAIN     KODTV                              33
N01  C   33              Z-ADD     1800          KOVLKG
N01  C   33              Z-ADD     300           KOVKKG
      *
n15  c*                  call      'SYGE83'
n15  c*                  parm                    tupro
n15  c*                  parm                    kodet             1
n15  c*                  parm                    ubelop           13 2
n15  C*                  Z-ADD     0             TURES             5 2
n15  c*                  z-add     tutbel        budsj            11 2
n15   *
n15   * eller hente budsjett
n15   *
n15  c*    budsj         ifeq      *zeros
n15  c*                  move      tupro         uproa             8
N15  c*                  call      'SYGE79TCL'
N15  c*                  parm                    uproa
N15  c*                  parm                    wstvalb           3
N15  c*                  parm                    budsj            11 2
N15  c*                  parm                    wstakob           1
N15  C*                  end
N15  c*    budsj         ifne      0
n15  C*    UBELOP        IFEQ      0
n15  C*                  Z-ADD     0             TURES
n15  C*                  ELSE
n15  c*    ubelop        div       budsj         work             15 5
N15  c*    work          sub       1             work
n15  c*    work          ifgt      999
N15  c*                  z-add     100           tures
n15  c*                  else
n15  c*    work          mult      100           tures
n15  c*                  end
n15  C*                  END
n15  c*                  else
N15  c*                  z-add     100           tures
N15  c*                  end
      * INITIER AKKUMULATORE/DS-ER
     C                   MOVE      *ZEROS        TOTIÅA           13 2
     C                   MOVE      *ZEROS        TOTIOA           13 2
     C                   MOVE      *ZEROS        TOTISA           13 2
     C                   MOVE      *ZEROS        TOTIÅG           13 2
     C                   MOVE      *ZEROS        TOTIOG           13 2
     C                   MOVE      *ZEROS        TOTISG           13 2
     C                   MOVE      *ZEROS        TOTKÅA           13 2
     C                   MOVE      *ZEROS        TOTKOA           13 2
     C                   MOVE      *ZEROS        TOTKSA           13 2
     C                   MOVE      *ZEROS        TOTKÅØ           13 2
     C                   MOVE      *ZEROS        TOTKOØ           13 2
     C                   MOVE      *ZEROS        TOTKSØ           13 2
     C                   MOVE      *ZEROS        TOTÅ             13 2
     C                   MOVE      *ZEROS        TOTO             13 2
     C                   MOVE      *ZEROS        TOTS             13 2
     C                   EXSR      SUMFRA
      * klokke med foranstilt
     c                   move      TUTM          TUTMA             4
     c                   if        TUTM = *zeros
     c                   move      *blanks       TUTMA
     c                   endif
     c                   move      TUTMT         TUTMTA            4
     c                   if        TUTMT= *zeros
     c                   move      *blanks       TUTMTA
     c                   endif
     C                   ENDSR
      ***********************************************
     C     SUMFRA        BEGSR
      ***********************************************
      *
     C                   MOVE      *ZEROS        TOTIÅA
     C                   MOVE      *ZEROS        TOTIOA
     C                   MOVE      *ZEROS        TOTISA
     C                   MOVE      *ZEROS        TOTIÅG
     C                   MOVE      *ZEROS        TOTIOG
     C                   MOVE      *ZEROS        TOTISG
     C                   MOVE      *ZEROS        TOTKÅA
     C                   MOVE      *ZEROS        TOTKOA
     C                   MOVE      *ZEROS        TOTKSA
     C                   MOVE      *ZEROS        TOTKÅØ
     C                   MOVE      *ZEROS        TOTKOØ
     C                   MOVE      *ZEROS        TOTKSØ
     C                   MOVE      *ZEROS        TOTÅ
     C                   MOVE      *ZEROS        TOTO
     C                   MOVE      *ZEROS        TOTS
N01  C                   MOVE      *ZEROS        SIMLM             5 2
N01  C                   MOVE      *ZEROS        SIMM3             9 3
N01  C                   MOVE      *ZEROS        TUAO
N01  C                   MOVE      *ZEROS        TUTS
      *
     C     STSUM1        TAG
     C     TUPRO         SETLL     HEAD11
     C     STSUM2        TAG
     C                   SETOFF                                       33
     C     TUPRO         READE     HEAD11                                 33
     C  N33              DO                                                     1<-B
N01   * stoler ikke på TUAO/TUTS - reakkumulerer når en likevel leser alle oppdrag
N01  C                   Add       1             TUAO
N01  C                   Add       HENT          TUTS
N01   * Akkumulere simmulert LM / M3 utfra F-vekt med avdelingens faktor.
N01  c                   z-add     HEVKT         TMPFBV            9 0
N01  c     HELM          mult      KOVLKG        TMPFBV1           9 0
N01  c     HEM3          mult      KOVKKG        TMPFBV2           9 0
N01  c     TMPFBV1       ifgt      TMPFBV
N01  c                   z-add     TMPFBV1       TMPFBV
N01  c                   end
N01  c     TMPFBV2       ifgt      TMPFBV
N01  c                   z-add     TMPFBV2       TMPFBV
N01  c                   end
     C                   IF        KOVLKG > *ZEROS
N01  c     TMPFBV        div(H)    KOVLKG        TMPLM            12 3
     C                   ELSE
N01  c                   EVAL      TMPLM=*ZEROS
     C                   ENDIF
     C                   IF        KOVKKG > *ZEROS
N01  c     TMPFBV        div(H)    KOVKKG        TMPM3            12 3
     C                   ELSE
N01  c                   EVAL      TMPM3=*ZEROS
     C                   ENDIF
N01  C                   ADD       TMPLM         SIMLM
N01  C                   ADD       TMPM3         SIMM3
      * ENNÅ IKKE OVERFØRT HENTE-KOSTNAD VIA DUP
     C     TROPD1        IFNE      *ZEROS
     C     FAK2KI        SETLL     FAK2                               34
     C     FAK2KI        READE     FAK2                                   34
     C     *IN34         DOWEQ     '0'
     C     FAOPKO        IFEQ      ' '
     C     FASK          ANDEQ     'I'
     C     FAKDA         ANDNE     'I'
     C                   SUB       FABELN        TOTKÅØ
     C                   SUB       FABELN        TOTKSØ
     C                   SUB       FABELN        TOTÅ
     C                   SUB       FABELN        TOTS
     C                   END
     C     FAK2KI        READE     FAK2                                   34
     C                   END
     C                   END
      * ENNÅ IKKE OVERFØRT UTKJ-KOSTNAD VIA DUP
     C     TROPD2        IFNE      *ZEROS
     C     FAK2KU        SETLL     FAK2                               34
     C     FAK2KU        READE     FAK2                                   34
     C     *IN34         DOWEQ     '0'
     C     FAOPKO        IFEQ      ' '
     C     FASK          ANDEQ     'I'
     C     FAKDA         ANDNE     'I'
     C                   SUB       FABELN        TOTKÅØ
     C                   SUB       FABELN        TOTKSØ
     C                   SUB       FABELN        TOTÅ
     C                   SUB       FABELN        TOTS
     C                   END
     C     FAK2KU        READE     FAK2                                   34
     C                   END
     C                   END
      ***************************************************
      * Hent inntekter/kostnader fra fakt-linjer
      ***************************************************
     C     FAK2K         SETLL     FAK2                               33
     C     STSUM3        TAG
     C     FAK2K         READE     FAK2                                   33
     C   33              GOTO      STSUM2
     C     FAKDA         IFEQ      'D'                                           2<-B
     C     FAOPKO        OREQ      'D'                                           2<-B
     C                   GOTO      STSUM3
     C                   END                                                     2<-E
      ****************************************************
      * INNTEKTER
      ****************************************************
     C     KODGEK        CHAIN     KODTGE                             33
     C   33              MOVE      ' '           KGEAVR
     C     FAKDA         IFNE      'K'
     C     KGEAVR        IFEQ      'T'                                           2<-B
     C                   ADD       FABELN        TOTISA
     C     FAOPKO        IFLT      'O'
     C                   ADD       FABELN        TOTIÅA
     C                   ADD       FABELN        TOTÅ
     C                   ELSE
     C                   ADD       FABELN        TOTIOA
     C                   ADD       FABELN        TOTO
     C                   END
     C                   ELSE                                                    2<-E
     C                   ADD       FABELN        TOTISG
     C     FAOPKO        IFLT      'O'
     C                   ADD       FABELN        TOTIÅG
     C                   ADD       FABELN        TOTÅ
     C                   ELSE
     C                   ADD       FABELN        TOTIOG
     C                   ADD       FABELN        TOTO
     C                   END
     C                   END                                                     2<-E
     C                   ADD       FABELN        TOTS
      *********************
      * FØRTE KOSTNADER!!
      *********************
     C                   ELSE
N03   * avregningsjusteringer må regnes inn under øvrige
N03  c     THFAKT        ifne      *zeros
N03  c     THFAKT        andne     FAFAKT
N03  c                   move      *blanks       FAVT
N03  c                   end
     C     FAVT          IFNE      AVRTXT
     C     FAVTX         ANDNE     AVRTXD
     C     FAVTX         ANDNE     AVRTXF
S13  C*    FAVTXX        ANDNE     '*T*'
N13  C     FAVTXX        IFNE      '*T*'
     C                   ADD       FABELN        TOTKOØ
     C                   ADD       FABELN        TOTKSØ
     C                   ADD       FABELN        TOTO
     C                   ADD       FABELN        TOTS
      * ta med kostnad nå transportør sender regning
N13  C                   else
N13  C     vmincr        ifeq      1
N13  C     vmincr        oreq      5
N13  C                   ADD       FABELN        TOTKOØ
N13  C                   ADD       FABELN        TOTKSØ
N13  C                   ADD       FABELN        TOTO
N13  C                   ADD       FABELN        TOTS
N13  C                   END
N13  C                   END
     C                   END
     C                   END
     C                   GOTO      STSUM3
     C                   END                                                    1<-E
      *
      * Avregnings-kostnader...
     C     THTOT         IFNE      *ZEROS
     C     VMINCR        ifeq      1
     C     VMINCR        oreq      3
     C                   Z-ADD     0             TOTKOA
     c                   else
     C                   Z-SUB     THTOT         TOTKOA
     C                   END
     C                   ELSE
     C                   Z-ADD     TUTBEL        TMPBL            11 2
     C     TUTVAL        IFNE      FICURR
     C                   MOVE      TUTVAL        TMPVAL            3
     C                   EXSR      VALUT
     C                   END
N13  C     vmincr        ifne      1
N13  C     vmincr        andne     5
     C   32              Z-SUB     TMPBL         TOTKOA
N13  C                   END
     C  N32              Z-SUB     TMPBL         TOTKÅA
     C                   END
     C                   ADD       TOTKOA        TOTKSA
     C                   ADD       TOTKOA        TOTO
     C                   ADD       TOTKOA        TOTS
     C                   ADD       TOTKÅA        TOTKSA
     C                   ADD       TOTKÅA        TOTÅ
     C                   ADD       TOTKÅA        TOTS
      * Hent åpne forv. kostnader. på turnivå
     C     KOSBK2        SETLL     KOSBU2
     C     KOSBK2        READE     KOSBU2                                 33
     C     *IN33         DOWEQ     '0'
N07  C     BUVK          IFEQ      'FEI'
N07  C                   MOVE      'T'           BUFER
N07  C                   END
     C     BUBNR         IFNE      TUTREF
     C     BUFER         ANDNE     'F'
     C     BUVAL         IFNE      FICURR
     C                   MOVE      BUVAL         TMPVAL
     C                   Z-ADD     BUBL          TMPBL
     C                   EXSR      VALUT
     C                   Z-ADD     TMPBL         BUBL
     C                   END
     C                   SUB       BUBL          TOTKÅØ
     C                   SUB       BUBL          TOTKSØ
     C                   SUB       BUBL          TOTÅ
     C                   SUB       BUBL          TOTS
     C                   END
     C     KOSBK2        READE     KOSBU2                                 33
     C                   END
n15  c                   move      TUPRO         uproa             8
N15  c                   call      'SYGE79TCL'
N15  c                   parm                    uproa
N15  c                   parm                    wstvalb           3
N15  c                   parm                    wstbelb          11 2
N15  c                   parm                    avtale            1
N15  C                   z-add     wstbelb       berbud            9 0
N15  c     TUTako        ifeq      'E'
N15  c     avtale        andeq     'A'
N15  c                   move      wstvalb       TUTVAL
N15  c                   move      wstbelb       TUTBEL
N15  c                   end
n16  C                   MOVE      'N'           XXVIS             1
CB   C*                  CALL      'SYTR12A'
CB   C*                  PARM                    TUAVD
CB   C*                  PARM                    TUPRO
CB   C*                  PARM                    XXVIS
CB   C*                  PARM                    N4                4 0
CB   C*                  PARM                    N7                7 0
CB   C*                  PARM                    N8                8 0
N16   *Hvis ennå ikke avregnet, trtype  0 - hent avr.tall til estimert
n16  C  N32VMINCR        IFEQ      0
n16  C     VMINCR        OREQ      4
n16  C     TURKEY        CHAIN     TRAVH1                             32
n16  C     *IN32         IFEQ      '0'
n16   * TREKK UT GAMMEL VERDI / NULL-STILL
n16  C                   SUB       TOTKÅA        TOTKSA
n16  C                   SUB       TOTKÅA        TOTÅ
n16  C                   SUB       TOTKÅA        TOTS
N16  C                   MOVE      *ZEROS        TOTKÅA
n16   * LEGG INN NY VERDI.......
n16  C                   Z-SUB     THTOT         TOTKÅA
n16  C                   ADD       TOTKÅA        TOTKSA
N16  C                   ADD       TOTKÅA        TOTÅ
n16  C                   ADD       TOTKÅA        TOTS
n16   * VERDIENE OVER I 9,0 SKJERMVARIABLE
n16  C                   Z-ADD(H)  TOTKÅA        TOXKÅA
n16  C                   Z-ADD(H)  TOTKSA        TOXKSA
n16  C                   Z-ADD(H)  TOTÅ          TOXÅ
n16  C                   Z-ADD(H)  TOTS          TOXS
n16  C                   END
n16  C                   MOVE      '0'           *IN32
n16  C                   END
n16   *
n16   * Dersom avregn.transportør og summer finnes. Rød om AvrBel foreløpig under beregnet kost
N16  c                   setoff                                       6061
n16  C     VMINCR        ifeq      0
n16  C     VMINCR        oreq      4
n16  C     BERBUD        ifne      0
n16  C     TOXKSA        andne     0
n16  c     TOXKSA        mult      -1            AvrBel            9 0
n16  c     AvrBel        iflt      BERBUD
n16  c                   seton                                        60        Rød / Revers
n16  c                   else
N16  c                   seton                                        61        Grønn / Revers
n16  C                   endif
n16  C                   endif
n16  C                   endif
      * LEGG I AKKUMULERTE VERDIER I SKJERMVARIABLE 9.0
     C                   Z-ADD(H)  TOTIÅA        TOXIÅA            9 0
     C                   Z-ADD(H)  TOTIOA        TOXIOA            9 0
     C                   Z-ADD(H)  TOTISA        TOXISA            9 0
     C                   Z-ADD(H)  TOTIÅG        TOXIÅG            9 0
     C                   Z-ADD(H)  TOTIOG        TOXIOG            9 0
     C                   Z-ADD(H)  TOTISG        TOXISG            9 0
     C                   Z-ADD(H)  TOTKÅA        TOXKÅA            9 0
     C                   Z-ADD(H)  TOTKOA        TOXKOA            9 0
     C                   Z-ADD(H)  TOTKSA        TOXKSA            9 0
     C                   Z-ADD(H)  TOTKÅØ        TOXKÅØ            9 0
     C                   Z-ADD(H)  TOTKOØ        TOXKOØ            9 0
     C                   Z-ADD(H)  TOTKSØ        TOXKSØ            9 0
     C                   Z-ADD(H)  TOTÅ          TOXÅ              9 0
     C                   Z-ADD(H)  TOTO          TOXO              9 0
     C                   Z-ADD(H)  TOTS          TOXS              9 0
      *
     C                   ENDSR
     C***********************************************
     C     VALUT         BEGSR
     C***********************************************
     C*
     C     VALKEY        CHAIN     VALUL01                            39
     C  N39              DO
     C     VALKU2        IFNE      0
     C                   MOVE      VALKU2        VALKU1
     C                   END
     C     TMPBL         MULT      VALKU1        XWORK            15 4
     C     XWORK         DIV(H)    OMRFAK        TMPBL
     C                   END
     C                   ENDSR
      *
