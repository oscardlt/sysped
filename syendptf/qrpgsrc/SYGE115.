********************************************************************
      * RETTINGER I DETTE PROGRAM:
PTFnr:*Sek Sig Vers  Beskrivelse...........................
""""""*"""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""
12XXX * 01 SH  PTF12 start slett
12XXX * 02 SH  PTF12 tar mva fra fraktlinjen
********************************************************************
     FFAK4      IF   E           K DISK
     F                                     RENAME(FAKTR:FAKTR4)
     FFAKT      UF A E           K DISK
     FKODTGE    IF   E           K DISK
     FFIRM      IF   E           K DISK
     C                   EXSR      INIT
     C                   exsr      slett
     C                   EXSR      REGTIL
     C                   seton                                        lr
     C                   return
      *******************************************************************
     C     INIT          BEGSR
      *******************************************************************
     c     *ENTRY        PLIST
     C                   PARM                    UAVD              4 0
     C                   PARM                    UOPD              7 0
     C                   PARM                    HEUR              1
     C                   PARM                    hevalt            3            Nyverdi
     C                   PARM                    hevaltf           3            Førverdi
     C                   PARM                    hevalpa           3            ny prosent
     C                   PARM                    hevalpfa          3            gm prosent
     c                   parm                    part              1
     c                   parm                    partf             1
      * flytter til numeriske verdier
     c                   move      hevalpa       hevalp            3 3
     c                   move      hevalpfa      hevalpf           3 3
     C                   MOVE      UAVD          FAAVD
     C                   MOVE      UOPD          FAOPD
     C     FAK4K         KLIST
     C                   KFLD                    UAVD
     C                   KFLD                    UOPD
     C                   KFLD                    PART
     C     FAK4KF        KLIST
     C                   KFLD                    UAVD
     C                   KFLD                    UOPD
     C                   KFLD                    PARTF
     C     FAKTK         KLIST
     C                   KFLD                    UAVD
     C                   KFLD                    UOPD
     C                   KFLD                    FALI
     C     SLETK         KLIST
     C                   KFLD                    UAVD
     C                   KFLD                    UOPD
     C                   READ      FIRM                                   33
      * sletter gammel linje hvis kode for tillegg endret
      * eller part endret
     c     hevalt        ifne      hevaltf
     c     part          orne      partf
     c                   exsr      delsr
     c                   end
     C                   ENDSR
     c***********************************************************************
     c     REGTIL        begsr
     c***********************************************************************
      * finn om tillegg er låst til FRA,FR1 ELLER FR2
     C     KODGEK        KLIST
     C                   KFLD                    XGEUNI
     C                   KFLD                    WSVK
     C                   MOVE      'GE'          XGEUNI            2
     C                   MOVE      HEVALT        WSVK              3
     C     KODGEK        CHAIN     KODTGE                             36
     c  N36              move      kgetyp        ffftyp            3
     C*
     C* summerer varelinjer av type fra fr1 fr2
     C* (SOM IKKE ER FAKTURERT)
     C*
     c                   move      *zeros        fr12no           13 2
     c                   move      *zeros        fr12va           13 2
N02  c                   move      fakdm         fakdmn            1
     c                   z-add     0             tillli            5 0
     C                   SETOFF                                       33
     C     fak4k         SETLL     FAK4
     C     *IN33         DOWEQ     '0'
     C     fak4k         READE     FAK4                                   33
     c     *in(33)       ifeq      '0'
     C     FAVK          IFEQ      HEVALT
     c                   z-add     fali          tillli
     c                   else
     C                   MOVE      FAVK          WSVK
     C     KODGEK        CHAIN     KODTGE                             36
      * summerer alle FRA FR1 FR2 når tillegg hra blank type
     c  N36ffftyp        ifeq      *blanks
     C  N36KGETYP        ifeq      'FR1'
     c     KGETYP        oreq      'FR2'
     c     KGETYP        oreq      'FRA'
     c                   add       fabeln        fr12no
     c                   add       fabelv        fr12va
N02  c                   move      fakdm         fakdmn            1
     c                   end
     c                   else
      * summerer type lig tilleggets type
     c     ffftyp        ifeq      KGETYP
     c                   add       fabeln        fr12no
     c                   add       fabelv        fr12va
     C                   END
     C                   END
     C                   END
     C                   END
     C                   END
      * oppdaterer hvis linjen eksisterer
     c     tillli        ifne      *zeros
      * ved heur H  og null i summering hent frakt fra linje null som da er fakturert
     c     fr12no        ifeq      0
     C     heur          andeq     'H'
     C                   z-add     0             fali
     c     faktk         chain(n)  fakt                               33
     c     *in33         ifeq      '0'
     c                   add       fabeln        fr12no
     c                   add       fabelv        fr12va
     c                   end
     c                   end
     c                   z-add     tillli        fali
     c     faktk         chain     fakt                               33
     c  N33faopko        iflt      'D'
     c     favk          andeq     hevalt
N12  c                   move      fakdmn        fakdm             1
     c                   z-add     fr12no        fabeln
     c                   z-add     fr12va        fabelv
     C     FABELV        MULT      HEVALP        FABELV
     C     FABELN        MULT      HEVALP        FABELN
     C                   exsr      deci
     c                   update    faktr
     c                   end
      * skriv ny
     c                   else
     C                   move      *zeros        fajour
     C                   MOVE      *ZEROS        FABELU
     C                   MOVE      *BLANKS       FACU33
     C                   MOVE      *BLANKS       FAKDUK
     c                   move      *blanks       favt
     c                   MOVE      hevalt        favk
     c                   z-add     fr12no        fabeln
     c                   z-add     fr12va        fabelv
     C     FABELV        MULT      HEVALP        FABELV
     C     FABELN        MULT      HEVALP        FABELN
     C     FABELN        IFNE      *zeros
     C                   exsr      deci
     C                   CALL      'SYGE06'
     C                   PARM                    UAVD
     C                   PARM                    UOPD
     C                   PARM                    FALI
N02  c                   move      fakdmn        fakdm             1
     C                   EXCEPT    NYFAKU
     c                   end
     c                   end
     c                   endsr
      *
      ***********************************************
     C     DECI          BEGSR
      ***********************************************
      * TEST FIRMS NUMBER OF DECIMALS
      *
      * NO DECIMALS
     C     FIDECI        IFEQ      0
     C                   Z-ADD(H)  FABELN        FABEL0           11 0
     C                   Z-ADD     FABEL0        FABELN
     C                   Z-ADD(H)  FABELU        FABEL0           11 0
     C                   Z-ADD     FABEL0        FABELU
     C                   ELSE
      * 1 DECIMAL
     C     FIDECI        IFEQ      1
     C                   Z-ADD(H)  FABELN        FABEL1           12 1
     C                   Z-ADD     FABEL1        FABELN
     C                   Z-ADD(H)  FABELU        FABEL1           12 1
     C                   Z-ADD     FABEL1        FABELU
     C                   END
     C                   END
      *
     C                   ENDSR
     c***********************************************************************
     c     DELSR         begsr
     c***********************************************************************
     C                   SETOFF                                       33
     C     fak4kf        SETLL     FAK4
     C     *IN33         DOWEQ     '0'
     C     fak4k         READE     FAK4                                   33
     c     *in(33)       ifeq      '0'
     C     FAVK          ANDEQ     HEVALTF
     c     faktk         chain     fakt                               33
     c     *in33         ifeq      '0'
     c     faopko        andle     'D'
     c                   delete    faktr
     c                   end
     c                   end
     c                   enddo
     c                   endsr
     c***********************************************************************
     c     SLETT         begsr
     c***********************************************************************
     C                   SETOFF                                       33
     C     SLETK         SETLL     FAK4
     C     *IN33         DOWEQ     '0'
     C     SLETK         READE     FAK4                                   33
     c     *in(33)       ifeq      '0'
     C     FAVK          andeq     HEVALT
     c     faktk         chain     fakt                               33
     c     *in33         ifeq      '0'
     c                   delete    faktr
     c                   end
     c                   end
     c                   enddo
     c                   endsr
      *
     OFAKTR     EADD         NYFAKU
     O                       FA01
     O                       FALI
     O                       FAAVD
     O                       FAOPD
     O                       FASK
     O                       FAVK
     O                       FAVT
     O                       FAVAL
     O                       FABELV
     O                       FAKDM
     O                       FABELN
     O                       FAKDA
     O                       FAKDUL
     O                       FA01B
     O                       FAKDUK
     O                       FA01B
     O                       FABELU
     O                       FALEVN
     O                       FAKUNR
     O                       FAAVDR
     O                       FAJOUR
     O                       FAAGRN
     O                       FAEXRA
     O                       FACD11
     O                       FACURI
     O                       FACU33
     O                       FADOCN
