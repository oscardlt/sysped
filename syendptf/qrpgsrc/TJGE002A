      *********************************************************************
      *
CRTPG+*  CRTPGM SYSPED/TJGE002A MODULE(*LIBL/TJGE002A *LIBL/INCGI)
CRTPGM*        ACTGRP(*NEW) AUT(*USE)
      *
********************************************************************
      * RETTINGER I DETTE PROGRAM:
PTFnr:*Sek Sig Vers  Beskrivelse...........................
""""""*"""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""
12XXX * 01 JOV PTF12
      *********************************************************************
      /copy SYSPEDS/qrpgsrcpy,hspecs
      /copy SYSPEDS/qrpgsrcpy,hspecsbnd
      *********************************************************************
     FBRIDF     UF   E           K DISK    USROPN
n04  FTRACKF    O  A E           K DISK    USROPN
     F                                     PREFIX(X)
n04  FTRACKL01  IF   E           K DISK    USROPN
     F                                     RENAME(TRACKFR:TRACKFR1)
n04   *--------------------------------------------------------------------
      * Variables common to all CGIs
      *--------------------------------------------------------------------
      /copy SYSPEDS/qrpgsrcpy,prototypeb
      /copy SYSPEDS/qrpgsrcpy,usec
      /copy SYSPEDS/qrpgsrcpy,variables3
      *
      * Varible for
     D WSUSER          S             10
     D WA              S             15
     D JSONstring      S          32000
     D Error           S            150
n11  D                 DS
N11  D  TTDATE                 1      8  0
N11  D  TTAA                   3      4
N11  D  TTMM                   5      6
N11  D  TTDG                   7      8
n11  D                 DS
N11  D  TTTIME                 1      6  0
N11  D  TTTIM4                 1      4  0
N11  D  TTTIT                  1      2
N11  D  TTTIM                  3      4
N11  D  TTTIS                  5      6
      *get input-string
      /copy syspeds/qrpgsrcpy,prolog3

      * Parse input
     C                   exsr      Parse
      * Open files etc
     C                   EXSR      INIT
      *
     C                   EXSR      TESTSR
     C                   if        error = *blanks
     C                   EXSR      ADDSR
     c                   endif
      *
     c                   callp     gethtmlifs(
     C                             '/syspeddev/html/JSON.html':
     C                             '/CGITAG/')
     C                   callp     wrtsection('top')
      *
      * ............................................................................................
      * skriv JSON-Object start..(alltid '{' + x ant param. m/komma mellom (IKKE komma etter siste))
      * ............................................................................................
      *
      /free
        JSONstring='{'
        +'¬user¬ : ¬'+%trim(WSUSER)+'¬, '
        +'¬errMsg¬ : ¬'+%trim(Error)+'¬, '
        +'¬ttavd¬ : ¬'+%trim(%editc(TTAVD:'Z'))+'¬, '
        +'¬ttopd¬ : ¬'+%trim(%editc(TTOPD:'Z'))+'¬, '
        +'¬ttfbnr¬ : ¬'+%trim(%editc(TTFBNR:'Z'))+'¬} ';
      /end-free
      * JSONfix escaper " i tekst,  for deretter å bytte ¬->"
     c                   call      'JSONFIX'
     c                   parm                    JSONstring
     C                   CALLP     updHTMLvar2('JSONstring'
     C                                         :%addr(JSONstring)
     C                                         :%len(JSONstring))
     C                   callp     wrtsection('JSONlin')
      *
      *
      * Quit
     C                   exsr      Exit


      *=====================================================================
      * Close output html and quit
      *=====================================================================
     C     Exit          begsr
      * Lukk fil
     C                   CLOSE     BRIDF
     C  N50              CLOSE     TRACKF

      * Do not delete the call to wrtsection with section name *fini.  It is needed
      * to ensure that all output html that has been buffered gets output.
     C                   callp     wrtsection('*fini')
      * Quit
     C                   MOVE      *ON           *INLR
     C                   return
     C                   endsr
      *
      *********************************************************
     C     TESTSR        Begsr
      *********************************************************
      * serverside tester ?
      *
     C                   endsr
      *********************************************************
     C     ADDSR         Begsr
      *********************************************************
      * Key
     C                   EVAL      xTTAVD = TTAVD
     C                   EVAL      xTTOPD = TTOPD
     C                   EVAL      xTTFBNR= TTFBNR
      * alfa
     C                   EVAL      xTTACTI= TTACTI
     C                   EVAL      xTTTEXT= TTTEXT
     C                   EVAL      xTTUSER= TTUSER
     C                   EVAL      xTTEDEV= TTEDEV
     C                   EVAL      xTTEDRE= TTEDRE
     C                   EVAL      xTTDEPO= TTDEPO
     C                   EVAL      xTTNAME= TTNAME
     C                   EVAL      xTTMANU= TTMANU
     C                   EVAL      xTTTEXL= TTTEXL
     C                   EVAL      xTTLOCC= TTLOCC
     C                   EVAL      xTTLOCT= TTLOCT
     C                   EVAL      xTTURL = TTURL
      * Num
     C                   EVAL      xTTDATE=TTDATE
     C                   EVAL      xTTTIME=TTTIME
     C                   EVAL      xTTTUR =TTTUR
      * IKKE oppdatert er ...
     C                   move      WDT           xTTDATL
     C                   move      WTM           xTTTIML
     C                   eval      xTTMANU='S'
     C                   eval      xTTMAN2='J'
      *                            xTTBRE2
      *                            xTTLEN2
      *
     c                   write     TRACKFR
      *
     c                   endsr
      *
      *********************************************************
     C     Parse         Begsr
      *********************************************************
      * Get input
     C                   EVAL      WSUSER  = zhbgetvar('USER')
     C                   EVAL      WA    = zhbgetvar('TTAVD')
     C                   EVAL      TTAVD = c2n2(WA)
     C                   EVAL      WA    = zhbgetvar('TTOPD')
     C                   EVAL      TTOPD = c2n2(WA)
     C                   EVAL      WA    = zhbgetvar('TTFBNR')
     C                   EVAL      TTFBNR= c2n2(WA)
      * alfa
     C                   EVAL      TTACTI= zhbgetvar('TTACTI')
     C                   EVAL      TTTEXT= zhbgetvar('TTTEXT')
     C                   EVAL      TTUSER= zhbgetvar('TTUSER')
     C                   EVAL      TTEDEV= zhbgetvar('TTEDEV')
     C                   EVAL      TTEDRE= zhbgetvar('TTEDRE')
     C                   EVAL      TTDEPO= zhbgetvar('TTDEPO')
     C                   EVAL      TTNAME= zhbgetvar('TTNAME')
     C                   EVAL      TTMANU= zhbgetvar('TTMANU')
     C                   EVAL      TTTEXL= zhbgetvar('TTTEXL')
     C                   EVAL      TTLOCC= zhbgetvar('TTLOCC')
     C                   EVAL      TTLOCT= zhbgetvar('TTLOCT')
     C                   EVAL      TTURL = zhbgetvar('TTURL ')
      * Num
     C                   EVAL      WA    = zhbgetvar('TTDATE')
     C                   EVAL      TTDATE= c2n2(WA)
     C                   EVAL      WA    = zhbgetvar('TTTIME')
     C                   EVAL      TTTIME= c2n2(WA)
     C                   EVAL      WA    = zhbgetvar('TTTUR ')
     C                   EVAL      TTTUR = c2n2(WA)
      * IKKE basert på inpyt/ikke oppdater
      *                            TTDATL
      *                            TTTIML
      *                            TTMANU
      *                            TTBRE2
      *                            TTLEN2
      *                            TTMAN2
     c                   endsr
      *
      *********************************************************
     C     INIT          Begsr
      *********************************************************
     C                   OPEN      BRIDF
      * Test innlogging
     C     WSUSER        CHAIN     BRIDF                              50
     C     BILIBL        ifeq      *blanks
     C                   callb     'INCGI'
     C                   parm                    BISTDL
     C                   else
     C                   call      BILIBL
     C                   end
     C   50              eval      Error = 'Invalid userID'
     C  N50              OPEN      TRACKF
      * dummy open (aldri) for å få tilfang til fildefinisjon/inputfelt
     c                   if        *in50='0' and *in50='1'
     C                   OPEN      TRACKL01
     C                   endif
      *
     C                   CALL      'SYGE15C'
     C                   PARM                    WDT               8
     C                   PARM                    WTM               6
      *
     c                   endsr
