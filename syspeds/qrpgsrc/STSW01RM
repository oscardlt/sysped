      *********************************************************************
      *  After compiling this RPG MODULE,
      *  create the related program with the following command:
      *
CRTPG+*  CRTPGM SYSPED/STSW01RM
CRTPG+*         MODULE(*LIBL/STSW01RM *LIBL/INCGI *LIBL/STSW01CF)
CRTPGM*         ACTGRP(*NEW) AUT(*USE)
      *
      *********************************************************************
********************************************************************
      * RETTINGER I DETTE PROGRAM:
PTFnr:*Sek Sig Vers  Beskrivelse...........................
""""""*"""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""
11XXX * 01 JOV PTF11 Info om Prioritert gods innført  (midlertidig / test)
11XXX * 02 JOV PTF11 Info om Prioritert gods hentes nå fra T&T
11XXX * 03 JOV PTF11 Kan merke manuelt via avd_opd dersom ikke innland (og ikke kollimerket)
********************************************************************
      *
      /copy syspeds/qrpgsrcpy,hspecs
      /copy syspeds/qrpgsrcpy,hspecsbnd
      *--------------------------------------------------------------------
      * Data base files
      *--------------------------------------------------------------------
     FBRIDF     if   e           k disk    usropn
     FKODTA     if   e           k disk    usropn
     FTURER14   IF   E           K DISK    usropn
     FHEADF     IF   E           K DISK    usropn
     FHEAD14    IF   E           K DISK    usropn
     F                                     RENAME(HEADFR:HEADFR14)
     FHEAD39    IF   E           K DISK    usropn
     F                                     RENAME(HEADFR:HEADFR39)
N03  FFRISOL01  IF   E           K DISK    usropn
     FDOKUF     IF   E           K DISK    usropn
     FDOKUFM    IF   E           K DISK    usropn
     FDOKUFM1   IF   E           K DISK    usropn
     F                                     RENAME(DOKUFMR:DOKUFMR1)
     FHENOK01   IF   E           K DISK    usropn
     FHENOS     IF   E           K DISK    usropn
     FSTSTUR    UF A E           K DISK    usropn
     FSTSOPD    UF A E           K DISK    usropn
     FSTSFBR    UF A E           K DISK    usropn
     FSTSCLI    UF A E           K DISK    usropn
     FSTSCLI1   UF   E           K DISK    usropn
     F                                     RENAME(STSCLIR:STSCLIR1)
     FCUNDC03   IF   E           K DISK    USROPN
N02  FTRACKL02  IF   E           K DISK    USROPN
N03  FBRPARF    if   e           k disk    usropn
      *--------------------------------------------------------------------
      * Prototype defintions and standard system API error structure
      *--------------------------------------------------------------------
      /copy syspeds/qrpgsrcpy,prototypeb
      /copy syspeds/qrpgsrcpy,usec
      *
      *Array over adresser en vil sende mankomail til
     D MAIL            S             70    DIM(5)
      *--------------------------------------------------------------------
      * Variables common to CGI programs
      *--------------------------------------------------------------------
      /copy syspeds/qrpgsrcpy,variables3
      *--------------------------------------------------------------------
      * Variables received from the input string
     DwsPro            s              8  0
     DTA1              s              4
     DTN1              s              8
     DwsPro1           s              8  0
     DTA2              s              4
     DTN2              s              8
     DwsPro2           s              8  0
     DTA3              s              4
     DTN3              s              8
     DwsPro3           s              8  0
     DBILN             s             10
     Dxxmrk1           s             35
     DWsClId           s             20
     Dwsclid18         s             18
     DViaFrbr          s              1
     DUser             s             10
N01  D VERSJ           s             10
N03  D MerkManKll      s              1
      * andre variabler
     D BridSw          s              1
     D WsAnOp          s              4  0
     D WsAnOk          s              4  0
     D WsAnOM          s              4  0
     D WsAnFb          s              4  0
     D WsAnFk          s              4  0
     D WsAnFM          s              4  0
     D WsAnKi          s              4  0
     D WsAnKk          s              4  0
     D WsAnKM          s              4  0
     D Fn              s             10
     D Lib             s             10
     D Mbr             s             10
     D Feil            s             50
     D FeilKode        s              1
     D FeilIni         s              1
N01  D PRITXT          s             50
     D RefrTur         s              1
     D RefrTurA        s              1
     D NattP1          s             20
     D NattP2          s             40
     D SEMI            s              1
      *
     D                 DS
     D  XXREF                  1     48
     D  XTAB                   1     48    DIM(48)
     D                 DS
     D  XXREF2                 1     20
     D  XTAB2                  1     20    DIM(20)
     D                 DS
     D  FMAI00                 1      2
     D  FMMRK1                 3     37
     D  FMMRK18                3     20
     D  FMCLID                 1     20
     D                 DS
     D  XDT                    1      8  0
     D  XDTÅÅ                  1      4  0
     D  XDTMM                  5      6  0
     D  XDTDD                  7      8  0
     D                 DS
     D  XTIME                  1     14  0
     D  XTID                   1      4  0
     D  XDD                    7      8  0
     D  XMM                    9     10  0
     D  XÅÅ                   11     14  0
     D Spaces          s             12a   inz('&nbsp;&nbsp;')
      *--------------------------------------------------------------------
      * Prolog common to CGI programs
      * -Receive input from the remote browser
      *--------------------------------------------------------------------
      /copy syspeds/qrpgsrcpy,prolog3
      *=====================================================================******
      * MAIN PROCESS LINE
      *=====================================================================******
      * Get program start time for calculating execution time
     C                   time                    timedata1
      * Parse input string
     C                   EXSR      PARSE
      ***
      * Set output skeleton html member name
     C                   exsr      SetSkl
      * Read skeleton output html, etc.
     C                   callp     gethtml(fn:lib:mbr:'/CGITAG/')
      * User changed?? - Set libl ..
     C                   exsr      Init
      *------------------
      * Write sections of HTML.
      *
      * Her er HOVED logikk-rutine
     C                   exsr      SetTop
      *
     C     SEMI          IFNE      'Y'
     C                   callp     wrtsection('top')
     C     FeilIni       IFNE      'X'
     C                   time                    timedata2
     C     timedata2     subdur    timedata1     ms:*ms
     C                   eval      sec = ms / 1000000
     C                   callp     updhtmlvar('runtime':
     C                             %trim(%editw(sec:'     0 .   ')))
     C                   callp     wrtsection('Bot')
     C                   else
     C                   callp     wrtsection('FeilI')
     C                   end
     C                   else
     C                   callp     wrtsection('all')
     C                   end
      *
      * Do not delete the call to wrtsection with section name *fini.  It is needed
      * to ensure that all output html that has been buffered gets output.
     C                   callp     wrtsection('*fini')
      *
      *
     C                   close     BRIDF
     C                   close     KODTA
     C                   close     TURER14
     C                   close     HEADF
     C                   close     HEAD14
     C                   close     HEAD39
N03  C                   close     FRISOL01
     C                   close     DOKUF
     C                   close     DOKUFM
     C                   close     DOKUFM1
     C                   close     STSTUR
     C                   close     STSOPD
     C                   close     STSFBR
     C                   close     STSCLI
     C                   close     STSCLI1
     C                   close     CUNDC03
     C                   close     henok01
     C                   close     henos
N02  C                   close     TRACKL02
N03  C                   close     BRPARF
     C                   eval      *inlr = *on
     C                   RETURN
      *
      *=====================================================================******
      * Parse input
      *=====================================================================******
     C     Parse         begsr
     C                   eval      USER     = zhbgetvar('USER')
     C                   eval      TN1      = zhbgetvar('TN1   ')
     C                   eval      TN2      = zhbgetvar('TN2   ')
     C                   eval      TN3      = zhbgetvar('TN3   ')
     C                   eval      TA1      = zhbgetvar('TA1   ')
     C                   eval      TA2      = zhbgetvar('TA2   ')
     C                   eval      TA3      = zhbgetvar('TA3   ')
     C                   eval      WSPRO    = c2n2(TN1   )
     C                   eval      WSPRO1   = c2n2(TN1   )
     C                   eval      WSPRO2   = c2n2(TN2   )
     C                   eval      WSPRO3   = c2n2(TN3   )
      * Bilnr er blank 1 gang. Hentes i INITTUR repeteres så senere..
     C                   eval      BILN   = zhbgetvar('BILN')
     C                   eval      WSCLID   = zhbgetvar('CLID')
     C                   eval      SEMI    = zhbgetvar('SEMI')
N01  C                   eval      VERSJ = zhbgetvar('V')
      *
     C                   endsr
      *=====================================================================
      * EXECUTE LOGIC / Set html output variables for section /$top
      *=====================================================================
     C     SetTop        begsr
     C                   Move      *blanks       FeilINI
     C                   Move      *blanks       Feil
     C                   Move      *blanks       FeilKode
N01  C                   Move      *blanks       PRITXT                         Prioritert gods?
      *
     C     wsclid        ifeq      '99'
      * CLID = 99, KOMMER INN FRA TURBILDET.. - INITIER (men ikke v/turnr 0)
     C     WSPRO         Ifne      *ZEROS
     C                   EXSR      INITTUR
     C                   end
      *
     C                   else
      * CLID ULIK 99, KOMMER INN FRA skyte-bilde
     C     WSCLID        IFNE      *BLANKS
     C                   EXSR      TESTB2
      * Meld evt feil...
     C     *IN30         IFEQ      *ON
     C   41              eval      feil = wsclid + ' er ugyldig'
     C   42              eval      feil = wsclid + ' ER ALT lest/skutt '
     C   43              eval      feil = wsclid + ' tilhører IKKE turen'
     C   44              eval      feil = wsclid + ' tilhører avd '+heavda
     C   30              eval      feilKode = 'X'
     C                   END
     C                   END
      *
     C                   end
      *
      * HENT ANTALL FOR Å VISE PÅ SKJERMEN
     C                   MOVE      *ZEROS        WSANOP
     C                   MOVE      *ZEROS        WSANOK
     C                   MOVE      *ZEROS        WSANFB
     C                   MOVE      *ZEROS        WSANFK
     C                   MOVE      *ZEROS        WSANKI
     C                   MOVE      *ZEROS        WSANKK
     c                   movel     wspro1        wspro
      *  tur 1
     C                   EXSR      HANTS
      * +tur 2
     c     wspro2        ifne      *zeros
     c                   movel     wspro2        wspro
     C                   EXSR      HANTS
     c                   end
      * +tur 3
     c     wspro3        ifne      *zeros
     c                   movel     wspro3        wspro
     C                   EXSR      HANTS
     c                   end
      *
      * TURENS ANTAL OPPDRAG / ANTALL OPPDRAG KONTROLLERT.
     C     WSANOP        COMP      WSANOK                               5050
      *
N01  c                   if        Versj>='01.26'
N01  C                   callp     updhtmlvar('FEILKOD':PRITXT+';'+FeilKode)
N01  c                   else
     C                   callp     updhtmlvar('FEILKOD':FeilKode)
N01  c                   endif
     C                   callp     updhtmlvar('FEILTXT':Feil)
      *
      * Repeat UserId for the next invocation
BODY C                   callp     updhtmlvar('BODYCLASS':'class='+BIFARG)
     C                   callp     updhtmlvar('User':user)
     C                   callp     updhtmlvar('TN1   ':TN1   )
     C                   callp     updhtmlvar('TN2   ':TN2   )
     C                   callp     updhtmlvar('TN3   ':TN3   )
     C                   callp     updhtmlvar('TA1   ':TA1   )
     C                   callp     updhtmlvar('TA2   ':TA2   )
     C                   callp     updhtmlvar('TA3   ':TA3   )
     C                   callp     updhtmlvar('BILN':biln)
      * Anonym brulker (NN)
     C     BIPO          ifeq      *blanks
     C                   callp     updhtmlvar('ANONYM':'Y')
     C                   else
     C                   callp     updhtmlvar('ANONYM':'N')
     C                   end
      *
     C* Ant. oppdrag totalt / kontrollert/Manko
     C                   callp     updhtmlvar('OPD':
     C                             %trim(%editc(wsanop:'3')))
     C                   callp     updhtmlvar('OPDK':
     C                             %trim(%editc(wsanok:'3')))
     C     wsanop        sub       wsanok        WsAnOm
     c     WsAnOm        IFLT      *ZEROS
     c                   MOVE      *ZEROS        WsAnOm
     C                   end
     C                   callp     updhtmlvar('OPDM':
     C                             %trim(%editc(Wsanom:'3')))
     C* Ant. oppdrag totalt / kontrollert/Manko
     C                   callp     updhtmlvar('FBR':
     C                             %trim(%editc(Wsanfb:'3')))
     C                   callp     updhtmlvar('FBRK':
     C                             %trim(%editc(wsanfk:'3')))
     C     wsanfb        sub       wsanfk        wsanfm
     c     wsanfm        IFLT      *ZEROS
     c                   MOVE      *ZEROS        wsanfm
     C                   end
     C                   callp     updhtmlvar('FBRM':
     C                             %trim(%editc(wsanfm:'3')))
     C* Ant. oppdrag totalt / kontrollert/Manko
     C                   callp     updhtmlvar('KLI':
     C                             %trim(%editc(wsanki:'3')))
     C                   callp     updhtmlvar('KLIK':
     C                             %trim(%editc(wsankk:'3')))
     C     wsanki        sub       wsankk        wsankm
     c     wsankm        IFLT      *ZEROS
     c                   MOVE      *ZEROS        wsankm
     C                   end
     C                   callp     updhtmlvar('KLIM':
     C                             %trim(%editc(wsankm:'3')))
      * Nullstill WSCLID
     c                   move      wsclid        gmclid           20
     c                   move      *blanks       wsclid
     C                   callp     updhtmlvar('clid':spaces)
      *
     C                   endsr
      *
      *
     C***********************************************
     C     TESTB2        BEGSR
     C***********************************************
      * SR KJØRES KUN NÅR WSCLID ULIK BLANK (og ULIK 99=INIT)
      * denne rutinen er blitt unødig komplisert med LAANGE if ... else...
      * burde vært skrevet om til å teste ett og ett vilkår / evt hoppe ut
      * (slik som i rutine SR401)
     C                   MOVE      *BLANKS       WSCLID3           3
     C                   MOVE      *BLANKS       WSCLID10         10
N03  C                   MOVE      *BLANKS       WSCLID5_5         1
     C                   MOVEA     '00000'       *IN(41)
     C                   move      'N'           RefrTur
     C                   move      'N'           RefrTurA
     C                   move      'N'           ViaFrbr
     C                   move      'N'           NyttOPD           1
      *
     C     StrTestb      tag
     c                   move      wspro1        wspro
     C     CLIK1         CHAIN     STSCLI1                            30
     c     *in30         ifeq      '1'
     c     wspro2        andne     *zeros
     c                   move      wspro2        wspro
     C     CLIK1         CHAIN     STSCLI1                            30
     c                   end
     c     *in30         ifeq      '1'
     c     wspro3        andne     *zeros
     c                   move      wspro3        wspro
     C     CLIK1         CHAIN     STSCLI1                            30
     c                   end
      *
     C     *IN30         IFEQ      '1'                                          1<-B
      * finner ikke kolli-id i skyte-fila
     C                   MOVE      *OFF          *IN30
      * ER DET FRAKTBREV SOM ER SKUTT? (begynner på 401 eller gml 10 lang)
     C                   MOVEL     WSCLID        WSCLID3
     C                   MOVE      WSCLID        WSCLID10
N03  c                   eval      WSCLID5_5=%subst(WSCLID:5:1)
     C     WSCLID3       IFEQ      '401'                                        1<-B
     C     WSCLID10      OREQ      *BLANKS                                      1<-B
N03  C     WSCLID5_5     OREQ      '_'                                          1<-B
     C                   EXSR      SR401
     c   30              goto      UtTestb
     C                   GOTO      FBROK
     C                   END
      * Kolli finnes ikke i skytelista, er det gyldig likevel??
     C                   MOVE      WSCLID        WSCLID18
     C                   MOVEL     WSCLID18      XXMRK1
     C                   MOVE      'J'           Gethent           1
     C                   MOVE      'N'           FantHent          1
     c     TstDokufm     tag
     C     DOKFM1K       SETLL     DOKUFM1
     C                   READ      DOKUFM1                                30
     C  N30FMMRK18       COMP      WSCLID18                           3030
     C  N30HEAKEY        CHAIN     HEADF                              30
      * 30 on-kolli finnes ikke i dokufm - finnes det i hentesystemet??
     c     *in30         ifeq      *ON
     c     GetHent       andeq     'J'
     c                   exsr      HenteSR
     c     FantHent      cabeq     'J'           TstDokufm
     c     FantHent      cabeq     'F'           UtTestb
     c                   end
      *
     C     *IN30         IFEQ      '0'                                          1<-B
      * Trigge initiering gjennom skyting av kolli...
     C     WSPRO         IFEQ      *ZEROS
     c     HEPRO         ANDNE     *ZEROS
     C                   move      hepro         wspro
     C                   exsr      INITTUR
     c   30              goto      UtTestb
     c                   goto      StrTestb
     C                   end
      * Ikke turdisponert
     C     HEPRO         IFEQ      *ZEROS
     C                   EXSR      SettPaTur
     c   30              goto      UtTestb
     c                   goto      StrTestb
     C                   end
      *
     c     HEPRO         IFEQ      WSPRO1
     c     HEPRO         oreq      WSPRO2
     c     HEPRO         oreq      WSPRO3
     c                   move      hepro         wspro
      * Kolli er gyldig, på riktig tur - refresh (nye posisjoner)
     c     RefrTur       Ifeq      'N'
     c     HEPRO         ANDNE     *ZEROS
     C                   move      'J'           RefrTur
     C                   EXSR      REFRESH
     c                   goto      StrTestb
     C                   end
     C                   else
      * ok. kolli men tilhører annen tur
     C                   MOVE      *ON           *IN30
     C                   MOVE      *ON           *IN43
      * ok. turen på annen avdeling (sjekk 4 første)
     C                   move      Heavd         heavda            4
     C     TA1           IFne      Heavda                                        2<-B
     C     TA2           andne     Heavda                                        2<-B
     C     TA3           andne     Heavda                                        2<-B
     C                   MOVE      *ON           *IN44
     C                   MOVE      *BLANKS       XXSCTX           55
     C                   EVAL      XXSCTX = 'er FREMMED kolli med kolli-ID '+
     C                                       WSCLID
     C                   exsr      SndMail
     C                   end
     C                   end
     C                   end
      *
      * KOLLI-ID FINNES IKKE , feilindikator
     C                   MOVE      *ON           *IN41
     C                   ELSE                                                   1
      *
      * KOLLI-ID finnes i skytelista - vellykket les.
     C     SCSTAT        IFEQ      'X'                                           2<-B
      * KOLLI-ID ER KONTROLLERT FRA FØR.
     C                   MOVE      *ON           *IN42
     C                   MOVE      *ON           *IN30
     C     FBRK1         CHAIN(N)  STSFBR                             33
     C     OPDK1         CHAIN(N)  STSOPD                             33
     C     TURKEY        CHAIN(N)  STSTUR                             33         *FIL
     C                   ELSE                                                    2
     C     FBROK         TAG
     c* Oppdraget er ikke lenger på tur?? Fjerne fra skyteliste.Varsle!!
     C                   EXSR      DLTTST
     C   30              GOTO      UTTESTB
      *
     C                   TIME                    XTIME
     C                   MOVE      XDD           XDTDD
     C                   MOVE      XMM           XDTMM
     C                   MOVE      XÅÅ           XDTÅÅ
     C                   MOVE      XDT           SCDT
     C                   MOVE      XTID          SCTID
     C                   MOVE      User          SCUSER
     C                   MOVE      'X'           SCSTAT
     C     FBRK1         CHAIN     STSFBR                             33
     C     ViaFrbr       IFNE      'J'
     C                   ADD       1             SFANKK                          *FIL
     C                   ADD       1             WSANKK                          *PÅ SKJERM
     c                   ELSE
     C                   z-add     SFANKI        SFANKK
     c                   END
     C     SFANKK        IFGE      SFANKI                                         3<-B
     C                   MOVE      'X'           SFSTAT
     C     OPDK1         CHAIN     STSOPD                             33
     C                   ADD       1             SOANFK                          *FIL
     C                   ADD       1             WSANFK                          *PÅ SKJERM
     C     SOANFK        IFGE      SOANFB                                          4<-B
     C                   MOVE      'X'           SOSTAT
     C     TURKEY        CHAIN     STSTUR                             33         *FIL
     C                   ADD       1             STANOK                          *SKJERM/FIL
     C                   ADD       1             WSANOK                          *SKJERM/FIL
      * Antallet Kontrollert på lest tur..
     C     STANOK        IFGE      STANOP                                           5<-B
     C                   Move      'J'           RefrTurA
     C                   END                                                        5<-E
     C                   UPDATE    STSTURR
     C                   END                                                       4<-E
     C                   UPDATE    STSOPDR
     C                   END                                                      3<-E
     C                   UPDATE    STSFBRR
     C                   END                                                     2<-E
      * Når lest på fr.brevsnivå skal ikke STSCLI oppdateres..
     C     ViaFrbr       IFNE      'J'
     C                   UPDATE    STSCLIR1
     C                   END                                                    1<-E
      * Siste skyting medførte ferdig..- Auto refresh / gi varsel.
     C     RefrTurA      IFeq      'J'                                              5<-B
     C     NyttOpd       ANDNE     'J'
     C                   exsr      refresh
     C                   SETON                                        30
     c                   move      wspro         pro
     C                   eval      feil = 'Tur '+PRO+' er auto-oppfrisket'
     c
     C     STANOK        IFGE      STANOP                                           5<-B
      * en tur er frisket/ferdig.. sjekk de inntil 2 andre
     c                   z-add     stanok        wsanok
     c                   z-add     stanop        wsanop
     c                   move      wspro         TmpPro            8 0
     c     wspro1        IFNE      *zeros
     c     wspro1        ANDNE     TmpPro
     c                   move      wspro1        wspro
     C                   exsr      refresh
     c                   add       stanok        wsanok
     c                   add       stanop        wsanop
     C                   END                                                    1<-E
     c     wspro2        IFNE      *zeros
     c     wspro2        ANDNE     TmpPro
     c                   move      wspro2        wspro
     C                   exsr      refresh
     c                   add       stanok        wsanok
     c                   add       stanop        wsanop
     C                   END                                                    1<-E
     c     wspro3        IFNE      *zeros
     c     wspro3        ANDNE     TmpPro
     c                   move      wspro3        wspro
     C                   exsr      refresh
     c                   add       stanok        wsanok
     c                   add       stanop        wsanop
     C                   END                                                    1<-E
     C     WSANOK        IFGE      WSANOP                                           5<-B
     C                   eval      feil = 'FERDIG SKUTT, Fullfør eller Parker.'
     C                   END                                                    1<-E
     C                   END                                                    1<-E
     C                   END                                                    1<-E
      *
     C                   END                                                    1<-E
      *
     C     UTTESTB       ENDSR
      *
     C***********************************************
     C     SR401         BEGSR
     C***********************************************
      * Skyting basert på Sendingsnr...
      * sendingen må finnes..
N03   * via avd_oppd (manuell merking via oppdragsliste)
N03  c                   if        %subst(WSCLID:5:1)='_'
N03  c                   move      *zeros        HEAVDA            4
N03  c                   move      *zeros        HEOPDA            7
N03  c                   eval      HEAVDA= %subst(WSCLID:1:4)
N03  c                   eval      HEOPDA= %subst(WSCLID:6:7)
N03  c                   move      HEAVDA        FMAVD
N03  c                   move      HEOPDA        FMOPD
N03  C     HEAKEY        CHAIN     HEADF                              30
N03  c                   else
N03   * eller via sendingsnr innland
     c     wsclid        chain     Head39                             30
N03  c                   endif
N03   * Skyting via sendingsnr ??
N03  c     *in30         ifeq      '1'
N03  c                   setoff                                       30
N03  C                   eval      FSSOK = %subst(WSCLID:4:17)
N03  C     IFBkey        chain     FRISOL01                           30
N03  C  N30              eval      FMAVD = FSAVD
N03  C  N30              eval      FMOPD = FSOPD
N03  c  N30HeaKey        chain     Headf                              30
N03   * Hvis oppdrag bak fraktbrevet hadde utk-oppdrag under seg så bruk utkj-oppdraget
N03  C  N30TROPD2        ifne      *zeros
N03  C                   MOVE      TRAVD2        FMAVD
N03  C                   MOVE      TROPD2        FMOPD
N03  C     HEAKEY        CHAIN     HEADF                              33
N03  c                   endif
N03  c                   endif
     C     *in30         IFEQ      '1'
     C                   eval      feil = 'UKjent sending lest'
     c   30              goto      Ut401
     C                   end
      *
      * Sendingen kan IKKE være kollimerket (må da lese kolli for kolli)
      * (Selv når fraktbrev ikke finnes er kollimerking lagret på fb.nr 001)
N03  c                   IF        MerkManKll<>'J'
     C                   Z-add     1             DFFBNR
S03  C*    DOKFMK        chain     DOKUFM                             33
N03  C     DOKFMK        setll     DOKUFM
N03  C     NESTEKLL      TAG
N03  C     DOKFMK        Reade     DOKUFM                                 33
N03  c     *IN33         IFEQ      '0'
N03  C                   IF        FMST<>'I' AND  FMST<>'E'
N03  C                   GOTO      NESTEKLL
N03  C                   ENDIF
     C                   SETON                                        30
     C                   eval      feil = 'KOLLIMERKET skyt kll.'
     c   30              goto      Ut401
     c                   end
N03  c                   ENDIF
      *
      * hente tur via fraktbrev..
     C     WSPRO         IFEQ      *ZEROS
     c     HEPRO         ANDNE     *ZEROS
     C                   move      hepro         wspro
     C                   exsr      INITTUR
     c   30              goto      Ut401
     C                   end
      * Sending er ikke på tur nå
     c     HEPRO         IFEQ      *zeros
     C                   EXSR      SettPaTur
     c   30              goto      Ut401
     c                   end
      *
      * Sending må tilhøre rett tur
     c     HEPRO         IFNE      WSPRO1
     c     HEPRO         ANDNE     WSPRO2
     c     HEPRO         ANDNE     WSPRO3
     C                   SETON                                        30
     C                   eval      feil = 'Sendingen tilhører IKKE turen'
      * Annen avdeling?? - i så fall send mail...
     C                   move      Heavd         heavda            4
     C     TA1           IFne      Heavda                                        2<-B
     C     TA2           ANDNE     Heavda                                        2<-B
     C     TA3           ANDNE     Heavda                                        2<-B
     C                   eval      feil = 'Sending tilh. IKKE tur/+
     C                                     Tilh. avd '+heavda
     C                   MOVE      *BLANKS       XXSCTX           55
     C                   EVAL      XXSCTX = 'er FREMMED kolli '
     C                   exsr      SndMail
     C                   end
      * det var IKKE match med noen av turene - hopp ut
     C                   goto      Ut401
     C                   else
      * matcher en av max 3 turer - sett rett tur i key
     C                   move      hepro         wspro
     C                   end
      *
      * Sending må finnes i "skyteliste" for aktuell tur
     C     OPDKEY        CHAIN(N)  STSFBR                             33
     C     *iN33         IFeq      '1'
     C                   EXSR      REFRESH
     C     OPDKEY        CHAIN(N)  STSFBR                             33
     C                   end
     C     *iN33         IFeq      '1'
     C                   SETON                                        30
     C                   eval      feil = 'Sendingen IKKE i skyteliste'
     c   30              goto      Ut401
     C                   end
      *
      * Fraktbrev må ikke være skutt før..
     c     SFSTAT        IFNE      ' '
     C                   SETON                                        30
     C                   eval      feil = 'Sendingen ER alt skutt'
     c   30              goto      Ut401
     C                   end
      *
      * skal IKKE finnes i Koli-id fila
N03  c                   IF        MerkManKll<>'J'
     C     OPDKEY        CHAIN(N)  STSCLI                             33
     c     *IN33         IFEQ      *OFF
     C                   SETON                                        30
     C                   eval      feil = 'Sendingen er Kolli-Merket, +
     C                             skyt Kolli'
     C                   goto      ut401
     C                   end
N03  c                   ENDIF
      *
      * ALT OK.
      * Klargjør nøkkel for oppdat av STSFBR/STSOPD... i sr "settop"
     C                   MOVE      'J'           ViaFrbr
     c                   move      ' '           scstat
     c                   move      heavd         scavd
     c                   move      heopd         scopd
     c                   z-add     1             scfbnr
      *
     C     Ut401         ENDSR
      *
      *=====================================================================******
      * Send mail vedr FEILPLASSERT KOLLI/SENDING
      *=====================================================================******
     C     SndMail       begsr
     c     wsclid        ifeq      gmclid
     c                   goto      NoMail
     c                   end
      * Interne bruker som skal ha mail (max 5)
     c                   clear                   mail
     c                   move      *zeros        mn                2 0
     C     MAILKEYI      SETLL     CUNDC03
     C     MAILKEYI      READE     CUNDC03                                35
     C   35              GOTO      NoMail
     C                   DOW       *IN35 = *OFF
     c                   add       1             mn
     c                   movel     CEMAIL        mail(mn)
     c     mn            ifeq      1
     c                   movel     CPHONE        XXAVID           10
     c                   movel     CMOBIL        XXAVADR          10
     C                   MOVEL     CTYPE         XXSIGN           30
     c                   end
     c     mn            cabeq     5             utmail
     C     MAILKEYI      READE     CUNDC03                                35
     C  N35              ENDDO
      *
     c     utmail        tag
      *
     C     XXAVID        IFEQ      *BLANKS
     c                   movel     '*CURRENT'    XXAVID
     c                   move      *BLANKS       XXAVADR
     c                   END
      *
     c     WSPRO         ifeq      *zeros
     c                   move      wspro1        wspro
     c                   end
     C                   MOVEL     BILN          XXBIL            10
     C                   MOVEL     WSPRO         XXTUR             8
     C                   MOVEL     HEAVDA        XXAVD             4
     C                   MOVEL     HXSNDN        XXSNR            20
     C                   MOVEL     HENAS         XXFRA            30
     C                   MOVEL     HENAK         XXTIL            30
     C                   MOVEL     HEADK1        XXTIL1           30
     C                   MOVEL     HEADK3        XXTIL3           30
     C                   MOVEL     BIBESK        XXUSRN           30
     C                   MOVEL     MAIL(1)       XXINT1           70
     C                   MOVEL     MAIL(2)       XXINT2           70
     C                   MOVEL     MAIL(3)       XXINT3           70
     C                   MOVEL     MAIL(4)       XXINT4           70
     C                   MOVEL     MAIL(5)       XXINT5           70
     C                   CALLB     'STSW01CF'
     C                   PARM                    XXBIL
     C                   PARM                    XXTUR
     C                   PARM                    XXSCTX
     C                   PARM                    XXAVD
     C                   PARM                    XXSNR
     C                   PARM                    XXFRA
     C                   PARM                    XXTIL
     C                   PARM                    XXTIL1
     C                   PARM                    XXTIL3
     C                   PARM                    XXUSRN
     C                   PARM                    XXAVID
     C                   PARM                    XXAVADR
     C                   PARM                    XXINT1
     C                   PARM                    XXINT2
     C                   PARM                    XXINT3
     C                   PARM                    XXINT4
     C                   PARM                    XXINT5
      *
     C     NoMail        endsr
      *
     C***********************************************
     C     INITTUR       BEGSR
     C***********************************************
      *
      * tur 1
     C     WSPRO         CHAIN     TURER14                            30
     C   30              move      wspro         PRO
     C   30              eval      feil = 'Finner ikke angitt tur ' + PRO
     C     *IN30         cabeq     '1'           UtIni                          1<-B
     c                   movel     TUAVD         TA1
     c                   movel     TUBILN        BILN
     C                   exsr      INITTURB
     C     *IN30         cabeq     '1'           UtIni                          1<-B
      *
      * tur 2
     c     wspro2        ifne      *zeros
     c     wspro2        andne     wspro1
     c     wspro2        andne     wspro3
     C                   move      wspro2        wspro
     C     WSPRO         CHAIN     TURER14                            30
     C   30              move      wspro         PRO
     C   30              eval      feil = 'Finner ikke angitt tur ' + PRO
     C     *IN30         cabeq     '1'           UtIni                          1<-B
     c                   movel     TUAVD         TA2
     C                   exsr      INITTURB
     C     *IN30         cabeq     '1'           UtIni                          1<-B
     c                   end
      *
      * tur 3
     c     wspro3        ifne      *zeros
     c     wspro3        andne     wspro1
     c     wspro3        andne     wspro2
     C                   move      wspro3        wspro
     C     WSPRO         CHAIN     TURER14                            30
     C   30              move      wspro         PRO
     C   30              eval      feil = 'Finner ikke angitt tur ' + PRO
     C     *IN30         cabeq     '1'           UtIni                          1<-B
     c                   movel     TUAVD         TA3
     C                   exsr      INITTURB
     C     *IN30         cabeq     '1'           UtIni                          1<-B
     c                   end
      *
     c     UtIni         TAG
     C   30              Move      'X'           FeilINI
     C   30              Move      'X'           FeilKode
     C                   endsr
      *
     C***********************************************
     C     INITTURB      BEGSR
     C***********************************************
      * tur kan være fanget opp via skyting - bevar for HTMLVAR
     c     TN1           IFEQ      *blanks
     C                   move      wspro         TN1
     c                   end
      * bevar bilnr fra 1. tur
     c     BILN          IFEQ      *blanks
     C                   move      TUBILN        BILN
     c                   end
      * Ved flere turer i samme skyting må bilnr matche
     C     TUBILN        COMP      BILN                               3030
     C   30              move      tupro         PRO
     C   30              eval      feil = 'Bil '+TUBILN+' tur ' +PRO+
     C                                    ' er feil'
     C     *IN30         cabeq     '1'           UtIniB                         1<-B
      * Sjekk om den finnes i skytefila fra før...
     C     TURKEY        CHAIN(N)  STSTUR                             33
     C     *IN33         IFEQ      '1'                                          1<-B
      * finnes IKKE fra før...
      * TØM FØRST EVT GAMLE DATA PÅ STATUSFIL UNDERREGISTER OPD/FBR/CLI
     C                   EXSR      TØMUNDER
      * legg ut STSTURR - kjør så "refresh")
     C                   CLEAR                   STSTURR
     C                   MOVE      *BLANKS       STTYPE
     C                   MOVE      WSPRO         STPRO
     C                   WRITE     STSTURR
     C                   ELSE                                                   1<-E
      * finnes fra før... ferdig skutt?
     C     STSTAT        COMP      ' '                                3030
     C   30              move      wspro         pro               8        T+
     C   30              eval      feil = 'Tur '+PRO+' ferdig skutt ('+STSTAT+
     C                             ') Trykk Avbryt!!'
     C                   END                                                    1<-E
      * refresh både ved ny / gjenopptakelse av skyting
     C  N30              EXSR      REFRESH
      *
     C     UtIniB        ENDSR
      *
     C***********************************************
     C     TØMUNDER      BEGSR
     C***********************************************
      * OPD
     C     TURKEY        SETLL     STSOPD
     C     TURKEY        READE     STSOPD                                 33
     C     *IN33         DOWEQ     '0'                                           2<-B
     C                   DELETE    STSOPDR
     C     TURKEY        READE     STSOPD                                 33
     C  N33              ENDDO                                                   2<-E
      * FBR
     C     TURKEY        SETLL     STSFBR
     C     TURKEY        READE     STSFBR                                 33
     C     *IN33         DOWEQ     '0'                                           2<-B
     C                   DELETE    STSFBRR
     C     TURKEY        READE     STSFBR                                 33
     C  N33              ENDDO                                                   2<-E
      * CLI
     C     TURKEY        SETLL     STSCLI
     C     TURKEY        READE     STSCLI                                 33
     C     *IN33         DOWEQ     '0'                                           2<-B
     C                   DELETE    STSCLIR
     C     TURKEY        READE     STSCLI                                 33
     C  N33              ENDDO                                                   2<-E
      *
      *
     C                   ENDSR
      *
     C***********************************************
     C     HETTOPD       BEGSR
     C***********************************************
     C                   ADD       1             STANOP
     C                   CLEAR                   STSOPDR
     C                   MOVE      STTYPE        SOTYPE
     C                   MOVE      WSPRO         SOPRO
     C                   MOVE      HEAVD         SOAVD
     C                   MOVE      HEOPD         SOOPD
      *
     C                   EXSR      HFBR
      *
     C                   WRITE     STSOPDR
      *
     C                   ENDSR
      *
     C***********************************************
     C     HFBR          BEGSR
     C***********************************************
     C     DOKUFK        SETLL     DOKUF
     C     DOKUFK        READE     DOKUF                                  33
      * ingen fraktbrev, simuler nr 001 ("frittstående" edimottatte CLID!!!)
     C     *in33         ifeq      '1'
     C                   Z-add     1             DFFBNR
     C                   goto      dummyf
     C                   end
     C     *IN33         DOWEQ     '0'
     C     dummyf        tag
     C                   ADD       1             SOANFB
     C                   CLEAR                   STSFBRR
     C                   MOVE      SOTYPE        SFTYPE
     C                   MOVE      WSPRO         SFPRO
     C                   MOVE      HEAVD         SFAVD
     C                   MOVE      HEOPD         SFOPD
     C                   MOVE      DFFBNR        SFFBNR
      *
     C                   EXSR      HCLI
      *
     C                   WRITE     STSFBRR
     C     DOKUFK        READE     DOKUF                                  33
     C  N33              ENDDO
      *
     C                   ENDSR
      *
     C***********************************************
     C     HCLI          BEGSR
     C***********************************************
     C     DOKFMK        SETLL     DOKUFM
     C     DOKFMK        READE     DOKUFM                                 33
     C     *IN33         DOWEQ     '0'
N03  C                   IF        FMST='I' OR  FMST='E'
     C                   ADD       1             SFANKI
     C                   CLEAR                   STSCLIR
     C                   MOVE      SFTYPE        SCTYPE
     C                   MOVE      WSPRO         SCPRO
     C                   MOVE      HEAVD         SCAVD
     C                   MOVE      HEOPD         SCOPD
     C                   MOVE      FMFBNR        SCFBNR
     C                   MOVE      FMCLID        SCCLID
     C                   WRITE     STSCLIR
N03  C                   ENDIF
     C     DOKFMK        READE     DOKUFM                                 33
     C  N33              ENDDO
      *
     C                   ENDSR
      *
     C***********************************************
     C     HANTS         BEGSR
     C***********************************************
      * HENT TURENS TOTALER FOR VISING PÅ SKJERM
     C     TURKEY        CHAIN(N)  STSTUR                             33
      * oppdrag   / Opd. KONTROLLERT.
     C                   ADD       STANOP        WSANOP
     C                   ADD       STANOK        WSANOK
      * FRAKTBREV / FBR. KONTROLLERT.
     C     TURKEY        SETLL     STSOPD
     C     TURKEY        READE(N)  STSOPD                                 33
     C     *IN33         DOWEQ     '0'                                          1<-B
     C                   ADD       SOANFB        WSANFB
     C                   ADD       SOANFK        WSANFK
     C     TURKEY        READE(N)  STSOPD                                 33
     C  N33              ENDDO                                                  1<-E
      * KOLLIID / KLID KONTROLLERT.
     C     TURKEY        SETLL     STSFBR
     C     TURKEY        READE(N)  STSFBR                                 33
     C     *IN33         DOWEQ     '0'                                          1<-B
     C                   ADD       SFANKI        WSANKI
     C                   ADD       SFANKK        WSANKK
     C     TURKEY        READE(N)  STSFBR                                 33
     C  N33              ENDDO                                                  1<-E
      * Hvis en av de max 3 turene er nattport - forbered mankomelding.
     C     WSPRO         Chain     TURER14                            33
     C     *IN33         IFEQ      '0'
     C     TUTST3        IFEQ      '1'
     C                   EVAL      NATTP1='*NATTPORT*.'
     C                   EVAL      NATTP2=' '
     C                   END
     C                   END
     C                   callp     updhtmlvar('NATTP1':nattp1)
     C                   callp     updhtmlvar('NATTP2':nattp2)
     C                   ENDSR
      *
     C***********************************************
     C     REFRESH       BEGSR
     C***********************************************
      * BEVAR HEAVD/HEOPD, (KEY I VISSE SAMMENHENGER)
     C                   MOVE      HEAVD         GMAVD             4 0
     C                   MOVE      HEOPD         GMOPD             7 0
      *  FJERN OPPDRAG SOM IKKE LENGER HØRER TIL TUREN...
     C     TURKEY        SETLL     STSOPD
     C     TURKEY        READE(N)  STSOPD                                 33
     C     *IN33         DOWEQ     '0'                                           2<-B
     C                   MOVE      SOAVD         FMAVD
     C                   MOVE      SOOPD         FMOPD
     C     HEAKEY        CHAIN     HEADF                              34
     C     *IN34         IFEQ      *OFF
     C     HEPRO         ANDNE     SOPRO
     C                   EXSR      DLTSND
     C                   END                                                      3<-E
     C     TURKEY        READE(N)  STSOPD                                 33
     C                   END                                                      3<-E
      *
     C     TURKEY        CHAIN     STSTUR                             33
     C     *IN33         IFEQ      '0'                                          1<-B
      * REFRESH DATA (=HENT NYE POSISJONER)
     C     WSPRO         SETLL     HEAD14
     C     WSPRO         READE     HEAD14                                 33
     C     *IN33         DOWEQ     '0'                                           2<-B
     C     OPDKEY        CHAIN     STSOPD                             34
     C     *IN34         IFEQ      '1'                                            3<-B
     C                   EXSR      HETTOPD
     C                   MOVE      *BLANKS       STSTAT
     C                   ELSE                                                     3
     C                   EXSR      HFBR2
     C                   UPDATE    STSOPDR
     C                   END                                                      3<-E
N01   * sjekk om ennå uskutt oppdrag har kode for prioritert
s02  c*                  if        HEGM2='PRIO' and SOSTAT=' '
N02  c                   if        SOSTAT=' ' and PRITXT=*blanks
N02  C                   MOVE      'URG'         XXACTI
N02  c     TTKey         Chain     TRACKl02                           33
N02  c                   if        *in33=*off and %subst(TTTEXT:1:8)='*URGENT*'
N01  c                   eval      PRITXT='Uskutt PRIO-GODS finnes!'
N02  c                   endif
N01  c                   endif
     C     WSPRO         READE     HEAD14                                 33
     C  N33              ENDDO                                                   2<-E
      *
     C                   UPDATE    STSTURR
      *
     C                   END                                                    1<-E
     C                   MOVE      GMAVD         HEAVD
     C                   MOVE      GMOPD         HEOPD
      *
     C                   ENDSR
      *
      *
     C***********************************************
     C     DLTTST        BEGSR
     C***********************************************
     C                   MOVE      SCAVD         FMAVD
     C                   MOVE      SCOPD         FMOPD
     C     HEAKEY        CHAIN     HEADF                              33
     C     *IN33         IFEQ      *OFF
     C     HEPRO         ANDNE     WSPRO
     C     ViaFrbr       IFNE      'J'
     C                   UPDATE    STSCLIR1
     C                   END                                                    1<-E
     C                   SETON                                        30
     C                   eval      feil = 'Send. er FJERNET fra turen'
     C                   EXSR      DLTSND
     C                   END
      *
     C                   ENDSR
      *
     C***********************************************
     C     DLTSND        BEGSR
     C***********************************************
     C                   MOVE      FMAVD         SFAVD
     C                   MOVE      FMOPD         SFOPD
      * FJERN OPPDRAG/REDUSER ANT I TUR.
     C     OPDK1         CHAIN     STSOPD                             33
     C     *IN33         IFEQ      *OFF
     C                   DELETE    STSOPDR
     C     TURKEY        CHAIN     STSTUR                             33         *FIL
     C     *IN33         IFEQ      *OFF
     C                   SUB       1             STANOP
     C     SOSTAT        IFEQ      'X'
     C                   SUB       1             STANOK
     C                   END
     C                   UPDATE    STSTURR
     C                   END
     C                   END
      * FRAKTBREV
     C     OPDK1         SETLL     STSFBR
     C     OPDK1         READE     STSFBR                                 33
     C     *IN33         DOWEQ     '0'
     C                   DELETE    STSFBRR
     C     OPDK1         READE     STSFBR                                 33
     C                   END
      * KOLLI
     C     OPDK1         SETLL     STSCLI
     C     OPDK1         READE     STSCLI                                 33
     C     *IN33         DOWEQ     '0'
     C                   DELETE    STSCLIR
     C     OPDK1         READE     STSCLI                                 33
     C                   END
      *
     C                   ENDSR
      *
     C***********************************************
     C     HFBR2         BEGSR
     C***********************************************
     C     DOKUFK        SETLL     DOKUF
     C     DOKUFK        READE     DOKUF                                  33
     C     *IN33         DOWEQ     '0'                                          1<-B
     C     FBRKEY        CHAIN     STSFBR                             33
     C     *IN33         IFEQ      '1'                                           2<-B
     C                   EXSR      HCLI
     C                   MOVE      *BLANKS       STSTAT
     C                   MOVE      *BLANKS       SOSTAT
     C                   ELSE                                                    2
      * HENT NYE DATA
     C                   EXSR      HCLI2
      *
     C                   UPDATE    STSFBRR
     C                   END                                                     2<-E
     C     DOKUFK        READE     DOKUF                                  33
     C  N33              ENDDO                                                  1<-E
      *
     C                   ENDSR
      *
     C***********************************************
     C     HCLI2         BEGSR
     C***********************************************
     C     DOKFMK        SETLL     DOKUFM
     C     DOKFMK        READE     DOKUFM                                 33
     C     *IN33         DOWEQ     '0'                                          1<-B
N03  C                   IF        FMST='I' OR  FMST='E'
     C     CLIKEY        CHAIN(N)  STSCLI                             33
     C     *IN33         IFEQ      '1'                                           2<-B
     C                   MOVE      *BLANKS       STSTAT
     C                   MOVE      *BLANKS       SOSTAT
     C                   MOVE      *BLANKS       SFSTAT
     C                   ADD       1             SFANKI
     C                   CLEAR                   STSCLIR
     C                   MOVE      SFTYPE        SCTYPE
     C                   MOVE      WSPRO         SCPRO
     C                   MOVE      FMAVD         SCAVD
     C                   MOVE      FMOPD         SCOPD
     C                   MOVE      FMFBNR        SCFBNR
     C                   MOVE      FMCLID        SCCLID
     C                   WRITE     STSCLIR
     C                   END                                                     2<-E
N03  C                   ENDIF
     C     DOKFMK        READE     DOKUFM                                 33
     C  N33              ENDDO                                                  1<-E
      *
     C                   ENDSR
      *
      *=====================================================================******
      *  Different User than last invocation
      *=====================================================================******
     C     Init          begsr
     C                   open      BRIDF
     C     User          CHAIN     BRIDF                              30
      *
     C* En "standardvariant" libl: call bound (INCGI=*MODULE) med parameter.
     C* (bedre ressursmessig). MODUL må da være med comp. av dette pgm!!
     C     BILIBL        ifeq      *blanks
     C                   callb     'INCGI'
     C                   parm                    BISTDL
     C                   else
     C* Helt egen bibl.liste satt på user - normal CALL (BILIBL er "*pgm")
     C                   call      BILIBL
     C                   end
      *
     C                   open      KODTA
     C                   open      TURER14
     C                   open      HEADF
     C                   open      HEAD14
     C                   open      HEAD39
N03  C                   open      FRISOL01
     C                   open      DOKUF
     C                   open      DOKUFM
     C                   open      DOKUFM1
     C                   open      STSTUR
     C                   open      STSOPD
     C                   open      STSFBR
     C                   open      STSCLI
     C                   open      STSCLI1
     C                   open      CUNDC03
     C                   open      henok01
     C                   open      henos
N02  C                   open      TRACKL02
N03  C                   open      BRPARF
      * Om brukerid ikke har kundenr (anonym) bruk avdelings knr
      *    (for å kunne sende mail....)
     C     BIKUNR        IFEQ      *ZEROS
     C     *LOVAL        SETLL     KODTA
     C                   READ      KODTA
     C                   MOVE      KOAKNR        BIKUNR
     C                   END
      *
      * definer KEYS m.m.
      *
     C     *LIKE         DEFINE    STTYPE        YTYPE
      *
N03  c     IFBKEY        KLIST
N03  c                   KFLD                    FSKODE
N03  c                   KFLD                    FSSOK
N03  c                   move      'IFB'         FSKODE
     C     TURKEY        KLIST
     C                   KFLD                    YTYPE
     C                   KFLD                    WSPRO
     C     OPDKEY        KLIST
     C                   KFLD                    YTYPE
     C                   KFLD                    WSPRO
     C                   KFLD                    HEAVD
     C                   KFLD                    HEOPD
     C     FBRKEY        KLIST
     C                   KFLD                    YTYPE
     C                   KFLD                    WSPRO
     C                   KFLD                    DFAVD
     C                   KFLD                    DFOPD
     C                   KFLD                    DFFBNR
     C     CLIKEY        KLIST
     C                   KFLD                    YTYPE
     C                   KFLD                    WSPRO
     C                   KFLD                    FMAVD
     C                   KFLD                    FMOPD
     C                   KFLD                    FMFBNR
     C                   KFLD                    FMCLID
     C                   move      '00'          FMAI00
     C     OPDK1         KLIST
     C                   KFLD                    YTYPE
     C                   KFLD                    WSPRO
     C                   KFLD                    SFAVD
     C                   KFLD                    SFOPD
     C     FBRK1         KLIST
     C                   KFLD                    YTYPE
     C                   KFLD                    WSPRO
     C                   KFLD                    SCAVD
     C                   KFLD                    SCOPD
     C                   KFLD                    SCFBNR
     C     CLIK1         KLIST
     C                   KFLD                    YTYPE
     C                   KFLD                    WSPRO
     C                   KFLD                    WSCLID
     C     DOKUFK        KLIST
     C                   KFLD                    DFRI
     C                   KFLD                    HEAVD
     C                   KFLD                    HEOPD
     C     DOKFMK        KLIST
     C                   KFLD                    DFRI
     C                   KFLD                    HEAVD
     C                   KFLD                    HEOPD
     C                   KFLD                    DFFBNR
     C     DOKFM1K       KLIST
     C                   KFLD                    XXMRK1
     C     HEAKEY        KLIST
     C                   KFLD                    FMAVD
     C                   KFLD                    FMOPD
     C     HenosKey      KLIST
     C                   KFLD                    HKLNR
     C                   KFLD                    HKLNR2
N02  C     TTKey         KLIST
N02  C                   KFLD                    HEAVD
N02  C                   KFLD                    HEOPD
N02  C                   KFLD                    XXFBNR            3 0
N02  C                   KFLD                    XXACTI            3
N03  C     BrParKey      klist
N03  C                   kfld                    PABRID
N03  C                   kfld                    PAKUNR
N03  C                   kfld                    PAID
      *
     C                   MOVE      *BLANKS       YTYPE
     C                   MOVE      'F'           DFRI
      * key for å finne adr for å sende email om feilplassert gods.
      * OBS! Det foutsettes at PDA-USER i BRIDF har rett firmakode
      *  og firmaets kundenr, samt at det på FØRSTE POST av type *FEILUTGODS
      *  ligger AS/400 USERID/ADR for avsender ( må ligge i WRKDIRE)
     C     MAILKEYI      KLIST
     C                   KFLD                    BIFIRM
     C                   KFLD                    YYCONTA
     C                   KFLD                    BIKUNR
     C                   MOVEL     '*FEILUTGODS' YYCONTA          30
N03  c                   if        Versj>='01.28'
N03   * kode for om manuell merking av oppdrag som er kollimerket er tillatt
N03  c                   eval      MerkManKll= 'N'
N03  C                   EVAL      PABRID   = BIBRID
N03  C                   EVAL      PAID     = 'TUMOK'
N03  C     BrParKey      Chain     BRPARF                             33
N03  c   33              eval      PABRID   = '*KUNDFT*'+BIFIRM
N03  C   33BrParKey      Chain     BRPARF                             33
N03  C                   IF        *IN33 = '0' AND %SUBST(PAVRDA:1:1)='J'
N03  C                   EVAL      MerkManKll= 'J'
N03  c                   ENDIF
N03  c                   endif
      *
     C                   endsr
      *
      *=====================================================================******
      * Set html output skeleton member before its read into memory
      *=====================================================================******
     C     SetSkl        begsr
      *------------------
      * Set html output skeleton member
     C                   eval      Lib = '*LIBL'
     C                   eval      Fn  = 'HTMLSRC'
     C     SEMI          IFNE      'Y'
     C                   eval      Mbr = 'STSW01M'
     C                   ELSE
     C                   eval      Mbr = 'STSW01T'
     C                   END
      *------------------
     C                   endsr
     C***********************************************
     C     SettPaTur     BEGSR
     C***********************************************
      *
      *  KAN IKKE LEGGE PÅ TUR VED NATTPORT-LASTING (sjekkr kun tur1 )
     C     WSPRO1        CHAIN     TURER14                            33
     C     *in33         IFEQ      '0'
     C     TUTST3        andeq     '1'
     C                   move      *on           *in30
     c                   eval      feil = '*NATTPORT* Ukjent gods, +
     c                                     KAN IKKE LEGGES PÅ TUR'
     c                   goto      UtPaTur
     C                   END
      * Oppdraget må tilhøre samme avd som tur det settes på..
     c                   move      heavd         heavda
     C                   select
     C     HEAVDA        WHENEQ    TA1
     C                   move      wspro1        wspro
     C     HEAVDA        WHENEQ    TA2
     C                   move      wspro2        wspro
     C     HEAVDA        WHENEQ    TA3
     C                   move      wspro3        wspro
     C                   OTHER
     C                   move      *on           *in30
     c                   eval      feil = 'Kan IKKE LEGGE PÅ TUR, feil avd.'
     c                   goto      UtPaTur
     C                   ENDSL
      *
      * (BHR-spesial??)  Oppdraget må ha kode for ok terminal inn
     C     HXTERI        IFEQ      ' '
      * STATUS PÅ SENDINGSNIVÅ BLANK - likevel ok fordi alle sjekket inn??
     c                   move      'J'           AllCllOK          1
     C     DOKFMK        SETLL     DOKUFM
     C     DOKFMK        READE     DOKUFM                                 33
     C     *IN33         DOWEQ     '0'
N03  C                   IF        FMST='I' OR  FMST='E'
     c     FMITER        ifeq      ' '
     c                   move      'N'           AllCllOK          1
     c                   goto      UtAllcok
     c                   end
N03  C                   ENDIF
     C     DOKFMK        READE     DOKUFM                                 33
     C  N33              ENDDO
     c     UtAllcok      tag
     c     AllCllOK      ifeq      'N'
     C                   move      *on           *in30
     c                   eval      feil =  WsClid+' på oppdr. '+
     c                                     'IKKE KOMPLETT INN'
     c                   goto      UtPaTur
     C                   END
     C                   END
      * (BHR-spesial??)  Beløp må være godkjent...
     C     HXBLGK        IFEQ      *BLANKS
     C     FantHent      andne     'J'
     C                   move      *on           *in30
     C                   eval      feil = 'Kan IKKE LEGGE PÅ TUR, +
     C                                     ER IKKE PRISET/GODKJENT.'
     C                   goto      UtPaTur
     C                   END
      *
      * (BHR-spesial??)  Beløp må være godkjent...
      *
      * (BHR-spesial??)  Utlev.forbehold KUN dersom sending via agent
      *
      * (BHR-spesial??)  Kan ikke sette på tur etter at avsl. godsl. kjørt.
      *                  (turstatus A)
      *
      *
      * OK.. Sett på Tur
     C                   call      'SYGE21'
     C                   parm                    HEAVD
     C                   parm                    HEOPD
     C                   parm                    WSPRO
     C                   parm                    UUIND             1
     C     UUIND         ifeq      '0'
     C                   MOVE      WSPRO         HEPRO
     C                   move      'J'           NyttOPD
     C                   else
     C                   move      *on           *in30
     C                   eval      feil = 'Kan IKKE LEGGE PÅ TUR, +
     c                                     Kont. megler(st?)'
     C                   end
      *
     C     UtPaTur       ENDSR
      *
     C***********************************************
     C     HenteSr       BEGSR
     C***********************************************
      *
     c     WSCLID        chain     Henok01                            33
     c     *in33         cabeq     '1'           UtHenSr
     c     HenosKey      chain     Henos                              33
     c     *in33         cabeq     '1'           UtHenSr
     c     HSST          cabeq     'O'           UtHenSr
      * Ukomplett - gi mer spesifik melding en 41= ukjent kolliid (F=Feil=hopp ut)
     c     HSSTIN        ifeq      ' '
     C                   move      'F'           FantHent
     C                   eval      feil = WsClid+' tilhører UKOMPLETT ' +
     C                                    'henteoppdrags-sending'
     c                   goto      UtHenSr
     c                   end
     c     HSAVDH        Ifne      *zeros
     c     HSOPDH        andeq     *zeros
     C                   move      HSAVDH        Heavda
     C     TA1           IFne      Heavda                                        2<-B
     C     TA2           andne     Heavda                                        2<-B
     C     TA3           andne     Heavda                                        2<-B
     c                   goto      UtHenSr
     c                   end
      * FINNES på ennå ikke overdørt senfing OG avd er lik en av TU-avd
     C                   move      'J'           UAUTO             1
     C                   CALL      'SYTR34B'
     C                   PARM                    HSLNR
     C                   PARM                    UAUTO
      * fakt henteoppdrag som ikke var overført , prov igjen.
     C                   move      'J'           FantHent
      *
     c                   else
     C                   move      'F'           FantHent
     C                   eval      feil = WsClid+' tilhører UFERDIG ' +
     C                                    'henteoppdrags-sending'
     c                   goto      UtHenSr
     c                   end
      *
     C     UtHenSr       ENDSR
      *
