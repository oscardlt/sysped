********************************************************************
      * RETTINGER I DETTE PROGRAM:
PTFnr:*Sek Sig Vers  Beskrivelse...........................
""""""*"""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""
10XXX * 01 sh  PTF10 ptfn til I/O
10XXX * 02 sh  PTF11 prjoin er tatt ut
********************************************************************
     FHEADF     IF   E           K DISK
     FPRIK      IF   E           K DISK
S02  F*RJOIN    IF   E           K DISK
      *
      * losseted
      *
     D                 DS
s02  D* LS                     1     60
s02  D*                                    DIM(3)                               I/O. last/loss
n02  D  LS                     1    100
n02  D                                     DIM(5)                               I/O. last/loss
     D  PKLS01                 1     20
     D  PKLS02                21     40
     D  PKLS03                41     60
     D  PKLS04                61     80
     D  PKLS05                81    100
      *
      * lastested
      *
     D                 DS
n02  D  L2                     1    100
n02  D                                     DIM(5)                               I/O. last/loss
n02  D  PKL201                 1     20
n02  D  PKL202                21     40
n20  D  PKL203                41     60
n02  D  PKL204                61     80
n02  D  PKL205                81    100
     D                 DS
     D  FS                     1     50
     D                                     DIM(10)                              I/O. frasted
     D  PKFS01                 1      5
     D  PKFS02                 6     10
     D  PKFS03                11     15
     D  PKFS04                16     20
     D  PKFS05                21     25
     D  PKFS06                26     30
     D  PKFS07                31     35
     D  PKFS08                36     40
     D  PKFS09                41     45
     D  PKFS10                46     50
     D                 DS
     D  UR                     1     10
     D                                     DIM(10)                              I/O. ursp.kode
     D                 DS
     D  TR                     1     40
     D                                     DIM(10)                              I/O. ursp.kode
     D  PTRA01                 1      4
     D  PTRA02                 5      8
     D  PTRA03                 9     12
     D  PTRA04                13     16
     D  PTRA05                17     20
     D  PTRA06                21     24
     D  PTRA07                25     28
     D  PTRA08                29     32
     D  PTRA09                33     36
     D  PTRA10                37     40
     D                 DS
     D  TS                     1     50
     D                                     DIM(10)                              I/O. tilsted
     D  PKTS01                 1      5
     D  PKTS02                 6     10
     D  PKTS03                11     15
     D  PKTS04                16     20
     D  PKTS05                21     25
     D  PKTS06                26     30
     D  PKTS07                31     35
     D  PKTS08                36     40
     D  PKTS09                41     45
     D  PKTS10                46     50
     D                 DS
     D  PKUR01                 1      1
     D  PKUR02                 2      2
     D  PKUR03                 3      3
     D  PKUR04                 4      4
     D  PKUR05                 5      5
     D  PKUR06                 6      6
     D  PKUR07                 7      7
     D  PKUR08                 8      8
     D  PKUR09                 9      9
     D  PKUR10                10     10
     D                 DS
     D  FR                     1     30
     D                                     DIM(10)                              I/O. frankatur
     D  PKFR01                 1      3
     D  PKFR02                 4      6
     D  PKFR03                 7      9
     D  PKFR04                10     12
     D  PKFR05                13     15
     D  PKFR06                16     18
     D  PKFR07                19     21
     D  PKFR08                22     24
     D  PKFR09                25     27
     D  PKFR10                28     30
     D                 DS
     D  OT                     1     20
     D                                     DIM(10)                              I/O. oppd.type
     D  PKOT01                 1      2
     D  PKOT02                 3      4
     D  PKOT03                 5      6
     D  PKOT04                 7      8
     D  PKOT05                 9     10
     D  PKOT06                11     12
     D  PKOT07                13     14
     D  PKOT08                15     16
     D  PKOT09                17     18
     D  PKOT10                19     20
     D                 DS
     D  LK                     1     20
     D                                     DIM(10)                              I/O. landkode
     D  PKLK01                 1      2
     D  PKLK02                 3      4
     D  PKLK03                 5      6
     D  PKLK04                 7      8
     D  PKLK05                 9     10
     D  PKLK06                11     12
     D  PKLK07                13     14
     D  PKLK08                15     16
     D  PKLK09                17     18
     D  PKLK10                19     20
     D                 DS
     D  X01B                   1      1
     D  PRKOLL                 1      1
     D  PKKOLL                 1      1
     D  PRINT                  2      6  0
     D  PKINT                  2      6  0
     D  PRANT                  7     11  0
     D  PKPPR                  7     11  0
     D  PRTEGN                12     12
     D  PKTEGN                12     12
     D  PRJUST                13     22  3
     D  PKJUST                13     22  3
      *
     C                   EXSR      INIT
      *
     c     keyh          chain     headf                              33
     c   33              goto      slutt
     c                   exsr      FBELØ2
     c                   Z-ADD     PKBELØ        ubel
     c                   move      PKFVAL        uval
     c     slutt         tag
     c                   seton                                        lr
     c                   return
      ***********************************************
     C     FBELØ2        BEGSR
      ***********************************************
     C     PRIKK         KLIST
     C                   KFLD                    XKNR              8
     C                   KFLD                    XAVTN             1
     C                   KFLD                    XGEBY             3
     C                   KFLD                    XAVTT             1
     C                   KFLD                    XINT              5 0
     C     PRIKKE        KLIST
     C                   KFLD                    XKNR
     C                   KFLD                    XAVTN
     C                   KFLD                    XGEBY
      *
     C     PRIKKE        SETLL     PRIK
      **
     C     NESTE         TAG
      **
      *   TESTER INCLUDE OMITBEGREPER
      *
     C     PRIKKE        READE     PRIK                                   32
     C  N32              EXSR      TSTGIO
n01  C  N32
n01  CAN 78              Z-add     0             pkbelØ
     C  N32
     CAN 78              GOTO      NESTE
      *
      * N32 GYLDIG AVTALE ER LEST
      *
      * VED NY GEBYRKODE SKAL DEN UT AV LØKKA
      *
     C  N32PKAVTT        IFEQ      'P'
     C     PKAVTT        OREQ      'B'
     C     PKAVTT        OREQ      'X'
     C     PKAVTT        OREQ      'H'
     C                   Z-ADD     PKBELØ        XPROS            10 3
     C                   END
      *
     C                   MOVE      PKBELØ        PRBELØ           10 3
     C                   EXSR      SRTAB
      *
     C     SLFBL2        ENDSR
      ***********************************************
     C     TSTGIO        BEGSR
      ***********************************************
s02  C*    PRJOIK        KLIST
s02  C*                  KFLD                    PKKNR
s02  C*                  KFLD                    PKAVTN
s02  C*                  KFLD                    PKLNR
      *                 (= PRGE (Urspr/Franka/Opd.ty.) + PRLK (landk.)
      *                  + PRFS (FRASTED) + PRTS (Tilsted))
      *          contains all include/omit conditions possible for one
      *          priceline (max. include or omit per condition)
      *
     C                   SETOFF                                       78
      *
      *
s02  C*    PRJOIK        CHAIN     PRJOIN                             80
s02  C* N80              DO                                                     I
      * ______________________________
      * Ursprungskode - Include / Omit
      * """"""""""""""""""""""""""""""
     C     PKURIO        IFNE      ' '                                          II
     C     PKURIO        IFEQ      'I'                                          III
      * Ved include må begrepet finnes i -arrayet (->80 on)
     C                   SETOFF                                       80
     C     HEUR          LOOKUP    UR                                     80
     C  N80              SETON                                        78
     C                   ELSE
      * Ved omit må begrepet IKKE finnes i -arrayet (->80 off)
     C                   SETOFF                                       80
     C     HEUR          LOOKUP    UR                                     80
     C   80              SETON                                        78
     C                   END                                                    III
     C                   END                                                    II
      * ______________________________
      * trafikk sjø     Include / Omit
      * """"""""""""""""""""""""""""""
     C     PTRAIO        IFNE      ' '                                          II
     C     PTRAIO        IFEQ      'I'                                          III
      * Ved include må begrepet finnes i -arrayet (->80 on)
     C                   SETOFF                                       80
     C     BLTR          LOOKUP    TR                                     80
     C  N80              SETON                                        78
     C                   ELSE
      * Ved omit må begrepet IKKE finnes i -arrayet (->80 off)
     C                   SETOFF                                       80
     C     BLTR          LOOKUP    TR                                     80
     C   80              SETON                                        78
     C                   END                                                    III
     C                   END                                                    II
      * ___________________________________
      * Frankatur/Oppdt. er låst ved brutto
      * """""""""""""""""""""""""""""""""""
     C     XKNR          IFNE      '    ALLE'                                   II
      * ______________________________
      * Frankatur     - Include / Omit
      * """"""""""""""""""""""""""""""
     C  N78PKFRIO        IFNE      ' '                                          III
     C     PKFRIO        IFEQ      'I'                                          IIII
      * Ved include må begrepet finnes i -arrayet (->80 on)
     C                   SETOFF                                       80
     C     HEFR          LOOKUP    FR                                     80
     C  N80              SETON                                        78
     C                   ELSE
      * Ved omit måbegrepet IKKE finnes i -arrayet (->80 off)
     C                   SETOFF                                       80
     C     HEFR          LOOKUP    FR                                     80
     C   80              SETON                                        78
     C                   END                                                    IIII
     C                   END                                                    III
      *
      * ______________________________
      * Oppdr.type    - Include / Omit
      * """"""""""""""""""""""""""""""
     C  N78PKOTIO        IFNE      ' '                                          III
     C     PKOTIO        IFEQ      'I'                                          IIII
      * Ved include må begrepet finnes i -arrayet (->80 on)
     C                   SETOFF                                       80
     C     HEOT          LOOKUP    OT                                     80
     C  N80              SETON                                        78
     C                   ELSE
      * Ved omit måbegrepet IKKE finnes i-arrayet (->80 off)
     C                   SETOFF                                       80
     C     HEOT          LOOKUP    OT                                     80
     C   80              SETON                                        78
     C                   END                                                    IIII
     C                   END                                                    III
      *
     C                   END                                                    II
      *
      * ______________________________
      * Landkode     - Include / Omit
      * """"""""""""""""""""""""""""""
     C  N78PKLKIO        IFNE      ' '                                          II
     C     PKLKIO        IFEQ      'I'                                          III
      * Ved include må begrepet finnes i -arrayet (->80 on)
     C                   SETOFF                                       80
     C     INOMLK        LOOKUP    LK                                     80
     C  N80              SETON                                        78
     C                   ELSE
      * Ved omit må begrepet IKKE finnes i -arrayet (->80 off)
     C                   SETOFF                                       80
     C     INOMLK        LOOKUP    LK                                     80
     C   80              SETON                                        78
     C                   END                                                    III
     C                   END                                                    II
      *
      * ______________________________
      * Frasted      - Include / Omit
      * """"""""""""""""""""""""""""""
     C  N78PKFSIO        IFNE      ' '                                          II
     C     PKFSIO        IFEQ      'I'                                          III
      * Ved include må begrepet finnes i -arrayet (->80 on)
     C                   SETOFF                                       80
     C     HESDF         LOOKUP    FS                                     80
     C  N80              SETON                                        78
     C                   ELSE
      * Ved omit måbegrepet IKKE finnes i -arrayet (->80 off)
     C                   SETOFF                                       80
     C     HESDF         LOOKUP    FS                                     80
     C   80              SETON                                        78
     C                   END                                                    III
     C                   END                                                    II
      *
      * ______________________________
      * Tilsted      - Include / Omit
      * """"""""""""""""""""""""""""""
     C  N78PKTSIO        IFNE      ' '                                          II
     C     PKTSIO        IFEQ      'I'                                          III
      * Ved include må begrepet finnes i -arrayet (->80 on)
     C                   SETOFF                                       80
     C     HESDT         LOOKUP    TS                                     80
     C  N80              SETON                                        78
     C                   ELSE
      * Ved omit måbegrepet IKKE finnes i -arrayet (->80 off)
     C                   SETOFF                                       80
     C     HESDT         LOOKUP    TS                                     80
     C   80              SETON                                        78
     C                   END                                                    III
     C                   END                                                    II
      * ______________________________
      * Lossested - Include / Omit
      *(Gebyrer som er betinget av valgfrie felt tas
      * aldri med dersom feltet i oppdraget er blankt)
      * """"""""""""""""""""""""""""""
     C  N78PKLSIO        IFNE      ' '                                          II
     C     HESDL         IFEQ      *BLANKS                                      III
     C                   SETON                                        78
     C                   ELSE
     C     PKLSIO        IFEQ      'I'                                          IIII
      * Ved include må begrepet finnes i -arrayet (->80 on)
     C                   SETOFF                                       80
     C     HESDL         LOOKUP    LS                                     80
     C  N80              SETON                                        78
     C                   ELSE
      * Ved omit måbegrepet IKKE finnes i -arrayet (->80 off)
     C                   SETOFF                                       80
     C     HESDL         LOOKUP    LS                                     80
     C   80              SETON                                        78
     C                   END                                                    IIII
     C                   END                                                    III
     C                   END                                                    II
      * ______________________________
      * Lastested - Include / Omit
      *(Gebyrer som er betinget av valgfrie felt tas
      * aldri med dersom feltet i oppdraget er blankt)
      * """"""""""""""""""""""""""""""
     C  N78PKL2IO        IFNE      ' '                                          II
     C     HESDLA        IFEQ      *BLANKS                                      III
     C                   SETON                                        78
     C                   ELSE
     C     PKL2IO        IFEQ      'I'                                          IIII
      * Ved include må begrepet finnes i -arrayet (->80 on)
     C                   SETOFF                                       80
     C     HESDLA        LOOKUP    L2                                     80
     C  N80              SETON                                        78
     C                   ELSE
      * Ved omit måbegrepet IKKE finnes i -arrayet (->80 off)
     C                   SETOFF                                       80
     C     HESDLA        LOOKUP    L2                                     80
     C   80              SETON                                        78
     C                   END                                                    IIII
     C                   END                                                    III
     C                   END                                                    II
      *
s02  C*                  END                                                    I
      *
      * _______________________________________________________________
      * UTLØPSDATO (indikator 79 varsler at minsten linje i avt utløpt)
      * """""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""
     C     PKDT          IFGT      0
     C  N78
     CANN79PKDT          COMP      HEDTOP                               79
     C  N78PKDT          COMP      HEDTOP                               78
     C                   END
      * Linjen ok? (indikator 78 varsler at denne linje ikke gjelder)
      *
     C     UTGIO         ENDSR
      *
      **********************************************************************
     C     SRTAB         BEGSR
      **********************************************************************
      *
      *** SLÅ OPP I BRUTTOPRIS-TABELL
     C     X01B          IFEQ      'X'                                          1<-B
     C     PRANT         ANDGT     0
     C                   MULT      HENT          PRBELØ
     C                   END                                                    1<-E
     C     X01B          IFEQ      'T'                                          1<-B
     C     PRANT         ANDGT     0
     C                   MULT      ANTTEU        PRBELØ
     C                   END                                                    1<-E
     C     X01B          IFEQ      'F'                                          1<-B
     C     PRANT         ANDGT     0
     C                   MULT      FORANT        PRBELØ
     C                   END                                                    1<-E
      *
     C     X01B          IFEQ      'V'                                          1<-B
     C     PRBELØ        DIV       100           XWORK            17 5
     C     XWORK         MULT      TRVERB        PRBELØ
     C                   MOVE      TRVERV        PKFVAL
     C                   END                                                    1<-E
      *
     C     X01B          IFGE      '0'
     C     X01B          ANDLE     '9'
     C                   MOVE      'D'           X01B
     C                   END
      *
     C     X01B          IFEQ      'D'                                          1<-B
     C                   MOVE      *ZEROS        PRBELØ
     C                   END                                                    1<-E
      * TARRIFERINGSLINJER...
     C     X01B          IFEQ      'L'                                          1<-B
      *                    MULT HENTF     PRBELØ
     C                   MOVE      HENTF         XXNTF             4 0
      * JUST GITT UTEN FORTEGN => JUST. ER ANTALL FRIE LINJER
     C     PRJUST        IFNE      *ZEROS                                        2<-B
     C     PRTEGN        IFEQ      ' '                                           3<-B
     C                   SUB       PRJUST        XXNTF
     C                   ELSE                                                    3X
      * JUST GITT MED FORTEGN => TREKK GITT I KR.
      * PRANT (PRIS PR...) MÅ DA VÆRE GITT FOR Å GÅ I SR OMREGN
     C     PRANT         IFEQ      *ZEROS                                        4<-B
     C                   Z-ADD     1             PRANT
     C                   END                                                     4<-E
     C                   END                                                     3<-E
     C                   END                                                     2<-E
     C     XXNTF         IFLT      0                                             2<-B
     C                   MOVE      *ZEROS        XXNTF
     C                   END                                                     2<-E
     C                   MULT      XXNTF         PRBELØ
     C                   END                                                    1<-E
      *
     C     PRANT         IFGT      0
     C                   EXSR      OMREGN
     C                   END
      *
      *** PROSENTAVTALE ?
      *
     C     XPROS         IFNE      0
     C     XPROS         IFNE      0.001
     C     PRBELØ        DIV       100           XWORK
     C     XWORK         MULT(H)   XPROS         PRBELØ
     C                   ELSE                                                   MOTKOSTN.
     C                   Move      *zeros        XWORK
     C                   Move      *zeros        PRBELØ
     C                   END
     C                   END
      *
      *
     C                   ENDSR
      *
      ***********************************************
     C     OMREGN        BEGSR
      ***********************************************
      *
      *** AJUSTING VEIGHT        - LESS THAN 1000 TO NEAREST  10 KILO
      *** ELSE TO NEAREST     100 KG, BUT IF PRICE IS GIVEN   PR. 2-10
      *** TO NEAREST  10 KG. NOT IF PRICE PR 1 KILO
      *
      *** IF FIRM HAVE DEFINED NO AJUSTMENT
      *** (INGAVR = 'J') NO AJUSTMENT IS PERFORMED
      *
     C     X01B          IFEQ      'B'
     C                   Z-ADD     HEVKT         XVEKT             9 0
     C                   MOVE      *BLANKS       X01B
     C                   ELSE
     C                   Z-ADD     HEFBV         XVEKT
     C                   END
      *
     C     X01B          IFEQ      ' '                                          NOT PR LINE/PIESES
      * 1
     C     UAVR          IFNE      'J'
      * 2
     C     KOWMM         IFNE      3
      * 2B
     C     PRANT         IFNE      1
      * 3
     C     XVEKT         IFLT      1000                                         WEIGHT <   1000 KG
     C     XVEKT         ADD       9             XVEKT2            9 0          AJUST TO NEARES
     C                   MOVE      '0'           XVEKT2                         10 KG
     C                   ELSE                                                   WEIGHT >=     1000 K
     C     PRANT         IFGT      10                                           PRICE IS GIVEN PR 10
     C     XVEKT         ADD       99            XVEKT2                         KG OR MORE  , AJUST
     C                   MOVE      '00'          XVEKT2                         TO NEAREST   100 KG
     C                   ELSE
     C     XVEKT         ADD       9             XVEKT2                         PRICE GIVEN PR
     C                   MOVE      '0'           XVEKT2                         2-9 KG, AJUST TO
     C                   END                                                    NEAREST  10 KG
     C                   END
      * 3
     C                   ELSE                                                   NO AJUSTMENT
     C                   Z-ADD     XVEKT         XVEKT2
     C                   END
      * 2B
     C                   ELSE                                                   PRICE PR 1 AND NOT P
     C                   Z-ADD     XVEKT         XVEKT2                         LINEPRICE/PIESESPRIC
     C                   END
      * 2
     C                   ELSE                                                   PRICE PR 1 AND NOT P
     C                   Z-ADD     XVEKT         XVEKT2                         LINEPRICE/PIESESPRIC
     C                   END
      * 1
     C     PRBELØ        DIV       PRANT         XWORK
     C     XWORK         MULT(H)   XVEKT2        PRBELØ
     C                   END
     C     X01B          IFEQ      'M'
     C     PRANT         IFNE      *ZEROS
     C                   MULT(H)   HEM3          PRBELØ
     C                   DIV(H)    PRANT         PRBELØ
     C                   END
     C                   END
      *
     C     X01B          IFNE      'D'
     C     X01B          IFNE      'L'
     C     HENTF         ORGT      0
     C     PRTEGN        IFEQ      '-'
     C                   SUB       PRJUST        PRBELØ
     C                   ELSE
     C     PRTEGN        IFEQ      '+'
     C                   ADD       PRJUST        PRBELØ
     C                   ELSE
      * flyttet linjene til egen subrutine
     C                   exsr      mimasr
      *
     C                   END
     C                   END
     C                   END
     C                   END
      *
     C                   ENDSR
      ***********************************************
     C     MIMASR        BEGSR
      ***********************************************
      *
      * M = MINIMUM
      *SYOSLO* IKKE VED VAREVERDI DA VALUTAPROBLEMER
     C     PRTEGN        IFEQ      'M'
     C     X01B          IFNE      'V'
     C     PRBELØ        IFLT      PRJUST
     C                   Z-ADD     PRJUST        PRBELØ
     C                   END
     C                   ELSE
     C                   MOVE      'M'           KODEMM            1
     C                   END
     C                   END
      * N = MAXIMUM
     C     PRTEGN        IFEQ      'N'
     C     X01B          IFNE      'V'
     C     PRBELØ        IFGT      PRJUST
     C                   Z-ADD     PRJUST        PRBELØ
     C                   END
     C                   ELSE
     C                   MOVE      'N'           KODEMM            1
     C                   END
     C                   END
     C                   ENDSR
      *
      ***********************************************
     C     INIT          BEGSR
      ***********************************************
     C     *ENTRY        PLIST
     C                   PARM                    UAVD              4
     C                   PARM                    UOPD              7
     C                   PARM                    UKNR              8
     C                   PARM                    UGEBY             3
     C                   PARM                    UVAL              3
     C                   PARM                    UBEL             11 2
     C                   PARM                    ANTTEU            9 0
     C                   PARM                    FORANT            5 0
     C                   PARM                    BLTR              4
     C                   PARM                    INOMLK            2
     C                   PARM                    KOWMM             1 0
     C                   PARM                    UAVR              1
     C                   PARM                    UAVTN             1
     C                   MOVE      UKNR          XKNR
     C                   MOVE      UGEBY         XGEBY
     C                   MOVE      UAVTN         XAVTN
     C
      *
     C     keyh          klist
     c                   kfld                    heavd
     c                   kfld                    heopd
      *
     c                   MOVE      UAVD          heavd
     c                   MOVE      UOPD          heopd
     C                   MOVE      *ZEROS        PRINT
     C                   MOVE      *ZEROS        PRANT
     C                   MOVE      *ZEROS        PRJUST
     C                   ENDSR
