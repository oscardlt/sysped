     H DFTACTGRP(*NO)
      *
      ***********************************************************
      *** PROGRAM SKAL KONVERTER FISKEAVGIFTER FRA TVINN      ***
      ***********************************************************
      *
     FXMLRCVF   IF   E           K DISK
     FSADAVGE   UF A E           K DISK
      *
     D                sds
     D ZUSER                 254    263
      *  Prototype for syti02r
     d syti02r         pr
     d usn_                                like(usn)
      *  *ENTRY Interface for Main Procedure
     d syti02r         pi
     d usn                            9
      *----------------------------------------------------------------------
      * Stand Alone Fields - TOP
      *----------------------------------------------------------------------
     d xan08           s              8A
     d xlandgr         s             10A
     d x1_xrlev1       s                   like(xrlev1)
     d x1_xrlev2       s                   like(xrlev2)
     d x2_xrlev1       s                   like(xrlev1)
     d x2_xrlev2       s                   like(xrlev2)
     d x2_xrlev3       s                   like(xrlev3)
     d x3_xrlev1       s                   like(xrlev1)
     d x3_xrlev2       s                   like(xrlev2)
     d x3_xrlev3       s                   like(xrlev3)
     d x3_xrlev4       s                   like(xrlev4)
     d x4_xrlev1       s                   like(xrlev1)
     d x4_xrlev2       s                   like(xrlev2)
     d x4_xrlev3       s                   like(xrlev3)
     d x4_xrlev4       s                   like(xrlev4)
     d x4_xrlev5       s                   like(xrlev5)
     d x5_xrlev1       s                   like(xrlev1)
     d x5_xrlev2       s                   like(xrlev2)
     d x5_xrlev3       s                   like(xrlev3)
     d x5_xrlev4       s                   like(xrlev4)
     d x5_xrlev5       s                   like(xrlev5)
     d x5_xrlev6       s                   like(xrlev6)
     d x6_xrlev1       s                   like(xrlev1)
     d x6_xrlev2       s                   like(xrlev2)
     d x6_xrlev3       s                   like(xrlev3)
     d x6_xrlev4       s                   like(xrlev4)
     d x6_xrlev5       s                   like(xrlev5)
     d x6_xrlev6       s                   like(xrlev6)
     d x6_xrlev7       s                   like(xrlev7)
     d x7_xrlev1       s                   like(xrlev1)
     d x7_xrlev2       s                   like(xrlev2)
     d x7_xrlev3       s                   like(xrlev3)
     d x7_xrlev4       s                   like(xrlev4)
     d x7_xrlev5       s                   like(xrlev5)
     d x7_xrlev6       s                   like(xrlev6)
     d x7_xrlev7       s                   like(xrlev7)
     d x7_xrlev8       s                   like(xrlev8)
     d x8_xrlev1       s                   like(xrlev1)
     d x8_xrlev2       s                   like(xrlev2)
     d x8_xrlev3       s                   like(xrlev3)
     d x8_xrlev4       s                   like(xrlev4)
     d x8_xrlev5       s                   like(xrlev5)
     d x8_xrlev6       s                   like(xrlev6)
     d x8_xrlev7       s                   like(xrlev7)
     d x8_xrlev8       s                   like(xrlev8)
     d x8_xrlev9       s                   like(xrlev9)
     d x_agtanr        s                   like(agtanr)
     d x_agakd         s                   like(agakd)
     d x_agskv         s                   like(agskv)
     d x_agdtf         s                   like(agdtf)
     d x_agdtt         s                   like(agdtt)
     d x_agpp          s                   like(agpp)
     d x_agsats        s                   like(agsats)

      *----------------------------------------------------------------------
      /free

       exsr init;

       exsr srxml1;

       *inlr = *on;
       return;

       //**********************************************                ------
       begsr srxml1;
       //**********************************************

         X1_XRLEV1 = 1;
         X1_XRLEV2 = 0;

         chain (xrsn:x1_xrlev1:x1_xrlev2) xmlrcvf;
         dow %found;
           select;
           when xrnv = 'versjon';
           when xrnv = 'vare';
             exsr srxml2;
           endsl;
           x1_xrlev1 = x1_xrlev1 + 1;
           chain (xrsn:x1_xrlev1:x1_xrlev2) xmlrcvf;
         enddo;

         endsr;

       //**********************************************
       begsr srxml2;
       //**********************************************

         x2_xrlev1 = xrlev1;
         x2_xrlev2 = 1;
         x2_xrlev3 = 0;

         chain (xrsn:x2_xrlev1:x2_xrlev2:x2_xrlev3) xmlrcvf;
         dow %found;
           select;
           when xrnv = 'id';
             x_agtanr = %float(xrverd);
           when xrnv = 'avgiftsatser';
             exsr srxml3;
           endsl;
           x2_xrlev2 = x2_xrlev2 + 1;
           chain (xrsn:x2_xrlev1:x2_xrlev2:x2_xrlev3) xmlrcvf;
         enddo;

       endsr;

       //**********************************************
       begsr srxml3;
       //**********************************************

         x3_xrlev1 = xrlev1;
         x3_xrlev2 = xrlev2;
         x3_xrlev3 = 1;
         x3_xrlev4 = 0;

         chain (xrsn:x3_xrlev1:x3_xrlev2:x3_xrlev3:x3_xrlev4) xmlrcvf;
         dow %found;
           select;
           when xrnv = 'avgiftsats';
             exsr srxml4;
           endsl;
           x3_xrlev3 = x3_xrlev3 + 1;
           chain (xrsn:x3_xrlev1:x3_xrlev2:x3_xrlev3:x3_xrlev4) xmlrcvf;
         enddo;

       endsr;

       //**********************************************
       begsr srxml4;
       //**********************************************

         x4_xrlev1 = xrlev1;
         x4_xrlev2 = xrlev2;
         x4_xrlev3 = xrlev3;
         x4_xrlev4 = 1;
         x4_xrlev5 = 0;

         chain (xrsn:x4_xrlev1:x4_xrlev2:x4_xrlev3:x4_xrlev4:x4_xrlev5)
               xmlrcvf;
         dow %found;
           select;
           when xrnv = 'landgruppe';
             xlandgr = xrverd;
           when xrnv = 'landgruppenavn';
           when xrnv = 'avgiftstyper';
             if xlandgr = 'UALL';
               exsr srxml5;
               xlandgr = ' ';
             endif;
           endsl;
           x4_xrlev4 = x4_xrlev4 + 1;
           chain (xrsn:x4_xrlev1:x4_xrlev2:x4_xrlev3:x4_xrlev4:x4_xrlev5)
                 xmlrcvf;
         enddo;

       endsr;

       //**********************************************
       begsr srxml5;
       //**********************************************

         x5_xrlev1 = xrlev1;
         x5_xrlev2 = xrlev2;
         x5_xrlev3 = xrlev3;
         x5_xrlev4 = xrlev4;
         x5_xrlev5 = 1;
         x5_xrlev6 = 0;

         chain (xrsn:x5_xrlev1:x5_xrlev2:x5_xrlev3:x5_xrlev4:x5_xrlev5
               :x5_xrlev6) xmlrcvf;
         dow %found;
           select;
           when xrnv = 'avgiftstype';
             exsr srxml6;
           endsl;
           x5_xrlev5 = x5_xrlev5 + 1;
           chain (xrsn:x5_xrlev1:x5_xrlev2:x5_xrlev3:x5_xrlev4:x5_xrlev5
                 :x5_xrlev6) xmlrcvf;
         enddo;

       endsr;

       //**********************************************
       begsr srxml6;
       //**********************************************

         x6_xrlev1 = xrlev1;
         x6_xrlev2 = xrlev2;
         x6_xrlev3 = xrlev3;
         x6_xrlev4 = xrlev4;
         x6_xrlev5 = xrlev5;
         x6_xrlev6 = 1;
         x6_xrlev7 = 0;

         chain (xrsn:x6_xrlev1:x6_xrlev2:x6_xrlev3:x6_xrlev4:x6_xrlev5
               :x6_xrlev6:x6_xrlev7) xmlrcvf;
         dow %found;
           select;
           when xrnv = 'avgiftstype';
             x_agakd = xrverd;
           when xrnv = 'avgiftstypebeskrivelse';
           when xrnv = 'avgiftsgrupper';
             exsr srxml7;
           endsl;
           x6_xrlev6 = x6_xrlev6 + 1;
           chain (xrsn:x6_xrlev1:x6_xrlev2:x6_xrlev3:x6_xrlev4:x6_xrlev5
                 :x6_xrlev6:x6_xrlev7) xmlrcvf;
         enddo;

         exsr opdavg;

       endsr;

       //**********************************************
       begsr srxml7;
       //**********************************************

         x7_xrlev1 = xrlev1;
         x7_xrlev2 = xrlev2;
         x7_xrlev3 = xrlev3;
         x7_xrlev4 = xrlev4;
         x7_xrlev5 = xrlev5;
         x7_xrlev6 = xrlev6;
         x7_xrlev7 = 1;
         x7_xrlev8 = 0;

         chain (xrsn:x7_xrlev1:x7_xrlev2:x7_xrlev3:x7_xrlev4:x7_xrlev5
               :x7_xrlev6:x7_xrlev7:x7_xrlev8) xmlrcvf;
         dow %found;
           select;
           when xrnv = 'avgiftsgruppe';
             exsr srxml8;
           endsl;
           x7_xrlev7 = x7_xrlev7 + 1;
           chain (xrsn:x7_xrlev1:x7_xrlev2:x7_xrlev3:x7_xrlev4:x7_xrlev5
                 :x7_xrlev6:x7_xrlev7:x7_xrlev8) xmlrcvf;
         enddo;

       endsr;

       //**********************************************
       begsr srxml8;
       //**********************************************

         x8_xrlev1 = xrlev1;
         x8_xrlev2 = xrlev2;
         x8_xrlev3 = xrlev3;
         x8_xrlev4 = xrlev4;
         x8_xrlev5 = xrlev5;
         x8_xrlev6 = xrlev6;
         x8_xrlev7 = xrlev7;
         x8_xrlev8 = 1;
         x8_xrlev9 = 0;

         chain (xrsn:x8_xrlev1:x8_xrlev2:x8_xrlev3:x8_xrlev4:x8_xrlev5
               :x8_xrlev6:x8_xrlev7:x8_xrlev8:x8_xrlev9) xmlrcvf;
         dow %found;
           select;
           when xrnv = 'avgiftsgruppe';
             x_agskv = xrverd;
           when xrnv = 'avgiftsgruppebeskrivelse';
           when xrnv = 'sats';
             x_agsats = %dec(xrverd:5:3);
           when xrnv = 'oresats';
           when xrnv = 'enhet';
             x_agpp = xrverd;
           when xrnv = 'enhetbeskrivelse';
           when xrnv = 'fomdato';
             xan08    = %subst(xrverd:1:4) + %subst(xrverd:6:2)
                      + %subst(xrverd:9:2);
             x_agdtf  = %dec(xan08:8:0);
           when xrnv = 'tomdato';
             if xrverd = *blanks;
               x_agdtt  = 0;
             else;
               xan08    = %subst(xrverd:1:4) + %subst(xrverd:6:2)
                        + %subst(xrverd:9:2);
               x_agdtt  = %dec(xan08:8:0);
             endif;
           endsl;
           x8_xrlev8 = x8_xrlev8 + 1;
           chain (xrsn:x8_xrlev1:x8_xrlev2:x8_xrlev3:x8_xrlev4:x8_xrlev5
                 :x8_xrlev6:x8_xrlev7:x8_xrlev8:x8_xrlev9) xmlrcvf;
         enddo;

       endsr;

       //**********************************************
       begsr opdavg;
       //**********************************************

         chain (x_agtanr: x_agakd: x_agskv: x_agdtf) sadavge;
         if x_agpp = 'P';
           agpp   = '%';
         else;
           agpp   = x_agpp;
         endif;
         agsats = x_agsats;
         if %found;
           // Oppdater ny FF-avgiftsats
           if x_agdtt <> 0 and agdtt = 0;
             agdtt = x_agdtt;
           endif;
           update sadavger;
         else;
           // Ny FF-avgift
           agtanr = x_agtanr;
           agakd  = x_agakd;
           agskv  = x_agskv;
           agdtf  = x_agdtf;
           if x_agdtt = 0;
             agdtt  = 99991231;
           else;
             agdtt = x_agdtt;
           endif;
           agkd   = ' ';
           agaktk = ' ';
           write sadavger;
           // Oppdater sluttdato på tidligere sats
           setll (x_agtanr: x_agakd: x_agskv: x_agdtf) sadavge;
           readpe (x_agtanr: x_agakd: x_agskv) sadavge;
           dow not %eof;
             if agdtf < x_agdtf;
               if agdtt = 0;
                 agdtt = x_agdtf;
               endif;
               leave;
             endif;
             readpe (x_agtanr: x_agakd: x_agskv) sadavge;
           enddo;
         endif;

         clear sadavger;

       endsr;

       //**********************************************
       begsr init;
       //**********************************************

         xrsn = %dec(usn:9:0);

       endsr;

      /end-free
