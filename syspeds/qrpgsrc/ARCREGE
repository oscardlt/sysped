Ram   * ramberg skal ikke sende faktura til avdelinger under nr 100
     H DECEDIT(',') debug(*yes)
      ***********************************************************
      *** PROGRAM for arkivering
      ***********************************************************
     FARCREGED  CF   E             WORKSTN
     FARUSERL1  IF   E           K DISK
     Fcundl01   IF   E           K DISK
     FFAK9      IF   E           K DISK
     FFIRM      IF   E           K DISK
     FARKEPO    UF A E           K DISK
     FARKTXT    IF   E           K DISK
     FCUNDC03   IF   E           K DISK
     FFain      IF   E           K DISK
     FFIRMARC   IF   E           K DISK
     FARKIVL06  IF   E           K DISK
     F                                     RENAME(arkivr:arkivr2)
     D                SDS
     D  UUSR                 254    263
     D                 DS
     D  FADATO                 1      8  0
     D  FAAA                   3      4
     D  FAMM                   5      6
     D  FADG                   7      8
     D                 DS
     D  avdopd                 1     11
     D  aravd                  1      4  0
     D  aropd                  5     11  0
     D                 DS
     D  ag                     1    800  0
     D                                     DIM(100)
     D                 DS
     D  hegn                   1     15
     D  hegn11                 5     15
     D                 DS
     D  V                      1     60
     D                                     DIM(30)
     D  arkved                 1     60
     D  V01                    1      2
     D  V02                    3      4
     D  V03                    5      6
     D  V04                    7      8
     D  V05                    9     10
     D  V06                   11     12
     D  V07                   13     14
     D  V08                   15     16
     D  V09                   17     18
     D  V10                   19     20
     D  V11                   21     22
     D  V12                   23     24
     D  V13                   25     26
     D  V14                   27     28
     D  V15                   29     30
     D  V16                   31     32
     D  V17                   33     34
     D  V18                   35     36
     D  V19                   37     38
     D  V20                   39     40
     D  V21                   41     42
     D  V22                   43     44
     D  V23                   45     46
     D  V24                   47     48
     D  V25                   49     50
     D  V26                   51     52
     D  V27                   53     54
     D  V28                   55     56
     D  V29                   57     58
     D  V30                   59     60
     D vedleggf        C                   CONST('Fakturaen er sendt -
     D                                     som PDF-vedlegg')
     D vedlegga        C                   CONST('Avregning er sendt -
     D                                     som PDF-vedlegg')
     D vedleggg        C                   CONST('Godsliste er sendt -
     D                                     som PDF-vedlegg')
     D vedleggt        C                   CONST('Tolldeklarasjon er sendt -
     D                                     som PDF-vedlegg')
     D trykkf          C                   CONST('Trykk på link for å -
     D                                     se på faktura')
     D trykka          C                   CONST('Trykk på link for å -
     D                                     se på avregning')
     D trykkg          C                   CONST('Trykk på link for å -
     D                                     se på godsliste')
     D trykkt          C                   CONST('Trykk på link for å -
     D                                     se på Tolldeklarasjon')
      *
     c                   exsr      init
      *
      * fix nøkkel
      *
     c     keyark        klist
     c                   kfld                    arfirm
     c                   kfld                    artype
     c                   kfld                    arunde
      *
     c     start         tag
     c                   exfmt     BILDE01
     c   03              goto      slutt
     c  N10              goto      start
      *
     c                   sub       1             fakfra
     c     fakfra        dowle     faktil
     c                   add       1             fakfra
      *
      * test singel
      *
     c                   move      '01'          arfirm
     c                   move      'fa'          artype
     c                   movel     fakfra        arunde
     c     keyark        chain     arkivl06                           33
     c     *in(33)       ifeq      '0'
     c     arlink        andne     *blanks
     c                   exsr      pdfinv
     c                   else
     c                   move      'fx'          artype
     c     keyark        chain     arkivl06                           33
     c   33              move      'fs'          artype
     c   33keyark        chain     arkivl06                           33
     c     *in(33)       ifeq      '0'
     c     arlink        andne     *blanks
     c                   move      'fs'          artype
     c                   exsr      pdfinvs
     c                   end
     c                   end
     c                   end
     c     slutt         tag
     c                   seton                                        lr
     c                   return
      *
     C***********************************************
     C     PDFINV        BEGSR
     C***********************************************
     C                   MOVEL     ARUNDE        AFAK              6
     C                   MOVEL     ARUNDE        fafakt
     c* ordner start av linken med forståelig info
     c*
     c**                 move      *blanks       arlink
     c**                 movel     artype        arlink
     c**                 movel     ardate        aar               4
     C**   arlink        CAT       aar:0         arlink
     C**   arlink        CAT       afak:0        arlink
     c                   move      'J'           fins1             1
     c                   move      'N'           fins2             1
     C*
     C     faktkk        KLIST
     C                   KFLD                    fifirm
     C                   KFLD                    fakunr
     C*
     c     artype        chain     ARKTXT                             33
     C  N33ARKJN         IFEQ      'J'
      *
      * Singel faktura til arkiv
      *
     C                   exsr      genbane
     C                   CALL      'ARCREGE2'
     C                   PARM                    AAVD
     C                   PARM                    AFAK
     C                   PARM                    uhttpi
     C                   PARM                    ubane
     c                   parm                    fins1
     c                   parm                    ubanes
     c                   parm                    fins2
     C                   PARM                    ARCINF
     c     fins1         ifeq      'X'
     c                   move      'J'           fins1             1
     c                   goto      utsr1
     c                   end
     C*
      *
      * skal kunde ha mail
      *
     c     fafakt        chain     fak9                               33
     c     *in(33)       ifeq      '0'
ram  c     faavd         andge     100
     c                   z-add     fakunr        tuknt             8 0
     C     ARKSND        IFEQ      'J'
     C                   MOVE      ARTXT         MAIL16           16
     C                   MOVEL     '*'           MAIL16
     c                   movel     MAIL16        mail30           30
     c                   moveL     artxt         wstex1           30
     c                   setoff                                       44
     c     mailk         setll     cundc03
     c     *in(44)       doweq     '0'
     c     mailk         reade     cundc03                                44
     c     *in(44)       ifeq      '0'
     c                   move      *blanks       eplink
     c                   move      *blanks       epline
     c                   move      *blanks       epbane
      *
      * slett eventuellt gamle poster
      *
     c                   exsr      delark
     c                   move      *blanks       wstex2           60
     C                   movel     'Fakturanr:'  wstex2
     C     wstex2        CAT       afak:1        wstex2
     C     wstex2        CAT       'fakturada':1 wstex2
     C     wstex2        CAT       'to:':0       wstex2
     C     wstex2        CAT       fadg:1        wstex2
     C     wstex2        CAT       '.':0         wstex2
     C     wstex2        CAT       famm:0        wstex2
     C     wstex2        CAT       '.':0         wstex2
     C     wstex2        CAT       faaa:0        wstex2
     c     faktkk        CHAIN     CUNDL01                            33
     C  N33wstex2        cat       'Til:':1      wstex2
     C  N33wstex2        cat       knavn:1       wstex2
     c                   move      uusr          epuser
     c                   movel     uhttpi        eplink
     c                   movel     uhttpe        epline
     C     CLIVE         IFEQ      'V'
     c                   eval      EPBANE = UBANE
     C                   END
      *
      * skjekk om mailbruker  er intern
      *
     C                   MOVE      'E'           inteks
     C     CEMAIL        CHAIN     ARUSERL1                           33
     C  N33arinek        ifeq      'I'
     C                   MOVE      'I'           inteks
     c                   end
     c                   moveL     wstex1        eptex1
     c                   move      wstex2        eptex2
     c                   write     arkepor
     C                   move      *blanks       wscvp1
     C                   movel     'Faktura fra:'wscvp1
     C     wscvp1        cat       fift:1        wscvp1
     C     CLIVE         IFNE      'V'
     C                   movel     trykkf        wscvp2
     C                   else
     c                   movel     vedleggf      wscvp2
     C                   end
     C     ARKVED        IFNE      *BLANKS
     C                   CALL      'ARC002V'
     C                   PARM                    ARTYPE
     C                   PARM                    Aavd
     C                   PARM                    Aopd
     C                   PARM                    ARKVED
     C                   PARM                    CLIVE
     C                   PARM                    arinek
     C                   END
     c                   call      'ARC009CL'
     c                   parm                    CEMAIL
     c                   parm                    wscvp1           40
     c                   parm                    wscvp2           40
     c                   parm                    wscvp3           40
     c                   parm                    wscvp4           40
     C                   parm                    wscvp5           40
     C                   parm                    wscvp6           40
     C                   parm                    wscvp7           40
     C                   parm                    wscvp8           40
     C                   parm                    inteks            1
     c                   end
     c                   end
     c                   end
     c                   end
     c                   end
     C     utsr1         ENDSR
     C***********************************************
     C     PDFINVS       BEGSR
     C***********************************************
      *
      * samlefaktura
     c                   move      aravd         xxavd
     c                   move      'J'           fins1             1
     c                   move      'J'           fins2             1
     c                   Move      'A'           arSTAT
     C                   MOVEL     ARUNDE        fifn
     C                   MOVEL     ARUNDE        AFAK              6
     C                   MOVEL     ARUNDE        fafakt
     c                   move      'A'           arstat
      * skal arkivering skje
      *
     c     artype        chain     ARKTXT                             33
     C  N33ARKJN         IFEQ      'J'
     c                   setoff                                       35
     c     fifn          chain     fain                               33
     c     xxavd         ifeq      *zeros
     c                   move      fiavd         xxavd             4
     c                   end
      *****************************************************************************
      * genererer bane til spesifikasjon
      *****************************************************************************
     C                   MOVE      *zeros        ARAVD
     C                   MOVE      *zeros        AROPD
      *
      * ordner start av linken med forståelig info
      *
     c                   exsr      genbane
     c                   move      *blanks       ubanes           50
     c                   movel     ubane         ubanes
     c                   move      *blanks       uhttpis          76
     c                   movel     uhttpi        uhttpis
     c                   move      *blanks       uhttpes          76
     c                   movel     uhttpe        uhttpes
     c                   movel     arlink        arlinks          40
      *
      * genererer bane til selve fakturaen
      *
     c                   movel     arlink        arlinkf          40
      *
     C                   CALL      'ARCREGE2'
     C                   PARM                    XXavd
     C                   PARM                    AFAK
     C                   PARM                    uhttpi
     C                   PARM                    ubane
     c                   parm                    fins1
     c                   parm                    ubanes
     c                   parm                    fins2
     C                   PARM                    ARCINF
     C*
     c     fins1         ifeq      'X'
     c                   move      'J'           fins1             1
     c                   goto      utsr2
     c                   end
      *
      *
      * skal kunde ha mail av samlefaktura
      *
     c     artype        chain     ARKTXT                             33
     C  N33ARKJN         IFEQ      'J'
ram  c     fiavd         andge     100
      *
      * SKAL skal ha en mail
      *
     c     fafakt        ifne      gmfakt
     c                   z-add     fafakt        gmfakt            6 0
     c     fafakt        chain     fak9                               33
     c     *in(33)       ifeq      '0'
     c                   z-add     fakunr        tuknt
     C     ARKSND        IFEQ      'J'
     C                   MOVE      ARTXT         MAIL16           16
     C                   MOVEL     '*'           MAIL16
     c                   movel     MAIL16        mail30           30
     c                   moveL     artxt         wstex1           30
     c                   setoff                                       44
     c     mailk         setll     cundc03
     c     *in(44)       doweq     '0'
     c     mailk         reade     cundc03                                44
     c     *in(44)       ifeq      '0'
     c                   move      *blanks       eplink
     c                   move      *blanks       epline
     c                   move      *blanks       epbane
     c* slett eventuellt gamle poster
     c                   exsr      delark
     c                   move      *blanks       wstex2
     C                   movel     'Fakturanr:'  wstex2
     C     wstex2        CAT       afak:1        wstex2
     C     wstex2        CAT       'fakturada':1 wstex2
     C     wstex2        CAT       'to:':0       wstex2
     C     wstex2        CAT       fadg:1        wstex2
     C     wstex2        CAT       '.':0         wstex2
     C     wstex2        CAT       famm:0        wstex2
     C     wstex2        CAT       '.':0         wstex2
     C     wstex2        CAT       faaa:0        wstex2
     c     faktkk        CHAIN     CUNDL01                            33
     C  N33wstex2        cat       'Til:':1      wstex2
     C  N33wstex2        cat       knavn:1       wstex2
     c                   move      uusr          epuser
     c                   move      *blanks       eplink
     c                   move      *blanks       epline
     C                   MOVE      *BLANKS       EPBANE
     c     fins1         ifeq      'J'
     c                   movel     uhttpi        eplink
     c                   movel     uhttpe        epline
     C     CLIVE         IFEQ      'V'
     c                   eval      EPBANE = UBANE
     C                   END
      * skjekk om mailbruker  er intern
     C                   MOVE      'E'           inteks
     C     CEMAIL        CHAIN     ARUSERL1                           33
     C  N33arinek        ifeq      'I'
     C                   MOVE      'I'           inteks
     c                   end
     c                   movel     wstex1        eptex1
     c                   move      wstex2        eptex2
     c                   write     arkepor
     c                   end
      *
      *spesifikasjon
      *
     c     fins2         ifeq      'J'
      *
      * skjekk om mailbruker  er intern
      *
     c                   movel     uhttpis       eplink
     c                   movel     uhttpes       epline
     C     CLIVE         IFEQ      'V'
     c                   eval      EPBANE = UBANES
     C                   END
     C                   MOVE      'E'           inteks
     C     CEMAIL        CHAIN     ARUSERL1                           33
     C  N33arinek        ifeq      'I'
     C                   MOVE      'I'           inteks
     c                   end
     c     fins1         ifeq      'J'
     c                   move      *blanks       wstex1           30
     c                   moveL     'Spesifikasjo'wste13           13
     c                   move      'n'           wste13
     c                   moveL     wste13        wstex1           30
     c                   end
     c                   movel     wstex1        eptex1
     c                   move      wstex2        eptex2
     c                   write     arkepor
     c                   end
     C                   move      *blanks       wscvp1
     C                   movel     'Faktura fra:'wscvp1
     C     wscvp1        cat       fift:1        wscvp1
     C                   move      *blanks       wscvp2
     C     CLIVE         IFNE      'V'
     C                   movel     trykkf        wscvp2
     C                   else
     c                   movel     vedleggf      wscvp2
     C                   end
     c                   call      'ARC009CL'
     c                   parm                    CEMAIL
     c                   parm                    wscvp1           40
     c                   parm                    wscvp2           40
     c                   parm                    wscvp3           40
     c                   parm                    wscvp4           40
     C                   parm                    wscvp5           40
     C                   parm                    wscvp6           40
     C                   parm                    wscvp7           40
     C                   parm                    wscvp8           40
     C                   parm                    inteks            1
     c                   end
     c                   end
     c                   end
     c                   end
     c                   end
     c                   end
     c                   end
     C     utsr2         ENDSR
     C*
     C***********************************************
     C     genbane       BEGSR
     C***********************************************
      * genererer bane for lagring
      *
     C                   MOVE      'N'           vise              1
     C                   MOVE      ARAVD         AAVD              4
     C                   MOVE      AROPD         AOPD              7
      *
      * lager http for interne brukere
      *
     C                   move      *blanks       uhttpi
     c                   movel     uhttpista     uhttpi           76
     C     uhttpi        CAT       arlink:0      uhttpi
     C     uhttpi        CAT       '.pdf':0      uhttpi
      * lager http for interne brukere
     C                   move      *blanks       uhttpe           76
     c                   movel     uhttpesta     uhttpe
     C     uhttpe        CAT       arlink:0      uhttpe
     C     uhttpe        CAT       '.pdf':0      uhttpe
      *
      * lager bane til IFS
      *
     C                   move      *blanks       ubane            50
     C                   movel     ubanesta      ubane
     C     ubane         CAT       arlink:0      ubane
     C     ubane         CAT       '.pdf':0      ubane
     c                   endsr
      *
     C***********************************************
     C     init          BEGSR
     C***********************************************
     C*
     c                   move      uusr          xxUSER           10
     C                   MOVE      'N'           vise              1
      *
     c                   move      uusr          uuser            10
      *
      *
     c     mailk         klist
     c                   kfld                    fifirm
     c                   kfld                    mail30
     c                   kfld                    tuknt
     C     KEYHEA        KLIST
     C                   KFLD                    ARAVD
     C                   KFLD                    AROPD
      *
     C*
     c                   read      firm                                   33
     c                   read      firmarc                                33
     c     *in33         ifeq      '1'
     c                   seton                                        lr
     c                   return
     c                   end
      *
      * med vennlig hilsen
      *
     c                   move      'N'           arcinf            1
     c                   movel     '.'           wscvp3
     c                   movel     'Med vennlig 'wscvp4
     C     wscvp4        CAT       'hilsen':1    wscvp4
     C                   movel     fift          wscvp5
     c*
     c*
     c*
     C* lager starten på http og IFS-bane  intern ekstern
     c*
     c*
      * lager http for interne brukere
      *
      * intern
      *
     C                   move      *blanks       uhttpista        76
     c                   movel     'http://'     uhttpista
     C     uhttpista     CAT       arcpad:0      uhttpista
     C     uhttpista     CAT       '/':0         uhttpista
     C     uhttpista     CAT       arcane:0      uhttpista
     C     uhttpista     CAT       '/':0         uhttpista
      *
      * ekstern
      *
     C                   move      *blanks       uhttpesta        76
     c                   movel     'http://'     uhttpesta
     C     uhttpesta     CAT       arcpae:0      uhttpesta
     C     uhttpesta     CAT       '/':0         uhttpesta
     C     uhttpesta     CAT       arcane:0      uhttpesta
     C     uhttpesta     CAT       '/':0         uhttpesta
      *
      * lager bane til IFS
      *
     C                   movel     '/'           ubanesta         70
     C     ubanesta      CAT       arcane:0      ubanesta
     C     ubanesta      CAT       '/':0         ubanesta
     c                   endsr
     C***********************************************
     C     delark        BEGSR
     C***********************************************
     c                   move      *blanks       epbane
     c                   move      '0'           *in(39)
     c     uusr          setll     arkepo
     c     *in(39)       doweq     '0'
     c     uusr          reade     arkepo                                 39
     c     *in(39)       ifeq      '0'
     c                   delete    arkepor
     c                   end
     c                   end
     c                   endsr
      *stykkgods fraktbrev
     C*
