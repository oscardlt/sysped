      *********************************************************************
      *
CRTPG+*  CRTPGM SYSPED/TDCE022R MODULE(*LIBL/TDCE022R *LIBL/INCGI)
CRTPGM*        ACTGRP(*NEW) AUT(*USE)
      *
      *********************************************************************
      /copy SYSPEDS/qrpgsrcpy,hspecs
      /copy SYSPEDS/qrpgsrcpy,hspecsbnd
      *********************************************************************
     FBRIDF     IF   E           K DISK    USROPN
     FDKXHFV    IF   E             DISK    USROPN
      *--------------------------------------------------------------------
      * Variables common to all CGIs
      *--------------------------------------------------------------------
      /copy SYSPEDS/qrpgsrcpy,prototypeb
      /copy SYSPEDS/qrpgsrcpy,usec
      /copy SYSPEDS/qrpgsrcpy,variables3
     ‚*  Prototype for 'JSONFIX'
     d jsonfix         pr                  extpgm('JSONFIX')
     d jsonstring_                         like(jsonstring)
     ‚*  Prototype for 'INCGI'
     d incgi           pr                  extproc('INCGI')
     d bistdl_                             like(bistdl)
     ‚*  Prototype for variabel program
     D Varpgm          Pr                  ExtPgm(BILIBL)
      * Varible for
     D WSUSER          S             10
     D WMODE           S              1
     D JSONstring      s          32000
     D Error           S            150
     D AntLest         S              9  0
     d myrows          s             10i 0
     d  X              S              5  0
     d  WERR           S              1
     d  W              S             20

      *get input-string
      /copy syspeds/qrpgsrcpy,prolog3
        /free

        // Parse input
         exsr Parse;
        // Open files etc
         exsr Init;

       gethtmlifs(
       '/syspeddev/html/JSON.html':
       '/CGITAG/');
       wrtsection('top');

       //...........................................................................................
       //skriv JSON-Object start (alltid '{' + x ant param. m/komma mellom (IKKE komma etter siste))
       //...........................................................................................

        JSONstring='{'
        +'¬user¬ : ¬'+%trim(WSUSER)+'¬, '
        +'¬errMsg¬ : ¬'+%trim(Error)+'¬, ';

       //JSONfix escaper " i tekst,  for deretter å bytte ¬->"

       jsonfix ( jsonstring );

       updhtmlvar2('JSONstring'
                  :%addr(jsonstring)
                  :%len(jsonstring));
       wrtsection('JSONlin');

       //...........................................................................................
       // Skriv JSON-LISTE Start (en liste er EN parameter(fra [ til   )
       //..........................................................................................
       jsonstring ='"securityheadadd" : [';

       updhtmlvar2('JSONstring'
                  :%addr(jsonstring)
                  :%len(jsonstring));
       wrtsection('JSONlin');

       if error = *blanks;
         // Hæmta til array
         select;
         when wmode = 'A';
         exsr sradd;
         when wmode = 'D';
         exsr srdel;
         when wmode = 'U';
         exsr srupd;
         endsl;
         // Avsluta
         exsr avslut;
       endif;
       // ..........................................................................................
       // Skriv JSON-Liste/Array  Avslutning
       // ..........................................................................................
       jsonstring =']';
       updhtmlvar2('JSONstring'
                  :%addr(jsonstring)
                  :%len(jsonstring));
       wrtsection('JSONlin');
       // ..........................................................................................
       // Skriv JSON-string Avsluttning
       // ..........................................................................................
       jsonstring ='}';
       updhtmlvar2('JSONstring'
                  :%addr(jsonstring)
                  :%len(jsonstring));
       wrtsection('JSONlin');

       // Quit
       exsr exit;

       //=====================================================================
       // Close output html and quit
       //=====================================================================
       begsr exit;
         // Lukk fil
         close bridf;
         if *in50 = *off;
         close DKXHFV;
         endif;

         // Do not delete the call to wrtsection with section name *fini.  It is needed
         // to ensure that all output html that has been buffered gets output.
         wrtsection('*fini');
         // Quit
         *inlr = *on;
         return;
       endsr;
       //********************************************************
       begsr parse;
       //********************************************************
       // Get input
        wsuser  = zhbgetvar('USER');
        wmode   = zhbgetvar('MODE');
        w         = zhbgetvar('THAVD');
        THAVD     = c2n2(w);
        w         = zhbgetvar('THTDN');
        THTDN     = c2n2(w);
        w         = zhbgetvar('THSIK');
        THSIK     = c2n2(w);
        w         = zhbgetvar('THDTA');
        THDTA     = c2n2(w);
        w         = zhbgetvar('THTMA');
        THTMA     = c2n2(w);
        THSPOM    = zhbgetvar('THSPOM');
        THTKBM    = zhbgetvar('THTKBM');
        THKREF    = zhbgetvar('THKREF');
        THTREF    = zhbgetvar('THTREF');
        THLOSD    = zhbgetvar('THLOSD');
        THLOSDSK  = zhbgetvar('THLOSDSK');
        THLKR1    = zhbgetvar('THLKR1');
        THLKR2    = zhbgetvar('THLKR2');
        THLKR3    = zhbgetvar('THLKR3');
        THLKR4    = zhbgetvar('THLKR4');
        THLKR5    = zhbgetvar('THLKR5');
        THLKR6    = zhbgetvar('THLKR6');
        THLKR7    = zhbgetvar('THLKR7');
        THLKR8    = zhbgetvar('THLKR8');
        w         = zhbgetvar('THKNSS');
        THKNSS    = c2n2(w);
        THNASS    = zhbgetvar('THNASS');
        THADSS1   = zhbgetvar('THADSS1');
        THPNSS    = zhbgetvar('THPNSS');
        THPSSS    = zhbgetvar('THPSSS');
        THLKSS    = zhbgetvar('THLKSS');
        THSKSS    = zhbgetvar('THSKSS');
        THTINSS   = zhbgetvar('THTINSS');
        w         = zhbgetvar('THKNKS');
        THKNKS    = c2n2(w);
        THNAKS    = zhbgetvar('THNAKS');
        THADKS1   = zhbgetvar('THADKS1');
        THPNKS    = zhbgetvar('THPNKS');
        THPSKS    = zhbgetvar('THPSKS');
        THLKKS    = zhbgetvar('THLKKS');
        THSKKS    = zhbgetvar('THSKKS');
        THTINKS   = zhbgetvar('THTINKS');
        w         = zhbgetvar('THKNT');
        THKNT     = c2n2(w);
        THNAT     = zhbgetvar('THNAT');
        THADT1    = zhbgetvar('THADT1');
        THPNT     = zhbgetvar('THPNT');
        THPST     = zhbgetvar('THPST');
        THLKT     = zhbgetvar('THLKT');
        THSKT     = zhbgetvar('THSKT');
        THTINT    = zhbgetvar('THTINT');

       endsr;
       //********************************************************
       begsr init;
       //********************************************************
         open bridf;
         // Test innlogging
         chain wsuser bridf;
         *in50 = not %found;

         if *in50 = *off;
           if bilibl = *blanks;
             incgi ( bistdl );
           else;

             Monitor;
                   Varpgm();
                 On-Error;
                   //
                 EndMon;

           endif;
        //Dummy read for feltbeskrivelser, kuttes ut i java
         open dkxhfv;
         if *in50 = *on;
         read dkxhfv;
         endif;
         else;

           error = 'Invalid userID';
         endif;

       endsr;
        // __________________________________________________
        // Addera post till fil                         SRADD
        // """"""""""""""""""""""""""""""""""""""""""""""""""
           begsr sradd;

          exec sql

          INSERT INTO DKXHFV
          (THAVD, THTDN, THSIK, THDTA, THTMA, THSPOM, THTKBM, THKREF,
          THTREF, THLOSD, THLOSDSK, THLKR1, THLKR2, THLKR3, THLKR4,
          THLKR5, THLKR6, THLKR7, THLKR8, THKNSS, THNASS, THADSS1,
          THPNSS, THPSSS, THLKSS, THSKSS, THTINSS, THKNKS, THNAKS,
          THADKS1, THPNKS, THPSKS, THLKKS, THSKKS, THTINKS, THKNT,
          THNAT, THADT1, THPNT, THPST, THLKT, THSKT, THTINT)
          VALUES(:THAVD, :THTDN, :THSIK, :THDTA, :THTMA, :THSPOM,
          :THTKBM, :THKREF, :THTREF, :THLOSD, :THLOSDSK, :THLKR1,
          :THLKR2, :THLKR3, :THLKR4, :THLKR5, :THLKR6, :THLKR7,
          :THLKR8, :THKNSS, :THNASS, :THADSS1, :THPNSS, :THPSSS,
          :THLKSS, :THSKSS, :THTINSS, :THKNKS, :THNAKS, :THADKS1,
          :THPNKS, :THPSKS, :THLKKS, :THSKKS, :THTINKS, :THKNT,
          :THNAT, :THADT1, :THPNT, :THPST, :THLKT, :THSKT, :THTINT)
          WITH NC;

       endsr;
        // __________________________________________________
        // Update post i fil                            SRUPD
        // """"""""""""""""""""""""""""""""""""""""""""""""""
           begsr srupd;

          exec sql

          UPDATE DKXHFV
          SET THSIK=:THSIK, THDTA=:THDTA, THTMA=:THTMA,
          THSPOM=:THSPOM, THTKBM=:THTKBM, THKREF=:THKREF,
          THTREF=:THTREF, THLOSD=:THLOSD, THLOSDSK=:THLOSDSK,
          THLKR1=:THLKR1, THLKR2=:THLKR2, THLKR3=:THLKR3,
          THLKR4=:THLKR4, THLKR5=:THLKR5, THLKR6=:THLKR6,
          THLKR7=:THLKR7, THLKR8=:THLKR8, THKNSS=:THKNSS,
          THNASS=:THNASS, THADSS1=:THADSS1, THPNSS=:THPNSS,
          THPSSS=:THPSSS, THLKSS=:THLKSS, THSKSS=:THSKSS,
          THTINSS=:THTINSS, THKNKS=:THKNKS, THNAKS=:THNAKS,
          THADKS1=:THADKS1, THPNKS=:THPNKS, THPSKS=:THPSKS,
          THLKKS=:THLKKS, THSKKS=:THSKKS, THTINKS=:THTINKS,
          THKNT=:THKNT, THNAT=:THNAT, THADT1=:THADT1,
          THPNT=:THPNT, THPST=:THPST, THLKT=:THLKT,
          THSKT=:THSKT, THTINT=:THTINT
          WHERE THAVD=:THAVD and THTDN=:THTDN
          WITH NC;

       endsr;
        // __________________________________________________
        // Slette post i fil                            SRDEL
        // """"""""""""""""""""""""""""""""""""""""""""""""""
           begsr srdel;

          exec sql

          DELETE FROM DKXHFV
          WHERE THAVD=:THAVD and THTDN=:THTDN
          WITH NC;

       endsr;
        // __________________________________________________
        // Avsluta                                     AVSLUT
        // """"""""""""""""""""""""""""""""""""""""""""""""""
           begsr avslut;
          JSONstring=*blanks;
       JSONstring=%trim(JSONstring)+'{'
          +'¬result¬ : ¬'+ 'ok' + '¬}';
         jsonfix (JSONstring);
       updhtmlvar2('JSONstring'
                  :%addr(jsonstring)
                  :%len(jsonstring));
         wrtsection ('JSONlin');

       endsr;
      /end-free
