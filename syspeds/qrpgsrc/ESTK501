      *********************************************************************
      *
CRTPG+*  CRTPGM SYSPED/ESTK501 MODULE(*LIBL/ESTK501 *LIBL/INCGI)
CRTPGM*         ACTGRP(*NEW) AUT(*USE)
      *
********************************************************************
      * RETTINGER I DETTE PROGRAM:
PTFnr:*Sek Sig Vers  Beskrivelse...........................
""""""*"""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""
10XXX * 01 JOV PTF10 STØRRE OMSKRIVING - GAMMER MERKING FJERNET
10XXX *        fra V02.37 ALLTID avd_oppd som "sendnr"(5) mens fr.brnr sendes i Kref(37)
10XXX *        versjontester t.o.m. 20 fjernet, Aktiv send av '*blanks' i term gjeninnført MM
      * 02 JOV PTF10 Omskrivingen i ptf01 klusset til NØKKEL (5) ved delete...
      * 03 JOV PTF10 IKKE ta hensyn til hendelser som har 'KOP' i event (kommer fra andre oppdrag)
10XXX * 04 JOV PTF10 Noen merkelige kall med blank i alle param (spes hos grieg) libl=1
P10047* 05 Jov PTF10 Error ved ukjent user flyttes til INIT-rutine
P10118* 06 JOV PTF10 Test endret navn/adr - Nå hvert ledd for seg (før samlet avs/ mot)
      * 07 JOV PTF10 Utfylt HESDL teller IKKE som levering tl terminal
      * 08 JOV PTF10 Tidligere TE2 teller som levert/POD kun når utført av PD.. (TKsignPDA)
      * 09 JOV PTF10 Kutte manuell UTF8-konvertering - krever at HTTP-server er satt opp med UTF8
      * 10 JOV PTF10 H/L-tid på egen notislinje - fast lengde
      * 11 JOV PTF10 Varelinje-info/merker på linjenivå
      * 12 JOV PTF10 Også ved refresh av dummy Tur 99999999 må '##INGEN ENDRING' inn i svaret
10XXX * 13 JOV PTF11 både senders og mottakers ref
********************************************************************
      /copy syspeds/qrpgsrcpy,hspecs
      /copy syspeds/qrpgsrcpy,hspecsbnd
     FBRIDF     IF   E           K DISK    USROPN
     FBRPARF    if   e           k disk    usropn
     FTURER14   UF   E           K DISK    USROPN
     FTKSGM     UF A E           K DISK    USROPN
     FTurer20   IF   E           K DISK    USROPN
     F                                     RENAME(TURERR:TURERR20)
     FHeadF     IF   E           K DISK    USROPN
     FHead11    IF   E           K DISK    USROPN
     F                                     RENAME(HEADFR:HEADFR11)
     FHead39    IF   E           K DISK    USROPN
     F                                     RENAME(HEADFR:HEADFR39)
     FFREETXT2  UF   E           K DISK    USROPN
     FFREETUR2  UF   E           K DISK    USROPN
     FDOKUF     IF   E           K DISK    USROPN
N11  FDOKUFV    IF   E           K DISK    USROPN
     FDOKUFM    IF   E           K DISK    USROPN
     FDOKUFM1   IF   E           K DISK    USROPN
     F                                     RENAME(DOKUFMR:DOKUFM1R)
     FFRISOK    IF   E           K DISK    USROPN
     FFRISOL01  IF   E           K DISK    USROPN
     F                                     RENAME(FRISOKR:FRI01R)
     FTRACKL02  IF   E           K DISK    USROPN
     FKUFAST    IF   E           K DISK    USROPN
     FKODTRI    IF   E           K DISK    USROPN
      *********************************************************************
      *--------------------------------------------------------------------
      * Variables common to all CGIs
      *--------------------------------------------------------------------
      /copy syspeds/qrpgsrcpy,prototypeb
      /copy syspeds/qrpgsrcpy,usec
      /copy syspeds/qrpgsrcpy,variables3
      *
      * Client input variables
     D user            s             10
     D Tur             s              8
     D TurNr           s              8  0
     D Snd             s             20
     D Snd17           s             17
     D Snd20           s             20
     D AvdAA           s             20
     D OpdAA           s             20
     D SJA             s              8
     D SJN             s              8  0
     D VERSJ           s             10
     D Status          s             25
     D TurInfo         s             20
     D LinTxt          s           5000
     D KOID            s             20
     D AntKOID         s              5  0
     D EKSTRA          s            256
     D EKSTRA2         s            256
     D Refresh         s              1
     D Tegn            s              1
     D HexTegn         s              2
     D TomTomSt        s             20
     D TTTest          s             30
     D ItemCount       s             10i 0
     D i               s             10i 0
     D i2              s             10i 0
      * Definere  hex Æ Ø Å æ ø å
     D HexÆ            c                   x'6606'
     D HexØ            c                   x'6638'
     D HexÅ            c                   x'66B2'
     D HexÆl           c                   x'6670'
     D HexØl           c                   x'669D'
     D HexÅl           c                   x'66B2'
      * Definere  hex appostrof
     D Appo            c                   x'7D'
      * Definere  hex 0D / 25 (CRLF)
     D Hex0D           c                   x'0D'
     D Hex25           c                   x'25'
      *
     D Spaces          s             12a   inz('&nbsp;&nbsp;')
     D                 DS
     D  HXSNDN                 1     20
     D  HXSND17B               4     20
     D  HXSND11_20            11     20
     D                 DS
     D  DOKFM1K                3     37
     D   DSSnd                 1     20
     D                 DS
     D   DSSnd2                1     20
     D   DSSnd1_3              1      3
     D   DSSnd4_20             4     20
     D   DSSnd11_20           11     20
     D   DSSnd17_17           17     17
     D   DSSnd18_18           18     18
     D                 DS
     D  DSAVOP                 1     12
     D  HEAVD                  1      4  0
     D  Strek                  5      5
     D  HEOPD                  6     12  0
     D                 DS
     D  TUDTA                  1      8
     D  TudtÅ                  1      4
     D  TudtM                  5      6
     D  TudtD                  7      8
     D                 DS
     D  TRSDFD                 1      8  0
     D  FMM                    5      6
     D  FDD                    7      8
N10  D                 DS
N10  D  TRSDFK                 1      4  0
N10  D  FTI                    1      2
N10  D  FMI                    3      4
     D                 DS
     D  TRSDTD                 1      8  0
     D  TMM                    5      6
     D  TDD                    7      8
N10  D                 DS
N10  D  TRSDTK                 1      4  0
N10  D  TTI                    1      2
N10  D  TMI                    3      4
     D                 DS
     D  HEVS1                  1     25
     D  HEVS1A                 1      4
     D  HEVS1B                 5     25
      *____________________________________
      * DS for leftjustify numericel fields
      *""""""""""""""""""""""""""""""""""""
     D                 DS
     D  ØN153                  1     15  3
     D  ØA153H                 1     12
     D  ØA153X                 5     12
     D  ØA153D                13     15
     D                 DS
     D  ØA12                   1     12
     D  Ø12                    1     12
     D                                     DIM(12)
      *
     D                 DS
     D  XULTID                 1     14  0
     D  XULTM                  1      6  0
     D  XULDD                  7      8  0
     D  XULMM                  9     10  0
     D  XULÅÅ                 11     14  0
     D                 DS
     D  ULÅÅ                   1      4  0
     D  ULMM                   5      6  0
     D  ULDD                   7      8  0
     D  ULDT                   1      8  0
     D                 DS
     D  Tst35                  1     70
     D  Tst35A                 1     35
     D  Tst35B                36     70
     D  Tst35C                70     70
     D                 DS
     D  FRTTXT                 1     70
     D  FRTT70                70     70
     D                 DS
     D  Info                   1    700
     D  INF                    1    700
     D                                     DIM(10)
     D                 DS
     D  Tinf                   1    700
     D  TIN                    1    700
     D                                     DIM(10)
     D                 DS
     D  HAR                    1    900
     D                                     DIM(100)
N08  D                 DS
N08  D  TTUSER                 1     10
N08  D  TTUS12                 1      2
      *
      /copy syspeds/qrpgsrcpy,prolog3
      *
      * Parse input / cvt to numeric
     C                   exsr      Parse
      * File open / keys
     C                   EXSR      INIT
      * Read output skeleton html member into memory
     C                   exsr      LoadHtml
      * Set section variables
     C                   exsr      SetAll
      * Quit
     C                   exsr      Exit
      *
     C                   eval      *inlr = *on
     C                   return
      *
      *
      *=====================================================================
      * Parse input / cvt to numeric
      *=====================================================================
     C     Parse         begsr
      * Parse variables from QUERY_STRING environment variable
      * Userid = PD+8 siffer (8 siffer er sjåførid)
     C                   eval      user = zhbgetvar('user')
     C                   move      user          SJA
     C                   eval      SJN     = c2n2(SJA)
      * versjonsnr av klientprogramvare
     C                   eval      VERSJ = zhbgetvar('V')
     C                   eval      TUR  = zhbgetvar('TUR')
     C                   eval      TURNR   = c2n2(TUR)
     C                   eval      ReFresh  = zhbgetvar('REFR')
     C                   eval      Snd  = zhbgetvar('SND')
S05  C     REFRESH       IFEQ      ' '
S05  C     Turnr         oreq      *zeros
N05  C*    REFRESH       IFNE      'J'
     C                   MOVE      'N'           REFRESH
     C                   END
     C                   endsr
      *=====================================================================
      * Close output html and quit
      *=====================================================================
     C     Exit          begsr
      * Do not delete the call to wrtsection with section name *fini.  It is needed
      * to ensure that all output html that has been buffered gets output.
     C                   callp     wrtsection('*fini')
      * Quit
     C                   CLOSE     BRIDF
     C                   CLOSE     TURER20
     C                   CLOSE     TURER14
     C                   CLOSE     HEADF
     C                   CLOSE     HEAD11
     C                   CLOSE     FRISOK
     C                   CLOSE     DOKUF
N11  C                   CLOSE     DOKUFV
     C                   CLOSE     DOKUFM
     C                   CLOSE     FREETXT2
     C                   CLOSE     FREETUR2
     C                   close     TKSGM
     C                   close     Trackl02
     C                   close     KUFAST
     C                   close     KODTRI
     C                   close     BRPARF
     C                   endsr
      *=====================================================================
      * Read output skeleton html member into memory
      *=====================================================================
     C     LoadHtml      begsr
     C                   callp     gethtml('HTMLSRC':
     C                             '*LIBL':
     C                             'ESTK501':'/CGITAG/')
     C                   endsr
      *=====================================================================
      *  Set variable data for section /$top , lin , Bot
      *=====================================================================
     C     SetAll        begsr
      * Send section top
     C                   callp     wrtsection('top')
S05  C* Ugyldig userID
S05  C*    *IN50         IFEQ      '1'
S05  C*                  eval      lintxt ='#ERROR# Ukjent userID'
S05  C*                  callp     updHTMLvar('LINTXT':LinTxt)
S05  C*                  callp     wrtsection('lin')
S05  C*                  goto      utles
S05  C*                  END
      *
      * Turnr blank/0 + sendnr oppgitt = HENTE ETT OPPDRAG.
     C     Snd           Ifne      *blanks
     C                   exsr      ETTOPD
     C                   goto      utles
     C                   end
      * Turnr oppgitt > gå innpå den
     C     TurNr         IFNE      *Zeros
     C     TurNr         IFEQ      99999999
     C     ReFresh       andeq     'J'
     C                   exsr      ANTTSR
     c                   else
     C                   exsr      ENTUR
     c                   end
     C                   goto      utles
     C                   end
      *
      * Finnses det turer -hvis ikke - egen alert-melding
     C     TURKEY20      chain     TURER20                            33
     C     *in33         IFEQ      '1'
     C                   callp     wrtsection('ingentop')
     C                   goto      utles
     C                   END
      *
      *  Vis turvelger..
     C                   callp     wrtsection('turtop')
     C     TURKEY20      setll     TURER20
     C     TURKEY20      Reade     TURER20                                33
     C     *IN33         DOWEQ     '0'
     C                   move      TUPRO         TUPROA            8
     C                   move      *blanks       TUDTA             8
     C     TUDT          Ifne      *zeros
     C     TUDT          andne     99999999
     C                   move      TUDT          TUDTA
     C                   end
     C                   EXSR      GetTurInfo
     C     Tust          ifeq      ' '
     C     Tust          oreq      'P'
     C                   eval      Status = 'Under planlegging'
     c                   else
     C                   eval      Status = 'Planlegging avsluttet'
     c                   end
     C                   eval      lintxt =TUPROA+';'+
     C                             %trim(%editW(TUDT:'    .  .  '))+';'+
     C                             'Status.: ' + Status + CrLf +
     C                             'Ant ord: '+%trim(%editc(TUAO:'3'))+
     C                             '  Vkt: '+%trim(%editc(TUTVKT:'3'))+
     C                             '  Vol: '+%trim(%editc(TUTM3:'M'))+' M3'+
     C                             CrLf+'Fra: ' + %trim(TUSDF) +
     C                             ' Til: ' + %trim(TUSDT) +
     C                             CrLf+'Kommentar: ' +CrLf+%trim(TuInfTxt)
     C                   callp     updHTMLvar('LINTXT':LinTxt)
     C                   callp     wrtsection('lin')
     C     TURKEY20      Reade     TURER20                                33
     c                   end
      *
      *
     c     UtLes         tag
      * Send section bot
     C                   callp     wrtsection('bot')
     C
     C                   endsr
      *=====================================================================******
      *  EnTur - Legg ut sendingsdta for EN tur
      *=====================================================================******
     C     EnTur         begsr
      * EN tur - vis godsliste - sett kode 1=hentet i TUSTS4
     C                   callp     wrtsection('godsltop')
     C     TURNR         CHAIN     TURER14                            33
     C     *IN33         IFEQ      '0'
     C     REFRESH       IFeq      'N'
     C                   move      '1'           TUTST4
     C                   END
     C                   update    turerr
     C                   END
      * Finn antall turer i turvelgere for å varsle ved endring..
     C                   EXSR      ANTTSR
     C     TURNR         CHAIN(N)  TURER14                            33
      * Initier oversikt over oppdrag som alt er sendt til pda på denne turen
     c                   exsr      IniTKSGM
      *
      * Les tur (i stigende pos.nr)
     C                   Move      *zeros        Antpos            3 0
     C                   exsr      Turhead
      *
     C     TUPRO         setll     HEAD11
     C     TUPRO         Reade     HEAD11                                 33
     C     *IN33         DOWEQ     '0'
      * Hent info som må"settes sammen" for å kunne  teste mot gml v/refresh
     C                   EXSR      GetInfo
     C                   movea     '0000000000'  *IN(60)                        60-69
     C                   movea     '0000000000'  *IN(70)                        70-79
     C                   movea     '0000000000'  *IN(80)                        80-89
      *
     C     Refresh       IFEQ      'J'
     C                   Exsr      FinsOPD
      * 60 ON = NOE er endret
     C     Finnes        IFEQ      'J'
     C     *in60         andeq     *off
     C                   GOTO      NXTOPD
     C                   end
     C                   end
      * dersom oppdrag alt er levert aksepteres ikke TIL PDA
     C                   move      'POD'         TTACTI
     c     TrackKey      Chain     TrackL02                           33
N03  C     *IN33         doweq     '0'
N03  c     TTEDRE        ifne      'KOP'
N03  c                   leave
N03  c                   endif
N03  c     TrackKey      reade     TrackL02                               33
N03  c                   enddo
     C     *IN33         cabeq     '0'           NXTOPD
      * "levert" til terminal logges som TE2 (sluttlevering)
      * logikk tar høyde for at det KAN finnes TE2 tidligere i kjeden..- Kun "Signed by" gir skipp.
     C                   move      'TE2'         TTACTI
     c     TrackKey      Chain     TrackL02                           33
s03  C*    *IN33         doweq     '0'
s03  C*                  movel     TTTEXT        TTTX1_9           9
s03  c*    TTTX1_9       cabeq     'Signed by'   Signed
s03  C*    TrackKey      reade     TrackL02                               33
s03  C*                  enddo
s03  c*    Signed        tag
N03  c     *IN33         doweq     '0'
N03  c     TTEDRE        ifne      'KOP'
N08  c     TTUS12        andeq     'PD'                                         kun TE2 fra PDA=POD
N03  c                   leave
N03  c                   endif
N03  c     TrackKey      reade     TrackL02                               33
N03  c                   enddo
     C     *IN33         cabeq     '0'           NXTOPD
      * Ved FF logges "levert" til terminal som TEI
     c     TRSLAG        ifeq      'FF'
     C                   move      'TEI'         TTACTI
     c     TrackKey      Chain     TrackL02                           33
N03  C     *IN33         doweq     '0'
N03  c     TTEDRE        ifne      'KOP'
N03  c                   leave
N03  c                   endif
N03  c     TrackKey      reade     TrackL02                               33
N03  c                   enddo
     C     *IN33         cabeq     '0'           NXTOPD
     c                   endif
      *
      * Klargjør post som Semikolonseparert streng
     C                   exsr      semi
     C                   callp     updHTMLvar('LINTXT':LinTxt)
     C                   callp     wrtsection('lin')
      * Send kolli-id som egen linje, men kun på oribgilat utlagt, eller addet...
      * (med qiden kansje også sjekke på alle?  ID tildelt etter hentet til PDA??)
     c     KolliJN       ifeq      'J'
     c     Tgkoh         ifeq      'O'
     c     Tgkoh         oreq      'A'
     c                   exsr      KolliID
     C                   END
     C                   END
      *
     C     NXTOPD        tag
     C     TUPRO         Reade     HEAD11                                 33
     C                   END
      ***
      * Ved refresh - send anmodning om fjerning av de som nå ikke er på turen
     C     Refresh       IFEQ      'J'
     C                   Exsr      DelOPD
     C                   END
      ***
     C     Antpos        Ifeq      *zeros
     C                   eval      LinTxt = '##INGEN OPPDRAG'
     C     Refresh       Ifeq      'J'
     C                   eval      LinTxt = '##INGEN ENDRING'
     C                   END
     C                   callp     updHTMLvar('LINTXT':LinTxt)
     C                   callp     wrtsection('lin')
     C                   END
      *
     C
     C                   endsr
      *
      *

      *=====================================================================******
      *  ETTOPD - Legg ut sendingsdta for ETT OPPDRAG
      *=====================================================================******
     C     EttOpd        begsr
     c
     c
     C                   callp     wrtsection('godsltop')
      * Finn antall turer i turvelgere for å varsle ved endring..
     C                   EXSR      ANTTSR
     c
      * enten AVD*OPD eller AVD_OPD eller kolli-iD eller send.nr
     C     '*'           SCAN      Snd           f
     c     f             ifeq      *zeros
     C     '_'           SCAN      Snd           f                              Ikke A*O, prøv A_O
     c                   endif
     c     f             cabeq     *zeros        UtEopdClId                     Ikke A*O/A_O pr CLID
     c                   eval      avdaa = %SUBST(Snd:1:f-1)
     c                   eval      opdaa = %SUBST(Snd:f+1:20-f-1)
     C                   eval      HEAVD   = c2n2(avdaa)
     C                   eval      HEOPD   = c2n2(opdaa)
     C     HeaKey        chain     Headf                              33
     c     *in33         cabeq     *on           UtEopd
     c     *in33         cabeq     *off          OKEopd
      * CLID  - Hent via skutt kolli-ID.
     c     UtEopdClId    tag
     c                   move      snd           DSsnd
     C                   OPEN      DOKUFM1
     c     DOKFM1K       chain     DOKUFM1                            33
     C                   CLOSE     DOKUFM1
     c     *in33         cabeq     *on           UtEopdSnd                      Ikke CLID, prøv SNDN
     c     *in33         ifeq      *off
     C                   eval      HEAVD   = FMavd
     C                   eval      HEOPD   = FMopd
     C     HeaKey        chain     Headf                              33
     c     *in33         cabeq     *on           UtEopd
     c     *in33         cabeq     *off          OKEopd
     c                   end
      *
      * SND   - Hent via skutt sendingsnr
     c     UtEopdSnd     tag
     c                   move      snd           DSsnd2
     c                   eval      snd17 =       snd
     c                   eval      snd20 =       snd
     c     DSSnd1_3      ifeq      '401'
     c                   eval      snd17 =       DSsnd4_20
     c                   else
     c     DSSnd17_17    ifne      *blanks
     c     DSSnd18_18    andeq     *blanks
     c                   eval      snd20 =       '401'+snd
     c                   end
     c                   end
     C                   OPEN      HEAD39
     c     snd20         chain     Head39                             33
     C                   CLOSE     HEAD39
     c     *in33         ifeq      *on
     c                   eval      FSKODE = 'IFB'
     c                   eval      FSSOK  = snd17
     C                   OPEN      FRISOL01
     c     FS1Key        chain     FRISOL01                           33
     C                   CLOSE     FRISOL01
     C  n33              eval      HEAVD   = FSavd
     C  n33              eval      HEOPD   = FSopd
     C  n33HeaKey        chain     Headf                              33
     c     *in33         cabeq     *on           UtEopd
     c                   end
      **
     c     OKEopd        tag
      * hvis plukk til tur -kan det ikke alt være på tur
     c     TurNr         ifne      *zeros
     c     HEPRO         cabne     *zeros        UtEopd
     C                   call      'SYGE21'
     C                   parm      heAVD         uuAVD             4 0
     C                   parm      heOPD         uuOPD             7 0
     C                   parm      turnr         uurnr             8 0
     C                   parm                    UUIND             1
     c     UUIND         cabne     '0'           UtEopd
     C                   MOVE      TurNr         HEPRO
     c                   else
      * hvis plukk av oppdrag uavhengig av tur, simuler at turnr = 0 (samle under turnr o)
     C                   MOVE      *ZEROS        HEPRO
     c                   endif
      * Hent info som må"settes sammen" for å kunne  teste mot gml v/refresh
     C                   EXSR      GetInfo
     C                   movea     '0000000000'  *IN(60)                        60-69
     C                   movea     '0000000000'  *IN(70)                        70-79
     C                   movea     '0000000000'  *IN(80)                        80-89
      *
      * dersom oppdrag alt er levert aksepteres ikke TIL PDA
     C                   move      'POD'         TTACTI
     c     TrackKey      Chain     TrackL02                           33
N03  C     *IN33         doweq     '0'
N03  c     TTEDRE        ifne      'KOP'
N03  c                   leave
N03  c                   endif
N03  c     TrackKey      reade     TrackL02                               33
N03  c                   enddo
     C     *IN33         cabeq     '0'           UtEOpd
      * "levert" til terminal logges som TE2 (sluttlevering)
      * logikk tar høyde for at det KAN finnes TE2 tidligere i kjeden..- Kun "Signed by" gir skipp.
     C                   move      'TE2'         TTACTI
     c     TrackKey      Chain     TrackL02                           33
s03  C*    *IN33         doweq     '0'
s03  C*                  movel     TTTEXT        TTTX1_9           9
s03  c*    TTTX1_9       cabeq     'Signed by'   Signed2
s03  C*    TrackKey      reade     TrackL02                               33
s03  C*                  enddo
s03  c*    Signed2       tag
N03  c     *IN33         doweq     '0'
N03  c     TTEDRE        ifne      'KOP'
N03  c                   leave
N03  c                   endif
N03  c     TrackKey      reade     TrackL02                               33
N03  c                   enddo
     C     *IN33         cabeq     '0'           UtEOpd
      * Ved FF logges "levert" til terminal som TEI
     c     TRSLAG        ifeq      'FF'
     C                   move      'TEI'         TTACTI
     c     TrackKey      Chain     TrackL02                           33
N03  C     *IN33         doweq     '0'
N03  c     TTEDRE        ifne      'KOP'
N03  c                   leave
N03  c                   endif
N03  c     TrackKey      reade     TrackL02                               33
N03  c                   enddo
     C     *IN33         cabeq     '0'           UtEOpd
     c                   endif
      *
      * Klargjør post som Semikolonseparert streng
     C                   exsr      semi
     C                   callp     updHTMLvar('LINTXT':LinTxt)
     C                   callp     wrtsection('lin')
      * Send kolli-id som egen linje, men kun på oribgilat utlagt, eller addet...
      * (med qiden kansje også sjekke på alle?  ID tildelt etter hentet til PDA??)
     c     KolliJN       ifeq      'J'
     c     Tgkoh         ifeq      'O'
     c     Tgkoh         oreq      'A'
     c                   exsr      KolliID
     C                   END
     C                   END
      *
     C     UtEOpd        tag
      ***
     C     Antpos        Ifeq      *zeros
     C                   eval      LinTxt = '##INGEN OPPDRAG'
     C                   callp     updHTMLvar('LINTXT':LinTxt)
     C                   callp     wrtsection('lin')
     C                   END
      *
     C
     C                   endsr
      *
      * ***********************************
     C     ANTTSR        begsr
      * ***********************************
      * EGEN linje for evt overvåking av antall turer i "Hent liste"
     C                   MOVE      'TKATU'       PAID
     C     FiParKey      CHAIN     BRPARF                             33
     C     *IN33         IFEQ      *OFF
     C                   MOVEl     PAVRDA        TKATUjn           1
     C     TKATUjn       CABNE     'J'           UtAntt
     c                   end
      *
     C                   move      *zeros        AntTur            5 0
     C     TURKEY20      setll     TURER20
     C     TURKEY20      Reade     TURER20                                33
     C     *IN33         DOWEQ     '0'
     C                   ADD       1             AntTur
     C     TURKEY20      Reade     TURER20                                33
     C                   end
     C                   eval      LinTxt='##AT'+%trim(%editc(AntTur:'3'))
     C                   callp     updHTMLvar('LINTXT':LinTxt)
     C                   callp     wrtsection('lin')
N12   * 99999999 er dummy når det er ingen turer aktive,Men en vil ha refresh av ant i 'Hent liste'
N12   * (før V03.14 var test på endret tur utlede av lengde på svar, etter V03.14 på '##INGEN E..' )
N12  C     TurNr         IFEQ      99999999
N12  C     ReFresh       andeq     'J'
N12  C                   eval      LinTxt = '##INGEN ENDRING'
N12  C                   callp     updHTMLvar('LINTXT':LinTxt)
N12  C                   callp     wrtsection('lin')
N12  C                   END
     c     UtAntt        tag
     C                   endsr
     C
      *=====================================================================******
      *  TurHead
      *=====================================================================******
     C     TurHead       begsr
      * Turheader-record med status
      * sendes alltid ved original/kun ved endring når refresh
      * Utfra turstatus velger TKSign hva den skal gjøre når alle oppdrag er Ferdig
     C                   move      TUPRO         TUA               8
     C     TUST          IFEQ      'P'                                          Protect= I arbeid
     C                   move      ' '           TUST                             = åpen
     c                   end
     C     TUST          IFEQ      ' '
     C                   Move      '*BT*'        TUSTA             4            Behold tur
     c                   else
     C                   Move      '*DT*'        TUSTA             4            Delet tur
     c                   end
      * foreløpig brukes turrecorden i TKSGM kun for å lagre status (I TGHEKO)
      * men med tiden kan en tenke seg at turinfo legges i INFOFELT...
     C                   clear                   TKSGMR
     C                   move      TUPRO         TGPRO
     C     GmTurKey      CHAIN     TKSGM                              35
     C                   EXSR      GetTurInfo
     C     REFRESH       IFeq      'N'
     C     *in60         Oreq      '1'
     C     Tmeld         Orne      *blanks
     C                   add       1             AntPos
      * felt 5 sndn=turnr, felt 6-23 iKKE i bruk ved tur (semi 5-22 hardkodet)
     C                   eval      LinTxt = USER+';'+TUA+';'+TUSTA+';;'+TUA+
     C                             ';;;;;;;;;;;;;;;;;;;;'+
     C                             ';' + %trim(TIN(01)) +
     C                             ';' + %trim(TIN(02)) +
     C                             ';' + %trim(TIN(03)) +
     C                             ';' + %trim(TIN(04)) +
     C                             ';' + %trim(TIN(05)) +
     C                             ';' + %trim(TIN(06)) +
     C                             ';' + %trim(TIN(07)) +
     C                             ';' + %trim(TIN(08)) +
     C                             ';' + %trim(TIN(09)) +
     C                             ';' + %trim(TIN(10)) +
     C                             ';' + %trim(Tmeld)
     c     Versj         IFge      '02.37'
     C                   eval      LinTxt = %trim(LinTxt)+';'
     c                   endif
N11  c     Versj         IFge      '03.14'
N11  C                   eval      LinTxt = %trim(LinTxt)+';'
N11  c                   endif
     C                   callp     updHTMLvar('LINTXT':LinTxt)
     C                   callp     wrtsection('lin')
     C                   end
     C
     C                   endsr

      *=====================================================================******
      *  Semi
      *=====================================================================******
     C     SEMI          begsr
      *
     C                   add       1             AntPos
      *
      * Logg hvilke oppdrag/felt-verdier som er sendt til TKSign
      * (for framtidig sjekk for update ved refresh.. da sendes kun erdrede felt  )
     C     HEPOS1        IFNE      '*D*'
     c                   exsr      LogTKS
     c                   end
      *
      * Legg ut feltene i rett rekkefølge med semikolon mellom
      * 55 ON = ta henyn til ÆØÅæøå(UTF8) - 55 OFF - trengs ikke
      * 1 = USER
     C                   Movel(P)  USER          LinTxt
      * 2 = TURNR
     C                   Movel(P)  HEPRO         EKSTRA
     C                   Move      *OFF          *IN55
     C                   exsr      semi2
      * 3 = POS.NR
     C                   Movel(P)  HEPOS1        EKSTRA
     C                   Move      *OFF          *IN55
     C                   exsr      semi2
      * 4 = TURDATO
     C                   Movel(P)  TUDT          EKSTRA
     C   60              Movel     *blanks       EKSTRA
     C                   Move      *OFF          *IN55
     C                   exsr      semi2
      * 5 = SEND.NR  (ETTER VERSJON 02.37 er det alltid avd_oppd, så det er egentlig unødig
      * (AVD OPPD sendes jo uansett i 6,6) sendes fortsatt for å slippe omskrivinger på KLIENTside
     C                   Movel(P)  HXSND17       EKSTRA
     c     Versj         ifge      '02.37'
     C                   Movel(P)  DSAVOP        EKSTRA
     C                   endif
     C                   Move      *OFF          *IN55
     C                   exsr      semi2
      * 6 = Avd
     C                   Movel(P)  HEAVD         EKSTRA
     C                   Move      *OFF          *IN55
     C                   exsr      semi2
      * 7 = Oppd
     c                   z-add     HEOPD         ØN153
     C                   exsr      srne
     C                   Movel(P)  ØAN           EKSTRA
     C                   Move      *OFF          *IN55
     C                   exsr      semi2
      * ved anmodning om sletting trengs ikke resten av feltene
     C     HEPOS1        IFEQ      '*D*'
     C                   GOTO      UTSEMI
     C                   END
      * 8 = Avsender Name
     C                   Movel(P)  HENAS         EKSTRA
      * endr 06 foreløpig droppet, det er no LEV.adr som vises når neste er Levering..
     C   66              Movel     *blanks       EKSTRA
     C                   Move      *ON           *IN55
     C                   exsr      semi2
      * 9 = Avsender Adr1
     C                   Movel(P)  HEADS1        EKSTRA
S06  C*  66              Movel     *blanks       EKSTRA
N06  C   82              Movel     *blanks       EKSTRA
N06  c  N82EKSTRA        IFeq      *blanks                                      ENDR TIL VERDI BLANK
N06  c     Refresh       andeq     'J'                                          V/REFRESH =
N06  c     VERSJ         andge     '03.10'                                      f.om V03.10
N06  C                   Movel(P)  '*blanks'     EKSTRA                         "*blanks" til TKsign
N06  c                   end
     C                   Move      *ON           *IN55
     C                   exsr      semi2
      *10 = Avsender Adr2
     C                   Movel(P)  HEADS2        EKSTRA
S06  C*  66              Movel     *blanks       EKSTRA
N06  C   83              Movel     *blanks       EKSTRA
N06  c  N83EKSTRA        IFeq      *blanks                                      ENDR TIL VERDI BLANK
N06  c     Refresh       andeq     'J'                                          V/REFRESH =
N06  c     VERSJ         andge     '03.10'                                      f.om V03.10
N06  C                   Movel(P)  '*blanks'     EKSTRA                         "*blanks" til TKsign
N06  c                   end
     C                   Move      *ON           *IN55
     C                   exsr      semi2
      *11 = Avsender Adr 3
     C                   Movel(P)  HEADS3        EKSTRA
S06  C*  66              Movel     *blanks       EKSTRA
N06  C   84              Movel     *blanks       EKSTRA
     C                   Move      *ON           *IN55
     C                   exsr      semi2
      *12 =Tomtom sted
     C                   Movel(P)  HEADS3        TTTest
     C                   exsr      TTSted
     C                   Movel(P)  TomTomSt      EKSTRA
     C                   Move      *ON           *IN55
     C                   exsr      semi2
      *13 = Mottaker Name
     C                   Movel(P)  HENAK         EKSTRA
     C   67              Movel     *blanks       EKSTRA
     C                   Move      *ON           *IN55
     C                   exsr      semi2
      *14 = Mottaker Gate
     C                   Movel(P)  HEADK1        EKSTRA
S06  C*  67              Movel     *blanks       EKSTRA
N06  C   85              Movel     *blanks       EKSTRA
N06  c  N85EKSTRA        IFeq      *blanks                                      ENDR TIL VERDI BLANK
N06  c     Refresh       andeq     'J'                                          V/REFRESH =
N06  c     VERSJ         andge     '03.10'                                      f.om V03.10
N06  C                   Movel(P)  '*blanks'     EKSTRA                         "*blanks" til TKsign
N06  c                   end
     C                   Move      *ON           *IN55
     C                   exsr      semi2
      *15 = Mottaker adresse 2
     C                   Movel(P)  HEADK2        EKSTRA
S06  C*  67              Movel     *blanks       EKSTRA
N06  C   86              Movel     *blanks       EKSTRA
N06  c  N86EKSTRA        IFeq      *blanks                                      ENDR TIL VERDI BLANK
N06  c     Refresh       andeq     'J'                                          V/REFRESH =
N06  c     VERSJ         andge     '03.10'                                      f.om V03.10
N06  C                   Movel(P)  '*blanks'     EKSTRA                         "*blanks" til TKsign
N06  c                   end
     C                   Move      *ON           *IN55
     C                   exsr      semi2
      *16 = Mottaker Postnr sted
     C                   Movel(P)  HEADK3        EKSTRA
S06  C*  67              Movel     *blanks       EKSTRA
N06  C   87              Movel     *blanks       EKSTRA
     C                   Move      *ON           *IN55
     C                   exsr      semi2
      *17 = Tomtom sted
     C                   Movel(P)  HEADK3        TTTest
     C                   exsr      TTSted
     C                   Movel(P)  TomTomSt      EKSTRA
     C                   Move      *ON           *IN55
     C                   exsr      semi2
      *18 = Antall Paller
     c                   z-add     HXPALL        ØN153
     C                   exsr      srne
     C                   Movel(P)  ØAN           EKSTRA
     C   65              Movel     *blanks       EKSTRA
     C                   Move      *OFF          *IN55
     C                   exsr      semi2
      *19 = Antall Kolli
     c                   z-add     HENT          ØN153
     C                   exsr      srne
     C                   Movel(P)  ØAN           EKSTRA
     C   61              Movel     *blanks       EKSTRA
     C                   Move      *OFF          *IN55
     C                   exsr      semi2
      *20 = Vekt
     c                   z-add     HEvkt         ØN153
     C                   exsr      srne
     C                   Movel(P)  ØAN           EKSTRA
     C   62              Movel     *blanks       EKSTRA
     C                   Move      *OFF          *IN55
     C                   exsr      semi2
      *21 = Volum (i M3)
     c                   z-add     hem3          ØN153
     C                   exsr      srne
     C                   Movel(P)  ØAN           EKSTRA
     C   63              Movel     *blanks       EKSTRA
     C                   Move      *OFF          *IN55
     C                   exsr      semi2
      *22 = Lastemeter
     c                   z-add     heLM          ØN153
     C                   exsr      srne
     C                   Movel(P)  ØAN           EKSTRA
     C   64              Movel     *blanks       EKSTRA
     C                   Move      *OFF          *IN55
     C                   exsr      semi2
      *23 = Lastes opp (Dft = er alt lastet/egen terminal = 0 / Henting =3(norm hos kunde)
     C                   Movel(P)  Hentkode      EKSTRA
     C   68              Movel     *blanks       EKSTRA
      *   status tilbake til TKsign, basert på hentkode + annen info
      *  Statusen inngår i sortering OG forteller: Hva er det neste som skal skje
     c                   exsr      StatTKs
     C                   Move      *OFF          *IN55
     C                   exsr      semi2
      *24 = Hente-terminal
     C                   Movel(P)  HenTerm       EKSTRA
     C   69              Movel     *blanks       EKSTRA
     c     Versj         IFge      '02.32'
      * ved endret(N69) TIL BLANK send tekst '*blanks' for at TKsign skal blanke..
     c  N69HenTerm       IFeq      *blanks
     c     Refresh       andeq     'J'
     C                   Movel(P)  '*blanks'     EKSTRA
     c                   end
     c                   end
     C                   Move      *ON           *IN55
     C                   exsr      semi2
      *25 = Lev-Terminal (Hvis lossested - terminal...) endring TIL BLANK sendes aktivt.
     C                   Movel(P)  Terminal      EKSTRA
     C   70              Movel     *blanks       EKSTRA
     c     Versj         IFge      '02.32'
      * ved endret(N70) TIL BLANK send tekst '*blanks' for at TKsign skal blanke..
     c  N70Terminal      IFeq      *blanks
     c     Refresh       andeq     'J'
     C                   Movel(P)  '*blanks'     EKSTRA
     c                   end
     c                   end
     C                   Move      *ON           *IN55
     C                   exsr      semi2
      *26 - 35  = Max 10 linjer a 35 tegn med info.
     C   71              move      *blanks       INF(01)
N06  c  N71INF(01)       IFeq      *blanks                                      ENDR TIL VERDI BLANK
N06  c     Refresh       andeq     'J'                                          V/REFRESH =
N06  c     VERSJ         andge     '03.10'                                      f.om V03.10
N06  C                   Movel(P)  '*blanks'     INF(01)                        "*blanks" til TKsign
N06  c                   end
N06   *
     C   72              move      *blanks       INF(02)
N06  c  N72INF(02)       IFeq      *blanks                                      ENDR TIL VERDI BLANK
N06  c     Refresh       andeq     'J'                                          V/REFRESH =
N06  c     VERSJ         andge     '03.10'                                      f.om V03.10
N06  C                   Movel(P)  '*blanks'     INF(02)                        "*blanks" til TKsign
N06  c                   end
N06   *
     C   73              move      *blanks       INF(03)
N06  c  N73INF(03)       IFeq      *blanks                                      ENDR TIL VERDI BLANK
N06  c     Refresh       andeq     'J'                                          V/REFRESH =
N06  c     VERSJ         andge     '03.10'                                      f.om V03.10
N06  C                   Movel(P)  '*blanks'     INF(03)                        "*blanks" til TKsign
N06  c                   end
N06   *
     C   74              move      *blanks       INF(04)
N06  c  N74INF(04)       IFeq      *blanks                                      ENDR TIL VERDI BLANK
N06  c     Refresh       andeq     'J'                                          V/REFRESH =
N06  c     VERSJ         andge     '03.10'                                      f.om V03.10
N06  C                   Movel(P)  '*blanks'     INF(04)                        "*blanks" til TKsign
N06  c                   end
N06   *
     C   75              move      *blanks       INF(05)
N06  c  N75INF(05)       IFeq      *blanks                                      ENDR TIL VERDI BLANK
N06  c     Refresh       andeq     'J'                                          V/REFRESH =
N06  c     VERSJ         andge     '03.10'                                      f.om V03.10
N06  C                   Movel(P)  '*blanks'     INF(05)                        "*blanks" til TKsign
N06  c                   end
N06   *
     C   76              move      *blanks       INF(06)
N06  c  N76INF(06)       IFeq      *blanks                                      ENDR TIL VERDI BLANK
N06  c     Refresh       andeq     'J'                                          V/REFRESH =
N06  c     VERSJ         andge     '03.10'                                      f.om V03.10
N06  C                   Movel(P)  '*blanks'     INF(06)                        "*blanks" til TKsign
N06  c                   end
N06   *
     C   77              move      *blanks       INF(07)
N06  c  N77INF(07)       IFeq      *blanks                                      ENDR TIL VERDI BLANK
N06  c     Refresh       andeq     'J'                                          V/REFRESH =
N06  c     VERSJ         andge     '03.10'                                      f.om V03.10
N06  C                   Movel(P)  '*blanks'     INF(07)                        "*blanks" til TKsign
N06  c                   end
N06   *
     C   78              move      *blanks       INF(08)
N06  c  N78INF(08)       IFeq      *blanks                                      ENDR TIL VERDI BLANK
N06  c     Refresh       andeq     'J'                                          V/REFRESH =
N06  c     VERSJ         andge     '03.10'                                      f.om V03.10
N06  C                   Movel(P)  '*blanks'     INF(08)                        "*blanks" til TKsign
N06  c                   end
N06   *
     C   79              move      *blanks       INF(09)
N06  c  N79INF(09)       IFeq      *blanks                                      ENDR TIL VERDI BLANK
N06  c     Refresh       andeq     'J'                                          V/REFRESH =
N06  c     VERSJ         andge     '03.10'                                      f.om V03.10
N06  C                   Movel(P)  '*blanks'     INF(09)                        "*blanks" til TKsign
N06  c                   end
N06   *
     C   80              move      *blanks       INF(10)
N06  c  N80INF(10)       IFeq      *blanks                                      ENDR TIL VERDI BLANK
N06  c     Refresh       andeq     'J'                                          V/REFRESH =
N06  c     VERSJ         andge     '03.10'                                      f.om V03.10
N06  C                   Movel(P)  '*blanks'     INF(10)                        "*blanks" til TKsign
N06  c                   end
N06   *
     C     1             do        10            nr                2 0
     C                   Movel(P)  INF(NR)       EKSTRA
     C                   Move      *ON           *IN55
     C                   exsr      semi2
     C                   enddo
      *36 = Meldin (øyeblikks...) til sjåfør vedr denne ordren
     C                   Movel(P)  Smeld         EKSTRA
     C                   Move      *ON           *IN55
     C                   exsr      semi2
      * 37 = SEND.NR
     c     Versj         ifge      '02.37'
     C                   Movel(P)  HXSND17       EKSTRA
     C   81              Movel     *blanks       EKSTRA
      * ved endret(N81) TIL BLANK send tekst '*blanks' for at TKsign skal blanke..
     c  N81HXSND17       IFeq      *blanks
     c     Refresh       andeq     'J'
     C                   Movel(P)  '*blanks'     EKSTRA
     c                   end
     C                   Move      *OFF          *IN55
     C                   exsr      semi2
     C                   endif
N11   * 38 = EKSTRA VARELINJEINFO..
N11  c     Versj         ifge      '03.14'
N11  C                   Movel(P)  LININFO       EKSTRA
N11  C   88              Movel     *blanks       EKSTRA
N11   * ved endret(N82) TIL BLANK send tekst '*blanks' for at TKsign skal blanke..
N11  c  N88LININFO       IFeq      *blanks
N11  c     Refresh       andeq     'J'
N11  C                   Movel(P)  '*blanks'     EKSTRA
N11  c                   end
N11  C                   Move      *OFF          *IN55
N11  C                   exsr      semi2
N11  C                   endif
      *
      *xx = KOLLI-ID
      * leseloop på dokufm - fr.brnr 1 - status I Interne og E Eksterne
      *
     C     UtSemi        endsr
      *
      *
      *=====================================================================******
      *  Semi2
      *=====================================================================******
     C     SEMI2         begsr
      * 55 *ON = alfafelt som kan trenge UTF-8-konv av særnorske tegn
      * 55 *OFF  spar ressurser ved IKKE å kjøre UTF-8-konvertering
     C     EKSTRA        ifeq      *blanks
     C                   Move      *OFF          *IN55
     C                   end
     C                   CAT       ';':0         LinTxt
     C     ';':':'       XLATE     EKSTRA        EKSTRA
     C     Appo:' '      XLATE     EKSTRA        EKSTRA
     C   55              EXSR      UTF8U
     C                   CAT       EKSTRA:0      LinTxt
     C                   endsr
      *=====================================================================******
      *  TTSted
      *=====================================================================******
     C     TTSted        begsr
     C                   movel     TTTest        KFKOD
     C     TTkey         Chain     KUFAST                             33
     C   33              eval      TomTomSt  =   *blanks
     C  N33              eval      TomTomSt  =   KFTXT
     C                   endsr
      *=====================================================================******
      *  KolliID
      *=====================================================================******
     C     KOLLIID       begsr
      *
     c                   move      *zeros        AntKOID
     c     DOKUFKEY      setll     DOKUFM
     c     DOKUFKEY      reade     DOKUFM                                 33
     c     *IN33         doweq     '0'
     C     FMST          IFEQ      'I'
     C     FMST          OREQ      'E'
     c                   add       1             AntKOID
     c     AntKOID       ifeq      1
     C                   eval      LinTxt='KOID'
     c                   end
     c                   eval      KOID = '00'+FMMRK1
     C                   eval      LinTxt = %trim(LinTxt) + ';' + KOID
     C                   end
     c     DOKUFKEY      reade     DOKUFM                                 33
     C                   end
      * Egen record med kolliID legges ut kun når kolliid finnes
     c     AntKOID       ifge      1
     C                   callp     updHTMLvar('LINTXT':LinTxt)
     C                   callp     wrtsection('lin')
     C                   end
     C                   endsr
      *
      *=====================================================================******
      *  StatTKS
      *=====================================================================******
     C     StatTKS       begsr
      *  Statusen inngår i sortering OG forteller - Hva er det neste som skal skje
      *  statuser: (0=Turheader 90=Ferdig)
      *            10= Ny sending, Henting (skal bekreftes)
      *            20= Ny sending, Levering (skal bekreftes)
      *            30= Oppdatering, henting (skal bekreftes)
      *            40= Oppdatering, levering (skal bekreftes)
      *            45= Henting Terminal
      *            50= Henting   Kunde
      *            60= Levering  (hos sluttkunde ELLER term/agent)
      * Refresh/Endring,men  KUN "øyebliksmelding" - status på PDA blir uendret.
     C     *in60         IFEQ      *ON
     C     KunSmeld      andeq     'J'
     c                   move      *blanks       StatNext
     c                   goto      UtStSTKS
     C                   end
      *
      *  Henting hos kunde...
     C     Hentkode      IFEQ      '3'
     C                   movel     '50'          StatNext          2
      * Henteoppdrag, men hentingen er alt utført/har vært innom term - Status/neste = Levering
     C                   move      'COL'         TTACTI
     c     TrackKey      Chain     TrackL02                           33
     C   33              move      'TEU'         TTACTI
     c   33TrackKey      Chain     TrackL02                           33
     C   33              move      'TEI'         TTACTI
     c   33TrackKey      Chain     TrackL02                           33
     C  N33              movel     '60'          StatNext
     c                   else
      * henkode 0=starter på terminal - fra 2.15 - egen status (før -> leveres)
     C                   movel     '60'          StatNext
     c     TKhenTerm     ifeq      'J'
     C                   movel     '45'          StatNext
      * Hent/last på terminal, men lasting ER alt utført - Status/neste = Levering
     C                   move      'TEU'         TTACTI
     c     TrackKey      Chain     TrackL02                           33
     C  N33              movel     '60'          StatNext                       H
     C     StatNext      Ifeq      '45'
     C                   moveL     HESDFF        HenTerm
     c     HenTerm       ifeq      *blanks
     C                   moveL     HESDF         HenTerm
     c                   end
     c                   end
     c                   end
     c                   end
      *
      * ved Refresh NY /Endret så sendes egne koder (SKAL BEKREFTES/i top av lista)
     C     Refresh       Ifeq      'J'
      * NY
     C     TGKOH         IFEQ      'A'
     C     StatNext      IFEQ      '50'
     C     StatNext      oreq      '45'
     C                   movel     '10'          StatNext                       Ny henting
     c                   else
     C                   movel     '20'          StatNext                       Ny levering
     c                   end
     c                   end
      * Endret
     C     TGKOH         IFEQ      'U'
     C     StatNext      IFEQ      '50'
     C     StatNext      oreq      '45'
     C                   movel     '30'          StatNext                       Endret henting
     c                   else
     C                   movel     '40'          StatNext                       Endret levering
     c                   end
     c                   end
     c                   end
     C     UtStSTKS      tag
      * 2-sifret ststus/neste-kode sendes i stedet for 3/0 Hent /lev..
     C                   Movel(P)  StatNext      EKSTRA
     C                   endsr
      *////////////////////////////////////////////////////////////
      *  Leftjustify num.fields                              SRNE /
      *////////////////////////////////////////////////////////////
     C     SRNE          BEGSR
      * Remove neg sign.
     C                   IF        ØN153 < 0
     C                   Z-SUB     ØN153         ØN153
     C                   ENDIF
      * Move correct value into alpha 12-field
     C                   MOVE      *ZEROS        ØA12
     C     ØA153D        IFEQ      '000'
     C                   MOVE      ØA153H        ØA12
     C                   ELSE
     C                   MOVEL     ØA153X        ØA12
     C                   MOVE      ',   '        ØA12
     C                   MOVE      ØA153D        ØA12
     C                   END
      * search from left and find first sign over 0
     C     1             DO        11            ØX                2 0
     C     Ø12(ØX)       IFNE      '0'
     C                   GOTO      SRNE1
     C                   END
     C                   END
     C     SRNE1         TAG
      * Leftjustify to a new field
     C     ØA153D        IFNE      '000'
     C     ØA153X        IFEQ      '00000000'
     C                   SUB       1             ØX
     C                   ENDIF
     C     Ø12(12)       IFEQ      '0'
     C                   MOVE      ' '           Ø12(12)
     C     Ø12(11)       IFEQ      '0'
     C                   MOVE      ' '           Ø12(11)
     C                   ENDIF
     C                   ENDIF
     C                   ENDIF
     C                   MOVE      *BLANKS       ØAN              12
     C                   MOVEA     Ø12(ØX)       ØAN

     C                   ENDSR
      *////////////////////////////////////////////////////////////
      *  Hent inntil 10 linjer med info                           /
      *////////////////////////////////////////////////////////////
     C     GetInfo       BEGSR
      * fra versjon 02.37 er SNDNR helt odinært felt (som kan endres..)
      * info om verdien av det må dermed hentes inn tidligere (flyttet fra SEMI)
      * Trmodul innland, langt/kort sendnr....
     c                   move      *blanks       HXSND17          17
     c     HXSNDN        ifne      *blanks
     c     HXSND11_20    ifne      *blanks
     c                   movel     HXSND17B      HXSND17                        Langt innland
     c                   else
     c                   movel     HXSNDN        HXSND17                        Kort innland
     c                   end
     c                   end
      * Om IKKE fra trmodul innland hent sndnr fra dokuf  / evt IFB
      *    om så ikke dokuf/IFB  finnes settes
     C     HXSND17       IFEQ      *BLANKS
     c     Versj         IFge      '02.37'
     C     DOKUFKEY      CHAIN     DOKUF                              33
     c     *in33         ifeq      '0'
     C  N33              MOVEL     DF1004        HXSND17
     c                   else
     C     IFBKey        CHAIN     FRISOK                             33
     C  N33              movel     FSSOK         HXSND17
     c                   endif
     c                   else
      * før versjon 02.37 - kan IKKE endre sendingnr side det er nøkkel...
     c*Om den ER tidligere sendt - behold nr.. (fraktbrev KAN være laget etterpå..)
     C     TKSGMKey      CHAIN(N)  TKSGM                              33
     c     *in33         ifeq      *off
     C                   move      TGSN17        HXSND17
     c                   else
     C     DOKUFKEY      CHAIN     DOKUF                              33
     C   33              move      *blanks       DF1004
     c     *in33         ifeq      '1'
     C     IFBKey        CHAIN     FRISOK                             33
     C  N33              movel     FSSOK         DF1004
     c                   endif
     C     DF1004        IFNE      *blanks
     C                   MOVEL     DF1004        HXSND17
     C                   ELSE
     C                   MOVEL     DSAVOP        HXSND17
     C                   END
     c                   end
     c                   endif
     C                   END
      *
      *  HEADFINFO BASERT PÅ FELTTESTER/SAMMENSATTE FELT..
      * Lastes opp (Dft = er alt lastet/egen terminal = 0 / Henting =3(norm hos kunde)
     C                   move      '0'           HentKode          1
      *   blank via1=Direkte - Da er det hening(normalt hos kunde).
      * MEN IKKE HVIS INNLAND FRA EGEN TERMNINAL (34 OFF)
     C                   move      '1'           *IN34
     C                   Movel     HESDF         FraPnrA           4
     C                   TESTN                   FraPnrA              33
     C     *IN33         IFEQ      '1'
     C                   Movel     FraPnrA       FraPnr            4 0
     c     fraPNR        chain     KODTRI                             34
     C                   END
     C     HESDFF        Ifeq      *blanks
     C     *in34         andeq     '1'
     C                   move      '3'           HentKode
     C                   end
      * dup - viderefrakt er alltid henting på terminal
     c     Hentkode      ifeq      '3'
     c     TRSLAG        andeq     'VF'
     C                   move      '0'           HentKode          1
     c                   end
      * Hente-terminal (kombinert med kode 3 foran..)
     C                   move      *blanks       HenTerm          20
      * Lev.terminal
     C                   move      *blanks       Terminal         20
s07  C*    HESDL         ifne      *BLANK
s07  C*    hepro         andne     *zeros
s07  C*                  movel     HESDL         Terminal
s07  C*                  end
      * dup - forfraktk er alltid levering til terminal
     c     TRSLAG        ifeq      'FF'
     C                   eval      Terminal = HESDT
     c                   end
      *
      *
      *  FRITEKST-INFO - Feltet INFO = 700 langt (via Ds 10 X 70)
     C                   move      *blanks       Info
     C* Starten vil ta fra 1-3 linjer(variabelt)
     C     HEVS1a        Ifeq      'KLL '
     C     HEVS1a        Oreq      'CLL '
     C     HEVS1B        ifne      *blanks
     C                   Eval      Info='Varesl: ' + %trim(HEVS1B)+%trim(HEVS2)
     c                   end
     C                   ELSE
     C                   Eval      Info='Varesl: ' + %trim(HEVS1)+ %trim(HEVS2)
     C                   END
      *
      * Finn første siste brukte linje..
     C     1             do        10            nr                2 0
     C     INF(nr)       Ifeq      *blanks
     c                   sub       1             nr
     C                   leave
     c                   end
     C                   enddo
      * GODSMERKING
     C     HEGM1         Ifne      *blanks
     C     HEGM1         andne     'ADR'
     C     HEGM1         andne     'ADRESSE'
     C                   add       1             nr
     C                   Eval      Tst35 = 'Merket: '+%trim(HEGM1)+
     C                             ' '+%trim(HEGM2)
     c     Versj         IFge      '02.25'
     C                   Eval      Inf(nr)= Tst35
     c                   else
     C                   Eval      Inf(nr)= Tst35A
     C     Tst35B        Ifne      *blanks
     C                   add       1             nr
     C                   Eval      Inf(nr)= Tst35B
     C                   END
     c                   end
     C                   END
     C* DENNE INFO ER FLYTTET NED BAK SENDERS REF (SOM ER GJORT UBETINGET...)
     C* (følgende FJERNES DERFOR FYSISK når alle er forbi 02.24 ...)
     c     Versj         iflt      '02.25'
     C* ØNSKET HENTE/LEV-TID.   Men kun dersom oppdraget spenner
     C* over flere dager, annet enn i dag , eller klokke er fylt ut
     C     TRSDFD        IFNE      TRSDTD
     C     TRSDFD        ORNE      ULDT
     C     TRSDFK        ORNE      *ZEROS
     C     TRSDTK        ORNE      *ZEROS
     C                   add       1             nr
s10  C*                  move      TRSDFD        FDAMN             4 0
s10  C*                  move      TRSDTD        TDAMN             4 0
     C                   Eval      Inf(nr)= 'H/L-Tid: ' +
     C                             FDD+'.'+FMM+' '+
     C                             %trim(%editw(TRSDFK:'  :  '))+' / '+
     C                             TDD+'.'+TMM+' '+
     C                             %trim(%editw(TRSDTK:'  :  '))
     C                   END
     C     HERFA         IFNE      *blanks
     C                   add       1             nr
     C                   Eval      Inf(nr)='Senders ref: '+HERFA
     C                   END
     C                   END
      *
     c     Versj         ifge      '02.25'
N10  c     Versj         andlt     '03.13'
      * Oppdr.givers ref
     C                   add       1             nr
     C                   Eval      Inf(nr)='Senders ref: '+HERFA
      * ØNSKET HENTE/LEV-TID.   Men kun dersom oppdraget er UTENLANNDS-modul og
      * spenner over flere dager, annet enn i dag , eller klokke er fylt ut
     C     HXSNDN        IFEQ      *blanks
s10  C*                  move      TRSDFD        FDAMN             4 0
s10  C*                  move      TRSDTD        TDAMN             4 0
     C                   Eval      Inf(nr)= %trim(Inf(nr)) + CrLf +
     C                             'H/L-Tid: ' +
     C                             FDD+'.'+FMM+' '+
     C                             %trim(%editw(TRSDFK:'  :  '))+' / '+
     C                             TDD+'.'+TMM+' '+
     C                             %trim(%editw(TRSDTK:'  :  '))
     C                   END
     c                   end
N10   * dato klokke i egen notislinje - ryddigere ved varsel om endring - lettere å teste
N10  c     Versj         ifge      '03.13'
N10   * Oppdr.givers ref
N10  C                   add       1             nr
N13  c                   select
N13  c                   when      HERFA<>*blanks and HERFK=*blanks
N10  C                   Eval      Inf(nr)='Senders ref: '+HERFA
N13  c                   when      HERFA=*blanks and HERFK<>*blanks
N13  C                   Eval      Inf(nr)='Mottakers ref: '+HERFK
N13  C                   other
N13  C                   Eval      Inf(nr)='Senders ref: '+HERFA
N13  C                             +' / Mott. ref: '+HERFK
N13  C                   endsl
N10   * ØNSKET HENTE/LEV-TID.   dersom oppdraget er UTENLANNDS-modul (fast lengde (ikke edit)
N10  C     HXSNDN        IFEQ      *blanks
N10  C                   add       1             nr
N10  C                   Eval      Inf(nr)= 'H/L-Tid: ' +
N10  C                             FDD+'.'+FMM+' '+FTI+':'+FMI+'/'+
N10  C                             TDD+'.'+TMM+' '+TTI+':'+TMI
N10  C                   END
N10  c                   end
      *
      * Linjer fra notisblokk merket G - permanent notis
      * (70 lang  . (lest)  på slutten droppes)
     C                   MOVE      'G'           XXSKKO
     C     FREETK        SETLL     FREETXT2
     C     FREETK        READE(N)  FREETXT2                               33
     C  N33              add       1             nr
     C  N33              Eval      Inf(nr)= '**OBS** Merknad: '
     C     *in33         doweq     *OFF
     C     FRTT70        Ifeq      '.'
     C                   move      ' '           FRTT70
     c                   end
     c     Versj         IFge      '02.25'
     C                   add       1             nr
     C                   Eval      Inf(nr)= FRTTXT
     C     Nr            cabge     10            utInfo
     C                   else
     C                   Move      FRTTXT        Tst35
     C                   add       1             nr
     C                   Eval      Inf(nr)= Tst35A
     C     Nr            cabge     10            utInfo
     C     Tst35B        Ifne      *blanks
     C                   add       1             nr
     C                   Eval      Inf(nr)= Tst35B
     C     Nr            cabge     10            utInfo
     C                   END
     C                   end
     C     FREETK        READE(N)  FREETXT2                               33
     C                   END
     C     utInfo        tag
N04
N04   * Tollpass??
N04  C     DOKUFKEY      CHAIN     DOKUF                              33
N04  C     *in33         ifeq      *off
N04  C     DFTOLL        andne     *zeros
N04  c     Nr            Iflt      10
N04  c                   add       1             Nr
N04  c                   else
N04  c                   z-add     10            Nr
N04  c                   endif
N04  C                   Eval      Inf(nr)= 'TOLLPASS! UFORTOLLET GODS!'
N04  c                   endif
      * Linjer fra notisblokk merket M=melding (øyeblikks..)
     C                   MOVE      *BLANKS       SMELD           210
     C                   MOVE      'M'           XXSKKO
     C     FREETK        SETLL     FREETXT2
     C     FREETK        READE     FREETXT2                               33
     C     *in33         doweq     *OFF
     C                   eval      Smeld = %trim(smeld) +%trim(FRTTXT)
      * kode M-> N funker som status - ER sendt.
     c                   move      'N'           FRTKOD
     C                   update    FREETXTR
     C     FREETK        READE     FREETXT2                               33
     C                   END
      *
N11   * Varelinjer fra fraktbrevet....
N11  C     Versj         ifge      '03.14'
N11  C                   MOVE      *zeros        Linje             5 0
N11  C                   MOVE      *BLANKS       LININFO         750
N11  C     DokufKey      SETLL     DOKUFV                             33
N11  C     DokufKey      READE     DOKUFV                                 33
N11  C     *IN33         DOWEQ     '0'
N11  C                   Z-ADD     1             FMMKNR
N11  C                   Z-ADD     1             FMLONR
N11  C                   move      *blanks       FMMRK1
N11  C     DOKUFMKEY     CHAIN     DOKUFM                             33
N11  C                   ADD       1             LINJE
N11  C                   if        Linje > 1
N11  C                   eval      LinInfo = %trim(lininfo)+'|'
N11  C                   endif
N11  C                   eval      LinInfo = %trim(lininfo)
N11  C                             +%trim(%editc(FVANT:'Z'))+' '
N11  C                             +%trim(FVPAKN)+' '+%trim(FVVT)
N11  C     FVVKT         ifgt      0
N11  C                   eval      LinInfo = %trim(lininfo)+' '
N11  C                             +%trim(%editc(FVVKT:'Z'))+' KG'
N11  C                   endif
N11  C     FVVOL         ifgt      0
N11  C                   eval      LinInfo = %trim(lininfo)+' '
N11  C                             +%trim(%editc(FVVOL:'4'))+' M3'
N11  C                   endif
N11  C     FVLM          ifgt      0
N11  C                   eval      LinInfo = %trim(lininfo)+' '
N11  C                             +%trim(%editc(FVLM:'4'))+' LM'
N11  C                   endif
N11  C     FMMRK1        ifne      *blanks
N11  C                   eval      LinInfo = %trim(lininfo)+' Mrk:'
N11  C                             +%trim(FMMRK1)
N11  C                   endif
N11  C     DokufKey      READE     DOKUFV                                 33
N11  C                   ENDDO
N11  C                   endif
      *
     C                   ENDSR
      *
      *=====================================================================******
      *  TURINFO fra notisblokk
      *=====================================================================******
     C     GetTurInfo    begsr
      * Turvelgeren (turnr = 0) = 1 felt
     C                   MOVE      'G'           XXSKKO
     c                   move      *blanks       TuInfTxt       5000
      * Info for VIS på en tur (turnr<>0)  Feltet TNFO = 350 langt (via Ds 10 X 35)
     C                   move      *zeros        nr
     C                   move      *blanks       Tinf
     C     FREETURK      SETLL     FREETUR2
     C     FREETURK      READE(N)  FREETUR2                               33
     C     *in33         doweq     '0'
     C     ';':':'       XLATE     FRTTXT        FRTTXT
     C     Appo:' '      XLATE     FRTTXT        FRTTXT
     c                   movel     FRTTXT        EKSTRA
     C                   EXSR      UTF8U
     c                   movel     EKSTRA        FRTTXT
     C     Turnr         ifeq      *zeros
     c                   eval      TuinfTxt = %trim(TuInfTxt)+%trim(FRTTXT)+CrLf
     c                   else
     c     Versj         IFge      '02.25'
     C                   add       1             nr
     C                   Eval      Tin(nr)= FRTTXT
     c                   else
     C                   Move      FRTTXT        Tst35
     C                   add       1             nr
     C                   Eval      Tin(nr)= Tst35A
     C     Nr            cabge     10            utTinf
     C     Tst35B        Ifne      *blanks
     C                   add       1             nr
     C                   Eval      Inf(nr)= Tst35B
     C     Nr            cabge     10            utTinf
     C                   END
     c                   end
     c                   end
     C     FREETURK      READE(N)  FREETUR2                               33
     c                   end
      *
     C     utTinf        TAG
      *
      * Turnr oppgitt (IKKE Turvelger) lagre verdier i TKSGM mm.
     C     Turnr         ifne      *zeros
     C                   MOVE      TUST          TGTUST
     C                   move      TIN(01)       TGIN01
     C                   move      TIN(02)       TGIN02
     C                   move      TIN(03)       TGIN03
     C                   move      TIN(04)       TGIN04
     C                   move      TIN(05)       TGIN05
     C                   move      TIN(06)       TGIN06
     C                   move      TIN(07)       TGIN07
     C                   move      TIN(08)       TGIN08
     C                   move      TIN(09)       TGIN09
     C                   move      TIN(10)       TGIN10
      * Hvis refresh - sett indikator / blank de som er lik som sist..
     C     Refresh       IFEQ      'J'
     C     TGIN01        COMP      TIN(01)                                71
     C     TGIN02        COMP      TIN(02)                                72
     C     TGIN03        COMP      TIN(03)                                73
     C     TGIN04        COMP      TIN(04)                                74
     C     TGIN05        COMP      TIN(05)                                75
     C     TGIN06        COMP      TIN(06)                                76
     C     TGIN07        COMP      TIN(07)                                77
     C     TGIN08        COMP      TIN(08)                                78
     C     TGIN09        COMP      TIN(09)                                79
     C     TGIN10        COMP      TIN(10)                                80
     C   71              move      *blanks       TIN(01)
     C   72              move      *blanks       TIN(02)
     C   73              move      *blanks       TIN(03)
     C   74              move      *blanks       TIN(04)
     C   75              move      *blanks       TIN(05)
     C   76              move      *blanks       TIN(06)
     C   77              move      *blanks       TIN(07)
     C   78              move      *blanks       TIN(08)
     C   79              move      *blanks       TIN(09)
     C   80              move      *blanks       TIN(10)
     c* Er felt endret?  -> 60 ON
     C                   move      '0'           *IN60
     c     *in71         ifeq      '0'
     c     *in72         oreq      '0'
     c     *in73         oreq      '0'
     c     *in74         oreq      '0'
     c     *in75         oreq      '0'
     c     *in76         oreq      '0'
     c     *in77         oreq      '0'
     c     *in78         oreq      '0'
     c     *in79         oreq      '0'
     c     *in80         oreq      '0'
     C     TUST          orne      TGHEKO
     C                   move      '1'           *IN60
      * sist endret
     C                   MOVE      ULDT          TGDTH
     C                   MOVE      XULTM         TGTIH
     c                   end
     c                   end
      * sist hentet/endret
     C                   MOVE      ULDT          TGDTH
     C                   MOVE      XULTM         TGTIH
     c                   move      TUST          TGHEKO
      * sist endret
     C                   MOVE      TUST          TGTUST
     C                   MOVE      ULDT          TGDTH
     C                   MOVE      XULTM         TGTIH
      * sist Refreshet
     C                   MOVE      ULDT          TGDTR
     C                   MOVE      XULTM         TGTIR
     C   35              write     TKSGMR
     C  N35              update    TKSGMR
      *
      * Linjer fra notisblokk merket M=melding (øyeblikks..)
     C                   MOVE      *BLANKS       TMELD           210
     C                   MOVE      'M'           XXSKKO
     C     FREETURK      SETLL     FREETUR2
     C     FREETURK      READE     FREETUR2                               33
     C     *in33         doweq     *OFF
     C                   eval      Tmeld = %trim(Tmeld)+'  '+%trim(FRTTXT)
      * kode M-> N funker som status - ER sendt.
     c                   move      'N'           FRTKOD
     C                   update    FREETURR
     C     FREETURK      READE     FREETUR2                               33
     C                   END
     C     Tmeld         ifne      *blanks
     C     ';':':'       XLATE     TMELD         FRTTXT
     C     Appo:' '      XLATE     TMELD         FRTTXT
     c                   movel     TMELD         EKSTRA
     C                   EXSR      UTF8U
     c                   movel     EKSTRA        TMELD
     c                   end
      *
     C                   end
      *
     C                   ENDSR
      *
      *=====================================================================******
      *  INITIER
      *=====================================================================******
     C     INIT          begsr
     C                   OPEN      BRIDF
     C     USER          CHAIN     BRIDF                              50
N05   * Ukjent UserID
N05  c     *in50         ifeq      '1'
N05  C                   callp     gethtml('HTMLSRC':'*LIBL':'ESTK501':
N05  c                             '/CGITAG/')
N05  C                   callp     wrtsection('top')
N05  C                   eval      LinTxt = '#ERROR# Ukjent userID'
N05  C                   callp     updHTMLvar('LINTXT':LinTxt)
N05  C                   callp     wrtsection('lin')
N05  C                   callp     wrtsection('bot')
N05  C                   callp     wrtsection('*fini')
N05  C                   close     BRIDF
N05  C                   eval      *inlr = *on
N05  C                   return
N05  c                   endif
     C* En "standardvariant" libl: call bound (INCGI=*MODULE) med parameter.
     C     BILIBL        ifeq      *blanks
     C                   callb     'INCGI'
     C                   parm                    BISTDL
     C                   else
     C* Helt egen bibl.liste satt på user - normal CALL (BILIBL er "*pgm")
     C                   call      BILIBL
     C                   end
      *
     C                   OPEN      TURER20
     C                   OPEN      TURER14
     C                   OPEN      HEADF
     C                   OPEN      HEAD11
     C                   OPEN      FRISOK
     C                   OPEN      DOKUF
N11  C                   OPEN      DOKUFV
     C                   OPEN      DOKUFM
     C                   OPEN      FREETXT2
     C                   OPEN      FREETUR2
     C                   OPEN      TKSGM
     C                   OPEN      TRACKL02
     C                   OPEN      KUFAST
     C                   OPEN      KODTRI
     C                   OPEN      BRPARF
      * Key for TURER
     C     TurKey20      KLIST
     C                   KFLD                    SJN
     C                   KFLD                    xxTST4
     C                   MOVE      ' '           xxTST4            1
      * Key for Dokuf
     C     DokufKey      KLIST
     C                   KFLD                    DFRI
     C                   KFLD                    HEAVD
     C                   KFLD                    HEOPD
     C                   KFLD                    DFFBNR
     C                   Move      'F'           DFRI
     C                   z-add     1             DFFBNR
N11   * key for godsmerke(nr 1) på varelinjenivå
N11  C     DOKUFMKEY     KLIST
N11  C                   KFLD                    FVRI
N11  C                   KFLD                    FVAVD
N11  C                   KFLD                    FVOPD
N11  C                   KFLD                    FVFBNR
N11  C                   KFLD                    FVLINR
N11  C                   KFLD                    FMMKNR
N11  C                   KFLD                    FMLONR
     C     FS1Key        KLIST
     C                   KFLD                    FSKODE
     C                   KFLD                    FSSOK
     C     IFBKey        KLIST
     C                   KFLD                    HEAVD
     C                   KFLD                    HEOPD
     C                   KFLD                    IFBkod            3
     c                   eval      IFBkod = 'IFB'
     C     FREETK        KLIST
     C                   KFLD                    HEAVD
     C                   KFLD                    HEOPD
     C                   KFLD                    XXSKKO            1
     C     FREETURK      KLIST
     C                   KFLD                    TUAVD
     C                   KFLD                    TUPRO
     C                   KFLD                    XXSKKO            1
     C     HEAKEY        KLIST
     C                   KFLD                    HEAVD
     C                   KFLD                    HEOPD
     C     TKSGMKey      KLIST
     C                   KFLD                    HEPRO
     C                   KFLD                    Xblank            1
     C                   KFLD                    HEAVD
     C                   KFLD                    HEOPD
     C     TKSGMK2       KLIST
     C                   KFLD                    TUPRO
     C                   KFLD                    Xblank
     C     FINSKEY       KLIST
     C                   KFLD                    HEPRO
     C                   KFLD                    XDEL
     C                   KFLD                    HEAVD
     C                   KFLD                    HEOPD
     C                   MOVE      'X'           XDEL              1
     C     GmTurKey      KLIST
     C                   KFLD                    TGPRO
     C                   KFLD                    TGDEL
     C                   KFLD                    TGAVD
     C                   KFLD                    TGOPD
      * alle poster som alt er sendt til PDA merkes i utg.pkt som om de skal deletes
      * ved denne oppgradering - inntil dette er "motbevist" i rutine FinsOpd
      * Om de ETTER rutine fremdeles har X finnes de ikke lenger og skal deletes
     C     FINSIKKE      KLIST
     C                   KFLD                    TUPRO
     C                   KFLD                    XDEL
      * TRACKl02 -key
     C     TrackKey      KLIST
     C                   KFLD                    HEAVD
     C                   KFLD                    HEOPD
     C                   KFLD                    TTFBNR
     C                   KFLD                    TTACTI
      *
     C     TTkey         KLIST
     C                   KFLD                    KFTYP
     C                   KFLD                    KFKOD
     C                   movel     'TKTTSTED  '  KFTYP
     C     FiParKey      klist
     C                   kfld                    FIBRID
     C                   kfld                    PAKUNR
     C                   kfld                    PAID
     C                   movel     '*KUNDFT*'    FIBRID           10
     C                   move      BIFIRM        FIBRID
      * HENTING TERMINAL skal utføres  ??? (J=*DFT ) (ellers Levering er første handling)
     C                   MOVE      'J'           TKhenTerm         1
     C                   MOVE      'TKHET'       PAID
     C     FiParKey      CHAIN     BRPARF                             33
     C     *IN33         IFEQ      *OFF
     C                   MOVEl     PAVRDA        TKhenTerm
     C     TKhenTerm     IFNE      'J'
     C     TKhenTerm     andne     'N'
     C                   MOVEl     'J'           TKhenTerm
     c                   end
     c                   end
      *
     C                   move      *zeros        Heavd
     C                   move      '_'           Strek
     C                   move      *zeros        Heopd
      * Initier CrLF
     c                   movel     Hex0D         CrLf              2
     c                   move      Hex25         CrLf
      *
     C                   move      *zeros        TRSDFD
     C                   move      *zeros        TRSDTD
      *
     C                   TIME                    XULTID
     C                   MOVE      XULDD         ULDD
     C                   MOVE      XULMM         ULMM
     C                   MOVE      XULÅÅ         ULÅÅ
      * skal kolli-ID sendes - (bør hentes som firmaparameter..)
     C                   move      'N'           KolliJN           1
N09   * HENT NetCCSID (1208 = UTF8)
N09  c                   move      *blanks       NetCCSID         10
N09  C                   eval      NetCCSID   =getenv('CGI_ASCII_CCSID':
N09  C                             qusec)
      *
     C     UtInit        endsr
      *
      *=====================================================================******
      *  TEST OM OPPDRAG ALT FINNES PÅ PDA (Ved refresh)
      *=====================================================================******
     C     FinsOpd       begsr
     C                   move      'N'           FINNES            1
      * FINNES... ta bort flagg for deletes..  MEN ER ENDRET?   UPDATE
     C     FINSKEY       CHAIN     TKSGM                              33
     C     *IN33         IFEQ      *OFF
     C                   move      'J'           FINNES
     C                   move      ' '           TGDEL
      * dato/kl sist refreshet
     C                   MOVE      ULDT          TGDTR
     C                   MOVE      XULTM         TGTIR
     c                   update    TKSGMR
      * 60 ON =NOE er endret - sett indikator på det som er uendret (skal blankes)
     C     TGNT          COMP      HENT                                   61
     C     TGVKT         COMP      HEVKT                                  62
     C     TGM3          COMP      HEM3                                   63
     C     TGLM          COMP      HELM                                   64
     C     TGPLL         COMP      HXPALL                                 65
     C     TGAVNA        COMP      HENAS                                  66
S06  C*  66TGAVA1        COMP      HEADS1                                 66
S06  C*  66TGAVA2        COMP      HEADS2                                 66
S06  C*  66TGAVA3        COMP      HEADS3                                 66
N06  C     TGAVA1        COMP      HEADS1                                 82
N06  C     TGAVA2        COMP      HEADS2                                 83
N06  C     TGAVA3        COMP      HEADS3                                 84
     C     TGMONA        COMP      HENAK                                  67
S06  C*  67TGMOA1        COMP      HEADK1                                 67
S06  C*  67TGMOA2        COMP      HEADK2                                 67
S06  C*  67TGMOA3        COMP      HEADK3                                 67
N06  C     TGMOA1        COMP      HEADK1                                 85
N06  C     TGMOA2        COMP      HEADK2                                 86
N06  C     TGMOA3        COMP      HEADK3                                 87
     C     TGHEKO        COMP      Hentkode                               68
     C     TGHETE        COMP      Henterm                                69
     C     TGLETE        COMP      Terminal                               70
     C     TGIN01        COMP      INF(01)                                71
     C     TGIN02        COMP      INF(02)                                72
     C     TGIN03        COMP      INF(03)                                73
     C     TGIN04        COMP      INF(04)                                74
     C     TGIN05        COMP      INF(05)                                75
     C     TGIN06        COMP      INF(06)                                76
     C     TGIN07        COMP      INF(07)                                77
     C     TGIN08        COMP      INF(08)                                78
     C     TGIN09        COMP      INF(09)                                79
     C     TGIN10        COMP      INF(10)                                80
     c     Versj         ifge      '02.37'
     C     TGSN17        COMP      HXSND17                                81
     C                   else
     c                   move      '1'           *in81                          *ON= Ikke endret
     C                   endif
N11  c     Versj         ifge      '03.14'
N11  C     TGVLIN        COMP      LININFO                                88
N11  C                   else                                                   Tst under ubetinget
N11  c                   move      '1'           *in88                          *ON= Ikke endret
N11  C                   endif
      * Indikator = 0 = endret    -> *IN60 ON = noe er endret...
     c     *in61         Ifeq      '0'
     c     *in62         oreq      '0'
     c     *in63         oreq      '0'
     c     *in64         oreq      '0'
     c     *in65         oreq      '0'
     c     *in66         oreq      '0'
     c     *in67         oreq      '0'
     c     *in68         oreq      '0'
     c     *in69         oreq      '0'
     c     *in70         oreq      '0'
     c     *in71         oreq      '0'
     c     *in72         oreq      '0'
     c     *in73         oreq      '0'
     c     *in74         oreq      '0'
     c     *in75         oreq      '0'
     c     *in76         oreq      '0'
     c     *in77         oreq      '0'
     c     *in78         oreq      '0'
     c     *in79         oreq      '0'
     c     *in80         oreq      '0'
     c     *in81         oreq      '0'
N06  c     *in82         oreq      '0'                                          HEADS1
N06  c     *in83         oreq      '0'                                          HEADS2
N06  c     *in84         oreq      '0'                                          HEADS3
N06  c     *in85         oreq      '0'                                          HEADK1
N06  c     *in86         oreq      '0'                                          HEADK2
N06  c     *in87         oreq      '0'                                          HEADK3
N11  c     *in88         oreq      '0'                                          lininfo
     C                   move      '1'           *IN60
     C                   end
     C                   move      'N'           KunSmeld          1
     c     *in60         Ifeq      '0'
     C     Smeld         Andne     *blanks
     C                   move      '1'           *IN60
     C                   move      'J'           KunSmeld
     C                   end
     C                   end
      *
     C     UtFins        endsr
      *
      *=====================================================================******
      *  Update loggfil med gamle verdier - for hva som sendes til pda
      *  ved endring av ordre - blank felt som ikke skal sendes
      *  (numeriske blankes basert på indikator direkte i SEMI)
      *=====================================================================******
     C     LogTKS        begsr
      * På poster som fines vil TGDEL være blank
     C     TKSGMKey      CHAIN     TKSGM                              35
     c                   clear                   TKSGMR
     C                   move      HEPRO         TGPRO
     C                   move      ' '           TGDEL
     C                   move      HEAVD         TGAVD
     C                   move      HEOPD         TGOPD
     C                   move      HXSND17       TGSN17
     C                   move      HENAS         TGAVNA
     C                   move      HEADS1        TGAVA1
     C                   move      HEADS2        TGAVA2
     C                   move      HEADS3        TGAVA3
     C                   move      HENAK         TGMONA
     C                   move      HEADK1        TGMOA1
     C                   move      HEADK2        TGMOA2
     C                   move      HEADK3        TGMOA3
     C                   move      HXPALL        TGPLL
     C                   move      HENT          TGNT
     C                   move      HEVKT         TGVKT
     C                   move      HELM          TGLM
     C                   move      HEM3          TGM3
     C                   move      Hentkode      TGHEKO
     C                   move      HenTerm       TGHETE
     C                   move      Terminal      TGLETE
     C                   move      INF(01)       TGIN01
     C                   move      INF(02)       TGIN02
     C                   move      INF(03)       TGIN03
     C                   move      INF(04)       TGIN04
     C                   move      INF(05)       TGIN05
     C                   move      INF(06)       TGIN06
     C                   move      INF(07)       TGIN07
     C                   move      INF(08)       TGIN08
     C                   move      INF(09)       TGIN09
     C                   move      INF(10)       TGIN10
N11  C                   move      LININFO       TGVLIN
     C     Refresh       ifne      'J'
     C                   move      'O'           TGKOH                          Original godsl.
     C                   else
     C  N60              move      'A'           TGKOH                          Addet til godsl
      * ikke sett flagg om endret dersom det kun er Øyeblikksmelding som er sendt
     C     KunSmeld      ifne      'J'
     C   60              move      'U'           TGKOH                          Updated verdi
     C                   end
     C                   end
      * sist sendt (original/endret)
     C                   MOVE      ULDT          TGDTH
     C                   MOVE      XULTM         TGTIH
      * sist Refreshet
     C                   MOVE      ULDT          TGDTR
     C                   MOVE      XULTM         TGTIR
     C   35              write     TKSGMR
     C  N35              update    TKSGMR
      *  60 ON = Update av et eksisterende oppdrag - send kun endrede verdier
     C     *in60         IFEQ      *ON
     C                   eval      HEPOS1 = '*U*'                               Flagg til TKSIGN
     C                   end
     C                   endsr
      **************************************************************
     C     IniTKSGM      begsr
      **************************************************************
      * ved første innhenting, delete avt gamle poster (etter Parker...)
      * ved Refresh sett Delet-merke X på alle oppdrag
      *     (....   SR FinsOpd opphever dette (setter blank) desom oppdrag ennå fins på tur
      *             til sist frese SR "DELOPD" gjennom alle som fremdeles har "X'  ...)
     C     TKSGMK2       setll     TKSGM
     C     TKSGMK2       reade     TKSGM                                  33
     C     *in33         doweq     '0'
     C     ReFresh       Ifeq      'N'
     C                   delete    TKSGMR
     C                   else
     C     TGOPD         IFNE      *ZEROS
     C                   move      'X'           TGDEL
     C                   end
     C                   Update    TKSGMR
     C                   end
     C     TKSGMK2       reade     TKSGM                                  33
     c                   end
     C                   endsr
      *
      *=====================================================================******
      *  Oppdrag som Finnes på PDA men ikke på Turen nå skal slettes
      *=====================================================================******
     C     DelOPD        begsr
      *
     C     FINSIKKE      setll     TKSGM
     C     FINSIKKE      reade     TKSGM                                  33
     C     *in33         doweq     '0'
     C                   delete    TKSGMR
     C                   move      TGAVD         Heavd
     C                   move      TGOPD         Heopd
     C     HeaKey        chain     Headf                              33
     C     *in33         ifeq      *off
     C                   eval      Hepos1   =  '*D*'
N02  C     TGSN17        ifne      *blanks
N02  C                   move      TGSN17        HXSND17
N02  C                   else
N02  C                   MOVEL     DSAVOP        HXSND17
N02  C                   endif
     C                   exsr      semi
     C                   callp     updHTMLvar('LINTXT':LinTxt)
     C                   callp     wrtsection('lin')
     C                   end
     C     FINSIKKE      reade     TKSGM                                  33
     c                   end
     C                   endsr
      *
      **************************************************************************
     C     UTF8U         begsr
      **************************************************************************
N09   * DERSOM NetCCSID = 1208 SÅ KONVERTERES TIL UTF8 AUTOMATISK
N09   * (men med klient-versjoner før 03.13 så forventer TKsign spesielle verdier..)
N09  C     NetCCSID      CABEQ     '1208'        UT_UTF8
N09   * ELLERS- MANUELL KONVERTERING AV DE VIKTIGSTE
     C                   move      'Æ'           Tegn
     C                   move      HexÆ          Hextegn
     C                   exsr      UTF8UB
     C                   move      'Ø'           Tegn
     C                   move      HexØ          Hextegn
     C                   exsr      UTF8UB
     C                   move      'Å'           Tegn
     C                   move      HexÅ          Hextegn
     C                   exsr      UTF8UB
     C                   move      'æ'           Tegn
     C                   move      HexÆl         Hextegn
     C                   exsr      UTF8UB
     C                   move      'ø'           Tegn
     C                   move      HexØl         Hextegn
     C                   exsr      UTF8UB
     C                   move      'å'           Tegn
     C                   move      HexÅl         Hextegn
     C                   exsr      UTF8UB
N09  C     UT_UTF8       TAG
     C                   endsr
      *
      **************************************************************************
     C     UTF8UB        begsr
      **************************************************************************
      *
     c                   move      *zeros        f                 3 0
     C     FlerTegn      tag
     C     Tegn          SCAN      EKSTRA        f
     C     f             cabeq     *zeros        UtUTF8                         ikke flere...
     C                   EVAL      EKSTRA2 = %SUBST(EKSTRA:1:f-1) +
     C                             HexTegn+
     C                             %trim(%SUBST(EKSTRA:f+1:256-f))
     C                   eval      EKSTRA = EKSTRA2
     C                   goto      FlerTegn
      *
     C     UtUTF8        endsr
