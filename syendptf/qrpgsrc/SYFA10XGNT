NOR   *lengde varmetillegg automatisk ****************************
      * RETTINGER I DETTE PROGRAM:
     H debug(*yes)
********************************************************************
      * RETTINGER I DETTE PROGRAM:
PTFnr:*Sek Sig Vers  Beskrivelse...........................
""""""*"""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""
11XXX * XX sh  PTF11
11XXX * 01 sh  PTF12  beregne prosentverdier
11XXX * 02 sh  PTF12  sammenslåingskode
11XXX * 03 sh  PTF12  eventuelt hele kroner
11XXX * 04 sh  PTF12  dokumentkontroll
11XXX * 05 sh  PTF12  unntakskunde
12150 * 06 sh  PTF12  'FR*' er fr1/fr2/fra
12150 * 07 sh  PTF12  ENDRING BRUTTOPRISLØSNING
12150 * 08 sh  PTF12  S= kun singelfaktura
12150 * 09 sh  PTF12  SJEKK OGSÅ HIS ALLEREDE UTFAKTURERT
12150 * 10 sh  PTF12  farlig godstillegg
12150 * 11 sh  PTF12  min max også på %relaterte avtaler
12150 * 12 sh  PTF12  feil test utelot gebyr ved kostnadslinje
12150 * 13 sh  PTF12  ta høyde for avtalekundenummer +
********************************************************************
NOR  FCUNDEDI   IF   E           K DISK
NOR  FNTE020F   IF   E           K DISK
N07  FKODTW     IF   E           K DISK
N07  FKODTV     IF   E           K DISK
N01  FKODTGE    IF   E           K DISK
     FARKTXT    IF   E           K DISK
N04  FARKIVL02  IF   E           K DISK
     FCUNDC03   IF   E           K DISK
n08  FCUNDL01   IF   E           K DISK
     FHEADF     IF   E           K DISK
     FVALUL01   IF   E           K DISK
     FPRIK1     IF   E           K DISK
     FPRIK3     IF   E           K DISK    PREFIX(A_)
     F                                     RENAME(PRIKR:PRIKR3)
     FPRIS      IF   E           K DISK
     FFAKT      UF A E           K DISK
n01  FFAK4      IF   E           K DISK
N01  F                                     RENAME(FAKTR:FAKTR2)
n09  FFAK6      IF   E           K DISK
N09  F                                     RENAME(FAKTR:FAKTR9)
     FFIRM      IF   E           K DISK
     D                 DS
     D  LK                     1     20
     D                                     DIM(10)                              I/O. landkode
     D  PKLK01                 1      2
     D  PKLK02                 3      4
     D  PKLK03                 5      6
     D  PKLK04                 7      8
     D  PKLK05                 9     10
     D  PKLK06                11     12
     D  PKLK07                13     14
     D  PKLK08                15     16
     D  PKLK09                17     18
     D  PKLK10                19     20
sh   D  A_PKLK01               1      2
sh   D  A_PKLK02               3      4
sh   D  A_PKLK03               5      6
sh   D  A_PKLK04               7      8
sh   D  A_PKLK05               9     10
sh   D  A_PKLK06              11     12
sh   D  A_PKLK07              13     14
sh   D  A_PKLK08              15     16
sh   D  A_PKLK09              17     18
sh   D  A_PKLK10              19     20
     D                 DS
     D  UR                     1     10
     D                                     DIM(10)                              I/O. ursp.kode
     D  PKUR01                 1      1
     D  PKUR02                 2      2
     D  PKUR03                 3      3
     D  PKUR04                 4      4
     D  PKUR05                 5      5
     D  PKUR06                 6      6
     D  PKUR07                 7      7
     D  PKUR08                 8      8
     D  PKUR09                 9      9
     D  PKUR10                10     10
sh   D  A_PKUR01               1      1
sh   D  A_PKUR02               2      2
sh   D  A_PKUR03               3      3
sh   D  A_PKUR04               4      4
sh   D  A_PKUR05               5      5
sh   D  A_PKUR06               6      6
sh   D  A_PKUR07               7      7
sh   D  A_PKUR08               8      8
sh   D  A_PKUR09               9      9
sh   D  A_PKUR10              10     10
     D                 DS
     D  TR                     1     40
     D                                     DIM(10)                              I/O. ursp.kode
     D  PTRA01                 1      4
     D  PTRA02                 5      8
     D  PTRA03                 9     12
     D  PTRA04                13     16
     D  PTRA05                17     20
     D  PTRA06                21     24
     D  PTRA07                25     28
     D  PTRA08                29     32
     D  PTRA09                33     36
     D  PTRA10                37     40
sh   D  A_PTRA01               1      4
sh   D  A_PTRA02               5      8
sh   D  A_PTRA03               9     12
sh   D  A_PTRA04              13     16
sh   D  A_PTRA05              17     20
sh   D  A_PTRA06              21     24
sh   D  A_PTRA07              25     28
sh   D  A_PTRA08              29     32
sh   D  A_PTRA09              33     36
sh   D  A_PTRA10              37     40
     D                 DS
     D  FR                     1     30
     D                                     DIM(10)                              I/O. frankatur
     D  PKFR01                 1      3
     D  PKFR02                 4      6
     D  PKFR03                 7      9
     D  PKFR04                10     12
     D  PKFR05                13     15
     D  PKFR06                16     18
     D  PKFR07                19     21
     D  PKFR08                22     24
     D  PKFR09                25     27
     D  PKFR10                28     30
SH   D  A_PKFR01               1      3
SH   D  A_PKFR02               4      6
SH   D  A_PKFR03               7      9
SH   D  A_PKFR04              10     12
SH   D  A_PKFR05              13     15
SH   D  A_PKFR06              16     18
SH   D  A_PKFR07              19     21
SH   D  A_PKFR08              22     24
SH   D  A_PKFR09              25     27
SH   D  A_PKFR10              28     30
     D                 DS
     D  FS                     1     50
     D                                     DIM(10)                              I/O. frasted
     D  PKFS01                 1      5
     D  PKFS02                 6     10
     D  PKFS03                11     15
     D  PKFS04                16     20
     D  PKFS05                21     25
     D  PKFS06                26     30
     D  PKFS07                31     35
     D  PKFS08                36     40
     D  PKFS09                41     45
     D  PKFS10                46     50
SH   D  A_PKFS01               1      5
SH   D  A_PKFS02               6     10
SH   D  A_PKFS03              11     15
SH   D  A_PKFS04              16     20
SH   D  A_PKFS05              21     25
SH   D  A_PKFS06              26     30
SH   D  A_PKFS07              31     35
SH   D  A_PKFS08              36     40
SH   D  A_PKFS09              41     45
SH   D  A_PKFS10              46     50
     D                 DS
     D  TS                     1     50
     D                                     DIM(10)                              I/O. tilsted
     D  PKTS01                 1      5
     D  PKTS02                 6     10
     D  PKTS03                11     15
     D  PKTS04                16     20
     D  PKTS05                21     25
     D  PKTS06                26     30
     D  PKTS07                31     35
     D  PKTS08                36     40
     D  PKTS09                41     45
     D  PKTS10                46     50
SH   D  A_PKTS01               1      5
SH   D  A_PKTS02               6     10
SH   D  A_PKTS03              11     15
SH   D  A_PKTS04              16     20
SH   D  A_PKTS05              21     25
SH   D  A_PKTS06              26     30
SH   D  A_PKTS07              31     35
SH   D  A_PKTS08              36     40
SH   D  A_PKTS09              41     45
SH   D  A_PKTS10              46     50
      *
      * lossested
      *
     D                 DS
s41  D* LS                     1     80
s41  D*                                    DIM(3)                               I/O. last/loss
     D  LS                     1    100
     D                                     DIM(5)                               I/O. last/loss
     D  PKLS01                 1     20
     D  PKLS02                21     40
     D  PKLS03                41     60
     D  PKLS04                61     80
     D  PKLS05                81    100
SH   D  A_PKLS01               1     20
SH   D  A_PKLS02              21     40
SH   D  A_PKLS03              41     60
SH   D  A_PKLS04              61     80
SH   D  A_PKLS05              81    100
      *
      * lastested
      *
     D                 DS
     D  L2                     1    100
     D                                     DIM(5)                               I/O. last/loss
     D  PKL201                 1     20
     D  PKL202                21     40
     D  PKL203                41     60
     D  PKL204                61     80
     D  PKL205                81    100
SH   D  A_PKL201               1     20
SH   D  A_PKL202              21     40
SH   D  A_PKL203              41     60
SH   D  A_PKL204              61     80
SH   D  A_PKL205              81    100
     D                 DS
     D  TP                     1      5
     D                                     DIM(5)                               I/O. tillprodu
     D  HESTN1                 1      1
     D  HESTN2                 2      2
     D  HESTN3                 3      3
     D  HESTN4                 4      4
     D  HESTN5                 5      5
SH   D  A_HESTN1               1      1
SH   D  A_HESTN2               2      2
SH   D  A_HESTN3               3      3
SH   D  A_HESTN4               4      4
SH   D  A_HESTN5               5      5
     D  TPX                    1      5
SH   D                 DS
SH   D  PKURIO                 1      1
SH   D  A_PKURIO               1      1
SH   D  PKFRIO                 2      2
SH   D  A_PKFRIO               2      2
sH   D  PKOTIO                 3      3
SH   D  A_PKOTIO               3      3
sH   D  PKLKIO                 4      4
SH   D  A_PKLKIO               4      4
sH   D  PKFSIO                 5      5
SH   D  A_PKFSIO               5      5
sH   D  PKTSIO                 6      6
SH   D  A_PKTSIO               6      6
sH   D  PKLSIO                 7      7
SH   D  A_PKLSIO               7      7
sH   D  PKL2IO                 8      8
SH   D  A_PKL2IO               8      8
sH   D  PTRAIO                 9      9
SH   D  A_PTRAIO               9      9
NOR  D                SDS
NOR  D  ZUSER                254    263
      *
     c                   EXSR      INIT
      * Sjekk om oppdrag er fakturert - skipp i så fall
     C                   EXSR      Fakturert
     C     Slutt         tag
     C                   seton                                        LR
     C                   return
      *
     C***********************************************
     C     INIT          BEGSR
     C***********************************************
     C     *entry        PLIST
     C                   PARM                    UAVD              4 0
     C                   PARM                    UOPD              7 0
     C                   PARM                    UINT              5 0
N01  C     KODTGEK       KLIST
N01  C                   KFLD                    FAST              2
N01  C                   KFLD                    PKGEBY
N01  C                   MOVE      'GE'          FAST
     c                   z-add     uavd          faavd
     c                   z-add     uopd          faopd
     C                   z-add     uint          xint              5 0
     C                   MOVE      '****'        bltr              4
      *
     C     FakKey        KLIST
     C                   KFLD                    FAAVD
     C                   KFLD                    FAOPD
      *
     c     *loval        setll     FIRM
     c                   read      FIRM
      *
     c     fakkey        chain     headf                              33
     C     HEUR          IFEQ      'H'
     C     HELKA         IFEQ      FILAND
     C     HETRI         IFNE      FILAND
     C                   MOVE      '*EKS'        BLTR
     C                   ELSE
     C                   MOVE      '*INN'        BLTR
     C                   END
     C                   ELSE
     C     HETRI         IFEQ      FILAND
     C                   MOVE      '*IMP'        BLTR
     C                   ELSE
     C                   MOVE      '*TRA'        BLTR
     C                   END
     C                   END
     C                   END
      * TEST LK INC/OMIT PÅ "UTENLANDS-SIDEN" (=HELKA VED SPEDISJ.OPPD)
     C                   MOVE      HELKA         INOMLK            2
      * TRANSP.OPPD: HELKA=FRASIDE/HETRI=TILSIDE (HVIS NORGE, BRUK TIL)
     C     HEUR          IFEQ      'H'
     C     HELKA         IFEQ      FILAND
     C                   MOVE      HETRI         INOMLK            2
     C                   ELSE
     C     HETRI         IFNE      FILAND
     C                   MOVE      HETRI         INOMLK            2
     C                   END
     C                   END
     C                   END
N07  C     KODTWK        KLIST
N07  C                   KFLD                    kowfa             1
N07  C                   KFLD                    FAAVD
N07  C                   MOVE      'W'           KOWFA
N07  c     kodtwk        chain     kodtw                              33
N07  C     KODTVK        KLIST
N07  C                   KFLD                    kovfa             1
N07  C                   KFLD                    FAAVD
N07  C                   MOVE      'V'           KOVFA
N07  c     kodtvk        chain     kodtv                              33
     c*                  dump
     C                   ENDSR
      *
     C***********************************************
     C     Fakturert     BEGSR
     C***********************************************
      *  sjekk om gebyret allerede er på fakturabildet
      *  PKGEBY
      *  den som har frakt belastet skal ha gebyret
      *
     C     KEYAVVIK      KLIST
     C                   KFLD                    KUNDNRA           8
     C                   KFLD                    ANR               1
     C                   KFLD                    pkgeby
     C                   MOVE      0             ANR
     C     KEYGENGE      KLIST
     C                   KFLD                    ALLE              8
     C                   KFLD                    HEFRGE            3
     C                   KFLD                    HEOTGE            2
     C                   move      '    ALLE'    ALLE
     C                   move      'GEN'         HEFRGE
     C                   move      'GE'          HEOTGE
     C                   SETOFF                                       55
     c     keygenge      SETLL     prik1
     C     *IN55         DOWEQ     '0'
N01  c     lesneste      tag
     c     keygenge      READE     prik1                                  55
     C     *IN55         IFEQ      '0'
     c                   move      'N'           Skipp             1
N04  c     pkkoll        ifeq      'K'
N04  c                   exsr      dokosr
N04  c     dokojn        ifeq      'N'
N04  c                   goto      lesneste
N04  c                   end
N04  c                   end
NOR   *
NOR  C     pkgeby        ifeq      'IMC'
NOR  c     fakkey        chain     NTE020F                            35
NOR  c   35              goto      lesneste
NOR  c                   end
NOR  C     pkgeby        ifeq      'COV'
NOR  C     hedtop        andlt     20200401
NOR  c                   goto      lesneste
NOR  C                   end
NOR  C     pkgeby        ifeq      'COV'
NOR  C     heavd         ifeq      21
NOR  c     heavd         oreq      28
NOR  c     heavd         oreq      35
NOR  c     heavd         oreq      35
NOR  c     heavd         oreq      37
NOR  c     heavd         oreq      38
NOR  c     heavd         oreq      128
NOR  c     heavd         oreq      138
NOR  c     heavd         oreq      121
NOR  c     heavd         oreq      135
NOR  c     heavd         oreq      136
NOR  c     heavd         oreq      137
NOR  c                   goto      lesneste
NOR  C                   end
NOR  c*EXW, FCA og FOB   import
NOR  c     heur          ifeq      'A'
NOR  c     hefr          andne     'EXW'
NOR  c     hefr          andne     'FCA'
NOR  c     hefr          andne     'FOB'
NOR  c                   goto      lesneste
NOR  c                   end
NOR  c*DDP og DAP/DAT    eksport
NOR  c     heur          ifeq      'B'
NOR  c     hefr          andne     'DDP'
NOR  c     hefr          andne     'DAP'
NOR  c     hefr          andne     'DAT'
NOR  c                   goto      lesneste
NOR  c                   end
NOR  C                   end
NOR  C     CUNDEK        KLIST
NOR  C                   KFLD                    FIFIRM
NOR  C                   KFLD                    hekna
NOR  C     pkgeby        ifeq      'LEN'
NOR  c     trsta4        ifne      'J'
NOR  c                   goto      lesneste
NOR  c                   end
NOR  c     trsta4        ifEQ      'J'
NOR   * unntakskunder som ikke skal ha lengdetillegg
NOR   * FI: 95250 Varova
NOR   * DK: 90300, 90305, 90310 BHS Logistics
NOR   * SE: 94890, 94899, 94895, 94870, 94860, 94880 SDK Logistics
NOR  C     HEKNA         IFEQ      95250
NOR  C     HEKNA         oreq      90300
NOR  C     HEKNA         oreq      90305
NOR  C     HEKNA         oreq      90310
NOR  C     HEKNA         oreq      94890
NOR  C     HEKNA         oreq      94899
NOR  C     HEKNA         oreq      94895
NOR  C     HEKNA         oreq      94870
NOR  C     HEKNA         oreq      94860
NOR  C     HEKNA         oreq      94880
NOR  C     HEKNA         oreq      94805
NOR  c                   goto      lesneste
NOR  c                   end
NOR   * kundgruppe 95500 skal ikke ha lengdetillegg
NOR  C     CUNDEK        CHAIN     CUNDEDI                            44
NOR  C     *IN44         IFEQ      '0'
NOR  C     CUKNRG        ANDEQ     95500
NOR  c                   goto      lesneste
NOR  c                   end
NOR  c                   end
NOR  c*    zuser         ifne      'SYSTEMA'
NOR  c*    zuser         andne     'AUD'
NOR  C*    ZUSER         ANDNE     'ELISABETH'
NOR  c*                  goto      lesneste
NOR  c*                  end
NOR  c                   end
NOR  C     pkgeby        ifeq      'THE'
NOR  c     trsta3        ifne      'J'
NOR  c                   goto      lesneste
NOR  c                   end
NOR  c                   end
      *
n08   * ikke ta med samlefakturakunder HVIS pkkoll=s
N08   * ELLER AT PART IKKE SKAL HA FAKTURA
n08   *
N08  C     PKAVTN        IFEQ      'S'
N08  C     HEKDFS        IFEQ      'X'
N08  c                   GOTO      LESNESTE
N08  C                   END
N08  C                   MOVE      HEKNSF        KUNDNR
N08  C                   ELSE
N08  C     HEKDFK        IFEQ      'X'
N08  c                   GOTO      LESNESTE
N08  C                   END
N08  C                   MOVE      HEKNKF        KUNDNR
N08  C                   END
s13  C*    PKKOLL        IFEQ      'S'
n08  c     kunkey        CHAIN     cundl01                            33
N13  c     *in33         ifeq      '0'
N13  C                   MOVE      KUNDNR        KUNDNRA
N13  c     AKNRKU        ifne      0
N13  c                   move      AKNRKU        KUNDNRA
N13  c                   end
N13  c                   end
N13  C     PKKOLL        IFEQ      'S'
n08  c     *in33         ifeq      '0'
n08  c     sfakt         andne     ' '
N08  c                   GOTO      LESNESTE
N08  c                   end
N08  c                   end
      *
      * skjekk om gebyret allerede er på fakturaen
      *
S06  C*    fakkey        setll     FAKT
S06  C*    fakkey        reade(N)  FAKT                                   34
s06  C*    fak4k         setll     FAK4
s06  C*    fak4k         reade     FAK4                                   34
n06  C     fak6k         setll     FAK6
n06  C     fak6k         reade     FAK6                                   34
     C     *in34         doweq     '0'
     c                   if        FASK = PKAVTN
     C                   move      FASK          PARTSK            1
     C                   move      FAKUNR        PARTKU            8 0
      * GEBYR LIGGER DER FRA FØR  SKIPP
     c                   if        FAVK = PKGEBY
N12  c     fakda         ifne      'K'
     c                   move      'J'           Skipp
     c                   leave
N12  c                   endif
     c                   endif
     c                   endif
S06  C*    fakkey        reade(N)  FAKT                                   34
s09  C*    fak4k         reade     FAK4                                   34
n09  C     fak6k         reade     FAK6                                   34
     C                   enddo
     c     skipp         ifeq      'N'
     C     EPOKEYk       KLIST
     C                   KFLD                    FIFIRM
     C                   KFLD                    mail30
     C                   KFLD                    PARTKU
N08  C     KUNKEY        KLIST
N08  C                   KFLD                    FIFIRM
N08  C                   KFLD                    KUNDNR
     C     'fa'          chain     arktxt                             33
     C                   MOVE      ARTXT         MAIL16           16
     C                   MOVEL     '*'           MAIL16
     c                   movel     MAIL16        mail30           30
     c  N33              MOVE      'J'           epostk
     C                   MOVE      'N'           EPOSTK            1
     c     epokeyk       CHAIN     cundc03                            33
     c  N33              MOVE      'J'           epostk
     c                   exsr      tstgio
     C   78              MOVE      'J'           SKIPP
     c                   end
      *
     c     fask          ifeq      PKAVTN
     C     SKIPP         IFEQ      'N'
     C                   EXSR      CrtTilLin
     C                   END
     C                   END
      *
     C                   END
     C                   END
     C                   ENDSR
     C***********************************************
     C     CrtTilLin     BEGSR
     C***********************************************
      * legg ut linje i FAKT
      *
      * hent pris
      *
      *
     C     KEYPRIS       KLIST
     C                   KFLD                    PKTNR
     C                   KFLD                    PKGEBY
     C                   KFLD                    XINT
      *
      *
     C     KEYPRIS1      KLIST
     C                   KFLD                    PKTNR
     C                   KFLD                    PKGEBY
N01  c     KODTGEK       chain     KODTGE                             33
N01  c     *in33         ifeq      '0'
N01   *
N01  c     PKBELØ        ifne      *zeros
N01  c     kgetyp        ifeq      'FRA'
N01  c     kgetyp        oreq      'FR1'
N01  c     kgetyp        oreq      'FR2'
N06  C     kgetyp        oreq      'FR*'
S13  C*                  MOVE      FAKUNR        KUNDNRA
     c     keyavvik      chain     prik3                              34
     C     *IN34         IFEQ      '0'
SH   C                   exsr      tstgio
SH   C   78              GOTO      utsr
     C     A_PKBELØ      IFEQ      0
     C                   GOTO      UTSR
     c                   else
     c                   Z-add     A_PKBELØ      PKBELØ
N02  C                   MOVE      A_PKSAMM      PKSAMM
     C                   END
     C                   END
N01  c                   exsr      sumfakt
sh   c*                  goto      videre
sh   c                   goto      videre2
N01  c                   end
N01  c                   end
N05   * ikke fraktrelatert
S13  C*                  MOVE      FAKUNR        KUNDNRA
n05  c     keyavvik      chain     prik3                              33
n05  c     *in33         ifeq      '0'
SH   C                   exsr      tstgio
SH   C   78              goto      utsr
n05  C     A_PKBELØ      IFEQ      0
n05  C                   GOTO      UTSR
n05  c                   else
n05  c                   Z-add     A_PKBELØ      PRBELØ
N05  C                   MOVE      A_PKSAMM      PKSAMM
N05  c                   goto      videre
N05  c                   end
n05  c                   end
sh   c     videre        tag
      * hente pris fra brutttotabell
     c     keypris       setll     pris
     c     keypris1      reade     pris                                   33
     c     *in33         ifeq      '0'
sh   c     videre2       tag
      *
     c                   CLEAR                   FAKTR
     C                   MOVE      PARTSK        FASK
     C                   MOVE      PARTKU        FAKUNR
     C                   MOVE      UAVD          FAAVD
     C                   MOVE      UOPD          FAOPD
     C                   MOVE      PKGEBY        FAVK
     C                   MOVE      FICURR        FAVAL
     C                   MOVE      'B'           FAKDA
     C                   MOVE      PKMVA         FAKDM
N07   *** PRIS  PR
N07  C     PRANT         IFGT      0
N07  C                   EXSR      OMREGN                                       1<-B
N07  C                   END
     C                   eval      FABELV = PRBELØ
     C                   eval      FABELN = PRBELØ
N03  c                   exsr      deci
     C                   move      *BLANKS       FAVT
N02  C                   MOVE      PKSAMM        FACD11
n06  C     FABELN        IFNE      0
     C                   CALL      'SYGE06'
     C                   PARM                    FAAVD
     C                   PARM                    FAOPD
     C                   PARM                    FALI
NOR  C     favk          ifeq      'IMC'
NOR  c                   exsr      unntak
NOR  c                   end
     C                   exsr      valuta
NOR  C     favk          ifeq      'CA2'
NOR  c     fakunr        iflt      90000
NOR  c                   write     faktR
NOR  c                   end
NOR  c                   else
     C                   WRITE     FAKTR
NOR  c                   end
     C                   end
n06  C                   end
     C                   end
     C     utsr          ENDSR
      ***********************************************
     C     VALUTA        BEGSR
      ***********************************************
      * Converts from local currency to whatever currency that is
      * to be used on the invoice.
      * If the invoice is to be written in local currency or the line
      * already is in the right currency, nothing is done.
      *
     C*
     C*CURRENCY INVOICED (BLANK=FICURR)
     C     VALU1K        KLIST
     C                   KFLD                    fifirm
     C                   KFLD                    wsval
     C                   MOVE      *BLANKS       FACURI
     C     FASK          IFEQ      'I'
     C                   MOVE      FAVAL         WSVAL             3
     C                   ELSE
     C     FASK          IFEQ      'S'
     C                   MOVE      HEVALS        WSVAL
     C                   ELSE
     C     FASK          IFEQ      'K'
     C                   MOVE      HEVALK        WSVAL
     C                   ELSE
     C     FASK          IFEQ      'X'
     C                   MOVE      VALKOD        WSVAL
     C                   END
     C                   END
     C                   END
     C                   END
      * SKAL FAKTURERES I "HJEMMEVALUTA" - HOPP UT..
     C     WSVAL         IFEQ      *BLANKS
     C     WSVAL         OREQ      FICURR
     C                   GOTO      SLVAL
     C                   END
      *
      * SKAL FAKTURERES I "FREMMEDVALUTA" MEN LINJA HAR ALT DEN SAMME
      * INGEN OMREGNING - FREMMEDVALUTAEN LAGRES PÅ LINJA -HOPP SÅ UT
      *
     C     FAVAL         IFEQ      WSVAL
     C                   MOVE      WSVAL         FACURI
     C                   GOTO      SLVAL
     C                   END
     C*
     C     VALU1K        CHAIN     VALUL01                            31
      *
     C     FABELN        MULT      OMRFAK        XWORK            17 5
     C     XWORK         DIV(H)    VALKU1        FABELV
     C                   MOVE      WSVAL         FAVAL
     C*CURRENCY INVOICED (NÅR FORSKJELLIG FRA FICURR)
     C                   MOVE      WSVAL         FACURI
     C*                  DUMP
      *
     C     SLVAL         ENDSR
      *
      ***********************************************
     C     TSTGIO        BEGSR
      ***********************************************
      *
      *    INDIKATOR  78    betyr ikke skal være med
      *
      *          contains all include/omit conditions possible for one
      *          priceline (max. include or omit per condition)
      *
     C                   SETOFF                                       78
N10   * farlig godstillegg
N10  C     pkkoll        ifeq      'F'
N10  c     trfa11        andeq     *blanks
N10  c     trfa21        andeq     *blanks
N10  c                   seton                                        78
N10  c                   end
      * KODE I HOPP UT VED EPOSTKUNDE
     C     PKKOLL        IFEQ      'I'
     C     EPOSTK        ANDEQ     'J'
     C                   SETON                                        78
     C                   GOTO      UTGIO
     C                   END
      *
      * ______________________________
      * Ursprungskode - Include / Omit
      * """"""""""""""""""""""""""""""
     C     PKURIO        IFNE      ' '                                          II
     C     PKURIO        IFEQ      'I'                                          III
      * Ved include må begrepet finnes i -arrayet (->80 on)
     C                   SETOFF                                       80
     C     HEUR          LOOKUP    UR                                     80
     C  N80              SETON                                        78
     C                   ELSE
      * Ved omit må begrepet IKKE finnes i -arrayet (->80 off)
     C                   SETOFF                                       80
     C     HEUR          LOOKUP    UR                                     80
     C   80              SETON                                        78
     C                   END                                                    III
     C                   END                                                    II
      *--------------------------------
      * ved *AVD  er det avdelinger
      *--------------------------------
     C     TR(1)         IFEQ      '*AVD'
     C     PTRAIO        ANDNE     ' '                                          III
     C                   SETOFF                                       80
     C                   movel     heavd         test4             4
     C     test4         LOOKUP    TR                                     80
     C     PTRAIO        IFEQ      'I'                                          III
     C  N80              SETON                                        78
     C                   ELSE
      * Ved omit må begrepet IKKE finnes i -arrayet (->80 off)
     C   80              SETON                                        78
     C                   END                                                    III
     C                   ELSE                                                   II
      *--------------------------------
      * ved *pro  er det produktkode
      *--------------------------------
     C     TR(1)         IFEQ      '*PRO'
     C     HEKDPL        ANDNE     ' '
     C     PTRAIO        ANDNE     ' '                                          III
     C                   SETOFF                                       80
     C                   movel     hekdpl        test4             4
     C     test4         LOOKUP    TR                                     80
     C     PTRAIO        IFEQ      'I'                                          III
     C  N80              SETON                                        78
     C                   ELSE
      * Ved omit må begrepet IKKE finnes i -arrayet (->80 off)
     C   80              SETON                                        78
     C                   END                                                    III
     C                   ELSE                                                   II
      *--------------------------------
      * ved *TIL  er det tilleggsgebyrer
      *--------------------------------
     C     TR(1)         IFEQ      '*TIL'
     C     TPX           ANDNE     *BLANKS
     C     PTRAIO        ANDNE     ' '                                          III
      * skal alltid følge frakten
     C     PARTSK        COMP      TRKDFF                                 80
     C  N80              SETON                                        78
     C   78              GOTO      UTGIO
      *includetester prøver å finne en gyldig
     C                   SETOFF                                       80
     C     PTRAIO        IFEQ      'I'                                          III
     C     1             do        5             NR                2 0
     C     TP(NR)        ifne      ' '
     C                   movel     TP(NR)        test4             4
     C     test4         LOOKUP    TR                                     80
     c   80              goto      tilut
     C                   end
     c                   end
     c                   seton                                        78
      *omittester
     C                   ELSE
      * Ved omit må begrepet IKKE finnes i -arrayet (->80 off)
     C     1             do        5             NR
     C     TP(NR)        ifne      ' '
     C                   movel     TP(NR)        test4             4
     C     test4         LOOKUP    TR                                     80
     C   80              SETON                                        78
     c   80              goto      tilut
     C                   end
     c                   end
     C                   END                                                    III
     C                   ELSE                                                   II
      * ______________________________
      * trafikk sjø     Include / Omit
      * transportdisp benyttes til *IMP *EKSP *INN
      * """"""""""""""""""""""""""""""
     C     PTRAIO        IFNE      ' '                                          II
     C     PTRAIO        IFEQ      'I'                                          III
      * Ved include må begrepet finnes i -arrayet (->80 on)
     C                   SETOFF                                       80
     C     BLTR          LOOKUP    TR                                     80
     C  N80              SETON                                        78
     C                   ELSE
      * Ved omit må begrepet IKKE finnes i -arrayet (->80 off)
     C                   SETOFF                                       80
     C     BLTR          LOOKUP    TR                                     80
     C   80              SETON                                        78
     C                   END                                                    III
     C                   END                                                    II
     C                   END                                                    II
     C                   END                                                    II
     C                   END                                                    III
     C     TILUT         TAG
      * ___________________________________
      * Frankatur/Oppdt. er låst ved brutto
      * """""""""""""""""""""""""""""""""""
      *
      * ______________________________
      * Oppdr.type    - Include / Omit
      * """"""""""""""""""""""""""""""
      * ______________________________
      * Landkode     - Include / Omit
      * """"""""""""""""""""""""""""""
     C  N78PKLKIO        IFNE      ' '                                          II
     C     PKLKIO        IFEQ      'I'                                          III
      * Ved include må begrepet finnes i -arrayet (->80 on)
     C                   SETOFF                                       80
     C     INOMLK        LOOKUP    LK                                     80
     C  N80              SETON                                        78
     C                   ELSE
      * Ved omit må begrepet IKKE finnes i -arrayet (->80 off)
     C                   SETOFF                                       80
     C     INOMLK        LOOKUP    LK                                     80
     C   80              SETON                                        78
     C                   END                                                    III
     C                   END                                                    II
      *
      * ______________________________
      * Frasted      - Include / Omit
      * """"""""""""""""""""""""""""""
     C  N78PKFSIO        IFNE      ' '                                          II
     C     PKFSIO        IFEQ      'I'                                          III
     C     FS(1)         IFEQ      '*FRTI'
     C     HESDF         IFLT      FS(2)
     C     HESDF         ORGT      FS(3)
     C                   SETON                                        78
     C                   END
     C                   ELSE
      * Ved include må begrepet finnes i -arrayet (->80 on)
     C                   SETOFF                                       80
     C     HESDF         LOOKUP    FS                                     80
     C  N80              SETON                                        78
     C                   END
     C                   ELSE
      * Ved omit måbegrepet IKKE finnes i -arrayet (->80 off)
     C                   SETOFF                                       80
     C     FS(1)         IFEQ      '*FRTI'
     C     HESDF         IFGE      FS(2)
     C     HESDF         ANDLE     FS(3)
     C                   SETON                                        78
     C                   END
     C                   ELSE
     C     HESDF         LOOKUP    FS                                     80
     C   80              SETON                                        78
     C                   END
     C                   END                                                    III
     C                   END                                                    II
      *
      * ______________________________
      * Tilsted      - Include / Omit
      * """"""""""""""""""""""""""""""
     C  N78PKTSIO        IFNE      ' '                                          II
     C     PKTSIO        IFEQ      'I'                                          III
     C     TS(1)         IFEQ      '*FRTI'
     C     HESDT         IFLT      TS(2)
     C     HESDT         ORGT      TS(3)
     C                   SETON                                        78
     C                   END
     C                   ELSE
      * Ved include må begrepet finnes i -arrayet (->80 on)
     C                   SETOFF                                       80
     C     HESDT         LOOKUP    TS                                     80
     C  N80              SETON                                        78
     C                   END
     C                   ELSE
      * Ved omit måbegrepet IKKE finnes i -arrayet (->80 off)
     C     TS(1)         IFEQ      '*FRTI'
     C     HESDT         IFGE      TS(2)
     C     HESDT         ANDLE     TS(3)
     C                   SETON                                        78
     C                   END
     C                   ELSE
     C                   SETOFF                                       80
     C     HESDT         LOOKUP    TS                                     80
     C   80              SETON                                        78
     C                   END
     C                   END                                                    III
     C                   END                                                    II
      * ______________________________
      * Losssested      - Include / Omit
      *(Gebyrer som er betinget av valgfrie felt tas
      * aldri med dersom feltet i oppdraget er blankt)
      * """"""""""""""""""""""""""""""
     C  N78PKLSIO        IFNE      ' '                                          II
     C     HESDL         IFEQ      *BLANKS                                      III
     C                   SETON                                        78
     C                   ELSE
     C     PKLSIO        IFEQ      'I'                                          IIII
      * Ved include må begrepet finnes i -arrayet (->80 on)
     C                   SETOFF                                       80
     C     HESDL         LOOKUP    LS                                     80
     C  N80              SETON                                        78
     C                   ELSE
      * Ved omit måbegrepet IKKE finnes i -arrayet (->80 off)
     C                   SETOFF                                       80
     C     HESDL         LOOKUP    LS                                     80
     C   80              SETON                                        78
     C                   END                                                    IIII
     C                   END                                                    III
     C                   END                                                    II
      *
      * ______________________________
      * Lastested      - Include / Omit
      *(Gebyrer som er betinget av valgfrie felt tas
      * aldri med dersom feltet i oppdraget er blankt)
      * """"""""""""""""""""""""""""""
     C  N78PKL2IO        IFNE      ' '                                          II
     C     HESDLA        IFEQ      *BLANKS                                      III
     C                   SETON                                        78
     C                   ELSE
     C     PKL2IO        IFEQ      'I'                                          IIII
      * Ved include må begrepet finnes i -arrayet (->80 on)
     C                   SETOFF                                       80
     C     HESDLA        LOOKUP    L2                                     80
     C  N80              SETON                                        78
     C                   ELSE
      * Ved omit måbegrepet IKKE finnes i -arrayet (->80 off)
     C                   SETOFF                                       80
     C     HESDLA        LOOKUP    L2                                     80
     C   80              SETON                                        78
     C                   END                                                    IIII
     C                   END                                                    III
     C                   END                                                    II
      *
      *
      * _______________________________________________________________
      * UTLØPSDATO (indikator 79 varsler at minsten linje i avt utløpt)
      * """""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""
     C     PKDT          IFGT      0
     C  N78
     CANN79PKDT          COMP      HEDTOP                               79
     C  N78PKDT          COMP      HEDTOP                               78
     C                   END
      * Linjen ok? (indikator 78 varsler at denne linje ikke gjelder)
      *
     C     UTGIO         ENDSR
      *
      *
N01   ***********************************************
N01  C     SUMFAKT       BEGSR
N01   ***********************************************
N01  C     FAK4K         KLIST
N01  C                   KFLD                    UAVD
N01  C                   KFLD                    UOPD
S06  C*                  KFLD                    PARTSK
n06  C                   KFLD                    pkavtn
N09  C     FAK6K         KLIST
N09  C                   KFLD                    UAVD
N09  C                   KFLD                    UOPD
NOR   * bytt type fra FR* til FRX på agenter
NOR  c     fakunr        ifge      90000
NOR  c     fakunr        andle     99999
NOR  C     pkgeby        andeq     'IMC'
NOR  C                   move      'FRX'         kgetyp
NOR  C                   end
N01  C     FAK4K         SETLL     FAK4
N01  C                   MOVE      *ZEROS        frabel
N01  C                   SETOFF                                       33
N01  C     *in33         doweq     '0'
N01  C     FAK4K         READE     FAK4                                   33
N01  c     *in33         ifeq      '0'
s06  C*    FAVK          ANDEQ     KGETYP
N06  C     FAVK          ifeq      KGETYP
N01  C                   ADD       FABELN        FRABEL           13 2
N06  c                   else
N06  C     KGETYP        IFEQ      'FR*'
N06  C     FAVK          IFEQ      'FR1'
N06  C     FAVK          OREQ      'FR2'
N06  C     FAVK          OREQ      'FRA'
N06  C                   ADD       FABELN        FRABEL           13 2
N06  c                   end
N06  c                   end
N06  c                   end
N01  C                   END
N01  c                   enddo
N01  c     FRABEL        mult      pkbelØ        wrk              15 4
N01  c     wrk           div       100           prbelØ
N11  c     PRBELØ        ifne      0
n11  c     wrk           div       100           prbelØw          11 3
n11   * evt min max på fraktrelatert gebyr
n11  c     keypris       setll     pris
n11  c     keypris1      reade     pris                                   33
n11  c     *in33         ifeq      '0'
n11  c                   z-add     prbelØw       prbelØ
n11  c     prtegn        ifne      ' '
N11  C     PRTEGN        IFEQ      '-'
N11  C                   SUB       PRJUST        PRBELØ
N11  C                   ELSE
N11  C     PRTEGN        IFEQ      '+'
N11  C                   ADD       PRJUST        PRBELØ
N11  C                   ELSE
N11   * flyttet linjene til egen subrutine
N11  C                   exsr      mimasr
N11   *
N11  C                   END
N11  C                   END
N11  C                   END
N11  C                   END
N11  C                   END
N01  C                   ENDSR
N03   ***********************************************
N03  C     DECI          BEGSR
N03   ***********************************************
N03   * TEST FIRMS NUMBER OF DECIMALS
N03   *
N03   * NO DECIMALS
N03  C     FIDECI        IFEQ      0
N03  C                   Z-ADD(H)  FABELN        FABEL0           11 0
N03  C                   Z-ADD     FABEL0        FABELN
N03  C                   Z-ADD(H)  FABELU        FABEL0           11 0
N03  C                   Z-ADD     FABEL0        FABELU
N03  C                   ELSE
N03   * 1 DECIMAL
N03  C     FIDECI        IFEQ      1
N03  C                   Z-ADD(H)  FABELN        FABEL1           12 1
N03  C                   Z-ADD     FABEL1        FABELN
N03  C                   Z-ADD(H)  FABELU        FABEL1           12 1
N03  C                   Z-ADD     FABEL1        FABELU
N03  C                   END
N03  C                   END
N03   *
N03  C                   ENDSR
N04   ***********************************************
N04  C     DOKOSR        BEGSR
N04   ***********************************************
N04  c                   move      'N'           dokojn            1
N04  C     arkkey        klist
N04  c                   kfld                    arstat
N04  c                   kfld                    uavd
N04  c                   kfld                    uopd
N04  c                   kfld                    artype
N04  c                   move      'A'           arstat
N04  c                   move      'sd'          artype
N04  c     arkkey        chain     arkivl02                           33
N04  c  N33              move      'J'           dokojn
N04  c                   endsr
N07   ***********************************************
N07  C     OMREGN        BEGSR
N07   ***********************************************
N07   *
N07   *** AJUSTING VEIGHT        - LESS THAN 1000 TO NEAREST  10 KILO
N07   *** ELSE TO NEAREST     100 KG, BUT IF PRICE IS GIVEN   PR. 2-10
N07   *** TO NEAREST  10 KG. NOT IF PRICE PR 1 KILO
N07   *
N07   *** IF FIRM HAVE DEFINED NO AJUSTMENT
N07   *** (INGAVR = 'J') NO AJUSTMENT IS PERFORMED
N07   *
N07  C     PRKOLL        IFEQ      'B'
N07  C                   Z-ADD     HEVKT         XVEKT             9 0
N07  C                   MOVE      *BLANKS       PRKOLL
N07  C                   ELSE
N07  C                   Z-ADD     HEFBV         XVEKT
N07  C                   END
N07   *
N07  C     PRKOLL        IFEQ      ' '                                          NOT PR LINE/PIESES
N07   * 1
N07  C     KOVAVR        IFNE      'J'
N07   * 2
N07  C     KOWMM         IFNE      3
N07   * 2B
N07  C     PRANT         IFNE      1
N07   * 3
N07  C     XVEKT         IFLT      1000                                         WEIGHT <   1000 KG
N07  C     XVEKT         ADD       9             XVEKT2            9 0          AJUST TO NEARES
N07  C                   MOVE      '0'           XVEKT2                         10 KG
N07  C                   ELSE                                                   WEIGHT >=     1000 K
N07  C     PRANT         IFGT      10                                           PRICE IS GIVEN PR 10
N07  C     XVEKT         ADD       99            XVEKT2                         KG OR MORE  , AJUST
N07  C                   MOVE      '00'          XVEKT2                         TO NEAREST   100 KG
N07  C                   ELSE
N07  C     XVEKT         ADD       9             XVEKT2                         PRICE GIVEN PR
N07  C                   MOVE      '0'           XVEKT2                         2-9 KG, AJUST TO
N07  C                   END                                                    NEAREST  10 KG
N07  C                   END
N07   * 3
N07  C                   ELSE                                                   NO AJUSTMENT
N07  C                   Z-ADD     XVEKT         XVEKT2
N07  C                   END
N07   * 2B
N07  C                   ELSE                                                   PRICE PR 1 AND NOT P
N07  C                   Z-ADD     XVEKT         XVEKT2                         LINEPRICE/PIESESPRIC
N07  C                   END
N07   * 2
N07  C                   ELSE                                                   PRICE PR 1 AND NOT P
N07  C                   Z-ADD     XVEKT         XVEKT2                         LINEPRICE/PIESESPRIC
N07  C                   END
N07   * 1
N07  C     PRBELØ        DIV       PRANT         XWORK
N07  C     XWORK         MULT(H)   XVEKT2        PRBELØ
N07  C                   END
N07  C     PRKOLL        IFEQ      'M'
N07  C     PRANT         IFNE      *ZEROS
N07  C                   MULT(H)   HEM3          PRBELØ
N07  C                   DIV(H)    PRANT         PRBELØ
N07  C                   END
N07  C                   END
N07   *
N07  C     PRKOLL        IFNE      'D'
N07  C     PRKOLL        IFNE      'L'
N07  C     HENTF         ORGT      0
N07  C     PRTEGN        IFEQ      '-'
N07  C                   SUB       PRJUST        PRBELØ
N07  C                   ELSE
N07  C     PRTEGN        IFEQ      '+'
N07  C                   ADD       PRJUST        PRBELØ
N07  C                   ELSE
N07   * flyttet linjene til egen subrutine
N07  C                   exsr      mimasr
N07   *
N07  C                   END
N07  C                   END
N07  C                   END
N07  C                   END
N07   *
N07  C                   ENDSR
N07   ***********************************************
N07  C     MIMASR        BEGSR
N07   ***********************************************
N07   *
N07   * M = MINIMUM
N07  C     PRTEGN        IFEQ      'M'
N07  C     PRBELØ        IFLT      PRJUST
N07  C                   Z-ADD     PRJUST        PRBELØ
N07  C                   END
N07  C                   ELSE
N07  C                   MOVE      'M'           KODEMM            1
N07  C                   END
N07   * N = MAXIMUM
N07  C     PRTEGN        IFEQ      'N'
N07  C     PRBELØ        IFGT      PRJUST
N07  C                   Z-ADD     PRJUST        PRBELØ
N07  C                   END
N07  C                   END
N07  C                   ENDSR
NOR   ***********************************************
NOR  C     UNNTAK        BEGSR
NOR   ***********************************************
NOR   * gjelder ikke agentene 90.000 99.999
NOR  C     FAKUNR        IFLT      90000
NOR  C     FAKUNR        ORGT      99999
NOR   * Avd. 11-34: 1900,-
NOR  C     FAAVD         IFGE      11
NOR  C     FAAVD         ANDLE     34
NOR  C                   Z-ADD     1900          fabeln
NOR  C                   Z-ADD     1900          fabelv
NOR  C                   END
NOR   * Avd 35-39: 1300,-
NOR  C     FAAVD         IFGE      35
NOR  C     FAAVD         ANDLE     39
NOR  C                   Z-ADD     1300          fabeln
NOR  C                   Z-ADD     1300          fabelv
NOR  C                   END
NOR  C                   end
NOR  C                   ENDSR
