      *********************************************************************
CRTPG+*  CRTPGM SYSPED/TNOI002R MODULE(*LIBL/TNOI002R *LIBL/INCGI)
CRTPGM*        ACTGRP(*NEW) AUT(*USE)
********************************************************************
      * RETTINGER I DETTE PROGRAM:
PTFnr:*Sek Sig Vers  Beskrivelse...........................
""""""*"""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""
12281 * 01 YBC PTF12 4 SIFFER PROSEDYRE OG 2 SIFFER TRANSAKSJONSTYPE
********************************************************************
      *********************************************************************
      /copy SYSPEDS/qrpgsrcpy,hspecs
      /copy SYSPEDS/qrpgsrcpy,hspecsbnd
      *********************************************************************
     FBRIDF     IF   E           K DISK    USROPN
     FFIRM      IF   E             DISK    USROPN
     FSADH      UF A E           K DISK    USROPN
     F                                     PREFIX(X)
     FSADH1     IF   E             DISK    USROPN
     F                                     RENAME(SADHR:SADHR1)
     FSADHIN    UF A E           K DISK    USROPN
     F                                     PREFIX(X)
     FSADHOM    UF A E           K DISK    USROPN
     F                                     RENAME(SADHR:SADHROM)
     F                                     PREFIX(OM_)
     FSADV      IF A E           K DISK    USROPN
     FSTANDI    UF   E           K DISK    USROPN
     F                                     PREFIX(Y)
     FKODTSI1   IF   E           K DISK    USROPN
     F                                     RENAME(KOSIR:KOSIR1)
     FKODTSI    IF   E           K DISK    USROPN
     FHEADF     IF   E           K DISK    USROPN
     FCUNDL01   UF   E           K DISK    USROPN
     FEDIC      UF   E             DISK    USROPN
     FEDIM1     UF A E           K DISK    USROPN
     FEDIM2     IF   E           K DISK    USROPN
     F                                     RENAME(EDIMR:EDIMR2)
     FEDIM4     IF   E           K DISK    USROPN
     F                                     RENAME(EDIMR:EDIMR4)
     FFRISOK    UF A E           K DISK    USROPN
     FFRISOL01  IF   E           K DISK    USROPN
     F                                     RENAME(FRISOKR:FRISOKRL)
     FTVIND     UF A E           K DISK    USROPN
     FKODTA     IF   E           K DISK    USROPN
     FKODTLB    IF   E           K DISK    USROPN
     FKODTVAL2  IF   E           K DISK    USROPN
      *--------------------------------------------------------------------
      * Variables common to all CGIs
      *--------------------------------------------------------------------
      /copy SYSPEDS/qrpgsrcpy,prototypeb
      /copy SYSPEDS/qrpgsrcpy,usec
      /copy SYSPEDS/qrpgsrcpy,variables3
      *
      * Varible for
     D P               S              5U 0
     D WSUSER          S             10
     D SIAVDA          S              4
     D NEWSYAVA        S              4
     D NEWAVD          S              4  0
     D SITDNA          S              7
     D NEWOPD          S              7  0
     D WMODE           S              2
     D WSISG           S              3
     D NEWSISG         S              3
     D XREF            S             35
     D INSIVF          S              1
     D INSIBVNV        S              4  2
     D SITYPE          S              4
     D SIFT01          S             70
     D SIFT02          S             70
     D SIFT03          S             70
     D SIFT04          S             70
     D SIFT05          S             70
     D WM1N07          S              3
     D WM3039E         S              6S 0
     D WM2005B         S              8S 0
     D WM5004D         S             10S 0
     D WMVEN           S              1
     D WM0035          S              1
     D WM9N01          S              1S 0
     D WS3039EX1       S              6    INZ('020603')
     D WS3039EX2       S              6    INZ('      ')
     D WS3039EX3       S              6    INZ('      ')
     D WURL1           S            200
     D WURL2           S            200
     D WURL3           S            200
     D WURL4           S            200
     D WURL5           S            200
     D WURL6           S            200
     D WURL7           S            200
     D WURL8           S            200
     D WURL9           S            200
     D WA              S             15
     D WOPDKNUM        S              1
     D DETA            S             12
     D JSONstring      S          32000
     D Error           S            150
     D                 DS
     D  X0068Æ                 1      9  0
     D  X0068A                10     17  0
     D  X0068B                18     23  0
     D  X0068C                24     25  0
     D  X0068Å                 2     25
     D  XN068Å                 1     25
     D                 DS
     D  SYRG                   1     14
     D  SYFORE                 1      9
     D                 DS
     D  SI27                   1     27
     D  SIBELC                 1     11  2
     D  SIRAB                 12     15  2

      *get input-string
      /copy syspeds/qrpgsrcpy,prolog3

      * Parse input
     C                   EXSR      Parse
      * Open files etc
     C                   EXSR      INIT
      *
     c                   callp     gethtmlifs(
     C                             '/syspeddev/html/JSON.html':
     C                             '/CGITAG/')
     C                   callp     wrtsection('top')
      * Teste input og utfør
     C  N50              EXSR      TEST

      * ............................................................................................
      * skriv JSON-Object start..(alltid '{' + x ant param. m/komma mellom (IKKE komma etter siste))
      * ............................................................................................
      *
      /free
        JSONstring='{'
        +'¬user¬ : ¬'+%trim(WSUSER)+'¬, '
        +'¬siavd¬ : ¬'+%trim(%editc(SIAVD:'Z'))+'¬, '
        +'¬newavd¬ : ¬'+%trim(%editc(NEWAVD:'Z'))+'¬, '
        +'¬sitdn¬ : ¬'+%trim(%editc(SITDN:'M'))+'¬, '
        +'¬newopd¬ : ¬'+%trim(%editc(NEWOPD:'M'))+'¬, '
        +'¬sisg¬ : ¬'+%trim(WSISG)+'¬, '
        +'¬newsisg¬ : ¬'+%trim(NEWSISG)+'¬, '
        +'¬mode¬ : ¬'+%trim(WMODE)+'¬, '
        +'¬s3039ex1¬ : ¬'+%trim(WS3039EX1)+'¬, '
        +'¬s3039ex2¬ : ¬'+%trim(WS3039EX2)+'¬, '
        +'¬s3039ex3¬ : ¬'+%trim(WS3039EX3)+'¬, '
        +'¬errMsg¬ : ¬'+%trim(Error)+'¬, '
        +'¬s0035¬ : ¬'+%trim(YS0035)+'¬, ';
      /end-free
      * JSONfix escaper " i tekst,  for deretter å bytte ¬->"
     c                   call      'JSONFIX'
     c                   parm                    JSONstring
     C                   callp     updHTMLvar('JSONstring':JSONstring)
     C                   callp     wrtsection('JSONlin')
      *
      * ............................................................................................
      * Skriv JSON-LISTE Start (en liste er EN parameter(fra [ til   )
      * ............................................................................................
     c                   eval      JSONstring ='"orderupdate" : ['
     C                   callp     updHTMLvar('JSONstring':JSONstring)
     C                   callp     wrtsection('JSONlin')
      * ............................................................................................
      * Skriv JSON-Liste/Array  Avslutning
      * ............................................................................................
     c                   eval      JSONstring =']'
     C                   callp     updHTMLvar('JSONstring':JSONstring)
     C                   callp     wrtsection('JSONlin')
      * ............................................................................................
      * Skriv JSON-string Avsluttning
      * ............................................................................................
     c                   eval      JSONstring ='}'
     C                   callp     updHTMLvar('JSONstring':JSONstring)
     C                   callp     wrtsection('JSONlin')
      *
      * Quit
     C                   exsr      Exit


      *=====================================================================
      * Close output html and quit
      *=====================================================================
     C     Exit          begsr
      * Lukk fil
     C                   CLOSE     BRIDF
     C  N50              CLOSE     SADH
     C  N50              CLOSE     SADH1
     C  N50              CLOSE     SADHIN
     C  N50              CLOSE     SADHOM
     C  N50              CLOSE     SADV
     C  N50              CLOSE     STANDI
     C  N50              CLOSE     KODTSI
     C  N50              CLOSE     KODTSI1
     C  N50              CLOSE     HEADF
     C  N50              CLOSE     CUNDL01
     C  N50              CLOSE     FIRM
     C  N50              CLOSE     EDIC
     C  N50              CLOSE     EDIM1
     C  N50              CLOSE     EDIM2
     C  N50              CLOSE     EDIM4
     C  N50              CLOSE     FRISOK
     C  N50              CLOSE     FRISOL01
     C  N50              CLOSE     TVIND
     C  N50              CLOSE     KODTA
     C  N50              CLOSE     KODTLB
     C  N50              CLOSE     KODTVAL2

      * Do not delete the call to wrtsection with section name *fini.  It is needed
      * to ensure that all output html that has been buffered gets output.
     C                   callp     wrtsection('*fini')
      * Quit
     C                   MOVE      *ON           *INLR
     C                   return
     C                   endsr
      *
      *********************************************************
     C     Parse         Begsr
      *********************************************************
      * Get input
     C                   EVAL      WSUSER  = zhbgetvar('USER')
     C                   EVAL      SIAVDA = zhbgetvar('AVD')
     C                   EVAL      SIAVD  = c2n2(SIAVDA)
     C                   EVAL      NEWSYAVA = zhbgetvar('NEWAVD')
     C                   EVAL      NEWAVD  = c2n2(NEWSYAVA)
     C                   EVAL      SITDNA = zhbgetvar('OPD')
     C                   EVAL      SITDN  = c2n2(SITDNA)
     C                   EVAL      WMODE  = zhbgetvar('MODE')
     C                   EVAL      WSISG  = zhbgetvar('SISG')
     C                   EVAL      NEWSISG      = zhbgetvar('NEWSISG')
     C                   EVAL      XREF       = zhbgetvar('H_XREF')
     C                   EVAL      SIST  = zhbgetvar('SIST')
     C                   EVAL      SIUR   =zhbgetvar('SIUR')
     C                   EVAL      SIDTY  =zhbgetvar('SIDTY')
     C                   EVAL      WA     =zhbgetvar('SIDP')
     C                   EVAL      SIDP   =c2n2(WA)
N01  C                   EVAL      WA     = zhbgetvar('SIDP2')
N01  C                   EVAL      SIDP2  = c2n2(WA)
     C                   EVAL      WA     =zhbgetvar('SIKNS')
     C                   EVAL      SIKNS  =c2n2(WA)
     C                   EVAL      SINAS  =zhbgetvar('SINAS')
     C                   EVAL      SIADS1 =zhbgetvar('SIADS1')
     C                   EVAL      SIADS2 =zhbgetvar('SIADS2')
     C                   EVAL      SIADS3 =zhbgetvar('SIADS3')
     C                   EVAL      WA     =zhbgetvar('SINTK')
     C                   EVAL      SINTK  =c2n2(WA)
     C                   EVAL      SISKI  =zhbgetvar('SISKI')
     C                   EVAL      SIKDDK =zhbgetvar('SIKDDK')
     C                   EVAL      WA     =zhbgetvar('SIVKB')
     C                   EVAL      SIVKB  =c2n2(WA)
     C                   EVAL      SIKDC  =zhbgetvar('SIKDC')
     C                   EVAL      WA     =zhbgetvar('SIKNK')
     C                   EVAL      SIKNK  =c2n2(WA)
     C                   EVAL      SIRG   =zhbgetvar('SIRG')
     C                   EVAL      SIMVA  =zhbgetvar('SIMVA')
     C                   EVAL      SINAK  =zhbgetvar('SINAK')
     C                   EVAL      SIADK1 =zhbgetvar('SIADK1')
     C                   EVAL      SIADK2 =zhbgetvar('SIADK2')
     C                   EVAL      SIADK3 =zhbgetvar('SIADK3')
     C                   EVAL      SIVAL1 =zhbgetvar('SIVAL1')
     C                   EVAL      WA     =zhbgetvar('SIBEL1')
     C                   EVAL      SIBEL1 =c2n2(WA)
     C                   EVAL      SIVAL2 =zhbgetvar('SIVAL2')
     C                   EVAL      WA     =zhbgetvar('SIBEL2')
     C                   EVAL      SIBEL2 =c2n2(WA)
     C                   EVAL      SIFTG2 =zhbgetvar('SIFTG2')
     C                   EVAL      SILKA  =zhbgetvar('SILKA')
     C                   EVAL      SITLF  =zhbgetvar('SITLF')
     C                   EVAL      SINAD  =zhbgetvar('SINAD')
     C                   EVAL      SILV   =zhbgetvar('SILV')
     C                   EVAL      SILVT  =zhbgetvar('SILVT')
     C                   EVAL      SITRID =zhbgetvar('SITRID')
     C                   EVAL      SILKT  =zhbgetvar('SILKT')
     C                   EVAL      SIVAL3 =zhbgetvar('SIVAL3')
     C                   EVAL      WA     =zhbgetvar('SIBEL3')
     C                   EVAL      SIBEL3 =c2n2(WA)
     C                   EVAL      WA     =zhbgetvar('SIVKU')
     C                   EVAL      SIVKU  =c2n2(WA)
     C                   EVAL      WA     =zhbgetvar('SITST')
     C                   EVAL      SITST  =c2n2(WA)
     C                   EVAL      WA     =zhbgetvar('SITRT')
     C                   EVAL      SITRT  =c2n2(WA)
     C                   EVAL      WA     =zhbgetvar('SITRM')
     C                   EVAL      SITRM  =c2n2(WA)
     C                   EVAL      SIFIF  =zhbgetvar('SIFIF')
     C                   EVAL      WA     =zhbgetvar('SIFID')
     C                   EVAL      SIFID  =c2n2(WA)
     C                   EVAL      WA     =zhbgetvar('SIBELT')
     C                   EVAL      SIBELT =c2n2(WA)
     C                   EVAL      SI07   =zhbgetvar('SI07')
     C                   EVAL      WA     =zhbgetvar('SIKTA')
     C                   EVAL      SIKTA  =c2n2(WA)
     C                   EVAL      WA     =zhbgetvar('SIKTB')
     C                   EVAL      SIKTB  =c2n2(WA)
     C                   EVAL      SIGN   =zhbgetvar('SIGN')
     C                   EVAL      SIFT1  =zhbgetvar('SIFT1')
     C                   EVAL      SIFT2  =zhbgetvar('SIFT2')
     C                   EVAL      SIFT3  =zhbgetvar('SIFT3')
     C                   EVAL      SIFT4  =zhbgetvar('SIFT4')
     C                   EVAL      SIDST  =zhbgetvar('SIDST')
     C                   EVAL      WA     =zhbgetvar('SIBEL4')
     C                   EVAL      SIBEL4 =c2n2(WA)
     C                   EVAL      SIDTG  =zhbgetvar('SIDTG')
     C                   EVAL      SITLL  =zhbgetvar('SITLL')
     C                   EVAL      SITLE  =zhbgetvar('SITLE')
     C                   EVAL      SILS   =zhbgetvar('SILS')
     C                   EVAL      SIKDLS =zhbgetvar('SIKDLS')
N01  C*                  EVAL      WA     =zhbgetvar('SIKDH')
N01  C*                  EVAL      SIKDH  =c2n2(WA)
     C*                  EVAL      SIKDTR =zhbgetvar('SIKDTR')
     C*                  EVAL      WA     =zhbgetvar('SIAS')
     C*                  EVAL      SIAS   =c2n2(WA)
     C                   EVAL      WA     =zhbgetvar('SIDT')
     C                   EVAL      SIDT   =c2n2(WA)
     C                   EVAL      WA     =zhbgetvar('SIBEL5')
     C                   EVAL      SIBEL5 =c2n2(WA)
     C                   EVAL      WA     =zhbgetvar('SIBEL6')
     C                   EVAL      SIBEL6 =c2n2(WA)
     C                   EVAL      WA     =zhbgetvar('SIBEL7')
     C                   EVAL      SIBEL7 =c2n2(WA)
     C                   EVAL      WA     =zhbgetvar('SIBEL8')
     C                   EVAL      SIBEL8 =c2n2(WA)
     C                   EVAL      WA     =zhbgetvar('SIBEL9')
     C                   EVAL      SIBEL9 =c2n2(WA)
     C                   EVAL      WA     =zhbgetvar('SIBELA')
     C                   EVAL      SIBELA =c2n2(WA)
     C                   EVAL      SILV2  =zhbgetvar('SILV2')
     C                   EVAL      SIPOS  =zhbgetvar('SIPOS')
     C                   EVAL      SITARF =zhbgetvar('SITARF')
     C                   EVAL      SIVALB =zhbgetvar('SIVALB')
     C                   EVAL      WA     =zhbgetvar('SIBELB')
     C                   EVAL      SIBELB =c2n2(WA)
     C                   EVAL      SIMID  =zhbgetvar('SIMID')
     C                   EVAL      SIMIDK =zhbgetvar('SIMIDK')
     C                   EVAL      SIMF   =zhbgetvar('SIMF')
     C                   EVAL      WA     =zhbgetvar('SIMP')
     C                   EVAL      SIMP   =c2n2(WA)
     C                   EVAL      WA     =zhbgetvar('SIDTO')
     C                   EVAL      SIDTØ  =c2n2(WA)
     C                   EVAL      SIMI   =zhbgetvar('SIMI')
     C                   EVAL      WA     =zhbgetvar('SIBELD')
     C                   EVAL      SIBELD =c2n2(WA)
     C                   EVAL      SIPKL  =zhbgetvar('SIPKL')
     C                   EVAL      SIKDV  =zhbgetvar('SIKDV')
     C                   EVAL      SI0035 =zhbgetvar('SI0035')
     C                   EVAL      WA     =zhbgetvar('SIRAB')
     C                   EVAL      SIRAB  =c2n2(WA)
     C                   EVAL      WA     =zhbgetvar('SIOPD')
     C                   EVAL      SIOPD  =c2n2(WA)
     C                   EVAL      WA     =zhbgetvar('SIFRBN')
     C                   EVAL      SIFRBN =c2n2(WA)
     C                   EVAL      SIWS   =zhbgetvar('SIWS')
     C                   EVAL      SIKTC  =zhbgetvar('SIKTC')
     C                   EVAL      SIVALR =zhbgetvar('SIVALR')
     C                   EVAL      WA     =zhbgetvar('SIBELR')
     C                   EVAL      SIBELR =c2n2(WA)
     C                   EVAL      WA     =zhbgetvar('SIBELS')
     C                   EVAL      SIBELS =c2n2(WA)
     C                   EVAL      INSIVF =zhbgetvar('INSIVF')
     C                   EVAL      WA     =zhbgetvar('INSIBVNV')
     C                   EVAL      INSIBVNV =c2n2(WA)
     C                   EVAL      SITYPE = zhbgetvar('OM_SITYPE')
     C                   EVAL      SIFT01 = zhbgetvar('OM_SIFT01')
     C                   EVAL      SIFT02 = zhbgetvar('OM_SIFT02')
     C                   EVAL      SIFT03 = zhbgetvar('OM_SIFT03')
     C                   EVAL      SIFT04 = zhbgetvar('OM_SIFT04')
     C                   EVAL      SIFT05 = zhbgetvar('OM_SIFT05')
     C                   EVAL      WM1N07 = zhbgetvar('M1N07')
     C                   EVAL      WA     =zhbgetvar('M3039E')
     C                   EVAL      WM3039E=c2n2(WA)
     C                   EVAL      WA     =zhbgetvar('M2005B')
     C                   EVAL      WM2005B=c2n2(WA)
     C                   EVAL      WA     =zhbgetvar('M5004D')
     C                   EVAL      WM5004D=c2n2(WA)
     C                   EVAL      WMVEN  = zhbgetvar('MVEN')
     C                   EVAL      WM0035 = zhbgetvar('M0035')
     C                   EVAL      WA     =zhbgetvar('M9N01')
     C                   EVAL      WM9N01 =c2n2(WA)
     C                   EVAL      WURL1  = zhbgetvar('URL1')
     C                   EVAL      WURL2  = zhbgetvar('URL2')
     C                   EVAL      WURL3  = zhbgetvar('URL3')
     C                   EVAL      WURL4  = zhbgetvar('URL4')
     C                   EVAL      WURL5  = zhbgetvar('URL5')
     C                   EVAL      WURL6  = zhbgetvar('URL6')
     C                   EVAL      WURL7  = zhbgetvar('URL7')
     C                   EVAL      WURL8  = zhbgetvar('URL8')
     C                   EVAL      WURL9  = zhbgetvar('URL9')
     C                   EVAL      WOPDKNUM  = zhbgetvar('OPDKNUM')
     C                   EVAL      DETA = zhbgetvar('DETA')
     C                   ENDSR
      *********************************************************
     C     INIT          Begsr
      *********************************************************
     C                   OPEN      BRIDF
      * Test innlogging
     C     WSUSER        CHAIN     BRIDF                              50
     C     BILIBL        ifeq      *blanks
     C                   callb     'INCGI'
     C                   parm                    BISTDL
     C                   else
     C                   call      BILIBL
     C                   end
      *
     C     SADHKey       klist
     C                   kfld                    SIAVD
     C                   kfld                    SITDN
     C     CUNDL01K      KLIST
     C                   KFLD                    FIFIRM
     C                   KFLD                    KUNDNR
     C     CUNDL01K2     KLIST
     C                   KFLD                    FIFIRM
     C                   KFLD                    SIKNK
     C     FRIKEY        klist
     C                   kfld                    SIAVD
     C                   kfld                    SITDN
     C                   KFLD                    WFSKODE           3
     C     FRIKEY01      KLIST
     C                   KFLD                    WFSKODE
     C                   KFLD                    XREF
     C     KODTSIKEY     KLIST
     C                   KFLD                    WKSIUNI
     C                   KFLD                    XSISG
     C     MAKDCK        KLIST
     C                   KFLD                    XSR1
     C                   KFLD                    SIAVD
     C                   KFLD                    SITDN
     C                   KFLD                    MAX0B
     C                   KFLD                    MAX0C
     C                   KFLD                    MAX0D
     C     MAKD2K        KLIST
     C                   KFLD                    XSR1
     C                   KFLD                    SIAVD
     C                   KFLD                    SITDN
     C     M2KDCK        KLIST
     C                   KFLD                    SIAVD
     C                   KFLD                    SITDN
     C                   KFLD                    MAX0B
     C                   KFLD                    MAX0C
     C                   KFLD                    MAX0D
     C     M2KD2K        KLIST
     C                   KFLD                    SIAVD
     C                   KFLD                    SITDN
     C     TVIM1K        KLIST
     C                   KFLD                    X1STA
     C                   KFLD                    SIAVD
     C                   KFLD                    SITDN
     C     KODTAK        KLIST
     C                   KFLD                    KOAUNI
     C                   KFLD                    SIAVD
     C     KODTLBK       KLIST
     C                   KFLD                    KLBUNI
     C                   KFLD                    XSILV
     C     KODTVAK       KLIST
     C                   KFLD                    WKVAKOD           3
     C                   KFLD                    XDATO
     C                   MOVE      'A'           KOAUNI
     C                   MOVE      'LB'          KLBUNI
     C                   EVAL      WFSKODE='*CR'
     C     *LIKE         DEFINE    KSIUNI        WKSIUNI
     C     *LIKE         DEFINE    MSR           XSR1
     C     *LIKE         DEFINE    M0068A        MAX0B
     C     *LIKE         DEFINE    M0068B        MAX0C
     C     *LIKE         DEFINE    M0068C        MAX0D
     C     *LIKE         DEFINE    MST           X1STA
     C                   EVAL      WKSIUNI='SI'
     C                   MOVE      'R'           XSR1
     C                   MOVE      '99999999'    MAX0B
     C                   MOVE      '999999'      MAX0C
     C                   MOVE      '99'          MAX0D
      *
     C   50              eval      Error = 'Invalid userID'
     C  N50              OPEN      SADH
     C  N50              OPEN      SADH1
     C  N50              OPEN      SADHIN
     C  N50              OPEN      SADHOM
     C  N50              OPEN      SADV
     C  N50              OPEN      STANDI
     C  N50              OPEN      KODTSI
     C  N50              OPEN      KODTSI1
     C  N50              OPEN      HEADF
     C  N50              OPEN      CUNDL01
     C  N50              OPEN      FIRM
     C  N50              OPEN      EDIC
     C  N50              OPEN      EDIM1
     C  N50              OPEN      EDIM2
     C  N50              OPEN      EDIM4
     C  N50              OPEN      FRISOK
     C  N50              OPEN      FRISOL01
     C  N50              OPEN      TVIND
     C  N50              OPEN      KODTA
     C  N50              OPEN      KODTVAL2
     C  N50              OPEN      KODTLB
      *_________________________________
      * Hæmta dagens datum och klockslag
      *"""""""""""""""""""""""""""""""""
     C                   IF        *IN50=*OFF
     C                   CALL      'SYGE15C'
     C                   PARM                    WDT               8
     C                   PARM                    WTM               6
     C                   MOVEL     WDT           XDATO             8 0
      * Hæmta firmaopplysninger
     C                   READ      FIRM
      * DUMMY READ AV SADH1
     C     *IN50         IFEQ      *OFF
     C     *IN50         ANDEQ     *ON
     C                   READ      SADH1
     C                   ENDIF
      * MODE=GS
     C     WMODE         IFEQ      'GS'
     C     XREF          ANDNE     *BLANKS
     C     *IN50         ANDEQ     *OFF
     C     FRIKEY01      CHAIN     FRISOL01                           56
     C                   IF        *IN56=*OFF
     C                   EVAL      SIAVD=FSAVD
     C                   EVAL      SITDN=FSOPD
     C                   ENDIF
     C                   ENDIF
     C                   ENDIF

     c                   endsr
      *
      *______________________________________________________
      * TEST                                             TEST
      *""""""""""""""""""""""""""""""""""""""""""""""""""""""
     C     TEST          BEGSR
      * Hæmta userid
     C     WSUSER        CHAIN     KODTSI1
      * Hæmta ærende
     C     WMODE         IFNE      'A'
     C     SADHKey       CHAIN     SADH                               55
     C                   ENDIF
      * MODE A=Add  D=Delete  U=Update  S=Skicka  C=Copy  GS=Hæmta från SYSPED
     C                   SELECT
     C     WMODE         WHENEQ    'A'
     C                   eval      Error = *blanks
     C                   EXSR      SRA
     C     WMODE         WHENEQ    'GS'
     C                   eval      Error = *blanks
     C  N55              eval      Error = 'Fel, finns redan'
     C   55              EXSR      SRGS
     C     WMODE         WHENEQ    'C'
     C                   IF        *IN55=*ON
     C                   eval      Error = 'Order not found'
     C                   ELSE
     C                   UPDATE    SADHR
     C                   eval      Error = *blanks
     C                   EXSR      SRC
     C                   ENDIF
     C     WMODE         WHENEQ    'D'
     C                   IF        *IN55=*ON
     C                   eval      Error = 'Order not found'
     C                   ELSE
     C                   eval      Error = *blanks
     C                   EXSR      SRD
     C                   ENDIF
     C     WMODE         WHENEQ    'S'
     C                   IF        *IN55=*ON
     C                   eval      Error = 'Order not found'
     C                   ELSE
     C                   eval      Error = *blanks
     C                   EXSR      SRS
     C                   ENDIF
     C     WMODE         WHENEQ    'U'
     C                   IF        *IN55=*ON
     C                   eval      Error = 'Order not found'
     C                   ELSE
     C                   eval      Error = *blanks
     C                   EXSR      SRU
     C                   ENDIF
     C                   OTHER
     C                   eval      Error = 'Wrong mode'
     C                   ENDSL
     C                   ENDSR
      *______________________________________________________
      * Add                                               SRA
      *""""""""""""""""""""""""""""""""""""""""""""""""""""""
     C     SRA           BEGSR
     C                   CLEAR                   SADHR
     C                   CLEAR                   SADHINR
      * Hæmta uppdragsnummer
     C     SIAVD         CHAIN     STANDI                             52
     C                   EVAL      XSITDN=YSITDN
     C                   ADD       1             YSITDN
     C                   UPDATE    STANDIR
     C                   EVAL      XSIAVD=SIAVD
     C                   EVAL      SITDN=XSITDN
     C                   EVAL      XSISG=WSISG
     C                   EVAL      XSI0035=YS0035
     C                   MOVEL     WDT           XSIDT
     C                   EVAL      XINSIAVD=SIAVD
     C                   EVAL      XINSITDN=SITDN
     C                   EVAL      XINSIVF='1'
     C                   EVAL      XINSIBVNV=0.9
     C                   EVAL      SIBELC=*ZEROS
     C                   EVAL      SIRAB=*ZEROS
     C                   EVAL      XSI27=SI27
      * Write
     C                   WRITE     SADHR
     C                   WRITE     SADHINR
     C                   ENDSR
      *______________________________________________________
      * Delete                                            SRD
      *""""""""""""""""""""""""""""""""""""""""""""""""""""""
     C     SRD           BEGSR
     C                   EVAL      XSIST='S '
     C                   UPDATE    SADHR
     C                   ENDSR
      *______________________________________________________
      * Skicka                                            SRS
      *""""""""""""""""""""""""""""""""""""""""""""""""""""""
     C     SRS           BEGSR
     C                   eval      Error = *blanks
      * Ændra status
     C                   EVAL      XSIST='A'
     C                   UPDATE    SADHR
      * Hent avdelingsopplysninger
     C     KODTAK        CHAIN     KODTA
      * Hent foretaksnummer
     C                   MOVE      KOAKNR        KUNDNR
     C     CUNDL01K      CHAIN(N)  CUNDL01                            35
     C   35              EVAL      SYFORE=*BLANKS
      * Skriv til EDIM
     C     SIAVD         CHAIN     STANDI
     C                   EXSR      KOMLIN
     C                   ENDSR
      *______________________________________________________
      * Update                                            SRU
      *""""""""""""""""""""""""""""""""""""""""""""""""""""""
     C     SRU           BEGSR
     C                   EXSR      CIFSR
     C                   EVAL      XSISG   = WSISG
     C                   EVAL      XSIST   = SIST
     C                   EVAL      XSIUR   = SIUR
     C                   EVAL      XSIDTY  = SIDTY
     C                   EVAL      XSIDP   = SIDP
N01  C                   EVAL      XSIDP2  = SIDP2
     C                   EVAL      XSIKNS  = SIKNS
     C                   EVAL      XSINAS  = SINAS
     C                   EVAL      XSIADS1 = SIADS1
     C                   EVAL      XSIADS2 = SIADS2
     C                   EVAL      XSIADS3 = SIADS3
     C                   EVAL      XSINTK  = SINTK
     C                   EVAL      XSISKI  = SISKI
     C                   EVAL      XSIKDDK = SIKDDK
     C                   EVAL      XSIVKB  = SIVKB
     C                   EVAL      XSIKDC  = SIKDC
     C                   EVAL      XSIKNK  = SIKNK
     C                   EVAL      XSIRG   = SIRG
     C                   EVAL      XSIMVA  = SIMVA
     C                   EVAL      XSINAK  = SINAK
     C                   EVAL      XSIADK1 = SIADK1
     C                   EVAL      XSIADK2 = SIADK2
     C                   EVAL      XSIADK3 = SIADK3
     C                   EVAL      XSIVAL1 = SIVAL1
     C                   EVAL      XSIBEL1 = SIBEL1
     C                   EVAL      XSIVAL2 = SIVAL2
     C                   EVAL      XSIBEL2 = SIBEL2
     C                   EVAL      XSIFTG2 = SIFTG2
     C                   EVAL      XSILKA  = SILKA
     C                   EVAL      XSITLF  = SITLF
     C                   EVAL      XSINAD  = SINAD
     C                   EVAL      XSILV   = SILV
     C                   EVAL      XSILVT  = SILVT
     C                   EVAL      XSITRID = SITRID
     C                   EVAL      XSILKT  = SILKT
     C                   EVAL      XSIVAL3 = SIVAL3
     C                   EVAL      XSIBEL3 = SIBEL3
     C                   EVAL      XSIVKU  = SIVKU
     C                   EVAL      XSITST  = SITST
     C                   EVAL      XSITRT  = SITRT
     C                   EVAL      XSITRM  = SITRM
     C                   EVAL      XSIFIF  = SIFIF
     C                   EVAL      XSIFID  = SIFID
     C                   EVAL      XSIBELT = SIBELT
     C                   EVAL      XSI07   = SI07
     C                   EVAL      XSIKTA  = SIKTA
     C                   EVAL      XSIKTB  = SIKTB
     C                   EVAL      XSIGN   = SIGN
     C                   EVAL      XSIFT1  = SIFT1
     C                   EVAL      XSIFT2  = SIFT2
     C                   EVAL      XSIFT3  = SIFT3
     C                   EVAL      XSIFT4  = SIFT4
     C                   EVAL      XSIDST  = SIDST
     C                   EVAL      XSIBEL4 = SIBEL4
     C                   EVAL      XSIDTG  = SIDTG
     C                   EVAL      XSITLL  = SITLL
     C                   EVAL      XSITLE  = SITLE
     C                   EVAL      XSILS   = SILS
     C                   EVAL      XSIKDLS = SIKDLS
N01  C*                  EVAL      XSIKDH  = SIKDH
     C*                  EVAL      XSIKDTR = SIKDTR
     C*                  EVAL      XSIAS   = SIAS
     C*                  EVAL      XSIDT   = SIDT
     C                   EVAL      XSIBEL5 = SIBEL5
     C                   EVAL      XSIBEL6 = SIBEL6
     C                   EVAL      XSIBEL7 = SIBEL7
     C                   EVAL      XSIBEL8 = SIBEL8
     C                   EVAL      XSIBEL9 = SIBEL9
     C                   EVAL      XSIBELA = SIBELA
     C                   EVAL      XSILV2  = SILV2
     C                   IF        XSILV2=*BLANKS
     C                   EVAL      XSILV2  = XSILV
     C                   ENDIF
     C                   EVAL      XSIPOS  = SIPOS
     C                   EVAL      XSITARF = SITARF
     C*                  IF        XSITARF = *BLANKS
     C     KODTSIKEY     CHAIN     KODTSI                             56
     C  N56              EVAL      XSITARF = KSINAV
     C*                  ENDIF
     C                   EVAL      XSIVALB = SIVALB
     C                   EVAL      XSIBELB = SIBELB
     C                   EVAL      XSIMID  = SIMID
     C                   EVAL      XSIMIDK = SIMIDK
     C                   EVAL      XSIMF   = SIMF
     C                   EVAL      XSIMP   = SIMP
     C*                  EVAL      XSIDTØ  = SIDTØ
     C                   EVAL      XSIMI   = SIMI
     C                   EVAL      XSIBELD = SIBELD
     C                   EVAL      XSIPKL  = SIPKL
     C                   EVAL      XSIKDV  = SIKDV
     C                   EVAL      XSI0035 = SI0035
     C                   EVAL      SIBELC=*ZEROS
     C                   EVAL      SIRAB=*ZEROS
     C                   EVAL      XSI27   = SI27
     C                   EVAL      XSIOPD  = SIOPD
     C                   EVAL      XSIFRBN = SIFRBN
     C                   EVAL      XSIWS   = SIWS
     C                   EVAL      XSIKTC  = SIKTC
     C                   EVAL      XSIVALR = SIVALR
     C                   EVAL      XSIBELR = SIBELR
     C                   EVAL      XSIBELS = SIBELS
     C                   UPDATE    SADHR
      * Oppdater arbetsfil
     C     SADHKey       CHAIN     SADHIN                             56
     C                   IF        *IN56
     C                   EVAL      XINSIAVD=SIAVD
     C                   EVAL      XINSITDN=SITDN
     C                   EVAL      XINSIVF=INSIVF
     C                   EVAL      XINSIBVNV=INSIBVNV
     C                   WRITE     SADHINR
     C                   ELSE
     C                   EVAL      XINSIVF=INSIVF
     C                   EVAL      XINSIBVNV=INSIBVNV
     C                   UPDATE    SADHINR
     C                   ENDIF
      * Oppdater omberegningsvariabler
     C
     C                   IF        SITDN < 0
     C     SADHKey       CHAIN     SADHOM                             56
     C                   IF        *IN56
     C                   EVAL      OM_SIAVD=SIAVD
     C                   EVAL      OM_SITDN=SITDN
     C                   EVAL      OM_SITYPE=SITYPE
     C                   EVAL      OM_SIFT01=SIFT01
     C                   EVAL      OM_SIFT02=SIFT02
     C                   EVAL      OM_SIFT03=SIFT03
     C                   EVAL      OM_SIFT04=SIFT04
     C                   EVAL      OM_SIFT05=SIFT05
     C                   WRITE     SADHROM
     C                   ELSE
     C                   EVAL      OM_SITYPE=SITYPE
     C                   EVAL      OM_SIFT01=SIFT01
     C                   EVAL      OM_SIFT02=SIFT02
     C                   EVAL      OM_SIFT03=SIFT03
     C                   EVAL      OM_SIFT04=SIFT04
     C                   EVAL      OM_SIFT05=SIFT05
     C                   UPDATE    SADHROM
     C                   ENDIF
     C                   ENDIF
      * Legg ut frie søkeveier
     C                   EVAL      WFSKODE='*CR'
     C     FRIKEY        DELETE    FRISOK                             56
     C     XREF          IFNE      *BLANKS
     C                   CLEAR                   FRISOKR
     C                   EVAL      FSAVD=SIAVD
     C                   EVAL      FSOPD=SITDN
     C                   EVAL      FSKODE='*CR'
     C                   EVAL      FSSOK=XREF
     C                   MOVE      WDT           FSDTOP
     C                   WRITE     FRISOKR
     C                   ENDIF
      * Legg ut frie søkeveier
     C                   EVAL      WFSKODE='*DF'
     C     FRIKEY        DELETE    FRISOK                             56
     C     DETA          IFNE      *BLANKS
     C                   CLEAR                   FRISOKR
     C                   EVAL      FSAVD=SIAVD
     C                   EVAL      FSOPD=SITDN
     C                   EVAL      FSKODE='*DF'
     C                   MOVEL     DETA          FSSOK
     C                   MOVE      WDT           FSDTOP
     C                   WRITE     FRISOKR
     C                   ENDIF
      * Oppdater kunderegister med kontonummer hos tollkasserer + Regnr
     C                   IF        SIKNK > *ZEROS and WOPDKNUM <> *BLANKS
     C     CUNDL01K2     CHAIN     CUNDL01
     C                   IF        %FOUND(CUNDL01)
     C                   IF        XSIRG <> *BLANKS
     C                   MOVEL     XSIRG         SYFORE
     C                   ENDIF
     C                   IF        XSIKTB > *ZEROS
     C                   MOVEL     XSIKTA        SYKONT
     C                   MOVE      XSIKTB        SYKONT
     C                   MOVE      XSIKTC        SYFR02
     C                   ENDIF
     C                   UPDATE    KUNDR
     C                   ENDIF
     C                   ENDIF
     C                   ENDSR
      *______________________________________________________
      * Copy                                              SRC
      *""""""""""""""""""""""""""""""""""""""""""""""""""""""
     C     SRC           BEGSR
     C                   EVAL      WSISG=SISG
      * Hæmta uppdragsnummer
     C     NEWAVD        CHAIN     STANDI                             52
     C                   EVAL      XSITDN=YSITDN
     C                   ADD       1             YSITDN
     C                   UPDATE    STANDIR
     C                   EVAL      XSIAVD=NEWAVD
     C                   EVAL      NEWOPD=XSITDN
     C                   EVAL      XSISG=NEWSISG
     C                   MOVEL     WDT           XSIDT
     C                   EVAL      XSIST=*BLANKS
     C                   EVAL      XSI0035=YS0035
     C                   EVAL      XSIDTG=*BLANKS
     C                   EVAL      XSITLL=*BLANKS
     C                   EVAL      XSITLE=*BLANKS
     C                   EVAL      XSIFIF=*BLANKS
      * Write
     C                   WRITE     SADHR
      * Oppdater arbetsfil
     C                   EVAL      XINSIAVD=NEWAVD
     C                   EVAL      XINSITDN=YSITDN
     C                   EVAL      XINSIVF='1'
     C                   EVAL      XINSIBVNV=0.9
     C                   WRITE     SADHINR
      * Kopiera också varuposter
     C                   EVAL      *IN52=*OFF
     C     SADHKey       SETLL     SADV
     C     SADHKey       READE     SADV                                   52
     C     *IN52         DOWEQ     *OFF

     C                   EVAL      SVAVD=NEWAVD
     C                   EVAL      SVTDN=NEWOPD
     C                   WRITE     SADVR

     C     SADHKey       READE     SADV                                   52
     C                   ENDDO
     C                   ENDSR
      *______________________________________________________
      * Hæmta från SAD Export, SYSPED op, eller DKI      SRGS
      *""""""""""""""""""""""""""""""""""""""""""""""""""""""
     C     SRGS          BEGSR
     C                   CLEAR                   SADHR
     C                   CLEAR                   SADHINR
      * Finnes SYSPED Oppdrag ?
     C     SADHKey       CHAIN     HEADF                              54
      * Fel, finns inte i sysped uppdrag
     C                   IF        *IN54
     C                   eval      Error = 'Order not found'
     C                   GOTO      SRGS9
     C                   ENDIF
      * Skapa gemensam information
     C     SIAVD         CHAIN(N)  STANDI                             52
     C                   IF        *IN52=*OFF
     C                   EVAL      Xsidty  = Ysidty
     C                   EVAL      Xsidp   = Ysidp
N01  C                   EVAL      Xsidp2  = Ysidp2
     C                   EVAL      Xsiski  = Ysiski
     C                   EVAL      Xsikddk = Ysikddk
     C                   EVAL      Xsikdc  = Ysikdc
     C                   EVAL      Xsival1 = Ysival1
     C                   EVAL      Xsival2 = Ysival2
     C                   EVAL      Xsiftg2 = Ysiftg2
     C                   EVAL      Xsilka  = Ysilka
     C                   EVAL      Xsitlf  = Ysitlf
     C                   EVAL      Xsinad  = Ysinad
     C                   EVAL      Xsilvt  = Ysilvt
     C                   EVAL      Xsival3 = Ysival3
     C                   EVAL      Xsitst  = Ysitst
     C                   EVAL      Xsitrt  = Ysitrt
     C                   EVAL      Xsign   = Ysign
     C                   EVAL      Xsift1  = Ysift1
     C                   EVAL      Xsift2  = Ysift2
     C                   EVAL      Xsift3  = Ysift3
     C                   EVAL      Xsift4  = Ysift4
     C                   EVAL      Xsidst  = Ysidst
     C                   EVAL      Xsils   = Ysils
     C                   EVAL      Xsikdls = Ysikdls
N01  C*                  EVAL      Xsikdh  = Ysikdh
     C*                  EVAL      XsiKdtr = YsiKdtr
     C                   EVAL      Xsilv2  = Ysilv2
     C                   IF        XSILV2=*BLANKS
     C                   EVAL      Xsilv2  = Ysilv
     C                   ENDIF
     C                   EVAL      Xsitarf = Ysitarf
     C                   EVAL      Xsipkl  = Ysipkl
     C                   EVAL      Xsikdv  = Ysikdv
     C                   EVAL      XsI0035 = Ys0035
     C                   ENDIF
     C                   EVAL      XSIAVD=SIAVD
     C                   EVAL      XSITDN=SITDN
     C                   EVAL      XSISG=WSISG
     C                   MOVEL     WDT           XSIDT
     C                   EVAL      SIBELC=*ZEROS
     C                   EVAL      SIRAB=*ZEROS
     C                   EVAL      XSI27   = SI27

      * Hæmta från SYSPED oppdrag
     C                   EXSR      SRGSO
      * Write
     C                   WRITE     SADHR
      * Oppdater arbetsfil
     C                   EVAL      XINSIAVD=XSIAVD
     C                   EVAL      XINSITDN=XSITDN
     C                   EVAL      XINSIVF='1'
     C                   EVAL      XINSIBVNV=0.9
     C                   WRITE     SADHINR
     C     SRGS9         ENDSR
      *______________________________________________________
      * Hæmta från SYSPED Oppdrag                       SRGSO
      *""""""""""""""""""""""""""""""""""""""""""""""""""""""
     C     SRGSO         BEGSR
     C                   EVAL      XSIKNS=HEKNS
     C                   EVAL      XSINAS=HENAS
     C                   EVAL      XSIADS1=HEADS1
     C                   EVAL      XSIADS2=HEADS2
     C                   EVAL      XSIADS3=HEADS3
      * Spesial kingsrød, hent avs. oppl fra kundereg uansett
     C     XSIKNS        IFNE      0
     C                   MOVE      XSIKNS        KUNDNR
     C     CUNDL01K      CHAIN(N)  CUNDL01                            35
     C                   IF        *IN35=*OFF
     C                   EVAL      XSINAS = KNAVN
     C                   EVAL      XSIADS1 = ADR1
     C                   EVAL      XSIADS2 = ADR2
     C                   IF        POSTNR = 0

     C                   EVAL      XSIADS3 = ADR3

     C                   ELSE
     C                   MOVEL     POSTNR        XSIADS3
     C                   MOVE      ADR3          XSIADS3
     C                   ENDIF
     C                   ENDIF
     C                   ENDIF

     C                   EVAL      XSIKNK=HEKNK
     C                   EVAL      XSINAK=HENAK
     C                   EVAL      XSIADK1=HEADK1
     C                   EVAL      XSIADK2=HEADK2
     C                   EVAL      XSIADK3=HEADK3
     C                   EVAL      XSILKT=HELKA
     C                   EVAL      XSINTK=HENT
     C                   EVAL      XSITRM=30
     C                   EVAL      XSILKT=HETRI
     C                   EVAL      XSIVKB=HEVKT
     C                   MOVEL     HEGN          XSIGN
     C                   EVAL      XSILKA=HELKA
     C                   EVAL      XSIPOS=HEPOS1
     C                   EVAL      XSILV=HEFR
     C     KODTLBK       CHAIN     KODTLB                             40
     C                   IF        *IN40=*OFF
     C                   EVAL      XSILV=KLBKT
     C                   IF        KLBKT <> 'N'
     C                   Z-ADD     HEFBK         XSIBEL1
     C                   ENDIF
     C                   ENDIF
     C                   IF        %SUBST(KLBXXX:1:1)='A'
     C     XSIADS3       IFNE      *BLANKS
     C                   MOVEL     XSIADS3       XSILVT
     C                   ELSE
     C     XSIADS2       IFNE      *BLANKS
     C                   MOVEL     XSIADS3       XSILVT
     C                   ELSE
     C                   MOVEL     XSIADS1       XSILVT
     C                   ENDIF
     C                   ENDIF
     C                   ELSE
     C     XSIADK3       IFNE      *BLANKS
     C                   MOVEL     XSIADK3       XSILVT
     C                   ELSE
     C     XSIADK2       IFNE      *BLANKS
     C                   MOVEL     XSIADK2       XSILVT
     C                   ELSE
     C                   MOVEL     XSIADK1       XSILVT
     C                   ENDIF
     C                   ENDIF
     C                   ENDIF
      * hæmta kundinfo
     C     XSIKNK        IFNE      0
     C                   MOVE      XSIKNK        KUNDNR
     C     CUNDL01K      CHAIN(N)  CUNDL01                            40
     C                   IF        *IN40=*OFF
     C     XSIRG         IFEQ      *BLANKS
     C     SYFORE        IFGT      *ZEROS
     C                   EVAL      XSIRG=*BLANKS
     C                   MOVEL     SYFORE        XSIRG
     C                   ENDIF
     C                   MOVEL     SYKONT        XSIKTA
     C                   MOVE      SYKONT        XSIKTB
     C                   MOVE      SYFR02        XSIKTC
     C                   ENDIF
      * Spesial for Kingrød, hent mott.oppl fra kundereg uansett
     C                   MOVE      KNAVN         XSINAK
     C                   MOVE      ADR1          XSIADK1
     C                   MOVE      ADR2          XSIADK2
     C                   MOVE      *BLANKS       XSIADK3
     C     POSTNR        IFEQ      0
     C                   MOVEL     ADR3          XSIADK3
     C                   ELSE
     C                   MOVEL     POSTNR        XSIADK3
     C                   MOVE      ADR3          XSIADK3
     C                   ENDIF

     C                   ENDIF
     C                   ENDIF
     C                   ENDSR
      *_____________________________________________________
      *                                               KOMLIN
      *"""""""""""""""""""""""""""""""""""""""""""""""""""""
     C     KOMLIN        BEGSR
     C     MAKDCK        SETLL     EDIM4                              31
     C                   MOVE      *ZEROS        Æ0068C            2 0
     C     STKL          TAG
     C     MAKD2K        READPE    EDIM4                                  31
     C  N31M0065         IFNE      'CUSDEC'                                     1<-B
     C     M0065         ANDNE     'CUSRES'
     C                   GOTO      STKL
     C                   END                                                    1<-E
     C  N31MST           IFEQ      'D'                                          1<-B
     C     M1001         OREQ      '830'
     C     M0068C        OREQ      0
     C                   GOTO      STKL
     C                   END                                                    1<-E
     C  N31Æ0068C        IFEQ      0                                            1<-B
     C                   MOVE      M0068C        Æ0068C
     C                   END                                                    1<-E
     C  N31M1N07         IFEQ      'DFI'                                        1<-B
     C     M1N07         OREQ      'DII'
     C     M1N07         OREQ      'DPU'
     C                   GOTO      STKL
     C                   END                                                    1<-E
     C  N31M1N07         IFEQ      'DIU'                                        1<-B
     C                   MOVE      '1'           *IN31
     C                   ELSE                                                   1
     C     Æ0068C        ADD       1             M0068C
     C                   END                                                    1<-E
      * HENT NY DATO/SEKVENS/VERSJON
     C   31              DO
     C                   CALL      'SYGE15C'
     C                   PARM                    WDT               8
     C                   PARM                    WTM               6
     C                   MOVEL     WDT           M0068A
      * HENT SEKVENSNR.
     C     M0068A        CHAIN     TVIND                              32
     C   32              Z-ADD     M0068A        D0068A
     C   32              Z-ADD     0             D0068B
     C                   ADD       1             D0068B
     C   32              WRITE     TVINDF
     C  N32              UPDATE    TVINDF
     C                   MOVE      D0068B        M0068B
      * VERSJONSNR. SETTES LIK 1.
     C                   Z-ADD     1             M0068C
     C                   END

      * HENTE MELDINGSNR
     C     1             CHAIN     EDIC                               32
     C                   ADD       1             CMN
     C                   UPDATE    EDICR

     C                   MOVE      M0068A        X0068A
     C                   MOVE      M0068B        X0068B
     C                   MOVE      M0068C        X0068C

     C     TVIM1K        SETLL     EDIM1                              32
     C     STKL3         TAG
     C     TVIM1K        READE     EDIM1                                  32
     C  N32M0065         IFEQ      'CUSDEC'
     C     M1001         ANDEQ     '929'
     C                   DELETE    EDIMR
     C                   ELSE
     C                   UPDATE    EDIMR
     C                   GOTO      STKL3
     C                   END
     C                   EXSR      MOVKD2

     C                   WRITE     EDIMR
      *
     C                   MOVE      SIAVD         UAVD2             4 0
     C                   MOVE      SITDN         UTDN2             7 0
     C                   CALL      'SAD061V'
     C                   PARM                    UAVD2
     C                   PARM                    UTDN2
      *
     C                   ENDSR
      *______________________________________________
      *                                        MOVKD2
      *""""""""""""""""""""""""""""""""""""""""""""""
     C     MOVKD2        BEGSR
     C                   EVAL      M0004=YS0004
     C                   EVAL      M0010=YS0010
     C                   EVAL      M0035=XSI0035
     C                   IF        XSI0035='2'
     C                   EVAL      M0010='NO000119    '
     C                   ENDIF
     C                   MOVEL     XSIAVD        W0062            11
     C                   IF        XSITDN < 0
     C                   Z-SUB     XSITDN        OM_SITDN
     C                   MOVE      OM_SITDN      W0062
     C                   ELSE
     C                   MOVE      XSITDN        W0062
     C                   ENDIF
     C     W0062         CAT       XSISG:0       M0062
     C                   MOVE      'CUSDEC'      M0065
     C                   MOVE      X0068A        M0068A
     C                   MOVE      X0068B        M0068B
     C                   MOVE      X0068C        M0068C
     C                   MOVE      *BLANKS       M0068
     C                   MOVE      SYFORE        X0068Æ
     C                   MOVEL     XN068Å        M0068
     C                   MOVE      *ZEROS        M0068D
     C                   MOVE      *ZEROS        M0068E
     C                   MOVE      *ZEROS        M0068F
     C                   MOVE      '929'         M1001
     C                   MOVE      *BLANKS       M1004
     C                   EVAL      M1N07=WM1N07
     C                   SELECT
     C     M1N07         WHENEQ    'DFU'
     C                   MOVEL     '9  '         M1225
     C     M1N07         WHENEQ    'DMA'
     C                   MOVEL     'ZZ '         M1225
     C     M1N07         WHENEQ    'DFO'
     C                   MOVEL     '14 '         M1225
     C     M1N07         WHENEQ    'DEN'
     C                   MOVEL     '2  '         M1225
     C     M1N07         WHENEQ    'DKO'
     C                   MOVEL     '18 '         M1225
     C     M1N07         WHENEQ    'DEB'
     C                   MOVEL     '18 '         M1225
     C     M1N07         WHENEQ    'DRE'
     C                   MOVEL     '19 '         M1225
     C     M1N07         WHENEQ    'DSO'
     C                   MOVEL     '43 '         M1225
     C                   ENDSL
     C                   MOVE      YS3039D       M3039D
     C                   MOVE      YS3039E       M3039E
     C                   MOVE      *ZEROS        M5004D
     C                   MOVE      *BLANKS       M1N08
      *SJEKK AT BEHANDLINGSPRIORITET ER INNENFOR INTERVALLET
     C                   MOVE      3             M9N01

     C                   MOVE      *ZEROS        MSN
     C                   Z-ADD     CMN           MMN
     C                   MOVE      'S'           MSR
     C                   MOVE      *BLANKS       MST
     C                   MOVEL     WDT           MDT
     C                   MOVEL     WTM           MTM
     C                   MOVE      XSIAVD        MAVD
     C                   MOVE      XSITDN        MTDN
      * Nå ekstra parm inn.
     C                   MOVE      WM1N07        M1N07
     C                   Z-ADD     WM3039E       M3039E
     C                   Z-ADD     WM2005B       M2005B
     C                   Z-ADD     WM5004D       M5004D
     C                   MOVE      WMVEN         MVEN
     C                   MOVE      WM0035        M0035
     C                   Z-ADD     WM9N01        M9N01
     C
     C                   ENDSR
     C***********************************************
     C     CIFSR         BEGSR
     C***********************************************
     C                   EXSR      GETKUR

     C                   EVAL      SIBEL4=SIBEL3

      * OMREGN FAKTURASUM TIL NORSK KRONE     SIVAL3
      * OG LEGG DETTE PÅ CIFSUM (SIBEL4)
     C     XOMRF         IFNE      0
     C     SIBEL3        MULT      SIVKU         XWORK            16 5
      *   AVRUND CIFSUM
     C     XWORK         DIV(H)    XOMRF         XFAKNO            9 0
     C                   Z-ADD     XFAKNO        SIBEL4
     C                   END
      * OMREGN BEARBEDINGSKOSTNAD TIL NORSK KRONE       SIVALR
     C     XOMRR         IFNE      0
     C     SIBELR        MULT      XKRSR         XWORK
      *   AVRUND CIFSUM
     C     XWORK         DIV(H)    XOMRR         XFAKNO
     C                   Z-ADD     XFAKNO        SIBELS
     C                   END

      * OMREGN FRAKT TIL NORSK KRONE    SIVAL1
      * OG LEGG DETTE PÅ CIFSUM (SIBEL4)
     C     SIBEL1        IFNE      0
     C     SIBEL1        MULT(H)   XKRS1         XKOSTN           15 4
     C     XKOSTN        DIV(H)    XOMR1         XKOSTN
     C                   Z-ADD     XKOSTN        SIBEL8
     C                   ADD(H)    XKOSTN        SIBEL4
     C     SIDP          IFEQ      49
     C                   MULT(H)   0.2           XKOSTN
     C                   END
     C                   ADD(H)    XKOSTN        SIBELS
     C                   END
     C                   MOVE      *ZEROS        XKOSTN

      * OMREGN ANDRE KOSTNAD TIL NORSK KRONE     SIVAL2
      * OG LEGG DETTE PÅ CIFSUM (SIBEL4)
     C     SIBEL2        IFNE      0
     C     SIBEL2        MULT(H)   XKRS2         XKOSTN
     C     XKOSTN        DIV(H)    XOMR2         XKOSTN
     C     SIDP          IFEQ      49
     C                   MULT(H)   0.2           XKOSTN
     C                   END
     C     SIFTG2        IFEQ      '+'
     C     SIFTG2        OREQ      'P'
     C                   ADD(H)    XKOSTN        SIBEL4
     C                   ELSE
     C                   SUB(H)    XKOSTN        SIBEL4
     C                   END
     C                   END
     C                   Z-ADD(H)  XKOSTN        SIBEL9

      * SJEKK OM FORSIKRING SKAL BEREGNES
     C     KLBFOK        IFEQ      'A'
     C     SIBEL4        MULT      KLBPRM        XWORK
     C     XWORK         DIV(H)    1000          SIBELA
     C     SIDP          IFEQ      49
     C                   MULT(H)   0.2           SIBELA
     C                   END
     C                   ELSE
     C                   MOVE      *ZEROS        SIBELA
     C                   END
     C                   ADD       SIBELA        SIBEL4
     C                   ADD       SIBELA        SIBELS

     C     SLCIF         ENDSR
      *________________________________________________
      * Hæmta de olika kurserna                  GETKUR
      *""""""""""""""""""""""""""""""""""""""""""""""""
     C     GETKUR        BEGSR
      * FAKTURASUM
     C                   EVAL      WKVAKOD=SIVAL3
     C                   EXSR      GETKUR2
     C                   Z-ADD     KVAOMR        XOMRF             3 0
     C                   Z-ADD     KVAKRS        SIVKU
      * BEARBEDINGSKOSTNADER
     C                   EVAL      WKVAKOD=SIVALR
     C                   EXSR      GETKUR2
     C                   Z-ADD     KVAOMR        XOMRR             3 0
     C                   Z-ADD     KVAKRS        XKRSR            11 3
      * FRAKT
     C                   EVAL      WKVAKOD=SIVAL1
     C                   EXSR      GETKUR2
     C                   Z-ADD     KVAOMR        XOMR1             3 0
     C                   Z-ADD     KVAKRS        XKRS1            11 3
      * ANDRE KOSTNADADER
     C                   EVAL      WKVAKOD=SIVAL2
     C                   EXSR      GETKUR2
     C                   Z-ADD     KVAOMR        XOMR2             3 0
     C                   Z-ADD     KVAKRS        XKRS2            11 3
     C                   ENDSR
      *________________________________________________
      * Hæmta de olika kurserna                 GETKUR2
      *""""""""""""""""""""""""""""""""""""""""""""""""
     C     GETKUR2       BEGSR
     C     KODTVAK       SETGT     KODTVAL2
     C     WKVAKOD       READPE    KODTVAL2                               56
     C                   IF        *IN56
     C                   CLEAR                   KOVAR
     C                   ENDIF
     C                   ENDSR
