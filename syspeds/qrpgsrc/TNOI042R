      *********************************************************************
      *
CRTPG+*  CRTPGM SYSPED/TNOI042R MODULE(*LIBL/TNOI042R *LIBL/INCGI)
CRTPGM*        ACTGRP(CGI) AUT(*USE)
      *
      *********************************************************************
      /copy SYSPEDS/qrpgsrcpy,hspecs
      /copy SYSPEDS/qrpgsrcpy,hspecsbnd
      *********************************************************************
     FBRIDF     IF   E           K DISK    USROPN
     FSADVARE   IF   E             DISK    USROPN
      *--------------------------------------------------------------------
      * Variables common to all CGIs
      *--------------------------------------------------------------------
      /copy SYSPEDS/qrpgsrcpy,prototypeb
      /copy SYSPEDS/qrpgsrcpy,usec
      /copy SYSPEDS/qrpgsrcpy,variables3
     ‚*  Prototype for 'JSONFIX'
     d jsonfix         pr                  extpgm('JSONFIX')
     d jsonstring_                         like(jsonstring)
     ‚*  Prototype for 'INCGI'
     d incgi           pr                  extproc('INCGI')
     d bistdl_                             like(bistdl)
     ‚*  Prototype for variabel program
     D Varpgm          Pr                  ExtPgm(BILIBL)
      * Varible for
     D WSUSER          S             10
     D JSONstring      s          32000
     D Error           S            150
     D AntLest         S              9  0
     d myrows          s             10i 0
     d  X              S              5  0
     d  WERR           S              1
     d  W              S             20

      *get input-string
      /copy syspeds/qrpgsrcpy,prolog3
        /free

        // Parse input
         exsr Parse;
        // Open files etc
         exsr Init;

       gethtmlifs(
       '/syspeddev/html/JSON.html':
       '/CGITAG/');
       wrtsection('top');

       //...........................................................................................
       //skriv JSON-Object start (alltid '{' + x ant param. m/komma mellom (IKKE komma etter siste))
       //...........................................................................................

        JSONstring='{'
        +'¬user¬ : ¬'+%trim(WSUSER)+'¬, '
        +'¬errMsg¬ : ¬'+%trim(Error)+'¬, ';

       //JSONfix escaper " i tekst,  for deretter å bytte ¬->"

       jsonfix ( jsonstring );

       updhtmlvar2('JSONstring'
                  :%addr(jsonstring)
                  :%len(jsonstring));
       wrtsection('JSONlin');

       //...........................................................................................
       // Skriv JSON-LISTE Start (en liste er EN parameter(fra [ til   )
       //..........................................................................................
       jsonstring ='"kundvaradd" : [';

       updhtmlvar2('JSONstring'
                  :%addr(jsonstring)
                  :%len(jsonstring));
       wrtsection('JSONlin');

       if error = *blanks;
         // Hæmta til array
         exsr sradd;
         // Avsluta
         exsr avslut;
       endif;
       // ..........................................................................................
       // Skriv JSON-Liste/Array  Avslutning
       // ..........................................................................................
       jsonstring =']';
       updhtmlvar2('JSONstring'
                  :%addr(jsonstring)
                  :%len(jsonstring));
       wrtsection('JSONlin');
       // ..........................................................................................
       // Skriv JSON-string Avsluttning
       // ..........................................................................................
       jsonstring ='}';
       updhtmlvar2('JSONstring'
                  :%addr(jsonstring)
                  :%len(jsonstring));
       wrtsection('JSONlin');

       // Quit
       exsr exit;

       //=====================================================================
       // Close output html and quit
       //=====================================================================
       begsr exit;
         // Lukk fil
         close bridf;
         if *in50 = *off;
         close sadvare;
         endif;

         // Do not delete the call to wrtsection with section name *fini.  It is needed
         // to ensure that all output html that has been buffered gets output.
         wrtsection('*fini');
         // Quit
         *inlr = *on;
         return;
       endsr;
       //********************************************************
       begsr parse;
       //********************************************************
       // Get input
         wsuser    = zhbgetvar('USER');
         varenr    = zhbgetvar('VARENR');
         varebe    = zhbgetvar('VAREBE');
         w         = zhbgetvar('LEVENR');
         levenr    = c2n2(w);
         W2VF      = zhbgetvar('W2VF');
         W2LK      = zhbgetvar('W2LK');
         W2VNTI    = zhbgetvar('W2VNTI');
         W2TN      = zhbgetvar('W2TN');
         W2PRE     = zhbgetvar('W2PRE');
         w         = zhbgetvar('W2BELT');
         w2belt    = c2n2(w);
         w         = zhbgetvar('W2VKTB');
         w2vktb    = c2n2(w);
         w         = zhbgetvar('W2VKTN');
         w2vktn    = c2n2(w);
         w         = zhbgetvar('W2NTM');
         w2ntm     = c2n2(w);
         W2PVA     = zhbgetvar('W2PVA');
         w         = zhbgetvar('W2AS');
         w2as      = c2n2(w);
         W2MFR     = zhbgetvar('W2MFR');
         W2AKD1    = zhbgetvar('W2AKD1');
         W2ASV1    = zhbgetvar('W2ASV1');
         w         = zhbgetvar('W2ASA1');
         w2asa1    = c2n2(w);
         w         = zhbgetvar('W2AGR1');
         w2agr1    = c2n2(w);
         w         = zhbgetvar('W2ABL1');
         w2abl1    = c2n2(w);
         w         = zhbgetvar('W2BEL');
         w2bel     = c2n2(w);
         W2AKD2    = zhbgetvar('W2AKD2');
         W2ASV2    = zhbgetvar('W2ASV2');
         w         = zhbgetvar('W2ASA2');
         w2asa2    = c2n2(w);
         w         = zhbgetvar('W2AGR2');
         w2agr2    = c2n2(w);
         w         = zhbgetvar('W2ABL2');
         w2abl2    = c2n2(w);
         w         = zhbgetvar('W2PROS');
         w2pros    = c2n2(w);
         W2AKD3    = zhbgetvar('W2AKD3');
         W2ASV3    = zhbgetvar('W2ASV3');
         w         = zhbgetvar('W2ASA3');
         w2asa3    = c2n2(w);
         w         = zhbgetvar('W2AGR3');
         w2agr3    = c2n2(w);
         w         = zhbgetvar('W2ABL3');
         w2abl3    = c2n2(w);
         W2VAL     = zhbgetvar('W2VAL');
         W2AKD4    = zhbgetvar('W2AKD4');
         W2ASV4    = zhbgetvar('W2ASV4');
         w         = zhbgetvar('W2ASA4');
         w2asa4    = c2n2(w);
         w         = zhbgetvar('W2AGR4');
         w2agr4    = c2n2(w);
         w         = zhbgetvar('W2ABL4');
         w2abl4    = c2n2(w);
         w         = zhbgetvar('W2BELN');
         w2beln    = c2n2(w);
         W2AKD5    = zhbgetvar('W2AKD5');
         W2ASV5    = zhbgetvar('W2ASV5');
         w         = zhbgetvar('W2ASA5');
         w2asa5    = c2n2(w);
         w         = zhbgetvar('W2AGR5');
         w2agr5    = c2n2(w);
         w         = zhbgetvar('W2ABL5');
         w2abl5    = c2n2(w);
         W2AKD6    = zhbgetvar('W2AKD6');
         W2ASV6    = zhbgetvar('W2ASV6');
         w         = zhbgetvar('W2ASA6');
         w2asa6    = c2n2(w);
         w         = zhbgetvar('W2AGR6');
         w2agr6    = c2n2(w);
         w         = zhbgetvar('W2ABL6');
         w2abl6    = c2n2(w);
         W2AKD7    = zhbgetvar('W2AKD7');
         W2ASV7    = zhbgetvar('W2ASV7');
         w         = zhbgetvar('W2ASA7');
         w2asa7    = c2n2(w);
         w         = zhbgetvar('W2AGR7');
         w2agr7    = c2n2(w);
         w         = zhbgetvar('W2ABL7');
         w2abl7    = c2n2(w);
         W2AKD8    = zhbgetvar('W2AKD8');
         W2ASV8    = zhbgetvar('W2ASV8');
         w         = zhbgetvar('W2ASA8');
         w2asa8    = c2n2(w);
         w         = zhbgetvar('W2AGR8');
         w2agr8    = c2n2(w);
         w         = zhbgetvar('W2ABL8');
         w2abl8    = c2n2(w);
         W2FT01    = zhbgetvar('W2FT01');
         w         = zhbgetvar('W2NT01');
         w2nt01    = c2n2(w);
         W2EH01    = zhbgetvar('W2EH01');
         W2VT01    = zhbgetvar('W2VT01');
         W2FT02    = zhbgetvar('W2FT02');
         w         = zhbgetvar('W2NT02');
         w2nt02    = c2n2(w);
         W2EH02    = zhbgetvar('W2EH02');
         W2VT02    = zhbgetvar('W2VT02');
         W2FT03    = zhbgetvar('W2FT03');
         w         = zhbgetvar('W2NT03');
         w2nt03    = c2n2(w);
         W2EH03    = zhbgetvar('W2EH03');
         W2VT03    = zhbgetvar('W2VT03');
         W2FT04    = zhbgetvar('W2FT04');
         w         = zhbgetvar('W2NT04');
         w2nt04    = c2n2(w);
         W2EH04    = zhbgetvar('W2EH04');
         W2VT04    = zhbgetvar('W2VT04');
         W2FT05    = zhbgetvar('W2FT05');
         w         = zhbgetvar('W2NT05');
         w2nt05    = c2n2(w);
         W2EH05    = zhbgetvar('W2EH05');
         W2VT05    = zhbgetvar('W2VT05');
         W2FT06    = zhbgetvar('W2FT06');
         w         = zhbgetvar('W2NT06');
         w2nt06    = c2n2(w);
         W2EH06    = zhbgetvar('W2EH06');
         W2FT07    = zhbgetvar('W2FT07');
         w         = zhbgetvar('W2NT07');
         w2nt07    = c2n2(w);
         W2EH07    = zhbgetvar('W2EH07');
         W2TOP1    = zhbgetvar('W2TOP1');
         W2CRE1    = zhbgetvar('W2CRE1');
         W2TOP2    = zhbgetvar('W2TOP2');
         W2CRE2    = zhbgetvar('W2CRE2');
         W2TOP3    = zhbgetvar('W2TOP3');
         W2CRE3    = zhbgetvar('W2CRE3');
         W2TOP4    = zhbgetvar('W2TOP4');
         W2CRE4    = zhbgetvar('W2CRE4');
         W2TOP5    = zhbgetvar('W2TOP5');
         W2CRE5    = zhbgetvar('W2CRE5');
         W2TOP6    = zhbgetvar('W2TOP6');
         W2CRE6    = zhbgetvar('W2CRE6');
         W2TOP7    = zhbgetvar('W2TOP7');
         W2CRE7    = zhbgetvar('W2CRE7');
         W2TOP8    = zhbgetvar('W2TOP8');
         W2CRE8    = zhbgetvar('W2CRE8');
         W2TOP9    = zhbgetvar('W2TOP9');
         W2CRE9    = zhbgetvar('W2CRE9');
         W2TOP10   = zhbgetvar('W2TOP10');
         W2CRE10   = zhbgetvar('W2CRE10');

       endsr;
       //********************************************************
       begsr init;
       //********************************************************
         open bridf;
         // Test innlogging
         chain wsuser bridf;
         *in50 = not %found;

         if *in50 = *off;
           if bilibl = *blanks;
             incgi ( bistdl );
           else;

             Monitor;
                   Varpgm();
                 On-Error;
                   //
                 EndMon;

           endif;
        //Dummy read for feltbeskrivelser, kuttes ut i java
         open sadvare;
         if *in50 = *on;
         read sadvare;
         endif;
         else;

           error = 'Invalid userID';
         endif;

       endsr;
        // __________________________________________________
        // Addera post till fil                         SRADD
        // """"""""""""""""""""""""""""""""""""""""""""""""""
           begsr sradd;

          exec sql

          INSERT INTO SADVARE
          (VARENR, VAREBE, LEVENR, W2VF, W2LK, W2VNTI, W2TN, W2PRE, W2BELT,
          W2VKTB, W2VKTN, W2NTM, W2PVA, W2AS, W2MFR, W2AKD1, W2ASV1, W2ASA1,
          W2AGR1, W2ABL1, W2BEL, W2AKD2, W2ASV2, W2ASA2, W2AGR2, W2ABL2,
          W2PROS, W2AKD3, W2ASV3, W2ASA3, W2AGR3, W2ABL3, W2VAL, W2AKD4,
          W2ASV4, W2ASA4, W2AGR4, W2ABL4, W2BELN, W2AKD5, W2ASV5, W2ASA5,
          W2AGR5, W2ABL5, W2AKD6, W2ASV6, W2ASA6, W2AGR6, W2ABL6, W2AKD7,
          W2ASV7, W2ASA7, W2AGR7, W2ABL7, W2AKD8, W2ASV8, W2ASA8, W2AGR8,
          W2ABL8, W2FT01, W2NT01, W2EH01, W2VT01, W2FT02, W2NT02, W2EH02,
          W2VT02, W2FT03, W2NT03, W2EH03, W2VT03, W2FT04, W2NT04, W2EH04,
          W2VT04, W2FT05, W2NT05, W2EH05, W2VT05, W2FT06, W2NT06, W2EH06,
          W2FT07, W2NT07, W2EH07, W2TOP1, W2CRE1, W2TOP2, W2CRE2, W2TOP3,
          W2CRE3, W2TOP4, W2CRE4, W2TOP5, W2CRE5, W2TOP6, W2CRE6, W2TOP7,
          W2CRE7, W2TOP8, W2CRE8, W2TOP9, W2CRE9, W2TOP10, W2CRE10)
          VALUES(:VARENR, :VAREBE, :LEVENR, :W2VF, :W2LK, :W2VNTI, :W2TN,
          :W2PRE, :W2BELT, :W2VKTB, :W2VKTN, :W2NTM, :W2PVA, :W2AS, :W2MFR,
          :W2AKD1, :W2ASV1, :W2ASA1, :W2AGR1, :W2ABL1, :W2BEL, :W2AKD2,
          :W2ASV2, :W2ASA2, :W2AGR2, :W2ABL2, :W2PROS, :W2AKD3, :W2ASV3,
          :W2ASA3, :W2AGR3, :W2ABL3, :W2VAL, :W2AKD4, :W2ASV4, :W2ASA4,
          :W2AGR4, :W2ABL4, :W2BELN, :W2AKD5, :W2ASV5, :W2ASA5, :W2AGR5,
          :W2ABL5, :W2AKD6, :W2ASV6, :W2ASA6, :W2AGR6, :W2ABL6, :W2AKD7,
          :W2ASV7, :W2ASA7, :W2AGR7, :W2ABL7, :W2AKD8, :W2ASV8, :W2ASA8,
          :W2AGR8, :W2ABL8, :W2FT01, :W2NT01, :W2EH01, :W2VT01, :W2FT02,
          :W2NT02, :W2EH02, :W2VT02, :W2FT03, :W2NT03, :W2EH03, :W2VT03,
          :W2FT04, :W2NT04, :W2EH04, :W2VT04, :W2FT05, :W2NT05, :W2EH05,
          :W2VT05, :W2FT06, :W2NT06, :W2EH06, :W2FT07, :W2NT07, :W2EH07,
          :W2TOP1, :W2CRE1, :W2TOP2, :W2CRE2, :W2TOP3, :W2CRE3, :W2TOP4,
          :W2CRE4, :W2TOP5, :W2CRE5, :W2TOP6, :W2CRE6, :W2TOP7, :W2CRE7,
          :W2TOP8, :W2CRE8, :W2TOP9, :W2CRE9, :W2TOP10, :W2CRE10);

       endsr;
        // __________________________________________________
        // Avsluta                                     AVSLUT
        // """"""""""""""""""""""""""""""""""""""""""""""""""
           begsr avslut;
          JSONstring=*blanks;
       JSONstring=%trim(JSONstring)+'{'
          +'¬result¬ : ¬'+ 'ok' + '¬}';
         jsonfix (JSONstring);
       updhtmlvar2('JSONstring'
                  :%addr(jsonstring)
                  :%len(jsonstring));
         wrtsection ('JSONlin');

       endsr;
      /end-free
