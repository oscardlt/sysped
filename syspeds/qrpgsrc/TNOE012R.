      *********************************************************************
      *
CRTPG+*  CRTPGM SYSPED/TNOE012R MODULE(*LIBL/TNOE012R *LIBL/INCGI)
CRTPGM*        ACTGRP(CGI) AUT(*USE)
      *
      *********************************************************************
      /copy SYSPEDS/qrpgsrcpy,hspecs
      /copy SYSPEDS/qrpgsrcpy,hspecsbnd
      *********************************************************************
      * I WEB varianten av SAD Eksport brukes kun fullskjermmodus for vareposter.
      * D.v.s. linjenr fra web er ALLTID hovedlinjenummer og så må jeg returnere
      * alle tillegslinjer som felt med repetisjoner.
      * WA1 - WA7  =  7 Repetisjoner av SVFT
      * WB1 - WB7  =  7 Repetisjoner av SVNT
      * WC1 - WC7  =  7 Repetisjoner av SVEH
      * WD1 - WD5  =  5 Repetisjoner av SVVT
      * WE1 - WE10 = 10 Repetisjoner av SVCREF
      * WF1 - WF10 = 10 Repetisjoner av SVTOA
     FBRIDF     IF   E           K DISK    USROPN
     FSAEV      UF A E           K DISK    USROPN
     F                                     PREFIX(X)
     FSAEV4     UF A E           K DISK    USROPN
     F                                     RENAME(SAEVR:SAEVR4)
     FSAEH      IF   E           K DISK    USROPN
      *--------------------------------------------------------------------
      * Variables common to all CGIs
      *--------------------------------------------------------------------
      /copy SYSPEDS/qrpgsrcpy,prototypeb
      /copy SYSPEDS/qrpgsrcpy,usec
      /copy SYSPEDS/qrpgsrcpy,variables3
      *
      * Varible for
     D WSUSER          S             10
     D WMODE           S              2
     D JSONstring      S          32000
     D Error           S            150
     D WN              S             15
     D SVERR           S              1
     D SVLIGH          S              1
      * Array for SVFT
     D                 DS
     D  WA1                    1     28
     D  WA2                   29     56
     D  WA3                   57     84
     D  WA4                   85    112
     D  WA5                  113    140
     D  WA6                  141    168
     D  WA7                  169    196
     D  WA                     1    280    DIM(10)
     D  XSVFT01                1     28
     D  XSVFT02               29     56
     D  XSVFT03               57     84
     D  XSVFT04               85    112
     D  XSVFT05              113    140
     D  XSVFT06              141    168
     D  XSVFT07              169    196

      * Array for SVNT
     D                 DS
     D  WB1                    1      6S 0
     D  WB2                    7     12S 0
     D  WB3                   13     18S 0
     D  WB4                   19     24S 0
     D  WB5                   25     30S 0
     D  WB6                   31     36S 0
     D  WB7                   37     42S 0
     D  WB                     1     60S 0 DIM(10)
     D  XSVNT01                1      6S 0
     D  XSVNT02                7     12S 0
     D  XSVNT03               13     18S 0
     D  XSVNT04               19     24S 0
     D  XSVNT05               25     30S 0
     D  XSVNT06               31     36S 0
     D  XSVNT07               37     42S 0

      * Array for SVEH
     D                 DS
     D  WC1                    1      4
     D  WC2                    5      8
     D  WC3                    9     12
     D  WC4                   13     16
     D  WC5                   17     20
     D  WC6                   21     24
     D  WC7                   25     28
     D  WC                     1     40    DIM(10)
     D  XSVEH01                1      4
     D  XSVEH02                5      8
     D  XSVEH03                9     12
     D  XSVEH04               13     16
     D  XSVEH05               17     20
     D  XSVEH06               21     24
     D  XSVEH07               25     28

      * Array for SVVT
     D                 DS
     D  WD1                    1     30
     D  WD2                   31     60
     D  WD3                   61     90
     D  WD4                   91    120
     D  WD5                  121    150
     D  WD                     1    300    DIM(10)
     D  XSVVT01                1     30
     D  XSVVT02               31     60
     D  XSVVT03               61     90
     D  XSVVT04               91    120
     D  XSVVT05              121    150

      * Array for SVCREF
     D                 DS
     D  WE1                    1      3
     D  WE2                    4      6
     D  WE3                    7      9
     D  WE4                   10     12
     D  WE5                   13     15
     D  WE6                   16     18
     D  WE7                   19     21
     D  WE8                   22     24
     D  WE9                   25     27
     D  WE10                  28     30
     D  WE                     1     30    DIM(10)
     D  XSVCRE1                1      3
     D  XSVCRE2                4      6
     D  XSVCRE3                7      9
     D  XSVCRE4               10     12
     D  XSVCRE5               13     15
     D  XSVCRE6               16     18
     D  XSVCRE7               19     21
     D  XSVCRE8               22     24
     D  XSVCRE9               25     27
     D  XSVCRE10              28     30

      * Array for SVTOP
     D                 DS
     D  WF1                    1     17
     D  WF2                   18     34
     D  WF3                   35     51
     D  WF4                   52     68
     D  WF5                   69     85
     D  WF6                   86    102
     D  WF7                  103    119
     D  WF8                  120    136
     D  WF9                  137    153
     D  WF10                 154    170
     D  WF                     1    170    DIM(10)
     D  XSVTOP1                1     17
     D  XSVTOP2               18     34
     D  XSVTOP3               35     51
     D  XSVTOP4               52     68
     D  XSVTOP5               69     85
     D  XSVTOP6               86    102
     D  XSVTOP7              103    119
     D  XSVTOP8              120    136
     D  XSVTOP9              137    153
     D  XSVTOP10             154    170

      *get input-string
      /copy syspeds/qrpgsrcpy,prolog3

      * Parse input
     C                   EXSR      Parse
      * Open files etc
     C                   EXSR      INIT
      *
     c                   callp     gethtmlifs(
     C                             '/syspeddev/html/JSON.html':
     C                             '/CGITAG/')
     C                   callp     wrtsection('top')
      * Teste input og utfør
     C                   EXSR      TEST

      * ............................................................................................
      * skriv JSON-Object start..(alltid '{' + x ant param. m/komma mellom (IKKE komma etter siste))
      * ............................................................................................
      *
      /free
        JSONstring='{'
        +'¬user¬ : ¬'+%trim(WSUSER)+'¬, '
        +'¬avd¬ : ¬'+%trim(%editc(SVAVD:'Z'))+'¬, '
        +'¬opd¬ : ¬'+%trim(%editc(SVTDN:'Z'))+'¬, '
        +'¬lin¬ : ¬'+%trim(%editc(SVLI:'Z'))+'¬, '
        +'¬mode¬ : ¬'+%trim(WMODE)+'¬, '
        +'¬errMsg¬ : ¬'+%trim(Error)+'¬, ';
      /end-free
      * JSONfix escaper " i tekst,  for deretter å bytte ¬->"
     c                   call      'JSONFIX'
     c                   parm                    JSONstring
     C                   callp     updHTMLvar('JSONstring':JSONstring)
     C                   callp     wrtsection('JSONlin')
      *
      * ............................................................................................
      * Skriv JSON-LISTE Start (en liste er EN parameter(fra [ til   )
      * ............................................................................................
     c                   eval      JSONstring ='"lineupdate" : ['
     C                   callp     updHTMLvar('JSONstring':JSONstring)
     C                   callp     wrtsection('JSONlin')
      * ............................................................................................
      * Skriv JSON-Liste/Array  Avslutning
      * ............................................................................................
     c                   eval      JSONstring =']'
     C                   callp     updHTMLvar('JSONstring':JSONstring)
     C                   callp     wrtsection('JSONlin')
      * ............................................................................................
      * Skriv JSON-string Avsluttning
      * ............................................................................................
     c                   eval      JSONstring ='}'
     C                   callp     updHTMLvar('JSONstring':JSONstring)
     C                   callp     wrtsection('JSONlin')
      *
      * Quit
     C                   exsr      Exit


      *=====================================================================
      * Close output html and quit
      *=====================================================================
     C     Exit          begsr
      * Lukk fil
     C                   CLOSE     BRIDF
     C  N50              CLOSE     SAEV
     C  N50              CLOSE     SAEV4
     C  N50              CLOSE     SAEH

      * Do not delete the call to wrtsection with section name *fini.  It is needed
      * to ensure that all output html that has been buffered gets output.
     C                   callp     wrtsection('*fini')
      * Quit
     C                   MOVE      *ON           *INLR
     C                   return
     C                   endsr
      *
      *********************************************************
     C     Parse         Begsr
      *********************************************************
     C                   MOVEA     *ZEROS        WB
      * Get input
     C                   EVAL      WSUSER  = zhbgetvar('USER')
     C                   EVAL      WN         = zhbgetvar('AVD')
     C                   EVAL      SVAVD      = c2n2(WN)
     C                   EVAL      WN         = zhbgetvar('OPD')
     C                   EVAL      SVTDN      = c2n2(WN)
     C                   EVAL      WN         = zhbgetvar('LIN')
     C                   EVAL      SVLI       = c2n2(WN)
     C                   EVAL      WMODE  = zhbgetvar('MODE')
     C                   EVAL      SV01  = zhbgetvar('SV01')
     C                   EVAL      WN         = zhbgetvar('SVBELT')
     C                   EVAL      SVBELT= c2n2(WN)
     C                   EVAL      SVFYL = zhbgetvar('SVFYL')
     C                   EVAL      WN         = zhbgetvar('SVVNT')
     C                   EVAL      SVVNT = c2n2(WN)
     C                   EVAL      SVAVT = zhbgetvar('SVAVT')
     C                   EVAL      SVAVTS= zhbgetvar('SVAVTS')
     C                   EVAL      WN         = zhbgetvar('SVAVTP')
     C                   EVAL      SVAVTP= c2n2(WN)
     C                   EVAL      WN         = zhbgetvar('SVVKTB')
     C                   EVAL      SVVKTB= c2n2(WN)
     C                   EVAL      WN         = zhbgetvar('SVVKTN')
     C                   EVAL      SVVKTN= c2n2(WN)
     C                   EVAL      WN         = zhbgetvar('SVNTM')
     C                   EVAL      SVNTM = c2n2(WN)
     C                   EVAL      SVERR      = zhbgetvar('SVERR')
     C                   EVAL      SVLIGH  = zhbgetvar('SVLIGH')
     C                   EVAL      WA1   = zhbgetvar('WA1')
     C                   EVAL      WA2   = zhbgetvar('WA2')
     C                   EVAL      WA3   = zhbgetvar('WA3')
     C                   EVAL      WA4   = zhbgetvar('WA4')
     C                   EVAL      WA5   = zhbgetvar('WA5')
     C                   EVAL      WA6   = zhbgetvar('WA6')
     C                   EVAL      WA7   = zhbgetvar('WA7')
     C                   EVAL      WN         = zhbgetvar('WB1')
     C                   EVAL      WB1   = c2n2(WN)
     C                   EVAL      WN         = zhbgetvar('WB2')
     C                   EVAL      WB2   = c2n2(WN)
     C                   EVAL      WN         = zhbgetvar('WB3')
     C                   EVAL      WB3   = c2n2(WN)
     C                   EVAL      WN         = zhbgetvar('WB4')
     C                   EVAL      WB4   = c2n2(WN)
     C                   EVAL      WN         = zhbgetvar('WB5')
     C                   EVAL      WB5   = c2n2(WN)
     C                   EVAL      WN         = zhbgetvar('WB6')
     C                   EVAL      WB6   = c2n2(WN)
     C                   EVAL      WN         = zhbgetvar('WB7')
     C                   EVAL      WB7   = c2n2(WN)
     C                   EVAL      WC1   = zhbgetvar('WC1')
     C                   EVAL      WC2   = zhbgetvar('WC2')
     C                   EVAL      WC3   = zhbgetvar('WC3')
     C                   EVAL      WC4   = zhbgetvar('WC4')
     C                   EVAL      WC5   = zhbgetvar('WC5')
     C                   EVAL      WC6   = zhbgetvar('WC6')
     C                   EVAL      WC7   = zhbgetvar('WC7')
     C                   EVAL      WD1   = zhbgetvar('WD1')
     C                   EVAL      WD2   = zhbgetvar('WD2')
     C                   EVAL      WD3   = zhbgetvar('WD3')
     C                   EVAL      WD4   = zhbgetvar('WD4')
     C                   EVAL      WD5   = zhbgetvar('WD5')
     C                   EVAL      WE1   = zhbgetvar('WE1')
     C                   EVAL      WE2   = zhbgetvar('WE2')
     C                   EVAL      WE3   = zhbgetvar('WE3')
     C                   EVAL      WE4   = zhbgetvar('WE4')
     C                   EVAL      WE5   = zhbgetvar('WE5')
     C                   EVAL      WE6   = zhbgetvar('WE6')
     C                   EVAL      WE7   = zhbgetvar('WE7')
     C                   EVAL      WE8   = zhbgetvar('WE8')
     C                   EVAL      WE9   = zhbgetvar('WE9')
     C                   EVAL      WE10  = zhbgetvar('WE10')
     C                   EVAL      WF1   = zhbgetvar('WF1')
     C                   EVAL      WF2   = zhbgetvar('WF2')
     C                   EVAL      WF3   = zhbgetvar('WF3')
     C                   EVAL      WF4   = zhbgetvar('WF4')
     C                   EVAL      WF5   = zhbgetvar('WF5')
     C                   EVAL      WF6   = zhbgetvar('WF6')
     C                   EVAL      WF7   = zhbgetvar('WF7')
     C                   EVAL      WF8   = zhbgetvar('WF8')
     C                   EVAL      WF9   = zhbgetvar('WF9')
     C                   EVAL      WF10  = zhbgetvar('WF10')
     C                   EVAL      SVTOB = zhbgetvar('SVTOB')
     C                   EVAL      WN         = zhbgetvar('SVREFL')
     C                   EVAL      SVREFL = c2n2(WN)
     C                   EVAL      SVEXR01= zhbgetvar('SVEXR01')
     C                   EVAL      SVEXR02= zhbgetvar('SVEXR02')
     C                   EVAL      SVEXR03= zhbgetvar('SVEXR03')
     C                   EVAL      WN         = zhbgetvar('SVEXR04')
     C                   EVAL      SVEXR04= c2n2(WN)
     C                   EVAL      WN         = zhbgetvar('SVEXR05')
     C                   EVAL      SVEXR05= c2n2(WN)
     C                   EVAL      SVEXR06= zhbgetvar('SVEXR06')
     C                   EVAL      WN         = zhbgetvar('SVEXR07')
     C                   EVAL      SVEXR07= c2n2(WN)
     C                   EVAL      SVLK  = zhbgetvar('SVLK')
     C                   EVAL      SVNYL = zhbgetvar('SVNYL')
     C                   ENDSR
      *********************************************************
     C     INIT          Begsr
      *********************************************************
     C                   OPEN      BRIDF
      * Test innlogging
     C     WSUSER        CHAIN     BRIDF                              50
     C     BILIBL        ifeq      *blanks
     C                   callb     'INCGI'
     C                   parm                    BISTDL
     C                   else
     C                   call      BILIBL
     C                   end
      *
     C     SAEVKEY       KLIST
     C                   KFLD                    SVAVD
     C                   KFLD                    SVTDN
     C                   KFLD                    SVLI
     C     SAEVKEY2      KLIST
     C                   KFLD                    SVAVD
     C                   KFLD                    SVTDN
     C                   KFLD                    WSVLI
     C     SAEVKEY4      klist
     C                   kfld                    SVAVD
     C                   kfld                    SVTDN
     C                   kfld                    SVLN
     C     SAEHKEY       KLIST
     C                   KFLD                    SVAVD
     C                   KFLD                    SVTDN
      *
     C   50              eval      Error = 'Invalid userID'
     C  N50              OPEN      SAEV
     C  N50              OPEN      SAEV4
     C  N50              OPEN      SAEH
      * Dummy chain for feltbeskrivelse
     C   50*IN50         IFEQ      *OFF
     C                   READ      SAEV4
     C                   ENDIF
     C     *LIKE         DEFINE    SVLI          WSVLI2
     C     *LIKE         DEFINE    SVLI          WSVLI
     C     *LIKE         DEFINE    SVLN          WSVLN
     C                   EVAL      WSVLI=99999
     C                   Z-ADD     0             WX                2 0

     c                   endsr
      *
      *______________________________________________________
      * TEST                                             TEST
      *""""""""""""""""""""""""""""""""""""""""""""""""""""""
     C     TEST          BEGSR
     C     WMODE         IFNE      'A'
     C     SAEVKEY       CHAIN     SAEV                               55
     C                   ENDIF
      * MODE A=Add  D=Delete  U=Update
     C                   SELECT
     C     WMODE         WHENEQ    'A'
     C                   eval      Error = *blanks
     C                   EXSR      SRA
     C     WMODE         WHENEQ    'D'
     C                   IF        *IN55=*ON
     C                   eval      Error = 'Order not found'
     C                   ELSE
     C                   eval      Error = *blanks
     C                   EXSR      SRD
     C                   ENDIF
     C     WMODE         WHENEQ    'U'
     C                   IF        *IN55=*ON
     C                   eval      Error = 'Order not found'
     C                   ELSE
     C                   eval      Error = *blanks
     C                   EXSR      SRU
     C                   ENDIF
     C                   OTHER
     C                   eval      Error = 'Wrong mode'
     C                   ENDSL
     C                   ENDSR
      *______________________________________________________
      * Add                                               SRA
      *""""""""""""""""""""""""""""""""""""""""""""""""""""""
     C     SRA           BEGSR
      * Finn høyeste linjenr
     C     SAEVKEY2      SETLL     SAEV
     C     SAEHKEY       READPE    SAEV                                   56
     C                   EVAL      WSVLI=XSVLI
     C                   ADD       1             WSVLI
     C                   CLEAR                   SAEVR
     C                   EVAL      XSVAVD=SVAVD
     C                   EVAL      XSVTDN=SVTDN
     C                   EVAL      XSVLI=WSVLI
     C                   EVAL      XSVLN=WSVLI
     C                   EVAL      SVLI=WSVLI
     C                   EVAL      XSVREFL=*ZEROS
     C                   WRITE     SAEVR
     C                   ENDSR
      *______________________________________________________
      * Delete                                            SRD
      *""""""""""""""""""""""""""""""""""""""""""""""""""""""
     C     SRD           BEGSR
     C                   UPDATE    SAEVR
     C                   EVAL      SVLN=XSVLN
     C     SAEVKEY4      SETLL     SAEV4
     C     SAEVKEY4      READE     SAEV4                                  56
     C     *IN56         DOWEQ     *OFF
     C                   DELETE    SAEVR4
     C     SAEVKEY4      READE     SAEV4                                  56
     C                   ENDDO
     C                   ENDSR
      *______________________________________________________
      * Update                                            SRU
      *""""""""""""""""""""""""""""""""""""""""""""""""""""""
     C     SRU           BEGSR
     C                   EVAL      XSVAVT =SVAVT
     C                   EVAL      XSVAVTS=SVAVTS
     C                   EVAL      XSVAVTP=SVAVTP
     C                   EVAL      XSVVKTN=SVVKTN
     C                   IF        SVLIGH=*BLANKS
     C                   EVAL      XSV01  =SV01
     C                   EVAL      XSVBELT=SVBELT
     C                   EVAL      XSVFYL =SVFYL
     C                   EVAL      XSVVNT =SVVNT
     C                   EVAL      XSVVKTB=SVVKTB
     C                   EVAL      XSVNTM =SVNTM
     C                   EVAL      XSVERR =SVERR
     C                   EVAL      XSVREFL =*ZEROS
     C                   EVAL      XSVEXR01=SVEXR01
     C                   EVAL      XSVEXR02=SVEXR02
     C                   EVAL      XSVEXR03=SVEXR03
     C                   EVAL      XSVEXR04=SVEXR04
     C                   EVAL      XSVEXR05=SVEXR05
     C                   EVAL      XSVEXR06=SVEXR06
     C                   EVAL      XSVEXR07=SVEXR07
     C                   EVAL      XSVLK   =SVLK
     C                   EVAL      XSVNYL  =SVNYL
     C                   ENDIF
     C                   UPDATE    SAEVR
     C                   ENDSR
