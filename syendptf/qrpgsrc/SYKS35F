********************************************************************
      * RETTINGER I DETTE PROGRAM:
PTFnr:*Sek Sig Vers  Beskrivelse...........................
""""""*"""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""
10XXX * 01 SH  PTF10 avvikende momssats .....
10XXX * 02 SH  PTF12 HENTER NÅ BILLAGSSERIE FRA KOSTT
10XXX * 03 SH  PTF12 FLYTTER MOMSKODEN TIL KOSTNADSKONTO
      * 04 SH  PTF12 VISMA
      * 05 SH  PTF12 mer visma
      * 06 SH  PTF12 visma netto
      * 07 SH  PTF12 momsavvik visma
********************************************************************
      *
      *
      * ferdeling bilag mot interrinskonto
      *
N01  FKODWL01   IF   E           K DISK
     Fkosal01   IP   E           K DISK
     FKOSAL02   UF A E           K DISK
     F                                     RENAME(KOSAR:KOSAR02)
     FFIRM      IF   E           K DISK
     FFIRMKOS   IF   E           K DISK
     Fkosbl02   UF A E           K DISK
S02  F*UMML01   UF   E           K DISK
n02  FKOSTT     UF A E           K DISK
     FSYSRL01   UF   E           K DISK
     D                 DS
     D  BILDAT                 1      8  0
     D  BILAAR                 1      4  0
     D  BILMND                 5      6  0
     D  BILDAG                 7      8  0
      *
      * INITIERING
      *
     C  N99              EXSR      INIT
     C  N99              SETON                                        99
      *
      * ikke les poster generert av dette program
      *
      *
      * TESTER AVVIKENDE PERIODE
      *
      * ikke les poster generert av dette program
      * de har aktivitektskode = I
      *
     c     aktkod        ifeq      'A'
     c                   EXSR      AVVIK
     C     DIFF          IFEQ      'J'
     C                   EXSR      FORDEL
     C                   END
     C                   END
      * renbumerer linjenummer i bilag
     cLR                 EXSR      RENUM
      ******************************************************
     C     AVVIK         BEGSR
      ******************************************************
      * test om billagsnummer har et avvik
      * setter da DIFF til 'J'
      *
     C                   SETOFF                                       33
     C                   MOVE      'N'           DIFF              1
     C                   MOVE      BILNR         BILNRH            7 0
     C                   MOVE      PERAAR        PERAARH           4 0
     C                   MOVE      PERNR         PERNRH            2 0
      *
     C     KEY           KLIST
     C                   KFLD                    BILNRH
      *
     C     KEY           SETLL     KOSBL02
     C     *IN33         DOWEQ     '0'
     C     KEY           READE     KOSBL02                                33
     C     *IN33         IFEQ      '0'
     C     PERAAR        IFNE      PERAARH
     C     PERNR         ORNE      PERNRH
     C                   MOVE      'J'           DIFF
      *
      * VARIABLE VAT
      *
     C     FITAX         ADD       1             FITAXN            5 4
     C     FITAXD        IFNE      *ZEROS
     C     FITAX2        ANDNE     *ZEROS
     C     BILDAT        ANDLT     FITAXD
     C     FITAX2        ADD       1             FITAXN
     C                   END
     C                   GOTO      AVVIKUT
     C                   ENDIF
     C                   ENDIF
     C                   ENDDO
     C     AVVIKUT       ENDSR
     C*************************************************************
     C     FORDEL        BEGSR
     C*************************************************************
     C     KEYF          KLIST
     C                   KFLD                    BILNRH
     c                   setoff                                       33
      *
     C     KEYF          SETLL     KOSBL02
     C     *IN33         DOWEQ     '0'
     C     KEYF          READE     KOSBL02                                33
     C     *IN33         IFEQ      '0'
      *
      * trekker ut kun de postene som diferrerer fra hovedbillaget
      *
     c     PERAAR        IFNE      PERAARH
     c     PERNR         ORNE      PERNRH
      *
      * LEGGER INTERRIMKONTO PÅ FØRING
      * OG HOVEDBILAGET PERIODE
      *
      * TAR VARE PÅ FØRVERDIENE
      *
     C                   MOVE      KONTO         KONTOT            5 0
     C                   MOVE      PERAAR        PERAART           4 0
     C                   MOVE      PERNR         PERNRT            2 0
     C                   MOVE      KSTED         KSTEDT            4 0
     C                   MOVE      KBARER        KBARERT           4 0
     C                   MOVE      PROSNR        PROSNRT           8 0
     C                   MOVE      BILTXT        BILTXTT          15
     C                   MOVE      MOMSK         MOMSKT            1
      *
      * SETTER KONTERING    TIL HOVEDBILLAGETS PERIODE
      * og oppdaterer dette
      *
     C                   MOVE      PERAARH       PERAAR
     C                   MOVE      PERNRH        PERNR
     C                   MOVE      INTERR        KONTO
     C                   MOVE      *ZEROS        KSTED
     C                   MOVE      *ZEROS        KBARER
     C                   MOVE      *ZEROS        PROSNR
N07  C     l1KJOR        IFNE      'V'
n03  c                   MOVE      '0'           MOMSK
N07  c                   end
s07  C*    l1KJOR        IFEQ      'V'
s07  c*                  z-add     bbelop        nbelpo
s07  c*                  end
     C                   UPDATE    KOSBR
      *
      *
      *
     C                   EXSR      KONTER
     C                   ENDIF
     C                   ENDIF
     C                   ENDDO
     C                   ENDSR
     C*************************************************************
     C     KONTER        BEGSR
     C*************************************************************
      *
      * KONTERER INTERRIMSFØRINGER
      *
      *
      *
     C     KOSAFK        KLIST
     C                   KFLD                    FIFIRM
     C                   KFLD                    aktint
     C                   KFLD                    PERAAR
     C                   KFLD                    PERNR
     C                   move      'I'           aktint            1
      *
      * POSTERER PÅ KOSTNADSKONTO FØRST
      * IKKE MOMS PÅ INTERRIMSFØRINGENE
      *
     C                   MOVE      KONTOT        KONTO
     C                   MOVE      PERAART       PERAAR
     C                   MOVE      PERNRT        PERNR
     C                   MOVE      KSTEDT        KSTED
     C                   MOVE      KBARERT       KBARER
     C                   MOVE      PROSNRT       PROSNR
      *
      * reduserer brutto hvis moms
      *
     C     MOMSK         IFEQ      '1'
     C     BBELOP        DIV(H)    FITAXN        BBELOP
     C                   END
     C     MOMSK         IFNE      '0'
     C     MOMSK         ANDNE     '1'
     C     MOMSK         ANDNE     '4'
N01   * avvikende moms
N01  C     KODWKY        CHAIN     KODWL01                            84
N01  C     *IN84         IFEQ      *OFF
N01  C     MVAAVI        DIV       100           FITAXB            5 4
N01  C                   ADD       1             FITAXB
N01  C     BBELOP        DIV(H)    FITAXB        BBELOP
N01  C                   END
N01  C                   END
N07  C     l1KJOR        IFEQ      'V'
N07  c                   z-add     nbelpo        belopv
N07  c                   end
      *
S03  C*                  MOVE      '0'           MOMSK
N07  C     l1KJOR        IFNE      'V'
n03  C                   MOVE      momskt        MOMSK
N07  c                   else
N07  c                   move      '0'           momsk
N07  c                   end
     C                   EXSR      GETSUR
      *
      *  FINNES RECORD I POSAF ?
      *
     C     KOSAFK        CHAIN     KOSAL02                            34
      *
      * skriv til fil
      *
     C     *IN34         IFEQ      '1'
     C                   EXSR      HENTBN
     C                   EXSR      GETSUR
     C                   move      'I'           aktkod
     c                   write     kosar02
     C                   END
      *
      *  skriver til     POSBF
      *
     C                   move      'A'           aktkod
N04  C                   EXSR      netto
N06  C     l1KJOR        IFEQ      'V'
N06  c                   z-add     1             bildag
N06  c                   z-add     pernr         bilmnd
N06  c                   end
N07  C                   MOVE      *blanks       BILTXT
N07  C                   MOVEL     BILNRH        BILTXT
     C                   WRITE     KOSBR
     C
      *
      * POSTERER PÅ INTERRIMSKONTOEN
      *
     C                   MOVE      *blanks       BILTXT
     C                   MOVEL     BILNRH        BILTXT
     C                   MOVE      INTERR        KONTO
     C                   MOVE      *ZEROS        KSTED
     C                   MOVE      *ZEROS        KBARER
     C                   MOVE      *ZEROS        PROSNR
     C                   Z-SUB     BBELOP        BBELOP
N03  C                   MOVE      '0'           MOMSK
     C                   EXSR      GETSUR
N04  C                   EXSR      netto
N07  C     l1KJOR        IFEQ      'V'
N07  C                   Z-SUB     belopv        belopv
N07  c                   end
     C                   WRITE     KOSBR
     C                   ENDSR
     C******************************************
     C     GETSUR        BEGSR
     C******************************************
     C     SYSRKE        KLIST
     C                   KFLD                    FIFIRM
     C                   KFLD                    REGNA
     C                   MOVE      'SYS   '      REGNA             6
     C*
     C* HENT NYTT SURRUGATNR - FRA SYSRF LEGG I "POSLNR"
     C*
     C*
     C     SYSRKE        CHAIN     SYSRL01                            30
     C  N30              ADD       1             SISSGT
     C  N30              UPDATE    SYSRR
     C                   Z-ADD     SISSGT        POSLNR
     C                   ENDSR
      *
      **********************************************************
     C     HENTBN        BEGSR
      **********************************************************
S02   *
S02  C* DEFINERER NØKKEL TIL NUMML01
S02   *
S02  C*    NUMMKY        KLIST
S02  C*                  KFLD                    FIFIRM
S02  C*                  KFLD                    SÅR               4 0
S02  C*                  KFLD                    NOK1
S02  C*                  KFLD                    NOK2
S02  C*                  MOVE      'BILS'        NOK1              4
S02  C*                  MOVE      '    '        NOK2              4
S02  C*                  MOVE      PERAAR        SÅR
      *
      *
S02  C*    NUMMKY        CHAIN     NUMML01                            61
S02  C*    *IN61         IFEQ      '1'
S02  C*                  EXSR      GMLNUM
S02  C*                  END
      *
S02  C*
S02  C* N61              DO
S02  C*                  ADD       1             SBNRNU
S02  C*                  MOVE      SBNRNU        BILNR
S02  C*                  MOVE      SBNRNU        BILNRS            7 0
S02  C*                  UPDATE    NUMMR
S02  C*                  END
N02  C* TILDEL BILAGSNUMMER INTERRIMSFØRINGER
N02  C     'I'           CHAIN     KOSTT                              33
N02  C   33              MOVE      'Ø'           KTTYP
N02  C   33              MOVE      2000000       KTNR
N02  C                   MOVE      KTNR          BILNR             7 0
N02  C                   MOVE      KTNR          BILNRS            7 0
N02  C                   ADD       1             KTNR
N02  C  N33              UPDATE    KOSTTR
N02  C   33              WRITE     KOSTTR
     C*
     C                   MOVE      'A'           AKTKOD
     C                   MOVE      *BLANKS       VALKOD
     C*
     C                   ENDSR
     C*
     C*************************************************************
S02  C*    GMLNUM        BEGSR
     C*************************************************************
      *
S02  C*    SÅR           DOWGT     2002
S02  C*                  SUB       1             SÅR
S02  C*    NUMMKY        CHAIN     NUMML01                            61
S02  C* N61              LEAVE
S02  C*                  END
      *
S02  C*                  ENDSR
     C*
     C*************************************************************
     C     INIT          BEGSR
     C*************************************************************
N04  C     *ENTRY        PLIST
N04  C                   PARM                    L1KJOR            1
N01  C     KODWKY        KLIST
N01  C                   KFLD                    FIFIRM
N01  C                   KFLD                    WMVAKD
     C                   KFLD                    MOMSK
     C                   MOVE      *BLANKS       WMVAKD            2
     C                   READ      FIRM                                   33
     C     FIFIRM        CHAIN     FIRMKOS                            33
     c     tillat        ifne      'J'
     c                   seton                                        lr
     c                   return
     c                   end
     C                   ENDSR
      ******************************************************
     C     RENUM         BEGSR
      ******************************************************
      * renummererer bilagene i kosbf
      *
     C                   Z-ADD     0             LINJE             5 0
     C                   z-add     0             BILNR0            7 0
     c                   setoff                                       33
      *
     C     KEY0          KLIST
     C                   KFLD                    BILNR0
      *
     C     KEY0          SETLL     KOSBL02
     C     *IN33         DOWEQ     '0'
     C                   READ      KOSBL02                                33
     C     *IN33         IFEQ      '0'
     C                   ADD       1             LINJE
     C                   Z-ADD     LINJE         POSNR
     C                   UPDATE    KOSBR
     C                   ENDIF
     C                   ENDDO
     c                   exsr      kosafsr
     C                   ENDSR
      ******************************************************
     C     kosafsr       BEGSR
      ******************************************************
      * renummererer bilagene i kosbf
      *
     c                   setoff                                       33
      *
      *
     C     KOSAFK0       KLIST
     C                   KFLD                    FIFIRM
     C                   KFLD                    AKTINT
     C                   move      'I'           aktint            1
      *
     C     KOSAFK0       SETLL     KOSAL02
     C     *IN33         DOWEQ     '0'
     C     KOSAFK0       READE     KOSAL02                                33
     C     *IN33         IFEQ      '0'
     C                   move      'A'           AKTKOD
     C                   UPDATE    KOSAR02
     C                   ENDIF
     C                   ENDDO
     C                   ENDSR
N04  C***********************************************
n04  C     NETTO         BEGSR
N04  C***********************************************
N04   * KUN VISMA
N04  C     l1KJOR        IFEQ      'V'
n04   * BBELOP TIL NBELPO
N04  c                   z-add     bbelop        nbelpo
N04  c     valkox        ifne      *blanks
N04  c     belopv        andne     *zeros
N04  c                   z-add     BELOPV        nbelpo
N04  c                   end
N04  c     momsk         ifeq      '1'
N04  C     nbelpo        DIV(H)    FITAXN        NBELpo
N04  c                   end
N04  c                   end
N05  c                   move      'J'           OPKDPO
N04  C                   ENDSR
