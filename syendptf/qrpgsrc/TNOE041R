      *********************************************************************
      *
CRTPG+*  CRTPGM SYSPED/TNOE041R MODULE(*LIBL/TNOE041R *LIBL/INCGI)
CRTPGM*        ACTGRP(*NEW) AUT(*USE)
      *
********************************************************************
      * RETTINGER I DETTE PROGRAM:
PTFnr:*Sek Sig Vers  Beskrivelse...........................
""""""*"""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""
12053 * 01 YBC PTF12 FLERE FELTER ER UTVIDET.
********************************************************************
      *********************************************************************
      /copy SYSPEDS/qrpgsrcpy,hspecs
      /copy SYSPEDS/qrpgsrcpy,hspecsbnd
      *********************************************************************
     FBRIDF     IF   E           K DISK    USROPN
      *--------------------------------------------------------------------
      * Variables common to all CGIs
      *--------------------------------------------------------------------
      /copy SYSPEDS/qrpgsrcpy,prototypeb
      /copy SYSPEDS/qrpgsrcpy,usec
      /copy SYSPEDS/qrpgsrcpy,variables3
     ‚*  Prototype for 'JSONFIX'
     d jsonfix         pr                  extpgm('JSONFIX')
     d jsonstring_                         like(jsonstring)
     ‚*  Prototype for 'INCGI'
     d incgi           pr                  extproc('INCGI')
     d bistdl_                             like(bistdl)
     ‚*  Prototype for variabel program
     D Varpgm          Pr                  ExtPgm(BILIBL)
      * Varible for
     D WSUSER          S             10
     D WLEVA           S              8
     D WLEVN           S              8S 0
     D VARNR           S             28
     D JSONstring      s          32000
     D Error           S            150
     D AntLest         S              9  0
     d myrows          s             10i 0
     d  X              S              5  0
     d  WERR           S              1
     d MyPoDS          ds                  Qualified  dim(10000)
     d  VARENR                       28
     d  VAREBE                       50
     d  W2VF                          1
     d  W2LK                          2
     d  W2VNTI                        8
     d  W2TN                          1
     d  W2PRE                         1
E01  d  W2BELT                       13S 2
     d  W2VKTB                       12S 3
     d  W2VKTN                       12S 3
     d  W2NTM                         9S 0
     d  W2PVA                         1
     d  W2AS                          7S 2
     d  W2MFR                         1
     d  W2AKD1                        2
     d  W2ASV1                        3
     d  W2ASA1                        7S 2
E01  d  W2AGR1                       13S 2
E01  d  W2ABL1                       13S 2
     d  W2BEL                        11S 2
     d  W2AKD2                        2
     d  W2ASV2                        3
     d  W2ASA2                        7S 2
E01  d  W2AGR2                       13S 2
E01  d  W2ABL2                       13S 2
     d  W2PROS                        5S 2
     d  W2AKD3                        2
     d  W2ASV3                        3
     d  W2ASA3                        7S 2
E01  d  W2AGR3                       13S 2
E01  d  W2ABL3                       13S 2
     d  W2VAL                         3
     d  W2AKD4                        2
     d  W2ASV4                        3
     d  W2ASA4                        7S 2
E01  d  W2AGR4                       13S 2
E01  d  W2ABL4                       13S 2
     d  W2BELN                       13S 2
     d  W2AKD5                        2
     d  W2ASV5                        3
     d  W2ASA5                        7S 2
E01  d  W2AGR5                       13S 2
E01  d  W2ABL5                       13S 2
     d  W2AKD6                        2
     d  W2ASV6                        3
     d  W2ASA6                        7S 2
E01  d  W2AGR6                       13S 2
E01  d  W2ABL6                       13S 2
     d  W2AKD7                        2
     d  W2ASV7                        3
     d  W2ASA7                        7S 2
E01  d  W2AGR7                       13S 2
E01  d  W2ABL7                       13S 2
     d  W2AKD8                        2
     d  W2ASV8                        3
     d  W2ASA8                        7S 2
E01  d  W2AGR8                       13S 2
E01  d  W2ABL8                       13S 2
     d  W2FT01                       28
     d  W2NT01                        6S 0
     d  W2EH01                        4
     d  W2VT01                       30
     d  W2FT02                       28
     d  W2NT02                        6S 0
     d  W2EH02                        4
     d  W2VT02                       30
     d  W2FT03                       28
     d  W2NT03                        6S 0
     d  W2EH03                        4
     d  W2VT03                       30
     d  W2FT04                       28
     d  W2NT04                        6S 0
     d  W2EH04                        4
     d  W2VT04                       30
     d  W2FT05                       28
     d  W2NT05                        6S 0
     d  W2EH05                        4
     d  W2VT05                       30
     d  W2FT06                       28
     d  W2NT06                        6S 0
     d  W2EH06                        4
     d  W2FT07                       28
     d  W2NT07                        6S 0
     d  W2EH07                        4
     d  W2TOP1                       17
     d  W2CRE1                        3
     d  W2TOP2                       17
     d  W2CRE2                        3
     d  W2TOP3                       17
     d  W2CRE3                        3
     d  W2TOP4                       17
     d  W2CRE4                        3
     d  W2TOP5                       17
     d  W2CRE5                        3
     d  W2TOP6                       17
     d  W2CRE6                        3
     d  W2TOP7                       17
     d  W2CRE7                        3
     d  W2TOP8                       17
     d  W2CRE8                        3
     d  W2TOP9                       17
     d  W2CRE9                        3
     d  W2TOP10                      17
     d  W2CRE10                       3

      *get input-string
      /copy syspeds/qrpgsrcpy,prolog3
        /free

        // Parse input
         exsr Parse;
        // Open files etc
         exsr Init;

       gethtmlifs(
       '/syspeddev/html/JSON.html':
       '/CGITAG/');
       wrtsection('top');

       //...........................................................................................
       //skriv JSON-Object start (alltid '{' + x ant param. m/komma mellom (IKKE komma etter siste))
       //...........................................................................................

        JSONstring='{'
        +'¬user¬ : ¬'+%trim(WSUSER)+'¬, '
        +'¬levenr¬ : ¬'+%trim(WLEVA)+'¬, '
        +'¬varnr¬ : ¬'+%trim(VARNR)+'¬, '
        +'¬errMsg¬ : ¬'+%trim(Error)+'¬, ';

       //JSONfix escaper " i tekst,  for deretter å bytte ¬->"

       jsonfix ( jsonstring );

       updhtmlvar2('JSONstring'
                  :%addr(jsonstring)
                  :%len(jsonstring));
       wrtsection('JSONlin');

       //...........................................................................................
       // Skriv JSON-LISTE Start (en liste er EN parameter(fra [ til   )
       //..........................................................................................
       jsonstring ='"kundvarlist" : [';

       updhtmlvar2('JSONstring'
                  :%addr(jsonstring)
                  :%len(jsonstring));
       wrtsection('JSONlin');

       if error = *blanks;
         // Hæmta til array
         exsr sok;
         // Les array
         exsr lesarr;
       endif;
       // ..........................................................................................
       // Skriv JSON-Liste/Array  Avslutning
       // ..........................................................................................
       jsonstring =']';
       updhtmlvar2('JSONstring'
                  :%addr(jsonstring)
                  :%len(jsonstring));
       wrtsection('JSONlin');
       // ..........................................................................................
       // Skriv JSON-string Avsluttning
       // ..........................................................................................
       jsonstring ='}';
       updhtmlvar2('JSONstring'
                  :%addr(jsonstring)
                  :%len(jsonstring));
       wrtsection('JSONlin');

       // Quit
       exsr exit;

       //=====================================================================
       // Close output html and quit
       //=====================================================================
       begsr exit;
         // Lukk fil
         close bridf;

         // Do not delete the call to wrtsection with section name *fini.  It is needed
         // to ensure that all output html that has been buffered gets output.
         wrtsection('*fini');
         // Quit
         *inlr = *on;
         return;
       endsr;
       //********************************************************
       begsr parse;
       //********************************************************
       // Get input
         wsuser  = zhbgetvar('USER');
         wleva = zhbgetvar('LEVENR');
         wlevn = c2n2(wleva);
         varnr = zhbgetvar('VARNR');

       endsr;
       //********************************************************
       begsr init;
       //********************************************************
         open bridf;
         // Test innlogging
         chain wsuser bridf;
         *in50 = not %found;

         if *in50 = *off;
           if bilibl = *blanks;
             incgi ( bistdl );
           else;

             Monitor;
                   Varpgm();
                 On-Error;
                   //
                 EndMon;

           endif;
         else;

           error = 'Invalid userID';
         endif;

       endsr;
        // __________________________________________________
        // Kør SQL in i array                             SOK
        // """"""""""""""""""""""""""""""""""""""""""""""""""
           begsr sok;

          exec sql declare  A33  cursor for

          SELECT VARENR, VAREBE, W2VF, W2LK, W2VNTI, W2TN, W2PRE, W2BELT,
          W2VKTB, W2VKTN, W2NTM, W2PVA, W2AS, W2MFR, W2AKD1, W2ASV1, W2ASA1,
          W2AGR1, W2ABL1, W2BEL, W2AKD2, W2ASV2, W2ASA2, W2AGR2, W2ABL2,
          W2PROS, W2AKD3, W2ASV3, W2ASA3, W2AGR3, W2ABL3, W2VAL, W2AKD4,
          W2ASV4, W2ASA4, W2AGR4, W2ABL4, W2BELN, W2AKD5, W2ASV5, W2ASA5,
          W2AGR5, W2ABL5, W2AKD6, W2ASV6, W2ASA6, W2AGR6, W2ABL6, W2AKD7,
          W2ASV7, W2ASA7, W2AGR7, W2ABL7, W2AKD8, W2ASV8, W2ASA8, W2AGR8,
          W2ABL8, W2FT01, W2NT01, W2EH01, W2VT01, W2FT02, W2NT02, W2EH02,
          W2VT02, W2FT03, W2NT03, W2EH03, W2VT03, W2FT04, W2NT04, W2EH04,
          W2VT04, W2FT05, W2NT05, W2EH05, W2VT05, W2FT06, W2NT06, W2EH06,
          W2FT07, W2NT07, W2EH07, W2TOP1, W2CRE1, W2TOP2, W2CRE2, W2TOP3,
          W2CRE3, W2TOP4, W2CRE4, W2TOP5, W2CRE5, W2TOP6, W2CRE6, W2TOP7,
          W2CRE7, W2TOP8, W2CRE8, W2TOP9, W2CRE9, W2TOP10, W2CRE10 FROM
          SADVARE
          WHERE upper(varenr) like
          upper('%' concat trim(:varnr) concat '%')
          AND LEVENR = :WLEVN FOR READ ONLY;

          exec sql open A33 ;

         Myrows = %elem(MyPoDS);
         exec sql FETCH A33   for :MyRows rows
                  INTO :MyPoDs;
       endsr;
        // __________________________________________________
        // Læs array                                   LESARR
        // """"""""""""""""""""""""""""""""""""""""""""""""""
           begsr lesarr;

               werr='X';

       for x = 1 to myrows;


             if %found;

             if mypods(x).varenr <> ' ';

        // Lægg ut Json stræng
           AntLest = AntLest + 1;

        // Skriv en JSON-Array-linje pr menypunkt - komma før hvert nytt element

       if AntLest=1;
          JSONstring=*blanks;
          else;
          JSONstring=', ';
          endif;
       JSONstring=%trim(JSONstring)+'{'
          +'¬varenr¬ : ¬'+%trim(mypods(x).varenr)+'¬, '
          +'¬varebe¬ : ¬'+%trim(mypods(x).varebe)+'¬, '
          +'¬w2vf¬ : ¬'+%trim(mypods(x).w2vf)+'¬, '
          +'¬w2lk¬ : ¬'+%trim(mypods(x).w2lk)+'¬, '
          +'¬w2vnti¬ : ¬'+%trim(mypods(x).w2vnti)+'¬, '
          +'¬w2tn¬ : ¬'+%trim(mypods(x).w2tn)+'¬, '
          +'¬w2pre¬ : ¬'+%trim(mypods(x).w2pre)+'¬, '
          +'¬w2belt¬ : ¬'+%trim(%editc(mypods(x).w2belt:'4'))+'¬, '
          +'¬w2vktb¬ : ¬'+%trim(%editc(mypods(x).w2vktb:'4'))+'¬, '
          +'¬w2vktn¬ : ¬'+%trim(%editc(mypods(x).w2vktn:'4'))+'¬, '
          +'¬w2ntm¬ : ¬'+%trim(%editc(mypods(x).w2ntm:'Z'))+'¬, '
          +'¬w2pva¬ : ¬'+%trim(mypods(x).w2pva)+'¬, '
          +'¬w2as¬ : ¬'+%trim(%editc(mypods(x).w2as:'4'))+'¬, '
          +'¬w2mfr¬ : ¬'+%trim(mypods(x).w2mfr)+'¬, '
          +'¬w2akd1¬ : ¬'+%trim(mypods(x).w2akd1)+'¬, '
          +'¬w2asv1¬ : ¬'+%trim(mypods(x).w2asv1)+'¬, '
          +'¬w2asa1¬ : ¬'+%trim(%editc(mypods(x).w2asa1:'4'))+'¬, '
          +'¬w2agr1¬ : ¬'+%trim(%editc(mypods(x).w2agr1:'4'))+'¬, '
          +'¬w2abl1¬ : ¬'+%trim(%editc(mypods(x).w2abl1:'4'))+'¬, '
          +'¬w2bel¬ : ¬'+%trim(%editc(mypods(x).w2bel:'4'))+'¬, '
          +'¬w2akd2¬ : ¬'+%trim(mypods(x).w2akd2)+'¬, '
          +'¬w2asv2¬ : ¬'+%trim(mypods(x).w2asv2)+'¬, '
          +'¬w2asa2¬ : ¬'+%trim(%editc(mypods(x).w2asa2:'4'))+'¬, '
          +'¬w2agr2¬ : ¬'+%trim(%editc(mypods(x).w2agr2:'4'))+'¬, '
          +'¬w2abl2¬ : ¬'+%trim(%editc(mypods(x).w2abl2:'4'))+'¬, '
          +'¬w2pros¬ : ¬'+%trim(%editc(mypods(x).w2pros:'4'))+'¬, '
          +'¬w2akd3¬ : ¬'+%trim(mypods(x).w2akd3)+'¬, '
          +'¬w2asv3¬ : ¬'+%trim(mypods(x).w2asv3)+'¬, '
          +'¬w2asa3¬ : ¬'+%trim(%editc(mypods(x).w2asa3:'4'))+'¬, '
          +'¬w2agr3¬ : ¬'+%trim(%editc(mypods(x).w2agr3:'4'))+'¬, '
          +'¬w2abl3¬ : ¬'+%trim(%editc(mypods(x).w2abl3:'4'))+'¬, '
          +'¬w2val¬ : ¬'+%trim(mypods(x).w2val)+'¬, '
          +'¬w2akd4¬ : ¬'+%trim(mypods(x).w2akd4)+'¬, '
          +'¬w2asv4¬ : ¬'+%trim(mypods(x).w2asv4)+'¬, '
          +'¬w2asa4¬ : ¬'+%trim(%editc(mypods(x).w2asa4:'4'))+'¬, '
          +'¬w2agr4¬ : ¬'+%trim(%editc(mypods(x).w2agr4:'4'))+'¬, '
          +'¬w2abl4¬ : ¬'+%trim(%editc(mypods(x).w2abl4:'4'))+'¬, '
          +'¬w2beln¬ : ¬'+%trim(%editc(mypods(x).w2beln:'4'))+'¬, '
          +'¬w2akd5¬ : ¬'+%trim(mypods(x).w2akd5)+'¬, '
          +'¬w2asv5¬ : ¬'+%trim(mypods(x).w2asv5)+'¬, '
          +'¬w2asa5¬ : ¬'+%trim(%editc(mypods(x).w2asa5:'4'))+'¬, '
          +'¬w2agr5¬ : ¬'+%trim(%editc(mypods(x).w2agr5:'4'))+'¬, '
          +'¬w2abl5¬ : ¬'+%trim(%editc(mypods(x).w2abl5:'4'))+'¬, '
          +'¬w2akd6¬ : ¬'+%trim(mypods(x).w2akd6)+'¬, '
          +'¬w2asv6¬ : ¬'+%trim(mypods(x).w2asv6)+'¬, '
          +'¬w2asa6¬ : ¬'+%trim(%editc(mypods(x).w2asa6:'4'))+'¬, '
          +'¬w2agr6¬ : ¬'+%trim(%editc(mypods(x).w2agr6:'4'))+'¬, '
          +'¬w2abl6¬ : ¬'+%trim(%editc(mypods(x).w2abl6:'4'))+'¬, '
          +'¬w2akd7¬ : ¬'+%trim(mypods(x).w2akd7)+'¬, '
          +'¬w2asv7¬ : ¬'+%trim(mypods(x).w2asv7)+'¬, '
          +'¬w2asa7¬ : ¬'+%trim(%editc(mypods(x).w2asa7:'4'))+'¬, '
          +'¬w2agr7¬ : ¬'+%trim(%editc(mypods(x).w2agr7:'4'))+'¬, '
          +'¬w2abl7¬ : ¬'+%trim(%editc(mypods(x).w2abl7:'4'))+'¬, '
          +'¬w2akd8¬ : ¬'+%trim(mypods(x).w2akd8)+'¬, '
          +'¬w2asv8¬ : ¬'+%trim(mypods(x).w2asv8)+'¬, '
          +'¬w2asa8¬ : ¬'+%trim(%editc(mypods(x).w2asa8:'4'))+'¬, '
          +'¬w2agr8¬ : ¬'+%trim(%editc(mypods(x).w2agr8:'4'))+'¬, '
          +'¬w2abl8¬ : ¬'+%trim(%editc(mypods(x).w2abl8:'4'))+'¬, '
          +'¬w2ft01¬ : ¬'+%trim(mypods(x).w2ft01)+'¬, '
          +'¬w2nt01¬ : ¬'+%trim(%editc(mypods(x).w2nt01:'Z'))+'¬, '
          +'¬w2eh01¬ : ¬'+%trim(mypods(x).w2eh01)+'¬, '
          +'¬w2vt01¬ : ¬'+%trim(mypods(x).w2vt01)+'¬, '
          +'¬w2ft02¬ : ¬'+%trim(mypods(x).w2ft02)+'¬, '
          +'¬w2nt02¬ : ¬'+%trim(%editc(mypods(x).w2nt02:'Z'))+'¬, '
          +'¬w2eh02¬ : ¬'+%trim(mypods(x).w2eh02)+'¬, '
          +'¬w2vt02¬ : ¬'+%trim(mypods(x).w2vt02)+'¬, '
          +'¬w2ft03¬ : ¬'+%trim(mypods(x).w2ft03)+'¬, '
          +'¬w2nt03¬ : ¬'+%trim(%editc(mypods(x).w2nt03:'Z'))+'¬, '
          +'¬w2eh03¬ : ¬'+%trim(mypods(x).w2eh03)+'¬, '
          +'¬w2vt03¬ : ¬'+%trim(mypods(x).w2vt03)+'¬, '
          +'¬w2ft04¬ : ¬'+%trim(mypods(x).w2ft04)+'¬, '
          +'¬w2nt04¬ : ¬'+%trim(%editc(mypods(x).w2nt04:'Z'))+'¬, '
          +'¬w2eh04¬ : ¬'+%trim(mypods(x).w2eh04)+'¬, '
          +'¬w2vt04¬ : ¬'+%trim(mypods(x).w2vt04)+'¬, '
          +'¬w2ft05¬ : ¬'+%trim(mypods(x).w2ft05)+'¬, '
          +'¬w2nt05¬ : ¬'+%trim(%editc(mypods(x).w2nt05:'Z'))+'¬, '
          +'¬w2eh05¬ : ¬'+%trim(mypods(x).w2eh05)+'¬, '
          +'¬w2vt05¬ : ¬'+%trim(mypods(x).w2vt05)+'¬, '
          +'¬w2ft06¬ : ¬'+%trim(mypods(x).w2ft06)+'¬, '
          +'¬w2nt06¬ : ¬'+%trim(%editc(mypods(x).w2nt06:'Z'))+'¬, '
          +'¬w2eh06¬ : ¬'+%trim(mypods(x).w2eh06)+'¬, '
          +'¬w2ft07¬ : ¬'+%trim(mypods(x).w2ft07)+'¬, '
          +'¬w2nt07¬ : ¬'+%trim(%editc(mypods(x).w2nt07:'Z'))+'¬, '
          +'¬w2eh07¬ : ¬'+%trim(mypods(x).w2eh07)+'¬, '
          +'¬w2top1¬ : ¬'+%trim(mypods(x).w2top1)+'¬, '
          +'¬w2cre1¬ : ¬'+%trim(mypods(x).w2cre1)+'¬, '
          +'¬w2top2¬ : ¬'+%trim(mypods(x).w2top2)+'¬, '
          +'¬w2cre2¬ : ¬'+%trim(mypods(x).w2cre2)+'¬, '
          +'¬w2top3¬ : ¬'+%trim(mypods(x).w2top3)+'¬, '
          +'¬w2cre3¬ : ¬'+%trim(mypods(x).w2cre3)+'¬, '
          +'¬w2top4¬ : ¬'+%trim(mypods(x).w2top4)+'¬, '
          +'¬w2cre4¬ : ¬'+%trim(mypods(x).w2cre4)+'¬, '
          +'¬w2top5¬ : ¬'+%trim(mypods(x).w2top5)+'¬, '
          +'¬w2cre5¬ : ¬'+%trim(mypods(x).w2cre5)+'¬, '
          +'¬w2top6¬ : ¬'+%trim(mypods(x).w2top6)+'¬, '
          +'¬w2cre6¬ : ¬'+%trim(mypods(x).w2cre6)+'¬, '
          +'¬w2top7¬ : ¬'+%trim(mypods(x).w2top7)+'¬, '
          +'¬w2cre7¬ : ¬'+%trim(mypods(x).w2cre7)+'¬, '
          +'¬w2top8¬ : ¬'+%trim(mypods(x).w2top8)+'¬, '
          +'¬w2cre8¬ : ¬'+%trim(mypods(x).w2cre8)+'¬, '
          +'¬w2top9¬ : ¬'+%trim(mypods(x).w2top9)+'¬, '
          +'¬w2cre9¬ : ¬'+%trim(mypods(x).w2cre9)+'¬, '
          +'¬w2top10¬ : ¬'+%trim(mypods(x).w2top10)+'¬, '
          +'¬w2cre10¬ : ¬'+%trim(mypods(x).w2cre10)+'¬}';
        //end-free
        //free
         jsonfix (JSONstring);
        //end-free
       updhtmlvar2('JSONstring'
                  :%addr(jsonstring)
                  :%len(jsonstring));
         wrtsection ('JSONlin');

             endif;
             endif;
        endfor;

       endsr;
      /end-free
