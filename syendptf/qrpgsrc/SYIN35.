********************************************************************
      * RETTINGER I DETTE PROGRAM:
      * LESER ALLE LINJER MED kbnøkk=4
      * skal deretter settes til 1 for kontering avdeling oppdrag
PTFnr:*Sek Sig Vers  Beskrivelse...........................
""""""*"""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""
10XXX * 01 SH
********************************************************************
      *
      *****************************************************************
      *** PROGRAM SKAL viderekontere interimsførte                  ***
      *****************************************************************
     FSYSRL01   UF   E           K DISK                                         X010
     FFIRMTEL   UF A E           K DISK                                         X010
     FKOSBL01   O  A E           K DISK
     FKOSAL01   O  A E           K DISK
     FKODTÅ     IF   E           K DISK
N06  Flevel01   IF   E           K DISK
N06  FSTED2     IF   E           K DISK
N06  FKODTA     IF   E           K DISK
N06  FKODTS2    IF   E           K DISK
N06  FKODTGE    IF   E           K DISK
N06  FKODTG2    IF   E           K DISK
N06  FKODTG3    IF   E           K DISK
     FHEADF     IF   E           K DISK
     FFIRM      IF   E           K DISK
     FFIRMINT   IF   E           K DISK
     FFAKT      UF a E           K DISK
     FKOSTB8    UF   E           K DISK
     FKOSTA     IF   E           K DISK
     FGSSORF    IF   E           K DISK
      *___________________________
      * Finner username
      *"""""""""""""""""""""""""""
     D                SDS
     D  ZUSER                254    263
     D                 DS
     D  KBGEBY                 1      1  0
     D  KBNØKK                 2      2  0
     D  GEBNØK                 1      2
N02  D                 DS
N02  D  XTIME                  1     14  0
N02  D  XTM                    1      6  0
N02  D  XDG                    7      8  0
N02  D  XMN                    9     10  0
N02  D  XÅR                   11     14  0
N02  D                 DS
N02  D  KADTE                  1      8  0
N02  D  KAÅRE                  1      4  0
N02  D  KAMNE                  5      6  0
N02  D  KADGE                  7      8  0
N02  D                 DS
N02  D  KBBILT                 1     15
N02  D  SIKOL                  1      3
N02  D  SSORDRE                4     10  0
     D                 DS
     D  MINPER                 1      6  0
     D  KOÅCC                  1      2  0
     D  KOÅÅR                  3      4  0
     D  KOÅMND                 5      6  0
     D  MINAAR                 1      4  0
     D  MINMND                 5      6  0
     D                 DS
     D  AARMND                 1      6  0
     D  AAR                    1      4  0
     D  MND                    5      6  0
     D                 DS
     D  BILAAR                 1      4  0
     D  BILMND                 5      6  0
     D  BILDAG                 7      8  0
     D  KABDT                  1      8  0

      *
      * føre bilag
      *
     C                   EXSR      INIT
     C                   EXSR      INTERI
      *
     C     SLUTT         TAG
     C                   SETON                                        LR
     C                   RETURN
      ***********************************************
     C     INIT          BEGSR
      ***********************************************
     C     *entry        plist
     C* Hvis pgm returnerer med '1' i UFLAGG er det ingen poster å
     C* overføre-CL vil avbryte- Minst en post->UFLAGG blir ' '.
     C                   parm                    uflagg            1
     C                   MOVE      '1'           UFLAGG
     C*--------------------------------------------------------------
     C* DEFINERER NØKKEL TIL SYSRL01
     C*--------------------------------------------------------------
     C     SYSRKE        KLIST
     C                   KFLD                    FIFIRM
     C                   KFLD                    REGNA
     C                   MOVE      'SYS   '      REGNA             6
     C*--------------------------------------------------------------
     C     KODÅKE        KLIST
     C                   KFLD                    KOÅUNI
     C                   KFLD                    KOÅCC
     C                   KFLD                    KOÅÅR
     C                   KFLD                    KOÅMND
     C                   MOVE      'K'           KOÅUNI
     C     levkey        KLIST
     C                   KFLD                    FIFIRM
     C                   KFLD                    KALNR
     C     KODAKE        KLIST
     C                   KFLD                    KOAUNI
     C                   KFLD                    KBAVD
     C                   MOVE      'A'           KOAUNI
     C     GEBKE2        KLIST
     C                   KFLD                    KG2UNI
     C                   KFLD                    KG2KOD
     C                   MOVE      'G2'          KG2UNI
     C     GEBKEY        KLIST
     C                   KFLD                    KGEUNI
     C                   KFLD                    KGEKOD
     C                   MOVE      'GE'          KGEUNI
N06  C     GEBKEYE       KLIST
N06  C                   KFLD                    EUKODE
N06  C                   KFLD                    KGEKOD
      *
     c     fakkey        klist
     c                   kfld                    faavd
     c                   kfld                    faopd
      *
     C     KEYKOST       KLIST
     C                   KFLD                    KBNØKKE           1 0
     C                   z-add     4             KBNØKKE
     c                   read      firm                                   33
     c     fifirm        chain     firmint                            33
      *
      * hent neste journalnummer
      *
     C     FIFIRM        CHAIN     FIRMTEL                            33
     C                   ADD       1             FIJOU2
     C  N33              UPDATE    FIRMTR
     C   33              WRITE     FIRMTR
     C*
     C*
     C* HENTER MINSTE ÅPNE PERIODE og legger i minper
     C*
     c                   move      *zeros        minper
     c                   move      *zeros        aarmnd
     C     KODÅKE        SETLL     KODTÅ
     C     'K'           READE     KODTÅ                                  33
     C     *IN33         IFEQ      '1'
     C     UYEAR         IFGT      50
     C     UYEAR         ADD       1900          MINPER            6 0
     C                   ELSE
     C     UYEAR         ADD       2000          MINPER
     C                   END
     C                   MULT      100           MINPER
     C                   MOVE      UMONTH        MINPER
     C                   END
     C*
     C     FITAX         ADD       1             FITAXN            5 4
     C                   Move      FITAXN        FITAXORI          5 4
     C                   ENDSR
      ***********************************************
     C     INTERI        BEGSR
      ***********************************************
      *
     C     KEYKOST       SETLL     KOSTB8
     C     *in33         doweq     '0'
     C     KEYKOST       READE     KOSTB8                                 33
     C     *in33         ifeq      '0'
     C     SIKOL         andeq     'SI:'
     C     KBKDM         IFEQ      1                                             2<-B
     C     KBKDPF        andeq     'P'
     C                   MOVE      FITAXOri      FITAXN
     C                   DIV(H)    FITAXN        KBBLHB
     C                   end
     C     ssordre       chain     gssorf                             34
     C     *in34         ifeq      '0'
     c**   kbbnr         ifeq      187487
     C     ORTNO         andne     *zeros
     C                   EXSR      TESTFA
     C     faktur        ifeq      'J'
     C                   Z-ADD     1             KBNØKK
     c                   movel     faavd         KBAVD
     c                   move      faopd         KBOPD
     C                   UPDATE    KOSTBR
     c***********        seton                                        33
     c**                 end
     c                   end
     C                   endif
     C                   endif
     C                   enddo
     C                   ENDSR
      ***********************************************
     C     TESTFA        BEGSR
      ***********************************************
     c                   move      'N'           faktur            1
      *
     C     kbbnr         chain     kosta                              33
     c     *IN33         IFEQ      '0'
     C     LEVKEY        CHAIN     LEVEL01                            33
     c                   movel     ortno         faavd
     c                   move      ortno         faopd
     c                   movel     ortno         kbavd
     c                   move      ortno         kbopd
     C     fakkey        chain     headf                              33
     c     *IN33         IFEQ      '0'
N06  C                   EXSR      EUSR
     C                   SETOFF                                       44
     C     FAKKEY        SETLL     FAKT
     C     *in44         DOWEQ     '0'
     C     FAKKEY        READE     FAKT                                   44
     C     *IN44         IFEQ      '0'
     C     FAKDA         ANDNE     'K'
     C     FAOPKO        ANDEQ     'O'
     C*
     C                   MOVE      '0'           UFLAGG
     C                   MOVE      'J'           FAKTUR
      * prøver å føre på periode = utfakturert periode
     C                   MOVEL     20            PERAAR            4 0
     C                   MOVEL     20            AAR
     C                   MOVE      FAÅR          AAR
     C                   Z-ADD     FAMND         MND
      * periode åpen?
     C     AARMND        IFLT      MINPER
     C                   Z-add     MINAAR        PERAAR
     C                   z-add     MINMND        PERNR
     C                   else
     c                   z-add     AAR           PERAAR
     c                   z-add     MND           PERNR
     c                   end
      * tar fakturadato fra utgående faktura
     C                   Z-ADD     FADATO        KABDT
      *
      * TØMMER UTFIL SYSPED
     C                   CLEAR                   FAKTR
     C                   exsr      finnku
     C                   EXSR      KONTOSR
     C                   GOTO      UTSR
     C                   ENDIF
     C                   ENDDO
     C                   endif
     C                   endif
     C     UTSR          ENDSR
     C*
      ***********************************************
     C     FINNKU        BEGSR
      ***********************************************
     c                   move      *zeros        kbkn
     C                   SELECT
     C     HEUR          WHENEQ    'H'
     C                   MOVE      HEKNSF        KBKN
     C     KBKN          IFEQ      *ZEROS
     C                   MOVE      HEKNKF        KBKN
     C                   END
     C     HEUR          WHENEQ    'A'
     C     HEUR          OREQ      'C'                                          IMPORT
     C     HEUR          OREQ      'F'
     C     hekdfk        ifne      'X'
     C                   MOVE      HEKNKF        KBKN
     c                   end
     C     KBKN          IFEQ      *ZEROS
     C                   MOVE      HEKNSF        KBKN
     C                   END
     C     HEUR          WHENEQ    'B'                                          EKSPORT
     C     HEUR          OREQ      'D'
     C     HEUR          OREQ      'G'
     C     hekdfs        ifne      'X'
     C                   MOVE      HEKNSF        KBKN
     c                   end
     C     KBKN          IFEQ      *ZEROS
     C                   MOVE      HEKNKF        KBKN
     C                   END
     C                   ENDSL
     C                   ENDSR
      ***********************************************************
     c     kontosr       begsr
      ***********************************************************
     C                   MOVE      'H'           TYPE              1
     C                   Z-ADD     0             KONTO             5 0
     C                   Z-ADD     0             KBARER            4 0
     C                   Z-ADD     0             KSTED             4 0
     C                   MOVE      'H'           TYPE
     C                   MOVE      KBVK          KGEKOD
     C     GEBKEY        CHAIN     KODTGE                             11
     C                   MOVE      KBVK          KG2KOD
     C     GEBKE2        CHAIN     KODTG2                             11
N06  C  N11EUKODE        IFNE      *BLANKS
N06  C     GEBKEYE       CHAIN     KODTG3                             11
N06  C                   SETOFF                                       11
N06  C                   END
     C  N11              MOVE      KG2UTG        KONTO
     C   11              Z-ADD     99999         KONTO
      * BÆRER OG STED
     C     KODAKE        CHAIN     KODTA                              33
     C   33              MOVE      *ZEROS        KSTED
     C   33              MOVE      *ZEROS        KBARER
     C  N33              Z-ADD     KOAKON        KSTED
     C  N33              Z-ADD     KOABÆR        KBARER
      * SKRIVER TIL FAKTURAFIL
     c                   EXSR      TILSYSP
     C                   ENDSR
N06  C***********************************************
N06  C     EUSR          BEGSR
N06  C***********************************************
N06  C                   MOVE      *BLANKS       EUKODE            1
N06   * SPESIALKONTERING EU
N06  C     KODTS2K       KLIST
N06  C                   KFLD                    KS2UNI
N06  C                   KFLD                    KS2LK
N06  C                   MOVEL     'S2'          KS2UNI
N06  C
N06   *
N06   * unntak for eu (KS2PRE=B)
N06   *
N06  C                   MOVE      FILAND        KS2LK
N06  C     KODTS2K       CHAIN     KODTS2                             33
N06   *
N06   * EGET LAND ER EU
N06   *
N06  C  N33KS2PRE        IFEQ      'B'
N06   *
N06   *   IMPORT
N06   *
N06  C     HEUR          IFEQ      'A'
N06  C     HEUR          OREQ      'C'
N06  C     HEUR          OREQ      'F'
N06  C                   MOVE      HELKA         FIRLKF
N06  C     KOAPOS        IFEQ      'J'
N06  C                   MOVE      FILAND        FIRLKT
N06  C                   ELSE
N06  C     HESDT         CHAIN     STED2                              33
N06  C                   MOVE      ST2LK         FIRLKT
N06  C                   END
N06  C                   END
N06   *
N06   *   EKSPORT
N06   *
N06  C     HEUR          IFEQ      'B'
N06  C     HEUR          OREQ      'D'
N06  C     HEUR          OREQ      'G'
N06  C                   MOVE      HELKA         FIRLKT
N06  C     KOAPOS        IFEQ      'J'
N06  C                   MOVE      FILAND        FIRLKF
N06  C                   ELSE
N06  C     HESDT         CHAIN     STED2                              33
N06  C                   MOVE      ST2LK         FIRLKF
N06  C                   END
N06  C                   END
N06   *
N06   * TRANSPORTDISPONERING
N06   *
N06  C     HEUR          IFEQ      'H'
N06  C                   MOVE      HELKA         FIRLKF            2
N06  C                   MOVE      HETRI         FIRLKT            2
N06  C                   END
N06   *
N06   * DOMESTIC
N06   *
N06  C     FILAND        IFEQ      FIRLKF
N06  C     FILAND        ANDEQ     FIRLKT
N06  C                   MOVE      'D'           EUKODE
N06  C                   END
N06   *
N06   *
N06   * TRANSIT  BEGGE LAND I EU
N06   *
N06  C     FIRLKF        IFNE      FIRLKT
N06  C                   MOVE      FIRLKF        KS2LK
N06  C     KODTS2K       CHAIN     KODTS2                             33
N06  C  N33KS2PRE        IFEQ      'B'
N06  C                   MOVE      FIRLKT        KS2LK
N06  C     KODTS2K       CHAIN     KODTS2                             33
N06  C  N33KS2PRE        IFEQ      'B'
N06  C                   MOVE      'T'           EUKODE
N06  C                   END
N06  C                   END
N06  C                   END
N06   *
N06  C                   END
N06  C                   SETOFF                                       33
N06  C                   ENDSR
N06  C***********************************************
N06  C     TILSYSP       BEGSR
N06  C***********************************************
     C                   Z-ADD     FIJOU2        FAJOUR
     C                   MOVE      KABNR2        FAFAKT
     C                   MOVE      'K'           FAKDA
     C                   MOVE      KBAVD         FAAVD
     C                   MOVE      KBOPD         FAOPD
     C                   Z-ADD     KABDT         FADATO
     C                   Z-ADD     KAFFDT        FADAFF
     C                   Z-ADD     KBKN          FAKUNR
     C                   Z-ADD     KALNR         FALEVN
     C                   Z-ADD     KAPCC         FACC
     C                   Z-ADD     PERAAR        FAÅR
     C                   Z-ADD     PERNR         FAMND
     C                   MOVE      KSTED         FAAVDR
     C                   MOVE      KBARER        FABÆR
     C                   MOVE      KONTO         FAACCN
     c                   move      'N'           fakdm
     C                   MOVE      *ZEROS        FALI
     C                   CALL      'SYGE06'
     C                   PARM                    FAAVD
     C                   PARM                    FAOPD
     C                   PARM                    FALI
     C     KBKN          IFEQ      HEKNSF                                       1B
     C                   MOVE      'S'           FASK
     C                   ELSE
     C     KBKN          IFEQ      HEKNKF                                       2B
     C                   MOVE      'K'           FASK
     C     HEUR          IFEQ      'D'                                           3B
     C     HESAML        ANDEQ     *BLANKS
     C                   MOVE      'F'           FASK
     C                   END                                                     3E
     C                   ELSE
     C                   MOVE      'X'           FASK
     C                   END                                                    2E
     C                   END                                                    1E
     C* På fakturalinja skal det opprinnelig KBVK (ikke evt. bilkode)
     C                   MOVE      kbvk          FAVK
     C                   MOVEL     LNAVN         FAVT
     C     KBBILT        IFNE      *BLANKS
     C                   MOVE      SSORDRE       FAVT
     C                   END
     C                   MOVE      KBKKEY        TURAVR            7
     C                   MOVE      KAVAL         FAVAL
     C                   MOVE      KAVAL         FACURI
     C                   Z-SUB     KBBLHB        FABELN
     C                   Z-SUB     KBBLHB        FABELV
     C                   move      'O'           faopko
     C     KAVAL         IFNE      '   '
     C     KAVAL         ANDNE     FICURR
     C     KAVKU         DIV       KAOMRF        XFAKT             9 6
N07  C     FABELN        DIV(H)    XFAKT         FABELV
     C                   END
     C                   WRITE     FAKTR
     C                   EXSR      postasr
     C                   EXSR      postbsr
     C                   ENDSR
N06  C***********************************************
N06  C     POSTBSR       BEGSR
N06  C***********************************************
      * skriver først kostnadsposten
n04  C                   MOVE      'H'           TYPE
n04  c                   z-sub     fabeln        bbelop
n04  c                   z-sub     fabelv        belopv
     c                   move      faval         valkox
     C     VALKOX        IFEQ      'NOK'
     c                   move      *blanks       valkox
     c                   end
n04  c                   eval      biltxt=KBBILT
n04  C                   MOVE      '0'           MOMSK
n04  C                   EXSR      GETSUR
N23  C                   z-add     kavku         valku1
A38  C                   div       kaomrf        valku1
     C                   exsr      valsr
     C                   ADD       1             POSNR
n04  C                   WRITE     KOSBR
      * motpost
      * interimskonto uten mva
N25  c                   Z-ADD     INKONU        KONTO
     c                   z-add     0             ksted
     c                   z-add     0             kbarer
n04  c                   z-sub     bbelop        bbelop
n04  c                   z-sub     belopv        belopv
n04  C                   EXSR      GETSUR
     c                   exsr      valsr
     C                   ADD       1             POSNR
n04  C                   WRITE     KOSBR
     c                   endsr
N06  C***********************************************
N06  C     POSTASR       BEGSR
N06  C***********************************************
     C                   MOVE      'A'           AKTKOD
     C                   MOVE      FIFIRM        FIRMA
     C*                  MOVEL     KAPCC         PERAAR
     C*                  MOVE      KAPÅR         PERAAR
     C*                  MOVE      KAPÅR         PERAA2            2 0
     C*                  MOVE      KAPMN         PERNR
     C                   MOVE      *BLANKS       VALKOX
     C                   z-add     kabnr2        BILNR
     C                   EXSR      GETSUR
N23  C                   z-add     kavku         valku1
A38  C                   div       kaomrf        valku1
     C                   WRITE     KOSAR
     C                   endsr
     C******************************************
     C     GETSUR        BEGSR
     C******************************************
     C*
     C* HENT NYTT SURRUGATNR - FRA SYSRF LEGG I "POSLNR"
     C*
     C*
     C     SYSRKE        CHAIN     SYSRL01                            30
     C  N30              ADD       1             SISSGT
     C  N30              UPDATE    SYSRR
     C                   Z-ADD     SISSGT        POSLNR
     C                   ENDSR
N23  C***********************************************
N23  C     VALSR         BEGSR
N23  C***********************************************
N23   * BBELOP TIL NBELPO
N23  c                   z-add     bbelop        nbelpo
N23  c     valkox        ifne      *blanks
N23  c     belopv        andne     *zeros
N23  c                   z-add     BELOPV        nbelpo
N23  c                   end
N23  C                   ENDSR
