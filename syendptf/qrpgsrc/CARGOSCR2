********************************************************************
      * RETTINGER I DETTE PROGRAM:
PTFnr:*Sek Sig Vers  Beskrivelse...........................
""""""*"""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""
10XXX * 01 JOV PTF10 Kolli Finnes på samme term = Update/ÅPNE ved å blanke avd/opd
10XXX * 02 Fjerne flere kolli-id i samme post / se etter LMindikator / image source
10XXX *           (fysisk fjernet )
      *%%%%%%%%%%%
      * 03 JOV PTF12 Trigge ny summeringupdate kun ved endring
      * 04 JOV PTF12 Dato/tid kun ved ny/første gang
********************************************************************
     H DATEDIT(*YMD)
     FQ3        IF   F 1024        DISK
     FCARGOF    UF A E           K DISK
     D A               S              1    DIM(79)
     D B               S              1    DIM(18)
      *________________________
      * DS for decimal handling
      *""""""""""""""""""""""""
     D                 DS
     D  ZDEC                   1      7  6
     D  ZDEC6                  2      7
     D  ZHEL                  11     22  0
     D                 DS
     D  Data                   1   1024
N02  D  Data1_5                1      5
     D  DTA                    1   1024
     D                                     DIM(1024)
     D                 DS
     D  Felt                   1     50
     D  FE                     1     50
     D                                     DIM(50)
     IQ3        NC  01
     I                                  1 1024  csdata
      *
     C                   EXSR      MAIN
      *
     C                   MOVE      '1'           *INLR
     C                   RETURN
      *************************************************
     C     MAIN          BEGSR
      *************************************************
      *
     C                   READ      Q3                                     33
     C     *IN33         DOWEQ     '0'
N02  C                   eval      Data  = CsData
N02  c     Data1_5       ifeq      'PLACE'
      * Splitt semikol-separert til faste felt
     C                   EXSR      FELTSR
      * Oppdater i CARGOF mm.
     C                   EXSR      OppDat
N02  c                   endif
      *
     C                   READ      Q3                                     33
     C                   END
      *
      * ALLE DETALJPOSTER LEST/MERKET...
      * LES WORKFILE MED ALLE BERØRTE FRAKTBREV OG OPPDATER T&T.
     C                   ENDSR
      *
      *
      *************************************************
     C     FELTSR        BEGSR
      *************************************************
S02  C*                  eval      Data  = CsData
      *
     C                   CLEAR                   SCA_PLACE        20
     C                   CLEAR                   SCA_STATION      20
     C                   CLEAR                   SCA_DATETIME     14
     C                   CLEAR                   SCA_SEQUENCE      5
     C                   CLEAR                   SCA_STATUS        3
     C                   CLEAR                   SCA_UNITS         1
     C                   CLEAR                   SCA_WEIGHT       10
     C                   CLEAR                   SCA_LENGTH       10
     C                   CLEAR                   SCA_WIDTH        10
     C                   CLEAR                   SCA_HEIGHT       10
     C                   CLEAR                   SCA_VOLUME       10
     C                   CLEAR                   SCA_MODE         10
     C                   CLEAR                   SCA_BARCTMP      20
     C                   CLEAR                   SCA_BARCODE      20
     C                   CLEAR                   SCA_BARCODE2     20
     C                   CLEAR                   SCA_BARCODE3     20
     C                   CLEAR                   SCA_BARCODE4     20
     C                   CLEAR                   SCA_BARCODE5     20
N02  C                   CLEAR                   SCA_LMINDIC       1            NON-STACKABLE = 1
N02  C                   CLEAR                   SCA_PATH         35
      *
      * 1 PLACE=
      *   Hopp forbi ledetekst../skipp foranstilte blanke
     C                   Z-ADD     7             NR                3 0
     C                   EXSR      SkipBlank
     C                   Z-ADD     1             N2                2 0
     C                   MOVE      *BLANKS       FELT
     C     DTA(NR)       DOWNE     ';'
     C                   MOVE      DTA(NR)       FE(N2)
     C                   ADD       1             NR
     C                   ADD       1             N2
     C                   END
     C                   MOVEL     FELT          SCA_PLACE
      * Står nå på semikolon - sett peker 1 forbi
     C                   ADD       1             NR
      *
      * 2 STATION=
      *   Hopp forbi ledetekst../skipp foranstilte blanke
     C                   ADD       8             NR
     C                   EXSR      SkipBlank
     C                   Z-ADD     1             N2
     C                   MOVE      *BLANKS       FELT
     C     DTA(NR)       DOWNE     ';'
     C                   MOVE      DTA(NR)       FE(N2)
     C                   ADD       1             NR
     C                   ADD       1             N2
     C                   END
     c                   MOVEL     FELT          SCA_STATION
      * Står nå på semikolon - sett peker 1 forbi
     C                   ADD       1             NR
      *
      * 3 DATETIME=
      *   Hopp forbi ledetekst../skipp foranstilte blanke
     C                   ADD       9             NR
     C                   EXSR      SkipBlank
     C                   Z-ADD     1             N2
     C                   MOVE      *BLANKS       FELT
     C     DTA(NR)       DOWNE     ';'
     C                   MOVE      DTA(NR)       FE(N2)
     C                   ADD       1             NR
     C                   ADD       1             N2
     C                   END
     c                   MOVEL     FELT          SCA_DATETIME
      * Står nå på semikolon - sett peker 1 forbi
     C                   ADD       1             NR
      *
      * 4 SEQUENCE=
      *   Hopp forbi ledetekst../skipp foranstilte blanke
     C                   ADD       9             NR
     C                   EXSR      SkipBlank
     C                   Z-ADD     1             N2
     C                   MOVE      *BLANKS       FELT
     C     DTA(NR)       DOWNE     ';'
     C                   MOVE      DTA(NR)       FE(N2)
     C                   ADD       1             NR
     C                   ADD       1             N2
     C                   END
     c                   MOVEL     FELT          SCA_SEQUENCE
      * Står nå på semikolon - sett peker 1 forbi
     C                   ADD       1             NR
      *
      * 5 STATUS=
      *   Hopp forbi ledetekst../skipp foranstilte blanke
     C                   ADD       7             NR
     C                   EXSR      SkipBlank
     C                   Z-ADD     1             N2
     C                   MOVE      *BLANKS       FELT
     C     DTA(NR)       DOWNE     ';'
     C                   MOVE      DTA(NR)       FE(N2)
     C                   ADD       1             NR
     C                   ADD       1             N2
     C                   END
     c                   MOVEL     FELT          SCA_STATUS
      * Står nå på semikolon - sett peker 1 forbi
     C                   ADD       1             NR
      *
      * 6 UNITS=
      *   Hopp forbi ledetekst../skipp foranstilte blanke
     C                   ADD       6             NR
     C                   EXSR      SkipBlank
     C                   Z-ADD     1             N2
     C                   MOVE      *BLANKS       FELT
     C     DTA(NR)       DOWNE     ';'
     C                   MOVE      DTA(NR)       FE(N2)
     C                   ADD       1             NR
     C                   ADD       1             N2
     C                   END
     c                   MOVEL     FELT          SCA_UNITS
      * Står nå på semikolon - sett peker 1 forbi
     C                   ADD       1             NR
      *
      * 7 WEIGHT=
      *   Hopp forbi ledetekst../skipp foranstilte blanke
     C                   ADD       7             NR
     C                   EXSR      SkipBlank
     C                   Z-ADD     1             N2
     C                   MOVE      *BLANKS       FELT
     C     DTA(NR)       DOWNE     ';'
     C                   MOVE      DTA(NR)       FE(N2)
     C                   ADD       1             NR
     C                   ADD       1             N2
     C                   END
     c                   MOVEL     FELT          SCA_WEIGHT
      * Står nå på semikolon - sett peker 1 forbi
     C                   ADD       1             NR
      *
      * 8 LENGTH=
      *   Hopp forbi ledetekst../skipp foranstilte blanke
     C                   ADD       7             NR
     C                   EXSR      SkipBlank
     C                   Z-ADD     1             N2
     C                   MOVE      *BLANKS       FELT
     C     DTA(NR)       DOWNE     ';'
     C                   MOVE      DTA(NR)       FE(N2)
     C                   ADD       1             NR
     C                   ADD       1             N2
     C                   END
     c                   MOVEL     FELT          SCA_LENGTH
      * Står nå på semikolon - sett peker 1 forbi
     C                   ADD       1             NR
      *
      * 9 WIDTH=
      *   Hopp forbi ledetekst../skipp foranstilte blanke
     C                   ADD       6             NR
     C                   EXSR      SkipBlank
     C                   Z-ADD     1             N2
     C                   MOVE      *BLANKS       FELT
     C     DTA(NR)       DOWNE     ';'
     C                   MOVE      DTA(NR)       FE(N2)
     C                   ADD       1             NR
     C                   ADD       1             N2
     C                   END
     c                   MOVEL     FELT          SCA_WIDTH
      * Står nå på semikolon - sett peker 1 forbi
     C                   ADD       1             NR
      *
      * 10 HEIGHT=
      *   Hopp forbi ledetekst../skipp foranstilte blanke
     C                   ADD       7             NR
     C                   EXSR      SkipBlank
     C                   Z-ADD     1             N2
     C                   MOVE      *BLANKS       FELT
     C     DTA(NR)       DOWNE     ';'
     C                   MOVE      DTA(NR)       FE(N2)
     C                   ADD       1             NR
     C                   ADD       1             N2
     C                   END
     c                   MOVEL     FELT          SCA_HEIGHT
      * Står nå på semikolon - sett peker 1 forbi
     C                   ADD       1             NR
      *
      * 11 VOLUME=
      *   Hopp forbi ledetekst../skipp foranstilte blanke
     C                   ADD       7             NR
     C                   EXSR      SkipBlank
     C                   Z-ADD     1             N2
     C                   MOVE      *BLANKS       FELT
     C     DTA(NR)       DOWNE     ';'
     C                   MOVE      DTA(NR)       FE(N2)
     C                   ADD       1             NR
     C                   ADD       1             N2
     C                   END
     c                   MOVEL     FELT          SCA_VOLUME
      * Står nå på semikolon - sett peker 1 forbi
     C                   ADD       1             NR
      *
      * 12 MODE=
      *   Hopp forbi ledetekst../skipp foranstilte blanke
     C                   ADD       5             NR
     C                   EXSR      SkipBlank
     C                   Z-ADD     1             N2
     C                   MOVE      *BLANKS       FELT
     C     DTA(NR)       DOWNE     ';'
     C                   MOVE      DTA(NR)       FE(N2)
     C                   ADD       1             NR
     C                   ADD       1             N2
     C                   END
     c                   MOVEL     FELT          SCA_MODE
      * Står nå på semikolon - sett peker 1 forbi
     C                   ADD       1             NR
      * 13 BARCODE=
      *   Hopp forbi ledetekst..
S02   * før var det egen SR GETBAR - nå tatt inn i main flow
     C                   ADD       8             NR
     C                   EXSR      SkipBlank
     C                   Z-ADD     1             N2
     C                   MOVE      *BLANKS       FELT
      * I gammel versj er barcode siste felt (ikke semikoln) ...
     C     DTA(NR)       DOWNE     ' '
     C     DTA(NR)       ANDNE     ';'
     C                   MOVE      DTA(NR)       FE(N2)
     C                   ADD       1             NR
     C                   ADD       1             N2
     C                   END
     c                   MOVEL     FELT          SCA_BARCODE
      *
      * fins det flere kolonner/semikolon - gammel standard=flere clid / NY = NON-STACABLE...
N02  C     DTA(NR)       IFEQ      ';'                                          flere???
     C     NR            ADD       1             NR2               3 0
      * først tegnetter semicolon er N..
N02   * 14 NON-STACKABLE=  (FINNES LM-INDIKATOR???)
N02  C     DTA(NR2)      Ifeq      'N'
N02   * Står nå på semikolon - sett peker 1 forbi
N02  C                   ADD       1             NR
N02   *   Hopp forbi ledetekst../skipp foranstilte blanke
N02  C                   ADD       14            NR
N02  C                   EXSR      SkipBlank
N02  C                   Z-ADD     1             N2
N02  C                   MOVE      *BLANKS       FELT
N02  C     DTA(NR)       DOWNE     ';'
N02  C                   MOVE      DTA(NR)       FE(N2)
N02  C                   ADD       1             NR
N02  C                   ADD       1             N2
N02  C                   END
N02  c                   MOVEL     FELT          SCA_LMINDIC
N02   * 15 PATH=
N02   * Står nå på semikolon - sett peker 1 forbi
N02  C                   ADD       1             NR
N02   *   Hopp forbi ledetekst../skipp foranstilte blanke
N02  C                   ADD       5             NR
N02  C                   EXSR      SkipBlank
N02  C                   Z-ADD     1             N2
N02  C                   MOVE      *BLANKS       FELT
N02   * I ny versj (pallvekta) er barcode siste felt (ikke semikoln) ...
N02  C     DTA(NR)       DOWNE     ' '
N02  C     DTA(NR)       ANDNE     ';'
N02  C                   MOVE      DTA(NR)       FE(N2)
N02  C                   ADD       1             NR
N02  C                   ADD       1             N2
N02  C                   END
N02  c                   MOVEL     FELT          SCA_PATH
      * FØRSTE TEGN ETTER SEMI VAR IKKE 'N' DA ER DET FLER KOLLI-IDS
     c                   else
      * mer enn en barcode???
     c                   exsr      GETBAR
     c                   MOVEL     SCA_BARCTMP   SCA_BARCODE2
     C     DTA(NR)       IFEQ      ';'
     c                   exsr      GETBAR
     c                   MOVEL     SCA_BARCTMP   SCA_BARCODE3
     c                   end
     C     DTA(NR)       IFEQ      ';'
     c                   exsr      GETBAR
     c                   MOVEL     SCA_BARCTMP   SCA_BARCODE4
     c                   end
     C     DTA(NR)       IFEQ      ';'
     c                   exsr      GETBAR
     c                   MOVEL     SCA_BARCTMP   SCA_BARCODE5
     c                   end
N02  c                   end
N02  c                   end                                                    flere...
      *
     C                   ENDSR
      *////////////////////////////////////////////////////////////
     C     SkipBlank     BEGSR
      *////////////////////////////////////////////////////////////
      * Skip foranstilte blanke (hindre indexfeil på slutten av record)
     C                   Z-ADD     1             N2
     C     DTA(NR)       DOWEQ     ' '
     C                   ADD       1             NR
     C                   ADD       1             N2
     C     N2            IFge      30
     C                   leave
     C                   END
     C                   END
     C                   ENDSR
      *////////////////////////////////////////////////////////////
     C     OppDat        BEGSR
      *////////////////////////////////////////////////////////////
      * OPPDATER I CARGOF.
     C     CARGOFKey     KLIST
     C                   KFLD                    SCA_BARCODE
     C                   KFLD                    SCA_PLACE
N01  C     FlerBarc      TAG
     C     CARGOFKey     Chain     CARGOF                             33
N01  C     *in33         ifeq      '1'
     C                   clear                   CARGOFR
     C                   else
S03  C* clear knytning til oppddr. - (funker som 'status') = trigge ny summering
S03  C*                  clear                   KOAVD
S03  c*                  clear                   KOOPD
S03  c*                  clear                   KOLNR
S03  c*                  clear                   KOLNR2
N03  C                   Z-ADD     KOMVKT        GMMVKT            7 2
N03  C                   Z-ADD     KOMM3         GMMM3             7 5
N01  C                   endif
     C                   move      SCA_BARCODE   KOID
     C                   move      SCA_STATUS    KOSTAT
      *
     C                   MOVEA     SCA_WEIGHT    A
     C                   EXSR      GETNUM
     C                   Z-ADD     ZNUM          KOMVKT
      *
     C                   MOVEA     SCA_LENGTH    A
     C                   EXSR      GETNUM
     C                   Z-ADD     ZNUM          KOMLEN
      *
     C                   MOVEA     SCA_WIDTH     A
     C                   EXSR      GETNUM
     C                   Z-ADD     ZNUM          KOMBRE
      *
     C                   MOVEA     SCA_HEIGHT    A
     C                   EXSR      GETNUM
     C                   Z-ADD     ZNUM          KOMHØY
      * Volum gitt i dm3
N03   * Siden CS2SY gjør mer presis beregning ut fra LxBxH må også rutine fra fil gjøre samme..
N03  C*                  MOVEA     SCA_VOLUME    A
N03  C*                  EXSR      GETNUM
N03  C*    ZNUM          DIV       1000          KOMM3
     c                   eval(H)   KOMM3 =(KOMLEN*KOMBRE*KOMHØY)/1000000
      *
     C                   movel     SCA_PLACE     KOTERM
     C                   movel     SCA_STATION   KOSTNR
N04  C     *in33         ifeq      '1'
     C                   movel     SCA_DATETIME  KOINDT
     C                   move      SCA_DATETIME  KOINTI
N04  C                   endif
N02  C                   move      SCA_LMINDIC   KOLMIN
N02  C                   movel     SCA_PATH      KOPATH
N02   * Ved LM-indikator beregn teoretisk lastemeter på kolliet ( L x B / 2,5)
N02  c                   eval      KOMLM = 0
N02  c                   if        KOLMIN='1'
N02  c                   eval      KOMLM = (KOMLEN*KOMBRE/10000)/2.5
N02  c                   endif
Nxx   * UPDATE kun dersom endring.....
Nxx   * Siden BHR begynte med CS2SY-webservice som primær skal inndata fra fil sjelden brukes..
Nxx   *       Fil er kun backup/dersom webservice har sviktet (og er 99% sikkert lik den far CS2SY )
N03   * clear knytning til oppddr. - (funker som 'status') = trigge ny summering
N03  C     *in33         ifeq      '0'
     c                   move      'LIK'         KOPATH
N03  C                   if        KOMVKT <> GMMVKT or
N03  C                             KOMM3  <> GMMM3
N03  c                   clear                   KOAVD
N03  c                   clear                   KOOPD
N03  c                   clear                   KOLNR
N03  c                   clear                   KOLNR2
     c                   move      'UPD'         KOPATH
N03  c                   endif
N03  c                   else
     c                   move      'ADD'         KOPATH
N03  c                   endif
N01  C  N33              update    CARGOFR
     C   33              write     CARGOFR
      *
      * FLRE BARCODER I SAMME POST!!! gjenta..
     C     SCA_BARCODE2  IFNE      *blanks
     c                   move      SCA_BARCODE2  SCA_BARCODE
     C                   move      *blanks       SCA_BARCODE2
     c                   goto      FlerBarc
     c                   end
      *
     C     SCA_BARCODE3  IFNE      *blanks
     c                   move      SCA_BARCODE3  SCA_BARCODE
     C                   move      *blanks       SCA_BARCODE3
     c                   goto      FlerBarc
     c                   end
      *
     C     SCA_BARCODE4  IFNE      *blanks
     c                   move      SCA_BARCODE4  SCA_BARCODE
     C                   move      *blanks       SCA_BARCODE4
     c                   goto      FlerBarc
     c                   end
      *
     C     SCA_BARCODE5  IFNE      *blanks
     c                   move      SCA_BARCODE5  SCA_BARCODE
     C                   move      *blanks       SCA_BARCODE5
     c                   goto      FlerBarc
     c                   end
      *
     C                   ENDSR
      *////////////////////////////////////////////////////////////
     C     GetBar        BEGSR
      *////////////////////////////////////////////////////////////
      * normalt (ved kun en lapp pr pakke) KAN det se slik ut:
      * ;BARCODE=          00370386900000225223
      * ved flere lapper på samme pakke KAN det se slik ut:
      * ;BARCODE=          00370386900000225223;          003707062400048364
      * Står nå på semikolon - sett peker 1 forbi
     C                   ADD       1             NR
      *
     C                   EXSR      SkipBlank
     C                   Z-ADD     1             N2
     C                   MOVE      *BLANKS       FELT
      * Siste felt ...
     C     DTA(NR)       DOWNE     ' '
     C     DTA(NR)       ANDNE     ';'
     C                   MOVE      DTA(NR)       FE(N2)
     C                   ADD       1             NR
     C                   ADD       1             N2
     C                   END
     c                   MOVEL     FELT          SCA_BARCTMP
     C                   ENDSR
      *
      *////////////////////////////////////////////////////////////
      *  Get numerical value                               GETNUM /
      *////////////////////////////////////////////////////////////
     C     GETNUM        BEGSR
     C                   MOVE      *ZEROS        ZHEL
     C                   MOVE      *ZEROS        ZDEC
     C                   MOVE      *ZEROS        B
     C                   Z-ADD     1             AX                2 0
     C                   Z-ADD     1             BX                2 0
      * Get Integer
     C     A(AX)         DOWGE     '0'
     C     ZHEL          MULT      10            ZHEL
     C                   MOVE      A(AX)         ZHEL
     C                   ADD       1             AX
     C                   ENDDO
      * Decimal point ?
     C     A(AX)         IFEQ      '.'
     C     A(AX)         OREQ      ','
     C                   ADD       1             AX
     C     A(AX)         DOWGE     '0'
     C                   MOVE      A(AX)         B(BX)
     C                   ADD       1             AX
     C                   ADD       1             BX
     C                   ENDDO
     C                   MOVEA     B             ZDEC6
     C                   ENDIF
      * Concatenate
     C                   Z-ADD     ZHEL          ZNUM             18 6
     C                   ADD       ZDEC          ZNUM
     C                   ENDSR
