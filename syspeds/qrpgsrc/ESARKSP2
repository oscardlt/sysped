      *********************************************************************
CRTPG+*  CRTPGM SYSPED/ESARKSP2 MODULE(*LIBL/ESARKSP2 *LIBL/INCGI)
CRTPGM*         ACTGRP(CGI) AUT(*USE)
      *********************************************************************
      * RETTINGER I DETTE PROGRAM:
PTFnr:*Sek Sig Vers  Beskrivelse...........................
""""""*"""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""
10XXX * 01 JOV PTF10 ENDRINGER (FULLFØRING:=) NOV 2010
10XXX * 02 JOV PTF10 TA HØYDE FOR AT DET VIA SKANNEFEIL KAN LIGGE FLERE POS PÅ EN SAK..
10XXX * 03 JOV PTF10 Logg også på relaterte dup-oppdrag
10XXX * 04 JOV PTF10 ttmanu settes til 'S' for å få (mulighet) for å sende melding
10172 * 05 SH  PTF10 norsk text til Track and trace
      * %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
10172 * 06 JOV PTF11 Merke PODes skapt via oppf. av fraktbrevsskann  med POS i TTEDRE
********************************************************************
      /copy syspeds/qrpgsrcpy,hspecs
      /copy syspeds/qrpgsrcpy,hspecsbnd

     FBRIDF     IF   E           K DISK    USROPN
     FCUNDL01   IF   E           K DISK    USROPN
     FTRACKL02  UF a E           K DISK    USROPN
     FHEADF     UF   E           K DISK    USROPN
      *_____________________________
      * Variables common to all CGIs
      *"""""""""""""""""""""""""""""
      /copy syspeds/qrpgsrcpy,prototypeb
      /copy syspeds/qrpgsrcpy,usec
      /copy syspeds/qrpgsrcpy,variables3
      *_______________________
      * Client input variables
      *"""""""""""""""""""""""
     D WUSER           S             10
     D KOBL            S            100
     D AVD             S              4
     D AVDn            S              4  0
     D OPD             S              7
     D OPDn            S              7  0
     D FBN             S              3
     D FBNn            S              3  0
     D SIGN            S             10
     D DATO            S              4
     D*DATOn           S              8  0
     D KL              S              4
     D KLn             S              4  0
     D TTFRA           S              3
     D TTTIL           S              3
     D TTTX            S             39
     D UsrSpcName      s             10
     D FEILTEXT        S            120
     D AVSLUTT         S              1
     D                 DS
     D Idag                    1      8  0
     D IdagÅÅ                  1      4  0
     D IdagMM                  5      6  0
     D IdagDD                  7      8  0
     D                 DS
     D TTÅMD                   1      8  0
     D TTÅÅ                    1      4  0
     D TTMM                    5      6  0
     D TTDD                    7      8  0
      * For xlate mellom Upper Case og Lower Case
     D UC              C                   CONST('ABCDEFGHIJKLMNOPQRST-
     D                                     UVWXYZÆØÅ')
     D LC              C                   CONST('abcdefghijklmnopqrst-
     D                                     uvwxyzæøå')

      /copy syspeds/qrpgsrcpy,prolog3

      * Parse input / cvt to numeric
     C                   EXSR      PARSE
      * File open / keys
     C                   EXSR      INIT
      * Read output skeleton html member into memory
     C                   EXSR      LOADHTML
      * Set section variables
     C                   EXSR      SETTOP
     C                   CALLP     wrtsection('top')

     C                   EXSR      EXIT

     C                   EVAL      *inlr = *on
     C                   RETURN
      *////////////////////////////////////////////////////////////
      *  Hente variabler                                    PARSE /
      *////////////////////////////////////////////////////////////
     C     PARSE         BEGSR
      * Parse variables from QUERY_STRING environment variable
     C                   EVAL      AVD      = zhbgetvar('AVD')
     C                   EVAL      AVDN     = c2n2(AVD)
     C                   EVAL      OPD      = zhbgetvar('OPD')
     C                   EVAL      OPDN     = c2n2(OPD)
     C                   EVAL      FBN      = zhbgetvar('FBN')
     C                   EVAL      FBNN     = c2n2(FBN)
     C                   EVAL      SIGN     = zhbgetvar('SIGN')
     C                   EVAL      DATO     = zhbgetvar('DATO')
     C*                  EVAL      DATOn    = c2n2(DATO)
     C                   EVAL      KL       = zhbgetvar('KL')
     C                   EVAL      KLn      = c2n2(KL)
     C                   EVAL      TTFRA    = zhbgetvar('TTFRA')
     C                   EVAL      TTTIL    = zhbgetvar('TTTIL')
     C                   EVAL      TTTX     = zhbgetvar('TTTX')
     C                   EVAL      UsrSpcName = zhbgetvar('UsrSpcName')
      * ved kall fra liste er type blank.
     C                   EVAL      AVSLUTT  = zhbgetvar('AVSLUTT')
     C     LC:UC         XLATE     SIGN          SIGN
      * Userid.....
     C                   EVAL      WUSER = zhbgetvar('USER')
     C                   ENDSR
      *////////////////////////////////////////////////////////////
      *  Close output html and quit                          EXIT /
      *////////////////////////////////////////////////////////////
     C     EXIT          BEGSR
      * Do not delete the call to wrtsection with section name *fini.  It is needed
      * to ensure that all output html that has been buffered gets output.
     C                   CALLP     wrtsection('*fini')
      * Quit
     C                   CLOSE     BRIDF
     C                   CLOSE     CUNDL01
     C                   CLOSE     TRACKL02
     C                   CLOSE     HEADF
     C                   ENDSR
      *////////////////////////////////////////////////////////////
      *  Read output skeleton html member into memory    LOADHTML /
      *////////////////////////////////////////////////////////////
     C     LOADHTML      BEGSR
     C                   CALLP     gethtml('HTMLSRC':
     C                             '*LIBL':
     C                             'ESARKSP2':'/CGITAG/')
     C                   ENDSR
      *////////////////////////////////////////////////////////////
      *  Set variable data for section /$top               SETTOP /
      *////////////////////////////////////////////////////////////
     C     SETTOP        BEGSR
BODY C                   callp     updhtmlvar('BODYCLASS':'class='+BIFARG)
     C                   CALLP     updHTMLvar('USER':WUSER)
     C                   CALLP     updHTMLvar('BESK':BIBESK)
     C                   CALLP     updHtmlVar('KUNDE':
     C                             %trim(%editc(BIKUNR:'Z')))
     C                   CALLP     updHTMLvar('KNAVN':KNAVN)
     C                   CALLP     updHTMLvar('TTFRA':TTFRA)
     C                   CALLP     updHTMLvar('TTTIL':TTTIL)
     C                   CALLP     updHTMLvar('TTTX':TTTX)
     C                   CALLP     updHTMLvar('avd':avd)
     C                   CALLP     updHTMLvar('opd':opd)
     C                   CALLP     updHTMLvar('fbn':fbn)
     C                   CALLP     updHTMLvar('SIGN':SIGN)
     C*                  CALLP     updHtmlVar('DATO':
     C*                            %trim(%editc(DATOn:'Z')))
     C                   CALLP     updHtmlVar('DATO':DATO)
     C                   CALLP     updHtmlVar('KL':
     C                             %trim(%editc(KLn:'Z')))
      * Nullstill en del verdier
     C                   EVAL      *IN30=*OFF
     C                   EVAL      FEILTEXT=*BLANKS
     C                   EVAL      AVSLUTT='N'
      *
s01  c*                  if        SIGN = *blanks or DATOn=*zeros
s01  C*                  EVAL      FEILTEXT='Signatur OG dato må angis '
s01  C*                  GOTO      NOVAR
s01  C*                  ENDIF
      * test sign
N01  c                   if        SIGN = *blanks
N01  C                   EVAL      FEILTEXT='Signatur må angis '
N01  C                   GOTO      NOVAR
N01  C                   ENDIF
      *
N01   * test dato (DDMM, lavere eller lik dagens dato,max 180 dg gml.
N01   * ledende null MÅ oppgis - eks 0309
N01  c                   testn                   Dato                 34
N01  c     *in34         Ifeq      *off
N01  C                   EVAL      FEILTEXT='4 siffer (DDMM) må angis.'
N01  c                             + '(også ledende null)'
N01  C                   GOTO      NOVAR
N01  C                   endif
      * max xxx dager gammel..
n01   * Hent dato og klokkeslett
n01  C                   CALL      'SYGE15C'
n01  C                   PARM                    WDATO             8
n01  C                   PARM                    WTID              6
n01  C                   Move      WDATO         Idag
n01   * Finn laveste gyldige dato tilbake i tid
n01  C                   CALL      'SYGE20'
n01  C                   PARM      'SUB'         UFUNK             3
n01  C                   PARM                    nulldato          8 0
n01  C                   PARM                    MinimDT           8 0
n01  C                   PARM                    MaxGml            5 0
      * Konstruer T&T-dato basert på 4-sifret input
     c                   movel     Dato          TTDD
     c                   move      Dato          TTMM
     c     TTmm          ifle      IdagMM
     c                   move      IDAGÅÅ        TTÅÅ                           mnd < NÅ = i ÅR
     c                   else
     c                   eval      TTÅÅ  = IDAGÅÅ - 1                           eller i fjor(høst..)
     c                   endif
     c     TTÅMD         ifgt      Idag
     c     TTÅMD         orlt      MinimDT
     C                   EVAL      FEILTEXT='Dato '
     C                             + %trim(%editw(TTÅMD:'    .  .  '))
     C                             + ' kan ikke være lavere enn '
     c                             + %trim(%editw(MinimDT:'    .  .  '))
     c                             + ' (og ikke høyere enn dagens.)'
     C                   GOTO      NOVAR
     c                   endif
      *
      * Ingen feil, oppdater gammel / lag NY  T&T..
N03  C     HEADKEY       chain(N)  HEADFR                             33
N03  c                   z-add     TRavd0        ekstrA0
N03  c                   z-add     TRopd0        ekstrO0
N03  c                   z-add     TRavd1        ekstrA1
N03  c                   z-add     TRopd1        ekstrO1
N03  c                   z-add     TRavd2        ekstrA2
N03  c                   z-add     TRopd2        ekstrO2
N03  c     StrUpdate     tag
      *oppdater gml.. ( TA HØYDE FOR AT DET VIA FEIL I ARKIVERING KAN VÆRE FLERE)
     C     TT2KEY        chain     TRACKL02                           33
N02  C     FlPOS         tag
     c                   eval      TTNAME= SIGN
     c  n33              update    TRACKFR
N02  C  N33TT2KEY        READE     TRACKL02                               33
N02  C  N33              goto      FlPos
S01   * Hent dato og klokkeslett
S01  C*                  CALL      'SYGE15C'
S01  C*                  PARM                    WDATO             8
S01  C*                  PARM                    WTID              6
      * legg ut ny
     c                   eval      TTACTI = TTTIL
     c*                  EVAL      TTDATE = DatoN
     c                   EVAL      TTDATE = TTÅMD
     c                   EVAL      TTTIME = KLn *100
     c                   EVAL      TTDATL = c2n2(WDATO)
     c                   EVAL      TTTIML = c2n2(WTID)
     c                   eval      TTTEXT = 'Signed by '+SIGN
N05  c                   eval      TTTEXL = 'Signert av '+SIGN
     c                   eval      TTNAME = SIGN
     C                   MOVEL     WUser         TTUSER
N06  C                   eval      TTEDRE = 'POS
N04  C                   MOVE      'S'           TTMANU
     c                   write     TRACKFR
      * oppdater oppdrag..
     c     TTTIL         ifeq      'POD'
     C     HEADKEY       chain     HEADFR                             33
     c                   eval      HESGM= SIGN
     C                   movel     TTDATE        HEDTMO
     C                   movel     TTTIME        HEKLMO
     c                   update    Headfr
     c                   endif
N03   * ekstra runder pga flere på samme via DUP..
N03  c                   select
N03  c     ekstrA0       whenne    *zeros
N03  C                   move      ekstrA0       AVDn
N03  C                   move      ekstrO0       OPDn
N03  C                   move      AVDn          TTAVD
N03  C                   move      OPDn          TTOPD
N03  C                   move      FBNn          TTFBNR
N03  c                   move      *zeros        ekstrA0
N03  c                   move      *zeros        ekstrO0
N03  c                   goto      StrUpdate
N03  c     ekstrA1       whenne    *zeros
N03  C                   move      ekstrA1       AVDn
N03  C                   move      ekstrO1       OPDn
N03  C                   move      AVDn          TTAVD
N03  C                   move      OPDn          TTOPD
N03  C                   move      FBNn          TTFBNR
N03  c                   move      *zeros        ekstrA1
N03  c                   move      *zeros        ekstrO1
N03  c                   goto      StrUpdate
N03  c     ekstrA2       whenne    *zeros
N03  C                   movel     ekstrA2       AVDn
N03  C                   movel     ekstrO2       OPDn
N03  C                   move      AVDn          TTAVD
N03  C                   move      OPDn          TTOPD
N03  C                   move      FBNn          TTFBNR
N03  c                   move      *zeros        ekstrA2
N03  c                   move      *zeros        ekstrO2
N03  c                   goto      StrUpdate
N03  c                   endsl
      * Oppdater variabel for selfclose
     C                   EVAL      AVSLUTT='Y'
      *
     C     NOVAR         TAG
     C                   CALLP     updHTMLvar('FEILTEXT':FEILTEXT)
     C                   CALLP     updHTMLvar('AVSLUTT':AVSLUTT)
     C                   ENDSR
      *////////////////////////////////////////////////////////////
      *  Init                                                INIT /
      *////////////////////////////////////////////////////////////
     C     INIT          BEGSR
     C                   OPEN      BRIDF
     C     WUSER         CHAIN     BRIDF                              50
      * En "standardvariant" libl: call bound (INCGI=*MODULE) med parameter.
     C     BILIBL        IFEQ      *BLANKS
     C                   CALLB     'INCGI'
     C                   PARM                    BISTDL
     C                   ELSE
     C* Helt egen bibl.liste satt på user - normal CALL (BILIBL er "*pgm")
     C                   CALL      BILIBL
     C                   ENDIF

     C                   OPEN      CUNDL01
     C                   OPEN      TRACKL02
     C                   OPEN      HEADF

     C     HEADKEY       KLIST
     C                   KFLD                    AVDn
     C                   KFLD                    OPDn

     C     TT2KEY        KLIST
     C                   KFLD                    AVDn
     C                   KFLD                    OPDn
     C                   KFLD                    FBNn
     C                   KFLD                    TTFRA
     C*                  KFLD                    TTDATE
     C*                  KFLD                    TTTIME

     C     KunKey        KLIST
     C                   KFLD                    BIFIRM
     C                   KFLD                    BIKUNR
     C     KUNKEY        CHAIN     CUNDL01                            33
      *
N03  c     *like         define    HEAVD         ekstrA0
N03  c     *like         define    HEOPD         ekstrO0
N03  c     *like         define    HEAVD         ekstrA1
N03  c     *like         define    HEOPD         ekstrO1
N03  c     *like         define    HEAVD         ekstrA2
N03  c     *like         define    HEOPD         ekstrO2
      *
     c                   z-add     180           MaxGml            5 0
     C                   ENDSR
