********************************************************************
      * RETTINGER I DETTE PROGRAM:
PTFnr:*Sek Sig Vers  Beskrivelse...........................
""""""*"""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""
11XXX * 01 YBC PTF11 FEIL LEVERINGSADRESSE
11XXX * 02 YBC ORIGINAL FAKTURANR PÅ KREDITNOTA
11XXX * 03 YBC SLÅ SAMME VEDLEGG
11XXX * 04 YBC DIV. ENDRING PGA. NY VERSJON AV EHF
11XXX * 05 YBC NY MÅTE Å OPNE IFS-FIL PGA. TEGNSETT. INGEN MERKING
11XXX * 06 YBC FEIL INDIKATOR
11XXX * 07 YBC ENDRE OBJEKT AUTORISAKSJON
11065 * 08 YBC LOGG I TRACKF
11XXX * 09 YBC BELØP=0 SENDER 0.00
11XXX * 10 YBC PTF11 TOM TAG IKKE TILLATE. VERSJON 2.0.5
11XXX * 11 YBC PTF11 PaymentMeansCode settes alltid til 30 (Credit transfer)
      *              http://www.unece.org/trade/untdid/d04a/tred/tred4461.htm
11XXX * 12 YBC PTF11 KREDITNOTA VER 2.0
11XXX * 13 YBC PTF11 FEIL I TaxCategory/ID VED KREDITNOTA
11XXX * 14 YBC PTF11 Set status=N ved faktura uten fakturalinje
11XXX * 15 YBC PTF11 Takle negativ fakturalinje
xxxxxx*xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
12XXX * 16 YBC PTF12 Test om PDF er generert. Nei -> ikke send EHF
12XXX * 17 YBC PTF12 Send gebyrkode
12XXX * 18 YBC PTF12 Send TaxSubTotal for momsfri
12XXX * 19 YBC PTF12 Summere total MVA fra linjer
12XXX * 20 YBC DocumentType for faktura og kreditnota
12XXX * 21 YBC Bytt rekkefølger av SRSNDSL og SRCLOSE
12XXX * 22 YBC XDOKTYPE er for kort. Hent ekstra beskrivelse
12XXX * 23 YBC TaxSubTotal må sendes selv om det er 0-faktura
12XXX * 24 YBC Hent kundenr på nytt i tilfelle stopp
12XXX * 25 YBC Test om mottakers organisasjonsnr er blank
12XXX * 26 YBC Send TaxCategory på hode ved momsfri med beløp=0
12XXX * 27 YBC Rettelse på endring 16
12XXX * 28 YBC Rettelse på endring 26
12XXX * 29 YBC Ikke ta med kostnadsbilag med samme nummer
12XXX * 30 YBC Initiere XXMVA
12XXX * 31 YBC Bruk IBAN
12XXX * 32 YBC Feilretting på endring 19
12XXX * 33 YBC Rett feil (alle fakturaer blir stoppet hvis en kunde har problem ved vedlegg)
12XXX * 34 YBC Fakturavaluta=firmasvaluta, linje med annen valuta
12XXX * 35 YBC Særtegn bytting
12XXX * 36 YBC Flere vedlegg
12XXX * 37 YBC EHF billing 3.0
12161 * 38 YBC Fast edi-avsender/mottaker (EHF på begge sider)
12XXX * 39 YBC IKKE SEND <cbc:PaymentID> VED KID-NR=BLANK
12XXX * 40 YBC Test om vedlegg er pdf ved sammenslåing.
12XXX * 41 YBC Konverter tegn for tekst til betalingsmåte
********************************************************************
     H DFTACTGRP(*NO)
      *
      ***********************************************************
      *** PROGRAM SKAL SENDE XML-FAKTURA EHF                  ***
      *** INDIKATORER 01 - 26 KUN CMD-TASTER / ROLL TASTER    ***
      *** LEDIGE INDIKATORER 01-26                            ***
      *** LEDIGE INDIKATORER 27-32 34-49 51-99                ***
      ***********************************************************
     FFIRM      IF   E           K DISK
     FXMLUFL1   UF   E           K DISK
S38  F*ECMSG     IF   E           K DISK
N38  FSYPARL1   IF   E           K DISK
     FKODWL01   IF   E           K DISK    USROPN
     FKODTA     IF   E           K DISK    USROPN
     FKODTGE    IF   E           K DISK    USROPN
     FKODTG2    IF   E           K DISK    USROPN
     FKODTFR    IF   E           K DISK    USROPN
     FKODTOTY   IF   E           K DISK    USROPN
     FKODTSF    IF   E           K DISK    USROPN
S25  F*CUNDL01   IF   E           K DISK    USROPN
N25  FCUNDL01   IF   E           K DISK
N03  FCUNDC05   IF   E           K DISK    USROPN
S14  F*FAIN      IF   E           K DISK    USROPN
N14  FFAIN      IF   E           K DISK
     FHEADF     IF   E           K DISK    USROPN
S14  F*FAK8      IF   E           K DISK    USROPN
N14  FFAK8      IF   E           K DISK
     FFAKTXT    IF   E           K DISK    USROPN
     FFRISOK    IF   E           K DISK    USROPN
     FKODFRI    IF   E           K DISK    USROPN
     FFREETXT2  IF   E           K DISK
     FFIRMARC   IF   E           K DISK
     FARKIVL02  IF   E           K DISK
     FARKTXT    IF   E           K DISK
     FARKEXT    IF   E           K DISK
     FARKVEDK   IF   E           K DISK
     FEDIC      UF A E             DISK    USROPN
     FEDIS      UF A E           K DISK    USROPN
     FEDIM      O  A E             DISK    USROPN
N08  FTRACKF    O  A E             DISK    USROPN
      /copy ifsio_h
     D TXT             S             80    DIM(18) CTDATA PERRCD(1)
     D VEDL            S             70    DIM(900)
     D*XSNV            S              9  0 DIM(100)
N38  D X_S0020         S             14A
     D                 DS
     D  XTXT05                 1      5
     D  XT05                   1      5    DIM(5)
     D                 DS
     D  XTXT40                 1     40
     D  XT40                   1     40    DIM(40)
     D                 DS
     D  XTXT801                1     80
     D  XT801                  1     80    DIM(80)
     D                 DS
     D  XTXT802                1     80
     D  XT802                  1     80    DIM(80)
     D                 DS
     D  ØN152                  1     15  2
     D  ØA152H                 1     13
     D  ØA152X                 5     13
     D  ØA152D                14     15
     D                 DS
     D  ØA12                   1     12
     D  Ø12                    1     12
     D                                     DIM(12)                              Num edit
     D                 DS
     D  WDT                    1      8
     D  WDTÅ                   1      4
     D  WDTM                   5      6
     D  WDTD                   7      8
     D                 DS
     D  WTM                    1      6
     D  WTMH                   1      2
     D  WTMM                   3      4
     D  WTMS                   5      6
     D                 DS
     D  HEAVD                  1      4  0
     D  XXSTREKK1              5      5
     D  HEOPD                  6     12  0
     D  XXSTREKK2             13     13
     D  HESG                  14     16
     D  SYSPEDREF              1     16
     D                 DS
     D  HEDTOP                 1      8  0
     D  HEDTOPÅ                1      4
     D  HEDTOPM                5      6
     D  HEDTOPD                7      8
     D                 DS
     D  FADATO                 1      8  0
     D  FADATOÅ                1      4
     D  FADATOM                5      6
     D  FADATOD                7      8
     D                 DS
     D  FADAFF                 1      8  0
     D  FADAFFÅ                1      4
     D  FADAFFM                5      6
     D  FADAFFD                7      8
     D                 DS
     D  FAVT                   1     20
     D  FAVT01                 1      1
     D  FAVT02                 2     20
     D                 DS
     D  SYKT8                  1      8
     D  SYFR02                 1      1
     D  SYKT7                  2      7
     D  SYKONT                 2      8  0
     D                 DS
     D  XMLT1                  1     44  2 DIM(11)
     D  XFMS01                 1      4  2
     D  XFMS02                 5      8  2
     D  XFMS03                 9     12  2
     D  XFMS04                13     16  2
     D  XFMS05                17     20  2
     D  XFMS06                21     24  2
     D  XFMS07                25     28  2
     D  XFMS08                29     32  2
     D  XFMS09                33     36  2
     D  XFMS10                37     40  2
     D  XFMS11                41     44  2
     D                 DS
     D  XMLT2                  1     33    DIM(11)
     D  XFMV01                 1      3
     D  XFMV02                 4      6
     D  XFMV03                 7      9
     D  XFMV04                10     12
     D  XFMV05                13     15
     D  XFMV06                16     18
     D  XFMV07                19     21
     D  XFMV08                22     24
     D  XFMV09                25     27
     D  XFMV10                28     30
     D  XFMV11                31     33
     D                 DS
     D  XMLT3                  1    143  2 DIM(11)
     D  XFMGN1                 1     13  2
     D  XFMGN2                14     26  2
     D  XFMGN3                27     39  2
     D  XFMGN4                40     52  2
     D  XFMGN5                53     65  2
     D  XFMGN6                66     78  2
     D  XFMGN7                79     91  2
     D  XFMGN8                92    104  2
     D  XFMGN9               105    117  2
     D  XFMGNA               118    130  2
     D  XFMGNB               131    143  2
     D                 DS
     D  XMLT4                  1    143  2 DIM(11)
     D  XFMGV1                 1     13  2
     D  XFMGV2                14     26  2
     D  XFMGV3                27     39  2
     D  XFMGV4                40     52  2
     D  XFMGV5                53     65  2
     D  XFMGV6                66     78  2
     D  XFMGV7                79     91  2
     D  XFMGV8                92    104  2
     D  XFMGV9               105    117  2
     D  XFMGVA               118    130  2
     D  XFMGVB               131    143  2
     D                 DS
     D  FSDOKK                 1     10
     D  DFS                    1     10    DIM(10)
     D                 DS
     D  SYRG                   1     14
     D  SYRG9                  1      9
     D                 DS
     D  AVKVED                 1     60
     D  AVK                    1     60    DIM(30)
     D                 DS
     D  TRSDFD                 1      8  0
     D  TRSDFDAA               1      4
     D  TRSDFDMM               5      6
     D  TRSDFDDD               7      8
     D                 DS
     D  TRSDTD                 1      8  0
     D  TRSDTDAA               1      4
     D  TRSDTDMM               5      6
     D  TRSDTDDD               7      8
      *
     D FILE_o          s             10I 0
     D String          s            512a
     D rc              s             10i 0
     D Idx             s              5u 0
     D FILNAM          s            100A
     D FILNAM1         s            100A
     D FILNAM2         s            100A
     D FILNAM3         s            100A
N07  D XCHGAUT         s            200A
     D LF              c                   x'25'
     D RunCmd          PR                  EXTPGM('QCMDEXC')
     D  Cmd                         200A   CONST
     D  Len                          15P 5 CONST
     D                SDS
     D  ZUSER                254    263
      *
     C                   EXSR      INIT
N16   * ÅPNE ALLE FAKTURAER SOM IKKE HADDE GENERERERT PDF FRA SISTE KJØRING
N16  C     START0        TAG
N16  C                   EVAL      XANT = XANT + 1
N16  C                   SELECT
N16  C                   WHEN      XANT > 10
N16  C                   GOTO      SLUTT
N16  C                   WHEN      XANT > 1
N16   * VENT 5 MIN.
N16  C                   Z-ADD     300           USEC              3 0
N16  C                   CALL      'DLYJBSEC'
N16  C                   PARM                    USEC
N16  C                   ENDSL
N16  C     'T'           SETLL     XMLUFL1
N16  C     'T'           READE     XMLUFL1                                50
N16  C                   IF        *IN50 AND XANT > 1
N16   * INGEN VENT-FAKTURA
N16  C                   GOTO      SLUTT
N16  C                   END
N16  C                   DOW       *IN50 = *OFF
N16  C                   EVAL      XFST = *BLANKS
N16  C                   UPDATE    XMLUFFR
N16  C     'T'           READE     XMLUFL1                                50
N16  C                   ENDDO
      *
      * Teller antall fakturaer
     C     START         TAG
S04  C*                  MOVE      *ZEROS        S0036
     C     XMLUFL1K      SETLL     XMLUFL1
     C     XMLUFL1K      READE     XMLUFL1                                50
S16  C*  50              GOTO      SLUTT
N16  C   50              GOTO      START0
N25   * TEST ORGANISASJONSNR
N25  C                   MOVE      XFKN          KUNDNR
N25  C     CUNDL01K      CHAIN     CUNDL01                            33
N38  C     SYPARL1K      CHAIN     SYPARL1                            33
S38  C*                  IF        SYRG = *BLANKS OR SYRG9 = *ZEROS             1<-B
N38  C                   IF        (SYRG = *BLANKS OR SYRG9 = *ZEROS)           1<-B
N38  C                             AND *IN33
N25   * SEND FEILMELDING
N25  C                   EVAL      UEMNE = 'Feil ved utsending av EHF'
N25  C                   EVAL      UMSG  = %TRIM(FIFT)
N25  C                             + ':  Kunde (' + %TRIM(%EDITC(XFKN:'Z'))
N25  C                             + ') mangler organisasjonsnr.'
N25  C                   EVAL      UEP   = 'helpdesk@systema.no'
N25  C                   CALL      'SYXML30C2'
N25  C                   PARM                    UEMNE            40
N25  C                   PARM                    UMSG            256
N25  C                   PARM                    UEP              70
N25   * SETT STATUS TIL VENTING
N25  C                   DOW       *IN50 = *OFF                                  2<-B
N25  C                   IF        XFKN = KUNDNR                                  3<-B
N25  C                   MOVE      'W'           XFST
N25  C                   END                                                      3<-E
N25  C                   UPDATE    XMLUFFR
N25  C     XMLUFL1K      READE     XMLUFL1                                50
N25  C                   ENDDO                                                   2<-E
N25  C                   GOTO      START
N25  C                   END                                                    1<-E
N25   *
     C                   MOVE      XFKN          XXKN              8 0
     C                   MOVE      ' '           XSINGEL           1
     C                   MOVE      'N'           XOK               1
     C                   DOW       *IN50 = *OFF                                 1<-B
     C                   IF        XFKN = XXKN                                   2<-B
S38  C*    ECMSGK        CHAIN     ECMSG                              33
S38  C*                  IF        *IN33 = *OFF                                   3<-B
     C                   MOVE      'J'           XOK
      *
     C                   SELECT                                                    4<-B
     C                   WHEN      XSINGEL = ' '                                   4
     C                   IF        XFSAML = 'J'                                     5<-B
     C                   MOVE      'N'           XSINGEL
     C                   ELSE                                                       5
     C                   MOVE      'J'           XSINGEL
     C                   END                                                        5<-E
     C                   WHEN      XSINGEL = 'J'                                   4
     C     XFSAML        CABEQ     'J'           XNESTE
     C                   OTHER                                                     4
     C     XFSAML        CABEQ     'N'           XNESTE
     C                   ENDSL                                                     4<-E
      *
S04  C*                  ADD       1             S0036
N14  C     XFFN          CHAIN     FAIN                               33
N29  C     START2        TAG
N14  C  N33FAK8K         CHAIN     FAK8                               33
N29  C  N33              IF        FAKDA = 'K'
N29  C     XFFN          READE     FAIN                                   33
N29  C  N33              GOTO      START2
N29  C                   END
N14  C                   IF        *IN33                                           4<-B
N14  C                   MOVE      'N'           XFST
N14  C                   ELSE                                                      4
N27  C                   MOVEL     XFFN          X_ARUNDE
N16  C     ARKIVL02K2    CHAIN     ARKIVL02                           33
N16  C                   IF        *IN33                                            5<-B
N16   * OPPDATER STATUS T NÅR PDF IKKE ER KLAR. DA VENTER FAKTURA TIL NESTE KJØRING.
N16  C                   MOVE      'T'           XFST
N16  C                   ELSE                                                       5
     C                   MOVE      'A'           XFST
N16  C                   END                                                        5<-E
N14  C                   END                                                       4<-E
S38  C*                  ELSE                                                     3
S38  C*                  MOVE      'V'           XFST
S38  C*                  END                                                      3<-E
     C                   END                                                     2<-E
     C     XNESTE        TAG
     C                   UPDATE    XMLUFFR
      *
     C                   IF        XSINGEL = 'N'                                 2<-B
     C                   LEAVE
     C                   END                                                     2<-E
      *
     C     XMLUFL1K      READE     XMLUFL1                                50
     C                   ENDDO                                                  1<-E
     C     XOK           CABNE     'J'           START
      *
      * TEST OM DET FINNES SENDING.
      * ÅRSAK KAN VÆRE KUNDE IKKE ER DEFINERT I ECMSG.
     C                   MOVE      'A'           XXST
     C     XMLUFL1K      CHAIN     XMLUFL1                            50
S16  C*  50              GOTO      SLUTT
S33  C*  50              GOTO      START0
N33  C   50              MOVE      ' '           XXST
N33  C   50              GOTO      START
      *
     C                   MOVE      'A'           XXST
     C     XMLUFL1K      SETLL     XMLUFL1
     C     START1        TAG
     C     XMLUFL1K      READE     XMLUFL1                                50
     C                   IF        *IN50
     C                   MOVE      ' '           XXST
     C                   GOTO      START
     C                   END
N24  C                   MOVE      XFKN          XXKN
      *
     C                   EXSR      SRSNDST
      *
     C                   EXSR      SRINVOICE
      * Oppdate EDIM
     C                   IF        XFSAML = 'N'
     C                   EXSR      OPDEDIM
     C                   END
      * Oppdater XMLUFF
     C                   MOVE      'C'           XFST
     C                   MOVE      WDT           XFDTS
     C                   MOVE      WTM           XFTDS
     C                   UPDATE    XMLUFFR
      *
N21  C                   EXSR      SRCLOSE
     C                   EXSR      SRSNDSL
S21  C*                  EXSR      SRCLOSE
     C                   GOTO      START1
      *
     C     SLUTT         TAG
N25   * SETT STATUS TILBAKE. VENT TIL NESTE SENDING
N25  C                   MOVE      'W'           XXST
N25  C     XMLUFL1K      CHAIN     XMLUFL1                            50
N25  C                   DOW       *IN50 = *OFF
N25  C                   EVAL      XFST = ' '
N25  C                   UPDATE    XMLUFFR
N25  C     XMLUFL1K      READE     XMLUFL1                                50
N25  C                   ENDDO
N25   *
     C                   MOVE      *ON           *INLR
     C                   RETURN
      *
      ***********************************************
     C     SRSNDST       BEGSR
      ***********************************************
     C                   OPEN      KODWL01
     C                   OPEN      KODTA
     C                   OPEN      KODTGE
     C                   OPEN      KODTG2
     C                   OPEN      KODTFR
     C                   OPEN      KODTOTY
     C                   OPEN      KODTSF
S25  C*                  OPEN      CUNDL01
N03  C                   OPEN      CUNDC05
S14  C*                  OPEN      FAIN
     C                   OPEN      HEADF
S14  C*                  OPEN      FAK8
     C                   OPEN      FAKTXT
     C                   OPEN      FRISOK
     C                   OPEN      KODFRI
     C                   OPEN      EDIC
     C                   OPEN      EDIS
     C                   OPEN      EDIM
N08  C                   OPEN      TRACKF
     C*                  MOVE      *ZEROS        XSNV
     C*                  MOVE      *ZEROS        XSNVN             3 0
      *
S38  C*    ECMSGK        CHAIN     ECMSG                              33
     C     1             CHAIN     EDIC                               33
     C                   ADD       1             CSN
     C                   UPDATE    EDICR
      *
     C                   MOVE      *BLANKS       SDATA          1024
     C                   CALL      'SYGE15C'
     C                   PARM                    WDT
     C                   PARM                    WTM
      *
S38  C*                  EVAL      S0004 = ECIIDI
S38  C*                  EVAL      S0010 = ECIIDC
N38  C                   EVAL      S0004 = 'EHF'
N38  C                   EVAL      S0010 = 'EHF'
N38   * S0020 = 7 FØRSTE SIFFER AV KUNDENR + FAKTURANR
N38  C                   EVAL      S0020 = KNAVN
     C                   MOVE      XFFN          XFFNALFA          7
N38  C                   MOVE      XFFNALFA      S0020
     C                   IF        XFFK = 'F'
S38  C*                  EVAL      S0020 = 'F' + XFFNALFA
N38  C                   EVAL      X_S0020 = 'F' + XFFNALFA
     C                   ELSE
S38  C*                  EVAL      S0020 = 'K' + XFFNALFA
N38  C                   EVAL      X_S0020 = 'K' + XFFNALFA
     C                   END
N04  C                   Z-ADD     1             S0036
     C                   EVAL      SSN   = CSN
     C                   EVAL      SSR   = 'S'
     C                   EVAL      SST   = 'X'
     C                   MOVE      WDT           SDT
     C                   MOVE      WTM           STM
     C                   EVAL      SLIB  = *BLANKS
     C                   EVAL      SFILE = '*IFS'
     C                   EVAL      SMBR  = *BLANKS
     C                   EVAL      SMBRS  = 0
      *
     C                   EVAL      FILNAM = '/' + %TRIM(FILIBF) + 'X/'
     C                             + %TRIM(S0010) + '/EDISE1K/BACKUP/'
S38  C*                            + %TRIM(S0020) + %TRIM(WDT)
N38  C                             + %TRIM(X_S0020) + %TRIM(WDT)
     C                             + %TRIM(WTM) + '.xml'
     C                   EVAL      FILNAM1 = '/' + %TRIM(FILIBF) + 'X/'
     C                             + %TRIM(S0010) + '/EDISE1K/BACKUP/'
S38  C*                            + %TRIM(S0020) + %TRIM(WDT)
N38  C                             + %TRIM(X_S0020) + %TRIM(WDT)
     C                             + %TRIM(WTM) + '-1.xml'
      * 1208 = UTF-8
     C                   eval      FILE_o = open( %TrimR( FilNam )
     C                               : O_CREAT+O_TRUNC+O_WRONLY
     C                                + O_TEXT_CREAT+O_CCSID+O_TEXTDATA
     C                               : S_IRUSR + S_IWUSR
     C                               : 1208
     C                               : 0)
      *
     C                   EVAL      SIFS   = FILNAM
     C                   WRITE     EDISR
      *
     C                   EVAL      XSSN = SSN
     C                   MOVE      *ZEROS        XANTMSG           5 0
      *
     C                   EVAL      SDATA = TXT(001)
     C                   EXSR      OPDFIL
S37  C*                  IF        XFFK = 'F'
S37  C*                  EVAL      SDATA = TXT(002)
S37  C*                  ELSE
S37  C*                  EVAL      SDATA = TXT(010)
S37  C*                  END
S37  C*                  EXSR      OPDFIL
      *
     C                   ENDSR
      *
      ***********************************************
     C     SRINVOICE     BEGSR
      ***********************************************
     C                   MOVE      XXKN          KUNDNR
     C     XFFN          CHAIN     FAIN                               33
N29  C     STSRINV01     TAG
     C     CUNDL01K      CHAIN     CUNDL01                            33
N38   *
N38   * MOTTAGERS ORG.NR KAN ER REGISTRERT I PARAMTERFIL
N38  C     SYPARL1K      CHAIN     SYPARL1                            33
N38  C                   IF        *IN33 = *OFF AND SYVRDA <> *BLANKS
N38  C                   EVAL      SYRG = SYVRDA
N38  C                   END
     C     HEADFK        CHAIN     HEADF                              33
     C     FAK8K         SETLL     FAK8
     C     FAK8K         READE     FAK8                                   33
N29  C  N33              IF        FAKDA = 'K'
N29  C     XFFN          READE     FAIN                                   33
N29  C  N33              GOTO      STSRINV01
N29  C                   END
      *
     C                   IF        XFFK = 'F'
      * <Invoice
     C                   EVAL      SDATA = %TRIM(TXT(003)) + %TRIM(TXT(004))
     C                             + %TRIM(TXT(005)) + %TRIM(TXT(006))
     C                             + %TRIM(TXT(007)) + %TRIM(TXT(008))
     C                   ELSE
      * <CreditNote
     C                   EVAL      SDATA = %TRIM(TXT(011)) + %TRIM(TXT(012))
     C                             + %TRIM(TXT(013)) + %TRIM(TXT(014))
     C                             + %TRIM(TXT(015)) + ' ' + %TRIM(TXT(016))
     C                             + %TRIM(TXT(017))
     C                   END
     C                   EXSR      OPDFIL
      * <cbc:UBLVersionID>
     C*                  EVAL      SDATA = '<cbc:UBLVersionID>' + '2.0'         Versjon 1.6
S37  C*                  EVAL      SDATA = '<cbc:UBLVersionID>' + '2.1'         Versjon 2.0
S37  C*                            + '</cbc:UBLVersionID>'
S37  C*                  EXSR      OPDFIL
      * <cbc:CustomizationID>
     C                   IF        XFFK = 'F'
     C                   EVAL      SDATA = '<cbc:CustomizationID>'
N37  C                             + 'urn:cen.eu:en16931:2017#compliant'
N37  C                             + '#urn:fdc:peppol.eu:2017:poacc:billing:3.0'
S37  C*                            + 'urn:www.cenbii.eu:transaction:'
S37  C*                            + 'biitrns010:ver2.0:extended:'
S37  C*                            + 'urn:www.peppol.eu:bis:peppol5a:'
S37  C*                            + 'ver2.0:extended:'
S37  C*                            + 'urn:www.difi.no:ehf:faktura:ver2.0'
     C                             + '</cbc:CustomizationID>'
     C*                            + 'biitrns010:ver1.0:extended:tionId'
     C*                            + 'urn:www.peppol.eu:bis:peppol4a:'
     C*                            + 'ver1.0:extended:'
     C*                            + 'urn:www.difi.no:ehf:faktura:ver1'
     C                   ELSE
     C                   EVAL      SDATA = '<cbc:CustomizationID>'
N37  C                             + 'urn:cen.eu:en16931:2017#compliant'
N37  C                             + '#urn:fdc:peppol.eu:2017:poacc:billing:3.0'
S37  C*                            + 'urn:www.cenbii.eu:transaction:'
S37  C*                            + 'biitrns014:ver2.0:'
S37  C*                            + 'extended:urn:www.peppol.eu:'
S37  C*                            + 'bis:peppol5a:ver2.0:'
S37  C*                            + 'extended:urn:www.difi.no:'
S37  C*                            + 'ehf:kreditnota:ver2.0'
S12  C*                            + 'biicoretrdm014:ver1.0:'
S12  C*                            + '#urn:www.cenbii.eu:profile:bii05:ver1.0'
S12  C*                            + '#urn:www.difi.no:ehf:kreditnota:ver1'
     C                             + '</cbc:CustomizationID>'
     C                   END
     C                   EXSR      OPDFIL
      * <cbc:ProfileID>
     C                   EVAL      SDATA = '<cbc:ProfileID>'
N37  C                             + 'urn:fdc:peppol.eu:2017:poacc:billing:01'
N37  C                             + ':1.0'
S37  C*                            + 'urn:www.cenbii.eu:profile:bii05:ver2.0'
     C                             + '</cbc:ProfileID>'
     C*                            + 'urn:www.cenbii.eu:profile:bii05:ver1.0'
     C                   EXSR      OPDFIL
      * <cbc:ID>
     C                   EVAL      SDATA = '<cbc:ID>'
     C                             + %TRIM(%EDITC(XFFN:'Z')) + '</cbc:ID>'
     C                   EXSR      OPDFIL
      * <cbc:IssueDate>
     C                   EVAL      SDATA = '<cbc:IssueDate>'
     C                             + %TRIM(FADATOÅ) + '-'
     C                             + %TRIM(FADATOM) + '-'
     C                             + %TRIM(FADATOD) + '</cbc:IssueDate>'
     C                   EXSR      OPDFIL
      * <cbc:InvoiceTypeCode>
     C                   IF        XFFK = 'F'
S04  C*                  EVAL      SDATA = '<cbc:InvoiceTypeCode>380'
N04  C                   EVAL      SDATA = '<cbc:InvoiceTypeCode '
N04  C                             + 'listID="UNCL1001">380'
     C                             + '</cbc:InvoiceTypeCode>'
N12  C                   EXSR      OPDFIL
     C                   ELSE
S04  C*                  EVAL      SDATA = '<cbc:InvoiceTypeCode>381'
S12  C*                  EVAL      SDATA = '<cbc:InvoiceTypeCode '
S12  C*                            + 'listID="UNCL1001">393'
S12  C*                            + '</cbc:InvoiceTypeCode>'
N37  C                   EVAL      SDATA = '<cbc:CreditNoteTypeCode>381'
N37  C                             + '</cbc:CreditNoteTypeCode>'
     C                   END
S12  C*                  EXSR      OPDFIL
      * <cbc:DocumentCurrencyCode>
     C                   EVAL      SDATA = '<cbc:DocumentCurrencyCode '
     C                             + 'listID="ISO4217">'
     C                             + %TRIM(XFVAL)+'</cbc:DocumentCurrencyCode>'
     C                   EXSR      OPDFIL
      *
      * Kreditnote: Send orginal fakturanr.
     C                   IF        XFFK = 'K'
N37   * <cac:OrderReference> start
N37  C                   EVAL      SDATA = '<cac:OrderReference>'
N37  C                             + %TRIM(SYSPEDREF) + '</cac:OrderReference>'
N37  C                   EXSR      OPDFIL
      * <cac:BillingReference> start
     C                   EVAL      SDATA = '<cac:BillingReference>'
     C                   EXSR      OPDFIL
      * <cac:InvoiceDocumentReference> start
     C                   EVAL      SDATA = '<cac:InvoiceDocumentReference>'
     C                   EXSR      OPDFIL
      * <cbc:ID>
     C                   SELECT
S02  C*                  WHEN      FASK = 'K' AND XFFN <> HEFNGK
N02  C                   WHEN      FASK = 'K' AND XFFN <> HEFNGK AND HEFNGK <> 0
     C                   MOVEL     HEFNGK        XAN07             7
     C                   EVAL      SDATA = '<cbc:ID>'
     C                             + %TRIM(XAN07) + '</cbc:ID>'
S02  C*                  WHEN      FASK = 'S' AND XFFN <> HEFNGS
S02  C*                  MOVEL     HEFNGK        XAN07             7
N02  C                   WHEN      FASK = 'S' AND XFFN <> HEFNGS AND HEFNGS <> 0
N02  C                   MOVEL     HEFNGS        XAN07             7
S12  C*                  EVAL      SDATA = '<cac:ID>'
N12  C                   EVAL      SDATA = '<cbc:ID>'
     C                             + %TRIM(XAN07) + '</cbc:ID>'
     C                   OTHER
     C*                  EVAL      SDATA = '<cbc:ID>See orderref.</cbc:ID>'
     C                   EVAL      XTXT801 = SYSPEDREF
     C                   Z-ADD     30            XN53              3 0
     C                   EXSR      KNVST
     C                   EVAL      SDATA = '<cbc:ID>'
     C                             + %TRIM(XTXT802) + '</cbc:ID>'
     C*                            + %TRIM(SYSPEDREF) + '</cbc:ID>'
     C                   ENDSL
     C                   EXSR      OPDFIL
      * </cac:InvoiceDocumentReference> start
     C                   EVAL      SDATA = '</cac:InvoiceDocumentReference>'
     C                   EXSR      OPDFIL
      * </cac:BillingReference> slutt
     C                   EVAL      SDATA = '</cac:BillingReference>'
     C                   EXSR      OPDFIL
      *
     C                   END
      *
     C                   IF        XFFK = 'F'
      * <cac:OrderReference> start
     C                   EVAL      SDATA = '<cac:OrderReference>'
     C                   EXSR      OPDFIL
      * <cbc:ID>
     C                   EVAL      XTXT801 = SYSPEDREF
     C                   Z-ADD     30            XN53              3 0
     C                   EXSR      KNVST
     C                   EVAL      SDATA = '<cbc:ID>'
     C                             + %TRIM(XTXT802) + '</cbc:ID>'
     C*                            + %TRIM(SYSPEDREF) + '</cbc:ID>'
     C                   EXSR      OPDFIL
      * </cac:OrderReference> slutt
     C                   EVAL      SDATA = '</cac:OrderReference>'
     C                   EXSR      OPDFIL
     C                   END
      * Andre ref.
     C     HEADFK        SETLL     FRISOK
     C     HEADFK        READE     FRISOK                                 33
     C                   DOW       *IN33 = *OFF                                 1<-B
     C                   IF        FSSOK <> *BLANKS                              2<-b
     C                   SORTA     DFS
     C     DFS(10)       IFNE      ' '                                            3<-B
     C                   MOVE      '0'           *IN34
     C     FASK          LOOKUP    DFS                                    34
S06  C* N34'B'           LOOKUP    DFS                                    33
N06  C  N34'B'           LOOKUP    DFS                                    34
     C                   IF        *IN34                                           4<-B
      * <cac:AdditionalDocumentReference> start
     C                   EVAL      SDATA = '<cac:AdditionalDocumentReference>'
     C                   EXSR      OPDFIL
      * <cbc:ID>
     C                   EVAL      XTXT801 = FSSOK
     C                   Z-ADD     35            XN53              3 0
     C                   EXSR      KNVST
     C                   EVAL      SDATA = '<cbc:ID>'
     C                             + %TRIM(XTXT802) + '</cbc:ID>'
     C*                            + %TRIM(FSSOK) + '</cbc:ID>'
     C                   EXSR      OPDFIL
      * <cbc:DocumentType>
     C                   EVAL      SDATA = '<cbc:DocumentType>'
     C                             + %TRIM(FSKODE) + '</cbc:DocumentType>'
     C                   EXSR      OPDFIL
      * </cac:AdditionalDocumentReference> slutt
     C                   EVAL      SDATA = '</cac:AdditionalDocumentReference>'
     C                   EXSR      OPDFIL
      *
     C                   END                                                       4<-E
     C                   END                                                      3<-E
     C                   END                                                     2<-E
     C     HEADFK        READE     FRISOK                                 33
     C  N33              ENDDO                                                  1<-E
      *
N03  C     CUNDC05K      CHAIN     CUNDC05                            33
N38  C                   IF        *IN33
N38  C     'fa'          CHAIN     ARKTXT                             33
N38  C  N33              EVAL      CMERGE = ARMRG
N38  C                   END
S38  C*                  IF        *IN33 OR CMERGE <> 'J'
N38  C                   IF        *IN33
     C                   EXSR      SRATTACH
N03  C                   ELSE
N03  C                   EXSR      SRATTACH2
N03  C                   END
     C                   EXSR      SRPARTY
     C                   IF        XFFK = 'F'
     C                   EXSR      SRPAYMENT
     C                   END
     C                   EXSR      SRTOTAL
      *
     C                   EXSR      SRINVLINE
      *
     C                   IF        XFFK = 'F'
      * </Invoice> slutt
     C                   EVAL      SDATA = %TRIM(TXT(009))
     C                   ELSE
      * </CreditNote> slutt
     C                   EVAL      SDATA = %TRIM(TXT(018))
     C                   END
     C                   EXSR      OPDFIL
      *
     C                   ENDSR
      *
      ***********************************************
     C     SRATTACH      BEGSR
      ***********************************************
N36  C                   MOVE      'N'           XFLERDOK          1
      *
     C                   IF        XFSAML = 'J'                                 1<-B
     C                   MOVE      'X2'          X_AVTYPE
     C                   ELSE                                                   1
S38  C*                  MOVE      'X1'          X_AVTYPE
N38  C                   MOVE      'fa'          X_AVTYPE
     C                   END                                                    1<-E
     C     ARKVEDKK      CHAIN     ARKVEDK                            33
N38  C                   IF        *IN33
N38   * KUNDE HAR IKKE SPESIFIKK. BRUK GENERELL FOR HELE FIRMA
N38  C     X_AVTYPE      CHAIN     ARKTXT                             33
N38  C  N33              EVAL      AVKVED = ARKVED
N38  C                   END
     C   33              MOVE      *BLANKS       AVKVED
     C                   IF        XFSAML = 'J'                                 1<-B
     C                   MOVE      'fs'          ARTYPE
     C                   MOVE      'fs'          AVTYPE
     C                   ELSE                                                   1
     C                   MOVE      'fa'          ARTYPE
     C                   MOVE      'fa'          AVTYPE
     C                   END                                                    1<-E
     C                   MOVEL     FIFN          ARUNDE
     C     ARKIVL02K     CHAIN     ARKIVL02                           33
     C                   IF        *IN33 = *OFF                                 1<-B
     C     TAGATTACH     TAG
     C                   IF        ((ARTYPE = AVTYPE) OR (ARTYPE = 'fx'))        2<-B
     C                   MOVEL     ARUNDE        XFN               7 0
     C     XFN           CABNE     FIFN          NESTEVEDL
     C                   ELSE                                                    2
     C     1             DO        30            XN                3 0            3<-B
     C                   SELECT                                                    4<-B
     C                   WHEN      AVK(XN) = ARTYPE                                4
     C                   LEAVE
     C                   WHEN      AVK(XN) = *BLANKS                               4
     C                   GOTO      NESTEVEDL
     C                   ENDSL                                                     4<-E
     C                   ENDDO                                                    3<-E
     C                   END                                                     2<-E
      *
     C     ARTYPE        CHAIN     ARKTXT                             33
     C                   IF        ARKLAG <> *BLANKS                             2<-B
     C     ARKLAGK       CHAIN     ARKEXT                             33
     C                   ELSE                                                    2
     C     FIFIRM        CHAIN     FIRMARC                            33
     C                   END                                                     2<-E
      *
     C     '.'           SCAN      ARLINK                                 33
     C  N33              EVAL      X_ARLINK = %TRIM(ARLINK) + '.pdf'
     C   33              EVAL      X_ARLINK = %TRIM(ARLINK)
      * <cac:AdditionalDocumentReference> start
     C                   EVAL      SDATA = '<cac:AdditionalDocumentReference>'
     C                   EXSR      OPDFIL
      * <cbc:ID>
     C                   EVAL      SDATA = '<cbc:ID>'
     C                             + %TRIM(X_ARLINK) + '</cbc:ID>'
     C                   EXSR      OPDFIL
      * <cbc:DocumentType>
N20  C                   IF        ARTYPE = 'fa'
N20  C                   IF        XFFK = 'F'
N20  C                   EVAL      XDOKTYPE = 'Commercial invoice'
N20  C                   ELSE
N20  C                   EVAL      XDOKTYPE = 'Credit note'
N20  C                   END
N20  C                   ELSE
N20  C                   EVAL      XDOKTYPE = ARTXT
N20  C                   END
     C                   EVAL      SDATA = '<cbc:DocumentType>'
S20  C*                            + %TRIM(ARTXT) + '</cbc:DocumentType>'
N20  C                             + %TRIM(XDOKTYPE) + '</cbc:DocumentType>'
     C                   EXSR      OPDFIL
      * <cac:Attachment> start
     C                   EVAL      SDATA = '<cac:Attachment>'
     C                   EXSR      OPDFIL
      * <cac:ExternalReference> start
     C                   EVAL      SDATA = '<cac:ExternalReference>'
     C                   EXSR      OPDFIL
      * <cbc:URI>
     C                   EVAL      SDATA = '<cbc:URI>'
     C                             + 'http://' + %TRIM(ARCPAE) + '/'
     C                   IF        ARCANE <> *BLANKS                             2<-B
     C                   EVAL      SDATA = %TRIM(SDATA) + %TRIM(ARCANE) + '/'
     C                   END                                                     2<-E
     C                   EVAL      SDATA = %TRIM(SDATA) + %TRIM(X_ARLINK)
     C                             + '</cbc:URI>'
     C                   EXSR      OPDFIL
      * </cac:ExternalReference> slutt
     C                   EVAL      SDATA = '</cac:ExternalReference>'
     C                   EXSR      OPDFIL
      * </cac:Attachment> slutt
     C                   EVAL      SDATA = '</cac:Attachment>'
     C                   EXSR      OPDFIL
      * </cac:AdditionalDocumentReference> slutt
     C                   EVAL      SDATA = '</cac:AdditionalDocumentReference>'
     C                   EXSR      OPDFIL
      *
      * Send vedlegg som binært objekt
      * <cac:AdditionalDocumentReference> start
     C                   EVAL      SDATA = '<cac:AdditionalDocumentReference>'
     C                   EXSR      OPDFIL
      * <cbc:ID>
     C                   EVAL      SDATA = '<cbc:ID>'
     C                             + %TRIM(X_ARLINK) + '</cbc:ID>'
     C                   EXSR      OPDFIL
      * <cbc:DocumentType>
N20  C                   IF        ARTYPE = 'fa'
N20  C                   IF        XFFK = 'F'
N20  C                   EVAL      XDOKTYPE = 'Commercial invoice'
N20  C                   ELSE
N20  C                   EVAL      XDOKTYPE = 'Credit note'
N20  C                   END
N20  C                   ELSE
N20  C                   EVAL      XDOKTYPE = ARTXT
N20  C                   END
     C                   EVAL      SDATA = '<cbc:DocumentType>'
S20  C*                            + %TRIM(ARTXT) + '</cbc:DocumentType>'
N20  C                             + %TRIM(XDOKTYPE) + '</cbc:DocumentType>'
     C                   EXSR      OPDFIL
      * <cac:Attachment> start
     C                   EVAL      SDATA = '<cac:Attachment>'
     C                   EXSR      OPDFIL
      * <cbc:EmbeddedDocumentBinaryObject
     C                   EVAL      SDATA = '<cbc:EmbeddedDocumentBinaryObject '
N37  C                             + 'mimeCode="application/pdf" '
N38  C                             + 'filename="' + %TRIM(X_S0020) + '.pdf">'
S38  C*                            + 'filename="' + %TRIM(S0020) + '.pdf">'
S37  C*                            + 'mimeCode="application/pdf">'
     C                   EXSR      OPDFIL
      *
     C                   EXSR      SRHENTDOK
      *
      * </cbc:EmbeddedDocumentBinaryObject
     C                   EVAL      SDATA = '</cbc:EmbeddedDocumentBinaryObject>'
     C                   EXSR      OPDFIL
      * </cac:Attachment> slutt
     C                   EVAL      SDATA = '</cac:Attachment>'
     C                   EXSR      OPDFIL
      * </cac:AdditionalDocumentReference> slutt
     C                   EVAL      SDATA = '</cac:AdditionalDocumentReference>'
     C                   EXSR      OPDFIL
      *
     C     NESTEVEDL     TAG
     C     ARKIVL02K     READE     ARKIVL02                               33
     C  N33              GOTO      TAGATTACH
     C                   END                                                    1<-E
      *
     C                   ENDSR
      *
N03   ***********************************************
N03  C     SRATTACH2     BEGSR
N03   ***********************************************
N03   * SJEKK OM DET FINNES FLERE VEDLEGG
N03  C                   MOVE      *ZEROS        XANTVEDL          3 0
S38  C*                  MOVE      'X1'          X_AVTYPE
N38  C                   MOVE      'fa'          X_AVTYPE
N03  C     ARKVEDKK      CHAIN     ARKVEDK                            33
N38  C                   IF        *IN33
N38   * KUNDE HAR IKKE SPESIFIKK. BRUK GENERELL FOR HELE FIRMA
N38  C     X_AVTYPE      CHAIN     ARKTXT                             33
N38  C  N33              EVAL      AVKVED = ARKVED
N38  C                   END
N03  C   33              MOVE      *BLANKS       AVKVED
N03  C                   MOVE      'fa'          AVTYPE
N03  C                   MOVE      XFFN          UFN
N03   *
N03  C     ARKIVL02K     CHAIN     ARKIVL02                           33
N03  C                   DOW       *IN33 = *OFF                                 1<-B
N38   * KUN pdf være med
N38  C     '.'           SCAN      ARLINK                                 33
N38  C  N33              EVAL      X_ARLINK = %TRIM(ARLINK) + '.pdf'
N40  C   33              EVAL      X_ARLINK = %TRIM(ARLINK)
N38  C     '.pdf'        SCAN      X_ARLINK                               33
N38  C                   IF        *IN33                                        1a<B
N03  C                   IF        ARTYPE = AVTYPE                               2<-B
N03  C                   IF        ARUNDE = UFN                                   3<-B
N03  C                   ADD       1             XANTVEDL
N03  C                   END                                                      3<-E
N03  C                   ELSE                                                    2
N03  C     1             DO        30            XN                3 0            3<-B
N03  C                   SELECT                                                    4<-B
N03  C                   WHEN      ARTYPE = AVK(XN)                                4
N03  C                   ADD       1             XANTVEDL
N03  C                   WHEN      AVK(XN) = *BLANKS                               4
N03  C                   LEAVE
N03  C                   ENDSL                                                     4<-E
N03  C                   ENDDO                                                    3<-E
N03  C                   END                                                     2<-E
N38  C                   END                                                    1a<E
N03  C     ARKIVL02K     READE     ARKIVL02                               33
N03  C                   ENDDO                                                  1<-E
N03   *
N03  C                   IF        XANTVEDL < 2                                 1<-B
N03  C                   EXSR      SRATTACH
N03  C                   ELSE                                                   1
N03  C                   MOVE      FIAVD         UAVD
N03  C                   MOVE      FIOPD         UOPD
N03  C                   CALL      'SYXML31'
N03  C                   PARM                    FIFIRM
N03  C                   PARM                    UFN               7
N03  C                   PARM                    UAVD              4
N03  C                   PARM                    UOPD              7
N03  C                   PARM                    AVKVED
N03   *
N03   * Send vedlegg som binært objekt
N03   * <cac:AdditionalDocumentReference> start
N03  C                   EVAL      SDATA = '<cac:AdditionalDocumentReference>'
N03  C                   EXSR      OPDFIL
N03   * <cbc:ID>
N03  C                   EVAL      SDATA = '<cbc:ID>'
N03  C                             + 'Attachments' + '</cbc:ID>'
N03  C                   EXSR      OPDFIL
N03   * <cbc:DocumentType>
N20  C                   IF        XFFK = 'F'
N20  C                   EVAL      XDOKTYPE = 'Commercial invoice'
N20  C                   ELSE
N20  C                   EVAL      XDOKTYPE = 'Credit note'
N20  C                   END
N03  C                   EVAL      SDATA = '<cbc:DocumentType>'
S20  C*                            + 'Merged' + '</cbc:DocumentType>'
N20  C                             + %TRIM(XDOKTYPE) + '</cbc:DocumentType>'
N03  C                   EXSR      OPDFIL
N03   * <cac:Attachment> start
N03  C                   EVAL      SDATA = '<cac:Attachment>'
N03  C                   EXSR      OPDFIL
N03   * <cbc:EmbeddedDocumentBinaryObject
N03  C                   EVAL      SDATA = '<cbc:EmbeddedDocumentBinaryObject '
N37  C                             + 'mimeCode="application/pdf" '
N38  C                             + 'filename="' + %TRIM(X_S0020) + '.pdf">'
S38  C*                            + 'filename="' + %TRIM(S0020) + '.pdf">'
S37  C*                            + 'mimeCode="application/pdf">'
N03  C                   EXSR      OPDFIL
N03   *
N03  C                   EVAL      ARCANE = '/pdf/tmp'
N03  C                   EVAL      ARLINK = 'EHF' + %TRIM(UFN) + '.pdf'
N03  C                   EXSR      SRHENTDOK
N03   *
N03   * </cbc:EmbeddedDocumentBinaryObject
N03  C                   EVAL      SDATA = '</cbc:EmbeddedDocumentBinaryObject>'
N03  C                   EXSR      OPDFIL
N03   * </cac:Attachment> slutt
N03  C                   EVAL      SDATA = '</cac:Attachment>'
N03  C                   EXSR      OPDFIL
N03   * </cac:AdditionalDocumentReference> slutt
N03  C                   EVAL      SDATA = '</cac:AdditionalDocumentReference>'
N03  C                   EXSR      OPDFIL
N03   *
N03  C                   EVAL      UCMD = 'RMVLNK OBJLNK(' + XAPS
N03  C                             + '/pdf/tmp/EHF' + %TRIM(UFN) + '.pdf'
N03  C                             + XAPS + ') '
N03  C                   CALL      'QCMDEXC'                            33
N03  C                   PARM                    UCMD
N03  C                   PARM                    UCMDL
N03   *
N03  C                   END                                                    1<-E
N03   *
N03  C                   ENDSR
N03   *
      ***********************************************
     C     SRHENTDOK     BEGSR
      ***********************************************
     C                   callp     close( FILE_o )
N36   * SLÅ SAMMEN
N36  C                   IF        XFLERDOK = 'J'
N36  C                   MOVE      *BLANKS       WCMD            300
N36  C                   EVAL      WCMD = 'QSH CMD(' + XAPS + 'cat'
N36  C                             + ' '
N36  C                             + %trimr(FILNAM1)
N36  C                             + ' >> '
N36  C                             + %trimr(FILNAM)
N36  C                             + XAPS + ')'
N36  C                   CALLP     RUNCMD(WCMD:300)
N36  C                   END
N36  C                   EVAL      XFLERDOK = 'J'
      *
     C                   IF        %SUBST(ARCANE:1:1) = '/'
     C                   EVAL      FILNAM2 = *BLANKS
     C                   ELSE
     C                   EVAL      FILNAM2 = '/'
     C                   END
     C                   EVAL      FILNAM2 = %TRIM(FILNAM2) + %TRIM(ARCANE)
     C                             + '/' + %TRIM(ARLINK)
     C     '.'           SCAN      ARLINK                                 33
     C  N33              EVAL      FILNAM2 = %TRIM(FILNAM2) + '.pdf'
     C                   EVAL      FILNAM3 = '/' + %TRIM(FILIBF)
     C                             + '/EHF-VEDLEGG.enc'

     C                   MOVE      *BLANKS       WCMD            300
     C                   EVAL      WCMD = 'QSH CMD(' + XAPS + 'openssl e'
     C                             + 'nc -base64 -in ' + %trimr(FILNAM2)
     C                             + ' -out ' + %trimr(FILNAM3) + XAPS + ')'
      *   openssl enc -base64 -in file.txt -out file.txt.enc

     C                   CALLP     RUNCMD(WCMD:300)

     C                   MOVE      *BLANKS       WCMD            300
     C                   EVAL      WCMD = 'QSH CMD(' + XAPS + 'cat'
     C*                            + ' '
     C*                            + %trimr(FILNAM)
     C                             + ' '
     C                             + %trimr(FILNAM3)
     C                             + ' >> '
     C                             + %trimr(FILNAM)
     C                             + XAPS + ')'

     C                   CALLP     RUNCMD(WCMD:300)
      *
     C                   eval      FILE_o = open( %TrimR( FilNam1 )
     C                               : O_CREAT+O_TRUNC+O_WRONLY
     C                                + O_TEXT_CREAT+O_CCSID+O_TEXTDATA
     C                               : S_IRUSR + S_IWUSR
     C                               : 1208
     C                               : 0)
      *
     C                   ENDSR
      *
      ***********************************************
     C     SRPARTY       BEGSR
      ***********************************************
      * Avsender
     C     KODTAK        CHAIN     KODTA                              33
     C                   MOVE      KOAKNR        KUNDNR
     C     CUNDL01K      CHAIN     CUNDL01                            33
N38   *
N38   * AVSENDERS ORG.NR KAN ER REGISTRERT I PARAMTERFIL
N38  C     SYPARL1K0     CHAIN     SYPARL1                            33
N38  C                   IF        *IN33 = *OFF AND SYVRDA <> *BLANKS
N38  C                   EVAL      SYRG = SYVRDA
N38  C                   END
      *
      * <cac:AccountingSupplierParty> start
     C                   EVAL      SDATA = '<cac:AccountingSupplierParty>'
     C                   EXSR      OPDFIL
      * <cac:Party> start
     C                   EVAL      SDATA = '<cac:Party>'
     C                   EXSR      OPDFIL
      * <cbc:EndpointID>
     C*                  EVAL      SDATA = '<cbc:EndpointID>'
     C*                            + '9908:' + %TRIM(SYRG)
     C                   EVAL      SDATA = '<cbc:EndpointID '
S37  C*                            + 'schemeID="NO:ORGNR">' + %TRIM(SYRG)
N37  C                             + 'schemeID="0007">' + %TRIM(SYRG)
     C                             + '</cbc:EndpointID>'
     C                   EXSR      OPDFIL
      * <cac:PartyName> start
     C                   EVAL      SDATA = '<cac:PartyName>'
     C                   EXSR      OPDFIL
      * <cbc:Name>
     C                   EVAL      XTXT801 = KNAVN
     C                   Z-ADD     30            XN53              3 0
     C                   EXSR      KNVST
     C                   EVAL      SDATA = '<cbc:Name>'
     C                             + %TRIM(XTXT802) + '</cbc:Name>'
     C                   EXSR      OPDFIL
      * </cac:PartyName> slutt
     C                   EVAL      SDATA = '</cac:PartyName>'
     C                   EXSR      OPDFIL
      * <cac:PostalAddress> start
     C                   EVAL      SDATA = '<cac:PostalAddress>'
     C                   EXSR      OPDFIL
      * <cbc:Postbox>
     C                   EVAL      XTXT801 = %TRIM(ADR2)
     C                   Z-ADD     30            XN53              3 0
     C                   EXSR      KNVST
     C                   EVAL      SDATA = '<cbc:Postbox>'
     C                             + %TRIM(XTXT802) + '</cbc:Postbox>'
     C                   EXSR      OPDFIL
      * <cbc:StreetName>
     C                   EVAL      XTXT801 = %TRIM(ADR1)
     C                   Z-ADD     30            XN53              3 0
     C                   EXSR      KNVST
     C                   EVAL      SDATA = '<cbc:StreetName>'
     C                             + %TRIM(XTXT802) + '</cbc:StreetName>'
     C                   EXSR      OPDFIL
      * <cbc:CityName>
     C                   EVAL      XTXT801 = %TRIM(ADR3)
     C                   Z-ADD     61            XN53              3 0
     C                   EXSR      KNVST
     C                   EVAL      SDATA = '<cbc:CityName>'
     C                             + %TRIM(XTXT802) + '</cbc:CityName>'
     C                   EXSR      OPDFIL
      * <cbc:PostalZone>
     C                   IF        POSTNR = 0
     C                   EVAL      XTXT801 = SYPOGE
     C                   ELSE
     C                   EVAL      XTXT801 = *BLANKS
     C                   MOVEL     POSTNR        XTXT801
     C                   END
     C                   Z-ADD     10            XN53              3 0
     C                   EXSR      KNVST
     C                   EVAL      SDATA = '<cbc:PostalZone>'
     C                             + %TRIM(XTXT802) + '</cbc:PostalZone>'
     C                   EXSR      OPDFIL
      * <cac:Country> start
     C                   EVAL      SDATA = '<cac:Country>'
     C                   EXSR      OPDFIL
      * <cbc:IdentificationCode>
     C                   IF        SYLAND = *BLANKS
     C                   EVAL      SYLAND = FILAND
     C                   END
     C*                  EVAL      SDATA = '<cbc:IdentificationCode>'
     C                   EVAL      SDATA = '<cbc:IdentificationCode '
     C                             + 'listID="ISO3166-1:Alpha2" '
     C                             + 'listAgencyID="6">'
     C                             + SYLAND + '</cbc:IdentificationCode>'
     C                   EXSR      OPDFIL
      * </cac:Country> slutt
     C                   EVAL      SDATA = '</cac:Country>'
     C                   EXSR      OPDFIL
      * </cac:PostalAddress> slutt
     C                   EVAL      SDATA = '</cac:PostalAddress>'
     C                   EXSR      OPDFIL
      * <cac:PartyTaxScheme> start
     C                   EVAL      SDATA = '<cac:PartyTaxScheme>'
     C                   EXSR      OPDFIL
      * <cbc:CompanyID>
S37  C*                  EVAL      SDATA = '<cbc:CompanyID>'
N37  C                   EVAL      SDATA = '<cbc:CompanyID schemeID="0007">'
S04  C*                            + 'NO' + %TRIM(SYRG) + 'MVA'
S37  C*                            + %TRIM(SYRG) + 'MVA'
N37  C                             + %TRIM(SYLAND) + %TRIM(SYRG) + 'MVA'
     C                             + '</cbc:CompanyID>'
     C*                  EVAL      SDATA = '<cbc:CompanyID schemeID="NO:VAT" '
     C*                            + 'schemAgencyID="82">' + %TRIM(SYRG) + 'MVA'
     C                   EXSR      OPDFIL
      * <cac:TaxScheme> start
     C                   EVAL      SDATA = '<cac:TaxScheme>'
     C                   EXSR      OPDFIL
      * <cbc:ID
      *
S37  C*                  EVAL      SDATA = '<cbc:ID schemeID="UN/ECE 5153" '
S37  C*                            + 'schemeAgencyID="6">VAT</cbc:ID>'
N37  C                   EVAL      SDATA = '<cbc:ID>VAT</cbc:ID>'
     C                   EXSR      OPDFIL
      * </cac:TaxScheme> slutt
     C                   EVAL      SDATA = '</cac:TaxScheme>'
     C                   EXSR      OPDFIL
      * </cac:PartyTaxScheme> start
     C                   EVAL      SDATA = '</cac:PartyTaxScheme>'
     C                   EXSR      OPDFIL
      * <cac:PartyLegalEntity> start
     C                   EVAL      SDATA = '<cac:PartyLegalEntity>'
     C                   EXSR      OPDFIL
      * <cbc:RegistrationName>
     C                   EVAL      XTXT801 = KNAVN
     C                   Z-ADD     30            XN53              3 0
     C                   EXSR      KNVST
     C                   EVAL      SDATA = '<cbc:RegistrationName>'
     C                             + %TRIM(XTXT802) + '</cbc:RegistrationName>'
     C                   EXSR      OPDFIL
      * <cbc:CompanyID
S37  C*                  EVAL      SDATA = '<cbc:CompanyID schemeID="NO:ORGNR" '
S37  C*                            + 'schemeName="Foretaksregisteret" '
S37  C*                            + 'schemeAgencyID="82">'
S37  C*                            + %TRIM(SYRG) + '</cbc:CompanyID>'
N37  C                   EVAL      SDATA = '<cbc:CompanyID schemeID="0007">'
N37  C                             +'NO'+ %TRIM(SYRG) +'MVA'+ '</cbc:CompanyID>'
     C                   EXSR      OPDFIL
      * </cac:PartyLegalEntity> slutt
     C                   EVAL      SDATA = '</cac:PartyLegalEntity>'
     C                   EXSR      OPDFIL
      * <cac:Contact> start
     C                   EVAL      SDATA = '<cac:Contact>'
     C                   EXSR      OPDFIL
      * <cbc:ID>
     C     KODTSFK       CHAIN     KODTSF                             33
     C                   EVAL      XTXT801 = KOSFNV
     C                   Z-ADD     30            XN53              3 0
     C                   EXSR      KNVST
     C                   EVAL      SDATA = '<cbc:ID>'
     C                             + %TRIM(XTXT802) + '</cbc:ID>'
     C                   EXSR      OPDFIL
      * </cac:Contact> slutt
     C                   EVAL      SDATA = '</cac:Contact>'
     C                   EXSR      OPDFIL
      * </cac:Party> slutt
     C                   EVAL      SDATA = '</cac:Party>'
     C                   EXSR      OPDFIL
      * </cac:AccountingSupplierParty> slutt
     C                   EVAL      SDATA = '</cac:AccountingSupplierParty>'
     C                   EXSR      OPDFIL
      *
      * Mottaker
     C                   MOVE      XXKN          KUNDNR
     C     CUNDL01K      CHAIN     CUNDL01                            33
N38   *
N38   * MOTTAGERS ORG.NR KAN ER REGISTRERT I PARAMTERFIL
N38  C     SYPARL1K      CHAIN     SYPARL1                            33
N38  C                   IF        *IN33 = *OFF AND SYVRDA <> *BLANKS
N38  C                   EVAL      SYRG = SYVRDA
N38  C                   END
      *
      * <cac:AccountingCustomerParty> start
     C                   EVAL      SDATA = '<cac:AccountingCustomerParty>'
     C                   EXSR      OPDFIL
      * <cac:Party> start
     C                   EVAL      SDATA = '<cac:Party>'
     C                   EXSR      OPDFIL
      * <cbc:EndpointID>
     C*                  EVAL      SDATA = '<cbc:EndpointID>'
     C*                            + '9908:' + %TRIM(SYRG)
     C                   EVAL      SDATA = '<cbc:EndpointID '
S37  C*                            + 'schemeID="NO:ORGNR">' + %TRIM(SYRG)
N37  C                             + 'schemeID="0007">' + %TRIM(SYRG)
     C                             + '</cbc:EndpointID>'
     C                   EXSR      OPDFIL
      * <cac:PartyIdentification> start
     C*                  EVAL      SDATA = '<cac:PartyIdentification>'
     C*                  EXSR      OPDFIL
      * <cbc:ID>
     C*                  EVAL      SDATA = '<cbc:ID>'
     C*                            + %TRIM(%EDITC(XFKN:'Z')) + '</cbc:ID>'
     C*                  EXSR      OPDFIL
      * </cac:PartyIdentification> slutt
     C*                  EVAL      SDATA = '</cac:PartyIdentification>'
     C*                  EXSR      OPDFIL
      * <cac:PartyName> start
     C                   EVAL      SDATA = '<cac:PartyName>'
     C                   EXSR      OPDFIL
      * <cbc:Name>
     C                   EVAL      XTXT801 = KNAVN
     C                   Z-ADD     30            XN53              3 0
     C                   EXSR      KNVST
     C                   EVAL      SDATA = '<cbc:Name>'
     C                             + %TRIM(XTXT802) + '</cbc:Name>'
     C                   EXSR      OPDFIL
      * </cac:PartyName> slutt
     C                   EVAL      SDATA = '</cac:PartyName>'
     C                   EXSR      OPDFIL
      * <cac:PostalAddress> start
     C                   EVAL      SDATA = '<cac:PostalAddress>'
     C                   EXSR      OPDFIL
      * <cbc:Postbox>
     C                   EVAL      XTXT801 = %TRIM(ADR2)
     C                   Z-ADD     30            XN53              3 0
     C                   EXSR      KNVST
     C                   EVAL      SDATA = '<cbc:Postbox>'
     C                             + %TRIM(XTXT802) + '</cbc:Postbox>'
     C                   EXSR      OPDFIL
      * <cbc:StreetName>
     C                   EVAL      XTXT801 = %TRIM(ADR1)
     C                   Z-ADD     30            XN53              3 0
     C                   EXSR      KNVST
     C                   EVAL      SDATA = '<cbc:StreetName>'
     C                             + %TRIM(XTXT802) + '</cbc:StreetName>'
     C                   EXSR      OPDFIL
      * <cbc:CityName>
     C                   EVAL      XTXT801 = %TRIM(ADR3)
     C                   Z-ADD     61            XN53              3 0
     C                   EXSR      KNVST
     C                   EVAL      SDATA = '<cbc:CityName>'
     C                             + %TRIM(XTXT802) + '</cbc:CityName>'
     C                   EXSR      OPDFIL
      * <cbc:PostalZone>
     C                   IF        POSTNR = 0
     C                   EVAL      XTXT801 = SYPOGE
     C                   ELSE
     C                   EVAL      XTXT801 = *BLANKS
     C                   MOVEL     POSTNR        XTXT801
     C                   END
     C                   Z-ADD     10            XN53              3 0
     C                   EXSR      KNVST
     C                   EVAL      SDATA = '<cbc:PostalZone>'
     C                             + %TRIM(XTXT802) + '</cbc:PostalZone>'
     C                   EXSR      OPDFIL
      * <cac:Country> start
     C                   EVAL      SDATA = '<cac:Country>'
     C                   EXSR      OPDFIL
      * <cbc:IdentificationCode>
     C                   IF        SYLAND = *BLANKS
     C                   EVAL      SYLAND = FILAND
     C                   END
     C*                  EVAL      SDATA = '<cbc:IdentificationCode>'
     C                   EVAL      SDATA = '<cbc:IdentificationCode '
     C                             + 'listID="ISO3166-1:Alpha2" '
     C                             + 'listAgencyID="6">'
     C                             + SYLAND + '</cbc:IdentificationCode>'
     C                   EXSR      OPDFIL
      * </cac:Country> slutt
     C                   EVAL      SDATA = '</cac:Country>'
     C                   EXSR      OPDFIL
      * </cac:PostalAddress> slutt
     C                   EVAL      SDATA = '</cac:PostalAddress>'
     C                   EXSR      OPDFIL
      * <cac:PartyLegalEntity> start
     C                   EVAL      SDATA = '<cac:PartyLegalEntity>'
     C                   EXSR      OPDFIL
      * <cbc:RegistrationName>
     C                   EVAL      XTXT801 = KNAVN
     C                   Z-ADD     30            XN53              3 0
     C                   EXSR      KNVST
     C                   EVAL      SDATA = '<cbc:RegistrationName>'
     C                             + %TRIM(XTXT802) + '</cbc:RegistrationName>'
     C                   EXSR      OPDFIL
      * <cbc:CompanyID
N37  C                   IF        SYLAND = *BLANKS
N37  C                   EVAL      SYLAND = FILAND
N37  C                   END
N37  C                   EVAL      SDATA = '<cbc:CompanyID schemeID="0007">'
N37  C                             + %TRIM(SYLAND) + %TRIM(SYRG)
N37  C                             + '</cbc:CompanyID>'
S37  C*                  EVAL      SDATA = '<cbc:CompanyID>'
S37  C*                            + %TRIM(SYRG) + '</cbc:CompanyID>'
     C*                  EVAL      SDATA = '<cbc:CompanyID schemeID="NO:VAT" '
     C*                            + 'schemAgencyID="82">' + %TRIM(SYRG) + 'MVA'
     C                   EXSR      OPDFIL
      * </cac:PartyLegalEntity> slutt
     C                   EVAL      SDATA = '</cac:PartyLegalEntity>'
     C                   EXSR      OPDFIL
      *
      * <cac:Contact> start
     C                   EVAL      SDATA = '<cac:Contact>'
     C                   EXSR      OPDFIL
      * <cbc:ID>
     C                   IF        KPERS = *BLANKS
     C                   EVAL      XTXT801 = '.'
     C                   ELSE
     C                   EVAL      XTXT801 = KPERS
     C                   END
     C                   Z-ADD     30            XN53              3 0
     C                   EXSR      KNVST
     C                   EVAL      SDATA = '<cbc:ID>'
     C                             + %TRIM(XTXT802) + '</cbc:ID>'
     C                   EXSR      OPDFIL
      * </cac:Contact> slutt
     C                   EVAL      SDATA = '</cac:Contact>'
     C                   EXSR      OPDFIL
      *
      * </cac:Party> slutt
     C                   EVAL      SDATA = '</cac:Party>'
     C                   EXSR      OPDFIL
      * </cac:AccountingCustomerParty> slutt
     C                   EVAL      SDATA = '</cac:AccountingCustomerParty>'
     C                   EXSR      OPDFIL
      *
     C                   IF        XFFK = 'F'
      * DeliveryPart
      *
      * <cac:Delivery> start
     C                   EVAL      SDATA = '<cac:Delivery>'
     C                   EXSR      OPDFIL
      * <cbc:ActualDeliveryDate>
     C                   EVAL      SDATA = '<cbc:ActualDeliveryDate>'
     C                             + HEDTOPÅ + '-' + HEDTOPM + '-' + HEDTOPD
     C                             + '</cbc:ActualDeliveryDate>'
     C                   EXSR      OPDFIL
      * <cac:DeliveryLocation> start
     C                   EVAL      SDATA = '<cac:DeliveryLocation>'
     C                   EXSR      OPDFIL
      * <cac:Address> start
     C                   EVAL      SDATA = '<cac:Address>'
     C                   EXSR      OPDFIL
      * <cbc:StreetName>
S01  C*                  IF        FASK = 'S'
S01  C*                  EVAL      XTXT801 = HENAS
S01  C*                  ELSE
     C                   EVAL      XTXT801 = HENAK
S01  C*                  END
     C                   Z-ADD     30            XN53              3 0
     C                   EXSR      KNVST
     C                   EVAL      SDATA = '<cbc:StreetName>'
     C                             + %TRIM(XTXT802) + '</cbc:StreetName>'
     C                   EXSR      OPDFIL
      * <cbc:BuildingNumber>
S01  C*                  IF        FASK = 'S'
S01  C*                  EVAL      XTXT801 = HEADS1
S01  C*                  ELSE
     C                   EVAL      XTXT801 = HEADK1
S01  C*                  END
     C                   Z-ADD     30            XN53              3 0
     C                   EXSR      KNVST
     C                   EVAL      SDATA = '<cbc:BuildingNumber>'
     C                             + %TRIM(XTXT802) + '</cbc:BuildingNumber>'
     C                   EXSR      OPDFIL
      * <cbc:CityName>
S01  C*                  IF        FASK = 'S'
S01  C*                  IF        HEADS3 = *BLANKS
S01  C*                  EVAL      XTXT801 = HEADS2
S01  C*                  ELSE
S01  C*                  EVAL      XTXT801 = HEADS3
S01  C*                  END
S01  C*                  ELSE
     C                   IF        HEADK3 = *BLANKS
     C                   EVAL      XTXT801 = HEADK2
     C                   ELSE
     C                   EVAL      XTXT801 = HEADK3
     C                   END
S01  C*                  END
     C                   Z-ADD     30            XN53              3 0
     C                   EXSR      KNVST
     C                   EVAL      SDATA = '<cbc:CityName>'
     C                             + %TRIM(XTXT802) + '</cbc:CityName>'
     C                   EXSR      OPDFIL
      * <cbc:PostalZone>
S01  C*                  IF        FASK = 'S'
S01  C*                  IF        HEADS3 = *BLANKS
S01  C*                  EVAL      XTXT801 = %SUBST(HEADS2:1:5)
S01  C*                  ELSE
S01  C*                  EVAL      XTXT801 = %SUBST(HEADS3:1:5)
S01  C*                  END
S01  C*                  ELSE
     C                   IF        HEADK3 = *BLANKS
     C                   EVAL      XTXT801 = %SUBST(HEADK2:1:5)
     C                   ELSE
     C                   EVAL      XTXT801 = %SUBST(HEADK3:1:5)
     C                   END
S01  C*                  END
     C                   Z-ADD     30            XN53              3 0
     C                   EXSR      KNVST
     C                   EVAL      SDATA = '<cbc:PostalZone>'
     C                             + %TRIM(XTXT802) + '</cbc:PostalZone>'
     C                   EXSR      OPDFIL
      * <cac:Country> start
     C                   EVAL      SDATA = '<cac:Country>'
     C                   EXSR      OPDFIL
      * <cbc:IdentificationCode>
     C*                  EVAL      SDATA = '<cbc:IdentificationCode>'
     C                   EVAL      SDATA = '<cbc:IdentificationCode '
     C                             + 'listID="ISO3166-1:Alpha2" '
     C                             + 'listAgencyID="6">'
     C                             + SYLAND + '</cbc:IdentificationCode>'
     C                   EXSR      OPDFIL
      * </cac:Country> slutt
     C                   EVAL      SDATA = '</cac:Country>'
     C                   EXSR      OPDFIL
      * </cac:Address> slutt
     C                   EVAL      SDATA = '</cac:Address>'
     C                   EXSR      OPDFIL
      * </cac:DeliveryLocation> slutt
     C                   EVAL      SDATA = '</cac:DeliveryLocation>'
     C                   EXSR      OPDFIL
      * </cac:Delivery> slutt
     C                   EVAL      SDATA = '</cac:Delivery>'
     C                   EXSR      OPDFIL
      *
     C                   ELSE
      * PayeeParty
      *
      * <cac:PayeeParty> start
     C*                  EVAL      SDATA = '<cac:PayeeParty>'
     C*                  EXSR      OPDFIL
      * </cac:PayeeParty> slutt
     C*                  EVAL      SDATA = '</cac:PayeeParty>'
     C*                  EXSR      OPDFIL
      *
     C                   END
      *
     C                   ENDSR
      *
      ***********************************************
     C     SRPAYMENT     BEGSR
      ***********************************************
      * <cac:PaymentMeans> start
     C                   EVAL      SDATA = '<cac:PaymentMeans>'
     C                   EXSR      OPDFIL
      * <cbc:PaymentMeansCode>
     C*                  EVAL      SDATA = '<cbc:PaymentMeansCode>'
     C                   EVAL      SDATA = '<cbc:PaymentMeansCode '
     C                             + 'listID="UNCL4461" listAgencyID="NES">'
N11  C                             + '30' + '</cbc:PaymentMeansCode>'
S11  C*                            + %TRIM(XFBB) + '</cbc:PaymentMeansCode>'
     C                   EXSR      OPDFIL
      * <cbc:PaymentDueDate>
     C                   EVAL      SDATA = '<cbc:PaymentDueDate>'
     C                             + FADAFFÅ + '-' + FADAFFM + '-' + FADAFFD
     C                             + '</cbc:PaymentDueDate>'
     C                   EXSR      OPDFIL
      * <cbc:PaymentID>
N39  C                   IF        XFKID <> *BLANKS
     C                   EVAL      SDATA = '<cbc:PaymentID>'
     C                             + %TRIM(XFKID) + '</cbc:PaymentID>'
     C                   EXSR      OPDFIL
N39  C                   END
      * <cac:PayeeFinancialAccount> start
     C                   EVAL      SDATA = '<cac:PayeeFinancialAccount>'
     C                   EXSR      OPDFIL
      * <cbc:ID
N31  C                   IF        %SUBST(XFKT:1:1)<'0' OR %SUBST(XFKT:1:1)>'9'
N31  C                   EVAL      SDATA = '<cbc:ID schemeID="IBAN">'
N31  C                             + %TRIM(XFKT) + '</cbc:ID>'
N31  C                   ELSE
     C                   EVAL      SDATA = '<cbc:ID schemeID="BBAN">'
     C                             + %TRIM(XFKT) + '</cbc:ID>'
N31  C                   END
     C                   EXSR      OPDFIL
N31   *
N31  C                   IF        %SUBST(XFKT:1:1)<'0' OR %SUBST(XFKT:1:1)>'9'
N31   * <cac:FinancialInstitutionBranch>
N31  C                   EVAL      SDATA = '<cac:FinancialInstitutionBranch>'
N31  C                   EXSR      OPDFIL
N31   * <cbc:ID>
N31  C                   EVAL      SDATA = '<cbc:ID>BIC</cbc:ID>'
N31  C                   EXSR      OPDFIL
N31   * <cac:FinancialInstitution>
N31  C                   EVAL      SDATA = '<cac:FinancialInstitution>'
N31  C                   EXSR      OPDFIL
N31   * <cbc:ID>
N31  C     'XXX'         SCAN      XFKID                                  33
N31  C                   IF        *IN33
N31  C                   EVAL      SDATA = '<cbc:ID schemeID="BIC">'
N31  C                             + %TRIM(XFKID) + '</cbc:ID>'
N31  C                   ELSE
N31  C                   EVAL      SDATA = '<cbc:ID schemeID="BIC">'
N31  C                             + %TRIM(XFKID) + 'XXX</cbc:ID>'
N31  C                   END
N31  C                   EXSR      OPDFIL
N31   * </cac:FinancialInstitution>
N31  C                   EVAL      SDATA = '</cac:FinancialInstitution>'
N31  C                   EXSR      OPDFIL
N31   * </cac:FinancialInstitutionBranch>
N31  C                   EVAL      SDATA = '</cac:FinancialInstitutionBranch>'
N31  C                   EXSR      OPDFIL
N31  C                   END
      * </cac:PayeeFinancialAccount> slutt
     C                   EVAL      SDATA = '</cac:PayeeFinancialAccount>'
     C                   EXSR      OPDFIL
      * </cac:PaymentMeans> slutt
     C                   EVAL      SDATA = '</cac:PaymentMeans>'
     C                   EXSR      OPDFIL
N11   * <cac:PaymentMeans> start
N11  C                   EVAL      SDATA = '<cac:PaymentTerms>'
N11  C                   EXSR      OPDFIL
N11   * <cbc:Note>
N11  C                   IF        XFBBT = *BLANKS
N11  C                   EVAL      SDATA = '<cbc:Note>'
N11  C                             + %TRIM(XFBB) + '</cbc:Note>'
N11  C                   ELSE
N41  C                   EVAL      XTXT801 = XFBBT
N41  C                   Z-ADD     40            XN53              3 0
N41  C                   EXSR      KNVST
N11  C                   EVAL      SDATA = '<cbc:Note>'
S41  C*                            + %TRIM(XFBBT) + '</cbc:Note>'
N41  C                             + %TRIM(XTXT802) + '</cbc:Note>'
N11  C                   END
N11  C                   EXSR      OPDFIL
N11   * </cac:PaymentMeans> slutt
N11  C                   EVAL      SDATA = '</cac:PaymentTerms>'
N11  C                   EXSR      OPDFIL
      *
     C                   ENDSR
      *
      ***********************************************
     C     SRTOTAL       BEGSR
      ***********************************************
      *
     C                   MOVE      *ZEROS        XXMVAT           13 2
S19  C*    1             DO        11            XN01              3 0
S19  C*                  IF        XMLT1(XN01) > 0
S19  C*                  IF        XMLT2(XN01) = *BLANKS
S19  C*                  EVAL      XMLT2(XN01) = FICURR
S19  C*                  END
S19  C*                  IF        XMLT2(XN01) = FICURR
S19  C*                  EVAL(H)   XXMVAT = XXMVAT+XMLT1(XN01)*XMLT3(XN01)/100
S19  C*                  ELSE
S19  C*                  EVAL(H)   XXMVAT = XXMVAT+XMLT1(XN01)*XMLT4(XN01)/100
S19  C*                  END
S19  C*                  END
S19  C*                  ENDDO
N19   *
N19  C                   MOVE      *ZEROS        XXMVAGL          13 2
N26  C                   MOVE      *BLANKS       XUTENMVA0         1
N26  C                   MOVE      *BLANKS       XUTENMVA0VAL      3
N19  C     FAK8K         SETLL     FAK8
N19  C     FAK8K         READE     FAK8                                   33
N19  C                   DOW       *IN33 = *OFF                                 1<-B
S26  C*                  IF        FAOPKO <> 'D' AND FAKDM = 'J'                 2<-B
N26  C                   IF        FAOPKO <> 'D'                                 2<-B
N26  C                   SELECT                                                   3<-B
N26  C                   WHEN      FAKDM = 'J'                                    3
N19  C                   IF        XFVAL = FICURR OR XFVAL = *BLANKS               4<-B
N19  C                   EVAL      XXMVAGL = XXMVAGL + FABELN
N19  C                   EVAL(H)   XXMVAT = XXMVAT + FABELN * FITAX
N19  C                   ELSE                                                      4
N19  C                   EVAL      XXMVAGL = XXMVAGL + FABELV
N19  C                   EVAL(H)   XXMVAT = XXMVAT + FABELV * FITAX
N19  C                   END                                                       4-E
N26  C                   WHEN      FAKDM = 'N' AND XFTOT <> 0                     3
N26   * SJEKK OM TOTAL UTEN MOMS ER 0 (JA: MÅ SENDE cac:TaxCategory)
N26  C                   IF        FABELN = 0                                      4<-B
N28  C                   IF        XUTENMVA0 = ' '
N26  C                   EVAL      XUTENMVA0 = 'J'
N26  C                   IF        FAVAL = *BLANKS                                  5<-B
N26  C                   EVAL      XUTENMVA0VAL = FICURR
N26  C                   ELSE                                                       5
N26  C                   EVAL      XUTENMVA0VAL = FAVAL
N26  C                   END                                                        5<-E
N28  C                   END
N26  C                   ELSE                                                      4
N26  C                   EVAL      XUTENMVA0 = 'N'
S28  C*                  LEAVE
N26  C                   END                                                       4<-E
N19  C                   ENDSL                                                    3-E
N19  C                   END                                                     2<-E
N19  C     FAK8K         READE     FAK8                                   33
N19  C                   ENDDO                                                  1<-E
N19   *
S28  C*    XFTOT         SUB       XXMVAT        XX0MVAGR         13 2
      *
      * Total moms
      * <cac:TaxTotal> start
     C                   EVAL      SDATA = '<cac:TaxTotal>'
     C                   EXSR      OPDFIL
      * <cbc:TaxAmount
S37  C*                  IF        XXMVAT < 0
S37  C*                  Z-SUB     XXMVAT        XXMVAT
S37  C*                  END
     C                   EVAL      ØN152 = XXMVAT
     C                   MOVE      'J'           XBELØP
     C                   EXSR      SRNE
     C                   EVAL      SDATA = '<cbc:TaxAmount '
     C                             + 'currencyID="' + %TRIM(XFVAL) + '">'
     C                             + %TRIM(ØAN) + '</cbc:TaxAmount>'
     C                   EXSR      OPDFIL
      *
     C                   EVAL      XBELMVFG = 0
      * Del moms
     C     1             DO        11            XN01              3 0
      *
S18  C*                  IF        XMLT1(XN01) > 0
N18  C                   IF        XMLT3(XN01) <> 0
N23  C                             OR (XFTOT = 0 AND XN01 = 1)
N26  C                             OR XMLT1(XN01) = 0 AND XUTENMVA0 = 'J'
N26  C                   IF        XMLT1(XN01) = 0 AND XUTENMVA0 = 'J'
N26   * TOTAL UTEN MOMS ER 0 --> SEND cac:TaxCategory
N26  C                   EVAL      XUTENMVA0 = 'N'
N26  C                   EVAL      XMLT2(XN01) = XUTENMVA0VAL
N26  C                   END
      *
     C                   IF        XMLT2(XN01) = *BLANKS
     C                   EVAL      XMLT2(XN01) = FICURR
     C                   END
     C                   IF        XMLT2(XN01) = FICURR
N34  C                             OR XFVAL = FICURR
     C                   EVAL(H)   XXMVAG = XMLT3(XN01)
S19  C*                  EVAL(H)   XXMVA = XMLT1(XN01)*XMLT3(XN01)/100
N19  C                   IF        XMLT1(XN01) > 0
N19  C                   EVAL(H)   XXMVA = XXMVAT
N30  C                   ELSE
N30  C                   EVAL(H)   XXMVA = 0
N19  C                   END
     C                   ELSE
     C                   EVAL(H)   XXMVAG = XMLT4(XN01)
S19  C*                  EVAL(H)   XXMVA = XMLT1(XN01)*XMLT4(XN01)/100
N19  C                   IF        XMLT1(XN01) > 0
N19  C                   EVAL(H)   XXMVA = XXMVAT
N30  C                   ELSE
N30  C                   EVAL(H)   XXMVA = 0
N19  C                   END
     C                   END
N37   *
N37  C                   IF        XMLT1(XN01) <> 0
      * <cac:TaxSubtotal> start
     C                   EVAL      SDATA = '<cac:TaxSubtotal>'
     C                   EXSR      OPDFIL
      * Momsgrunnlag
      * <cbc:TaxableAmount
S18  C*                  IF        XXMVAG < 0
N19   * IKKE SNU BELØP PGA. BEREGNINGSMÅTE PÅ EN NY MÅTE
S19  C*                  IF        XFFK = 'K'
S19  C*                  Z-SUB     XXMVAG        XXMVAG
S19  C*                  END
S37  C*                  IF        XFFK = 'K'
S37  C*                  Z-SUB     XXMVAG        XXMVAG
S37  C*                  END
     C                   ADD       XXMVAG        XBELMVFG
     C                   EVAL      ØN152 = XXMVAG
     C                   MOVE      'J'           XBELØP
     C                   EXSR      SRNE
N34  C                   IF        XFVAL = FICURR
N34  C                   EVAL      SDATA = '<cbc:TaxableAmount '
N34  C                             + 'currencyID="' + %TRIM(XFVAL) + '">'
N34  C                             + %TRIM(ØAN) + '</cbc:TaxableAmount>'
N34  C                   ELSE
     C                   EVAL      SDATA = '<cbc:TaxableAmount '
     C                             + 'currencyID="' + %TRIM(XMLT2(XN01)) + '">'
     C                             + %TRIM(ØAN) + '</cbc:TaxableAmount>'
N34  C                   END
     C                   EXSR      OPDFIL
      * Moms
      * <cbc:TaxAmount
S18  C*                  IF        XXMVA < 0
S32  C*                  IF        XFFK = 'K'
S32  C*                  Z-SUB     XXMVA         XXMVA
S32  C*                  END
     C                   EVAL      ØN152 = XXMVA
     C                   MOVE      'J'           XBELØP
     C                   EXSR      SRNE
     C                   EVAL      SDATA = '<cbc:TaxAmount '
S34  C*                            + 'currencyID="' + %TRIM(XMLT2(XN01)) + '">'
N34  C                             + 'currencyID="' + %TRIM(XFVAL) + '">'
     C                             + %TRIM(ØAN) + '</cbc:TaxAmount>'
     C                   EXSR      OPDFIL
      * <cac:TaxCategory> start
     C                   EVAL      SDATA = '<cac:TaxCategory>'
     C                   EXSR      OPDFIL
      * <cbc:ID>
     C                   EVAL      XTEREASON = *BLANKS
     C                   IF        XFFK = 'F'
     C                   SELECT
     C                   WHEN      XMLT1(XN01) = 0
     C*                  EVAL      SDATA = '<cbc:ID>E</cbc:ID>'
     C                   EVAL      XTEREASON = 'VAT FREE'
     C                   EVAL      SDATA = '<cbc:ID schemeAgencyID="6" '
     C                             + 'schemeID="UNCL5305">'
     C                             + 'E</cbc:ID>'
     C                   WHEN      XMLT1(XN01) = FITAX * 100
     C*                  EVAL      SDATA = '<cbc:ID>S</cbc:ID>'
     C*                  EVAL      XTEREASON = 'VAT STANDARD'
S37  C*                  EVAL      SDATA = '<cbc:ID schemeAgencyID="6" '
S37  C*                            + 'schemeID="UNCL5305">'
S37  C*                            + 'S</cbc:ID>'
N37  C                   EVAL      SDATA = '<cbc:ID>S</cbc:ID>'
     C                   WHEN      XMLT1(XN01) = 8
     C*                  EVAL      SDATA = '<cbc:ID>AA</cbc:ID>'
     C*                  EVAL      XTEREASON = 'VAT LOW'
     C                   EVAL      SDATA = '<cbc:ID schemeAgencyID="6" '
     C                             + 'schemeID="UNCL5305">'
     C                             + 'AA</cbc:ID>'
     C                   WHEN      XMLT1(XN01) = 15
     C*                  EVAL      SDATA = '<cbc:ID>H</cbc:ID>'
     C*                  EVAL      XTEREASON = 'VAT HIGH'
     C                   EVAL      SDATA = '<cbc:ID schemeAgencyID="6" '
     C                             + 'schemeID="UNCL5305">'
     C                             + 'H</cbc:ID>'
     C                   OTHER
     C*                  EVAL      SDATA = '<cbc:ID>H</cbc:ID>'
     C                   EVAL      SDATA = '<cbc:ID schemeAgencyID="6" '
     C                             + 'schemeID="UNCL5305">'
     C                             + 'H</cbc:ID>'
     C                   ENDSL
     C                   ELSE
     C                   EVAL      SDATA = '<cbc:ID schemeAgencyID="6" '
     C                             + 'schemeID="UNCL5305">'
     C                   SELECT
     C                   WHEN      XMLT1(XN01) = 0
     C                   EVAL      XTEREASON = 'VAT FREE'
     C                   EVAL      SDATA = %TRIM(SDATA)
S13  C*                            + '>E</cbc:ID>'
N13  C                             + 'E</cbc:ID>'
     C                   WHEN      XMLT1(XN01) = FITAX * 100
     C                   EVAL      SDATA = %TRIM(SDATA)
S13  C*                            + '>S</cbc:ID>'
N13  C                             + 'S</cbc:ID>'
     C                   WHEN      XMLT1(XN01) = 8
     C                   EVAL      SDATA = %TRIM(SDATA)
S13  C*                            + '>AA</cbc:ID>'
N13  C                             + 'AA</cbc:ID>'
     C                   WHEN      XMLT1(XN01) = 15
     C                   EVAL      SDATA = %TRIM(SDATA)
S13  C*                            + '>H</cbc:ID>'
N13  C                             + 'H</cbc:ID>'
     C                   OTHER
     C                   EVAL      SDATA = %TRIM(SDATA)
S13  C*                            + '>H</cbc:ID>'
N13  C                             + 'H</cbc:ID>'
     C                   ENDSL
     C                   END
     C                   EXSR      OPDFIL
      * <cbc:Percent>
     C                   EVAL      ØN152 = XMLT1(XN01)
     C                   MOVE      'N'           XBELØP            1
     C                   EXSR      SRNE
     C                   EVAL      SDATA = '<cbc:Percent>'
     C                             + %TRIM(ØAN) + '</cbc:Percent>'
     C                   EXSR      OPDFIL
      * <cbc:TaxExemptionReason>
     C                   IF        XTEREASON <> *BLANKS
     C                   EVAL      SDATA = '<cbc:TaxExemptionReason>'
     C                             + %TRIM(XTEREASON)
     C                             + '</cbc:TaxExemptionReason>'
     C                   EXSR      OPDFIL
     C                   END
      * <cac:TaxScheme> start
     C                   EVAL      SDATA = '<cac:TaxScheme>'
     C                   EXSR      OPDFIL
      * <cbc:ID>
     C*                  EVAL      SDATA = '<cbc:ID>VAT</cbc:ID>'
S37  C*                  EVAL      SDATA = '<cbc:ID schemeAgencyID="6" '
S37  C*                            + 'schemeID="UN/ECE 5153">VAT</cbc:ID>'
N37  C                   EVAL      SDATA = '<cbc:ID>VAT</cbc:ID>'
     C                   EXSR      OPDFIL
      * </cac:TaxScheme> slutt
     C                   EVAL      SDATA = '</cac:TaxScheme>'
     C                   EXSR      OPDFIL
      * </cac:TaxCategory> slutt
     C                   EVAL      SDATA = '</cac:TaxCategory>'
     C                   EXSR      OPDFIL
      * </cac:TaxSubtotal> slutt
     C                   EVAL      SDATA = '</cac:TaxSubtotal>'
     C                   EXSR      OPDFIL
N37   *
N37  C                   END
      *
     C                   END
      *
     C                   ENDDO
      *
     C                   MOVE      XFTOT         XFTOT2           13 2
     C                   IF        XFFK = 'F'
     C                   IF        XFTOT2 < 0
     C                   CAT       '-':0         SDATA
     C                   Z-SUB     XFTOT2        XFTOT2
     C                   END
     C                   ELSE
     C                   IF        XFTOT2 > 0
     C                   CAT       '-':0         SDATA
     C                   ELSE
     C                   Z-SUB     XFTOT2        XFTOT2
     C                   END
     C                   END
      *
      * XFTOT2 = TOTAL INKL. MVA, XXMVAT = TOTAL MVA, XBELMVFG = TOTAL MVA-GRUNNLAG
     C                   EVAL      XBELMVFG = XFTOT2 - XXMVAT - XBELMVFG
      * XBELMVFG = TOTAL MVAFRI-GRUNNLAG
      *
      * SEND TaxSubTotal UTEN MOMS
     C                   IF        XBELMVFG > 0
      * <cac:TaxSubtotal> start
     C                   EVAL      SDATA = '<cac:TaxSubtotal>'
     C                   EXSR      OPDFIL
      * <cbc:TaxableAmount
     C                   EVAL      ØN152 = XBELMVFG
     C                   MOVE      'J'           XBELØP
     C                   EXSR      SRNE
     C                   EVAL      SDATA = '<cbc:TaxableAmount '
     C                             + 'currencyID="' + %TRIM(XFVAL) + '">'
     C                             + %TRIM(ØAN) + '</cbc:TaxableAmount>'
     C                   EXSR      OPDFIL
      * <cbc:TaxAmount
     C                   EVAL      SDATA = '<cbc:TaxAmount '
     C                             + 'currencyID="' + %TRIM(XFVAL) + '">'
     C                             + '0' + '</cbc:TaxAmount>'
     C                   EXSR      OPDFIL
      * <cac:TaxCategory> start
     C                   EVAL      SDATA = '<cac:TaxCategory>'
     C                   EXSR      OPDFIL
      * <cbc:ID>
     C*                  IF        XFFK = 'F'
     C*                  EVAL      SDATA = '<cbc:ID>E</cbc:ID>'
     C*                  ELSE
     C                   EVAL      SDATA = '<cbc:ID '
     C                             + 'schemeAgencyID="6" schemeID="UNCL5305"'
     C                             + '>E</cbc:ID>'
     C*                  END
     C                   EXSR      OPDFIL
      * <cbc:Percent>
     C                   EVAL      SDATA = '<cbc:Percent>0</cbc:Percent>'
     C                   EXSR      OPDFIL
      * <cbc:TaxExemptionReason>
     C                   EVAL      XTEREASON = 'VAT FREE'
     C                   EVAL      SDATA = '<cbc:TaxExemptionReason>'
     C                             + %TRIM(XTEREASON)
     C                             + '</cbc:TaxExemptionReason>'
     C                   EXSR      OPDFIL
      * <cac:TaxScheme> start
     C                   EVAL      SDATA = '<cac:TaxScheme>'
     C                   EXSR      OPDFIL
      * <cbc:ID>
     C*                  EVAL      SDATA = '<cbc:ID>VAT</cbc:ID>'
S37  C*                  EVAL      SDATA = '<cbc:ID '
S37  C*                            + 'schemeAgencyID="6" schemeID="UN/ECE 5153"'
S37  C*                            + '>VAT</cbc:ID>'
N37  C                   EVAL      SDATA = '<cbc:ID>VAT</cbc:ID>'
     C                   EXSR      OPDFIL
      * </cac:TaxScheme> slutt
     C                   EVAL      SDATA = '</cac:TaxScheme>'
     C                   EXSR      OPDFIL
      * </cac:TaxCategory> slutt
     C                   EVAL      SDATA = '</cac:TaxCategory>'
     C                   EXSR      OPDFIL
      * </cac:TaxSubtotal> slutt
     C                   EVAL      SDATA = '</cac:TaxSubtotal>'
     C                   EXSR      OPDFIL
     C                   END
      *
      * </cac:TaxTotal> slutt
     C                   EVAL      SDATA = '</cac:TaxTotal>'
     C                   EXSR      OPDFIL
      *
      * <cac:LegalMonetaryTotal> start
     C                   EVAL      SDATA = '<cac:LegalMonetaryTotal>'
     C                   EXSR      OPDFIL
      *
     C                   MOVE      XFTOT         XFTOT2           13 2
S37  C*                  IF        XFFK = 'F'
     C                   IF        XFTOT2 < 0
     C                   CAT       '-':0         SDATA
     C                   Z-SUB     XFTOT2        XFTOT2
     C                   END
S37  C*                  ELSE
S37  C*                  IF        XFTOT2 > 0
S37  C*                  CAT       '-':0         SDATA
S37  C*                  ELSE
S37  C*                  Z-SUB     XFTOT2        XFTOT2
S37  C*                  END
S37  C*                  END
      * Linjesum
      * <cbc:LineExtensionAmount
     C                   EVAL      ØN152 = XFTOT2 - XXMVAT
     C                   MOVE      'J'           XBELØP
     C                   EXSR      SRNE
     C                   EVAL      SDATA = '<cbc:LineExtensionAmount '
     C                             + 'currencyID="' + %TRIM(XFVAL) + '">'
     C                             + %TRIM(ØAN) + '</cbc:LineExtensionAmount>'
     C                   EXSR      OPDFIL
      * Beløp uten moms
      * <cbc:TaxExclusiveAmount
     C                   EVAL      ØN152 = XFTOT2 - XXMVAT
     C                   MOVE      'J'           XBELØP
     C                   EXSR      SRNE
     C                   EVAL      SDATA = '<cbc:TaxExclusiveAmount '
     C                             + 'currencyID="' + %TRIM(XFVAL) + '">'
     C                             + %TRIM(ØAN) + '</cbc:TaxExclusiveAmount>'
     C                   EXSR      OPDFIL
      * Beløp med moms
      * <cbc:TaxInclusiveAmount
     C                   EVAL      ØN152 = XFTOT2
     C                   MOVE      'J'           XBELØP
     C                   EXSR      SRNE
     C                   EVAL      SDATA = '<cbc:TaxInclusiveAmount '
     C                             + 'currencyID="' + %TRIM(XFVAL) + '">'
     C                             + %TRIM(ØAN) + '</cbc:TaxInclusiveAmount>'
     C                   EXSR      OPDFIL
      * Betalings beløp
      * <cbc:PayableAmount
     C                   EVAL      ØN152 = XFTOT2
     C                   MOVE      'J'           XBELØP
     C                   EXSR      SRNE
     C                   EVAL      SDATA = '<cbc:PayableAmount '
     C                             + 'currencyID="' + %TRIM(XFVAL) + '">'
     C                             + %TRIM(ØAN) + '</cbc:PayableAmount>'
     C                   EXSR      OPDFIL
      * <c/ac:LegalMonetaryTotal> slutt
     C                   EVAL      SDATA = '</cac:LegalMonetaryTotal>'
     C                   EXSR      OPDFIL
      *
     C                   ENDSR
      *
      ***********************************************
     C     SRINVLINE     BEGSR
      ***********************************************
     C     FAK8K         SETLL     FAK8
     C     FAK8K         READE     FAK8                                   33
     C                   MOVE      *ZEROS        XXLNR             5 0
     C                   DOW       *IN33 = *OFF                                 1<-B
      *
     C                   IF        FAOPKO <> 'D'                                 2<-B
     C                   IF        ((XFVAL = FICURR) OR (XFVAL = *BLANKS))        3<-B
     C                   EVAL      XXBEL = FABELN
     C                   ELSE                                                     3
     C                   EVAL      XXBEL = FABELV
     C                   END                                                      3<-E
      * Fortegn
     C                   MOVE      ' '           XFORTEGN          1
S37  C*                  IF        XFFK = 'F'
     C                   IF        XXBEL < 0
     C                   MOVE      '-'           XFORTEGN
     C                   Z-SUB     XXBEL         XXBEL
     C                   END
S37  C*                  ELSE
S37  C*                  IF        XXBEL > 0
S37  C*                  MOVE      '-'           XFORTEGN
S37  C*                  ELSE
S37  C*                  Z-SUB     XXBEL         XXBEL
S37  C*                  END
S37  C*                  END
      *
     C                   IF        XFFK = 'F'
      * <cac:InvoiceLine> start
     C                   EVAL      SDATA = '<cac:InvoiceLine>'
     C                   ELSE
      * <cac:CreditNoteLine> start
     C                   EVAL      SDATA = '<cac:CreditNoteLine>'
     C                   END
     C                   EXSR      OPDFIL
      * <cbc:ID>
     C                   ADD       1             XXLNR
     C                   EVAL      SDATA = '<cbc:ID>'
     C                             + %TRIM(%EDITC(XXLNR:'Z'))
     C                             + '</cbc:ID>'
     C                   EXSR      OPDFIL
      *
     C                   IF        XFFK = 'F'
      * <cbc:InvoicedQuantity
     C                   EVAL      SDATA = '<cbc:InvoicedQuantity '
     C                             + 'unitCode="NMP" '
E15  C                             + 'unitCodeListID="UNECERec20">'
N15  C                             + %TRIM(XFORTEGN)
E15  C                             + '1</cbc:InvoicedQuantity>'
     C                   ELSE
      * <cbc:CreditedQuantity
     C                   EVAL      SDATA = '<cbc:CreditedQuantity '
     C                             + 'unitCode="NAR" '
E15  C                             + 'unitCodeListID="UNECERec20">'
N15  C                             + %TRIM(XFORTEGN)
E15  C                             + '1</cbc:CreditedQuantity>'
     C                   END
     C                   EXSR      OPDFIL
      * <cbc:LineExtensionAmount
     C                   EVAL      SDATA = '<cbc:LineExtensionAmount '
     C                             + 'currencyID="' + XFVAL + '">'
S09  C*                            + %TRIM(%EDITC(XXBEL:'4'))
N15  C                             + %TRIM(XFORTEGN)
N09  C                             + %TRIM(%EDITC(XXBEL:'3'))
     C                             + '</cbc:LineExtensionAmount>'
     C                   EXSR      OPDFIL
S37   * <cac:TaxTotal> start
S37  C*                  EVAL      SDATA = '<cac:TaxTotal>'
S37  C*                  EXSR      OPDFIL
S37   * <cbc:TaxAmount
S37  C*                  SELECT                                                   3<-B
S37  C*                  WHEN      FAKDM = 'N'
S37  C*                  EVAL      MVAAVI = 0
S37  C*                  WHEN      FAKDM = 'J'
S37  C*                  EVAL      MVAAVI = FITAX * 100
S37  C*                  OTHER
S37  C*    KODWL01K      CHAIN     KODWL01                            33
S37  C*  33              EVAL      MVAAVI = 0
S37  C*                  ENDSL                                                    3<-E
S37  C*                  EVAL      XXMVA = XXBEL * MVAAVI / 100
S37  C*                  EVAL      ØN152 = XXMVA
S37  C*                  MOVE      'J'           XBELØP
S37  C*                  EXSR      SRNE
S37  C*                  EVAL      SDATA = '<cbc:TaxAmount '
S37  C*                            + 'currencyID="' + XFVAL + '">'
     C*                            + %TRIM(%EDITC(XXMVA:'3'))
     C*                            + '</cbc:TaxAmount>'
S37  C*                            + %TRIM(ØAN) + '</cbc:TaxAmount>'
S37  C*                  EXSR      OPDFIL
S37  C* </cac:TaxTotal> slutt
S37  C*                  EVAL      SDATA = '</cac:TaxTotal>'
S37  C*                  EXSR      OPDFIL
      * <cac:Item> start
     C                   EVAL      SDATA = '<cac:Item>'
     C                   EXSR      OPDFIL
      * <cbc:Name>
     C                   EVAL      SDATA = *BLANKS
     C                   IF        FAVT01 = 'X'                                   3<-B
      * KUN TEST FRA FAVT
     C                   EVAL      XTXT801 = FAVT02
     C                   Z-ADD     40            XN53              3 0
     C                   EXSR      KNVST
     C                   CAT       XTXT802:0     SDATA
     C                   ELSE                                                     3
     C                   IF        FAVT <> *BLANKS                                 4<-B
     C                   EVAL      XTXT801 = FAVT
     C                   Z-ADD     40            XN53              3 0
     C                   EXSR      KNVST
     C                   CAT       XTXT802:0     SDATA
S22  C*                  CAT       ',':0         SDATA
S22  C*                  END                                                       4<-E
N22  C                   ELSE                                                      4
     C     KODTGEK       CHAIN     KODTGE                             33
     C     KODTG2K       CHAIN     KODTG2                             33
     C                   SELECT                                                     5<-B
     C                   WHEN      SPRAAK = 'E'
     C                   EVAL      XTXT801 = KGEENT
     C                   WHEN      SPRAAK = 'T'
     C                   EVAL      XTXT801 = KG2TYT
     C                   OTHER
     C                   EVAL      XTXT801 = KGENOT
     C                   ENDSL                                                      5<-E
N22  C                   END                                                       4<-E
     C                   Z-ADD     40            XN53              3 0
     C                   EXSR      KNVST
     C                   CAT       XTXT802:0     SDATA
     C                   END                                                      3<-E
S22  C*                  MOVE      XAN13BLANK    SDATA
N22   *
N22  C     FAKTXTK       CHAIN     FAKTXT                             33
N22  C                   IF        *IN33 = *OFF
N22  C                   EVAL      XTXT801 = FXVT
N22  C                   Z-ADD     40            XN53              3 0
N22  C                   EXSR      KNVST
N22  C                   EVAL      SDATA = %TRIM(SDATA) + ', ' + %TRIM(XTXT802)
N22  C                   END
N22   *
     C                   EVAL      SDATA = '<cbc:Name>'
     C                             + %TRIM(SDATA) + '</cbc:Name>'
     C                   EXSR      OPDFIL
N17   * <cac:SellersItemIdentification> start
N17  C                   EVAL      SDATA = '<cac:SellersItemIdentification>'
N17  C                   EXSR      OPDFIL
N17   * <cbc:ID>
N17  C                   EVAL      SDATA = '<cbc:ID>' +%TRIM(FAVK)+ '</cbc:ID>'
N17  C                   EXSR      OPDFIL
N17   * <cac:SellersItemIdentification> slutt
N17  C                   EVAL      SDATA = '</cac:SellersItemIdentification>'
N17  C                   EXSR      OPDFIL
      * <cac:ClassifiedTaxCategory> start
     C                   EVAL      SDATA = '<cac:ClassifiedTaxCategory>'
     C                   EXSR      OPDFIL
      * <cbc:ID>
     C                   EVAL      XTEREASON = *BLANKS
     C                   IF        MVAAVI = 0
     C*                  EVAL      SDATA = '<cbc:ID>E</cbc:ID>'
     C                   EVAL      XTEREASON = 'VAT FREE'
     C                   EVAL      SDATA = '<cbc:ID '
     C                             + 'schemeAgencyID="6" schemeID="UNCL5305"'
     C                             + '>E</cbc:ID>'
     C                   ELSE
     C                   EVAL      SDATA = '<cbc:ID>S</cbc:ID>'
     C                   EVAL      SDATA = '<cbc:ID '
     C                             + 'schemeAgencyID="6" schemeID="UNCL5305"'
     C                             + '>S</cbc:ID>'
     C                   END
     C                   EXSR      OPDFIL
      * <cbc:Percent>
     C                   EVAL      ØN152 = MVAAVI
     C                   MOVE      'N'           XBELØP            1
     C                   EXSR      SRNE
     C                   EVAL      SDATA = '<cbc:Percent>'
     C                             + %TRIM(ØAN) + '</cbc:Percent>'
     C                   EXSR      OPDFIL
      * <cbc:TaxExemptionReason>
     C                   IF        XTEREASON <> *BLANKS
     C                   EVAL      SDATA = '<cbc:TaxExemptionReason>'
     C                             + %TRIM(XTEREASON)
     C                             + '</cbc:TaxExemptionReason>'
     C                   EXSR      OPDFIL
     C                   END
      * <cac:TaxScheme> start
     C                   EVAL      SDATA = '<cac:TaxScheme>'
     C                   EXSR      OPDFIL
      * <cbc:ID>
     C*                  EVAL      SDATA = '<cbc:ID>VAT</cbc:ID>'
S37  C*                  EVAL      SDATA = '<cbc:ID '
S37  C*                            + 'schemeAgencyID="6" schemeID="UN/ECE 5153"'
S37  C*                            + '>VAT</cbc:ID>'
N37  C                   EVAL      SDATA = '<cbc:ID>VAT</cbc:ID>'
     C                   EXSR      OPDFIL
      * </cac:TaxScheme> slutt
     C                   EVAL      SDATA = '</cac:TaxScheme>'
     C                   EXSR      OPDFIL
      * </cac:ClassifiedTaxCategory> slutt
     C                   EVAL      SDATA = '</cac:ClassifiedTaxCategory>'
     C                   EXSR      OPDFIL
      * </cac:Item> slutt
     C                   EVAL      SDATA = '</cac:Item>'
     C                   EXSR      OPDFIL
      * <cac:Price> start
     C                   EVAL      SDATA = '<cac:Price>'
     C                   EXSR      OPDFIL
      * <cbc:PriceAmount
     C                   EVAL      SDATA = '<cbc:PriceAmount '
     C                             + 'currencyID="' + XFVAL + '">'
S09  C*                            + %TRIM(%EDITC(XXBEL:'4'))
N09  C                             + %TRIM(%EDITC(XXBEL:'3'))
     C                             + '</cbc:PriceAmount>'
     C                   EXSR      OPDFIL
      * </cac:Price> slutt
     C                   EVAL      SDATA = '</cac:Price>'
     C                   EXSR      OPDFIL
      *
     C                   IF        XFFK = 'F'
      * </cac:InvoiceLine> slutt
     C                   EVAL      SDATA = '</cac:InvoiceLine>'
     C                   ELSE
      * </cac:CreditNoteLine> slutt
     C                   EVAL      SDATA = '</cac:CreditNoteLine>'
     C                   END
     C                   EXSR      OPDFIL
      *
     C                   END                                                     2<-E
      *
     C     FAK8K         READE     FAK8                                   33
     C                   ENDDO                                                  1<-E
      *
     C                   ENDSR
      *
      ***********************************************
     C     SRCLOSE       BEGSR
      ***********************************************
     C                   CLOSE     KODWL01
     C                   CLOSE     KODTA
     C                   CLOSE     KODTGE
     C                   CLOSE     KODTG2
     C                   CLOSE     KODTFR
     C                   CLOSE     KODTOTY
     C                   CLOSE     KODTSF
S25  C*                  CLOSE     CUNDL01
N03  C                   CLOSE     CUNDC05
S14  C*                  CLOSE     FAIN
     C                   CLOSE     HEADF
S14  C*                  CLOSE     FAK8
     C                   CLOSE     FAKTXT
     C                   CLOSE     FRISOK
     C                   CLOSE     KODFRI
     C                   CLOSE     EDIC
S21  C*                  CLOSE     EDIS
     C                   CLOSE     EDIM
N08  C                   CLOSE     TRACKF
      *
     C                   callp     close( FILE_o )
N07  C                   EVAL      XCHGAUT = 'CHGAUT OBJ(' + XAPS
N07  C                             + %TRIM(FILNAM) + XAPS
N07  C                             + ') USER(*PUBLIC) DTAAUT(*RWX) OBJAUT(*ALL)'
N07  C                   CALLP     RUNCMD(XCHGAUT:200)
      * SLÅ SAMMEN
     C                   MOVE      *BLANKS       WCMD            300
     C                   EVAL      WCMD = 'QSH CMD(' + XAPS + 'cat'
     C                             + ' '
     C                             + %trimr(FILNAM1)
     C                             + ' >> '
     C                             + %trimr(FILNAM)
     C                             + XAPS + ')'
     C                   CALLP     RUNCMD(WCMD:300)
      * FJERN BUNN-FIL
     C*                  EVAL      WCMD = 'QSH CMD(' + XAPS + 'RMVLNK OBJLNK("'
     C*                            + %trimr(FILNAM1) + '")'
     C*                            + XAPS + ')'
     C*                  CALLP     RUNCMD(WCMD:300)
     C                   EVAL      UCMD = 'RMVLNK OBJLNK(' + XAPS
     C                             + %TRIM(filnam1) + XAPS + ') '
     C                   CALL      'QCMDEXC'                            33
     C                   PARM                    UCMD
     C                   PARM                    UCMDL
      * CHGATR OBJ('home/cb/a.xml') ATR(*CCSID) VALUE(1208)
     C                   MOVE      *BLANKS       UCMD           1024
     C                   Z-ADD     1024          UCMDL            15 5
     C                   EVAL      UCMD = 'CHGATR OBJ(' + XAPS
     C                             + %TRIM(FILNAM) + XAPS + ') '
     C                             + 'ATR(*CCSID) VALUE(1208)'
     C                   CALL      'QCMDEXC'                            33
     C                   PARM                    UCMD
     C                   PARM                    UCMDL
      *
     C                   ENDSR
      *
      ***********************************************
     C     SRSNDSL       BEGSR
      ***********************************************
      *
     C     XSSN          CHAIN     EDIS                               33
     C  N33              MOVE      'X'           SST
     C  N33              UPDATE    EDISR
     C*    1             DO        100           XSNVN
     C*    XSNV(XSNVN)   CHAIN     EDIS                               33
     C* N33              MOVE      'X'           SST
     C* N33              UPDATE    EDISR
     C*                  ENDDO
N21  C                   CLOSE     EDIS
      *
     C                   ENDSR
      *
      ***********************************************
     C     OPDEDIM       BEGSR
      ***********************************************
     C     1             CHAIN     EDIC                               33
     C                   ADD       1             CMN
     C                   UPDATE    EDICR
      *
     C                   EVAL      M0004 = S0004
     C                   EVAL      M0010 = S0010
     C                   MOVEL     CMN           M0062
     C                   EVAL      M0065 = 'INVXML'
     C                   MOVEL     XFFN          M0068
     C                   IF        XFFK = 'F'
     C                   MOVEL     '380'         M1001
     C                   ELSE
     C                   MOVEL     '381'         M1001
     C                   END
     C                   MOVEL     XFFN          M1004
     C                   IF        XFSAML = 'N'
     C                   MOVE      'SIN'         M1225
     C                   ELSE
     C                   MOVE      'SAM'         M1225
     C                   END
     C                   EVAL      MSN = SSN
     C                   EVAL      MMN = CMN
     C                   EVAL      MSR = 'S'
     C                   EVAL      MST = 'C'
     C                   MOVE      WDT           MDT
     C                   MOVE      WTM           MTM
     C                   IF        XFSAML = 'N'
     C                   EVAL      MAVD = FIAVD
     C                   EVAL      MTDN = FIOPD
     C                   ELSE
     C                   EVAL      MAVD = 0
     C                   EVAL      MTDN = 0
     C                   END
     C                   WRITE     EDIMR
N08   *
N08  C                   EVAL      TTAVD  = MAVD
N08  C                   EVAL      TTOPD  = MTDN
N08  C                   EVAL      TTACTI = 'EHF'
N08  C                   EVAL      TTDATE = MDT
N08  C                   EVAL      TTTIME = MTM
N08  C                   EVAL      TTUSER = ZUSER
N08  C                   EVAL      TTDATL = MDT
N08  C                   EVAL      TTTIML = MTM
N08  C                   EVAL      TTMANU = 'E'
N08  C                   EVAL      TTTEXT = 'EHF-invoice (' + %TRIM(M0068)
N08  C                             + ') is created and sent to receiver'
N08  C                   EVAL      TTTEXL = 'EHF-faktura (' + %TRIM(M0068)
N08  C                             + ') er laget og sendt til mottaker'
N08  C                   WRITE     TRACKFR
      *
     C                   ENDSR
      *
      *////////////////////////////////////////////////////////////
      *  Venstrestill numeriske verdier                      SRNE /
      *////////////////////////////////////////////////////////////
     C     SRNE          BEGSR
     C                   IF        ØN152 < 0
     C                   MOVE      '-'           XAN01             1
     C                   Z-SUB     ØN152         ØN152
     C                   ELSE
     C                   MOVE      ' '           XAN01
     C                   END
      * Flytte in rett verdi i Alfa 12-felt
     C                   MOVE      *ZEROS        ØA12
     C     ØA152D        IFEQ      '00'                                         <-------------I
     C     XBELØP        ANDEQ     'N'                                                        I
     C                   MOVE      ØA152H        ØA12                                         I
     C                   ELSE                                                   <-------------I
     C                   MOVEL     ØA152X        ØA12                                         I
     C                   MOVE      '.  '         ØA12                                         I
     C                   MOVE      ØA152D        ØA12                                         I
     C     XBELØP        IFEQ      'N'
     C     Ø12(12)       IFEQ      '0'
     C                   MOVE      ' '           Ø12(12)
     C     Ø12(11)       IFEQ      '0'
     C                   MOVE      ' '           Ø12(11)
     C                   END
     C                   END
     C                   END
     C                   END                                                    <-------------I
      * lete fra venstre og finn foerste siffer over 0
     C     1             DO        11            ØX                             <-------------I
     C     Ø12(ØX)       IFNE      '0'                                           <-----------II
     C                   GOTO      SRNE1                                                     II
     C                   END                                                     <-----------II
     C                   END                                                    <-------------I
     C     SRNE1         TAG
      * Venstrestill til et nytt felt
     C                   MOVE      *BLANKS       XXA12            12
     C     Ø12(ØX)       IFEQ      '.'
     C                   SUB       1             ØX
     C                   END
     C                   MOVEA     Ø12(ØX)       XXA12
     C                   IF        XAN01 = '-'
     C                   EVAL      ØAN = XAN01
     C                   CAT       XXA12:0       ØAN
     C                   ELSE
     C                   EVAL      ØAN = XXA12
     C                   END
      *
     C                   ENDSR
      *
      ***********************************************
     C     OPDFIL        BEGSR
      ***********************************************
     C                   EVAL      SDATA=(%trimr(SDATA))+ LF
     c                   callp     write(File_o : %addr(Sdata)
     c                                : %len(%trimr(Sdata)) )
      *
     C                   ENDSR
      *
      ***********************************************
     C     KNVST         BEGSR
      ***********************************************
     C     XN53          SUB       4             XN54              3 0
     C     XN53          SUB       5             XN55              3 0
     C     XN53          SUB       6             XN56              3 0
     C                   Z-ADD     0             XN52              3 0
     C                   MOVE      *BLANKS       XTXT802
     C     1             DO        80            XN51              3 0          1<-B
     C                   IF        XT801(XN51) = '&' OR                          2<-B
     C                             XT801(XN51) = '"' OR
N35  C                             XT801(XN51) = 'Æ' OR
N35  C                             XT801(XN51) = 'Ø' OR
N35  C                             XT801(XN51) = 'Å' OR
N35  C                             XT801(XN51) = 'æ' OR
N35  C                             XT801(XN51) = 'ø' OR
N35  C                             XT801(XN51) = 'å' OR
N35  C                             XT801(XN51) = X'5A' OR                       ¤
N35  C                             XT801(XN51) = X'8E' OR
N35  C                             XT801(XN51) = X'B0' OR
N35  C                             XT801(XN51) = X'B2' OR
N35  C                             XT801(XN51) = X'71' OR
N35  C                             XT801(XN51) = X'54' OR
N35  C                             XT801(XN51) = X'74' OR
N35  C                             XT801(XN51) = X'58' OR
N35  C                             XT801(XN51) = X'7D' OR
N35  C                             XT801(XN51) = X'EC' OR
N35  C                             XT801(XN51) = X'90' OR
N3501C                             XT801(XN51) = X'63' OR                       Ä -> AA
N3502C                             XT801(XN51) = X'FC' OR
N3503C                             XT801(XN51) = X'CC' OR                       ö -> oe
N3504C                             XT801(XN51) = X'43' OR                       ä -> aa
N3505C                             XT801(XN51) = X'55' OR                       í -> i
N3505C                             XT801(XN51) = X'62' OR                       Â -> A
N3506C                             XT801(XN51) = X'51' OR                       é -> e
     C                             XT801(XN51) = XAPS OR
     C                             XT801(XN51) = '<' OR
     C                             XT801(XN51) = '>'
     C                   IF        XN52 < XN53                                    3<-B
     C                   ADD       1             XN52
     C                   SELECT                                                    4<-B
N35  C                   WHEN      XT801(XN51) = 'Æ'                               4
N3501C                             OR XT801(XN51) = X'63'
N35  C                   IF        XN51 < XN55                                      5<-B
N35  C                   MOVEA     'AA'          XT802(XN52)
N35  C                   ADD       1             XN52
N35  C                   ELSE                                                       5
N35  C                   SUB       1             XN52
N35  C                   END                                                        5<-E
N35  C                   WHEN      XT801(XN51) = 'Ø'                               4
N35  C                   IF        XN51 < XN55                                      5<-B
N35  C                   MOVEA     'OE'          XT802(XN52)
N35  C                   ADD       1             XN52
N35  C                   ELSE                                                       5
N35  C                   SUB       1             XN52
N35  C                   END                                                        5<-E
N35  C                   WHEN      XT801(XN51) = 'Å'                               4
N35  C                   IF        XN51 < XN55                                      5<-B
N35  C                   MOVEA     'AE'          XT802(XN52)
N35  C                   ADD       1             XN52
N35  C                   ELSE                                                       5
N35  C                   SUB       1             XN52
N35  C                   END                                                        5<-E
N35  C                   WHEN      XT801(XN51) = 'æ'                               4
N35  C                   IF        XN51 < XN55                                      5<-B
N35  C                   MOVEA     'aa'          XT802(XN52)
N35  C                   ADD       1             XN52
N35  C                   ELSE                                                       5
N35  C                   SUB       1             XN52
N35  C                   END                                                        5<-E
N35  C                   WHEN      XT801(XN51) = 'ø'                               4
N35  C                   IF        XN51 < XN55                                      5<-B
N35  C                   MOVEA     'oe'          XT802(XN52)
N35  C                   ADD       1             XN52
N35  C                   ELSE                                                       5
N35  C                   SUB       1             XN52
N35  C                   END                                                        5<-E
N35  C                   WHEN      XT801(XN51) = 'å'                               4
N35  C                   IF        XN51 < XN55                                      5<-B
N35  C                   MOVEA     'ae'          XT802(XN52)
N35  C                   ADD       1             XN52
N35  C                   ELSE                                                       5
N35  C                   SUB       1             XN52
N35  C                   END                                                        5<-E
N35  C                   WHEN      XT801(XN51) = X'5A'                             4
N35  C                   IF        XN51 < XN55                                      5<-B
N35  C                   MOVEA     '.'           XT802(XN52)
N35  C                   ELSE                                                       5
N35  C                   SUB       1             XN52
N35  C                   END                                                        5<-E
N35  C                   WHEN      XT801(XN51) = X'8E'                             4
N35  C                   IF        XN51 < XN55                                      5<-B
N35  C                   MOVEA     'OE'          XT802(XN52)
N35  C                   ADD       1             XN52
N35  C                   ELSE                                                       5
N35  C                   SUB       1             XN52
N35  C                   END                                                        5<-E
N35  C                   WHEN      XT801(XN51) = X'B0'                             4
N35  C                   IF        XN51 < XN55                                      5<-B
N35  C                   MOVEA     'oe'          XT802(XN52)
N35  C                   ADD       1             XN52
N35  C                   ELSE                                                       5
N35  C                   SUB       1             XN52
N35  C                   END                                                        5<-E
N35  C                   WHEN      XT801(XN51) = X'B2'                             4
N35  C                   IF        XN51 < XN55                                      5<-B
N35  C                   MOVEA     'OE'          XT802(XN52)
N35  C                   ADD       1             XN52
N35  C                   ELSE                                                       5
N35  C                   SUB       1             XN52
N35  C                   END                                                        5<-E
N35  C                   WHEN      XT801(XN51) = X'71'                             4
N35  C                   IF        XN51 < XN55                                      5<-B
N35  C                   MOVEA     'E'           XT802(XN52)
N35  C                   ELSE                                                       5
N35  C                   SUB       1             XN52
N35  C                   END                                                        5<-E
N35  C                   WHEN      XT801(XN51) = X'54'                             4
N35  C                             OR XT801(XN51) = X'74'
N35  C                   IF        XN51 < XN55                                      5<-B
N35  C                   MOVEA     'E'           XT802(XN52)
N35  C                   ELSE                                                       5
N35  C                   SUB       1             XN52
N35  C                   END                                                        5<-E
N35  C                   WHEN      XT801(XN51) = X'58'                             4
N35  C                   IF        XN51 < XN55                                      5<-B
N35  C                   MOVEA     'i'           XT802(XN52)
N35  C                   ELSE                                                       5
N35  C                   SUB       1             XN52
N35  C                   END                                                        5<-E
N35  C                   WHEN      XT801(XN51) = X'7D'                             4
N35  C                   IF        XN51 < XN56                                      5<-B
N35  C                   MOVEA     '&apos;'      XT802(XN52)
N35  C                   ADD       5             XN52
N35  C                   ELSE                                                       5
N35  C                   SUB       1             XN52
N35  C                   END                                                        5<-E
N35  C                   WHEN      XT801(XN51) = X'EC'                             4
N35  C                   IF        XN51 < XN55                                      5<-B
N35  C                   MOVEA     'O'           XT802(XN52)
N35  C                   ELSE                                                       5
N35  C                   SUB       1             XN52
N35  C                   END                                                        5<-E
N35  C                   WHEN      XT801(XN51) = X'90'                             4
N35  C                   IF        XN51 < XN56                                      5<-B
N35  C                   EVAL      XT802(XN52) = X'5F'
N35  C                   ELSE                                                       5
N35  C                   SUB       1             XN52
N35  C                   END                                                        5<-E
N3502C                   WHEN      XT801(XN51) = X'FC'                             4
N3502C                   IF        XN51 < XN55                                      5<-B
N3502C                   MOVEA     'U'           XT802(XN52)
N3502C                   ELSE                                                       5
N3502C                   SUB       1             XN52
N3502C                   END                                                        5<-E
N3503C                   WHEN      XT801(XN51) = X'CC'                             4
N3503C                   IF        XN51 < XN55                                      5<-B
N3503C                   MOVEA     'oe'          XT802(XN52)
N3503C                   ADD       1             XN52
N3503C                   ELSE                                                       5
N3503C                   SUB       1             XN52
N3503C                   END                                                        5<-E
N3504C                   WHEN      XT801(XN51) = X'43'                             4
N3504C                   IF        XN51 < XN55                                      5<-B
N3504C                   MOVEA     'aa'          XT802(XN52)
N3504C                   ADD       1             XN52
N3504C                   ELSE                                                       5
N3504C                   SUB       1             XN52
N3504C                   END                                                        5<-E
N3505C                   WHEN      XT801(XN51) = X'55'                             4
N3505C                   IF        XN51 < XN55                                      5<-B
N3505C                   MOVEA     'i'           XT802(XN52)
N3505C                   ELSE                                                       5
N3505C                   SUB       1             XN52
N3505C                   END                                                        5<-E
N3505C                   WHEN      XT801(XN51) = X'62'                             4
N3505C                   IF        XN51 < XN55                                      5<-B
N3505C                   MOVEA     'A'           XT802(XN52)
N3505C                   ELSE                                                       5
N3505C                   SUB       1             XN52
N3505C                   END                                                        5<-E
N3506C                   WHEN      XT801(XN51) = X'51'                             4
N3506C                   IF        XN51 < XN55                                      5<-B
N3506C                   MOVEA     'e'           XT802(XN52)
N3506C                   ELSE                                                       5
N3506C                   SUB       1             XN52
N3506C                   END                                                        5<-E
     C                   WHEN      XT801(XN51) = '&'                               4
     C                   IF        XN51 < XN55                                      5<-B
     C                   MOVEA     '&amp;'       XT802(XN52)
     C                   ADD       4             XN52
     C                   ELSE                                                       5
     C                   SUB       1             XN52
     C                   END                                                        5<-E
     C                   WHEN      XT801(XN51) = '"'                               4
     C                   IF        XN51 < XN56                                      5<-B
     C                   MOVEA     '&quot;'      XT802(XN52)
     C                   ADD       5             XN52
     C                   ELSE                                                       5
     C                   SUB       1             XN52
     C                   END                                                        5<-E
     C                   WHEN      XT801(XN51) = XAPS                              4
     C                   IF        XN51 < XN56                                      5<-B
     C                   MOVEA     '&apos;'      XT802(XN52)
     C                   ADD       5             XN52
     C                   ELSE                                                       5
     C                   SUB       1             XN52
     C                   END                                                        5<-E
     C                   WHEN      XT801(XN51) = '>'                               4
     C                   IF        XN51 < XN54                                      5<-B
     C                   MOVEA     '&gt;'        XT802(XN52)
     C                   ADD       3             XN52
     C                   ELSE                                                       5
     C                   SUB       1             XN52
     C                   END                                                        5<-E
     C                   WHEN      XT801(XN51) = '<'                               4
     C                   IF        XN51 < XN54                                      5<-B
     C                   MOVEA     '&lt;'        XT802(XN52)
     C                   ADD       3             XN52
     C                   ELSE                                                       5
     C                   SUB       1             XN52
     C                   END                                                        5<-E
     C                   OTHER                                                     4
     C                   IF        XN52 < XN53                                      5<-B
     C                   ADD       1             XN52
     C                   MOVE      XT801(XN51)   XT802(XN52)
     C                   ELSE                                                       5
     C                   LEAVE
     C                   END                                                        5<-E
     C                   ENDSL                                                     4<-E
     C                   END                                                      3<-E
     C                   ELSE                                                    2
     C                   IF        XN52 < XN53                                    3<-B
     C                   ADD       1             XN52
     C                   MOVE      XT801(XN51)   XT802(XN52)
     C                   ELSE                                                     3
     C                   LEAVE
     C                   END                                                      3<-E
     C                   END                                                     2<-E
     C                   ENDDO                                                  1<-E
N10   *
N10  C                   IF        XTXT802 = *BLANKS                            1<-B
N10  C                   EVAL      XTXT802 = '.'
N10  C                   END                                                    1<-E
      *
     C                   ENDSR
      *
      ***********************************************
     C     INIT          BEGSR
      ***********************************************
     C     XMLUFL1K      KLIST
     C                   KFLD                    XXST
     C                   KFLD                    FIFIRM
     C                   KFLD                    XXTYPE
S38  C*    ECMSGK        KLIST
S38  C*                  KFLD                    FIFIRM
S38  C*                  KFLD                    XXKN
S38  C*                  KFLD                    ECSR
S38  C*                  KFLD                    EC0065
     C     HEADFK        KLIST
     C                   KFLD                    FIAVD
     C                   KFLD                    FIOPD
     C     FAK8K         KLIST
     C                   KFLD                    FIAVD
     C                   KFLD                    FIOPD
     C                   KFLD                    FIFN
     C     FAKTXTK       KLIST
     C                   KFLD                    FAAVD
     C                   KFLD                    FAOPD
     C                   KFLD                    FALI
     C     KODWL01K      KLIST
     C                   KFLD                    FIFIRM
     C                   KFLD                    MOMSTW
     C                   KFLD                    FAKDM
     C     KODTAK        KLIST
     C                   KFLD                    KOAUNI
     C                   KFLD                    FIAVD
     C     KODTAKX       KLIST
     C                   KFLD                    KOAUNI
     C                   KFLD                    XFAVD
     C     KODTGEK       KLIST
     C                   KFLD                    KGEUNI
     C                   KFLD                    FAVK
     C     KODTG2K       KLIST
     C                   KFLD                    KG2UNI
     C                   KFLD                    FAVK
     C     KODTFRK       KLIST
     C                   KFLD                    KFRUNI
     C                   KFLD                    HEFR
     C     KODTOTYK      KLIST
     C                   KFLD                    KO1UNI
     C                   KFLD                    HEOT
     C     KODTSFK       KLIST
     C                   KFLD                    KOSFUN
     C                   KFLD                    HESG
     C     CUNDL01K      KLIST
     C                   KFLD                    FIFIRM
     C                   KFLD                    KUNDNR
N03  C     CUNDC05K      KLIST
N03  C                   KFLD                    FIFIRM
N03  C                   KFLD                    X_CTYPE
N03  C                   KFLD                    X_CCONTA
N03  C                   KFLD                    XFKN
N03  C     *LIKE         DEFINE    CTYPE         X_CTYPE
N03  C     *LIKE         DEFINE    CCONTA        X_CCONTA
N03  C                   EVAL      X_CTYPE  = '*XML FAKTURA SIN'
N03  C                   EVAL      X_CCONTA = 'SINGELFAKTURA'
N38  C     SYPARL1K      KLIST
N38  C                   KFLD                    KUNDNR
N38  C                   KFLD                    EHF_SYPAID
N38  C     *LIKE         DEFINE    SYPAID        EHF_SYPAID
N38  C                   EVAL      EHF_SYPAID = 'EHFON'
N38  C     SYPARL1K0     KLIST
N38  C                   KFLD                    FIRMA_KUNDNR
N38  C                   KFLD                    EHF_SYPAID
N38  C     *LIKE         DEFINE    KUNDNR        FIRMA_KUNDNR
     C     FREETK        KLIST
     C                   KFLD                    HEAVD
     C                   KFLD                    HEOPD
     C                   KFLD                    FASK
     C                   KFLD                    FIFN
     C     FRISOKK       KLIST
     C                   KFLD                    HEAVD
     C                   KFLD                    HEOPD
     C                   KFLD                    XFSKODE           3
     C     ARKIVL02K     KLIST
     C                   KFLD                    ARSTAT
     C                   KFLD                    FIAVD
     C                   KFLD                    FIOPD
N16  C     ARKIVL02K2    KLIST
N16  C                   KFLD                    X_ARSTAT
N16  C                   KFLD                    FIAVD
N16  C                   KFLD                    FIOPD
N16  C                   KFLD                    X_ARTYPE
N27  C                   KFLD                    X_ARUNDE
     C     ARKVEDKK      KLIST
     C                   KFLD                    FIFIRM
     C                   KFLD                    XXKN
     C                   KFLD                    X_AVTYPE
     C     ARKLAGK       KLIST
     C                   KFLD                    FIFIRM
     C                   KFLD                    ARKLAG
      *
     C     *LOVAL        SETLL     FIRM
     C                   READ      FIRM                                   33
      *
     C     *LIKE         DEFINE    SSN           XSSN
     C     *LIKE         DEFINE    SSN           XSSNVEDL
     C     *LIKE         DEFINE    AVTYPE        X_AVTYPE
N16  C     *LIKE         DEFINE    ARSTAT        X_ARSTAT
N16  C     *LIKE         DEFINE    ARTYPE        X_ARTYPE
N27  C     *LIKE         DEFINE    ARUNDE        X_ARUNDE
S22  C*    *LIKE         DEFINE    ARTXT         XDOKTYPE
S22  C                   MOVE      *BLANKS       XDOKTYPE         30
     C                   Z-ADD     0             ØX                2 0
     C                   MOVE      *BLANKS       ØAN              12
     C                   MOVE      *ZEROS        XXBEL            13 2
     C                   MOVE      *ZEROS        XXMVA            13 2
     C                   MOVE      *ZEROS        XXMVAG           13 2
     C                   MOVE      *ZEROS        XBELMVFG         13 2
     C                   MOVE      *BLANKS       XAN13BLANK       13
     C                   MOVE      ' '           XXST              1
     C                   MOVE      'EHF  '       XXTYPE            5
N16  C                   MOVE      'A'           X_ARSTAT
N16  C                   MOVE      'fa'          X_ARTYPE
N16  C                   MOVE      *ZEROS        XANT              3 0
     C                   MOVE      'A'           KOAUNI
     C                   MOVEL     'GE'          KGEUNI
     C                   MOVEL     'G2'          KG2UNI
     C                   MOVEL     'FR'          KFRUNI
     C                   MOVEL     'OTY'         KO1UNI
     C                   MOVEL     'SF'          KOSFUN
     C                   MOVE      'PO '         XFSKODE
     C                   MOVE      'A'           ARSTAT
S38  C*                  MOVEL     'S'           ECSR
S38  C*                  MOVEL     'INVXML'      EC0065
     C                   MOVE      '/'           XXSTREKK1
     C                   MOVE      '/'           XXSTREKK2
     C                   MOVE      *BLANKS       UFIL             70
     C                   MOVE      *BLANKS       UKAT             70
     C                   BITON     '123457'      XAPS              1
     C                   BITOFF    '06'          XAPS
     C                   MOVE      *BLANKS       XTEREASON        30
     C                   MOVE      *BLANKS       X_ARLINK         70
      *
     C                   ENDSR
      *
** TXT
<?xml version="1.0" encoding="UTF-8"?>                                          001
<?xml-stylesheet type='text/xsl' href='EHF-faktura_NO.xslt'?>                   002
<Invoice xmlns="urn:oasis:names:specification:ubl:schema:xsd:Invoice-2" xmlns:ca003
c="urn:oasis:names:specification:ubl:schema:xsd:CommonAggregateComponents-2" xml004
ns:cbc="urn:oasis:names:specification:ubl:schema:xsd:CommonBasicComponents-2" xm005
lns:ccts="urn:un:unece:uncefact:documentation:2" xmlns:qdt="urn:oasis:names:spec006
ification:ubl:schema:xsd:QualifiedDatatypes-2" xmlns:udt="urn:un:unece:uncefact:007
data:specification:UnqualifiedDataTypesSchemaModule:2">                         008
</Invoice>                                                                      009
<?xml-stylesheet type="text/xsl" href="EHF-kreditnota_NO.xslt"?>                010
<CreditNote xsi:schemaLocation="urn:oasis:names:specification:ubl:schema:xsd:Cre011
ditNote-2 UBL-CreditNote-2.0.xsd" xmlns="urn:oasis:names:specification:ubl:schem012
a:xsd:CreditNote-2" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:013
cac="urn:oasis:names:specification:ubl:schema:xsd:CommonAggregateComponents-2" x014
mlns:cbc="urn:oasis:names:specification:ubl:schema:xsd:CommonBasicComponents-2" 015
xmlns:ext="urn:oasis:names:specification:ubl:schema:xsd:CommonExtensionComponent016
s-2">                                                                           017
</CreditNote>                                                                   018
