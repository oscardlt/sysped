********************************************************************
      * RETTINGER I DETTE PROGRAM:
PTFnr:*Sek Sig Vers  Beskrivelse...........................
""""""*"""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""
11XXX * 01 YBC PTF11 TEST STATUS PÅ OPPDRAG (IKKE TA MED D)
11XXX * 02 YBC PTF11 SVEV_EUP1 = 1000 SKAL IKKE MED LISTE
11XXX * 03 YBC PTF11 TULL-ID = CIC0101498 SKAL IKKE MED PÅ LISTE
      *              TOMMY BAR OM DETTE. SE MAIL FRA 22.04.2016
********************************************************************
     FSVNH      IF   E             DISK
     FSVNL      IF   E           K DISK
     FSVIV3     IF   E           K DISK
     FSVEV3     IF   E           K DISK
     FSVIH      UF   E           K DISK
     FSVEH      UF   E           K DISK
     FSVIV      IF   E           K DISK    RENAME(SVIVR:SVIVRX)
     F                                     PREFIX(X)
     FSVEV      IF   E           K DISK    RENAME(SVEVR:SVEVRX)
     F                                     PREFIX(X)
     FEDIM2     IF   E           K DISK
     FSVG511F2  IF   E           K DISK
     FSVG513F   IF   E           K DISK
     FSVG511W   O  A E             DISK
      *//////////////
      *  Hodelogikk /
      *//////////////
     C                   EXSR      SRA
     C                   EXSR      SRB
     C                   EVAL      *INLR=*ON
      *_____________________________________________
      *                                          SRA
      *"""""""""""""""""""""""""""""""""""""""""""""
     C     SRA           BEGSR
      *__________________
      * Definiere Nøkkler
      *""""""""""""""""""
     C     KEYSVNL       KLIST
     C                   KFLD                    TIAVD
     C                   KFLD                    TITDN
     C     KEYSVIH       KLIST
     C                   KFLD                    SVIV_SYAV
     C                   KFLD                    SVIV_SYOP
     C     KEYSVEH       KLIST
     C                   KFLD                    SVEV_SYAV
     C                   KFLD                    SVEV_SYOP
     C     KEYA          KLIST
     C                   KFLD                    SVIH_SYAV
     C                   KFLD                    SVIH_SYOP
     C                   KFLD                    W0068A
     C                   KFLD                    W0068B
     C                   KFLD                    W0068C
     C     KEYA1         KLIST
     C                   KFLD                    SVIH_SYAV
     C                   KFLD                    SVIH_SYOP
     C     KEYB          KLIST
     C                   KFLD                    SVEH_SYAV
     C                   KFLD                    SVEH_SYOP
     C                   KFLD                    W0068A
     C                   KFLD                    W0068B
     C                   KFLD                    W0068C
     C     KEYB1         KLIST
     C                   KFLD                    SVEH_SYAV
     C                   KFLD                    SVEH_SYOP
      *___________________
      * Definiere Workfelt
      *"""""""""""""""""""
     C     *LIKE         DEFINE    M0068A        W0068A
     C     *LIKE         DEFINE    M0068B        W0068B
     C     *LIKE         DEFINE    M0068C        W0068C
     C     *LIKE         DEFINE    MDT           ZMDT
     C     *LIKE         DEFINE    MDT           WDTF
     C     *LIKE         DEFINE    MDT           WDTT
     C     *LIKE         DEFINE    A3            WA3
     C                   MOVE      *ZEROS        W0068A
     C                   MOVE      *ZEROS        W0068B
     C                   MOVE      *ZEROS        W0068C
      *_________________
      * Input parametrer
      *"""""""""""""""""
     C     *ENTRY        PLIST
     C                   PARM                    WDTFA             8
     C                   PARM                    WDTTA             8
     C                   PARM                    WGOLK             3
     C                   MOVE      WDTFA         WDTF
     C                   MOVE      WDTTA         WDTT
     C                   ENDSR
      *_____________________________________________
      *                                          SRB
      *"""""""""""""""""""""""""""""""""""""""""""""
     C     SRB           BEGSR
      * Kør først en runda før att uppdatera godsnr på huvudnivå
     C                   EXSR      UPDGODS
     C                   EXSR      UPDGODSE
      * Les deretter NCTS Import
     C                   READ      SVNH                                   51
     C     *IN51         DOWEQ     *OFF
     C                   IF        TIGN='VEB-16-00001'
     C                   SETON                                        99
     C                   ENDIF
     C     TIST          IFEQ      'U'
     C     TIST          OREQ      'P'
     C     TIGLSK        IFEQ      WGOLK
     C     TIDTF         IFGE      WDTF
     C     TIDTF         IFLE      WDTT

     C                   EXSR      SKRIV

     C                   ENDIF
     C                   ENDIF
     C                   ENDIF
     C                   ENDIF
     C                   READ      SVNH                                   51
     C                   ENDDO
     C                   ENDSR
      *_____________________________________________
      * Skriv til arbetsfil                    SKRIV
      *"""""""""""""""""""""""""""""""""""""""""""""
     C     SKRIV         BEGSR
     C                   Z-ADD     0             X
      * Finns det uttag (TDS Import varuposter med samma godsnummer ?)
     C                   MOVEL     TIGN          KEYSVIH14        14
     C                   MOVEL     TIGN          KEYSVIH15        15
     C                   IF        TIGN='VEB-14-00170'
     C                   SETOFF                                       52
     C                   ENDIF
     C     KEYSVIH14     COMP      *BLANKS                                52
     C  N52KEYSVIH14     CHAIN     SVIV3                              52
     C  N52KEYSVIH       CHAIN(N)  SVIH                               52
     C  N52SVIH_TUID     COMP      *BLANKS                                52
     C  N52SVIH_SYST     COMP      'G'                                5252


N03  C                   IF        SVIH_TUID <> 'CIC0101498'
     C                   CLEAR                   SVG511WR
     C                   MOVEL     TIGN          A1
     C                   EVAL      A2=TIDT
     C                   EVAL      A3=TINTK
     C                   IF        NINTK > 0
     C                   EVAL      A3=NINTK
     C                   ENDIF
      *
     C     TITRNR        CHAIN     SVG513F                            54
     C                   IF        *IN54=*OFF
     C                   EVAL      A3=YTINTK
     C                   ENDIF
      *
     C                   MOVEL     TITRNR        A4
     C                   EVAL      A5=TIVKB
     C     KEYSVNL       CHAIN     SVNL                               57
     C  N57              MOVEL     TVVT          A6
     C                   MOVEL     TINAK         A7
     C  N52              EXSR      SKRIV2
     C                   EXSR      SKRIV3
      * Finns det uttag (Egen fil for externe fort. ?)
     C     KEYSVIH15     CHAIN     SVG511F2                           60
     C     *IN60         IFEQ      *OFF
     C                   EXSR      SKRIV4
     C                   ENDIF

     C     *IN52         IFEQ      *ON
     C     *IN60         ANDEQ     *ON
     C     X             ANDLT     2
     C                   EVAL      B7=A3
     C                   WRITE     SVG511WR
     C                   ENDIF
N03  C                   END
     C                   ENDSR
      *_____________________________________________
      * Skriv til arbetsfil-2                 SKRIV2
      *"""""""""""""""""""""""""""""""""""""""""""""
     C     SKRIV2        BEGSR
     C                   EVAL      WA3=A3
     C                   Z-ADD     1             X                 5 0
     C                   EVAL      *IN53=*OFF
     C     KEYSVIH14     SETLL     SVIV3
     C     KEYSVIH14     READE     SVIV3                                  53
     C     *IN53         DOWEQ     *OFF
     C     KEYSVIH       CHAIN(N)  SVIH

     C     SVIH_TUID     IFNE      *BLANKS
N03  C     SVIH_TUID     ANDNE     'CIC0101498'
N01  C     SVEH_SYST     ANDNE     'D'
     C     SVIV_KOTA     IFGT      *ZEROS
     C                   MOVEL     SVIH_MONA     A7
     C                   IF        X > 1
     C                   CLEAR                   SVG511WR
     C                   ENDIF
     C                   MOVEL     SVIV_LAGI     B1
     C                   EXSR      GODDAT
     C                   EVAL      B2=ZMDT
     C                   EVAL      B3=SVIH_EUP1
     C                   MOVEL     SVIH_TUID     B4
     C                   EVAL      B5=SVIV_KOTA
     C                   EVAL      B6=SVIV_BRUT
     C                   SUB       B5            WA3
     C                   EVAL      B7=WA3
     C                   WRITE     SVG511WR
     C                   ADD       1             X
     C                   ENDIF
     C                   ENDIF

     C     KEYSVIH14     READE     SVIV3                                  53
     C                   ENDDO
     C                   ENDSR
      *_____________________________________________
      * Skriv til arbetsfil-3                 SKRIV3
      *"""""""""""""""""""""""""""""""""""""""""""""
     C     SKRIV3        BEGSR
     C     KEYSVIH14     CHAIN     SVEV3                              55
     C     *IN55         CABEQ     *ON           SKRIV39
     C   52              EVAL      WA3=A3
     C   52              Z-ADD     1             X
     C                   EVAL      *IN62=*OFF
     C     KEYSVIH14     SETLL     SVEV3
     C     KEYSVIH14     READE     SVEV3                                  62
     C     *IN62         CABEQ     *ON           SKRIV39
     C     *IN62         DOWEQ     *OFF

N02  C                   IF        XSVEV_EUP1 <> '1000'
N02  C                             OR %SUBST(KEYSVIH14:1:3) <> 'TDD'
     C     KEYSVEH       CHAIN(N)  SVEH

     C     SVEH_TUID     IFNE      *BLANKS
N01  C     SVIH_SYST     ANDNE     'D'
     C     SVEV_KOTA     IFGT      *ZEROS
     C                   MOVEL     SVEH_AVNA     A7
     C                   IF        X > 1
     C                   CLEAR                   SVG511WR
     C                   ENDIF
     C                   MOVEL     SVEV_LAGI     B1
     C                   EXSR      GODDATE
     C                   EVAL      B2=ZMDT
     C                   EVAL      B3=SVEV_EUP1
     C                   MOVEL     SVEH_TUID     B4
     C                   EVAL      B5=SVEV_KOTA
     C                   EVAL      B6=SVEV_BRUT
     C                   SUB       B5            WA3
     C                   EVAL      B7=WA3
     C                   WRITE     SVG511WR
     C                   ADD       1             X
     C                   ENDIF
     C                   ENDIF
N02  C                   ENDIF

     C     KEYSVIH14     READE     SVEV3                                  62
     C                   ENDDO
     C     SKRIV39       ENDSR
      *_____________________________________________
      * Skriv til arbetsfil-4                 SKRIV4
      *"""""""""""""""""""""""""""""""""""""""""""""
     C     SKRIV4        BEGSR
     C   52              EVAL      WA3=A3
     C   52              Z-ADD     1             X
     C                   EVAL      *IN61=*OFF
     C     KEYSVIH15     SETLL     SVG511F2
     C     KEYSVIH15     READE     SVG511F2                               61
     C     *IN61         DOWEQ     *OFF

     C     YVIH_TUID     IFNE      *BLANKS
     C                   IF        X > 1
     C                   CLEAR                   SVG511WR
     C                   ENDIF
     C                   MOVEL     YVIH_GOLK     B1
     C                   EVAL      B2=YVIH_SYDT
     C                   EVAL      B3=YVIH_EUP1
     C                   MOVEL     YVIH_TUID     B4
     C                   EVAL      B5=YVIH_KOTA
     C                   EVAL      B6=YVIH_BRUT
     C                   SUB       B5            WA3
     C                   EVAL      B7=WA3
     C                   WRITE     SVG511WR
     C                   ADD       1             X
     C                   ENDIF

     C     KEYSVIH15     READE     SVG511F2                               61
     C                   ENDDO
     C                   ENDSR
      *_____________________________________________
      * Uppdatera godsnummer på huvudnivå    UPDGODS
      *"""""""""""""""""""""""""""""""""""""""""""""
     C     UPDGODS       BEGSR
     C                   EVAL      *IN55=*OFF
     C                   READ      SVIV                                   55
     C     *IN55         DOWEQ     *OFF

     C     XSVIV_LAGI    IFNE      *BLANKS
     C     KEYSVIH       CHAIN(N)  SVIH                               56
     C     *IN56         IFEQ      *OFF
     C     SVIH_SYST     ANDEQ     'G'
     C     SVIH_GODN     ANDEQ     *BLANKS
     C     KEYSVIH       CHAIN     SVIH                               56
     C     *IN56         IFEQ      *OFF
     C     SVIH_GODN     ANDEQ     *BLANKS
     C                   MOVEL     XSVIV_LAGI    SVIH_GODN
     C                   UPDATE    SVIHR
     C                   ENDIF
     C                   ENDIF
     C                   ENDIF

     C                   READ      SVIV                                   55
     C                   ENDDO
     C                   ENDSR
      *_____________________________________________
      * Uppdatera godsnummer på huvudnivå   UPDGODSE
      *"""""""""""""""""""""""""""""""""""""""""""""
     C     UPDGODSE      BEGSR
     C                   EVAL      *IN55=*OFF
     C                   READ      SVEV                                   55
     C     *IN55         DOWEQ     *OFF

     C     XSVIV_LAGI    IFNE      *BLANKS
     C     KEYSVIH       CHAIN(N)  SVEH                               56
     C     *IN56         IFEQ      *OFF
     C     SVEH_SYST     ANDEQ     'G'
     C     SVEH_GODN     ANDEQ     *BLANKS
     C     KEYSVIH       CHAIN     SVEH                               56
     C     *IN56         IFEQ      *OFF
     C     SVEH_GODN     ANDEQ     *BLANKS
     C                   MOVEL     XSVEV_LAGI    SVEH_GODN
     C                   UPDATE    SVEHR
     C                   ENDIF
     C                   ENDIF
     C                   ENDIF

     C                   READ      SVEV                                   55
     C                   ENDDO
     C                   ENDSR
      *_____________________________________________
      * Hæmta godkænningsdatum                GODDAT
      *"""""""""""""""""""""""""""""""""""""""""""""
     C     GODDAT        BEGSR
     C                   EVAL      *IN59=*OFF
     C                   EVAL      ZMDT=*ZEROS
     C     KEYA          SETLL     EDIM2
     C     KEYA1         READE     EDIM2                                  59
     C     *IN59         DOWEQ     *OFF
     C                   IF        MSR='R'
     C                   IF        M1225='RES'
     C                   EVAL      ZMDT=MDT
     C                   ENDIF
     C                   ENDIF
     C     KEYA1         READE     EDIM2                                  59
     C                   ENDDO
     C                   IF        ZMDT=*ZEROS
     C                   EVAL      ZMDT=SVIH_SYDT
     C                   ENDIF
     C                   ENDSR
      *_____________________________________________
      * Hæmta godkænningsdatum               GODDATE
      *"""""""""""""""""""""""""""""""""""""""""""""
     C     GODDATE       BEGSR
     C                   EVAL      *IN59=*OFF
     C                   EVAL      ZMDT=*ZEROS
     C     KEYB          SETLL     EDIM2
     C     KEYB1         READE     EDIM2                                  59
     C     *IN59         DOWEQ     *OFF
     C                   IF        MSR='R'
     C                   IF        M1225='RES'
     C                   EVAL      ZMDT=MDT
     C                   ENDIF
     C                   ENDIF
     C     KEYB1         READE     EDIM2                                  59
     C                   ENDDO
     C                   IF        ZMDT=*ZEROS
     C                   EVAL      ZMDT=SVEH_SYDT
     C                   ENDIF
     C                   ENDSR
