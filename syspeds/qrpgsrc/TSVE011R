      *********************************************************************
      *
CRTPG+*  CRTPGM SYSPED/TSVE011R MODULE(*LIBL/TSVE011R *LIBL/INCGI)
CRTPGM*        ACTGRP(*NEW) AUT(*USE)
      *
      *********************************************************************
      /copy SYSPEDS/qrpgsrcpy,hspecs
      /copy SYSPEDS/qrpgsrcpy,hspecsbnd
      *********************************************************************
     FBRIDF     IF   E           K DISK    USROPN
     FSVEV      IF   E           K DISK    USROPN
      *--------------------------------------------------------------------
      * Variables common to all CGIs
      *--------------------------------------------------------------------
      /copy SYSPEDS/qrpgsrcpy,prototypeb
      /copy SYSPEDS/qrpgsrcpy,usec
      /copy SYSPEDS/qrpgsrcpy,variables3
      *
      * Varible for
     D WSUSER          S             10
     D AVD             S              4
     D AVDN            S              4  0
     D OPD             S              7
     D OPDN            S              7  0
     D LIN             S              5
     D LINN            S              5  0
     D JSONstring      s          32000
     D Error           S            150
     D AntLest         S              9  0

      *get input-string
      /copy syspeds/qrpgsrcpy,prolog3

      * Parse input
     C                   EXSR      Parse
      * Open files etc
     C                   EXSR      INIT

     C                   CALLP     gethtmlifs(
     C                             '/syspeddev/html/JSON.html':
     C                             '/CGITAG/')
     C                   CALLP     wrtsection('top')
      * ............................................................................................
      * skriv JSON-Object start..(alltid '{' + x ant param. m/komma mellom (IKKE komma etter siste))
      * ............................................................................................
      /free
        JSONstring='{'
        +'¬user¬ : ¬'+%trim(WSUSER)+'¬, '
        +'¬avd¬ : ¬'+%trim(%editc(AVDN:'Z'))+'¬, '
        +'¬opd¬ : ¬'+%trim(%editc(OPDN:'Z'))+'¬, '
        +'¬lin¬ : ¬'+%trim(%editc(LINN:'Z'))+'¬, '
        +'¬errMsg¬ : ¬'+%trim(Error)+'¬, ¬oneline¬ : [';
      /end-free
      * JSONfix escaper " i tekst,  for deretter å bytte ¬->"
     C                   CALL      'JSONFIX'
     C                   PARM                    JSONstring
     C                   CALLP     updHTMLvar2('JSONstring'
     C                                         :%addr(JSONstring)
     C                                         :%len(JSONstring))
     C                   CALLP     wrtsection('JSONlin')
      * Hæmta detta ena ærendet.

     C     Error         IFEQ      *blanks
     C     SVEVKey       CHAIN     SVEV                               55
     C     *IN55         IFEQ      '0'
      * ............................................................................................
      * Skriv en JSON-Array-linje pr menypunkt - komma før hvert nytt element
      * ............................................................................................
      /free
          JSONstring=*blanks;
       JSONstring=%trim(JSONstring)+'{'
          +'¬svev_syav¬ : ¬'+%trim(%editc(SVEV_SYAV:'Z'))+'¬, '
          +'¬svev_syop¬ : ¬'+%trim(%editc(SVEV_SYOP:'Z'))+'¬, '
          +'¬svev_syli¬ : ¬'+%trim(%editc(SVEV_SYLI:'Z'))+'¬, '
          +'¬svev_kota¬ : ¬'+%trim(%editc(SVEV_KOTA:'Z'))+'¬, '
          +'¬svev_kot2¬ : ¬'+%trim(%editc(SVEV_KOT2:'Z'))+'¬, '
          +'¬svev_kot3¬ : ¬'+%trim(%editc(SVEV_KOT3:'Z'))+'¬, '
          +'¬svev_kot4¬ : ¬'+%trim(%editc(SVEV_KOT4:'Z'))+'¬, '
          +'¬svev_kot5¬ : ¬'+%trim(%editc(SVEV_KOT5:'Z'))+'¬, '
          +'¬svev_kosl¬ : ¬'+%trim(svev_kosl)+'¬, '
          +'¬svev_kos2¬ : ¬'+%trim(svev_kos2)+'¬, '
          +'¬svev_kos3¬ : ¬'+%trim(svev_kos3)+'¬, '
          +'¬svev_kos4¬ : ¬'+%trim(svev_kos4)+'¬, '
          +'¬svev_kos5¬ : ¬'+%trim(svev_kos5)+'¬, '
          +'¬svev_vasl¬ : ¬'+%trim(svev_vasl)+'¬, '
          +'¬svev_vas2¬ : ¬'+%trim(svev_vas2)+'¬, '
          +'¬svev_vas3¬ : ¬'+%trim(svev_vas3)+'¬, '
          +'¬svev_vas4¬ : ¬'+%trim(svev_vas4)+'¬, '
          +'¬svev_vas5¬ : ¬'+%trim(svev_vas5)+'¬, '
          +'¬svev_godm¬ : ¬'+%trim(svev_godm)+'¬, '
          +'¬svev_god2¬ : ¬'+%trim(svev_god2)+'¬, '
          +'¬svev_god3¬ : ¬'+%trim(svev_god3)+'¬, '
          +'¬svev_god4¬ : ¬'+%trim(svev_god4)+'¬, '
          +'¬svev_god5¬ : ¬'+%trim(svev_god5)+'¬, '
          +'¬svev_vano¬ : ¬'+%trim(%editc(svev_vano:'Z'))+'¬, '
          +'¬svev_vata¬ : ¬'+%trim(svev_vata)+'¬, '
          +'¬svev_vati¬ : ¬'+%trim(svev_vati)+'¬, '
          +'¬svev_vat4¬ : ¬'+%trim(svev_vat4)+'¬, '
          +'¬svev_vat5¬ : ¬'+%trim(svev_vat5)+'¬, '
          +'¬svev_ulkd¬ : ¬'+%trim(svev_ulkd)+'¬, '
          +'¬svev_brut¬ : ¬'+%trim(%editc(svev_brut:'4'))+'¬, '
          +'¬svev_eup1¬ : ¬'+%trim(svev_eup1)+'¬, '
          +'¬svev_eup2¬ : ¬'+%trim(svev_eup2)+'¬, '
          +'¬svev_neto¬ : ¬'+%trim(%editc(svev_neto:'4'))+'¬, '
          +'¬svev_kono¬ : ¬'+%trim(svev_kosl)+'¬, '
          +'¬svev_ankv¬ : ¬'+%trim(%editc(svev_ankv:'Z'))+'¬, '
          +'¬svev_suko¬ : ¬'+%trim(svev_suko)+'¬, '
          +'¬svev_suk6¬ : ¬'+%trim(svev_suk6)+'¬, '
          +'¬svev_sukb¬ : ¬'+%trim(svev_sukB)+'¬, '
          +'¬svev_sutx¬ : ¬'+%trim(svev_sutx)+'¬, '
          +'¬svev_sut2¬ : ¬'+%trim(svev_sut2)+'¬, '
          +'¬svev_sut3¬ : ¬'+%trim(svev_sut3)+'¬, '
          +'¬svev_sut4¬ : ¬'+%trim(svev_sut4)+'¬, '
          +'¬svev_sut5¬ : ¬'+%trim(svev_sut5)+'¬, '
          +'¬svev_sut6¬ : ¬'+%trim(svev_sut6)+'¬, '
          +'¬svev_sut7¬ : ¬'+%trim(svev_sut7)+'¬, '
          +'¬svev_sut8¬ : ¬'+%trim(svev_sut8)+'¬, '
          +'¬svev_sut9¬ : ¬'+%trim(svev_sut9)+'¬, '
          +'¬svev_suta¬ : ¬'+%trim(svev_suta)+'¬, '
          +'¬svev_sutb¬ : ¬'+%trim(svev_sutb)+'¬, '
          +'¬svev_sutc¬ : ¬'+%trim(svev_sutc)+'¬, '
          +'¬svev_sutd¬ : ¬'+%trim(svev_sutd)+'¬, '
          +'¬svev_sute¬ : ¬'+%trim(svev_sute)+'¬, '
          +'¬svev_sutf¬ : ¬'+%trim(svev_sutf)+'¬, '
          +'¬svev_suok¬ : ¬'+%trim(%editc(svev_suok:'Z'))+'¬, '
          +'¬svev_sukr¬ : ¬'+%trim(%editc(svev_sukr:'Z'))+'¬, '
          +'¬svev_suar¬ : ¬'+%trim(%editc(svev_suar:'Z'))+'¬, '
          +'¬svev_atin¬ : ¬'+%trim(svev_atin)+'¬, '
          +'¬svev_stva¬ : ¬'+%trim(%editc(svev_stva:'Z'))+'¬, '
          +'¬svev_stva2¬ : ¬'+%trim(%editc(svev_stva2:'Z'))+'¬, '
          +'¬svev_fabl¬ : ¬'+%trim(%editc(svev_fabl:'4'))+'¬, '
          +'¬svev_betk¬ : ¬'+%trim(svev_betk)+'¬, '
          +'¬svev_komr¬ : ¬'+%trim(svev_komr)+'¬, '
          +'¬svev_fnkd¬ : ¬'+%trim(svev_fnkd)+'¬, '
          +'¬svev_bit1¬ : ¬'+%trim(svev_bit1)+'¬, '
          +'¬svev_bit2¬ : ¬'+%trim(svev_bit2)+'¬, '
          +'¬svev_bit3¬ : ¬'+%trim(svev_bit3)+'¬, '
          +'¬svev_bit4¬ : ¬'+%trim(svev_bit4)+'¬, '
          +'¬svev_bit5¬ : ¬'+%trim(svev_bit5)+'¬, '
          +'¬svev_bit6¬ : ¬'+%trim(svev_bit6)+'¬, '
          +'¬svev_bit7¬ : ¬'+%trim(svev_bit7)+'¬, '
          +'¬svev_bit8¬ : ¬'+%trim(svev_bit8)+'¬, '
          +'¬svev_bit9¬ : ¬'+%trim(svev_bit9)+'¬, '
          +'¬svev_bii1¬ : ¬'+%trim(svev_bii1)+'¬, '
          +'¬svev_bii2¬ : ¬'+%trim(svev_bii2)+'¬, '
          +'¬svev_bii3¬ : ¬'+%trim(svev_bii3)+'¬, '
          +'¬svev_bii4¬ : ¬'+%trim(svev_bii4)+'¬, '
          +'¬svev_bii5¬ : ¬'+%trim(svev_bii5)+'¬, '
          +'¬svev_bii6¬ : ¬'+%trim(svev_bii6)+'¬, '
          +'¬svev_bii7¬ : ¬'+%trim(svev_bii7)+'¬, '
          +'¬svev_bii8¬ : ¬'+%trim(svev_bii8)+'¬, '
          +'¬svev_bii9¬ : ¬'+%trim(svev_bii9)+'¬, '
          +'¬svev_co01¬ : ¬'+%trim(svev_co01)+'¬, '
          +'¬svev_co02¬ : ¬'+%trim(svev_co02)+'¬, '
          +'¬svev_co03¬ : ¬'+%trim(svev_co03)+'¬, '
          +'¬svev_co04¬ : ¬'+%trim(svev_co04)+'¬, '
          +'¬svev_co05¬ : ¬'+%trim(svev_co05)+'¬, '
          +'¬svev_co06¬ : ¬'+%trim(svev_co06)+'¬, '
          +'¬svev_co07¬ : ¬'+%trim(svev_co07)+'¬, '
          +'¬svev_co08¬ : ¬'+%trim(svev_co08)+'¬, '
          +'¬svev_co09¬ : ¬'+%trim(svev_co09)+'¬, '
          +'¬svev_co10¬ : ¬'+%trim(svev_co10)+'¬, '
          +'¬svev_co11¬ : ¬'+%trim(svev_co11)+'¬, '
          +'¬svev_co12¬ : ¬'+%trim(svev_co12)+'¬, '
          +'¬svev_co13¬ : ¬'+%trim(svev_co13)+'¬, '
          +'¬svev_co14¬ : ¬'+%trim(svev_co14)+'¬, '
          +'¬svev_co15¬ : ¬'+%trim(svev_co15)+'¬, '
          +'¬svev_co16¬ : ¬'+%trim(svev_co16)+'¬, '
          +'¬svev_co17¬ : ¬'+%trim(svev_co17)+'¬, '
          +'¬svev_co18¬ : ¬'+%trim(svev_co18)+'¬, '
          +'¬svev_co19¬ : ¬'+%trim(svev_co19)+'¬, '
          +'¬svev_co20¬ : ¬'+%trim(svev_co20)+'¬, '
          +'¬svev_tik1¬ : ¬'+%trim(svev_tik1)+'¬, '
          +'¬svev_tik2¬ : ¬'+%trim(svev_tik2)+'¬, '
          +'¬svev_tik3¬ : ¬'+%trim(svev_tik3)+'¬, '
          +'¬svev_tik4¬ : ¬'+%trim(svev_tik4)+'¬, '
          +'¬svev_tik5¬ : ¬'+%trim(svev_tik5)+'¬, '
          +'¬svev_tik6¬ : ¬'+%trim(svev_tik6)+'¬, '
          +'¬svev_tik7¬ : ¬'+%trim(svev_tik7)+'¬, '
          +'¬svev_tik8¬ : ¬'+%trim(svev_tik8)+'¬, '
          +'¬svev_tik9¬ : ¬'+%trim(svev_tik9)+'¬, '
          +'¬svev_tit1¬ : ¬'+%trim(svev_tit1)+'¬, '
          +'¬svev_tit2¬ : ¬'+%trim(svev_tit2)+'¬, '
          +'¬svev_tit3¬ : ¬'+%trim(svev_tit3)+'¬, '
          +'¬svev_tit4¬ : ¬'+%trim(svev_tit4)+'¬, '
          +'¬svev_tit5¬ : ¬'+%trim(svev_tit5)+'¬, '
          +'¬svev_tit6¬ : ¬'+%trim(svev_tit6)+'¬, '
          +'¬svev_tit7¬ : ¬'+%trim(svev_tit7)+'¬, '
          +'¬svev_tit8¬ : ¬'+%trim(svev_tit8)+'¬, '
          +'¬svev_tit9¬ : ¬'+%trim(svev_tit9)+'¬, '
          +'¬svev_tix1¬ : ¬'+%trim(svev_tix1)+'¬, '
          +'¬svev_tix2¬ : ¬'+%trim(svev_tix2)+'¬, '
          +'¬svev_tix3¬ : ¬'+%trim(svev_tix3)+'¬, '
          +'¬svev_tix4¬ : ¬'+%trim(svev_tix4)+'¬, '
          +'¬svev_tix5¬ : ¬'+%trim(svev_tix5)+'¬, '
          +'¬svev_tix6¬ : ¬'+%trim(svev_tix6)+'¬, '
          +'¬svev_tix7¬ : ¬'+%trim(svev_tix7)+'¬, '
          +'¬svev_tix8¬ : ¬'+%trim(svev_tix8)+'¬, '
          +'¬svev_tix9¬ : ¬'+%trim(svev_tix9)+'¬, '
          +'¬svev_lagi¬ : ¬'+%trim(svev_lagi)+'¬, '
          +'¬svev_lagt¬ : ¬'+%trim(svev_lagt)+'¬, '
          +'¬svev_lagl¬ : ¬'+%trim(SVEV_lagl)+'¬, '
          +'¬svev_call¬ : ¬'+%trim(SVEV_call)+'¬, '
          +'¬svev_err¬ : ¬'+%trim(SVEV_ERR)+'¬}';
      /end-free
     C                   CALL      'JSONFIX'
     C                   PARM                    JSONstring
     C                   CALLP     updHTMLvar2('JSONstring'
     C                                         :%addr(JSONstring)
     C                                         :%len(JSONstring))
     C                   CALLP     wrtsection('JSONlin')

     C                   ENDIF
     C                   ENDIF
      * ............................................................................................
      * Skriv JSON-string Avsluttning
      * ............................................................................................
     C                   EVAL      JSONstring =']}'
     C                   CALLP     updHTMLvar2('JSONstring'
     C                                         :%addr(JSONstring)
     C                                         :%len(JSONstring))
     C                   CALLP     wrtsection('JSONlin')
      * Quit
     C                   EXSR      EXIT
      *=====================================================================
      * Close output html and quit
      *=====================================================================
     C     EXIT          BEGSR
      * Lukk fil
     C                   CLOSE     BRIDF
     C  N50              CLOSE     SVEV

      * Do not delete the CALL to wrtsection with section name *fini.  It is needed
      * to ensure that all output html that has been buffered gets output.
     C                   CALLP     wrtsection('*fini')
      * Quit
     C                   MOVE      *ON           *INLR
     C                   RETURN
     C                   ENDSR
      *********************************************************
     C     Parse         BEGSR
      *********************************************************
      * Get input
     C                   EVAL      WSUSER  = zhbgetvar('USER')
     C                   EVAL      AVD     = zhbgetvar('AVD')
     C                   EVAL      AVDN    = c2n2(AVD)
     C                   EVAL      OPD     = zhbgetvar('OPD')
     C                   EVAL      OPDN    = c2n2(OPD)
     C                   EVAL      LIN     = zhbgetvar('LIN')
     C                   EVAL      LINN    = c2n2(LIN)
     C                   ENDSR
      *********************************************************
     C     INIT          BEGSR
      *********************************************************
     C                   OPEN      BRIDF
      * Test innlogging
     C     WSUSER        CHAIN     BRIDF                              50
     C     BILIBL        IFEQ      *blanks
     C                   CALLb     'INCGI'
     C                   PARM                    BISTDL
     C                   else
     C                   CALL      BILIBL
     C                   end

     C     SVEVKey       klist
     C                   kfld                    AVDN
     C                   kfld                    OPDN
     C                   kfld                    LINN

     C   50              EVAL      Error = 'Invalid userID'
     C  N50              OPEN      SVEV

     C                   ENDSR
