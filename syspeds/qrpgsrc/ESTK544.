      *  Obs ! Kompiler med tillat error 20  GENLVL(20)    (decedit angitt 2 ganger-siste ignoreres)
      *********************************************************************
      *
CRTPG+*  CRTPGM SYSPED/ESTK544 MODULE(*LIBL/ESTK544 *LIBL/INCGI)
CRTPGM*         ACTGRP(*NEW) AUT(*USE)
      *
********************************************************************
      * RETTINGER I DETTE PROGRAM:
PTFnr:*Sek Sig Vers  Beskrivelse...........................
""""""*"""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""
10XXX * 01 JOV PTF11 Ved UKJENT USER kan en ikke kalle jsonfix (manglende libl..)
      * 02 JOV PTF11 kan overføre også et enkelt oppdrag
********************************************************************
     H decedit('0.')
      /copy syspeds/qrpgsrcpy,hspecs
      /copy syspeds/qrpgsrcpy,hspecsbnd
     FBRIDF     IF   E           K DISK    USROPN
     FBRPARF    IF   E           K DISK    USROPN
     FTurer14   UF   E           K DISK    USROPN
     FUNITL04   IF   E           K DISK    USROPN
      *********************************************************************
      *--------------------------------------------------------------------
      * Variables common to all CGIs
      *--------------------------------------------------------------------
      /copy syspeds/qrpgsrcpy,prototypeb
      /copy syspeds/qrpgsrcpy,usec
      /copy syspeds/qrpgsrcpy,variables3
     D EnvString       s          32000
     D JSONstring      s          32000
      * Prototype
     D JSONescape      PR                  ExtPgm('JSONESC')
     D   JSONstr                  32000A
      * Indicators for GetHtmlIfsMult subprocedure
     D IfsMultIndicators...
     D                 ds
     D  NoErrors                       n
     D  NameTooLong                    n
     D  NotAccessible                  n
     D  NoFilesUsable                  n
     D  DupSections                    n
     D  FileIsEmpty                    n

      *
      * Client input variables
     D userId          s             10
     D UsrSpcName      s             10                                         =
     D SJA             s              8
     D SJN             s              8  0
     D VERSJ           s             10
     D tur             s              8
     D TurNr           s              8  0
     D avd             s              4
     D avdN            s              4  0
     D opd             s              7
     D opdN            s              7  0
     D Cmd             s             10
     D Sjofor          s              8
     D NySjN           s              8  0
     D NYUser          s             10
     D ErrTxt          s            100
     D ItemCount       s             10i 0
     D i               s             10i 0
     D i2              s             10i 0
      * Definere  hex 0D / 25 (CRLF)
     D Hex0D           c                   x'0D'
     D Hex25           c                   x'25'
      *
     D Spaces          s             12a   inz('&nbsp;&nbsp;')
      *
      /copy syspeds/qrpgsrcpy,prolog3
      *
      * Parse input / cvt to numeric
     C                   exsr      Parse
      * Read output skeleton html member into memory
     C                   exsr      LoadHtml
      * File open / keys
     C                   EXSR      INIT
      * Set section variables
     C                   exsr      SetAll
      * Quit
     C                   exsr      Exit
      *
     C                   eval      *inlr = *on
     C                   return
      *
      *
      *=====================================================================
      * Parse input / cvt to numeric
      *=====================================================================
     C     Parse         begsr
      * Parse variables from QUERY_STRING environment variable
      * Userid = PD+8 siffer (8 siffer er sjåførid)
     C                   eval      userId = zhbgetvar('userId')
     C                   move      userId        SJA
     C                   eval      SJN     = c2n2(SJA)
      * versjonsnr av klientprogramvare
     C                   eval      TUR  = zhbgetvar('TUR')
     C                   eval      TURNR   = c2n2(TUR)
N02  C                   eval      AVD  = zhbgetvar('AVD')
N02  C                   eval      AVDN    = c2n2(AVD)
N02  C                   eval      OPD  = zhbgetvar('OPD')
N02  C                   eval      OPDN    = c2n2(OPD)
     C                   eval      Cmd  = zhbgetvar('CMD')
     C                   eval      Sjofor = zhbgetvar('Sjofor')
     C                   eval      NYSJN  = c2n2(Sjofor)
     C                   move      UserId        Nyuser
     C                   move      NYSJN         Nyuser
     C                   eval      VERSJ = zhbgetvar('V')
     C                   eval      UsrSpcName= zhbgetvar('sessionId')
     C                   endsr
      *=====================================================================
      * Close output html and quit
      *=====================================================================
     C     Exit          begsr
      * Do not delete the call to wrtsection with section name *fini.  It is needed
      * to ensure that all output html that has been buffered gets output.
     C                   callp     wrtsection('*fini')
      * Quit
     C                   CLOSE     BRIDF
     C                   CLOSE     BRPARF
     C                   CLOSE     TURER14
     C                   endsr
      *=====================================================================
      * Read output skeleton html member into memory
      *=====================================================================
     C     LoadHtml      begsr
     c                   callp     gethtmlifs(
     C                             '/syspeddev/html/JSON.html':
     C                             '/CGITAG/')
     C                   endsr
      *=====================================================================
      *  Set variable data for section /$top , lin , Bot
      *=====================================================================
     C     SetAll        begsr
      * Cmd = parker- åpne status
      * Cmd = slett - åpne status + fjern sjårførnr (evt bytt ut med et fast dymmynr..)
      * Cmd = overfor åpne status + sett inn medsent sjåfør
      * Cmd = ferdig- sett status 1 --> 2
     C                   move      *blanks       ErrTxt
N02   * OPD <> 0 betyr at det er oppdrag som ønskes flyttet fra en tusjåfør til en annen ..
N02  c     OPDN          ifne      *zeros
N02  c                   exsr      flyttEttOpd
N02  c                   goto      UtAll
N02  c                   endif
     C     Turnr         chain     TURER14                            33
     C     *IN33         ifeq      *OFF
     C                   move      ' '           TUTST4
     c                   select
     C     Cmd           wheneq    'slett'
     C                   move      *zeros        TUSJA1
     C                   MOVE      'TKIPD'       PAID
     C     FiParKey      CHAIN     BRPARF                             33
     C     *IN33         IFEQ      *OFF
     C                   z-add     Pavrdn        Tusja1
     C                   end
     C     Cmd           wheneq    'ferdig'
     C                   move      '2'           TUTST4
     C     Cmd           wheneq    'overfor'
     c                   exsr      ByttSJ
     C                   endsl
      *
     C                   update    turerr
     C                   endif
      * Send section top
     C                   callp     wrtsection('top')
      *
      *  Resultat  (foreløpig ingen erroe uansett
      /free
        JSONstring='{'
        +'¬userId¬ : ¬'+%trim(userId)+'¬, '
        +'¬error¬ : ¬'+%trim(ErrTxt)+'¬ }';
        callp JSONescape(JSONstring);
        updHTMLvar2('JSONstring':%addr(JSONstring):%len(JSONstring));
        wrtsection('JSONlin');
      /end-free
     C
E02  C     UtAll         endsr
      *
N02   ************************************************************
N02  C     flyttEttOpd   begsr
N02   ************************************************************
N02  c                   eval      errTxt = '#ERROR#Funksjonen er ikke '
N02  c                             +'satt i drift ennå ('
     c                             + AVD + '/' +OPD + 'Ny sj: '
     c                             + Sjofor +')'
N02   *  Resultat  (foreløpig ingen erroe uansett
N02   /free
N02     JSONstring='{'
N02     +'¬userId¬ : ¬'+%trim(userId)+'¬, '
N02     +'¬error¬ : ¬'+%trim(ErrTxt)+'¬ }';
N02     callp JSONescape(JSONstring);
N02     updHTMLvar2('JSONstring':%addr(JSONstring):%len(JSONstring));
N02     wrtsection('JSONlin');
N02   /end-free
N02  C
E02  C                   endsr
      ************************************************************
     C     ByttSj        begsr
      ************************************************************
      * forutsett at det går feil - status til blank kun hvis OK
     c                   move      '1'           TUTST4
     C     NYUSER        CHAIN     BRIDF                              50
     C     *IN50         IFEQ      '1'
     C                   eval      ErrTxt = '#ERROR#Ukjent NY sjåfør '
     C                   goto      ErrSj
     C                   end
     C     TUST          IFEQ      'P'
     C                   eval      ErrTxt = '#ERROR#Noen arbeider med turen. '+
     c                             'Kan ikke bytte nå (kontakt kontoret/vent)'
     C                   goto      ErrSj
     C                   end
      * Sjårfør på turen ER alt endret på kontoret
     C     SJN           IFne      TUSJA1
     C                   eval      ErrTxt = '#ERROR#Du er IKKE registrert ' +
     c                             'som sjåfør på tuen - SLETT den fra PDA.'
     C                   goto      ErrSj
     C                   end
      *  sjåfør som Mottar MÅ være knyttet til bil som iggjen tilgører samme trans.
     C                   OPEN      UNITL04
     c                   Eval      UNRETU = 'PDA:'+SJA
     c     UNRETU        setll     UNITL04
     c     UNRETU        reade     UNITL04                                33
     c  N33UNTRAN        comp      TUKNT2                             33
     C                   CLOSE     UNITL04
     C     *IN33         IFEQ      '1'
     C                   eval      ErrTxt = '#ERROR#NY sjåfør er ikke ' +
     c                             'tilknyttet samme sjåfør som gammel.'
     C                   goto      ErrSj
     C                   end
      * ingen feil ved bytt - Utfør byttest
     c                   move      UNBILN        TUBILN
     c                   move      NYSjN         TUSJA1
     c                   move      ' '           TUTST4
      *
     C     ErrSj         endsr
      *
      *=====================================================================******
      *  INITIER
      *=====================================================================******
     C     INIT          begsr
      * HTTP_.... = headers , men grier ikke å hente privte headers
     C                   eval      EnvString  =getenv('HTTP_X-Test':
     C                             qusec)
     C                   eval      EnvString  =getenv('HTTP_Content-Type':
     C                             qusec)
     C                   eval      EnvString  =getenv('HTTP_CONTENT-TYPE':
     C                             qusec)
     C                   eval      EnvString  =getenv('HTTP_CONNECTION':
     C                             qusec)
     C                   eval      EnvString  =getenv('HTTP_DATE':
     C                             qusec)
      *
     C                   eval      EnvString  =getenv('REQUEST_METHOD':
     C                             qusec)
     C                   eval      EnvString  =getenv('CONTENT_TYPE':
     C                             qusec)
     C                   eval      EnvString  =getenv('QUERY_STRING':
     C                             qusec)
     C                   OPEN      BRIDF
     C     userId        CHAIN     BRIDF                              50
      * Ukjent UserID
     c     *in50         ifeq      '1'
     C                   close     BRIDF
      /free
        wrtsection('top');

        JSONstring='{'
        +'"userId" : "'+%trim(userId)+'", '
        +'"error" : "UnKnown UserID" ';
        JSONstring='}';
        updHTMLvar2('JSONstring':%addr(JSONstring):%len(JSONstring));
        wrtsection('JSONlin');

        wrtsection('*fini');
      /end-free
     C                   eval      *inlr = *on
     C                   return
     c                   endif
     C* En "standardvariant" libl: call bound (INCGI=*MODULE) med parameter.
     C     BILIBL        ifeq      *blanks
     C                   callb     'INCGI'
     C                   parm                    BISTDL
     C                   else
     C* Helt egen bibl.liste satt på user - normal CALL (BILIBL er "*pgm")
     C                   call      BILIBL
     C                   end
      * Kontoll av UsrSpcName (= sessionId)
      * pr juli 2014 - ingen test av korrekt UsrSpcName (lage variant av CHECK-USER ??)
     C*                  CALLB     PGMXXX
     C*                  PARM                    BIBRID
     C*                  PARM                    UsrSpcName
     C*                  PARM                    UINN              1
     C*                  IF        UINN = 'N'
     C* .....
     C*                  eval      *inlr = *on
     C*                  return
     C*                  END
      *
     C                   OPEN      BRPARF
     C                   OPEN      TURER14
     C     FiParKey      klist
     C                   kfld                    FIBRID
     C                   kfld                    PAKUNR
     C                   kfld                    PAID
     C                   movel     '*KUNDFT*'    FIBRID           10
     C                   move      BIFIRM        FIBRID
     C     UtInit        endsr
      *
      *
