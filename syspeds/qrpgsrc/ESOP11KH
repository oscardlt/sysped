      *********************************************************************
      * MERKE OPPDRAG KLAR FOR HENTING
      *********************************************************************
CRTPG+*  CRTPGM SYSPED/ESOP11KH MODULE(*LIBL/ESOP11KH
CRTPGM*        *LIBL/INCGI) ACTGRP(CGI) AUT(*USE)
      *********************************************************************
      * RETTINGER I DETTE PROGRAM:
PTFnr:*Sek Sig Vers  Beskrivelse...........................
""""""*"""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""
10XXX * 01 JOV PTF10 Benytter ikke lenger Utlev-forbehold ved henting..
********************************************************************
      *
      /copy syspeds/qrpgsrcpy,hspecs
      /copy syspeds/qrpgsrcpy,hspecsbnd
     FBRIDF     IF   E           K DISK    USROPN
s01  F*EADF     UF   E           K DISK    USROPN
n01  FHEADF     IF   E           K DISK    USROPN
     FTRACKl02  IF A E           K DISK    USROPN
      *--------------------------------------------------------------------
      * Prototype definitions and standard system API error structure
      /copy syspeds/qrpgsrcpy,prototypeb
      /copy syspeds/qrpgsrcpy,usec
      * Variables common to CGI programs
      /copy syspeds/qrpgsrcpy,variables3
      *--------------------------------------------------------------------
      * VARIABLES SPECIFIC TO THIS PROGRAM
      *--------------------------------------------------------------------
      * Variables received from the input string
     D lng             s              2
     D UsrSpcName      s             10

     D WSUSER          S             10
     D MailAdr         S             70
     D MerkTxt         S             70
     D AVD             S              4
     D OPD             S              7
     D Lib             s             10
     D Fn              s             10
     D Mbr             s             10
     D ItemCount       s             10i 0
     D i               s             10i 0
     D                 DS
     D  HEFT1                  1     51
     D  HEFT1A                 1     30
     D  HEFT1B                31     45
     D                 DS
     D  WDs≈MD                 1      8  0
     D  WDs≈MD≈                1      4  0
     D  WDs≈MDM                5      6  0
     D  WDs≈MDD                7      8  0
     D                 DS
     D  WDsDM≈                 1      8  0
     D  WDsDM≈D                1      2  0
     D  WDsDM≈M                3      4  0
     D  WDsDM≈≈                5      8  0
      *
      /copy syspeds/qrpgsrcpy,prolog3
      *=====================================================================
      * MAIN PROCESSING LINE
      *=====================================================================
      * Parse input string
     C                   exsr      Parse
      * Initier
     C                   EXSR      INIT
      * Oppdater/vis bekrefting
     C                   eval      Lib = '*LIBL'
     C                   eval      Fn  = 'HTMLSRC'
     C                   eval      Mbr = 'ESOP11KH'
     C                   callp     gethtml(fn:lib:mbr:'/CGITAG/')
     C                   EXSR      HOVED
     C                   callp     wrtsection('all')
      * Send output buffer and quit
     C     SLUTT         TAG
     C                   exsr      Exit
      *********************************************************************
     C     Hoved         begsr
      *********************************************************************
n01  C     HEADFK        chain     HEADF                              33
N01  c     *in33         cabeq     '1'           utMerk
      *  ER den alt bekreftet ?
     C                   MOVE      'RFC'         TTACTI
     C     TT02max       setgt     TRACKL02
     C     TT02KEY       readpe    TRACKL02                               33
     c     *in33         ifeq      '0'
s01  C*    HEADFK        chain(N)  HEADF                              33
     c                   eval      MerkTxt = 'Godset ER TIDLIGERE '
     c                             +'merket klart for henting:'
     c                   goto      utMerk
     c                   endif
      *
     C                   CALL      'SYGE15C'
     C                   PARM                    WDT               8
     C                   PARM                    WTM               6
S01  C*    HEADFK        chain     HEADF                              33
S01  c*    *in33         ifeq      *off
S01  C*    HEKF          IFEQ      'KH'
S01  c*                  eval      HEKFT1='X'
S01  C*                  eval      HEFT1B='BEKREFTET KLART!!'
S01  C*                  endif
S01  c*                  UPDATE    HEADFR
     c                   eval      MerkTxt = 'Godset nÂ '
     c                             +'merket klart for henting:'
      *
     C                   MOVE      HEAVD         TTAVD
     C                   MOVE      HEOPD         TTOPD
     C                   MOVE      WDT           TTDATE
     C                   MOVE      WTM           TTTIME
     C                   MOVE      WDT           TTDATL
     C                   MOVE      WTM           TTTIML
     C                   MOVE      'RFC'         TTACTI
     C                   MOVE      WSUSER        TTUSER
     C                   EVAL      TTTEXT ='Marked ready for collection '
     c                             +'by sender - ' + MailAdr
     C                   EVAL      TTTEXL ='Merket klar for henting av '
     c                             +'avsender - ' + MailAdr
     C                   MOVE      'S'           TTMANU
     C                   write     TRACKFR
S01  C*                  endif
      *
     c     UtMerk        tag
     C                   callp     updHtmlVar('HERFA':HERFA)
     C                   callp     updhtmlvar('HEAVD':
     C                             %trim(%editc(HEAVD:'Z')))
     C                   callp     updhtmlvar('HEOPD':
     C                             %trim(%editc(HEOPD:'Z')))
     C                   callp     updHtmlVar('SendNr':%subst(HXSNDN:4:17))
     C                   callp     updhtmlvar('HENT':
     C                             %trim(%editc(HENT:'Z')))
     C                   callp     updHtmlVar('HEVS1':HEVS1)
     C                   callp     updhtmlvar('HEVKT':
     C                             %trim(%editc(HEVKT:'Z')))
     C                   callp     updHtmlVar('MerkTxt':MerkTxt)
      * snu dato ≈.M.dag
     c                   move      TTDATE        WDs≈MD
     c                   move      WDs≈MD≈       WDsDM≈≈
     c                   move      WDs≈MDM       WDsDM≈M
     c                   move      WDs≈MDD       WDsDM≈D
     C                   callp     updHTMLvar('DATE':
     C                             %trim(%editw(WDsDM≈:'  .  .    ')))
     c                   movel     TTTIME        TIME4             4 0
     C                   callp     updHTMLvar('TIME4':
     C                             %trim(%editw(TIME4:'  :  ')))
     C                   endsr
      *
      *********************************************************************
     C     Exit          begsr
      *********************************************************************
     C                   callp     wrtsection('*fini')
     C                   CLOSE     BRIDF
     C                   CLOSE     HEADF
     C                   CLOSE     TRACKL02
     C                   eval      *inlr = *on
     C                   return
     C                   endsr
      *=====================================================================
      * Parse input string
      *=====================================================================
     C     Parse         begsr

     C                   eval      WSUSER  = zhbgetvar('USER')
     C                   eval      AVD     = zhbgetvar('HEAVD')
     C                   eval      HEAVD   = c2n2(AVD)
     C                   eval      OPD     = zhbgetvar('HEOPD')
     C                   eval      HEOPD   = c2n2(OPD)
     C                   eval      MailAdr = zhbgetvar('MailAdr')

     C                   endsr
      *=====================================================================
      *  Initier
      *=====================================================================
     C     INIT          begsr
      * Get program start time for calculating execution time
     C                   time                    timedata1
      *
     C                   OPEN      BRIDF
     C     WSUSER        CHAIN     BRIDF                              50
     C* En "standardvariant" libl: call bound (INCGI=*MODULE) med parameter.
     C     BILIBL        ifeq      *blanks
     C                   CALLB     'INCGI'
     C                   PARM                    BISTDL
     C                   else
     C* Helt egen bibl.liste satt pÂ user - normal CALL (BILIBL er "*pgm")
     C                   call      BILIBL
     C                   end
      *
     C                   open      HEADF                                50
     C                   open      TRACKL02                             50
      *
     c     HEADFK        klist
     c                   kfld                    HEAVD
     c                   kfld                    HEOPD
N23  C     TT02MAX       KLIST
     C                   KFLD                    HEAVD
     C                   KFLD                    HEOPD
     C                   KFLD                    TTFBNR
     C                   KFLD                    TTACTI
     C                   KFLD                    Maxdate
     C                   move      99999999      Maxdate           8 0
N23  C     TT02KEY       KLIST
     C                   KFLD                    HEAVD
     C                   KFLD                    HEOPD
     C                   KFLD                    TTFBNR
     C                   KFLD                    TTACTI
      *
     C                   endsr
      *
