      *********************************************************************
      *
CRTPG+*  CRTPGM SYSPED/TDKI001R MODULE(*LIBL/TDKI001R *LIBL/INCGI)
CRTPGM*        ACTGRP(*NEW) AUT(*USE)
      *
      *********************************************************************
      /copy SYSPEDS/qrpgsrcpy,hspecs
      /copy SYSPEDS/qrpgsrcpy,hspecsbnd
      *********************************************************************
     FBRIDF     IF   E           K DISK    USROPN
     FDKIH      IF   E           K DISK    USROPN
     FFRISOK    IF   E           K DISK    USROPN
      *--------------------------------------------------------------------
      * Variables common to all CGIs
      *--------------------------------------------------------------------
      /copy SYSPEDS/qrpgsrcpy,prototypeb
      /copy SYSPEDS/qrpgsrcpy,usec
      /copy SYSPEDS/qrpgsrcpy,variables3
      *
      * Varible for
     D WSUSER          S             10
     D AVD             S              4
     D AVDN            S              4  0
     D OPD             S              7
     D OPDN            S              7  0
     D JSONstring      s          32000
     D Error           S            150
     D AntLest         S              9  0

      *get input-string
      /copy syspeds/qrpgsrcpy,prolog3

      * Parse input
     C                   exsr      Parse
      * Open files etc
     C                   EXSR      INIT
      *
     c                   callp     gethtmlifs(
     C                             '/syspeddev/html/JSON.html':
     C                             '/CGITAG/')
     C                   callp     wrtsection('top')
      *
      * ............................................................................................
      * skriv JSON-Object start..(alltid '{' + x ant param. m/komma mellom (IKKE komma etter siste))
      * ............................................................................................
      *
      /free
        JSONstring='{'
        +'¬user¬ : ¬'+%trim(WSUSER)+'¬, '
        +'¬avd¬ : ¬'+%trim(%editc(AVDN:'Z'))+'¬, '
        +'¬opd¬ : ¬'+%trim(%editc(OPDN:'Z'))+'¬, '
        +'¬errMsg¬ : ¬'+%trim(Error)+'¬, ';
      /end-free
      * JSONfix escaper " i tekst,  for deretter å bytte ¬->"
     c                   call      'JSONFIX'
     c                   parm                    JSONstring
     C                   CALLP     updHTMLvar2('JSONstring'
     C                                         :%addr(JSONstring)
     C                                         :%len(JSONstring))
     C                   callp     wrtsection('JSONlin')
      *
      * ............................................................................................
      * Skriv JSON-LISTE Start (en liste er EN parameter(fra [ til   )
      * ............................................................................................
     C                   eval      JSONstring ='"oneorder" : ['
     C                   CALLP     updHTMLvar2('JSONstring'
     C                                         :%addr(JSONstring)
     C                                         :%len(JSONstring))
     C                   callp     wrtsection('JSONlin')
      *
      * Hæmta detta ena ærendet.
      *
     c     Error         ifeq      *blanks
     C     DKIHKey       CHAIN     DKIH                               55
     C  N55FRIKEY        CHAIN     FRISOK                             56
     C   56              EVAL      FSSOK=*BLANKS
     C     *IN55         IFEQ      '0'
      * ............................................................................................
      * Skriv en JSON-Array-linje pr menypunkt - komma før hvert nytt element
      * ............................................................................................
      /free
          JSONstring=*blanks;
       JSONstring=%trim(JSONstring)+'{'
          +'¬dkih_syav¬ : ¬'+%trim(%editc(DKIH_SYAV:'Z'))+'¬, '
          +'¬dkih_syop¬ : ¬'+%trim(%editc(DKIH_SYOP:'Z'))+'¬, '
          +'¬dkih_sysg¬ : ¬'+%trim(DKIH_SYSG)+'¬, '
          +'¬dkih_syst¬ : ¬'+%trim(DKIH_SYST)+'¬, '
          +'¬dkih_sydt¬ : ¬'+%trim(%editc(DKIH_SYDT:'Z'))+'¬, '
          +'¬dkih_0035¬ : ¬'+%trim(DKIH_0035)+'¬, '
          +'¬dkih_godt¬ : ¬'+%trim(%editc(DKIH_GODT:'Z'))+'¬, '
          +'¬dkih_vadt¬ : ¬'+%trim(%editc(DKIH_VADT:'Z'))+'¬, '
          +'¬dkih_sadt¬ : ¬'+%trim(%editc(DKIH_SADT:'Z'))+'¬, '
          +'¬dkih_andt¬ : ¬'+%trim(%editc(DKIH_ANDT:'Z'))+'¬, '
          +'¬dkih_1004¬ : ¬'+%trim(DKIH_1004)+'¬, '
          +'¬dkih_xref¬ : ¬'+%trim(FSSOK)+'¬, '
          +'¬dkih_a¬ : ¬'+%trim(DKIH_A)+'¬, '
          +'¬dkih_dtm1¬ : ¬'+%trim(%editc(DKIH_DTM1:'Z'))+'¬, '
          +'¬dkih_dtm2¬ : ¬'+%trim(%editc(DKIH_DTM2:'Z'))+'¬, '
          +'¬dkih_ajou¬ : ¬'+%trim(DKIH_AJOU)+'¬, '
          +'¬dkih_ensf¬ : ¬'+%trim(DKIH_ENSF)+'¬, '
          +'¬dkih_bega¬ : ¬'+%trim(DKIH_BEGA)+'¬, '
          +'¬dkih_begb¬ : ¬'+%trim(DKIH_BEGB)+'¬, '
          +'¬dkih_begc¬ : ¬'+%trim(DKIH_BEGC)+'¬, '
          +'¬dkih_begd¬ : ¬'+%trim(DKIH_BEGD)+'¬, '
          +'¬dkih_r011¬ : ¬'+%trim(DKIH_R011)+'¬, '
          +'¬dkih_r012¬ : ¬'+%trim(DKIH_R012)+'¬, '
          +'¬dkih_aart¬ : ¬'+%trim(DKIH_AART)+'¬, '
          +'¬dkih_avkn¬ : ¬'+%trim(%editc(DKIH_AVKN:'Z'))+'¬, '
          +'¬dkih_02a¬ : ¬'+%trim(DKIH_02A)+'¬, '
          +'¬dkih_02b¬ : ¬'+%trim(DKIH_02B)+'¬, '
          +'¬dkih_02c¬ : ¬'+%trim(DKIH_02C)+'¬, '
          +'¬dkih_02d¬ : ¬'+%trim(DKIH_02D)+'¬, '
          +'¬dkih_02e¬ : ¬'+%trim(DKIH_02E)+'¬, '
          +'¬dkih_02f¬ : ¬'+%trim(DKIH_02F)+'¬, '
          +'¬dkih_06¬ : ¬'+%trim(%editc(DKIH_06:'Z'))+'¬, '
          +'¬dkih_07¬ : ¬'+%trim(DKIH_07)+'¬,'
          +'¬dkih_07a¬ : ¬'+%trim(DKIH_07A)+'¬,'
          +'¬dkih_07b¬ : ¬'+%trim(DKIH_07B)+'¬, '
          +'¬dkih_07c¬ : ¬'+%trim(DKIH_07C)+'¬, '
          +'¬dkih_07d¬ : ¬'+%trim(DKIH_07D)+'¬, '
          +'¬dkih_mokn¬ : ¬'+%trim(%editc(DKIH_MOKN:'Z'))+'¬, '
          +'¬dkih_08a¬ : ¬'+%trim(DKIH_08A)+'¬, '
          +'¬dkih_08b¬ : ¬'+%trim(DKIH_08B)+'¬, '
          +'¬dkih_08c¬ : ¬'+%trim(DKIH_08C)+'¬, '
          +'¬dkih_08d¬ : ¬'+%trim(DKIH_08D)+'¬, '
          +'¬dkih_08e¬ : ¬'+%trim(DKIH_08E)+'¬, '
          +'¬dkih_08f¬ : ¬'+%trim(DKIH_08F)+'¬, '
          +'¬dkih_rekn¬ : ¬'+%trim(%editc(DKIH_REKN:'Z'))+'¬, '
          +'¬dkih_reeo¬ : ¬'+%trim(DKIH_REEO)+'¬, '
          +'¬dkih_trkn¬ : ¬'+%trim(%editc(DKIH_TRKN:'Z'))+'¬, '
          +'¬dkih_treo¬ : ¬'+%trim(DKIH_TREO)+'¬, '
          +'¬dkih_trna¬ : ¬'+%trim(DKIH_TRNA)+'¬, '
          +'¬dkih_trga¬ : ¬'+%trim(DKIH_TRGA)+'¬, '
          +'¬dkih_trpo¬ : ¬'+%trim(DKIH_TRPO)+'¬, '
          +'¬dkih_trby¬ : ¬'+%trim(DKIH_trby)+'¬, '
          +'¬dkih_trlk¬ : ¬'+%trim(DKIH_trlk)+'¬, '
          +'¬dkih_nikn¬ : ¬'+%trim(%editc(DKIH_NIKN:'Z'))+'¬, '
          +'¬dkih_nieo¬ : ¬'+%trim(DKIH_nieo)+'¬, '
          +'¬dkih_nina¬ : ¬'+%trim(DKIH_NINA)+'¬, '
          +'¬dkih_niga¬ : ¬'+%trim(DKIH_NIGA)+'¬, '
          +'¬dkih_nipo¬ : ¬'+%trim(DKIH_NIPO)+'¬, '
          +'¬dkih_niby¬ : ¬'+%trim(DKIH_NIBY)+'¬, '
          +'¬dkih_nilk¬ : ¬'+%trim(DKIH_NILK)+'¬, '
          +'¬dkih_12¬ : ¬'+%trim(%editc(DKIH_12:'4'))+'¬, '
          +'¬dkih_12e¬ : ¬'+%trim(%editc(DKIH_12E:'4'))+'¬, '
          +'¬dkih_14a¬ : ¬'+%trim(DKIH_14A)+'¬, '
          +'¬dkih_14b¬ : ¬'+%trim(DKIH_14B)+'¬, '
          +'¬dkih_15¬ : ¬'+%trim(DKIH_15)+'¬, '
          +'¬dkih_s17¬ : ¬'+%trim(DKIH_S17)+'¬, '
          +'¬dkih_s18¬ : ¬'+%trim(DKIH_S18)+'¬, '
          +'¬dkih_s28¬ : ¬'+%trim(DKIH_S28)+'¬, '
          +'¬dkih_s32¬ : ¬'+%trim(DKIH_S32)+'¬, '
          +'¬dkih_181¬ : ¬'+%trim(DKIH_181)+'¬, '
          +'¬dkih_201¬ : ¬'+%trim(DKIH_201)+'¬, '
          +'¬dkih_202¬ : ¬'+%trim(DKIH_202)+'¬, '
          +'¬dkih_211¬ : ¬'+%trim(DKIH_211)+'¬, '
          +'¬dkih_221¬ : ¬'+%trim(DKIH_221)+'¬, '
          +'¬dkih_221b¬ : ¬'+%trim(%editc(DKIH_221B:'4'))+'¬, '
          +'¬dkih_221c¬ : ¬'+%trim(%editc(DKIH_221C:'Z'))+'¬, '
          +'¬dkih_222¬ : ¬'+%trim(%editc(DKIH_222:'4'))+'¬, '
          +'¬dkih_25¬ : ¬'+%trim(DKIH_25)+'¬, '
          +'¬dkih_26¬ : ¬'+%trim(DKIH_26)+'¬, '
          +'¬dkih_28a¬ : ¬'+%trim(DKIH_28A)+'¬, '
          +'¬dkih_28b¬ : ¬'+%trim(DKIH_28B)+'¬, '
          +'¬dkih_28c¬ : ¬'+%trim(%editc(DKIH_28C:'Z'))+'¬, '
          +'¬dkih_s29¬ : ¬'+%trim(DKIH_S29)+'¬, '
          +'¬dkih_301¬ : ¬'+%trim(DKIH_301)+'¬, '
          +'¬dkih_302¬ : ¬'+%trim(DKIH_302)+'¬, '
          +'¬dkih_303¬ : ¬'+%trim(DKIH_303)+'¬, '
          +'¬dkih_304¬ : ¬'+%trim(DKIH_304)+'¬, '
          +'¬dkih_49¬ : ¬'+%trim(DKIH_49)+'¬, '
          +'¬dkih_brut¬ : ¬'+%trim(%editc(DKIH_BRUT:'4'))+'¬, '
          +'¬dkih_genb¬ : ¬'+%trim(DKIH_GENB)+'¬, '
          +'¬dkih_t04a¬ : ¬'+%trim(DKIH_T04A)+'¬, '
          +'¬dkih_t04b¬ : ¬'+%trim(%editc(DKIH_T04B:'Z'))+'¬, '
          +'¬dkih_t05a¬ : ¬'+%trim(DKIH_T05A)+'¬, '
          +'¬dkih_t05b¬ : ¬'+%trim(%editc(DKIH_T05B:'Z'))+'¬, '
          +'¬dkih_t06a¬ : ¬'+%trim(DKIH_T06A)+'¬, '
          +'¬dkih_t06b¬ : ¬'+%trim(%editc(DKIH_T06B:'Z'))+'¬, '
          +'¬dkih_t07a¬ : ¬'+%trim(DKIH_T07A)+'¬, '
          +'¬dkih_t07b¬ : ¬'+%trim(DKIH_T07B)+'¬, '
          +'¬dkih_t07c¬ : ¬'+%trim(DKIH_T07C)+'¬, '
          +'¬dkih_t07d¬ : ¬'+%trim(DKIH_T07D)+'¬, '
          +'¬dkih_t08a¬ : ¬'+%trim(DKIH_T08A)+'¬, '
          +'¬dkih_t08b¬ : ¬'+%trim(DKIH_T08B)+'¬, '
          +'¬dkih_t08c¬ : ¬'+%trim(DKIH_T08C)+'¬, '
          +'¬dkih_t09a¬ : ¬'+%trim(DKIH_T09A)+'¬, '
          +'¬dkih_t09b¬ : ¬'+%trim(DKIH_T09B)+'¬}';
      /end-free
     C                   call      'JSONFIX'
     C                   parm                    JSONstring
     C                   CALLP     updHTMLvar2('JSONstring'
     C                                         :%addr(JSONstring)
     C                                         :%len(JSONstring))
     C                   callp     wrtsection('JSONlin')
      *
     C                   ENDIF
     c                   endif
     c                   eval      JSONstring =']'
     C                   CALLP     updHTMLvar2('JSONstring'
     C                                         :%addr(JSONstring)
     C                                         :%len(JSONstring))
     C                   callp     wrtsection('JSONlin')
      * ............................................................................................
      * Skriv JSON-string Avsluttning
      * ............................................................................................
     c                   eval      JSONstring ='}'
     C                   CALLP     updHTMLvar2('JSONstring'
     C                                         :%addr(JSONstring)
     C                                         :%len(JSONstring))
     C                   callp     wrtsection('JSONlin')
      *
      * Quit
     C                   exsr      Exit


      *=====================================================================
      * Close output html and quit
      *=====================================================================
     C     Exit          begsr
      * Lukk fil
     C                   CLOSE     BRIDF
     C  N50              CLOSE     DKIH
     C  N50              CLOSE     FRISOK

      * Do not delete the call to wrtsection with section name *fini.  It is needed
      * to ensure that all output html that has been buffered gets output.
     C                   callp     wrtsection('*fini')
      * Quit
     C                   MOVE      *ON           *INLR
     C                   return
     C                   endsr
      *
      *********************************************************
     C     Parse         Begsr
      *********************************************************
      * Get input
     C                   EVAL      WSUSER  = zhbgetvar('USER')
     C                   EVAL      AVD     = zhbgetvar('AVD')
     C                   eval      AVDN    = c2n2(AVD)
     C                   EVAL      OPD     = zhbgetvar('OPD')
     C                   eval      OPDN    = c2n2(OPD)
     c                   endsr
      *
      *********************************************************
     C     INIT          Begsr
      *********************************************************
     C                   OPEN      BRIDF
      * Test innlogging
     C     WSUSER        CHAIN     BRIDF                              50
     C     BILIBL        ifeq      *blanks
     C                   callb     'INCGI'
     C                   parm                    BISTDL
     C                   else
     C                   call      BILIBL
     C                   end
      *
     C     DKIHKey       klist
     C                   kfld                    AVDN
     C                   kfld                    OPDN
     C     FRIKEY        klist
     C                   kfld                    AVDN
     C                   kfld                    OPDN
     C                   kfld                    WFSKODE           3

     C                   EVAL      WFSKODE='*CR'

     C   50              eval      Error = 'Invalid userID'
     C  N50              OPEN      DKIH
     C  N50              OPEN      FRISOK

     c                   endsr
      *
