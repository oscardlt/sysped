      *********************************************************************
CRTPG+*  CRTPGM SYSPED/TNOE002R MODULE(*LIBL/TNOE002R *LIBL/INCGI)
CRTPGM*        ACTGRP(CGI) AUT(*USE)
      *********************************************************************
      /copy SYSPEDS/qrpgsrcpy,hspecs
      /copy SYSPEDS/qrpgsrcpy,hspecsbnd
      *********************************************************************
     FBRIDF     IF   E           K DISK    USROPN
     FSAEH      UF A E           K DISK    USROPN
     F                                     PREFIX(X)
     FSAEH1     IF   E             DISK    USROPN
     F                                     RENAME(SAEHR:SAEHR1)
     FSAEHTL    UF A E           K DISK    USROPN
     F                                     PREFIX(X)
     FSAEV      IF A E           K DISK    USROPN
     FSTANDE    UF   E           K DISK    USROPN
     F                                     PREFIX(Y)
     FKODTSI1   IF   E           K DISK    USROPN
     F                                     RENAME(KOSIR:KOSIR1)
     FKODTSI    IF   E           K DISK    USROPN
     FHEADF     UF   E           K DISK    USROPN
     FCUNDL01   IF   E           K DISK    USROPN
     FFIRM      IF   E             DISK    USROPN
     FEDIC      UF   E             DISK    USROPN
     FEDIM1     UF A E           K DISK    USROPN
     FEDIM2     IF   E           K DISK    USROPN
     F                                     RENAME(EDIMR:EDIMR2)
     FEDIM4     IF   E           K DISK    USROPN
     F                                     RENAME(EDIMR:EDIMR4)
     FFRISOK    UF A E           K DISK    USROPN
     FFRISOL01  IF   E           K DISK    USROPN
     F                                     RENAME(FRISOKR:FRISOKRL)
     FTVIND     UF A E           K DISK    USROPN
     FKODTA     IF   E           K DISK    USROPN
     FKODTLB    IF   E           K DISK    USROPN
      *--------------------------------------------------------------------
      * Variables common to all CGIs
      *--------------------------------------------------------------------
      /copy SYSPEDS/qrpgsrcpy,prototypeb
      /copy SYSPEDS/qrpgsrcpy,usec
      /copy SYSPEDS/qrpgsrcpy,variables3
      *
      * Varible for
     D P               S              5U 0
     D WSUSER          S             10
     D SEAVDA          S              4
     D NEWSYAVA        S              4
     D NEWAVD          S              4  0
     D SETDNA          S              7
     D NEWOPD          S              7  0
     D WMODE           S              2
     D WSESG           S              3
     D NEWSESG         S              3
     D SESAM           S              1
     D SEFVK           S              3S 2
     D WA              S             15
     D XREF            S             35
     D JSONstring      S          32000
     D Error           S            150
     D                 DS
     D  X0068Æ                 1      9  0
     D  X0068A                10     17  0
     D  X0068B                18     23  0
     D  X0068C                24     25  0
     D  X0068Å                 2     25
     D  XN068Å                 1     25
     D                 DS
     D  SYRG                   1     14
     D  SYFORE                 1      9

      *get input-string
      /copy syspeds/qrpgsrcpy,prolog3

      * Parse input
     C                   EXSR      Parse
      * Open files etc
     C                   EXSR      INIT
      *
     c                   callp     gethtmlifs(
     C                             '/syspeddev/html/JSON.html':
     C                             '/CGITAG/')
     C                   callp     wrtsection('top')
      * Teste input og utfør
     C  N50              EXSR      TEST

      * ............................................................................................
      * skriv JSON-Object start..(alltid '{' + x ant param. m/komma mellom (IKKE komma etter siste))
      * ............................................................................................
      *
      /free
        JSONstring='{'
        +'¬user¬ : ¬'+%trim(WSUSER)+'¬, '
        +'¬seavd¬ : ¬'+%trim(%editc(SEAVD:'Z'))+'¬, '
        +'¬newavd¬ : ¬'+%trim(%editc(NEWAVD:'Z'))+'¬, '
        +'¬setdn¬ : ¬'+%trim(%editc(SETDN:'Z'))+'¬, '
        +'¬newopd¬ : ¬'+%trim(%editc(NEWOPD:'Z'))+'¬, '
        +'¬sesg¬ : ¬'+%trim(WSESG)+'¬, '
        +'¬newsesg¬ : ¬'+%trim(NEWSESG)+'¬, '
        +'¬mode¬ : ¬'+%trim(WMODE)+'¬, '
        +'¬errMsg¬ : ¬'+%trim(Error)+'¬, '
        +'¬s0035¬ : ¬'+%trim(YS0035)+'¬, ';
      /end-free
      * JSONfix escaper " i tekst,  for deretter å bytte ¬->"
     c                   call      'JSONFIX'
     c                   parm                    JSONstring
     C                   callp     updHTMLvar('JSONstring':JSONstring)
     C                   callp     wrtsection('JSONlin')
      *
      * ............................................................................................
      * Skriv JSON-LISTE Start (en liste er EN parameter(fra [ til   )
      * ............................................................................................
     c                   eval      JSONstring ='"orderupdate" : ['
     C                   callp     updHTMLvar('JSONstring':JSONstring)
     C                   callp     wrtsection('JSONlin')
      * ............................................................................................
      * Skriv JSON-Liste/Array  Avslutning
      * ............................................................................................
     c                   eval      JSONstring =']'
     C                   callp     updHTMLvar('JSONstring':JSONstring)
     C                   callp     wrtsection('JSONlin')
      * ............................................................................................
      * Skriv JSON-string Avsluttning
      * ............................................................................................
     c                   eval      JSONstring ='}'
     C                   callp     updHTMLvar('JSONstring':JSONstring)
     C                   callp     wrtsection('JSONlin')
      *
      * Quit
     C                   exsr      Exit


      *=====================================================================
      * Close output html and quit
      *=====================================================================
     C     Exit          begsr
      * Lukk fil
     C                   CLOSE     BRIDF
     C  N50              CLOSE     SAEH
     C  N50              CLOSE     SAEH1
     C  N50              CLOSE     SAEHTL
     C  N50              CLOSE     SAEV
     C  N50              CLOSE     STANDE
     C  N50              CLOSE     KODTSI
     C  N50              CLOSE     KODTSI1
     C  N50              CLOSE     HEADF
     C  N50              CLOSE     CUNDL01
     C  N50              CLOSE     FIRM
     C  N50              CLOSE     EDIC
     C  N50              CLOSE     EDIM1
     C  N50              CLOSE     EDIM2
     C  N50              CLOSE     EDIM4
     C  N50              CLOSE     FRISOK
     C  N50              CLOSE     FRISOL01
     C  N50              CLOSE     TVIND
     C  N50              CLOSE     KODTA
     C  N50              CLOSE     KODTLB

      * Do not delete the call to wrtsection with section name *fini.  It is needed
      * to ensure that all output html that has been buffered gets output.
     C                   callp     wrtsection('*fini')
      * Quit
     C                   MOVE      *ON           *INLR
     C                   return
     C                   endsr
      *
      *********************************************************
     C     Parse         Begsr
      *********************************************************
      * Get input
     C                   EVAL      WSUSER  = zhbgetvar('USER')
     C                   EVAL      SEAVDA = zhbgetvar('AVD')
     C                   EVAL      SEAVD  = c2n2(SEAVDA)
     C                   EVAL      NEWSYAVA = zhbgetvar('NEWAVD')
     C                   EVAL      NEWAVD  = c2n2(NEWSYAVA)
     C                   EVAL      SETDNA = zhbgetvar('OPD')
     C                   EVAL      SETDN  = c2n2(SETDNA)
     C                   EVAL      WMODE  = zhbgetvar('MODE')
     C                   EVAL      XREF       = zhbgetvar('H_XREF')
     C                   EVAL      SEST   = zhbgetvar('SEST')
     C                   EVAL      SEUR   = zhbgetvar('SEUR')
     C                   EVAL      SEDTY  = zhbgetvar('SEDTY')
     C                   EVAL      WA     = zhbgetvar('SEDP')
     C                   EVAL      SEDP   = c2n2(WA)
     C                   EVAL      WA     = zhbgetvar('SEKNS')
     C                   EVAL      SEKNS  = c2n2(WA)
     C                   EVAL      SENAS  = zhbgetvar('SENAS')
     C                   EVAL      SEADS1 = zhbgetvar('SEADS1')
     C                   EVAL      SEADS2 = zhbgetvar('SEADS2')
     C                   EVAL      SEADS3 = zhbgetvar('SEADS3')
     C                   EVAL      WA     = zhbgetvar('SENTK')
     C                   EVAL      SENTK  = c2n2(WA)
     C                   EVAL      WA     = zhbgetvar('SEVKB')
     C                   EVAL      SEVKB  = c2n2(WA)
     C                   EVAL      SEKDC  = zhbgetvar('SEKDC')
     C                   EVAL      WSESG   = zhbgetvar('SESG')
     C                   EVAL      NEWSESG      = zhbgetvar('NEWSESG')
     C                   EVAL      WA     = zhbgetvar('SEKNK')
     C                   EVAL      SEKNK  = c2n2(WA)
     C                   EVAL      SERG   = zhbgetvar('SERG')
     C                   EVAL      SENAK  = zhbgetvar('SENAK')
     C                   EVAL      SEADK1 = zhbgetvar('SEADK1')
     C                   EVAL      SEADK2 = zhbgetvar('SEADK2')
     C                   EVAL      SEADK3 = zhbgetvar('SEADK3')
     C                   EVAL      SELKA  = zhbgetvar('SELKA')
     C                   EVAL      SETLF  = zhbgetvar('SETLF')
     C                   EVAL      SENAD  = zhbgetvar('SENAD')
     C                   EVAL      SELV   = zhbgetvar('SELV')
     C                   EVAL      SELVT  = zhbgetvar('SELVT')
     C                   EVAL      SETRID = zhbgetvar('SETRID')
     C                   EVAL      SELKT  = zhbgetvar('SELKT')
     C                   EVAL      SEVAL1 = zhbgetvar('SEVAL1')
     C                   EVAL      WA     = zhbgetvar('SEBEL1')
     C                   EVAL      SEBEL1 = c2n2(WA)
     C                   EVAL      WA     = zhbgetvar('SEVKU')
     C                   EVAL      SEVKU  = c2n2(WA)
     C                   EVAL      WA     = zhbgetvar('SEKDH')
     C                   EVAL      SEKDH  = c2n2(WA)
     C                   EVAL      WA     = zhbgetvar('SETST')
     C                   EVAL      SETST  = c2n2(WA)
     C                   EVAL      WA     = zhbgetvar('SEBEL2')
     C                   EVAL      SEBEL2 = c2n2(WA)
     C                   EVAL      SEFTG2 = zhbgetvar('SEFTG2')
     C                   EVAL      WA     = zhbgetvar('SETRM')
     C                   EVAL      SETRM  = c2n2(WA)
     C                   EVAL      SEFIF  = zhbgetvar('SEFIF')
     C                   EVAL      WA     = zhbgetvar('SEFID')
     C                   EVAL      SEFID  = c2n2(WA)
     C                   EVAL      WA     = zhbgetvar('SEKTA')
     C                   EVAL      SEKTA  = c2n2(WA)
     C                   EVAL      WA     = zhbgetvar('SEKTB')
     C                   EVAL      SEKTB  = c2n2(WA)
     C                   EVAL      SEGN   = zhbgetvar('SEGN')
     C                   EVAL      SEFT1  = zhbgetvar('SEFT1')
     C                   EVAL      SEFT2  = zhbgetvar('SEFT2')
     C                   EVAL      SEFT3  = zhbgetvar('SEFT3')
     C                   EVAL      SEDST  = zhbgetvar('SEDST')
     C                   EVAL      SEDTG  = zhbgetvar('SEDTG')
     C                   EVAL      SETLL  = zhbgetvar('SETLL')
     C                   EVAL      SETLE  = zhbgetvar('SETLE')
     C                   EVAL      SESKI  = zhbgetvar('SESKI')
     C                   EVAL      SELS   = zhbgetvar('SELS')
     C                   EVAL      SEKDLS = zhbgetvar('SEKDLS')
N01  C                   EVAL      WA     = zhbgetvar('SEDT')
     C                   EVAL      SEDT   = c2n2(WA)
     C                   EVAL      SELV2  = zhbgetvar('SELV2')
     C                   EVAL      SEKDDK = zhbgetvar('SEKDDK')
     C                   EVAL      WA     = zhbgetvar('SEGKD')
     C                   EVAL      SEGKD  = c2n2(WA)
     C                   EVAL      SEGFT1 = zhbgetvar('SEGFT1')
     C                   EVAL      SEGFT2 = zhbgetvar('SEGFT2')
     C                   EVAL      SEPOS  = zhbgetvar('SEPOS')
     C                   EVAL      SEFTB  = zhbgetvar('SEFTB')
     C                   EVAL      SELKB  = zhbgetvar('SELKB')
     C                   EVAL      SEFTM  = zhbgetvar('SEFTM')
     C                   EVAL      SELKM  = zhbgetvar('SELKM')
     C                   EVAL      SEKDFT = zhbgetvar('SEKDFT')
     C                   EVAL      SETARF = zhbgetvar('SETARF')
     C                   EVAL      SELKAT = zhbgetvar('SELKAT')
     C                   EVAL      SEVAL2 = zhbgetvar('SEVAL2')
     C                   EVAL      WA     = zhbgetvar('SEBEL3')
     C                   EVAL      SEBEL3 = c2n2(WA)
     C                   EVAL      SEWS   = zhbgetvar('SEWS')
     C                   EVAL      SEMF   = zhbgetvar('SEMF')
     C                   EVAL      WA     = zhbgetvar('SEMP')
     C                   EVAL      SEMP   = c2n2(WA)
     C                   EVAL      WA     = zhbgetvar('SEDTO')
     C                   EVAL      SEDTØ  = c2n2(WA)
     C                   EVAL      WA     = zhbgetvar('SEBELD')
     C                   EVAL      SEBELD = c2n2(WA)
     C                   EVAL      SEPKL  = zhbgetvar('SEPKL')
     C                   EVAL      SEKDV  = zhbgetvar('SEKDV')
     C                   EVAL      SE0035 = zhbgetvar('SE0035')
     C                   EVAL      WA     = zhbgetvar('SE3039')
     C                   EVAL      SE3039 = c2n2(WA)
     C                   EVAL      SEMI   = zhbgetvar('SEMI')
     C                   EVAL      SEKTC  = zhbgetvar('SEKTC')
     C                   EVAL      SESAM  = zhbgetvar('SESAM')
     C                   EVAL      WA     = zhbgetvar('SEFVK')
     C                   EVAL      SEFVK  = c2n2(WA)
     C                   ENDSR
      *********************************************************
     C     INIT          Begsr
      *********************************************************
     C                   OPEN      BRIDF
      * Test innlogging
     C     WSUSER        CHAIN     BRIDF                              50
     C     BILIBL        ifeq      *blanks
     C                   callb     'INCGI'
     C                   parm                    BISTDL
     C                   else
     C                   call      BILIBL
     C                   end
      *
     C     SAEHKey       klist
     C                   kfld                    SEAVD
     C                   kfld                    SETDN
     C     CUNDL01K      KLIST
     C                   KFLD                    FIFIRM
     C                   KFLD                    KUNDNR
     C     FRIKEY        klist
     C                   kfld                    SEAVD
     C                   kfld                    SETDN
     C                   KFLD                    WFSKODE           3
     C     FRIKEY01      KLIST
     C                   KFLD                    WFSKODE
     C                   KFLD                    XREF
     C     KODTSIKEY     KLIST
     C                   KFLD                    WKSIUNI
     C                   KFLD                    XSESG
     C     KODTAK        KLIST
     C                   KFLD                    KOAUNI
     C                   KFLD                    SEAVD
     C     KODTLBK       KLIST
     C                   KFLD                    KLBUNI
     C                   KFLD                    XSELV
     C     MAKDCK        KLIST
     C                   KFLD                    XSR1
     C                   KFLD                    SEAVD
     C                   KFLD                    SETDN
     C                   KFLD                    MAX0B
     C                   KFLD                    MAX0C
     C                   KFLD                    MAX0D
     C     MAKD2K        KLIST
     C                   KFLD                    XSR1
     C                   KFLD                    SEAVD
     C                   KFLD                    SETDN
     C     M2KDCK        KLIST
     C                   KFLD                    SEAVD
     C                   KFLD                    SETDN
     C                   KFLD                    MAX0B
     C                   KFLD                    MAX0C
     C                   KFLD                    MAX0D
     C     M2KD2K        KLIST
     C                   KFLD                    SEAVD
     C                   KFLD                    SETDN
     C     TVIM1K        KLIST
     C                   KFLD                    X1STA
     C                   KFLD                    SEAVD
     C                   KFLD                    SETDN
     C                   MOVE      'A'           KOAUNI
     C                   MOVE      'LB'          KLBUNI
     C                   EVAL      WFSKODE='*CE'
     C     *LIKE         DEFINE    KSIUNI        WKSIUNI
     C     *LIKE         DEFINE    MSR           XSR1
     C     *LIKE         DEFINE    M0068A        MAX0B
     C     *LIKE         DEFINE    M0068B        MAX0C
     C     *LIKE         DEFINE    M0068C        MAX0D
     C     *LIKE         DEFINE    MST           X1STA
     C                   EVAL      WKSIUNI='SI'
     C                   MOVE      'R'           XSR1
     C                   MOVE      '99999999'    MAX0B
     C                   MOVE      '999999'      MAX0C
     C                   MOVE      '99'          MAX0D
      *
     C   50              eval      Error = 'Invalid userID'
     C  N50              OPEN      SAEH
     C  N50              OPEN      SAEH1
     C  N50              OPEN      SAEHTL
     C  N50              OPEN      SAEV
     C  N50              OPEN      STANDE
     C  N50              OPEN      KODTSI
     C  N50              OPEN      KODTSI1
     C  N50              OPEN      HEADF
     C  N50              OPEN      CUNDL01
     C  N50              OPEN      FIRM
     C  N50              OPEN      EDIC
     C  N50              OPEN      EDIM1
     C  N50              OPEN      EDIM2
     C  N50              OPEN      EDIM4
     C  N50              OPEN      FRISOK
     C  N50              OPEN      FRISOL01
     C  N50              OPEN      TVIND
     C  N50              OPEN      KODTA
     C  N50              OPEN      KODTLB
      *_________________________________
      * Hæmta dagens datum och klockslag
      *"""""""""""""""""""""""""""""""""
     C                   CALL      'SYGE15C'
     C                   PARM                    WDT               8
     C                   PARM                    WTM               6
      * Hæmta firmaopplysninger
     C                   READ      FIRM
      * DUMMY READ AV SAEH1
     C     *IN50         IFEQ      *OFF
     C     *IN50         ANDEQ     *ON
     C                   READ      SAEH1
     C                   ENDIF
      * MODE=GS
     C     WMODE         IFEQ      'GS'
     C     XREF          ANDNE     *BLANKS
     C     *IN50         ANDEQ     *OFF
     C     FRIKEY01      CHAIN     FRISOL01                           56
     C                   IF        *IN56=*OFF
     C                   EVAL      SEAVD=FSAVD
     C                   EVAL      SETDN=FSOPD
     C                   ENDIF
     C                   ENDIF

     c                   endsr
      *
      *______________________________________________________
      * TEST                                             TEST
      *""""""""""""""""""""""""""""""""""""""""""""""""""""""
     C     TEST          BEGSR
      * Hæmta userid
     C     WSUSER        CHAIN     KODTSI1
      * Hæmta ærende
     C     WMODE         IFNE      'A'
     C     SAEHKey       CHAIN     SAEH                               55
     C                   ENDIF
      * MODE A=Add  D=Delete  U=Update  S=Skicka  C=Copy  GS=Hæmta från SYSPED
     C                   SELECT
     C     WMODE         WHENEQ    'A'
     C                   eval      Error = *blanks
     C                   EXSR      SRA
     C     WMODE         WHENEQ    'GS'
     C                   eval      Error = *blanks
     C  N55              eval      Error = 'Fel, finns redan'
     C   55              EXSR      SRGS
     C     WMODE         WHENEQ    'C'
     C                   IF        *IN55=*ON
     C                   eval      Error = 'Order not found'
     C                   ELSE
     C                   UPDATE    SAEHR
     C                   eval      Error = *blanks
     C                   EXSR      SRC
     C                   ENDIF
     C     WMODE         WHENEQ    'D'
     C                   IF        *IN55=*ON
     C                   eval      Error = 'Order not found'
     C                   ELSE
     C                   eval      Error = *blanks
     C                   EXSR      SRD
     C                   ENDIF
     C     WMODE         WHENEQ    'S'
     C                   IF        *IN55=*ON
     C                   eval      Error = 'Order not found'
     C                   ELSE
     C                   eval      Error = *blanks
     C                   EXSR      SRS
     C                   ENDIF
     C     WMODE         WHENEQ    'U'
     C                   IF        *IN55=*ON
     C                   eval      Error = 'Order not found'
     C                   ELSE
     C                   eval      Error = *blanks
     C                   EXSR      SRU
     C                   ENDIF
     C                   OTHER
     C                   eval      Error = 'Wrong mode'
     C                   ENDSL
     C                   ENDSR
      *______________________________________________________
      * Add                                               SRA
      *""""""""""""""""""""""""""""""""""""""""""""""""""""""
     C     SRA           BEGSR
     C                   CLEAR                   SAEHR
     C                   CLEAR                   SAEHTLR
      * Hæmta uppdragsnummer
     C     SEAVD         CHAIN     STANDE                             52
     C                   EVAL      XSETDN=YSETDN
     C                   ADD       1             YSETDN
     C                   UPDATE    STANDER
     C                   EVAL      XSEAVD=SEAVD
     C                   EVAL      SETDN=XSETDN
     C                   EVAL      XSESG=WSESG
     C                   MOVEL     WDT           XSEDT
     C                   EVAL      XSESAM='J'
     C                   EVAL      XSEFVK=0.9
     C                   EVAL      Xsedty  = Ysedty
     C                   EVAL      Xsedp   = Ysedp
     C                   EVAL      Xsekdc  = Ysekdc
     C                   EVAL      Xselka  = Yselka
     C                   EVAL      Xsetlf  = Ysetlf
     C                   EVAL      Xsenad  = Ysenad
     C                   EVAL      Xsetrid = Ysetrid
     C                   EVAL      Xseval1 = Yseval1
     C                   EVAL      Xsebel1 = Ysebel1
     C                   EVAL      Xsevku  = Ysevku
     C                   EVAL      Xsekdh  = Ysekdh
     C                   EVAL      Xsetst  = Ysetst
     C                   EVAL      Xsebel1 = Ysebel1
     C                   EVAL      Xseftg2 = Yseftg2
     C                   EVAL      Xsefif  = Ysefif
     C                   EVAL      Xsefid  = Ysefid
     C                   EVAL      Xsegn   = Ysegn
     C                   EVAL      Xseft1  = Yseft1
     C                   EVAL      Xseft2  = Yseft2
     C                   EVAL      Xseft3  = Yseft3
     C                   EVAL      Xsedst  = Ysedst
     C                   EVAL      Xsedtg  = Ysedtg
     C                   EVAL      Xsetll  = Ysetll
     C                   EVAL      Xsetle  = Ysetle
     C                   EVAL      Xseski  = Yseski
     C                   EVAL      Xsels   = Ysels
     C                   EVAL      Xsekdls = Ysekdls
     C                   EVAL      Xsedt   = Ysedt
     C                   EVAL      Xselv2  = Yselv2
     C                   EVAL      Xsekddk = Ysekddk
     C                   EVAL      Xsegkd  = Ysegkd
     C                   EVAL      Xsegft1 = Ysegft1
     C                   EVAL      Xsegft2 = Ysegft2
     C                   EVAL      Xsepos  = Ysepos
     C                   EVAL      Xseftb  = Yseftb
     C                   EVAL      Xselkb  = Yselkb
     C                   EVAL      Xseftm  = Yseftm
     C                   EVAL      Xselkm  = Yselkm
     C                   EVAL      Xsekdft = Ysekdft
     C                   EVAL      Xselkat = Yselkat
     C                   EVAL      Xseval2 = Yseval2
     C                   EVAL      Xsebel3 = Ysebel3
     C                   EVAL      XsE0035  = Ys0035
      * Write
     C                   WRITE     SAEHR
     C                   WRITE     SAEHTLR
     C                   ENDSR
      *______________________________________________________
      * Delete                                            SRD
      *""""""""""""""""""""""""""""""""""""""""""""""""""""""
     C     SRD           BEGSR
     C                   EVAL      XSEST='D '
     C                   UPDATE    SAEHR
     C                   ENDSR
      *______________________________________________________
      * Skicka                                            SRS
      *""""""""""""""""""""""""""""""""""""""""""""""""""""""
     C     SRS           BEGSR
     C                   eval      Error = *blanks
      * Ændra status
     C                   EVAL      XSEST='A'
     C                   UPDATE    SAEHR
      * Hent avdelingsopplysninger
     C     KODTAK        CHAIN     KODTA
      * Hent foretaksnummer
     C                   MOVE      KOAKNR        KUNDNR
     C     CUNDL01K      CHAIN     CUNDL01                            35
     C   35              EVAL      SYFORE=*BLANKS
      * Skriv til EDIM
     C     SEAVD         CHAIN     STANDE                             52
     C                   EXSR      FINMTY
     C                   EXSR      KOMLIN
     C                   ENDSR
      *______________________________________________________
      * Update                                            SRU
      *""""""""""""""""""""""""""""""""""""""""""""""""""""""
     C     SRU           BEGSR
     C                   EVAL      XSEST   = SEST
     C                   EVAL      XSEUR   = SEUR
     C                   EVAL      XSEDTY  = SEDTY
     C                   EVAL      XSEDP   = SEDP
     C                   EVAL      XSEKNS  = SEKNS
     C                   EVAL      XSENAS  = SENAS
     C                   EVAL      XSEADS1 = SEADS1
     C                   EVAL      XSEADS2 = SEADS2
     C                   EVAL      XSEADS3 = SEADS3
     C                   EVAL      XSENTK  = SENTK
     C                   EVAL      XSEVKB  = SEVKB
     C                   EVAL      XSEKDC  = SEKDC
     C*                  EVAL      XSESG   = SESG
     C                   EVAL      XSEKNK  = SEKNK
     C                   EVAL      XSERG   = SERG
     C                   EVAL      XSENAK  = SENAK
     C                   EVAL      XSEADK1 = SEADK1
     C                   EVAL      XSEADK2 = SEADK2
     C                   EVAL      XSEADK3 = SEADK3
     C                   EVAL      XSELKA  = SELKA
     C                   EVAL      XSETLF  = SETLF
     C                   EVAL      XSENAD  = SENAD
     C                   EVAL      XSELV   = SELV
     C                   EVAL      XSELVT  = SELVT
     C                   EVAL      XSETRID = SETRID
     C                   EVAL      XSELKT  = SELKT
     C                   EVAL      XSEVAL1 = SEVAL1
     C                   EVAL      XSEBEL1 = SEBEL1
     C                   EVAL      XSEVKU  = SEVKU
     C                   EVAL      XSEKDH  = SEKDH
     C                   EVAL      XSETST  = SETST
     C                   EVAL      XSEBEL2 = SEBEL2
     C                   EVAL      XSEFTG2 = SEFTG2
     C                   EVAL      XSETRM  = SETRM
     C                   EVAL      XSEFIF  = SEFIF
     C                   EVAL      XSEFID  = SEFID
     C                   EVAL      XSEKTA  = SEKTA
     C                   EVAL      XSEKTB  = SEKTB
     C                   EVAL      XSEGN   = SEGN
     C                   EVAL      XSEFT1  = SEFT1
     C                   EVAL      XSEFT2  = SEFT2
     C                   EVAL      XSEFT3  = SEFT3
     C                   EVAL      XSEDST  = SEDST
     C                   EVAL      XSEDTG  = SEDTG
     C                   EVAL      XSETLL  = SETLL
     C                   EVAL      XSETLE  = SETLE
     C                   EVAL      XSESKI  = SESKI
     C                   EVAL      XSELS   = SELS
     C                   EVAL      XSEKDLS = SEKDLS
N01  C                   EVAL      XSEDT   = SEDT
     C                   EVAL      XSELV2  = SELV2
     C                   EVAL      XSEKDDK = SEKDDK
     C                   EVAL      XSEGKD  = SEGKD
     C                   EVAL      XSEGFT1 = SEGFT1
     C                   EVAL      XSEGFT2 = SEGFT2
     C                   EVAL      XSEPOS  = SEPOS
     C                   EVAL      XSEFTB  = SEFTB
     C                   EVAL      XSELKB  = SELKB
     C                   EVAL      XSEFTM  = SEFTM
     C                   EVAL      XSELKM  = SELKM
     C                   EVAL      XSEKDFT = SEKDFT
     C                   EVAL      XSETARF = SETARF
     C                   IF        XSETARF = *BLANKS
     C     KODTSIKEY     CHAIN     KODTSI                             56
     C  N56              EVAL      XSETARF = KSINAV
     C                   ENDIF
     C                   EVAL      XSELKAT = SELKAT
     C                   EVAL      XSEVAL2 = SEVAL2
     C                   EVAL      XSEBEL3 = SEBEL3
     C                   EVAL      XSEWS   = SEWS
     C                   EVAL      XSEMF   = SEMF
     C                   EVAL      XSEMP   = SEMP
     C                   EVAL      XSEDTØ  = SEDTØ
     C                   EVAL      XSEBELD = SEBELD
     C                   EVAL      XSEPKL  = SEPKL
     C                   EVAL      XSEKDV  = SEKDV
     C                   EVAL      XSE0035 = SE0035
     C                   EVAL      XSE3039 = SE3039
     C                   EVAL      XSEMI   = SEMI
     C                   EVAL      XSEKTC  = SEKTC
     C                   UPDATE    SAEHR
      * Oppdater arbetsfil
     C     SAEHKey       CHAIN     SAEHTL                             56
     C                   IF        *IN56
     C                   EVAL      XSESAM=SESAM
     C                   EVAL      XSEFVK=SEFVK
     C                   WRITE     SAEHTLR
     C                   ELSE
     C                   EVAL      XSESAM=SESAM
     C                   EVAL      XSEFVK=SEFVK
     C                   UPDATE    SAEHTLR
     C                   ENDIF
      * Legg ut frie søkeveier
     C     FRIKEY        DELETE    FRISOK                             56
     C     XREF          IFNE      *BLANKS
     C                   CLEAR                   FRISOKR
     C                   EVAL      FSAVD=SEAVD
     C                   EVAL      FSOPD=SETDN
     C                   EVAL      FSKODE='*CE'
     C                   EVAL      FSSOK=XREF
     C                   MOVE      WDT           FSDTOP
     C                   WRITE     FRISOKR
     C                   ENDIF
     C                   ENDSR
      *______________________________________________________
      * Copy                                              SRC
      *""""""""""""""""""""""""""""""""""""""""""""""""""""""
     C     SRC           BEGSR
     C                   EVAL      WSESG=SESG
      * Hæmta uppdragsnummer
     C     NEWAVD        CHAIN     STANDE                             52
     C                   EVAL      XSETDN=YSETDN
     C                   ADD       1             YSETDN
     C                   UPDATE    STANDER
     C                   EVAL      XSEAVD=NEWAVD
     C                   EVAL      NEWOPD=XSETDN
     C                   EVAL      XSESG=NEWSESG
     C                   MOVEL     WDT           XSEDT
     C                   EVAL      XSEST=*BLANKS
      * Write
     C                   WRITE     SAEHR
      * Oppdater arbetsfil
     C                   EVAL      XSESAM='J'
     C                   EVAL      XSEFVK=0.9
     C                   WRITE     SAEHTLR
      * Kopiera också varuposter
     C                   EVAL      *IN52=*OFF
     C     SAEHKey       SETLL     SAEV
     C     SAEHKey       READE     SAEV                                   52
     C     *IN52         DOWEQ     *OFF

     C                   EVAL      SVAVD=NEWAVD
     C                   EVAL      SVTDN=NEWOPD
     C                   WRITE     SAEVR

     C     SAEHKey       READE     SAEV                                   52
     C                   ENDDO
     C                   ENDSR
      *______________________________________________________
      * Hæmta från SYSPED op                             SRGS
      *""""""""""""""""""""""""""""""""""""""""""""""""""""""
     C     SRGS          BEGSR
      * Finnes SYSPED Oppdrag ?
     C     SAEHKey       CHAIN(N)  HEADF                              54
      * Fel, finns inte i sysped uppdrag
     C                   IF        *IN54
     C                   eval      Error = 'Order not found'
     C                   GOTO      SRGS9
     C                   ENDIF
      * Skapa gemensam information
     C     SEAVD         CHAIN(N)  STANDE                             52
     C                   EVAL      Xsedty  = Ysedty
     C                   EVAL      Xsedp   = Ysedp
     C                   EVAL      Xsekdc  = Ysekdc
     C                   EVAL      Xselka  = Yselka
     C                   EVAL      Xsetlf  = Ysetlf
     C                   EVAL      Xsenad  = Ysenad
     C                   EVAL      Xsetrid = Ysetrid
     C                   EVAL      Xseval1 = Yseval1
     C                   EVAL      Xsebel1 = Ysebel1
     C                   EVAL      Xsevku  = Ysevku
     C                   EVAL      Xsekdh  = Ysekdh
     C                   EVAL      Xsetst  = Ysetst
     C                   EVAL      Xsebel1 = Ysebel1
     C                   EVAL      Xseftg2 = Yseftg2
     C                   EVAL      Xsefif  = Ysefif
     C                   EVAL      Xsefid  = Ysefid
     C                   EVAL      Xsegn   = Ysegn
     C                   EVAL      Xseft1  = Yseft1
     C                   EVAL      Xseft2  = Yseft2
     C                   EVAL      Xseft3  = Yseft3
     C                   EVAL      Xsedst  = Ysedst
     C                   EVAL      Xsedtg  = Ysedtg
     C                   EVAL      Xsetll  = Ysetll
     C                   EVAL      Xsetle  = Ysetle
     C                   EVAL      Xseski  = Yseski
     C                   EVAL      Xsels   = Ysels
     C                   EVAL      Xsekdls = Ysekdls
     C                   EVAL      Xsedt   = Ysedt
     C                   EVAL      Xselv2  = Yselv2
     C                   EVAL      Xsekddk = Ysekddk
     C                   EVAL      Xsegkd  = Ysegkd
     C                   EVAL      Xsegft1 = Ysegft1
     C                   EVAL      Xsegft2 = Ysegft2
     C                   EVAL      Xsepos  = Ysepos
     C                   EVAL      Xseftb  = Yseftb
     C                   EVAL      Xselkb  = Yselkb
     C                   EVAL      Xseftm  = Yseftm
     C                   EVAL      Xselkm  = Yselkm
     C                   EVAL      Xsekdft = Ysekdft
     C                   EVAL      Xselkat = Yselkat
     C                   EVAL      Xseval2 = Yseval2
     C                   EVAL      Xsebel3 = Ysebel3
     C                   EVAL      XsE0035  = Ys0035
     C                   EVAL      XSEAVD=SEAVD
     C                   EVAL      XSETDN=SETDN
     C                   EVAL      XSESG=WSESG
     C                   MOVEL     WDT           XSEDT

      * Hæmta från SYSPED oppdrag
     C                   EXSR      SRGSO
      * Write
     C                   WRITE     SAEHR
      * Oppdater arbetsfil
     C                   EVAL      XSESAM='J'
     C                   EVAL      XSEFVK=0.9
     C                   WRITE     SAEHTLR
     C     SRGS9         ENDSR
      *______________________________________________________
      * Hæmta från SYSPED Oppdrag                       SRGSO
      *""""""""""""""""""""""""""""""""""""""""""""""""""""""
     C     SRGSO         BEGSR
     C                   EVAL      XSEKNS=HEKNK
     C                   EVAL      XSENAS=HENAK
     C                   EVAL      XSEADS1=HEADK1
     C                   EVAL      XSEADS2=HEADK2
     C                   EVAL      XSEADS3=HEADK3
      * Spesial kingsrød, hent avs. oppl fra kundereg uansett
     C     XSEKNS        IFNE      0
     C                   MOVE      XSEKNS        KUNDNR
     C     CUNDL01K      CHAIN     CUNDL01                            35
     C                   IF        *IN35=*OFF
     C                   EVAL      XSENAS = KNAVN
     C                   EVAL      XSEADS1 = ADR1
     C                   EVAL      XSEADS2 = ADR2
     C                   IF        POSTNR = 0

     C                   EVAL      XSEADS3 = ADR3

     C                   ELSE
     C                   MOVEL     POSTNR        XSEADS3
     C                   MOVE      ADR3          XSEADS3
     C                   ENDIF
     C                   ENDIF
     C                   ENDIF

     C                   EVAL      XSEKNK=HEKNS
     C                   EVAL      XSENAK=HENAS
     C                   EVAL      XSEADK1=HEADS1
     C                   EVAL      XSEADK2=HEADS2
     C                   EVAL      XSEADK3=HEADS3
     C                   EVAL      XSELKT=HELKA
     C                   EVAL      XSENTK=HENT
     C                   EVAL      XSETRM=30
     C                   EVAL      XSELKT=HETRI
     C                   EVAL      XSELV=HEFR
     C                   EVAL      XSEVKB=HEVKT
     C                   MOVEL     HEGN          XSEGN
     C                   MOVEL     HEHAWB        XSETRID
     C                   EVAL      XSELKA='NO'
     C                   EVAL      XSELKB=HELKA
     C                   EVAL      XSEPOS=HEPOS1
     C                   EVAL      XSELV=HEFR
     C     KODTLBK       CHAIN     KODTLB                             40
     C  N40              EVAL      XSELV=KLBKT
     C                   IF        %SUBST(KLBXXX:1:1)='A'
     C     XSEADK3       IFNE      *BLANKS
     C                   MOVEL     XSEADK3       XSELVT
     C                   ELSE
     C     XSEADK2       IFNE      *BLANKS
     C                   MOVEL     XSEADK3       XSELVT
     C                   ELSE
     C                   MOVEL     XSEADK1       XSELVT
     C                   ENDIF
     C                   ENDIF
     C                   ELSE
     C     XSEADS3       IFNE      *BLANKS
     C                   MOVEL     XSEADS3       XSELVT
     C                   ELSE
     C     XSEADS2       IFNE      *BLANKS
     C                   MOVEL     XSEADS2       XSELVT
     C                   ELSE
     C                   MOVEL     XSEADS1       XSELVT
     C                   ENDIF
     C                   ENDIF
     C                   ENDIF
      * hæmta kundinfo
     C     XSEKNK        IFNE      0
     C                   MOVE      XSEKNK        KUNDNR
     C     CUNDL01K      CHAIN     CUNDL01                            40
     C                   IF        *IN40=*OFF
     C     XSERG         IFEQ      *BLANKS
     C     SYFORE        IFGT      *ZEROS
     C                   EVAL      SERG=*BLANKS
     C                   MOVEL     SYFORE        XSERG
     C                   ENDIF
     C                   MOVEL     SYKONT        XSEKTA
     C                   MOVE      SYKONT        XSEKTB
     C                   MOVE      SYFR02        XSEKTC
     C                   ENDIF
      * Spesial for Kingrød, hent mott.oppl fra kundereg uansett
     C                   MOVE      KNAVN         XSENAK
     C                   MOVE      ADR1          XSEADK1
     C                   MOVE      ADR2          XSEADK2
     C                   MOVE      *BLANKS       XSEADK3
     C     POSTNR        IFEQ      0
     C                   MOVEL     ADR3          XSEADK3
     C                   ELSE
     C                   MOVEL     POSTNR        XSEADK3
     C                   MOVE      ADR3          XSEADK3
     C                   ENDIF

     C                   ENDIF
     C                   ENDIF
     C                   ENDSR
      *_____________________________________________________
      *                                               KOMLIN
      *"""""""""""""""""""""""""""""""""""""""""""""""""""""
     C     KOMLIN        BEGSR
     C     MAKDCK        SETLL     EDIM4                              31
     C                   MOVE      *ZEROS        Æ0068C            2 0
     C     STKL          TAG
     C     MAKD2K        READPE    EDIM4                                  31
     C  N31M0065         IFNE      'CUSDEC'                                     1<-B
     C     M0065         ANDNE     'CUSRES'
     C                   GOTO      STKL
     C                   END                                                    1<-E
     C  N31MST           IFEQ      'D'                                          1<-B
     C     M1001         OREQ      '929'
     C     M0068C        OREQ      0
     C                   GOTO      STKL
     C                   END                                                    1<-E
     C  N31Æ0068C        IFEQ      0                                            1<-B
     C                   MOVE      M0068C        Æ0068C
     C                   END                                                    1<-E
     C  N31M1N07         IFEQ      'DFI'                                        1<-B
     C     M1N07         OREQ      'DII'
     C     M1N07         OREQ      'DPU'
     C                   GOTO      STKL
     C                   END                                                    1<-E
     C  N31M1N07         IFEQ      'DIU'                                        1<-B
     C                   MOVE      '1'           *IN31
     C                   ELSE                                                   1
N02  C                   IF        MTDN < 0
N02  C     Æ0068C        ADD       2             M0068C
N02  C                   ELSE
     C     Æ0068C        ADD       1             M0068C
     C                   END                                                    1<-E
     C                   END                                                    1<-E
      * HENT NY DATO/SEKVENS/VERSJON
     C   31              DO
     C                   CALL      'SYGE15C'
     C                   PARM                    WDT               8
     C                   PARM                    WTM               6
     C                   MOVEL     WDT           M0068A
      * HENT SEKVENSNR.
     C     M0068A        CHAIN     TVIND                              32
     C   32              Z-ADD     M0068A        D0068A
     C   32              Z-ADD     0             D0068B
     C                   ADD       1             D0068B
     C   32              WRITE     TVINDF
     C  N32              UPDATE    TVINDF
     C                   MOVE      D0068B        M0068B
      * VERSJONSNR. SETTES LIK 1.
     C                   Z-ADD     1             M0068C
     C                   END

      * HENTE MELDINGSNR
     C     1             CHAIN     EDIC                               32
     C                   ADD       1             CMN
     C                   UPDATE    EDICR

     C                   MOVE      M0068A        X0068A
     C                   MOVE      M0068B        X0068B
     C                   MOVE      M0068C        X0068C

     C     TVIM1K        SETLL     EDIM1                              32
     C     STKL3         TAG
     C     TVIM1K        READE     EDIM1                                  32
     C  N32M0065         IFEQ      'CUSDEC'
     C     M1001         ANDEQ     '830'
     C                   DELETE    EDIMR
     C                   ELSE
     C                   UPDATE    EDIMR
     C                   GOTO      STKL3
     C                   END
     C                   EXSR      MOVKD2

     C                   WRITE     EDIMR
      *
     C                   MOVE      SEAVD         UAVD2             4 0
     C                   MOVE      SETDN         UTDN2             7 0
     C*                  CALL      'SAD061V'
     C*                  PARM                    UAVD2
     C*                  PARM                    UTDN2
      *
     C                   ENDSR
      *______________________________________________
      *                                        MOVKD2
      *""""""""""""""""""""""""""""""""""""""""""""""
     C     MOVKD2        BEGSR
     C                   EVAL      M0004=YS0004
     C                   EVAL      M0010=YS0010
     C                   EVAL      M0035=XSE0035
     C                   IF        XSE0035='2'
     C                   EVAL      M0010='NO000119    '
     C                   ENDIF
     C                   MOVEL     SEAVD         W0062            11
     C                   MOVE      SETDN         W0062
     C     W0062         CAT       XSESG:0       M0062
     C                   MOVE      'CUSDEC'      M0065
     C                   MOVE      X0068A        M0068A
     C                   MOVE      X0068B        M0068B
     C                   MOVE      X0068C        M0068C
     C                   MOVE      *BLANKS       M0068
     C                   MOVE      SYFORE        X0068Æ
     C                   MOVEL     XN068Å        M0068
     C                   MOVE      *ZEROS        M0068D
     C                   MOVE      *ZEROS        M0068E
     C                   MOVE      *ZEROS        M0068F
     C                   MOVE      '830'         M1001
     C                   MOVE      *BLANKS       M1004
     C                   EVAL      M1N07=W1N07
     C                   SELECT
     C     M1N07         WHENEQ    'DFU'
     C                   MOVEL     '9  '         M1225
     C     M1N07         WHENEQ    'DMA'
     C                   MOVEL     'ZZ '         M1225
     C     M1N07         WHENEQ    'DFO'
     C                   MOVEL     '14 '         M1225
     C     M1N07         WHENEQ    'DEN'
     C                   MOVEL     '2  '         M1225
     C     M1N07         WHENEQ    'DKO'
     C                   MOVEL     '14 '         M1225
N02  C     W1N07         WHENEQ    'DEB'
     C                   MOVEL     '18 '         M1225
N02  C     W1N07         WHENEQ    'DRE'
N02  C                   MOVEL     '19 '         M1225
N02  C     W1N07         WHENEQ    'DSO'
N02  C                   MOVEL     '43 '         M1225
     C                   ENDSL
     C                   MOVE      YS3039D       M3039D
     C                   MOVE      YS3039E       M3039E
     C                   MOVE      *ZEROS        M5004D
     C                   MOVE      *BLANKS       M1N08
      *SJEKK AT BEHANDLINGSPRIORITET ER INNENFOR INTERVALLET
     C                   MOVE      3             M9N01

     C                   MOVE      *ZEROS        MSN
     C                   Z-ADD     CMN           MMN
     C                   MOVE      'S'           MSR
     C                   MOVE      *BLANKS       MST
     C                   MOVEL     WDT           MDT
     C                   MOVEL     WTM           MTM
     C                   MOVE      SEAVD         MAVD
     C                   MOVE      SETDN         MTDN

     C                   ENDSR
      *_________________________________________________
      *                                           FINMTY
      *"""""""""""""""""""""""""""""""""""""""""""""""""
     C     FINMTY        BEGSR
     C                   MOVE      'N'           XBMI              1
     C                   MOVE      'N'           XINST             1
     C*                  Z-ADD     3             W9N01

      * FINNER SANSYNLIG MELDINGSTYPE UTFRA LOGGELEMENT

     C     M2KDCK        SETLL     EDIM2                              33
     C     STFMTY        TAG
     C     M2KD2K        READPE    EDIM2                                  33
     C  N33M1001         IFEQ      '929'                                        1<-B
     C     MST           OREQ      'D'
     C     MSR           OREQ      'S'
     C     M1N07         OREQ      'DFI'
     C     M1N07         OREQ      'DII'
     C     M1N07         OREQ      'DPU'
     C     M1N07         OREQ      'DKO'
     C     M0068C        OREQ      0
     C     M0068C        CABEQ     0             STFMTY
     C     MSR           IFEQ      'S'
     C     XINST         ANDEQ     'N'
     C     M1N07         IFEQ      'DMA'
     C     M1N07         OREQ      'DEN'
      * DENNE TOLLDEK. KAN VÆRE INNSTIKK HVIS MELDING FØR DENNE
      * ER EN 'DUA' FRA TOLLVESENET.
     C                   MOVE      'J'           XINST             1
     C                   END
     C                   END
     C                   GOTO      STFMTY
     C                   ELSE                                                   1
     C     M1N07         IFEQ      'DME'                                         2<-B
     C                   MOVE      'DKO'         W1N07             3
     C                   ELSE                                                    2
     C     M1N07         IFEQ      'DUA'                                          3<-B
     C     SEMI          IFEQ      'I'                                             4<-B
     C     XINST         OREQ      'J'
     C                   MOVE      'DEN'         W1N07
     C                   MOVE      'J'           XBMI
     C                   ELSE                                                      4
     C                   MOVE      'DKO'         W1N07
     C                   END                                                       4<-E
     C                   ELSE                                                     3
     C     M1N07         IFEQ      'DIU'                                           4<-B
     C                   MOVE      '1'           *IN33
     C                   MOVE      '1'           *IN99
     C                   ELSE                                                      4
     C                   MOVE      '1'           *IN33
     C                   END                                                       4<-E
     C                   END                                                      3<-E
     C                   END                                                     2<-E
     C                   END                                                    1<-E

     C   33              MOVE      'DFO'         W1N07
     C   33SEDP          IFEQ      10
     C                   MOVE      'DFU'         W1N07
     C                   ELSE
     C                   MOVE      'DMA'         W1N07
     C                   END
      *
     C                   ENDSR
