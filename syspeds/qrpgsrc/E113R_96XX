COLLI * COLLICARE - program ment for INNLand tatt ibruk til 'intern' IFCSUM mellom firma
COLLI * PR 04.04.2014 - innføre ny RFF-kode ZOP for å peke på edi-mottakers opprinnelige oppdrag
COLLI *             Før dette var peking til opprinnelig via  en 'skjør' logikk på RFF+CU
      *****************************************************************
      * MOTTAK AV IFCSUM FRA GEMSYS KUNDELØSNING                      *
      * LEGGES RETT I HEADF M.M. MEN MED DISP-STATUS "E"              *
      *****************************************************************
     H DATEDIT(*YMD)
     FSYPROD    IF   E           K DISK
     FEDIS      IF   E           K DISK
     FEDIM      IF   E           K DISK
     FEUNB      IF   E           K DISK
     FECMSG2    IF   E           K DISK
     FFIRM      IF   E           K DISK
     FETDT96A   IF   E           K DISK
     FERFF96A   IF   E           K DISK
     FECNI96A   IF   E           K DISK
     FENAD96A   IF   E           K DISK
     FETOD96A   IF   E           K DISK
     FEGID96A   IF   E           K DISK
     FEFTX96A   IF   E           K DISK
     FEMEA96A   IF   E           K DISK
     FEPCI96A   IF   E           K DISK
     FETSR96A   IF   E           K DISK
     FEEQD96A   IF   E           K DISK
     FEEQN96A   IF   E           K DISK
     FKODTRI    IF   E           K DISK
     FTELL      UF   E           K DISK
     FHEAD39    IF   E           K DISK
     F                                     RENAME(HEADFR:HEAD39R)
colliF*EADF     O  A E             DISK
colliF*ISP      O  A E             DISK
colliFHEADF     UF A E           K DISK
colliFDISP      UF A E           K DISK
colliFTRACKT    UF A E           K DISK
     FDOKUFM    O  A E             DISK
COLLIF*RISOK    O  A E             DISK
COLLIFFRISOL01  IF A E           K DISK
COLLIFKODFRI    IF   E           K DISK
COLLIFKODTS2    IF   E           K DISK
     FFREETXT   O  A E             DISK
     FDOK29     O  A E             DISK
     FTRACKF    O  A E             DISK
     FHENOP     UF A E           K DISK
     FHENOS01   UF   E           K DISK
     FHENOF01   UF   E           K DISK
     FKUNKO2    IF   E           K DISK
COLLIF*ENADSF    O  A E           K DISK
COLLIFTURER     UF A E           K DISK
COLLIFTELLRU    UF   E           K DISK
COLLIFUNITL01   IF   E           K DISK
ColliFKODTFR    IF   E           K DISK
     D A               S              1    DIM(79)
     D B               S              1    DIM(18)
ColliD UnikSn          S             35
COLLID                 DS
COLLID  M0004                  1     35
COLLID   CC_TST                1      3
COLLID                 DS
COLLID  M0010                  1     35
COLLID   MOTLK_EDI             4      5
COLLI * utgår pr 2014.0404 - kan slettes om litt
COLLID*                DS
COLLID* R1154                  1     35
COLLID*  R1154_1_4             1      4
COLLID*  R1154_5               5      5
COLLID*  R1154_6_12            6     12
COLLID                 DS
COLLID  XXREF35                1     35
COLLID   XXREFOT               1      3                                         OPD/TUR
COLLID   XXREFIE               5      7                                         IMP/EXP
COLLID   XXREFF                9     16                                         Orig XXREFF=Turnr
      *________________________
      * DS for decimal handling
      *""""""""""""""""""""""""
     D                 DS
     D  ZDEC                   1      7  6
     D  ZDEC6                  2      7
     D  ZHEL                  11     22  0
     D                 DS
     D  WMN2                   1      9  0
     D                 DS
     D  WPOS1                  1      3  0
     D  WPOS1A                 1      3
     D                 DS
     D  HSds                   1     30
     D  XXDATE                 1      8
     D  XXTIME                 9     14
     D                 DS
     D  XULTID                 1     14  0
     D  XULTM                  1      6  0
     D  XULDD                  7      8  0
     D  XULMM                  9     10  0
     D  XULÅÅ                 11     14  0
     D                 DS
     D  ULÅÅ                   1      4  0
     D  ULMM                   5      6  0
     D  ULDD                   7      8  0
     D  ULDT                   1      8  0
     D                 DS
     D  DSSOK                  1     15
     D  TILTX                  1      4
     D  DSTIL                  5      7
     D  FRATX                  8     11
     D  DSFRA                 12     14
      * Track/Trace-tekster
     D TTXED1          C                   CONST('Incoming EDI prepar-
     D                                     ed from sender      ')
      *
     D TTXED2          C                   CONST('Incoming EDI reciev-
     D                                     ed                  ')
      *
     D TTXSTR          C                   CONST('Order entered (proc-
     D                                     essed from EDI-data)')
      *
      * Tabell for konverter til store
BHR  DupNO             c                   'ABCDEFGHIJKLMNOPQRSTUVWXYZÆØÅ'
BHR  DlowNO            c                   'abcdefghijklmnopqrstuvwxyzæøå'
      */////////////
      * MAIN LOGIC /
      */////////////
      *___________
      * Initiering
      *"""""""""""
     C                   EXSR      INIT
     C                   MOVE      'N'           OPDMODE           1
      *________
      * CONVERT
      *""""""""
     C                   EXSR      RTVD
      *
     C                   MOVE      '1'           *INLR
      *
      *////////////////////////////////////////////////////////////
      *                                                      INIT /
      *////////////////////////////////////////////////////////////
     C     INIT          BEGSR
     C     KEYMS0        KLIST
     C                   KFLD                    ZMN
     C                   KFLD                    ZGN0
     C     KEYMS1        KLIST
     C                   KFLD                    ZMN
     C                   KFLD                    ZGN1
     C                   KFLD                    ZREPB0
     C     KEYMS2        KLIST
     C                   KFLD                    ZMN
     C                   KFLD                    ZGN2
     C                   KFLD                    ZREPC0
     C                   KFLD                    ZREPC1
     C     KUNKOK        KLIST
     C                   KFLD                    KUKUN1
     C                   KFLD                    KUINTN
      *
     C     *LIKE         DEFINE    NMN           ZMN
     C     *LIKE         DEFINE    NGN           ZGN0
     C     *LIKE         DEFINE    NGN           ZGN1
     C     *LIKE         DEFINE    NGN           ZGN2
     C     *LIKE         DEFINE    NREP0         ZREPB0
     C     *LIKE         DEFINE    NREP0         ZREPB0
     C     *LIKE         DEFINE    NREP0         ZREPC0
     C     *LIKE         DEFINE    NREP1         ZREPC1
     C     *LIKE         DEFINE    HEVKT         HXVKT
     C     *LIKE         DEFINE    HEFBV         HXFBV
     C     *LIKE         DEFINE    HEM3          HXM3
     C     *LIKE         DEFINE    HELM          HXLM
      * INIT WORKFIELDS
      *
     C     *ENTRY        PLIST
     C                   PARM                    WMN1              9
     C                   MOVEL     WMN1          WMN2
     C                   Z-ADD     WMN2          ZMN
      * Get msg and interchange values
     C     ZMN           CHAIN     EDIM                               51
     C     MSN           CHAIN     EDIS                               51
      *
     C     *LOVAL        SETLL     FIRM
     C                   READ      FIRM                                   33
      *
     C                   MOVE      'N'           PALLJN            1
     C                   MOVEL     'SYPALL  '    PRODNA           15
     C     PRODNA        CHAIN     SYPROD                             33
     C  N33PRINST        IFEQ      'J'
     C                   MOVE      'J'           PALLJN            1
     C                   END
      *
     C                   ENDSR
      *
      *////////////////////////////////////////////////////////////
      * RETREIVE INFO FROM EDIFACT DATABASE TO SYSPED400     RTVD /
      *////////////////////////////////////////////////////////////
     C     RTVD          BEGSR
      *_______________________
      * READ ALL MAIN SEGMENTS
      *"""""""""""""""""""""""
      * TDT05 - TRANSPORT DETAILS
     C                   MOVE      '0'           *IN51
     C                   Z-ADD     5             ZGN0
     C     KEYMS0        SETLL     ETDT96A                                20
     C     *IN20         IFEQ      '1'
     C     KEYMS0        READE     ETDT96A                                51
     C     *IN51         DOWEQ     '0'
      *
     C                   MOVEL     T8028         XXBILN           10
      *
     C  N51KEYMS0        READE     ETDT96A                                51
     C  N51              END
     C                   END
      *
      * RFF01 - FF = TURNR
     C                   MOVE      '0'           *IN51
     C                   Z-ADD     01            ZGN0
     C     KEYMS0        SETLL     ERFF96A                                20
     C     *IN20         IFEQ      '1'
     C     KEYMS0        READE     ERFF96A                                51
     C     *IN51         DOWEQ     '0'
      *
     C     R1153         IFEQ      'AFC'
COLLIC                   MOVEL     R1154         XXREF35
     C                   MOVE      '1'           *IN51
     C                   END
      *
     C  N51KEYMS0        READE     ERFF96A                                51
     C  N51              END
     C                   END
      *
      * DTM05 - TRANSP.DATO - HVIS INGENTING -> DAGENS DATO(MELDINGENS)
     C                   Z-ADD     MDT           XXDT              8 0
     C                   MOVE      '0'           *IN51
     C                   Z-ADD     5             ZGN0
      *
      * NAD09 - HER BØR!!! EN HA INN ET NAD-SEGMENT PÅ HVEM SOM ER AVS.
      * NÅ - HENTE-OPPDR.HEADER SKRIVES NÅR FØRSTE LINJE-NAD ER LEST
     C                   MOVE      '0'           *IN51
     C                   Z-ADD     9             ZGN0
      *
      *___________________
      * READ CONSIGNEMENTS  = LINJER
      *"""""""""""""""""""
     C                   MOVE      *ZEROS        WSLNR2            3 0
     C                   MOVE      '0'           *IN51
     C                   Z-ADD     15            ZGN0
     C     KEYMS0        SETLL     ECNI96A                                20
     C     *IN20         IFEQ      '1'
     C     KEYMS0        READE     ECNI96A                                51
     C     *IN51         DOWEQ     '0'
      * FINNES SENDINGEN ALLEREDE...
     C                   movel     C1004         Sndnr20          20
     C     Sndnr20       chain     Head39                             33
     C     *IN33         CABEQ     '0'           NXTCNI
COLLI * Unik kode er typisk CC_NL_0001_0009872, lagret i fri søkevei CCU
COLLIC                   eval      UnikSn= %trim(M0004)+'_'+C1004
COLLIc     UnikKey       Klist
COLLIc                   kfld                    FSKODE
COLLIc                   kfld                    UnikSn
COLLIc                   move      'CCU'         FSKODE
COLLIC     UnikKey       chain     FRISOL01                           33
COLLIC     *IN33         CABEQ     '0'           NXTCNI
      *
     C                   EXSR      RTVDB
     C                   EXSR      DELPRE
      *
     C     NXTCNI        TAG
     C                   Z-ADD     15            ZGN0
     C     KEYMS0        READE     ECNI96A                                51
     C  N51              ENDDO
     C                   ENDIF
      *
     C                   ENDSR
      *////////////////////////////////////////////////////////////
     C     DELPRE        BEGSR
      *////////////////////////////////////////////////////////////
     C                   MOVE      *zeros        XXDATE
     C                   MOVE      *zeros        XXTIME
      *__________________
      * DELETE PREADVICES
      *""""""""""""""""""
      * HEADER ER OPPDRAGSGIVER MED NEG. FORTEGN
     C                   Z-SUB     TRKNFA        XXLNR             7 0          NEGATIVT FOR
     C                   MOVEL     HXSNDN        TSTSND           20
      * Fjern Sending / tell ned(/fjern)i header -  fra Preadv.
     C     TSTSND        SETLL     HENOS01
     C     TSTSND        READE     HENOS01                                33
     C     *IN33         DOWEQ     '0'
     C     HSLNR         IFNE      XXLNR
     C                   UPDATE    HENOSR
     C                   ELSE
     C                   DELETE    HENOSR
     C* Dato / tid da preadviseet kom inn=tidspkt web-booket           3
     C                   TESTN                   XXDATE               33
     C  N33              MOVE      *zeros        XXDATE
     C                   TESTN                   XXTIME               33
     C  N33              MOVE      *zeros        XXTIME
      *
     C     HSLNR         CHAIN     HENOP                              33
     C     *IN33         IFEQ      '0'
     C                   SUB       1             HOMINT                          *ANT SND
     C                   SUB       HSANT         HOMINK                          *ANT KLL
     C                   SUB       HSVKT         HOVKT
     C                   SUB       HSM3          HOM3
     C                   SUB       HSLM          HOLM
     C     HOMINT        IFGT      0
     C                   UPDATE    HENOPR
     C                   ELSE
     C                   DELETE    HENOPR
     C                   END
     C                   END
     C                   END
     C     TSTSND        READE     HENOS01                                33
     C                   END
      *
      * Fjern Fritekster fra Preadv.
     c     HenofKey      KLIST
     c                   KFLD                    XXLNR
     c                   KFLD                    TSTSND
     C     HenofKey      SETLL     HENOF01
     C     HenofKey      READE     HENOF01                                33
     C     *IN33         DOWEQ     '0'
     C                   DELETE    HENOFR
     C     HenofKey      READE     HENOF01                                33
     C                   END
      *
     C     UTDEL         ENDSR
      *////////////////////////////////////////////////////////////
      * RETREIVE INFO FROM EDIFACT DATABASE TO SYSPED400    RTVDB /
      *////////////////////////////////////////////////////////////
     C     RTVDB         BEGSR
COLLIC                   MOVE      *ZEROS        OprAvd            4
COLLIC                   MOVE      *ZEROS        OprOpd            7
      *__________________
      * INIT. DATAFELTER
      *""""""""""""""""""
     C                   CLEAR                   HEADFR
      * INNTIL VIDERE - SKRIV FRAKTBREV VED EDI-MOTTATTE OPPDRAG.
     C                   MOVE      'J'           HEPK1
      * Edi-kode... (K=Kundeløsning, I=InternEDI, E=Ekstern EDI)
     C                   MOVE      'K'           HXEDIK
     C                   MOVE      'H'           HEUR
     C                   MOVE      'EDI'         HESG
     C                   MOVE      'HO'          TRSLAG
colliC*                  MOVEL     C1004         SNDN             20
colliC*                  MOVEL     SNDN          HERFK
     C                   MOVEL     XXBILN        HEHAWB
     C                   MOVE      XXDT          HEDTR
     C                   MOVE      XXDT          HEDTOP
     C                   MOVE      XXDT          TRSDFD
     C                   MOVE      XXDT          TRSDTD
     C                   MOVE      HESG          DISIGN
     C                   MOVE      XXDT          DIDATF
     C                   MOVE      XXDT          DIDATT
COLLI *
COLLIC*                  MOVE      'E'           DISTA1
COLLIC                   MOVE      ' '           DISTA1
      *__________________
      * READ ALL SEGMENTS
      *""""""""""""""""""
     C                   Z-ADD     CREP0         ZREPB0
      * NAD30 TILDELER AVD/OPPDR.NR - DERFOR FØRST.
     C                   EXSR      NAD30
COLLI * når det er ref til eksisterende avd-oppdrag skal kun avt/vkt/m3/Lm hentes fra edi
COLLIc     OprOpd        ifne      *zeros
COLLIC                   EXSR      GID37
COLLIC                   EXSR      MEA39
COLLIC                   else
COLLI *ekstre leserunde på ENAD forenkler skriving til ENADSF
COLLIC*                  EXSR      NAD30SF
     C                   EXSR      TSR19
     C                   EXSR      FTX15
     C                   EXSR      TOD21
     C                   EXSR      RFF22
     C                   EXSR      GID37
     C                   EXSR      FTX37
     C                   EXSR      MEA39
     C                   EXSR      PCI37
     C     PALLJN        IFEQ      'J'
     C                   EXSR      EQD13
     C                   END
Collic                   endif
      *___________________
      * WRITE TO HEADF/DISP
      *"""""""""""""""""""
COLLI *
COLLIC                   MOVE      XXDTT         HEDTOP
COLLIC                   MOVE      XXDTF         TRSDFD
COLLIC                   MOVE      XXDTT         TRSDTD
COLLIC                   MOVE      XXDTF         DIDATF
COLLIC                   MOVE      XXDTT         DIDATT
COLLIC                   MOVEL     XXLKPNF       HELKA
COLLIC                   MOVE      XXLKPNF       HESDF
COLLIC                   MOVEL     XXLKPNT       HETRI
COLLIC                   MOVE      XXLKPNT       HESDT
COLLI * skap-importtur/legg oppdragene på denne
COLLIc                   exsr      CrtTur
COLLI *
     C                   WRITE     HEADFR
      *
     C                   MOVEL     'NO'          DISONF
     C                   MOVE      HESDF         DISTEF
     C                   MOVEL     'NO'          DISONT
     C                   MOVE      HESDT         DISTET
COLLIC     CC_TST        ifeq      'CC_'
COLLIC                   MOVEL     XXLKPNF       DISONF
COLLIC                   MOVEL     XXLKPNT       DISONT
COLLIC                   endif
     C                   WRITE     DISPR
      *
     C     FIURBL        IFEQ      'J'
     C                   EXSR      TTSR
     C                   END
      *
      *
COLLIc     UtOppd        TAG
COLLI * Skriv/oppdater ETD/ETA
COLLIC     HEAKEY        chain     TRACKT                             38
COLLIc                   MOVE      HEAVD         TXAVD
COLLIc                   MOVE      HEOPD         TXOPD
COLLIC                   MOVE      XXDTF         TXETDD
COLLIC                   MOVE      XXDTT         TXETAD
COLLIC  N38              UPDATE    TRACKTR
COLLIC   38              WRITE     TRACKTR
     C                   ENDSR
      *////////////////////////////////////////////////////////////
      * EQD13                                               EQD13 /
      *////////////////////////////////////////////////////////////
     C     EQD13         BEGSR
     C                   Z-ADD     0             ANTEQN            3 0
     C                   Z-ADD     0             EQN1              5 0
     C                   Z-ADD     0             EQN2              5 0
     C                   Z-ADD     13            ZGN0
     C                   Z-ADD     13            ZGN1
      *
     C     KEYMS0        SETLL     EEQD96A                                20
     C     *IN20         IFEQ      '1'
     C     KEYMS0        READE     EEQD96A                                51
     C     *IN51         DOWEQ     '0'
      *
      * ETT ELLER 2 SEGMENT...
     C     E8053         IFEQ      'EFP'
     C                   Z-ADD     EREP0         ZREPB0
     C                   ADD       1             ANTEQN
     C     KEYMS1        CHAIN     EEQN96A                            33
     C     *IN33         IFEQ      '0'
     C     E6350         ANDNE     *BLANKS
     C                   CLEAR                   A
     C                   MOVEA     E6350         A
     C                   EXSR      GETNUM
      * FØRSTE ER TIL -> TRANSP FRA KUNDE(VAREN STÅR PÅ PALL V/HENTING)
     C     ANTEQN        IFEQ      1
     C                   Z-ADD     ZNUM          EQN1
     C                   END
      * ANDRE  ER FRA TRANSP -> KUNDE (HENTEBIL HADDE MED UT...)
     C     ANTEQN        IFEQ      2
     C                   Z-ADD     ZNUM          EQN2
     C                   END
     C                   END
     C                   END
      *
     C  N51KEYMS0        READE     EEQD96A                                51
     C  N51              END
     C                   END
     C                   MOVE      HEAVD         FSAVD
     C                   MOVE      HEOPD         FSOPD
     C                   MOVE      'DIR'         FSKODE
     C                   MOVEL     M1004         TMP402           20
     C                   MOVE      TMP402        TMP15            15
     C                   MOVEL     TMP15         FSSOK
     C                   WRITE     FRISOKR
      *
     C                   MOVE      'DIP'         FSKODE
     C                   MOVE      'TIL:'        TILTX
     C                   MOVE      'FRA:'        FRATX
     C                   MOVE      EQN1          DSTIL                             TIL TRANS
     C                   MOVE      EQN2          DSFRA                             FRA TRANS
     C                   MOVEL     DSSOK         FSSOK
     C                   WRITE     FRISOKR
      * PALLER LIGGER PÅ HEADER-NIVÅ (SUM ALLE OPPDRAG)
      * NORMALT ER DET KUN ETT OPPDRAG PÅ EN DIREKTE-KJØRING
      * ALLE PALLENE HEKTES PÅ DET FØRSTE OPPDRAGET, SETTER DERETTER AV
      * PALL-FLAGG JUST IN CASE DET ER FLERE OPPDRAG I MELDINGEN
     C                   MOVE      EQN1          HXPALL
     C                   MOVE      'N'           PALLJN            1
     C                   ENDSR
      *
      *
      *////////////////////////////////////////////////////////////
      * TSR19                                               TSR19 /
      *////////////////////////////////////////////////////////////
     C     TSR19         BEGSR
     C                   MOVE      '0'           *IN52
     C                   Z-ADD     19            ZGN1
     C     KEYMS1        SETLL     ETSR96A                                20
     C     *IN20         IFEQ      '1'
     C     KEYMS1        READE     ETSR96A                                52
     C     *IN52         DOWEQ     '0'
      * RMD=FARLIG (-> ADR-MERKING)  ZHO=VARME (-> IMD-MERKING)
     C                   SELECT
     C     T7085         WHENEQ    'RMD'
     C     T4065         OREQ      'RMD'
     C                   MOVEL     'X'           TRFA21                         *FARLIG
     C     T7085         WHENEQ    'ZHO'
     C     T4065         OREQ      'ZHO'
     C                   MOVEL     'X'           TRFA11                         *VARME
     C     T7085         WHENEQ    'ZPL'
     C     T4065         OREQ      'ZPL'
     C                   MOVEL     'P'           HEKDPL                         *PALL PRISET
     C     T7085         WHENEQ    'ZHP'
     C     T4065         OREQ      'ZHP'
     C                   MOVEL     'H'           HEKDPL                         *Halv-PALL PRISET
     C     T7085         WHENEQ    'ZKL'
     C     T4065         OREQ      'ZKL'
     C                   MOVEL     'K'           HEKDPL                         *KOLLIPRISET
     C     T7085         WHENEQ    'ZPG'
     C     T4065         OREQ      'ZPG'
     C                   MOVEL     'D'           HEKDPL                         *partigods/direkte
     C                   ENDSL
     C     KEYMS1        READE     ETSR96A                                52
     C                   ENDDO
      *
     C                   ENDIF
      *
     C                   ENDSR
      *////////////////////////////////////////////////////////////
      * TOD21                                               TOD21 /
      *////////////////////////////////////////////////////////////
     C     TOD21         BEGSR
     C                   MOVE      '0'           *IN52
     C                   Z-ADD     21            ZGN1
     C     KEYMS1        SETLL     ETOD96A                                20
     C     *IN20         IFEQ      '1'
     C     KEYMS1        READE     ETOD96A                                52
     C     *IN52         IFEQ      '0'
      *
     C                   MOVEL     T4052A        HEFR
      *
     C                   ENDIF
     C                   ENDIF
      *
Colli * STYRING via CC/PP blir for enkelt når en har både OPD/TUR - IMP/EXP..(KFG-20120925)
Colli * Hvis franakturtype 'CC'(Charges Collect)= Mottaker betaler må HEKNSF mm blankes
Collic*    KodtFRkey     Klist
Collic*                  Kfld                    KFRUNI
Collic*                  Kfld                    HEFR
Collic*                  move      'FR'          KFRUNI
Collic*                  move      'PP'          KFRCP
Collic*    KodtFRkey     chain     KODTFR
Collic*    KFRCP         ifeq      'CC'
ColliC*                  MOVEL     'K'           TRKDFF
ColliC*                  Z-ADD     HEKNK         HEKNKF
ColliC*                  MOVE      ' '           HEKDFK
ColliC*                  MOVE      'X'           HEKDFS
ColliC*                  move      *zeros        HEKNSF
Collic*                  endif
      *
     C                   ENDSR
COLLI ***********************************************************
COLLIC     RFFOPR        BEGSR
COLLI ***********************************************************
COLLIC                   MOVE      *ZEROS        XXDTF             8
COLLIC                   MOVE      *ZEROS        XXDTT             8
COLLIC                   MOVE      *ZEROS        OprAvd            4
COLLIC                   MOVE      *ZEROS        OprOpd            7
COLLIC                   MOVE      *BLANKS       AVSAVD            4
COLLIC                   MOVE      *BLANKS       TILLAND           2
COLLIC                   MOVE      'N'           VareMotEU         1
COLLIC                   MOVE      '0'           *IN52
COLLIC                   Z-ADD     18            ZGN1
COLLIC     KEYMS1        SETLL     ERFF96A                                20
COLLIC     *IN20         IFEQ      '1'
COLLIC     KEYMS1        READE     ERFF96A                                52
COLLIC     *IN52         DOWEQ     '0'
COLLI * Følgende 10-12 linjer utgår pr 2014.04.04 - kan ligge en stuns som dokumentasjon/slettes så
COLLIC*    R1153         ifeq      'CU '
COLLIC*    OPDMODE       andeq     'N'                                          Kun ved turmode
COLLIc*    R1154_5       Ifeq      '/'
COLLIc*    R1154_1_4     andge     '0001'
COLLIc*    R1154_1_4     andle     '9999'
COLLIc*    R1154_6_12    andge     '0000001'
COLLIc*    R1154_6_12    andle     '9999999'
COLLIC*                  MOVE      R1154_1_4     OprAvd
COLLIC*                  MOVE      R1154_6_12    OprOpd
COLLIC*                  MOVE      R1154_1_4     HEAVD
COLLIC*                  MOVE      R1154_6_12    HEOPD
COLLIc*                  endif
COLLIc*                  endif
COLLI * 2014.04.04 ligger nå evt referanse til opprinnelig oppdrag i egen fri søkevei ZOP
COLLI *   posi: 12345678901234567890
COLLI *   eks   CC_SE_0002_0001401
COLLIC     R1153         ifeq      'ZOP'
COLLIC     OPDMODE       andeq     'N'                                          Kun ved turmode
COLLIC                   if        %subst(R1154:7:4) >='0001' and
COLLIc                             %subst(R1154:7:4) <='9999' and
COLLIC                             %subst(R1154:12:7)>='0000001' and
COLLIc                             %subst(R1154:12:7)<='9999999'
COLLIc                   eval      OprAvd = %subst(R1154:7:4)
COLLIC                   eval      OprOpd = %subst(R1154:12:7)
COLLIc                   move      OprAvd        HEAVD
COLLIC                   move      OprOpd        HEOPD
COLLIC                   endif
COLLIC                   endif
COLLI * plukk opp dato fra/til allerede nå - trengs i fall kjent oppdrags TRACKT skal oppdateres
COLLIC     R1153         ifeq      'ZDF'
COLLIC                   MOVEL     R1154         XXDTF             8
COLLIc                   endif
COLLIC     R1153         ifeq      'ZDT'
COLLIC                   MOVEL     R1154         XXDTT             8
COLLIc                   endif
COLLIC     R1153         ifeq      'FF '
COLLIC                   MOVEL     R1154         AVSAVD
COLLIc                   endif
COLLIC     R1153         ifeq      'ZST'
COLLIC                   MOVEL     R1154         TILLAND
COLLIc                   endif
COLLIC     KEYMS1        READE     ERFF96A                                52
COLLIC  N52              ENDDO
COLLIC                   ENDIF
COLLI * FRAKT-MOTTAKERLAND I EU ??
COLLIC     LKKEY         KLIST
COLLIC                   KFLD                    KS2UNI
COLLIC                   KFLD                    TILLAND
COLLIC                   MOVEL     'S2 '         KS2UNI
COLLIC     LKKEY         CHAIN     KODTS2                             33
COLLIC     *IN33         IFEQ      '0'
COLLIC     KS2PRE        ANDEQ     'B'
COLLIC                   MOVE      'J'           VareMotEU         1
COLLIC                   ENDIF
COLLIC                   ENDSR
COLLI *
      *////////////////////////////////////////////////////////////
      * RFF22                                               RFF22 /
      *////////////////////////////////////////////////////////////
     C     RFF22         BEGSR
COLLIC                   MOVE      *ZEROS        XXDTF             8
COLLIC                   MOVE      *blanks       XXLKPNF           7
COLLIC                   MOVE      *ZEROS        XXDTT             8
COLLIC                   MOVE      *blanks       XXLKPNT           7
     C                   MOVE      '0'           *IN52
     C                   Z-ADD     22            ZGN1
     C     KEYMS1        SETLL     ERFF96A                                20
     C     *IN20         IFEQ      '1'
     C     KEYMS1        READE     ERFF96A                                52
     C     *IN52         DOWEQ     '0'
      *
     C                   MOVE      HEAVD         FSAVD
     C                   MOVE      HEOPD         FSOPD
COLLIC                   MOVE      *BLANKS       FSDOKK
     C                   SELECT
      * FF     FREIGHT FORWARDERS REF
COLLIC     R1153         WHENEQ    'FF '
COLLIC**   R1153         WHENEQ    'CU '                           pr 07.04.2014 - tilbake til STD
     C                   MOVE      HEAVD         FSAVD
     C                   MOVE      HEOPD         FSOPD
COLLIC                   MOVE      'FFR'         FSKODE
COLLIC**                 MOVE      'ORD'         FSKODE            pr 07.04.2014 - tilbake til STD
COLLIC     FSKODE        CHAIN     KODFRI                             33
COLLIC  N33              MOVE      KFSODK        FSDOKK
     C                   MOVEL     R1154         FSSOK
     C                   WRITE     FRISOKR
COLLIC     R1153         WHENEQ    'AAM'
COLLIC                   MOVE      HEAVD         FSAVD
COLLIC                   MOVE      HEOPD         FSOPD
COLLIC                   MOVE      'IFB'         FSKODE
COLLIC                   MOVEL     R1154         FSSOK
COLLIC     FSKODE        CHAIN     KODFRI                             33
COLLIC  N33              MOVE      KFSODK        FSDOKK
COLLIC                   WRITE     FRISOKR
      * CU     CONSIGNOR'S REFERENCE NUMBER         (SENDERS REF)
     C     R1153         WHENEQ    'CU '
     C     R1153         oreq      'CR '
COLLIC**   R1153         WHENEQ    'FF '    UTGÅR- tilbake til standard 2014.04.04 (CU->HERFA)
     C                   MOVEL     R1154         HERFA
      * AAO    CONSIGNEE'S SHIPMENT REFERENCE NUMBER(MOTTAKERS REF)
     C     R1153         WHENEQ    'AAO'
     C     HEFR          ANDEQ     'M  '
     C                   MOVEL     R1154         HERFA
COLLI * Laste/lossested
COLLIC     R1153         WHENEQ    'ZLS'
COLLIC                   MOVEL     R1154         HESDL
COLLI * DATO FRA TIL I RFF
COLLIC     R1153         WHENEQ    'ZDF'
COLLIC                   MOVEL     R1154         XXDTF             8
COLLIC     R1153         WHENEQ    'ZSF'
COLLIC                   MOVEL     R1154         XXLKPNF           7
COLLIC     R1153         WHENEQ    'ZDT'
COLLIC                   MOVEL     R1154         XXDTT             8
COLLIC     R1153         WHENEQ    'ZST'
COLLIC                   MOVEL     R1154         XXLKPNT           7
COLLI *
     C                   ENDSL
      *
     C  N52KEYMS1        READE     ERFF96A                                52
     C  N52              ENDDO
     C                   ENDIF
      * GRISETE - HARKODET IT -> NO
COLLIC                   MOVEL     'IT'          XXLKPNF           7
COLLIC                   MOVEL     'NO'          XXLKPNT           7
COLLI *
COLLIC     OPDMODE       IFEQ      'N'
COLLIC                   MOVE      'TRP'         FSKODE
COLLIC                   EVAL      FSSOK = XXREFF +' Truck: '+XXBILN
COLLIC                   WRITE     FRISOKR
COLLIC                   ENDIF
COLLI *
COLLIC                   MOVE      *BLANKS       FSDOKK
COLLIC                   MOVE      'CCU'         FSKODE
COLLIC                   EVAL      FSSOK = UnikSn
COLLIC     FSKODE        CHAIN     KODFRI                             33
COLLIC  N33              MOVE      KFSODK        FSDOKK
COLLIC**                 WRITE     FRISOKR
     C                   ENDSR
      *
      *////////////////////////////////////////////////////////////
      * NAD30                                               NAD30 /
      *////////////////////////////////////////////////////////////
     C     NAD30         BEGSR
      *
     C                   MOVE      '0'           *IN52
     C                   Z-ADD     30            ZGN1
     C     KEYMS1        SETLL     ENAD96A                                20
     C     *IN20         IFEQ      '1'
     C     KEYMS1        READE     ENAD96A                                52
     C     *IN52         DOWEQ     '0'
      *
     C                   SELECT
     C     N3035         WHENEQ    'CZ'                                         GODSAVSENDER
      * NAD
     C                   MOVEA     N3039         A
     C                   EXSR      GETNUM
COLLIC*                  MOVEL     'S'           TRKDAK
COLLIC                   MOVEL     ' '           TRKDAK
     C                   MOVEL     'X'           HEKDFK
     C                   MOVEL     'S'           TRKDFF
     C                   Z-ADD     ZNUM          TRKNFA
COLLI *HENTE KUNDENR FRA ECMSG...
COLLIC     ECMKEY        KLIST
COLLIC                   KFLD                    M0004                          AVSENDER
COLLIC                   KFLD                    M0010                          MOTTAKER
COLLIC                   KFLD                    MSR                            R
COLLIC                   KFLD                    M0065                          IFTMIN
COLLIC     ECMKEY        CHAIN     ECMSG2                             33
COLLIC     *IN33         IFEQ      '0'
COLLIC     ECCNO         ANDNE     *ZEROS
COLLIC                   Z-ADD     ECCNO         TRKNFA
COLLIC                   endif
COLLIC                   Z-ADD     TRKNFA        HEKNSF
COLLIC*    OPDMODE       IFEQ      'J'
COLLI * SETT FRA sendende EDI-parts side: om der er IMP så er han på KJØPERsiden..
COLLIC     XXREFIE       IFEQ      'IMP'
COLLIC                   MOVE      *ZEROS        HEKNSF
COLLIC                   MOVEL     ' '           HEKDFK
COLLIC                   MOVEL     'X'           HEKDFS
COLLIC                   MOVEL     'K'           TRKDFF
COLLIC                   Z-ADD     TRKNFA        HEKNKF
COLLIC                   Z-ADD     TRKNFA        HEKNA                          OGSÅ AGENT(EDI RET.)
COLLIC                   ENDIF
     C
     C*                  Z-ADD     TRKNFA        KUKUN1
COLLIC                   Z-ADD     7034          HEKNA                          OGSÅ AGENT(EDI RET.)
     C                   Z-ADD     HEKNA         KUKUN1
     C     HEFR          IFEQ      'S  '
     C                   Z-ADD     ZNUM          HEKNSF
     C                   MOVEL     N3036A        HENASF
bhr  C     lowNO:upNO    xlate     HENASF        HENASF
     C                   END
COLLI * mottatt nummer må via X-ref
COLLIC**                 Z-ADD     ZNUM          HEKNS
COLLIC                   MOVEL     N3039         KUITMP
COLLIC                   MOVEL     N3039         KUINTN
COLLIC     KUNKOK        CHAIN     KUNKO2                             33
COLLIC  N33              MOVE      KUKUN2        TRKNFA
COLLIC  N33              MOVE      KUKUN2        HEKNSF
COLLIC  N33              MOVE      KUKUN2        HEKNS
COLLIC  N33              MOVE      *blanks       KUITMP
     C                   MOVEL     N3036A        HENAS
COLLI * midlertidig - vis mottatt nr som 11 siste av HENAK hvis misslykket X-ref
COLLIc     KUITMP        ifne      *blanks
COLLIC                   MOVE      KUITMP        HENAS
COLLIc                   endif
bhr  C     lowNO:upNO    xlate     HENAS         HENAS
     C                   MOVEL     N3036A        HENAA
bhr  C     lowNO:upNO    xlate     HENAA         HENAA
     C                   MOVEL     N3042A        HEADS1
bhr  C     lowNO:upNO    xlate     HEADS1        HEADS1
     C                   MOVEL     N3251         HEADS3
     C                   MOVEL     N3164         XXST25           25
     C                   MOVE      XXST25        HEADS3
COLLIc                   eval      HEADS3= %trim(N3251)+' '+N3164
bhr  C     lowNO:upNO    xlate     HEADS3        HEADS3
     C                   MOVE      'NO'          HELKA
     C                   MOVEL     N3251         HESDF
      *
     C     N3035         WHENEQ    'CN'                                         GODSMOTTAKER
COLLIC                   MOVEL     *blanks       KUITMP           11
     C     N3055         IFEQ      '87'
     C                   MOVEA     N3039         A
     C                   EXSR      GETNUM
     C                   Z-ADD     ZNUM          HEKNK
     C                   ELSE
COLLIC                   MOVEL     N3039         KUITMP
     C                   MOVEL     N3039         KUINTN
     C     KUNKOK        CHAIN     KUNKO2                             33
     C  N33              MOVE      KUKUN2        HEKNK
COLLIC  N33              MOVE      *blanks       KUITMP
     C                   END
     C                   MOVEL     N3036A        HENAK
     C     HEFR          IFEQ      'M  '
     C                   Z-ADD     HEKNK         HEKNKF
     C                   MOVEL     'X'           HEKDFS
     C                   MOVEL     'K'           TRKDFF
     C                   MOVEL     N3036A        HENAKF
     C                   END
     C                   MOVEL     N3036A        HENAK
COLLI * midlertidig - vis mottatt nr som 8 siste av HENAK hvis misslykket X-ref
COLLIc     KUITMP        ifne      *blanks
COLLIC                   MOVE      KUITMP        HENAK
COLLIc                   endif
bhr  C     lowNO:upNO    xlate     HENAK         HENAK
     C                   MOVEL     N3042A        HEADK1
bhr  C     lowNO:upNO    xlate     HEADK1        HEADK1
     C                   MOVEL     N3251         HEADK3
     C                   MOVEL     N3164         XXST25
     C                   MOVE      XXST25        HEADK3
COLLIc                   eval      HEADK3= %trim(N3251)+' '+N3164
bhr  C     lowNO:upNO    xlate     HEADK3        HEADK3
     C                   MOVE      'NO'          HETRI
     C                   MOVEL     N3251         HESDT
     C                   MOVEL     N3251         PNRTA             4
     C                   TESTN                   PNRTA                34
     C     *IN34         IFEQ      '1'
     C                   MOVEL     N3251         PNRT              4 0
     C                   ELSE
     C                   MOVE      *ZEROS        PNRT
     C                   END
      * ANNEN FAK.BET
     C     N3035         WHENEQ    'IV'                                         F.MOT V. ANN
     C     HEFR          IFEQ      'A  '
     C     N3055         IFEQ      '87'
     C                   MOVEA     N3039         A
     C                   EXSR      GETNUM
     C                   Z-ADD     ZNUM          HEKNSF
     C                   ELSE
     C                   MOVEL     N3039         KUINTN
     C     KUNKOK        CHAIN     KUNKO2                             33
     C  N33              MOVE      KUKUN2        HEKNSF
     C                   END
     C                   MOVEL     N3036A        HENASF
bhr  C     lowNO:upNO    xlate     HENASF        HENASF
     C                   END
     C*
     C                   ENDSL
      *
     C     KEYMS1        READE     ENAD96A                                52
     C  N52              ENDDO
     C                   ENDIF
      *
COLLIC     OprOpd        cabne     *zeros        UtAvOp                         Opprinnelig Løst OPD
      * ANTAR AT SENDINGER SOM SENDES OVER FRA F.EKS DRM ->OSL ER
      * UTGÅENDE          FINN AVDELING
     C     KODRIK        KLIST
     C                   KFLD                    RITERM
     C                   KFLD                    PNRT
BHRRIC                   MOVEL     M0010         TXT08             8
BHRRIC     TXT08         IFEQ      'RIKSGODS'
BHRRIC                   MOVE      1000          RITERM                         OSLO
BHRRIC                   ELSE
BHRRIC                   MOVE      3000          RITERM                         DRAMMEN
BHRRIC                   END
BHRRIC***                  MOVE 1000      RITERM           OSLO
BHRRIC***                  MOVE 3000      RITERM           DRAMMEN
      *
     C                   MOVE      *ZEROS        HEAVD
     C     PNRT          IFNE      *ZEROS
     C     KODRIK        SETGT     KODTRI
     C     RITERM        READPE    KODTRI                                 33
     C  N33PNRT          IFGE      RIPNRF
     C     PNRT          ANDLE     RIPNRT
     C                   MOVE      RIAVDU        HEAVD
     C                   ENDIF
     C                   ENDIF
COLLI * FINN AVSENDERS AVD I FØRST RFF-SEGEMENT(FFR) i GRUPPE 18
COLLIC*                  MOVE      *BLANKS       AVSAVD            4
COLLIC*                  Z-ADD     18            ZGN1
COLLIC*    KEYMS1        CHAIN     ERFF96A                            52
COLLIC* N52              MOVEL     R1154         AvsAvd
COLLI *
      * AVDELING - HOVEDREGEL:
COLLI * SNU IMP-EXP RETN. SE/NL HAR KUN 1=IMP,2=EXP (NO HAR OGSÅ 3/4 FOR IM/EX EKSTERNE)
COLLIC     CC_TST        ifeq      'CC_'
COLLIC     XXREFIE       IFEQ      'EXP'
COLLIC                   Z-ADD     1             HEAVD                          1=Import OWN TRUCKS
COLLIC                   else
COLLIC                   Z-ADD     2             HEAVD                          2=Export OWN TRUCKS
COLLIC                   endif
      *   - Visse unntak ved EU-trafikk mm.. (foreløpig kun ved avs = EU (=IKKE NO) )
      *   EDIavs  Avsavd  EDImot     Varemottak     Til avd
      *D  EU         6    EU          EU               6
      *   EU        11    EU          EU               6     = LIK D ??
      *E  EU         2    EU          IKKE EU          2
      *G  EU        11    EU          IKKE EU          2
      *F* EU         1    IKKE EU     EU               1     *UTGÅR* se under (dekkes av std..)
      **                                                     eks:svensk imp.avd ber om eksp.-fra NO
      * Hvis fra EU til EU....
     c                   if        M0004<>'CC_NO' and M0010<>'CC_NO'            = EU->EU
     c                   if        AvsAvd='0006' and VareMotEU='J'
COLLIC                   Z-ADD     6             HEAVD                          EU- 6-EU- EU  -> 6
     c                   endif
     c                   if        AvsAvd='0011' and VareMotEU='J'
COLLIC                   Z-ADD     6             HEAVD                          EU-11-EU- EU  -> 6
     c                   endif
     c                   if        AvsAvd='0002' and VareMotEU='N'
COLLIC                   Z-ADD     2             HEAVD                          EU- 2-EU-IKKE -> 2
     c                   endif
     c                   if        AvsAvd='0011' and VareMotEU='N'
COLLIC                   Z-ADD     2             HEAVD                          EU-11-EU-IKKE -> 2
     c                   endif
     c                   endif
      * Hvis fra EU til IKKE EU....
     c** Utgår/standard  if        M0004<>'CC_NO' and M0010='CC_NO'             = EU->NO
     c**                 if        AvsAvd='0001' and VareMotEU='J'
COLLIC**                 Z-ADD     1             HEAVD                          EU-1-IKKE- EU -> 1
     c**                 endif
     c**                 endif
      *
COLLIC                   MOVEL     'BB'          HEOT                           Booking Bil
COLLIC                   endif
ACCELC                   Z-ADD     1             HEAVD                          1=Import OWN TRUCKS
     C     HEAVD         IFEQ      *ZEROS
BHRRIC     TXT08         IFEQ      'RIKSGODS'
BHRRIC                   Z-ADD     8101          HEAVD
BHRRIC                   ELSE
BHRRIC                   Z-ADD     101           HEAVD
BHRRIC                   END
BHR  C                   MOVEL     'OBS AVD!'    HESDL
     C                   ENDIF
      * OPPDRAG MED 00000 SKAPER KAOS - BEDRE MED 1 V/FEIL...
     C     HEAVD         CHAIN     TELL                               33
     C   33              Z-ADD     1             TEOPDN
     C                   MOVE      TEOPDN        HEOPD
     C                   ADD       1             TEOPDN
     C  N33              UPDATE    TELLR
COLLIc     UtAvOp        tag
     C                   MOVE      HEAVD         DIAVD
     C                   MOVE      HEOPD         DIOPD
      *
     C                   ENDSR
      *
COLLI *////////////////////////////////////////////////////////////
COLLI * NAD30SF                                                   /
COLLI *////////////////////////////////////////////////////////////
COLLIC     NAD30SF       BEGSR
COLLI *
COLLIC*                  MOVE      HEAVD         NAVD
COLLIC*                  MOVE      HEOPD         NOPD
COLLIC*                  MOVE      ZMN           NMN
COLLIC*                  MOVE      TRKNFA        NKN                            KUKUN1
COLLI *
COLLIC*                  MOVE      '0'           *IN52
COLLIC*                  Z-ADD     30            ZGN1
COLLIC*    KEYMS1        SETLL     ENAD96A                                20
COLLIC*    *IN20         IFEQ      '1'
COLLIC*    KEYMS1        READE     ENAD96A                                52
COLLIC*    *IN52         DOWEQ     '0'
COLLIC**                 WRITE     NADSR
COLLIC*    KEYMS1        READE     ENAD96A                                52
COLLIC* N52              ENDDO
COLLIC*                  ENDIF
COLLIC                   ENDSR
COLLI *
COLLI *****************************************
COLLIc     CrtTur        BEGSR
COLLI *****************************************
COLLI * PROGRAMMET BEHANDLER KUN EN-GODSLISTE, TRENGER IKKE HJELPEVARIABEL- TEST PÅ TUPRO = OK
COLLI * TUPRO = 0/FØRSTE OPPDRAG PÅ TUREN - TILDEL NÅ - SKAP TURHEADER.
COLLIc     TUPRO         ifeq      *zeros
COLLIC                   MOVE      *ZEROS        AVDZER            4 0
COLLIC                   MOVE      HEAVD         TUAVD
COLLIC     TUAVD         CHAIN     TELL                               34
COLLIC   34AVDZER        CHAIN     TELL                               34
COLLIC  N34              MOVE      TETURN        TUPRO
COLLIC  N34              ADD       1             TETURN
COLLIC  N34              UPDATE    TELLR
COLLIC     TUAVD         CHAIN     TELLRU                             34
COLLIC   34AVDZER        CHAIN     TELLRU                             34
COLLIC  N34              MOVE      TERUND        TURUND
COLLIC  N34              ADD       1             TERUND
COLLIC  N34              UPDATE    TELLRUR
COLLI * DATA HENTET FRA KJENT BILNR (OGSÅ HENGER BØR HENTES ??)
COLLIC                   MOVEL     HEHAWB        TUBILN
COLLIC     TUBILN        CHAIN     UNITL01                            34
COLLIC     *IN34         IFEQ      *OFF
COLLIC                   MOVE      UNTRAN        TUKNT2
COLLIC                   MOVE      UNLAND        TULK
COLLIC                   MOVE      UNTRMA        TUTRMA
COLLIC                   Z-ADD     UNVEKT        TUKVKT
COLLIC                   Z-ADD     UNM3          TUKAM3
COLLIC                   Z-ADD     UNLM          TUKALM
COLLIC                   ENDIF
COLLIC                   WRITE     TURERR
COLLIc                   endif
      *
CollI * Dersom mottatt EDI-oppdrag peker på et Opprinnelig oversendt Løst oppdrag-bruk det
COLLI *        ta vare på visse verdier fra inngående EDI -
COLLIc     OprOpd        Ifne      *zeros
COLLIc                   z-add     HENT          EDINT             7 0
COLLIc                   z-add     HEVKT         EDIVKT            9 0
COLLIc                   z-add     HEM3          EDIM3             7 3
COLLIc                   z-add     HELM          EDILM             4 2
COLLIC     HEAKEY        KLIST
COLLIC                   KFLD                    HEAVD
COLLIC                   KFLD                    HEOPD
ColliC                   move      OprAvd        HEAVD
ColliC                   move      OprOpd        HEOPD
COLLIC     HEAKEY        chain     HEADF                              36
COLLIC     *in36         ifeq      '1'
COLLIc                   move      'N'           OPRFins           1
COLLIc                   goto      UtCrtTur
COLLIC                   endif
COLLIC     HePRO         ifne      *zeros
COLLIC                   update    HEADFR
COLLIc                   move      'T'           OPRFins           1
COLLIc                   goto      UtCrtTur
COLLIC                   endif
COLLI * Opprinnelig oppdrag finnes OG er åpent for å legges på turen..
COLLIc                   move      'J'           OPRFins           1
COLLIc                   z-add     EDINT         HENT
COLLIc                   z-add     EDIVKT        HEVKT
COLLIc                   z-add     EDIM3         HEM3
COLLIc                   z-add     EDILM         HELM
     C                   MOVEL     XXBILN        HEHAWB
COLLIC     HEAKEY        chain     DISP                               37
COLLIC                   endif
COLLI *
COLLI * OPPDATER SUMTALL PÅ TUREN
COLLIC     TURERK        KLIST
COLLIC                   KFLD                    TUAVD
COLLIC                   KFLD                    TUPRO
COLLIC     TURERK        CHAIN     TURER                              33
COLLIC                   ADD       HENT          TUTS
COLLIC                   ADD       HEVKT         TUTVKT
COLLIC                   ADD       HEM3          TUTM3
COLLIC                   ADD       HELM          TUTLM
COLLIC                   ADD       1             TUAO
COLLIc     TUDT          ifeq      *zeros
COLLIc     TRSDFD        orlt      TUDT
COLLIc                   move      TRSDFD        TUDT
COLLIc                   movel     HELKA         TUSONF
COLLIc                   move      HESDF         TUSTEF
COLLIc                   endif
COLLIc     TUDTT         ifeq      *zeros
COLLIc     TRSDTD        orgt      TUDTT
COLLIc                   move      TRSDTD        TUDTT
COLLIc                   movel     HETRI         TUSONT
COLLIc                   move      HESDT         TUSTET
COLLIc                   endif
COLLIC  N33              UPDATE    TURERR
COLLI *
COLLI * Oppdraget/HEADF  (= LEGG OPPDRAGET PÅ TUR)
COLLIC                   MOVE      TUPRO         HEPRO
COLLIC                   MOVE      TURUND        TRRUND
COLLI *          /DISP
COLLIC                   MOVE      TUAVD         DITUAV
COLLIC                   MOVE      TUPRO         DITUR
COLLIC                   MOVE      TURUND        DIRUND
COLLIC                   MOVE      ' '           DISTA1
COLLI * Ved oppdatering av eksisterende - UPDATE her
COLLIc     OprOpd        Ifne      *zeros
COLLIc  N36              update    HEADFR
COLLIc  N37              update    DISPR
ColliC                   endif
COLLIc     UtCrtTur      ENDSR
      *
      *////////////////////////////////////////////////////////////
      * GID37                                               GID37 /
      *////////////////////////////////////////////////////////////
     C     GID37         BEGSR
     C                   MOVE      '0'           *IN52
     C                   Z-ADD     37            ZGN1
     C     KEYMS1        SETLL     EGID96A                                20
     C     *IN20         IFEQ      '1'
     C     KEYMS1        READE     EGID96A                                52
     C     *IN52         DOWEQ     '0'
      *
     C**   G1496         IFEQ      '99999'
     C                   MOVEA     G7224A        A
     C                   EXSR      GETNUM
     C                   ADD       ZNUM          HENT
     C                   MOVEL     G7065A        HEVS1
     C     HEVS1         IFEQ      *BLANKS
     C     HEVS1         OREQ      'KLI'
     C                   MOVEL     'KLL'         HEVS1
     C     HEKDPL        IFEQ      'P'
     C                   MOVEL     'PALLER'      HEVS1
     C                   END
     C                   ENDIF
     C**                 ENDIF
      *
     C     KEYMS1        READE     EGID96A                                52
     C  N52              ENDDO
     C                   ENDIF
      *
     C                   ENDSR
      *
      *
      *
      *////////////////////////////////////////////////////////////
      * MEA39                                               MEA39 /
      *////////////////////////////////////////////////////////////
     C     MEA39         BEGSR
     C                   MOVE      '0'           *IN52
     C                   Z-ADD     39            ZGN1
     C     KEYMS1        SETLL     EMEA96A                                20
     C     *IN20         IFEQ      '1'
     C     KEYMS1        READE     EMEA96A                                52
     C     *IN52         DOWEQ     '0'
      *
     C                   MOVEA     M6314         A
     C                   EXSR      GETNUM
     C                   SELECT
     C     M6311         WHENEQ    'WT '
     C*                  Z-ADD     ZNUM          HEVKT
     C     ZNUM          DIV       1000          HEVKT
     C                   ADD       HEVKT         HXVKT
     C                   ADD       HEVKT         HXFBV
     C     M6311         WHENEQ    'LMT'
     C                   Z-ADD     ZNUM          HELM
     C                   ADD       HELM          HXLM
     C     M6311         WHENEQ    'VOL'
     C     M6411         IFEQ      'DMQ'
     C     ZNUM          DIV(H)    1000          HEM3
     C                   ELSE
     C                   Z-ADD     ZNUM          HEM3
     C                   END
     C                   ADD       HEM3          HXM3
     C                   ENDSL
      *
     C     KEYMS1        READE     EMEA96A                                52
     C  N52              ENDDO
     C                   ENDIF
     C                   ENDSR
      *
      *////////////////////////////////////////////////////////////
      * PCI37                                               PCI37 /
      *////////////////////////////////////////////////////////////
     C     PCI37         BEGSR
     C                   MOVE      '0'           *IN52
     C                   Z-ADD     37            ZGN1
     C                   MOVE      *ZEROS        FMMKNR
     C     KEYMS1        SETLL     EPCI96A                                20
     C     *IN20         IFEQ      '1'
     C     KEYMS1        READE     EPCI96A                                52
     C     *IN52         DOWEQ     '0'
      *
     C                   MOVE      'F'           FMRI
     C                   MOVE      HEAVD         FMAVD
     C                   MOVE      HEOPD         FMOPD
     C                   Z-ADD     1             FMFBNR
COLLIC*                  MOVE      'I'           FMST
COLLIC                   MOVE      'E'           FMST
     C     P7102A        IFNE      *BLANKS
     C                   ADD       1             FMMKNR
     C                   MOVEL     P7102A        FMMRK1
     C                   WRITE     DOKUFMR
     C                   END
     C     P7102B        IFNE      *BLANKS
     C                   ADD       1             FMMKNR
     C                   MOVEL     P7102B        FMMRK1
     C                   WRITE     DOKUFMR
     C                   END
     C     P7102C        IFNE      *BLANKS
     C                   ADD       1             FMMKNR
     C                   MOVEL     P7102C        FMMRK1
     C                   WRITE     DOKUFMR
     C                   END
     C     P7102D        IFNE      *BLANKS
     C                   ADD       1             FMMKNR
     C                   MOVEL     P7102D        FMMRK1
     C                   WRITE     DOKUFMR
     C                   END
     C     P7102E        IFNE      *BLANKS
     C                   ADD       1             FMMKNR
     C                   MOVEL     P7102E        FMMRK1
     C                   WRITE     DOKUFMR
     C                   END
     C     P7102F        IFNE      *BLANKS
     C                   ADD       1             FMMKNR
     C                   MOVEL     P7102F        FMMRK1
     C                   WRITE     DOKUFMR
     C                   END
     C     P7102G        IFNE      *BLANKS
     C                   ADD       1             FMMKNR
     C                   MOVEL     P7102G        FMMRK1
     C                   WRITE     DOKUFMR
     C                   END
     C     P7102H        IFNE      *BLANKS
     C                   ADD       1             FMMKNR
     C                   MOVEL     P7102H        FMMRK1
     C                   WRITE     DOKUFMR
     C                   END
     C     P7102I        IFNE      *BLANKS
     C                   ADD       1             FMMKNR
     C                   MOVEL     P7102I        FMMRK1
     C                   WRITE     DOKUFMR
     C                   END
     C     P7102J        IFNE      *BLANKS
     C                   ADD       1             FMMKNR
     C                   MOVEL     P7102J        FMMRK1
     C                   WRITE     DOKUFMR
     C                   END
      *
     C     KEYMS1        READE     EPCI96A                                52
     C  N52              ENDDO
     C                   ENDIF
      *
     C                   ENDSR
      *
      *////////////////////////////////////////////////////////////
      * FTX15                                               FTX15 /
      *////////////////////////////////////////////////////////////
     C     FTX15         BEGSR
     C                   CLEAR                   FREETXTR
     C                   MOVE      HEAVD         FRTAVD
     C                   MOVE      HEOPD         FRTOPD
     C                   Z-ADD     MDT           FRTDT
     C                   CLEAR                   DOK29R
     C                   MOVE      HEAVD         D29AVD
     C                   MOVE      HEOPD         D29OPD
     C                   Z-ADD     1             D29FNR
     C                   MOVE      '0'           *IN51
     C                   Z-ADD     15            ZGN1
     C     KEYMS1        SETLL     EFTX96A                                20
     C     KEYMS1        READE     EFTX96A                                51
     C     *IN51         DOWEQ     '0'
      *
     C     F4451         IFEQ      'SIC'
CC   C     F4451         OREQ      'ZBL'
     C                   MOVE      'G'           FRTKOD
CC   C     F4451         IFEQ      'ZBL'
CC   C                   MOVE      ' '           FRTKOD
CC   C                   endif
      *
     C                   ADD       1             FRTLI
     C                   MOVEL     F4440A        FRTTXT
     C                   WRITE     FREETXTR
      *
     C     F4440B        IFNE      *BLANKS
     C                   ADD       1             FRTLI
     C                   MOVEL     F4440B        FRTTXT
     C                   WRITE     FREETXTR
     C                   ENDIF
     C     F4440C        IFNE      *BLANKS
     C                   ADD       1             FRTLI
     C                   MOVEL     F4440C        FRTTXT
     C                   WRITE     FREETXTR
     C                   ENDIF
     C     F4440D        IFNE      *BLANKS
     C                   ADD       1             FRTLI
     C                   MOVEL     F4440D        FRTTXT
     C                   WRITE     FREETXTR
     C                   ENDIF
     C     F4440E        IFNE      *BLANKS
     C                   ADD       1             FRTLI
     C                   MOVEL     F4440E        FRTTXT
     C                   WRITE     FREETXTR
     C                   ENDIF
     C                   ENDIF
      *
      **UNDERRETNING TIL KUNDE LEGGES RETT UT I RUBR38-FIL FOR FR.BREV
      * ALL FRITEKT PÅ DETT NIVÅ - RETT UT I RUBR38-FIL FOR FR.BREV
     C                   MOVEL     F4440A        D29TXT
     C                   WRITE     DOK29R
      *
     C     F4440B        IFNE      *BLANKS
     C                   MOVEL     F4440B        D29TXT
     C                   WRITE     DOK29R
     C                   ENDIF
     C     F4440C        IFNE      *BLANKS
     C                   MOVEL     F4440C        D29TXT
     C                   WRITE     DOK29R
     C                   ENDIF
     C     F4440D        IFNE      *BLANKS
     C                   MOVEL     F4440D        D29TXT
     C                   WRITE     DOK29R
     C                   ENDIF
     C     F4440E        IFNE      *BLANKS
     C                   MOVEL     F4440E        D29TXT
     C                   WRITE     DOK29R
     C                   ENDIF
      *
      *
     C     KEYMS1        READE     EFTX96A                                51
     C  N51              ENDDO
      *
     C                   ENDSR
      *////////////////////////////////////////////////////////////
      * FTX37                                               FTX37 /
      *////////////////////////////////////////////////////////////
     C     FTX37         BEGSR
     C                   MOVE      '0'           *IN52
     C                   Z-ADD     37            ZGN1
     C     KEYMS1        SETLL     EFTX96A                                20
     C     *IN20         IFEQ      '1'
     C     KEYMS1        READE     EFTX96A                                52
     C     *IN52         DOWEQ     '0'
      *
     C     F4451         IFEQ      'AAA'
     C     HEVS1         CAT       F4440A:1      HEVS1
     C                   ENDIF
      *
     C  N52KEYMS1        READE     EFTX96A                                52
     C  N52              ENDDO
     C                   ENDIF
      *
     C                   ENDSR
      *////////////////////////////////////////////////////////////
      *  Get numerical value                               GETNUM /
      *////////////////////////////////////////////////////////////
     C     GETNUM        BEGSR
     C                   MOVE      *ZEROS        ZHEL
     C                   MOVE      *ZEROS        ZDEC
     C                   MOVE      *ZEROS        B
     C                   Z-ADD     1             AX                2 0
     C                   Z-ADD     1             BX                2 0
      * Get Integer
     C     A(AX)         DOWGE     '0'
     C     ZHEL          MULT      10            ZHEL
     C                   MOVE      A(AX)         ZHEL
     C                   ADD       1             AX
     C                   ENDDO
      * Decimal point ?
     C     A(AX)         IFEQ      '.'
     C     A(AX)         OREQ      ','
     C                   ADD       1             AX
     C     A(AX)         DOWGE     '0'
     C                   MOVE      A(AX)         B(BX)
     C                   ADD       1             AX
     C                   ADD       1             BX
     C                   ENDDO
     C                   MOVEA     B             ZDEC6
     C                   ENDIF
      * Concatenate
     C                   Z-ADD     ZHEL          ZNUM             18 6
     C                   ADD       ZDEC          ZNUM
     C                   ENDSR
      *
     C***********************************************
     C     TTSR          BEGSR
     C***********************************************
      * EDI-FIL klargjort hos avsender (hentet fra EUNB)
     C                   MOVE      HEAVD         TTAVD
     C                   MOVE      HEOPD         TTOPD
     C     MSN           CHAIN     EUNB                               33
     C   33              MOVE      *ZEROS        U0017
     C   33              MOVE      *ZEROS        U0019
     C   33              MOVE      *ZEROS        TTDATE
     C                   MOVE      'ED1'         TTACTI
     C                   MOVEL     U0017         TSTÅR             2
     C  N33TSTÅR         IFGT      '43'
     C                   MOVEL     '19'          TTDATE
     C                   ELSE
     C                   MOVEL     '20'          TTDATE
     C                   END
     C                   MOVE      U0017         TTDATE
     C                   MOVEL     U0019         TTTIME
     C                   MOVE      '00'          TTTIME
bhr  c     XXDATE        IFNE      *ZEROS
COLLIC*                  MOVE      XXDATE        TTDATE
COLLIC*                  MOVE      XXTIME        TTTIME
bhr  c                   end
     C                   TIME                    XULTID
     C                   MOVE      XULDD         ULDD
     C                   MOVE      XULMM         ULMM
     C                   MOVE      XULÅÅ         ULÅÅ
     C                   MOVE      ULDT          TTDATL                          *LOGGFØRING
     C                   MOVE      XULTM         TTTIML
     C                   MOVEL     U0004         TTUSER
     C                   MOVEL     TTXED1        TTTEXT
     C                   WRITE     TRACKFR
      * EDI-fil mottatt og logget i SYSPED/SYEDI (hentet fra EDIS)
     C                   MOVE      'ED2'         TTACTI
     C                   MOVEL     SDT           TTDATE
     C                   MOVEL     STM           TTTIME
     C                   TIME                    XULTID
     C                   MOVE      XULDD         ULDD
     C                   MOVE      XULMM         ULMM
     C                   MOVE      XULÅÅ         ULÅÅ
     C                   MOVE      ULDT          TTDATL                          *LOGGFØRING
     C                   MOVE      XULTM         TTTIML
     C                   MOVE      *BLANKS       TTUSER
     C                   MOVEL     'SY400USR'    TTUSER
     C                   MOVEL     TTXED2        TTTEXT
     C                   WRITE     TRACKFR
      * Registrert (SKREVET TIL HEADF...)
     C                   TIME                    XULTID
     C                   MOVE      XULDD         ULDD
     C                   MOVE      XULMM         ULMM
     C                   MOVE      XULÅÅ         ULÅÅ
     C                   MOVE      'STR'         TTACTI
     C                   MOVE      ULDT          TTDATE
     C                   MOVE      XULTM         TTTIME
     C                   MOVE      TTDATE        TTDATL
     C                   MOVE      TTTIME        TTTIML
     C                   MOVEL     'SY400USR'    TTUSER
     C                   MOVEL     TTXSTR        TTTEXT
     C                   WRITE     TRACKFR
     C                   ENDSR
COLLI
COLLIC***********************************************
COLLIC     TTSRFins      BEGSR
COLLIC***********************************************
COLLI * Original finnes fra fø/addet til EDI-tur
COLLIC                   MOVE      HEAVD         TTAVD
COLLIC                   MOVE      HEOPD         TTOPD
COLLIC                   TIME                    XULTID
COLLIC                   MOVE      XULDD         ULDD
COLLIC                   MOVE      XULMM         ULMM
COLLIC                   MOVE      XULÅÅ         ULÅÅ
COLLIC                   MOVE      'ED2'         TTACTI
COLLIC                   MOVE      ULDT          TTDATE
COLLIC                   MOVE      XULTM         TTTIME
COLLIC                   MOVE      TTDATE        TTDATL
COLLIC                   MOVE      TTTIME        TTTIML
COLLIC                   MOVEL     'SY400USR'    TTUSER
COLLIC                   Eval      TTTEXT = 'Original Order added to '
COLLIc                             +'EDI-trip '+ %trim(%editc(TUPRO:'Z'))
COLLIc     OPRFins       ifeq      'T'
COLLIC                   Eval      TTTEXT = 'Orig. Order could NOT be added to '
COLLIc                             +'EDI-trip  '+ %trim(%editc(TUPRO:'Z'))
COLLIc                   endif
COLLIC                   WRITE     TRACKFR
COLLIC                   ENDSR
