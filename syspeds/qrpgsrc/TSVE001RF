     ‚*********************************************************************
CRTP‚+*  CRTPGM SYSPED/TSVE001R MODULE(*LIBL/TSVE001R *LIBL/INCGI)
CRTP‚m*        ACTGRP(CGI) AUT(*USE)
     ‚*********************************************************************
      /copy SYSPEDS/qrpgsrcpy,hspecs
      /copy SYSPEDS/qrpgsrcpy,hspecsbnd
     ‚*********************************************************************
     fbridf     uf   e           k disk    usropn
     fsveh      if   e           k disk    usropn
     ‚*--------------------------------------------------------------------
     ‚* Variables common to all CGIs
     ‚*--------------------------------------------------------------------
      /copy SYSPEDS/qrpgsrcpy,prototypeb
      /copy SYSPEDS/qrpgsrcpy,usec
      /copy SYSPEDS/qrpgsrcpy,variables3
     ‚*  Prototype for 'JSONFIX'
     d jsonfix         pr                  extpgm('JSONFIX')
     d jsonstring_                         like(jsonstring)
     ‚*  Prototype for 'INCGI'
     d incgi           pr                  extproc('INCGI')
     d bistdl_                             like(bistdl)
     ‚*  Prototype for variabel program
     D Varpgm          Pr                  ExtPgm(BILIBL)
     ‚* Varible for
     d wsuser          s             10
     d avd             s              4
     d avdn            s              4  0
     d opd             s              7
     d opdn            s              7  0
     d jsonstring      s          32000
     d error           s            150
     d antlest         s              9  0
     ‚*get input-string
      /copy syspeds/qrpgsrcpy,prolog3

      /free
       exsr parse;
       // Open files etc
       exsr init;

       gethtmlifs(
       '/syspeddev/html/JSON.html':
       '/CGITAG/');
       wrtsection('top');

       // ..........................................................................................
       // skriv JSON-Object start..(alltid '{' + x ant param. m/komma mellom (IKKE komma etter siste
       // ..........................................................................................

       jsonstring='{'
       +'¬user¬ : ¬'+%trim(wsuser)+'¬, '
       +'¬avd¬ : ¬'+%trim(%editc(avdn:'Z'))+'¬, '
       +'¬opd¬ : ¬'+%trim(%editc(opdn:'Z'))+'¬, '
       +'¬errMsg¬ : ¬'+%trim(error)+'¬, ';
       // JSONfix escaper " i tekst,  for deretter å bytte ¬->"
       jsonfix ( jsonstring );
       updhtmlvar2('JSONstring'
                  :%addr(jsonstring)
                  :%len(jsonstring));
       wrtsection('JSONlin');

       // ..........................................................................................
       // Skriv JSON-LISTE Start (en liste er EN parameter(fra [ til   )
       // ..........................................................................................
       jsonstring ='"oneorder" : [';
       updhtmlvar2('JSONstring'
                  :%addr(jsonstring)
                  :%len(jsonstring));
       wrtsection('JSONlin');

       // Hæmta detta ena ærendet.

       if error = *blanks;
         EXEC SQL
         SELECT *
         INTO :SVEH_SYAV, :SVEH_SYOP, :SVEH_SYSG, :SVEH_SYST, :SVEH_SYDT
              :SVEH_MTYP, :SVEH_TUID, :SVEH_KENH, :SVEH_DEK1, :SVEH_DEK2,
              :SVEH_TART, :SVEH_AVKN, :SVEH_AVEO, :SVEH_AVNA, :SVEH_AVA1,
              :SVEH_AVA2, :SVEH_AVPN, :SVEH_AVPA, :SVEH_AVLK, :SVEH_AVHA,
              :SVEH_AVTL, :SVEH_KOTA, :SVEH_RFAB, :SVEH_RFAC, :SVEH_RFAC2,
              :SVEH_RFAC3, :SVEH_MOKN, :SVEH_MOEO, : SVEH_MONA, : SVEH_MOA1,
              :SVEH_MOA2, :SVEH_MOPN, :SVEH_MOPA, :SVEH_MOLK, :SVEH_KVSA,
              :SVEH_DKKN, :SVEH_DKEO, :SVEH_DKLK, :SVEH_DKNA, :SVEH_DKA1,
              :SVEH_DKA2, :SVEH_DKPA, :SVEH_DKPN, :SVEH_OMEO, :SVEH_OMTY,
              :SVEH_OMHA, :SVEH_OMTL, :SVEH_AVUT, :SVEH_AUKD, :SVEH_AUBE,
              :SVEH_TRID, :SVEH_TRLK, :SVEH_CONT, :SVEH_CONN, :SVEH_TRAI,
              :SVEH_TRAL, :SVEH_FATY, :SVEH_FATX, :SVEH_VAKD, :SVEH_VAKU,
              :SVEH_VAOM, :SVEH_FABL, :SVEH_TRGR, :SVEH_TRIN, :SVEH_GRKD,
              :SVEH_GODM, :SVEH_GOLK, :SVEH_KOSL, :SVEH_VASL, :SVEH_BRUT,
              :SVEH_SUTI, :SVEH_ABUB, :SVEH_EUP1, :SVEH_EUP2, :SVEH_UPPS,
              :SVEH_TID1, :SVEH_TID2, :SVEH_TID3, :SVEH_TI21, :SVEH_TI22,
              :SVEH_TI23, :SVEH_KLEO, :SVEH_TRNR, :SVEH_LAGI, :SVEH_LAGT,
              :SVEH_LAGL, :SVEH_UTFA, :SVEH_LAST, :SVEH_TAXD, :SVEH_BEAT,
              :SVEH_BETK, :SVEH_KOMR, :SVEH_RES1, :SVEH_RES2, :SVEH_RES3,
              :SVEH_RES4, :SVEH_RES5, :SVEH_RES6, :SVEH_RES7, :SVEH_RES8,
              :SVEH_SEL1, :SVEH_SEL2, :SVEH_SAOM, :SVEH_SGDK, :SVEH_SGME,
              :SVEH_SGUT, :SVEH_SGID, :SVEH_SGDT, :SVEH_BYTE, :SVEH_KVAL,
              :SVEH_0035, :SVEH_GODN
         FROM SVEH
         WHERE SVEH_SYAV=:avdn AND SVEH_SYOP=:opdn;
         if SVEH_SYAV > 0;
       // ..........................................................................................
           // Skriv en JSON-Array-linje pr menypunkt - komma før hvert nytt element
       // ..........................................................................................
           jsonstring=*blanks;
           jsonstring=%trim(jsonstring)+'{'
              +'¬sveh_syav¬ : ¬'+%trim(%editc(sveh_syav:'Z'))+'¬, '
              +'¬sveh_syop¬ : ¬'+%trim(%editc(sveh_syop:'Z'))+'¬, '
              +'¬sveh_sysg¬ : ¬'+%trim(sveh_sysg)+'¬, '
              +'¬sveh_syst¬ : ¬'+%trim(sveh_syst)+'¬, '
              +'¬sveh_sydt¬ : ¬'+%trim(%editc(sveh_sydt:'Z'))+'¬, '
              +'¬sveh_mtyp¬ : ¬'+%trim(sveh_mtyp)+'¬, '
              +'¬sveh_tuid¬ : ¬'+%trim(sveh_tuid)+'¬, '
              +'¬sveh_kenh¬ : ¬'+%trim(sveh_kenh)+'¬, '
              +'¬sveh_dek1¬ : ¬'+%trim(sveh_dek1)+'¬, '
              +'¬sveh_dek2¬ : ¬'+%trim(sveh_dek2)+'¬, '
              +'¬sveh_tart¬ : ¬'+%trim(sveh_tart)+'¬, '
              +'¬sveh_avkn¬ : ¬'+%trim(%editc(sveh_avkn:'Z'))+'¬, '
              +'¬sveh_aveo¬ : ¬'+%trim(sveh_aveo)+'¬, '
              +'¬sveh_avna¬ : ¬'+%trim(sveh_avna)+'¬, '
              +'¬sveh_ava1¬ : ¬'+%trim(sveh_ava1)+'¬, '
              +'¬sveh_ava2¬ : ¬'+%trim(sveh_ava2)+'¬, '
              +'¬sveh_avpn¬ : ¬'+%trim(sveh_avpn)+'¬, '
              +'¬sveh_avpa¬ : ¬'+%trim(sveh_avpa)+'¬, '
              +'¬sveh_avlk¬ : ¬'+%trim(sveh_avlk)+'¬, '
              +'¬sveh_avha¬ : ¬'+%trim(sveh_avha)+'¬, '
              +'¬sveh_avtl¬ : ¬'+%trim(sveh_avtl)+'¬, '
              +'¬sveh_kota¬ : ¬'+%trim(%editc(sveh_kota:'Z'))+'¬, '
              +'¬sveh_rfab¬ : ¬'+%trim(sveh_rfab)+'¬, '
              +'¬sveh_rfac¬ : ¬'+%trim(sveh_rfac)+'¬, '
              +'¬sveh_rfac2¬ : ¬'+%trim(sveh_rfac2)+'¬, '
              +'¬sveh_rfac3¬ : ¬'+%trim(sveh_rfac3)+'¬, '
              +'¬sveh_mokn¬ : ¬'+%trim(%editc(sveh_mokn:'Z'))+'¬, '
              +'¬sveh_moeo¬ : ¬'+%trim(sveh_moeo)+'¬,'
              +'¬sveh_mona¬ : ¬'+%trim(sveh_mona)+'¬,'
              +'¬sveh_moa1¬ : ¬'+%trim(sveh_moa1)+'¬, '
              +'¬sveh_moa2¬ : ¬'+%trim(sveh_moa2)+'¬, '
              +'¬sveh_mopn¬ : ¬'+%trim(sveh_mopn)+'¬, '
              +'¬sveh_mopa¬ : ¬'+%trim(sveh_mopa)+'¬, '
              +'¬sveh_molk¬ : ¬'+%trim(sveh_molk)+'¬, '
              +'¬sveh_kvsa¬ : ¬'+%trim(sveh_kvsa)+'¬, '
              +'¬sveh_dkkn¬ : ¬'+%trim(%editc(sveh_dkkn:'Z'))+'¬, '
              +'¬sveh_dkeo¬ : ¬'+%trim(sveh_dkeo)+'¬, '
              +'¬sveh_dklk¬ : ¬'+%trim(sveh_dklk)+'¬, '
              +'¬sveh_dkna¬ : ¬'+%trim(sveh_dkna)+'¬, '
              +'¬sveh_dka1¬ : ¬'+%trim(sveh_dka1)+'¬, '
              +'¬sveh_dka2¬ : ¬'+%trim(sveh_dka2)+'¬, '
              +'¬sveh_dkpa¬ : ¬'+%trim(sveh_dkpa)+'¬, '
              +'¬sveh_dkpn¬ : ¬'+%trim(sveh_dkpn)+'¬, '
              +'¬sveh_omeo¬ : ¬'+%trim(sveh_omeo)+'¬, '
              +'¬sveh_omty¬ : ¬'+%trim(sveh_omty)+'¬, '
              +'¬sveh_omha¬ : ¬'+%trim(sveh_omha)+'¬, '
              +'¬sveh_omtl¬ : ¬'+%trim(sveh_omtl)+'¬, '
              +'¬sveh_avut¬ : ¬'+%trim(sveh_avut)+'¬, '
              +'¬sveh_aukd¬ : ¬'+%trim(sveh_aukd)+'¬, '
              +'¬sveh_aube¬ : ¬'+%trim(sveh_aube)+'¬, '
              +'¬sveh_trid¬ : ¬'+%trim(sveh_trid)+'¬, '
              +'¬sveh_trlk¬ : ¬'+%trim(sveh_trlk)+'¬, '
              +'¬sveh_cont¬ : ¬'+%trim(sveh_cont)+'¬, '
              +'¬sveh_trai¬ : ¬'+%trim(sveh_trai)+'¬, '
              +'¬sveh_tral¬ : ¬'+%trim(sveh_tral)+'¬, '
              +'¬sveh_faty¬ : ¬'+%trim(sveh_faty)+'¬, '
              +'¬sveh_fatx¬ : ¬'+%trim(sveh_fatx)+'¬, '
              +'¬sveh_vakd¬ : ¬'+%trim(sveh_vakd)+'¬, '
              +'¬sveh_vaku¬ : ¬'+%trim(%editc(sveh_vaku:'4'))+'¬, '
              +'¬sveh_vaom¬ : ¬'+%trim(%editc(sveh_vaom:'Z'))+'¬, '
              +'¬sveh_fabl¬ : ¬'+%trim(%editc(sveh_fabl:'4'))+'¬, '
              +'¬sveh_trgr¬ : ¬'+%trim(sveh_trgr)+'¬, '
              +'¬sveh_trin¬ : ¬'+%trim(sveh_trin)+'¬, '
              +'¬sveh_grkd¬ : ¬'+%trim(sveh_grkd)+'¬, '
              +'¬sveh_golk¬ : ¬'+%trim(sveh_golk)+'¬, '
              +'¬sveh_brut¬ : ¬'+%trim(%editc(sveh_brut:'4'))+'¬, '
              +'¬sveh_suti¬ : ¬'+%trim(sveh_suti)+'¬, '
              +'¬sveh_abub¬ : ¬'+%trim(sveh_abub)+'¬, '
              +'¬sveh_upps¬ : ¬'+%trim(sveh_upps)+'¬, '
              +'¬sveh_kleo¬ : ¬'+%trim(sveh_kleo)+'¬, '
              +'¬sveh_trnr¬ : ¬'+%trim(sveh_trnr)+'¬, '
              +'¬sveh_utfa¬ : ¬'+%trim(sveh_utfa)+'¬, '
              +'¬sveh_last¬ : ¬'+%trim(sveh_last)+'¬, '
              +'¬sveh_taxd¬ : ¬'+%trim(%editc(sveh_taxd:'Z'))+'¬, '
              +'¬sveh_beat¬ : ¬'+%trim(%editc(sveh_beat:'Z'))+'¬, '
              +'¬sveh_betk¬ : ¬'+%trim(sveh_betk)+'¬, '
              +'¬sveh_komr¬ : ¬'+%trim(sveh_komr)+'¬, '
              +'¬sveh_res1¬ : ¬'+%trim(sveh_res1)+'¬, '
              +'¬sveh_res2¬ : ¬'+%trim(sveh_res2)+'¬, '
              +'¬sveh_res3¬ : ¬'+%trim(sveh_res3)+'¬, '
              +'¬sveh_res4¬ : ¬'+%trim(sveh_res4)+'¬, '
              +'¬sveh_res5¬ : ¬'+%trim(sveh_res5)+'¬, '
              +'¬sveh_res6¬ : ¬'+%trim(sveh_res6)+'¬, '
              +'¬sveh_res7¬ : ¬'+%trim(sveh_res7)+'¬, '
              +'¬sveh_res8¬ : ¬'+%trim(sveh_res8)+'¬, '
              +'¬sveh_sel1¬ : ¬'+%trim(sveh_sel1)+'¬, '
              +'¬sveh_sel2¬ : ¬'+%trim(sveh_sel2)+'¬, '
              +'¬sveh_saom¬ : ¬'+%trim(sveh_saom)+'¬, '
              +'¬sveh_sgdk¬ : ¬'+%trim(sveh_sgdk)+'¬, '
              +'¬sveh_sgme¬ : ¬'+%trim(sveh_sgme)+'¬, '
              +'¬sveh_sgut¬ : ¬'+%trim(sveh_sgut)+'¬, '
              +'¬sveh_sgid¬ : ¬'+%trim(sveh_sgid)+'¬, '
              +'¬sveh_sgdt¬ : ¬'+%trim(sveh_sgdt)+'¬, '
              +'¬sveh_0035¬ : ¬'+%trim(sveh_0035)+'¬, '
              +'¬sveh_godn¬ : ¬'+%trim(sveh_godn)+'¬, '
              +'¬sveh_byte¬ : ¬'+%trim(%editc(sveh_byte:'Z'))+'¬}';
           jsonfix ( jsonstring );
           updhtmlvar2('JSONstring'
                      :%addr(jsonstring)
                      :%len(jsonstring));
           wrtsection('JSONlin');

         endif;
       endif;
       jsonstring =']';
       updhtmlvar2('JSONstring'
                  :%addr(jsonstring)
                  :%len(jsonstring));
       wrtsection('JSONlin');
       // ..........................................................................................
       // Skriv JSON-string Avsluttning
       // ..........................................................................................
       jsonstring ='}';
       updhtmlvar2('JSONstring'
                  :%addr(jsonstring)
                  :%len(jsonstring));
       wrtsection('JSONlin');

       // Quit
       exsr exit;


       //=====================================================================
       // Close output html and quit
       //=====================================================================
       begsr exit;
         // Lukk fil
         close bridf;

         // Do not delete the call to wrtsection with section name *fini.  It is needed
         // to ensure that all output html that has been buffered gets output.
         wrtsection('*fini');
         // Quit
         *inlr = *on;
         return;
       endsr;

       //********************************************************
       begsr parse;
         //********************************************************
         // Get input
         wsuser  = zhbgetvar('USER');
         avd     = zhbgetvar('AVD');
         avdn    = c2n2(avd);
         opd     = zhbgetvar('OPD');
         opdn    = c2n2(opd);
       endsr;

       //********************************************************
       begsr init;
         //********************************************************
         open bridf;
         // Test innlogging
         chain wsuser bridf;
         *in50 = not %found;

         if *in50 = *off;
           if bilibl = *blanks;
             incgi ( bistdl );
           else;

             Monitor;
                   Varpgm();
                 On-Error;
                   //
                 EndMon;

           endif;
           open sveh;
         if *in50 = *off and *IN50 = *on;
         chain ( avdn : opdn ) sveh;
           endif;
           close sveh;
         else;

           error = 'Invalid userID';
         endif;

       endsr;
      /end-free
