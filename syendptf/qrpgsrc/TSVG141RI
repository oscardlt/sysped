      *********************************************************************
      *
CRTPG+*  CRTPGM SYSPED/TSVG141RI MODULE(*LIBL/TSVG141RI *LIBL/INCGI)
CRTPGM*        ACTGRP(*NEW) AUT(*USE)
      *
      *********************************************************************
      /copy SYSPEDS/qrpgsrcpy,hspecs
      /copy SYSPEDS/qrpgsrcpy,hspecsbnd
      *********************************************************************
     FBRIDF     IF   E           K DISK    USROPN
     FEDIM      IF   E           K DISK    USROPN
     FSVIH      IF   E           K DISK
     FFRISOK    IF A E           K DISK
     FFREETXT   O  A E           K DISK
      *--------------------------------------------------------------------
      * Variables common to all CGIs
      *--------------------------------------------------------------------
      /copy SYSPEDS/qrpgsrcpy,prototypeb
      /copy SYSPEDS/qrpgsrcpy,usec
      /copy SYSPEDS/qrpgsrcpy,variables3

     D WSUSER          S             10
     D UMMNA           S              9
     D UMMN            S              9S 0
     D JSONstring      s          32000
     D Error           S            150
     D AntLest         S              9  0

      *get input-string
      /copy syspeds/qrpgsrcpy,prolog3

      * Parse input
     C                   EXSR      Parse
      * Open files etc
     C                   EXSR      INIT

     C                   IF        Error = *blanks
     C     UMMN          CHAIN     EDIM                               51
     C                   IF        *IN51
     C                   EVAL      Error = 'Meddelande finns inte'
     C                   ENDIF
     C                   ENDIF

     c                   CALLP     gethtmlifs(
     C                             '/syspeddev/html/JSON.html':
     C                             '/CGITAG/')
     C                   CALLP     wrtsection('top')

      * ............................................................................................
      * skriv JSON-Object start..(alltid '{' + x ant param. m/komma mellom (IKKE komma etter siste))
      * ............................................................................................

      /free
        JSONstring='{'
        +'¬user¬ : ¬'+%trim(WSUSER)+'¬, '
        +'¬mmn¬ : ¬'+%trim(UMMNA)+'¬, '
        +'¬errMsg¬ : ¬'+%trim(Error)+'¬, ';
      /end-free
      * JSONfix escaper " i tekst,  for deretter å bytte ¬->"
     C                   CALL      'JSONFIX'
     C                   PARM                    JSONstring
     C                   CALLP     updHTMLvar('JSONstring':JSONstring)
     C                   CALLP     wrtsection('JSONlin')
      *
      * ............................................................................................
      * Skriv JSON-LISTE Start (en liste er EN parameter(fra [ til   )
      * ............................................................................................
     c                   EVAL      JSONstring ='"ZFL ING aktiviteter" : ['
     C                   CALLP     updHTMLvar('JSONstring':JSONstring)
     C                   CALLP     wrtsection('JSONlin')

      * Hæmta varukod/varukoder

     c     Error         IFEQ      *blanks
     C  N50              EXSR      SRA

     c                   endif
      * ............................................................................................
      * Skriv JSON-Liste/Array  Avslutning
      * ............................................................................................
     c                   EVAL      JSONstring =']'
     C                   CALLP     updHTMLvar('JSONstring':JSONstring)
     C                   CALLP     wrtsection('JSONlin')
      * ............................................................................................
      * Skriv JSON-string Avsluttning
      * ............................................................................................
     c                   EVAL      JSONstring ='}'
     C                   CALLP     updHTMLvar('JSONstring':JSONstring)
     C                   CALLP     wrtsection('JSONlin')

      * Quit
     C                   EXSR      Exit

      *=====================================================================
      * Close output html and quit
      *=====================================================================
     C     Exit          BEGSR
      * Lukk fil
     C                   CLOSE     BRIDF
     C  N50              CLOSE     EDIM

      * Do not delete the CALL to wrtsection with section name *fini.  It is needed
      * to ensure that all output html that has been buffered gets output.
     C                   CALLP     wrtsection('*fini')
      * Quit
     C                   MOVE      *ON           *INLR
     C                   ENDSR
      *
      *********************************************************
     C     Parse         BEGSR
      *********************************************************
      * Get input
     C                   EVAL      WSUSER  = zhbgetvar('USER')
     C                   EVAL      UMMNA = zhbgetvar('MMN')
     C                   EVAL      UMMN    = c2n2(UMMNA)
     c                   ENDSR
      *********************************************************
     C     INIT          BEGSR
      *********************************************************
     C                   OPEN      BRIDF
      * Test innlogging
     C     WSUSER        CHAIN     BRIDF                              50
     C     BILIBL        IFEQ      *blanks
     C                   CALLb     'INCGI'
     C                   PARM                    BISTDL
     C                   ELSE
     C                   CALL      BILIBL
     C                   end

     C  N50              OPEN      EDIM
     C   50              EVAL      Error = 'Invalid userID'
     C     *LIKE         DEFINE    SVIH_SYAV     WVIH_SYAV
     C     *LIKE         DEFINE    SVIH_SYOP     WVIH_SYOP
     C     *LIKE         DEFINE    FSSOK         WFSSOK
     C     *LIKE         DEFINE    FSKODE        WFSKODE
     C                   EVAL      WFSKODE='TID'
     C     SVIH_KEY      KLIST
     C                   KFLD                    WVIH_SYAV
     C                   KFLD                    WVIH_SYOP
     C     FRIKEY        KLIST
     C                   KFLD                    WVIH_SYAV
     C                   KFLD                    WVIH_SYOP
     C                   KFLD                    WFSKODE
     C                   KFLD                    WFSSOK
     C                   ENDSR
      *////////////////////////////////////////////////////////////
      * Skriv ut mm.mm                                        SRA /
      *////////////////////////////////////////////////////////////
     C     SRA           BEGSR
      *_________________
      * Finnes ærendet ?
      *"""""""""""""""""
     C                   MOVEL     M0062         WVIH_SYAV
     C     7             SUBST     M0062:5       M0062B            7
     C                   MOVE      M0062B        WVIH_SYOP
     C     SVIH_KEY      CHAIN     SVIH                               51
     C                   IF        *IN51 = *OFF
      *_________________
      * Skriv ut ærendet
      *"""""""""""""""""
     C                   MOVE      'C'           CALLTYP
     C                   MOVE      SVIH_SYAV     SVIHASYAV         4
     C                   MOVE      SVIH_SYOP     SVIHASYOP         7
     C                   CALL      'SVI006R'
     C                   PARM                    SVIHASYAV
     C                   PARM                    SVIHASYOP
     C                   PARM                    CALLTYP           1
      *__________________
      * Skriv till FRISOK
      *""""""""""""""""""
     C                   CLEAR                   FRISOKR
     C                   EVAL      FSAVD=WVIH_SYAV
     C                   EVAL      FSOPD=WVIH_SYOP
     C                   EVAL      FSKODE='TID'
     C                   MOVEL     MDT           FSDTOP
     C                   EVAL      FSDOKK='G'
     C                   EVAL      WATYPE='SI'
     C                   EVAL      WUSER=SVIH_SGID
     C                   MOVEL     SVIH_TUID     WFSSOK
     C     FRIKEY        CHAIN     FRISOK                             59
     C                   IF        *IN59
     C                   MOVEL     SVIH_TUID     FSSOK
     C     FSSOK         CAT       SVIH_MTYP:1   FSSOK
     C                   WRITE     FRISOKR
     C                   ENDIF
      *_____________________
      * Skriv til notatblokk
      *"""""""""""""""""""""
     C                   CLEAR                   FREETXTR
     C                   EVAL      FRTAVD = SVIH_SYAV
     C                   EVAL      FRTOPD = SVIH_SYOP
     C                   MOVEL     MDT           FRTDT
     C                   EVAL      FRTLI     = 5
     C                   EVAL      FRTTXT    = 'TULLID='
     C     FRTTXT        CAT       SVIH_TUID:1   FRTTXT
     C                   EVAL      FRTKOD    = 'G'
     C                   WRITE     FREETXTR
      *_________________________
      * Aktivera arkivfunktionen
      *"""""""""""""""""""""""""
     C                   CALL      'ARC002CLB'
     C                   PARM                    WATYPE            2
     C                   PARM                    WUSER            10

     C                   ENDIF

     C                   ENDSR
