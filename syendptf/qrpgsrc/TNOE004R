      *********************************************************************
      *
CRTPG+*  CRTPGM SYSPED/TNOE004R MODULE(*LIBL/TNOE004R *LIBL/INCGI)
CRTPGM*        ACTGRP(*NEW) AUT(*USE)
      *
      *********************************************************************
      /copy SYSPEDS/qrpgsrcpy,hspecs
      /copy SYSPEDS/qrpgsrcpy,hspecsbnd

     FBRIDF     IF   E           K DISK    USROPN
     FSAEH      IF   E           K DISK    USROPN
     FSTANDE    IF   E           K DISK    USROPN
     FEDIM2     IF   E           K DISK    USROPN
      *--------------------------------------------------------------------
      * Variables common to all CGIs
      *--------------------------------------------------------------------
      /copy SYSPEDS/qrpgsrcpy,prototypeb
      /copy SYSPEDS/qrpgsrcpy,usec
      /copy SYSPEDS/qrpgsrcpy,variables3
     ‚*  Prototype for 'JSONFIX'
     d jsonfix         pr                  extpgm('JSONFIX')
     d jsonstring_                         like(jsonstring)
      *
      * Varible for
     D WSUSER          S             10
     D AVD             S              4
     D AVDN            S              4  0
     D OPD             S              7
     D OPDN            S              7  0
     D MAX0B           S              8S 0 INZ(99999999)
     D MAX0C           S              6S 0 INZ(666666)
     D MAX0D           S              2S 0 INZ(99)
     D XINST           S              1
     D XBMI            S              1
     D WM1N07          S              3
     D WM3039E         S              6S 0
     D WM3039EO1       S              6S 0
     D WM3039EO2       S              6S 0
     D WM2005B         S              8S 0 INZ(0)
     D WM5004D         S             10S 0 INZ(0)
     D WMVEN           S              1
     D WM0035          S              1
     D WM9N01          S              1S 0 INZ(3)
     D JSONstring      s          32000
     D Error           S            150
     D AntLest         S              9  0

      *get input-string
      /copy syspeds/qrpgsrcpy,prolog3
      /free
         exsr Parse;
         exsr init;

       gethtmlifs(
       '/syspeddev/html/JSON.html':
       '/CGITAG/');
       wrtsection('top');

       //...........................................................................................
       //skriv JSON-Object start (alltid '{' + x ant param. m/komma mellom (IKKE komma etter siste))
       //...........................................................................................

        JSONstring='{'
        +'¬user¬ : ¬'+%trim(WSUSER)+'¬, '
        +'¬avd¬ : ¬'+%trim(%editc(AVDN:'Z'))+'¬, '
        +'¬opd¬ : ¬'+%trim(%editc(OPDN:'M'))+'¬, '
        +'¬errMsg¬ : ¬'+%trim(Error)+'¬, ';

       //JSONfix escaper " i tekst,  for deretter å bytte ¬->"

       jsonfix ( jsonstring );

       updhtmlvar2('JSONstring'
                  :%addr(jsonstring)
                  :%len(jsonstring));
       wrtsection('JSONlin');

       //...........................................................................................
       // Skriv JSON-LISTE Start (en liste er EN parameter(fra [ til   )
       //..........................................................................................
       jsonstring ='"getcmn" : [';

       updhtmlvar2('JSONstring'
                  :%addr(jsonstring)
                  :%len(jsonstring));
       wrtsection('JSONlin');

      /end-free
     c                   If        Error = *blanks

     C     AVDN          Chain     STANDE
     C                   Eval      WM0035 = S0035
     C                   Eval      WM3039E = S3039E
     C                   Eval      WM3039EO1 = S3039EO1
     C                   Eval      WM3039EO2 = S3039EO2

     C     SADKEY        Chain     SAEH
     C                   If        %Found(SAEH)

     C                   If        SETDN < 0
     C                   EVAL      WM1N07 = 'D  '
     C                   else
     C                   Exsr      GETVAR
     C                   endif
      * Skriv en JSON-Array-linje pr menypunkt - komma før hvert nytt element
      /free
          JSONstring=*blanks;
       JSONstring=%trim(JSONstring)+'{'
          +'¬m1N07¬  : ¬'+%trim(WM1N07)+'¬, '
          +'¬m3039e¬ : ¬'+%trim(%editc(WM3039E:'Z'))+'¬, '
          +'¬m3039eo1¬ : ¬'+%trim(%editc(WM3039EO1:'Z'))+'¬, '
          +'¬m3039eo2¬ : ¬'+%trim(%editc(WM3039EO2:'Z'))+'¬, '
          +'¬m2005b¬ : ¬'+%trim(%editc(WM2005B:'Z'))+'¬, '
          +'¬m5004d¬ : ¬'+%trim(%editc(WM5004D:'4'))+'¬, '
          +'¬m0035¬  : ¬'+%trim(WM0035)+'¬, '
          +'¬m9n01¬  : ¬'+%trim(%editc(WM9N01:'Z'))+'¬}';

       jsonfix ( jsonstring );

       updhtmlvar2('JSONstring'
                  :%addr(jsonstring)
                  :%len(jsonstring));

       wrtsection('JSONlin');

      /end-free

     C                   Endif
     c                   Endif
     c                   Eval      JSONstring =']'
     C                   Callp     updHTMLvar2('JSONstring'
     C                                         :%addr(JSONstring)
     C                                         :%len(JSONstring))
     C                   Callp     wrtsection('JSONlin')
      * Skriv JSON-string Avsluttning
     c                   Eval      JSONstring ='}'
     C                   Callp     updHTMLvar2('JSONstring'
     C                                         :%addr(JSONstring)
     C                                         :%len(JSONstring))
     C                   Callp     wrtsection('JSONlin')

     C                   Exsr      Exit

      *=====================================================================
      * Close output html and quit
      *=====================================================================
     C     Exit          Begsr
      * Lukk filer
     C                   If        %Found(BRIDF)
     C                   Close     SAEH
     C                   Close     STANDE
     C                   Close     EDIM2
     C                   Endif
     C                   Close     BRIDF

      * Do not delete the call to wrtsection with section name *fini.  It is needed
      * to ensure that all output html that has been buffered gets output.
     C                   Callp     wrtsection('*fini')
      * Quit
     C                   Eval      *INLR = *on
     C                   Endsr
      *********************************************************
     C     Parse         Begsr
      *********************************************************
      * Get input
     C                   Eval      WSUSER  = zhbgetvar('USER')
     C                   Eval      AVD     = zhbgetvar('AVD')
     C                   Eval      AVDN    = c2n2(AVD)
     C                   Eval      OPD     = zhbgetvar('OPD')
     C                   Eval      OPDN    = c2n2(OPD)
     c                   Endsr
      *********************************************************
     C     INIT          Begsr
      *********************************************************
      * Test innlogging
     C                   Open      BRIDF
     C     WSUSER        Chain     BRIDF
     C                   If        %Found
     C                   Open      SAEH
     C                   Open      EDIM2
     C                   Open      STANDE
     C                   Else
     C                   Eval      Error = 'Invalid userID'
     C                   Endif

     C     BILIBL        Ifeq      *blanks
     C                   Callb     'INCGI'
     C                   Parm                    BISTDL
     C                   Else
     C                   Call      BILIBL
     C                   Endif

     C     SADKEY        Klist
     C                   Kfld                    AVDN
     C                   Kfld                    OPDN
     C     SAEOMTHK      KLIST
     C                   Kfld                    AVDN
     C                   Kfld                    OPDN
     C     M2KDCK        Klist
     C                   Kfld                    AVDN
     C                   Kfld                    OPDN
     C                   Kfld                    MAX0B
     C                   Kfld                    MAX0C
     C                   Kfld                    MAX0D

     c                   Endsr
      *********************************************************
     C     GETVAR        Begsr
      *********************************************************
     C                   Eval      XBMI = 'N'
     C                   Eval      XINST = 'N'

      * FINNER SANSYNLIG MELDINGSTYPE UTFRA LOGGELEMENT

     C     M2KDCK        Setll     EDIM2

     C     STFMTY        Tag

     C     SADKEY        Readpe    EDIM2                                  33
     C  N33M1001         Ifeq      '929'
     C     MST           Oreq      'D'
     C     MSR           Oreq      'S'
     C     M1N07         Oreq      'DFI'
     C     M1N07         Oreq      'DII'
     C     M1N07         Oreq      'DPU'
     C     M1N07         Oreq      'DKO'
     C     M0068C        Oreq      0
     C     M0068C        Cabeq     0             STFMTY

     C     MSR           Ifeq      'S'
     C     XINST         Andeq     'N'

     C     M1N07         Ifeq      'DMA'
     C     M1N07         Oreq      'DEN'
     C                   Eval      XINST = 'J'
     C                   Endif

     C                   Endif

     C                   Goto      STFMTY

     C                   Else

     C     M1N07         Ifeq      'DME'
     C                   MOVE      'DKO'         WM1N07
     C                   ELSE
     C     M1N07         IFEQ      'DUA'
     C     SEMI          IFEQ      'I'
     C     XINST         OREQ      'J'
     C                   MOVE      'DEN'         WM1N07
     C                   MOVE      'J'           XBMI
     C                   ELSE
     C                   MOVE      'DKO'         WM1N07
     C                   END
     C                   ELSE
     C                   MOVE      '1'           *IN33
     C                   END
     C                   END
     C                   END                                                    1<-E
      *
     C                   IF        *IN33
     C                   IF        SEMI = 'I'
     C                   MOVE      'DFO'         WM1N07
     C                   ELSE
     C     SEDP          IFEQ      10
     C                   MOVE      'DFU'         WM1N07
     C                   ELSE
     C                   MOVE      'DMA'         WM1N07
     C                   ENDif
     C                   ENDIF
     C                   ENDIF
      *
     C                   Endsr
