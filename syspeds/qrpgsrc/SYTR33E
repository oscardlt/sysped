********************************************************************
      * RETTINGER I DETTE PROGRAM:
PTFnr:*Sek Sig Vers  Beskrivelse...........................
""""""*"""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""
11XXX * 01 JOV PTF11 Sikre kundenavn OM......
11XXX * 02 JOV PTF11 ved VF-dup chain HEKNSF i stedet for oppdrgiver for kundenavn
********************************************************************
     FDISPL19   UF   E           K DISK
     FFRISOK    IF   E           K DISK
     FFRISOL01  IF   E           K DISK
     F                                     RENAME(FRISOKR:FRISR01)
     FHEADF     IF   E           K DISK
     FCUNDL01   IF   E           K DISK
     FWST01     UF A E           K DISK
     FKODTP     if   e           k disk
     FDOKUF     UF A E           K DISK
     FDOKUFM    iF   E           K DISK
     FSYTR33EM  CF   E             WORKSTN
     F                                     SFILE(SUBFIL:ZRECNO)
     D                SDS
     D  ZJOB                 244    253
     D  ZUSER                254    263
     D  ZJOBNR               264    269  0
     D                 DS
     D  HXSNDN                 1     20
     D  HXSNEA                 1      3
     D  HXSN17                 4     20
     D  HXSN10                 1     10
     D                 DS
     D  WSTKEY                 1     39
     D  DS1_7                  1      7
     D  DS19_35               19     35
     D                 DS
     D  WSTFCC                 1     11  0
     D  DSÅR                   4      7  0
     D  DSMN                   8      9  0
     D  DSDG                  10     11  0
     D                 DS
     D  SFDATO                 1      8  0
     D  SFDG                   1      2  0
     D  SFMN                   3      4  0
     D  SFÅR                   5      8  0
     D                UDS
     D  UDSFIR                 1      2
     D  UDSAVD                15     18  0
      *____
      * Inz
      *""""
     c                   exsr      INIT
      *______________
      * Clear Subfile
      *""""""""""""""
     C     START1        TAG

     C                   MOVE      '1'           *IN93
     C                   MOVE      *BLANKS       SFNR
     C                   WRITE     SUBCTL
     C                   MOVEA     '00'          *IN(93)
     C                   Z-ADD     *ZEROS        ZRECNO
     C     KEYHEA        CHAIN     HEADF
      *_____________
      * Fyll Subfile
      *"""""""""""""
     C     WSTUNI        SETLL     WST01
     C     WSTUNI        READE     WST01                                  94
     C     *IN94         DOWEQ     '0'
     c                   z-add     wstkos        SFKUNR
N01  c                   move      *blanks       Knavn
     C     Kunkey        CHAIN     CUNDL01                            33
     c                   movel     Knavn         SFKnavn
     c                   move      DSÅR          SFÅR
     c                   move      DSMN          SFMN
     c                   move      DSDG          SFDG
      * sendnr først/sist    E_S =0672605 eller EDS=00000067 20061011 0672605
     c                   movel     *blanks       SFEDSN
     c     ds19_35       ifne      *blanks
     c                   movel     ds19_35       SFEDSN
     c                   else
     c                   movel     ds1_7         SFEDSN
     c                   end
     c                   z-add     wstint        SFAnt
      * WSTICC=0=Umerket (minst en av sendingene)  - Varsel
     c     WSTICC        comp      *zeros                                 55
     C                   ADD       1             ZRECNO
     C                   WRITE     SUBFIL
     C     WSTUNI        READE     WST01                                  94
     C  N94              ENDDO
     C                   IF        ZRECNO>0
     C                   EVAL      ZRECNO=1
     C                   ENDIF
      *________________
      * Display Subfile
      *""""""""""""""""
     C     START2        TAG

     C                   MOVE      *OFF          *IN51
     C                   MOVEA     '11'          *IN(91)
     C* KOMMER HIT VED TOM FIL
     C     ZRECNO        IFEQ      0
     C                   MOVE      *OFF          *IN94
     C                   ADD       1             ZRECNO
     C                   MOVE      *ON           *IN51
     C                   WRITE     SUBFIL
     C                   SETON                                        94
     C                   ENDIF
     C                   WRITE     WIND01
     C                   WRITE     BUNN
     C     STBUNN        TAG

     C                   EXFMT     SUBCTL

     C                   SETOFF                                       999830
      * FORRIGE
     C   12              GOTO      SLUTT

      * Utført Option...
     C     ZRECNO        IFNE      0
     c                   move      *zeros        AntBrev           5 0
     C                   MOVE      *OFF          *IN98
     C     *IN98         DOWEQ     '0'
     C                   READC     SUBFIL                                 98
      * Vis detaljer
     C     SFNR          IFEQ      '1'
     C                   movel     WSTKEY        USOK
     C                   move      WSTKEY        UKODE
     C                   EVAL      SFNR=*BLANKS
     C                   GOTO      slutt
     C                   ENDIF
      * Print foreløpige fraktbrev..
     C     SFNR          IFEQ      '6'
     C                   EVAL      SFNR=*BLANKS
     C                   movel     WSTKEY        FSSOK
     C                   move      WSTKEY        FSKODE
     C     FriL01Key     SETLL     Frisol01
     C     FriL01Key     READE     Frisol01                               33
     C     *IN33         DOWEQ     '0'
     C                   exsr      PrtFbr
     C     FriL01Key     READE     Frisol01                               33
     C                   END
     C                   ENDIF
      * Print foreløpige fraktbrev..
     C     SFNR          IFEQ      '7'
     C                   EVAL      SFNR=*BLANKS
     C                   call      'SYFA48CLE'
     C                   parm                    WSTKEY
     C                   ENDIF
     C                   ENDDO
      **
     C                   GOTO      START1
     C                   ENDIF
      *
     C     SLUTT         TAG
     c                   exsr      delwrk
      *
     C                   SETON                                        LR
     C                   RETURN
      *
      ************************************************************
     C     DELWRK        BEGSR
      ************************************************************
      *
     C     WSTUNI        SETLL     WST01
     C     WSTUNI        READE     WST01                                  33
     C     *IN33         DOWEQ     '0'
     C                   DELETE    WST01R
     C     WSTUNI        READE     WST01                                  33
     C                   END
     C                   ENDSR
      *
      *_____________________________________________________
      * INIT
      *"""""""""""""""""""""""""""""""""""""""""""""""""""""
     C     INIT          BEGSR
      *
     C     *ENTRY        PLIST
     C                   PARM                    Uterm             4 0
     C                   PARM                    UKODE
     C                   PARM                    USOK
     C     *LIKE         DEFINE    FSKODE        UKODE
     C     *LIKE         DEFINE    FSSOK         USOK
     C     Frikey1       KLIST
     C                   KFLD                    DIAVD
     C                   KFLD                    DIOPD
     C                   KFLD                    XXEDS
     C                   MOVE      'EDS'         XXEDS             3
     C     Frikey2       KLIST
     C                   KFLD                    DIAVD
     C                   KFLD                    DIOPD
     C                   KFLD                    XXE_S
     C                   MOVE      'E_S'         XXE_S             3
     C     FriL01Key     KLIST
     C                   KFLD                    FSKODE
     C                   KFLD                    FSSOK
     C     KEYHEA        KLIST
     C                   KFLD                    FSAVD
     C                   KFLD                    FSOPD
     C     KEYFBR        KLIST
     C                   KFLD                    XXRI              1
     C                   KFLD                    FSAVD
     C                   KFLD                    FSOPD
     C                   KFLD                    XXFBNR            3 0
     C                   move      'F'           XXRI              1
     C                   z-add     1             XXFBNR            3 0
     C     KUNKEY        KLIST
     C                   KFLD                    UDSFIR
     C                   KFLD                    SFKUNR
     C     KODTPK        KLIST
     C                   KFLD                    WSPUNI
     C                   KFLD                    UDSAVD
     C                   KFLD                    WSPLNR
     C                   MOVE      'P'           WSPUNI            1
     C                   Z-ADD     113           WSPLNR            3 0
     C                   MOVEL     'QPRINT'      XXPRT            10
     C                   MOVEL     '*STD  '      XXPT             10
     C     KODTPK        CHAIN     KODTP                              33
     C  N33              MOVE      KOPNVN        XXPRT
     C  N33              MOVE      KOPTY         XXPT
     C     WKEY          KLIST
     C                   KFLD                    WSTUNI
     C                   KFLD                    WSTKEY
      * INITIER NUMERISKE DS-FELT
     C                   CLEAR                   WST01R
     C                   CLEAR                   SFDATO
      * "Låner" workfile WST01 for å lager/telle opp antall frie søkeveier...
     C                   MOVEL     ZJOBNR        WSTUNI
     c                   exsr      delwrk
      *
      * fjern E-status på de som er på tur
     C     D19Key        KLIST
     C                   KFLD                    xxsta1            1
     C                   KFLD                    XXTUR             8 0
     C                   move      'E'           xxsta1
     C     D19Key        SETGT     Displ19
     C     'E'           READE     Displ19                                94
     c     *in94         doweq     '0'
     C                   move      ' '           DISTA1
     c                   update    DISPR
     C     'E'           READE     Displ19                                94
     c                   end
      *
      *
     C     'E'           SETLL     Displ19
     C     'E'           READE(N)  Displ19                                94
     C     *IN94         DOWEQ     '0'
     C     UTERM         IFNE      *ZEROS
BHR  C     UTERM         IFEQ      3000
BHR  C     DIAVD         CABGT     8000          NEXT
BHR  C                   ELSE
BHR  C     DIAVD         CABLT     8000          NEXT
BHR  C                   END
     C                   END
     c     Frikey1       Chain     Frisok                             33
     c   33Frikey2       Chain     Frisok                             33
     c     *in33         cabeq     '1'           Next
     C     KEYHEA        CHAIN     HEADF                              33
     c     *in33         cabeq     '1'           Next
     c                   movel     FSSOK         WSTKey
     c                   move      FSKODE        WSTKey
     c     KeyFbr        Chain     DOKUFM                             34
     c     WKEY          Chain     WST01                              33
     c     *in33         ifeq      '1'
     c                   z-add     1             WSTINT                         INT=Ant oppdr
     c                   z-add     TRKNFA        WSTKOS                         KOS=Kunde
N02  c     TRSLAG        ifeq      'VF'
N02  c     Heknsf        ifne      *zeros
N02  c                   z-add     HEKNSF        WSTKOS                         KOS=Kunde
N02  c                   else
N02  c                   z-add     HEKNKF        WSTKOS                         KOS=Kunde
N02  c                   endif
N02  c                   endif
     c                   z-add     HEDTR         WSTFCC                         FCC=Dato
     c   34              MOVE      *zeros        WSTICC                         ICC=0=Umerket
     c  N34              z-add     1             WSTICC                         ICC=1=merket
     c                   write     WST01R
     c                   else
     c                   add       1             WSTINT
     c   34              MOVE      *zeros        WSTICC                         ICC=0=Umerket
     c                   update    WST01R
     c                   end
     c     Next          tag
     C     'E'           READE(N)  Displ19                                94
     C                   END
      *
     C                   ENDSR
     C***********************************************
     C     PrtFbr        BEGSR
     C***********************************************
     c     KeyHea        Chain     Headf                              33
     c     *in33         cabeq     '1'           SLFbr
      * IKKE dersom kolli-ID allerede finnes.
     c     KeyFbr        Chain     DOKUFM                             33
     c     *in33         cabeq     '0'           SLFbr
      * sjekk om Fraktbrev allerede finnes
     c     KeyFbr        Chain(N)  DOKUF                              33
     C     *in33         ifeq      '0'
     C     DFST          IFEQ      'P'
     c                   Move      'N'           FbrSkapt          1
     c                   goto      PrtBrev
     c                   else
     c     KeyFbr        Chain     DOKUF                              33
     c  N33              Delete    DOKUFR
     c                   Move      'J'           FbrSkapt          1
     c                   end
     c                   else
     c                   Move      'J'           FbrSkapt          1
     c                   end
      *  Finnes ikke - Skap midlertidig...
     C                   CLEAR                   DOKUFR
      *
     C                   MOVE      ' '           DFST
     C                   MOVE      HEKNS         DFKNSS
     C                   MOVE      HENAS         DFNAVS
     C                   MOVE      HEADS1        DFAD1S
     C                   MOVE      *BLANKS       DFAD2S
     C                   MOVEL     HEADS3        TMPPUL            4
     C                   TESTN                   TMPPUL               77
     C     *IN77         IFEQ      '1'
     C                   MOVE      TMPPUL        DFPNLS                          LASTESTED
     C                   MOVE      HEADS3        TMPAD3           25
     C                   MOVEL     TMPAD3        DFAD3S
     C                   ELSE
     C                   MOVEL     HEADS3        DFAD3S
     C                   END
     C                   MOVEL     HERFA         DFSREF
     C                   MOVE      HENT          DFNTLA
     C                   MOVE      HENAK         DFNAVL
     C                   MOVE      HEADK1        DFAD1L
     C                   MOVE      *BLANKS       DFAD2L
     C                   MOVEL     HEADK3        TMPPUL            4
     C                   TESTN                   TMPPUL               77
     C     *IN77         IFEQ      '1'
     C                   MOVE      TMPPUL        DFPOUL                          UTL.POSTNR
     C                   MOVE      HEADK3        TMPAD3           25
     C                   MOVEL     TMPAD3        DFADUL                          UTL.STED
     C                   ELSE
     C                   MOVEL     HEADK3        DFADUL
     C                   END
     C                   MOVE      HEKNK         DFKNSM
     C                   MOVE      HENAK         DFNAVM
     C                   MOVE      HEADK1        DFAD1M
     C                   MOVE      HEADK3        DFAD3M
     C                   MOVEL     HEGM1         DFGM
     C                   MOVE      HENT          DFNT
     C                   MOVE      HEVS1         DFVS
     C                   MOVE      HEVKT         DFVKT
     C                   MOVE      HELM          DFLM
     C                   MOVE      HEM3          DFM3
     C                   MOVEL     HEGM2         DFGM2
     C                   MOVEL     HEVS2         DFVS2
     C                   MOVE      HEFBV         DFVKTF
     C                   MOVE      HESG          DFSG
     C                   MOVE      'F'           DFRI
     C                   MOVE      HEAVD         DFAVD
     C                   MOVE      HEOPD         DFOPD
     C                   Z-ADD     1             DFFBNR
     C     HXSNEA        IFEQ      '401'
     C     HXSNEA        OREQ      '402'
     C                   MOVEL     HXSN17        DF1004
     C                   ELSE
     C                   MOVEL     HXSN10        DF1004
     C                   END
     C*
     C                   WRITE     DOKUFR
     C*
     C     PrtBrev       tag
     C*
     c                   add       1             AntBrev
     c                   move      HEAVD         AAAVD             4
     c                   move      HEOPD         AAOPD             7
     C                   CALL      'SYFA12CT1'
     C                   PARM                    AAAVD
     C                   PARM                    AAOPD
     C                   PARM                    XXPRT
     C                   PARM                    XXPT
     C*
      * Hvis FBR finnes og status er åpen - slett det
      * (lestteste måten å sikrer at endelig fbr blir riktigst mulig basrt på headf)
     c     KeyFbr        Chain     DOKUF                              33
     c     *in33         IFEQ      *OFF
     c     DFST          IFEQ      ' '
     c*    FbrSkapt      andeq     'J'
     c                   delete    dokufr
     c                   END
     c                   END
     c
     C     SlFbr         ENDSR
