      *********************************************************************
      *
CRTPG+*  CRTPGM SYSPED/TNCI012R MODULE(*LIBL/TNCI012R *LIBL/INCGI)
CRTPGM*        ACTGRP(*NEW) AUT(*USE)
      *
      *********************************************************************
      /copy SYSPEDS/qrpgsrcpy,hspecs
      /copy SYSPEDS/qrpgsrcpy,hspecsbnd
      *********************************************************************
     FBRIDF     IF   E           K DISK    USROPN
     FSVNV      UF A E           K DISK    USROPN
     F                                     PREFIX(X)
     FSVNVCN    UF A E           K DISK    USROPN
     F                                     PREFIX(XV_)
      *--------------------------------------------------------------------
      * Variables common to all CGIs
      *--------------------------------------------------------------------
      /copy SYSPEDS/qrpgsrcpy,prototypeb
      /copy SYSPEDS/qrpgsrcpy,usec
      /copy SYSPEDS/qrpgsrcpy,variables3
      *
      * Varible for
     D WSUSER          S             10
     D TVAVD_A         S              4
     D TVAVD           S              4  0
     D TVTDN_A         S              7
     D TVTDN           S              7  0
     D TVLI_A          S              5
     D TVLI            S              5  0
     D WMODE           S              2
     D TVVNT_A         S              8
     D TVST            S             35
     D TVSTSK          S              2
     D TVSTLK          S              2
     D TVCTL_A         S              1
     D TVCTL           S              1  0
     D TVFLG_A         S              1
     D TVFLG           S              1  0
     D TVINF1          S             70
     D TVINF2          S             70
     D TVINF3          S             70
     D TVINF4          S             70
     D TVINSK          S              2
     D TVGDT_A         S              8
     D TVGDT           S              8  0
     D TVGM            S             35
     D TVGMSK          S              2
     D TVGMST          S             35
     D TVGMSS          S              2
     D TVGMLK          S              2
     D TVDANT_A        S              3
     D TVDANT          S              3  0
     D TVDFKD          S             20
     D TVDFSK          S              2
     D TVTAID          S             27
     D TVTASK          S              2
     D TVTALK          S              2
     D TVGODT_A        S              8
     D TVGODT          S              8  0
     D TVOM            S             35
     D TVOMSK          S              2
     D TVOMST          S             35
     D TVOMSS          S              2
     D TVOMLK          S              2
     D TVCNR           S             17
     D JSONstring      S          32000
     D Error           S            150
     D                 DS
     D  TVCNR2                 1     17
     D  TVCNR3                18     34
     D  TVCNR4                35     51
     D  TVCNR5                52     68
     D  TVCNR6                69     85
     D  CN                     1     85    DIM(5)

      *get input-string
      /copy syspeds/qrpgsrcpy,prolog3

      * Parse input
     C                   EXSR      Parse
      * Open files etc
     C                   EXSR      INIT
      *
     c                   callp     gethtmlifs(
     C                             '/syspeddev/html/JSON.html':
     C                             '/CGITAG/')
     C                   callp     wrtsection('top')
      * Teste input og utfør
     C                   EXSR      TEST

      * ............................................................................................
      * skriv JSON-Object start..(alltid '{' + x ant param. m/komma mellom (IKKE komma etter siste))
      * ............................................................................................
      *
      /free
        JSONstring='{'
        +'¬user¬ : ¬'+%trim(WSUSER)+'¬, '
        +'¬tvavd¬ : ¬'+%trim(%editc(tvavd:'Z'))+'¬, '
        +'¬tvtdn¬ : ¬'+%trim(%editc(tvtdn:'Z'))+'¬, '
        +'¬tvli¬ : ¬'+%trim(%editc(tvli:'Z'))+'¬, '
        +'¬mode¬ : ¬'+%trim(WMODE)+'¬, '
        +'¬errMsg¬ : ¬'+%trim(Error)+'¬, ';
      /end-free
      * JSONfix escaper " i tekst,  for deretter å bytte ¬->"
     c                   call      'JSONFIX'
     c                   parm                    JSONstring
     C                   CALLP     updHTMLvar2('JSONstring'
     C                                         :%addr(JSONstring)
     C                                         :%len(JSONstring))
     C                   callp     wrtsection('JSONlin')
      *
      * ............................................................................................
      * Skriv JSON-LISTE Start (en liste er EN parameter(fra [ til   )
      * ............................................................................................
     c                   eval      JSONstring ='"lineupdate" : ['
     C                   CALLP     updHTMLvar2('JSONstring'
     C                                         :%addr(JSONstring)
     C                                         :%len(JSONstring))
     C                   callp     wrtsection('JSONlin')
      * ............................................................................................
      * Skriv JSON-Liste/Array  Avslutning
      * ............................................................................................
     c                   eval      JSONstring =']'
     C                   CALLP     updHTMLvar2('JSONstring'
     C                                         :%addr(JSONstring)
     C                                         :%len(JSONstring))
     C                   callp     wrtsection('JSONlin')
      * ............................................................................................
      * Skriv JSON-string Avsluttning
      * ............................................................................................
     c                   eval      JSONstring ='}'
     C                   CALLP     updHTMLvar2('JSONstring'
     C                                         :%addr(JSONstring)
     C                                         :%len(JSONstring))
     C                   callp     wrtsection('JSONlin')
      *
      * Quit
     C                   exsr      Exit


      *=====================================================================
      * Close output html and quit
      *=====================================================================
     C     Exit          begsr
      * Lukk fil
     C                   CLOSE     BRIDF
     C  N50              CLOSE     SVNV
     C  N50              CLOSE     SVNVCN

      * Do not delete the call to wrtsection with section name *fini.  It is needed
      * to ensure that all output html that has been buffered gets output.
     C                   callp     wrtsection('*fini')
      * Quit
     C                   MOVE      *ON           *INLR
     C                   return
     C                   endsr
      *
      *********************************************************
     C     Parse         Begsr
      *********************************************************
      * Get input
     C                   EVAL      WSUSER  = zhbgetvar('USER')
     C                   EVAL      TVAVD_A   = zhbgetvar('AVD')
     C                   EVAL      TVAVD     = c2n2(TVAVD_A)
     C                   EVAL      TVTDN_A   = zhbgetvar('OPD')
     C                   EVAL      TVTDN     = c2n2(TVTDN_A)
     C                   EVAL      TVLI_A    = zhbgetvar('LIN')
     C                   EVAL      TVLI      = c2n2(TVLI_A)
     C                   EVAL      WMODE     = zhbgetvar('MODE')
     C                   EVAL      TVST      = zhbgetvar('TVST')
     C                   EVAL      TVSTSK    = zhbgetvar('TVSTSK')
     C                   EVAL      TVSTLK    = zhbgetvar('TVSTLK')
     C                   EVAL      TVCTL_A   = zhbgetvar('TVCTL')
     C                   EVAL      TVCTL     = c2n2(TVCTL_A)
     C                   EVAL      TVFLG_A   = zhbgetvar('TVFLG')
     C                   EVAL      TVFLG     = c2n2(TVFLG_A)
     C                   EVAL      TVINF1    = zhbgetvar('TVINF1')
     C                   EVAL      TVINF2    = zhbgetvar('TVINF2')
     C                   EVAL      TVINF3    = zhbgetvar('TVINF3')
     C                   EVAL      TVINF4    = zhbgetvar('TVINF4')
     C                   EVAL      TVINSK    = zhbgetvar('TVINSK')
     C                   EVAL      TVGDT_A   = zhbgetvar('TVGDT')
     C                   EVAL      TVGDT     = c2n2(TVGDT_A)
     C                   EVAL      TVGM      = zhbgetvar('TVGM')
     C                   EVAL      TVGMST    = zhbgetvar('TVGMST')
     C                   EVAL      TVGMSK    = zhbgetvar('TVGMSK')
     C                   EVAL      TVGMSS    = zhbgetvar('TVGMSS')
     C                   EVAL      TVGMLK    = zhbgetvar('TVGMLK')
     C                   EVAL      TVDANT_A  = zhbgetvar('TVDANT')
     C                   EVAL      TVDANT    = c2n2(TVDANT_A)
     C                   EVAL      TVDFKD    = zhbgetvar('TVDFKD')
     C                   EVAL      TVDFSK    = zhbgetvar('TVDFSK')
     C                   EVAL      TVTAID    = zhbgetvar('TVTAID')
     C                   EVAL      TVTASK    = zhbgetvar('TVTASK')
     C                   EVAL      TVTALK    = zhbgetvar('TVTALK')
     C                   EVAL      TVGODT_A  = zhbgetvar('TVGODT')
     C                   EVAL      TVGODT    = c2n2(TVGODT_A)
     C                   EVAL      TVOM      = zhbgetvar('TVOM')
     C                   EVAL      TVOMSK    = zhbgetvar('TVOMSK')
     C                   EVAL      TVOMST    = zhbgetvar('TVOMST')
     C                   EVAL      TVOMSS    = zhbgetvar('TVOMSS')
     C                   EVAL      TVOMLK    = zhbgetvar('TVOMLK')
     C                   EVAL      TVCNR     = zhbgetvar('TVCNR')
     C                   EVAL      TVCNR2    = zhbgetvar('TVCNR2')
     C                   EVAL      TVCNR3    = zhbgetvar('TVCNR3')
     C                   EVAL      TVCNR4    = zhbgetvar('TVCNR4')
     C                   EVAL      TVCNR5    = zhbgetvar('TVCNR5')
     C                   EVAL      TVCNR6    = zhbgetvar('TVCNR6')
     c                   ENDSR
      *********************************************************
     C     INIT          Begsr
      *********************************************************
     C                   OPEN      BRIDF
      * Test innlogging
     C     WSUSER        CHAIN     BRIDF                              50
     C     BILIBL        ifeq      *blanks
     C                   callb     'INCGI'
     C                   parm                    BISTDL
     C                   else
     C                   call      BILIBL
     C                   end
      *
     C     SVNVKey       klist
     C                   kfld                    TVAVD
     C                   kfld                    TVTDN
     C                   kfld                    TVLI
      *
     C   50              eval      Error = 'Invalid userID'
     C  N50              OPEN      SVNV
     C  N50              OPEN      SVNVCN

     c                   endsr
      *
      *______________________________________________________
      * TEST                                             TEST
      *""""""""""""""""""""""""""""""""""""""""""""""""""""""
     C     TEST          BEGSR
     C     WMODE         IFNE      'A'
     C     SVNVKey       CHAIN     SVNV                               55
     C                   ENDIF
      * MODE A=Add  D=Delete  U=Update
     C                   SELECT
     C     WMODE         WHENEQ    'A'
     C                   eval      Error = *blanks
     C                   EXSR      SRA
     C     WMODE         WHENEQ    'D'
     C                   IF        *IN55=*ON
     C                   eval      Error = 'Order not found'
     C                   ELSE
     C                   eval      Error = *blanks
     C                   EXSR      SRD
     C                   ENDIF
     C     WMODE         WHENEQ    'U'
     C                   IF        *IN55=*ON
     C                   eval      Error = 'Order not found'
     C                   ELSE
     C                   eval      Error = *blanks
     C                   EXSR      SRU
     C                   ENDIF
     C                   OTHER
     C                   eval      Error = 'Wrong mode'
     C                   ENDSL
     C                   ENDSR
      *______________________________________________________
      * Add                                               SRA
      *""""""""""""""""""""""""""""""""""""""""""""""""""""""
     C     SRA           BEGSR
     C                   CLEAR                   SVNVR
     C                   EVAL      XTVAVD  = TVAVD
     C                   EVAL      XTVTDN  = TVTDN
     C                   EVAL      XTVLI   = TVLI
     C                   WRITE     SVNVR
      *
     C                   ENDSR
      *______________________________________________________
      * Delete                                            SRD
      *""""""""""""""""""""""""""""""""""""""""""""""""""""""
     C     SRD           BEGSR
     C                   DELETE    SVNVR
      *
     C     SVNVKey       SETLL     SVNVCN
     C     SVNVKey       READE     SVNVCN                                 33
     C                   DOW       *IN33 = *OFF
     C                   DELETE    SVNVCNR
     C     SVNVKey       READE     SVNVCN                                 33
     C                   ENDDO
      *
     C     SVNVKey       SETLL     SVNVCN
     C     SVNVKey       READE     SVNVCN                                 33
     C                   DOW       *IN33 = *OFF
     C                   DELETE    SVNVCNR
     C     SVNVKey       READE     SVNVCN                                 33
     C                   ENDDO
      *
     C                   ENDSR
      *______________________________________________________
      * Update                                            SRU
      *""""""""""""""""""""""""""""""""""""""""""""""""""""""
     C     SRU           BEGSR
     C                   EVAL      XTVST   = TVST
     C                   EVAL      XTVSTSK = TVSTSK
     C                   EVAL      XTVSTLK = TVSTLK
     C                   EVAL      XTVCTL  = TVCTL
     C                   EVAL      XTVFLG  = TVFLG
     C                   EVAL      XTVINF1 = TVINF1
     C                   EVAL      XTVINF2 = TVINF2
     C                   EVAL      XTVINF3 = TVINF3
     C                   EVAL      XTVINF4 = TVINF4
     C                   EVAL      XTVINSK = TVINSK
     C                   EVAL      XTVGDT  = TVGDT
     C                   EVAL      XTVGM   = TVGM
     C                   EVAL      XTVGMSK = TVGMSK
     C                   EVAL      XTVGMST = TVGMST
     C                   EVAL      XTVGMSS = TVGMSS
     C                   EVAL      XTVGMLK = TVGMLK
     C                   EVAL      XTVDANT = TVDANT
     C                   EVAL      XTVDFKD = TVDFKD
     C                   EVAL      XTVDFSK = TVDFSK
     C                   EVAL      XTVTAID = TVTAID
     C                   EVAL      XTVTASK = TVTASK
     C                   EVAL      XTVTALK = TVTALK
     C                   EVAL      XTVGODT = TVGODT
     C                   EVAL      XTVOM   = TVOM
     C                   EVAL      XTVOMSK = TVOMSK
     C                   EVAL      XTVOMST = TVOMST
     C                   EVAL      XTVOMSS = TVOMSS
     C                   EVAL      XTVOMLK = TVOMLK
     C                   EVAL      XTVCNR  = TVCNR
     C                   UPDATE    SVNVR
      *
     C     SVNVKey       SETLL     SVNVCN
     C     SVNVKey       READE     SVNVCN                                 33
     C                   DOW       *IN33 = *OFF
     C                   DELETE    SVNVCNR
     C     SVNVKey       READE     SVNVCN                                 33
     C                   ENDDO
     C                   EVAL      XV_TVAVD  = XTVAVD
     C                   EVAL      XV_TVTDN  = XTVTDN
     C                   EVAL      XV_TVLI   = XTVLI
     C     1             DO        5             XN                3 0
     C                   IF        CN(XN) <> *BLANKS
     C                   EVAL      XV_TVCNR  = CN(XN)
     C                   WRITE     SVNVCNR
     C                   END
     C                   ENDDO
      *
     C                   ENDSR
      *
