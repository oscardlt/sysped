      *********************************************************************
      * TKsmart, logg over innlogging m/parametre(setting mm)
      *********************************************************************
CRTPG+*  CRTPGM SYSPED/ESTK543L MODULE(*LIBL/ESTK543L *LIBL/INCGI)
CRTPGM*         ACTGRP(*NEW) AUT(*USE)
      *
********************************************************************
      * RETTINGER I DETTE PROGRAM:
PTFnr:*Sek Sig Vers  Beskrivelse...........................
""""""*"""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""
10XXX * 01 JOV PTF12 Nytt prog for Â tracke GPS-sendin-problemer mm
********************************************************************
      /copy syspeds/qrpgsrcpy,hspecs
      /copy syspeds/qrpgsrcpy,hspecsbnd
     FBRIDF     IF   E           K DISK    USROPN
     FTKSMLOG   UF A E           K DISK    USROPN
      *********************************************************************
      *--------------------------------------------------------------------
      * Variables common to all CGIs
      *--------------------------------------------------------------------
      /copy syspeds/qrpgsrcpy,prototypeb
      /copy syspeds/qrpgsrcpy,usec
      /copy syspeds/qrpgsrcpy,variables3
     D JSONstring      s          32000
      * Indicators for GetHtmlIfsMult subprocedure
     D IfsMultIndicators...
     D                 ds
     D  NoErrors                       n
     D  NameTooLong                    n
     D  NotAccessible                  n
     D  NoFilesUsable                  n
     D  DupSections                    n
     D  FileIsEmpty                    n

      *
     D Spaces          s             12a   inz('&nbsp;&nbsp;')
      *
     D                 DS
     D XULTID                  1     14  0
     D  XULTM                  1      6  0
     D  XULDD                  7      8  0
     D  XULMM                  9     10  0
     D  XUL≈≈                 11     14  0
     D                 DS
     D ULDT                    1      8  0
     D  UL≈≈                   1      4  0
     D  ULMM                   5      6  0
     D  ULDD                   7      8  0
      /copy syspeds/qrpgsrcpy,prolog3
      *
      * Parse input / cvt to numeric
     C                   exsr      Parse
      * Read output skeleton html member into memory
     C                   exsr      LoadHtml
      * File open / keys
     C                   EXSR      INIT
      * Set section variables
     C                   exsr      SetAll
      * Quit
     C                   exsr      Exit
      *
     C                   eval      *inlr = *on
     C                   return
      *
      *
      *=====================================================================
      * Parse input / cvt to numeric
      *=====================================================================
     C     Parse         begsr
      * leg rett i filvariable - kun output
     C                   eval      TKSUSR = zhbgetvar('userId')
     C                   eval      TKSUSR = uppify(TKSUSR)
     C                   eval      TKSLVL = zhbgetvar('level')
N05  C                   eval      TKSEVE = zhbgetvar('event')
N01  C                   eval      TKSTRA = zhbgetvar('transportor')
N01  C                   eval      TKSMSG = zhbgetvar('message')
     C                   endsr
      *=====================================================================
      * Close output html and quit
      *=====================================================================
     C     Exit          begsr
      * Do not delete the call to wrtsection with section name *fini.  It is needed
      * to ensure that all output html that has been buffered gets output.
     C                   callp     wrtsection('*fini')
      * Quit
     c                   close     BRIDF
     c                   close     TKSMLOG
     C                   endsr
      *=====================================================================
      * Read output skeleton html member into memory
      *=====================================================================
     C     LoadHtml      begsr
     c                   callp     gethtmlifs(
     C                             '/syspeddev/html/JSON.html':
     C                             '/CGITAG/')
     C                   endsr
      *=====================================================================
      *  Set variable data for section /$top , lin , Bot
      *=====================================================================
     C     SetAll        begsr
      * er skrevet rett til filvariable i Parse/timestamp i INIT  -  kun output til loggfil
     c                   write     TKSMLOGR
      *
      /free
        wrtsection('top');

        JSONstring='{'
        +'"userId" : "'+%trim(TKSUSR)+'", '
        +'"error" : "'+''+'" }';
        updHTMLvar2('JSONstring':%addr(JSONstring):%len(JSONstring));
        wrtsection('JSONlin');

        wrtsection('*fini');
      /end-free
      *
     C
     C                   endsr
      *
      *=====================================================================******
      *  INITIER
      *=====================================================================******
     C     INIT          begsr
     C                   OPEN      BRIDF
     C     TKSUSR        CHAIN     BRIDF                              50
      * Ukjent UserID
     c     *in50         ifeq      '1'
     C                   close     BRIDF
      /free
        wrtsection('top');

        JSONstring='{'
        +'"userId" : "'+%trim(TKSUSR)+'", '
Exx     +'"error" : "Incorrect userId or password." }';
        updHTMLvar2('JSONstring':%addr(JSONstring):%len(JSONstring));
        wrtsection('JSONlin');

        wrtsection('*fini');
      /end-free
     C                   eval      *inlr = *on
     C                   return
     c                   endif
     C* En "standardvariant" libl: call bound (INCGI=*MODULE) med parameter.
     C     BILIBL        ifeq      *blanks
     C                   callb     'INCGI'
     C                   parm                    BISTDL
     C                   else
     C* Helt egen bibl.liste satt pÂ user - normal CALL (BILIBL er "*pgm")
     C                   call      BILIBL
     C                   end
     c                   open      TKSMLOG
      *
     C                   TIME                    XULTID
     C                   MOVE      XULDD         ULDD
     C                   MOVE      XULMM         ULMM
     C                   MOVE      XUL≈≈         UL≈≈
      * Timestamp for loggen
     C                   MOVEL     ULDT          TKSTS
     C                   MOVE      XULTM         TKSTS
      *
     C     UtInit        endsr
