      *********************************************************************
      *
CRTPG+*  CRTPGM SYSPED/SYXML33 MODULE(*LIBL/SYXML33 *LIBL/INCGI)
CRTPGM*        ACTGRP(*NEW) AUT(*USE)
      *
      *********************************************************************
      /copy SYSPEDS/qrpgsrcpy,hspecs
      /copy SYSPEDS/qrpgsrcpy,hspecsbnd
      *********************************************************************
     FBRIDF     IF   E           K DISK    USROPN
     FXMLUFL2   IF   E           K DISK    USROPN
     FFAIN      IF   E           K DISK    USROPN
     FFAK9      IF   E           K DISK    USROPN
     FHEADF     IF   E           K DISK    USROPN
     FEDIM2     IF   E           K DISK    USROPN
     FEDIS      IF   E           K DISK    USROPN
     FARKIVL06  IF   E           K DISK    USROPN
     FFIRM      IF   E           K DISK    USROPN
     FFIRMARC   IF   E           K DISK    USROPN
     FARKTXT    IF   E           K DISK    USROPN
     FARKEXT    IF   E           K DISK    USROPN
      *--------------------------------------------------------------------
      * Variables common to all CGIs
      *--------------------------------------------------------------------
      /copy SYSPEDS/qrpgsrcpy,prototypeb
      /copy SYSPEDS/qrpgsrcpy,usec
      /copy SYSPEDS/qrpgsrcpy,variables3
      *
      * Varible for
     D WSUSER          S             10
     D ST              S              1
     D AVD             S              4
     D AVDN            S              4S 0
     D FKN             S              8
     D FKNN            S              8S 0
     D FN              S              7
     D FNN             S              7S 0
     D DTF             S              8
     D DTFN            S              8S 0
     D DTT             S              8
     D DTTN            S              8S 0
     D RFA             S             35
     D RFAMAX          S             35
     D JSONstring      s          32000
     D Error           S            150
     D AntLest         S              9  0
     D UC              C                   CONST('ABCDEFGHIJKLMNOPQRST-
     D                                     UVWXYZÆØÅ')
     D LC              C                   CONST('abcdefghijklmnopqrst-
     D                                     uvwxyzæøå')

      *get input-string
      /copy syspeds/qrpgsrcpy,prolog3

      * Parse input
     C                   exsr      Parse
      * Open files etc
     C                   EXSR      INIT
      *
     c                   callp     gethtmlifs(
     C                             '/syspeddev/html/JSON.html':
     C                             '/CGITAG/')
     C                   callp     wrtsection('top')
      *
      * ............................................................................................
      * skriv JSON-Object start..(alltid '{' + x ant param. m/komma mellom (IKKE komma etter siste))
      * ............................................................................................
      *
      /free
        JSONstring='{'
        +'¬user¬ : ¬'+%trim(WSUSER)+'¬, '
        +'¬st¬ : ¬'+%trim(ST)+'¬, '
        +'¬avd¬ : ¬'+%trim(%editc(AVDN:'Z'))+'¬, '
        +'¬fkn¬ : ¬'+%trim(%editc(FKNN:'Z'))+'¬, '
        +'¬fn¬ : ¬'+%trim(%editc(FNN:'Z'))+'¬, '
        +'¬dtf¬ : ¬'+%trim(%editc(DTFN:'Z'))+'¬, '
        +'¬dtt¬ : ¬'+%trim(%editc(DTTN:'Z'))+'¬, '
        +'¬rfa¬ : ¬'+%trim(RFA)+'¬, '
        +'¬errMsg¬ : ¬'+%trim(Error)+'¬, ';
      /end-free
      * JSONfix escaper " i tekst,  for deretter å bytte ¬->"
     c                   call      'JSONFIX'
     c                   parm                    JSONstring
     C                   callp     updHTMLvar('JSONstring':JSONstring)
     C                   callp     wrtsection('JSONlin')
      *
      * ............................................................................................
      * Skriv JSON-LISTE Start (en liste er EN parameter(fra [ til   )
      * ............................................................................................
     c                   eval      JSONstring ='"orderList" : ['
     C                   callp     updHTMLvar('JSONstring':JSONstring)
     C                   callp     wrtsection('JSONlin')
      *
      * Liste Angivelser
      *
     c     Error         ifeq      *blanks
     C                   IF        FNN <> 0
     C                   EVAL      DTFN = 0
     C                   EVAL      DTTN = 0
     C                   END
     C                   IF        FNN = 0 AND DTFN = 0
     C                   CALL      'SYGE15C'
     C                   PARM                    WDT               8
     C                   PARM                    WTM               6
     C                   MOVE      WDT           DTFN
     C                   MOVE      WDT           DTTN
     C                   IF        %SUBST(WDT:5:2) < '04'
     C                   SUB       10000         DTFN
     C                   ADD       900           DTFN
     C                   ELSE
     C                   SUB       300           DTFN
     C                   END
     C                   END
     C     *LOVAL        SETLL     XMLUFL2
     C                   READ      XMLUFL2                                55
     C     *IN55         DOWEQ     '0'
     C     XFFN          CHAIN     FAIN                               55
     C  N55HEADFK        CHAIN     HEADF                              55
     C     *IN55         CABEQ     *ON           HOPP

     C                   IF        ST <> '*'
     C                   SELECT
     C                   WHEN      ST = ' ' OR                                  IKKE SENDT
     C                             ST = 'C' OR                                  SENDT
     C                             ST = 'E' OR                                  ERROR
N03  C                             ST = 'D' OR                                  Slettet
N03  C                             ST = 'X' OR                                  Manuell satt
N03  C                             ST = 'T' OR
     C                             ST = 'O'                                     OK
     C     XFST          CABNE     ST            HOPP
     C                   WHEN      ST = 'A'                                     ANDRE
     C                   IF        XFST = ' ' OR                                IKKE SENDT
     C                             XFST = 'C' OR                                SENDT
     C                             XFST = 'E' OR                                ERROR
     C                             XFST = 'O'                                   OK
     C                   GOTO      HOPP
     C                   ENDIF
     C                   ENDSL
     C                   ENDIF
     C                   IF        AVDN > 0
     C     HEAVD         CABNE     AVDN          HOPP
     C                   ENDIF
     C                   IF        FKNN > 0
     C     XFKN          CABNE     FKNN          HOPP
     C                   ENDIF
     C                   IF        FNN > 0
     C     XFFN          CABNE     FNN           HOPP
     C                   ENDIF
     C                   IF        DTFN > 0
     C     HEDTOP        CABLT     DTFN          HOPP
     C                   ENDIF
     C                   IF        DTTN > 0
     C     HEDTOP        CABGT     DTTN          HOPP
     C                   ENDIF
     C                   IF        RFA <> *BLANKS
     C     RFA           CABGT     HERFA         HOPP
     C     RFAMAX        CABLT     HERFA         HOPP
     C                   ENDIF
      * HENT FAKTURADATO
     C     XFFN          CHAIN     FAK9                               55
     C                   DOW       *IN55 = *OFF AND FAKDA = 'K'
     C     XFFN          READE     FAK9                                   55
     C                   ENDDO
      *
     C                   EVAL      XSIFS = *BLANKS
     C                   EVAL      XRIFS = *BLANKS
     C     EDIM2K        SETGT     EDIM2
     C     EDIM2K        READPE    EDIM2                                  55
     C                   DOW       *IN55 = *OFF
     C                   SELECT
     C                   WHEN      M0065 = 'INVXML' AND XSIFS = *BLANKS
      * Utgående XML-faktura
     C     MSN           CHAIN     EDIS                               55
     C  N55              EVAL      XSIFS = SIFS
     C                   LEAVE
     C                   WHEN      M0065 = 'XMLRST' AND XRIFS = *BLANKS
      * Innkommede XML-kvittering
     C     MSN           CHAIN     EDIS                               55
     C  N55              EVAL      XRIFS = SIFS
     C                   ENDSL
     C     EDIM2K        READPE    EDIM2                                  55
     C                   ENDDO

     C                   MOVE      *BLANKS       XPDF            100
     C                   EVAL      ARTYPE = 'fa'
     C     ARTYPE        CHAIN     ARKTXT                             33
     C                   IF        *IN33 = *OFF
     C                   MOVEL     XFFN          ARUNDE
     C     ARKIVL06K     CHAIN     ARKIVL06                           33
     C                   IF        *IN33 = *OFF
     C                   MOVE      ARKLAG        ARCEXT
     C     ARKEXTK       CHAIN     ARKEXT                             33
     C   33FIFIRM        CHAIN     FIRMARC                            33
     C                   EVAL      XPDF = '/' + %TRIM(ARCANE) + '/'
     C                             + %TRIM(ARLINK)
     C     '.pdf'        SCAN      XPDF                                   33
     C  N33              CAT       '.pdf':0      XPDF
     C                   END
     C                   END

     C                   Add       1             AntLest
      * ............................................................................................
      * Skriv en JSON-Array-linje pr menypunkt - komma før hvert nytt element
      * ............................................................................................
      /free
       if AntLest=1;
          JSONstring=*blanks;
          else;
          JSONstring=', ';
          endif;
       JSONstring=%trim(JSONstring)+'{'
          +'¬avd¬ : ¬'+%trim(%editc(HEAVD:'Z'))+'¬, '
          +'¬opd¬ : ¬'+%trim(%editc(HEOPD:'Z'))+'¬, '
          +'¬xfkn¬ : ¬'+%trim(%editc(XFKN:'Z'))+'¬, '
          +'¬xffn¬ : ¬'+%trim(%editc(XFFN:'Z'))+'¬, '
          +'¬herfa¬ : ¬'+%trim(HERFA)+'¬, '
          +'¬hedtop¬ : ¬'+%trim(%editc(HEDTOP:'Z'))+'¬, '
          +'¬fadato¬ : ¬'+%trim(%editc(FADATO:'Z'))+'¬, '
          +'¬hesdf¬ : ¬'+%trim(HESDF)+'¬, '
          +'¬hesdt¬ : ¬'+%trim(HESDT)+'¬, '
          +'¬henas¬ : ¬'+%trim(HENAS)+'¬, '
          +'¬henak¬ : ¬'+%trim(HENAK)+'¬, '
          +'¬hekdpl¬ : ¬'+%trim(HEKDPL)+'¬, '
          +'¬hent¬ : ¬'+%trim(%editc(HENT:'Z'))+'¬, '
          +'¬hevkt¬ : ¬'+%trim(%editc(HEVKT:'Z'))+'¬, '
          +'¬hem3¬ : ¬'+%trim(%editc(HEM3:'4'))+'¬, '
          +'¬helm¬ : ¬'+%trim(%editc(HELM:'4'))+'¬, '
          +'¬xfst¬ : ¬'+%trim(XFST)+'¬, '
          +'¬xsifs¬ : ¬'+%trim(XSIFS)+'¬, '
          +'¬xrifs¬ : ¬'+%trim(XRIFS)+'¬, '
          +'¬xpdf¬ : ¬'+%trim(XPDF)+'¬, '
          +'¬xfdts¬ : ¬'+%trim(%editc(XFDTS:'Z'))+'¬, '
          +'¬xftds¬ : ¬'+%trim(%editc(XFTDS:'Z'))+'¬}';
      /end-free
     C                   call      'JSONFIX'
     C                   parm                    JSONstring
     C                   callp     updHTMLvar('JSONstring':JSONstring)
     C                   callp     wrtsection('JSONlin')

     C     HOPP          TAG

     C                   READ      XMLUFL2                                55
     C                   ENDDO
      *
     c                   endif
      * ............................................................................................
      * Skriv JSON-Liste/Array  Avslutning
      * ............................................................................................
     c                   eval      JSONstring =']'
     C                   callp     updHTMLvar('JSONstring':JSONstring)
     C                   callp     wrtsection('JSONlin')
      * ............................................................................................
      * Skriv JSON-string Avsluttning
      * ............................................................................................
     c                   eval      JSONstring ='}'
     C                   callp     updHTMLvar('JSONstring':JSONstring)
     C                   callp     wrtsection('JSONlin')
      *
      * Quit
     C                   exsr      Exit


      *=====================================================================
      * Close output html and quit
      *=====================================================================
     C     Exit          begsr
      * Lukk fil
     C                   CLOSE     BRIDF
     C  N50              CLOSE     XMLUFL2
     C  N50              CLOSE     FAIN
     C  N50              CLOSE     FAK9
     C  N50              CLOSE     HEADF
     C  N50              CLOSE     ARKIVL06
     C  N50              CLOSE     EDIM2
     C  N50              CLOSE     EDIS
     C  N50              CLOSE     FIRMARC
     C  N50              CLOSE     ARKTXT
     C  N50              CLOSE     ARKEXT

      * Do not delete the call to wrtsection with section name *fini.  It is needed
      * to ensure that all output html that has been buffered gets output.
     C                   callp     wrtsection('*fini')
      * Quit
     C                   MOVE      *ON           *INLR
     C                   return
     C                   endsr
      *
      *********************************************************
     C     Parse         Begsr
      *********************************************************
      * Get input
     C                   EVAL      WSUSER  = zhbgetvar('USER')
     C                   EVAL      ST      = zhbgetvar('ST')
     C                   EVAL      AVD     = zhbgetvar('AVD')
     C                   eval      AVDN    = c2n2(AVD)
     C                   EVAL      FKN     = zhbgetvar('FKN')
     C                   EVAL      FKNN    = c2n2(FKN)
     C                   EVAL      FN      = zhbgetvar('FN')
     C                   EVAL      FNN     = c2n2(FN)
     C                   EVAL      DTF     = zhbgetvar('DTF')
     C                   EVAL      DTFN    = c2n2(DTF)
     C                   EVAL      DTT     = zhbgetvar('DTT')
     C                   EVAL      DTTN    = c2n2(DTT)
     C                   EVAL      RFA     = zhbgetvar('RFA')
     C     LC:UC         XLATE     RFA           RFA
     C                   EVAL      RFAMAX  = %TRIM(RFA) + '99999999999999999999'
      *
     c                   endsr

      *********************************************************
     C     INIT          Begsr
      *********************************************************
     C                   OPEN      BRIDF
      * Test innlogging
     C     WSUSER        CHAIN     BRIDF                              50
     C     BILIBL        ifeq      *blanks
     C                   callb     'INCGI'
     C                   parm                    BISTDL
     C                   else
     C                   call      BILIBL
     C                   end
     C     HEADFK        klist
     C                   kfld                    FIAVD
     C                   kfld                    FIOPD
     C     EDIM2K        klist
     C                   kfld                    FIAVD
     C                   kfld                    FIOPD
     C                   kfld                    M0068A
     C                   kfld                    M0068B
     C                   kfld                    M0068C
     C     ARKEXTK       KLIST
     C                   KFLD                    FIFIRM
     C                   KFLD                    ARCEXT
     C     ARKIVL06K     KLIST
     C                   KFLD                    FIFIRM
     C                   KFLD                    ARTYPE
     C                   KFLD                    ARUNDE

     C     *LIKE         DEFINE    SIFS          XSIFS
     C     *LIKE         DEFINE    SIFS          XRIFS

     C   50              eval      Error = 'Invalid userID'
     C  N50              OPEN      XMLUFL2
     C  N50              OPEN      FAIN
     C  N50              OPEN      FAK9
     C  N50              OPEN      HEADF
     C  N50              OPEN      ARKIVL06
     C  N50              OPEN      EDIM2
     C  N50              OPEN      EDIS
     C  N50              OPEN      FIRM
     C  N50              OPEN      FIRMARC
     C  N50              OPEN      ARKTXT
     C  N50              OPEN      ARKEXT

     C     *LOVAL        SETLL     FIRM
     C                   READ      FIRM                                   33

     c                   endsr
