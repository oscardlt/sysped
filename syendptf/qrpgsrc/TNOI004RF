**FREE
/copy SYSPEDS/qrpgsrcpy,hspecs
/copy SYSPEDS/qrpgsrcpy,hspecsbnd

dcl-f bridf keyed usropn;
dcl-f sadh keyed usropn;
dcl-f standi keyed usropn;
dcl-f edim2 keyed usropn;
     ‚*--------------------------------------------------------------------
     ‚* Variables common to all CGIs
     ‚*--------------------------------------------------------------------
/copy SYSPEDS/qrpgsrcpy,prototypeb
/copy SYSPEDS/qrpgsrcpy,usec
/copy SYSPEDS/qrpgsrcpy,variables3
     ‚*  Prototype for 'JSONFIX'
dcl-pr jsonfix extpgm('JSONFIX');
  jsonstring_ like(jsonstring);
end-pr;

     ‚* Varible for
dcl-s wsuser char(10);
dcl-s avd char(4);
dcl-s avdn packed(4);
dcl-s opd char(7);
dcl-s opdn packed(7);
dcl-s max0b zoned(8) inz(99999999);
dcl-s max0c zoned(6) inz(666666);
dcl-s max0d zoned(2) inz(99);
dcl-s xinst char(1);
dcl-s wm1n07 char(3);
dcl-s wm3039e zoned(6);
dcl-s wm2005b zoned(8) inz(0);
dcl-s wm5004d zoned(10) inz(0);
dcl-s wmven char(1);
dcl-s wm0035 char(1);
dcl-s wm9n01 zoned(1) inz(3);
dcl-s jsonstring char(32000);
dcl-s error char(150);
dcl-s antlest packed(9);

     ‚*get input-string
/copy syspeds/qrpgsrcpy,prolog3
     ‚* Prototype for exit
dcl-pr exit;
end-pr;
     ‚* Prototype for parse
dcl-pr parse;
end-pr;
     ‚* Prototype for init
dcl-pr init;
end-pr;
     ‚* Prototype for 'INCGI'
dcl-pr incgi extproc('INCGI');
  bistdl_ like(bistdl);
end-pr;
     ‚* Prototype for bilibl
dcl-pr bilibl_001 extpgm(bilibl);
end-pr;
     ‚* Prototype for getvar
dcl-pr getvar;
end-pr;
parse();
init();

gethtmlifs(
'/syspeddev/html/JSON.html':
'/CGITAG/');
wrtsection('top');

//‚..........................................................................................
//‚skriv JSON-Object start (alltid '{' + x ant param. m/komma mellom (IKKE komma etter siste)
//‚..........................................................................................

jsonstring='{'
+'¬user¬ : ¬'+%trim(wsuser)+'¬, '
+'¬avd¬ : ¬'+%trim(%editc(avdn:'Z'))+'¬, '
+'¬opd¬ : ¬'+%trim(%editc(opdn:'M'))+'¬, '
+'¬errMsg¬ : ¬'+%trim(error)+'¬, ';

//‚JSONfix escaper " i tekst,  for deretter å bytte ¬->"

jsonfix ( jsonstring );

updhtmlvar2('JSONstring'
           :%addr(jsonstring)
           :%len(jsonstring));
wrtsection('JSONlin');

//‚..........................................................................................
//‚Skriv JSON-LISTE Start (en liste er EN parameter(fra [ til   )
//‚..........................................................................................
jsonstring ='"getcmn" : [';

updhtmlvar2('JSONstring'
           :%addr(jsonstring)
           :%len(jsonstring));
wrtsection('JSONlin');

if error = *blanks;
  chain ( avdn : opdn ) sadh;

  if %found(sadh);
    getvar();
     ‚* Skriv en JSON-Array-linje pr menypunkt - komma før hvert nytt element
    jsonstring=*blanks;
    jsonstring=%trim(jsonstring)+'{'
       +'¬m1N07¬  : ¬'+%trim(wm1n07)+'¬, '
       +'¬m3039e¬ : ¬'+%trim(%editc(wm3039e:'Z'))+'¬, '
       +'¬m2005b¬ : ¬'+%trim(%editc(wm2005b:'Z'))+'¬, '
       +'¬m5004d¬ : ¬'+%trim(%editc(wm5004d:'4'))+'¬, '
       +'¬m0035¬  : ¬'+%trim(wm0035)+'¬, '
       +'¬m9n01¬  : ¬'+%trim(%editc(wm9n01:'Z'))+'¬}';

    jsonfix ( jsonstring );

    updhtmlvar2('JSONstring'
               :%addr(jsonstring)
               :%len(jsonstring));

    wrtsection('JSONlin');


  endif;
endif;
jsonstring =']';
updhtmlvar2('JSONstring'
           :%addr(jsonstring)
           :%len(jsonstring));
wrtsection('JSONlin');
     ‚* Skriv JSON-string Avsluttning
jsonstring ='}';
updhtmlvar2('JSONstring'
           :%addr(jsonstring)
           :%len(jsonstring));
wrtsection('JSONlin');

exit();

     ‚*=====================================================================
     ‚* Close output html and quit
     ‚*=====================================================================
dcl-proc exit;
     ‚* Lukk filer
if %found(bridf);
  close sadh;
  close standi;
  close edim2;
endif;
close bridf;

     ‚* Do not delete the call to wrtsection with section name *fini.  It is needed
     ‚* to ensure that all output html that has been buffered gets output.
wrtsection('*fini');
     ‚* Quit
*inlr = *on;
end-proc exit;
dcl-proc parse;
     ‚* Get input
wsuser  = zhbgetvar('USER');
avd     = zhbgetvar('AVD');
avdn    = c2n2(avd);
opd     = zhbgetvar('OPD');
opdn    = c2n2(opd);
end-proc parse;
     ‚*********************************************************
dcl-proc init;
     ‚*********************************************************
     ‚* Test innlogging
open bridf;
chain wsuser bridf;
if %found;
  open sadh;
  open edim2;
  open standi;
else;
  error = 'Invalid userID';
endif;

if bilibl = *blanks;
  incgi ( bistdl );
else;
  bilibl_001();
endif;

     c     sadkey        klist
     c                   kfld                    avdn
     c                   kfld                    opdn
     c     m2kdck        klist
     c                   kfld                    avdn
     c                   kfld                    opdn
     c                   kfld                    max0b
     c                   kfld                    max0c
     c                   kfld                    max0d

end-proc init;
     ‚*********************************************************
dcl-proc getvar;
     ‚*********************************************************
xinst = 'N';

     ‚* FINNER SANSYNLIG MELDINGSTYPE UTFRA LOGGELEMENT

setll ( avdn : opdn : max0b : max0c : max0d ) edim2;

     c     stfmty        tag

readpe ( avdn : opdn ) edim2;
*in33 = %eof;
     c  n33              if        m1001 = '830'
     c                             or mst = 'D'
     c                             or msr = 'S'
     c                             or m1n07 = 'DFI'
     c                             or m1n07 = 'DII'
     c                             or m1n07 = 'DPU'
     c                             or m1n07 = 'DKO'
     c                             or m0068c = 0
     c     m0068c        cabeq     0             stfmty

  if msr = 'S'
    and xinst = 'N';

    if m1n07 = 'DMA'
      or m1n07 = 'DEN';
      xinst = 'J';
    endif;

  endif;

     c                   goto      stfmty

else;

  if m1n07 = 'DME';

    if simi = 'I';
     c                   goto      stfmty
    else;
      wm1n07 = 'DKO';
    endif;

  else;

    if m0065 = 'NCUMUA'
      or m1n07 = 'DUA';

      if xinst = 'J';

        if sidp = 40
          or sidp = 41;
          wm1n07 = 'DEN';
        else;
          wm1n07 = 'DMA';
        endif;

      else;

        wm1n07 = 'DKO';

      endif;

    else;
      *in33 = *on;
    endif;
  endif;
endif;

if *in33 = *on
  and simi = 'I';
  wm1n07 = 'DFO';

else;

  if sidp <> 40
    and sidp <> 41
    and sidp <> 49;
    wm1n07 = 'DMA';
  else;
    wm1n07 = 'DFU';
  endif;

endif;

chain avdn standi;
if %found(standi);
  wm0035 = s0035;
  wm3039e = s3039e;
endif;

end-proc getvar;
