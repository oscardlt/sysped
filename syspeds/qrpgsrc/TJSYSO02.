      * Kun hovedopplysninger i dette programet.
      * For repeterbar informasjon finnes egne programer:
      * TJGE11R     RPGLE       TomCat/JSON Oppdragsfritekst liste (kun A, 1)
      * TJGE12R     RPGLE       TomCat/JSON Oppdragsdokumenter
      * TJGE13R     RPGLE       TomCat/JSON Oppdragsfakturar
      * TJGE14R     RPGLE       TomCat/JSON OppdragsFrie søkeveier
      *********************************************************************
      *
CRTPG+*  CRTPGM SYSPED/TJSYSO02R MODULE(*LIBL/TJSYSO02R *LIBL/INCGI)
CRTPGM*        ACTGRP(CGI) AUT(*USE)
      *
      *********************************************************************
      /copy SYSPEDS/qrpgsrcpy,hspecs
      /copy SYSPEDS/qrpgsrcpy,hspecsbnd
      *********************************************************************
     FBRIDF     UF   E           K DISK    USROPN
     FHEADF     IF   E           K DISK    USROPN
     FARKIVL02  IF   E           K DISK    USROPN
     FFIRMARC   IF   E           K DISK    USROPN
     FFIRM      IF   E           K DISK    USROPN
     FARKTXT    IF   E           K DISK    USROPN
     FARKEXT    IF   E           K DISK    USROPN
     FFRISOK    IF   E           K DISK    USROPN
     FFRISOL01  IF   E           K DISK    USROPN
     F                                     RENAME(FRISOKR:FRISOKR1)
     FHEAD17    IF   E           K DISK    USROPN
     F                                     RENAME(headfr:headfr17)
     FKOFAST    IF   E           K DISK    USROPN
     FKODFRI    IF   E           K DISK    USROPN
     FDOKUF7    IF   E           K DISK    USROPN
     FTURER14   IF   E           K DISK    USROPN
     FTRAN      IF   E           K DISK    USROPN
     FBRPARF    if   e           k disk    USROPN
     FTRACKL01  IF   E           K DISK    USROPN
     FTRACKL02  IF   E           K DISK    USROPN
     F                                     RENAME(TRACKFR:TRACKFR2)
     FTRACKT    IF   E           K DISK    USROPN
     FFREETXT2  IF   E           K DISK    USROPN
     FFAK8      IF   E           K DISK    USROPN
     FGSSCGL02  IF   E           K DISK    USROPN
     FDOKUFM    IF   E           K DISK    USROPN
      *--------------------------------------------------------------------
      * Variables common to all CGIs
      *--------------------------------------------------------------------
      /copy SYSPEDS/qrpgsrcpy,prototypeb
      /copy SYSPEDS/qrpgsrcpy,usec
      /copy SYSPEDS/qrpgsrcpy,variables3
      *--------------------------------------------------------------------
      * Variables received from the input string
     D LNG             s              2
     D UsrSpcName      s             10
     D WSUSER          S             10
     D WSNA            S             30
     D KN              S              8  0 DIM(30)
     D DIR             s              1
     D WSAVD           S              4
     D WSOPD           S              7
     D EXTREF          S             35
     D WSSOK           S             80
     D WSSOKURL        S            200
     D WSFRTTXT        S            710
     D WSETA           S              8S 0
     D WSETD           S              8S 0
     D UtText          s            150
     D Error           S            150
     D JSONstring      s          64000
     D ANTSND          s              5  0
      *
     D Lib             s             10
     D Fn              s             10
     D Mbr             s             10
      *
     D Spaces          s             12a   inz('&nbsp;&nbsp;')

     D                 DS
     D  DSAVOP                 1     12
     D  DSAVD                  1      4
     D  Strek                  5      5
     D  DSOPD                  6     12
     D  DSOPD5                 6     10
     D                 DS
     D  updf1                  1    200
     D  updf2                201    400
     D  updf3                401    600
     D  updf4                601    800
     D  updf5                801   1000
     D  updf6               1001   1200
     D  updf7               1201   1400
     D  updf8               1401   1600
     D  updf9               1601   1800
     D  updf10              1801   2000
     D  updf11              2001   2200
     D  updf12              2201   2400
     D  updf13              2401   2600
     D  updf14              2601   2800
     D  updf15              2801   3000
     D  updf16              3001   3200
     D  updf17              3201   3400
     D  updf18              3401   3600
     D  updf19              3601   3800
     D  updf20              3801   4000
     D  updf                   1   4000
     D                                     DIM(20)
      * Faktura-linker
     D                 DS
     D  FakL1                  1    120
     D  FakL2                121    240
     D  FakL3                241    360
     D  FakL4                361    480
     D  FakL5                481    600
     D  FakL6                601    720
     D  FakL7                721    840
     D  FakL8                841    960
     D  FakL9                961   1080
     D  FakL10              1081   1200
     D  FakL11              1201   1320
     D  FakL12              1321   1440
     D  FakL13              1441   1560
     D  FakL14              1561   1680
     D  FakL15              1681   1800
     D  FakL16              1801   1920
     D  FakL17              1921   2040
     D  FakL18              2041   2160
     D  FakL19              2161   2280
     D  FakL20              2281   2400
     D  FakL                   1   2400    DIM(20)
      * T&T-linker
     D                 DS
     D  WTX01                  1     30
     D  WTX02                 31     60
     D  WTX03                 61     90
     D  WTX04                 91    120
     D  WTX05                121    150
     D  WTX06                151    180
     D  WTX07                181    210
     D  WTX08                211    240
     D  WTX09                241    270
     D  WTX                    1    270    DIM(9)
     D                 DS
     D  WTO01                  1     80
     D  WTO02                 81    160
     D  WTO03                161    240
     D  WTO04                241    320
     D  WTO05                321    400
     D  WTO06                401    480
     D  WTO07                481    560
     D  WTO08                561    640
     D  WTO09                641    720
     D  WTO                    1    720    DIM(9)
     D                 DS
     D  WTU01                  1    200
     D  WTU02                201    400
     D  WTU03                401    600
     D  WTU04                601    800
     D  WTU05                801   1000
     D  WTU06               1001   1200
     D  WTU07               1201   1400
     D  WTU08               1401   1600
     D  WTU09               1601   1800
     D  WTU                    1   1800    DIM(9)
     D                 DS
     D  WTTD01                 1      8
     D  WTTD02                 9     16
     D  WTTD03                17     24
     D  WTTD04                25     32
     D  WTTD05                33     40
     D  WTTD06                41     48
     D  WTTD07                49     56
     D  WTTD08                57     64
     D  WTTD09                65     72
     D  WTTD                   1     72    DIM(9)
     D                 DS
     D  WTTT01                 1      8
     D  WTTT02                 9     16
     D  WTTT03                17     24
     D  WTTT04                25     32
     D  WTTT05                33     40
     D  WTTT06                41     48
     D  WTTT07                49     56
     D  WTTT08                57     64
     D  WTTT09                65     72
     D  WTTT                   1     72    DIM(9)
     D                 DS
     D  WTTX01                 1    150
     D  WTTX02               151    300
     D  WTTX03               301    450
     D  WTTX04               451    600
     D  WTTX05               601    750
     D  WTTX06               751    900
     D  WTTX07               901   1050
     D  WTTX08              1051   1200
     D  WTTX09              1201   1350
     D  WTTX                   1   1350    DIM(9)
     D                 DS
     D  WTTG01                 1    150
     D  WTTG02               151    300
     D  WTTG03               301    450
     D  WTTG04               451    600
     D  WTTG05               601    750
     D  WTTG06               751    900
     D  WTTG07               901   1050
     D  WTTG08              1051   1200
     D  WTTG09              1201   1350
     D  WTTG                   1   1350    DIM(9)
      * Arkivtyper 16 elem. a 3 tegn (sb,si,..) Type er venstrestilt
     D                 DS
     D  ATString               1    192
     D  ATString1              1     48
     D  ATString2             49     96
     D  ATString3             97    144
     D  ATString4            145    192
     D  AT                     1    192    DIM(64)
     D                 DS
     D  A2                     1    128    DIM(64)
     D                 DS
     D  DFS                    1     10    DIM(10)
     D  KFSODK                 1     10
     D                 DS
     D  KFTXT                  1     50
     D  KFTXTB                 5     49
     D  VisWEB                50     50
     D                 DS
     D  WDsÅMD                 1      8  0
     D  WDsÅMDÅ                1      4  0
     D  WDsÅMDM                5      6  0
     D  WDsÅMDD                7      8  0
     D                 DS
     D  WDsDMÅ                 1      8  0
     D  WDsDMÅD                1      2  0
     D  WDsDMÅM                3      4  0
     D  WDsDMÅÅ                5      8  0
     D                 DS
     D  HXSNDN                 1     20
     D  HXSNR17                4     20
     D                 DS
     D  HEGN                   1     15
     D  HEGN04                 1      4
     D  HEGN03                 5      7
     D  HEGN08                 8     15
     D  HEGN515                5     15
     D                 DS
     D* HERFA                  1     15
     D  HERFA                  1     35
     D  HERFA03                1      3
     D  HERFA08                4     11
     D                 DS
     D  HEDTMO                 1      8
     D  HEDTMOD                1      2
     D  HEDTMOM                3      4
     D  HEDTMOÅ                5      6
     D  HEDTMO6                1      6
     D  HEDTMO2                7      8
     D                 DS
     D  WSATA                  1      8  0
     D  WSATAÅ                 1      4  0
     D  WSATAM                 5      6  0
     D  WSATAD                 7      8  0
      * For xlate mellom Upper Case og Lower Case
     D UC              C                   CONST('ABCDEFGHIJKLMNOPQRST-
     D                                     UVWXYZÆØÅ')
     D LC              C                   CONST('abcdefghijklmnopqrst-
     D                                     uvwxyzæøå')
      *get input-string
      /copy syspeds/qrpgsrcpy,prolog3
      * Parse input
     C                   EXSR      Parse
      * Open files etc
     C                   EXSR      INIT

      *
     C                   CALLP     gethtmlifs(
     C                             '/syspeddev/html/JSON.html':
     C                             '/CGITAG/')
     C                   CALLP     wrtsection('top')
      * skriv JSON-Object start..(alltid '{' + x ant param. m/komma mellom (IKKE komma etter siste))
      /free
        JSONstring='{'
        +'¬user¬ : ¬'+%trim(WSUSER)+'¬, '
        +'¬lng¬ : ¬'+%trim(LNG)+'¬, '
        +'¬wsna¬ : ¬'+%trim(WSNA)+'¬, '
        +'¬kunde¬ : ¬'+%trim(%editc(BIKUNR:'Z'))+'¬, '
        +'¬sdato¬ : ¬'+%trim(%editc(BIDTV:'Z'))+'¬, '
        +'¬stid¬ : ¬'+%trim(%editc(BITIDV:'Z'))+'¬, '
        +'¬wsavd¬ : ¬'+%trim(WSAVD)+'¬, '
        +'¬wsopd¬ : ¬'+%trim(WSOPD)+'¬, '
        +'¬dir¬ : ¬'+%trim(DIR)+'¬, '
        +'¬extref¬ : ¬'+%trim(EXTREF)+'¬, '
        +'¬errMsg¬ : ¬'+%trim(Error)+'¬, ';
      /end-free
      * JSONfix escaper " i tekst,  for deretter å bytte ¬->"
     C                   CALL      'JSONFIX'
     C                   PARM                    JSONstring
     C                   CALLP     updHTMLvar2('JSONstring'
     C                                         :%ADDr(JSONstring)
     C                                         :%len(JSONstring))
     C                   CALLP     wrtsection('JSONlin')

      * Skriv JSON-LISTE Start
     C                   EVAL      JSONstring ='"dspoppdrag" : ['
     C                   CALLP     UPdHTMLvar2('JSONstring'
     C                                         :%ADDr(JSONstring)
     C                                         :%len(JSONstring))
     C                   CALLP     wrtsection('JSONlin')
      * Hent oppdrag
     C                   EXSR      DspPart
     C                   EXSR      DspFAKT
     C                   EXSR      DSPFT
     C                   EXSR      DSPTT
     C                   ADD       1             AntSnd
      /free
          JSONstring=*BLANKS;
       JSONstring=%trim(JSONstring)+'{'
        +'¬heur¬ : ¬'+%trim(HEUR)+'¬, '
        +'¬fitdvi¬ : ¬'+%trim(FITDVI)+'¬, '
        +'¬heavd¬ : ¬'+%trim(%editc(HEAVD:'Z'))+'¬, '
        +'¬heopd¬ : ¬'+%trim(%editc(HEOPD:'Z'))+'¬, '
        +'¬hesg¬ : ¬'+%trim(HESG)+'¬, '
        +'¬hedtop¬ : ¬'+%trim(%editc(HEDTOP:'Z'))+'¬, '
        +'¬hepro¬ : ¬'+%trim(%editc(HEPRO:'Z'))+'¬, '
        +'¬wsetd¬ : ¬'+%trim(%editc(WSETD:'Z'))+'¬, '
        +'¬wseta¬ : ¬'+%trim(%editc(WSETA:'Z'))+'¬, '
        +'¬wsata¬ : ¬'+%trim(%editc(WSATA:'Z'))+'¬, '
        +'¬tracking¬ : ¬'+%trim(XTXT)+'¬, '
        +'¬tracking2¬ : ¬'+%trim(XTXT)+'¬, '
        +'¬hegn¬ : ¬'+%trim(HEGN)+'¬, '
        +'¬herfa¬ : ¬'+%trim(HERFA)+'¬, '
        +'¬hehawb¬ : ¬'+%trim(HEHAWB)+'¬, '
        +'¬hetrcn¬ : ¬'+%trim(HETRCN)+'¬, '
        +'¬henas¬ : ¬'+%trim(HENAS)+'¬, '
        +'¬heads1¬ : ¬'+%trim(HEADS1)+'¬, '
        +'¬heads2¬ : ¬'+%trim(HEADS2)+'¬, '
        +'¬heads3¬ : ¬'+%trim(HEADS3)+'¬, '
        +'¬henak¬ : ¬'+%trim(HENAK)+'¬, '
        +'¬headk1¬ : ¬'+%trim(HEADK1)+'¬, '
        +'¬headk2¬ : ¬'+%trim(HEADK2)+'¬, '
        +'¬headk3¬ : ¬'+%trim(HEADK3)+'¬, '
        +'¬hesdff¬ : ¬'+%trim(HESDFF)+'¬, '
        +'¬hesdf¬ : ¬'+%trim(HESDF)+'¬, '
        +'¬hesdt¬ : ¬'+%trim(HESDT)+'¬, '
        +'¬hesdvt¬ : ¬'+%trim(HESDVT)+'¬, '
        +'¬hent¬ : ¬'+%trim(%editc(HENT:'Z'))+'¬, '
        +'¬clis¬ : ¬'+%trim(CLIDLINK)+'¬, '
        +'¬hedtmo¬ : ¬'+%trim(HEDTMO)+'¬, '
        +'¬hevkt¬ : ¬'+%trim(%editc(HEVKT:'4'))+'¬, '
        +'¬hefbv¬ : ¬'+%trim(%editc(HEFBV:'4'))+'¬, '
        +'¬hem3¬ : ¬'+%trim(%editc(HEM3:'4'))+'¬, '
        +'¬helm¬ : ¬'+%trim(%editc(HELM:'4'))+'¬, '
        +'¬hevs1¬ : ¬'+%trim(HEVS1)+'¬, '
        +'¬hevs2¬ : ¬'+%trim(HEVS2)+'¬, '
        +'¬hegm1¬ : ¬'+%trim(HEGM1)+'¬, '
        +'¬hegm2¬ : ¬'+%trim(HEGM2)+'¬, '
        +'¬hesgm¬ : ¬'+%trim(HESGM)+'¬, '
        +'¬wsfrttxt¬ : ¬'+%trim(WSFRTTXT)+'¬, '
        +'¬updf1¬ : ¬'+%trim(UPDF1)+'¬, '
        +'¬updf2¬ : ¬'+%trim(UPDF2)+'¬, '
        +'¬updf3¬ : ¬'+%trim(UPDF3)+'¬, '
        +'¬updf4¬ : ¬'+%trim(UPDF4)+'¬, '
        +'¬updf5¬ : ¬'+%trim(UPDF5)+'¬, '
        +'¬updf6¬ : ¬'+%trim(UPDF6)+'¬, '
        +'¬updf7¬ : ¬'+%trim(UPDF7)+'¬, '
        +'¬updf8¬ : ¬'+%trim(UPDF8)+'¬, '
        +'¬updf9¬ : ¬'+%trim(UPDF9)+'¬, '
        +'¬updf10¬ : ¬'+%trim(UPDF10)+'¬, '
        +'¬updf11¬ : ¬'+%trim(UPDF11)+'¬, '
        +'¬updf12¬ : ¬'+%trim(UPDF12)+'¬, '
        +'¬updf13¬ : ¬'+%trim(UPDF13)+'¬, '
        +'¬updf14¬ : ¬'+%trim(UPDF14)+'¬, '
        +'¬updf15¬ : ¬'+%trim(UPDF15)+'¬, '
        +'¬updf16¬ : ¬'+%trim(UPDF16)+'¬, '
        +'¬updf17¬ : ¬'+%trim(UPDF17)+'¬, '
        +'¬updf18¬ : ¬'+%trim(UPDF18)+'¬, '
        +'¬updf19¬ : ¬'+%trim(UPDF19)+'¬, '
        +'¬updf20¬ : ¬'+%trim(UPDF20)+'¬, '
        +'¬fakL1¬ : ¬'+%trim(FakL1)+'¬, '
        +'¬fakL2¬ : ¬'+%trim(FakL2)+'¬, '
        +'¬fakL3¬ : ¬'+%trim(FakL3)+'¬, '
        +'¬fakL4¬ : ¬'+%trim(FakL4)+'¬, '
        +'¬fakL5¬ : ¬'+%trim(FakL5)+'¬, '
        +'¬fakL6¬ : ¬'+%trim(FakL6)+'¬, '
        +'¬fakL7¬ : ¬'+%trim(FakL7)+'¬, '
        +'¬fakL8¬ : ¬'+%trim(FakL8)+'¬, '
        +'¬fakL9¬ : ¬'+%trim(FakL9)+'¬, '
        +'¬fakL10¬ : ¬'+%trim(FakL10)+'¬, '
        +'¬fakL11¬ : ¬'+%trim(FakL11)+'¬, '
        +'¬fakL12¬ : ¬'+%trim(FakL12)+'¬, '
        +'¬fakL13¬ : ¬'+%trim(FakL13)+'¬, '
        +'¬fakL14¬ : ¬'+%trim(FakL14)+'¬, '
        +'¬fakL15¬ : ¬'+%trim(FakL15)+'¬, '
        +'¬fakL16¬ : ¬'+%trim(FakL16)+'¬, '
        +'¬fakL17¬ : ¬'+%trim(FakL17)+'¬, '
        +'¬fakL18¬ : ¬'+%trim(FakL18)+'¬, '
        +'¬fakL19¬ : ¬'+%trim(FakL19)+'¬, '
        +'¬fakL20¬ : ¬'+%trim(FakL20)+'¬, '
        +'¬wtx01¬ : ¬'+%trim(WTX01)+'¬, '
        +'¬wtx02¬ : ¬'+%trim(WTX02)+'¬, '
        +'¬wtx03¬ : ¬'+%trim(WTX03)+'¬, '
        +'¬wtx04¬ : ¬'+%trim(WTX04)+'¬, '
        +'¬wtx05¬ : ¬'+%trim(WTX05)+'¬, '
        +'¬wtx06¬ : ¬'+%trim(WTX06)+'¬, '
        +'¬wtx07¬ : ¬'+%trim(WTX07)+'¬, '
        +'¬wtx08¬ : ¬'+%trim(WTX08)+'¬, '
        +'¬wtx09¬ : ¬'+%trim(WTX09)+'¬, '
        +'¬wto01¬ : ¬'+%trim(WTO01)+'¬, '
        +'¬wto02¬ : ¬'+%trim(WTO02)+'¬, '
        +'¬wto03¬ : ¬'+%trim(WTO03)+'¬, '
        +'¬wto04¬ : ¬'+%trim(WTO04)+'¬, '
        +'¬wto05¬ : ¬'+%trim(WTO05)+'¬, '
        +'¬wto06¬ : ¬'+%trim(WTO06)+'¬, '
        +'¬wto07¬ : ¬'+%trim(WTO07)+'¬, '
        +'¬wto08¬ : ¬'+%trim(WTO08)+'¬, '
        +'¬wto09¬ : ¬'+%trim(WTO09)+'¬, '
        +'¬wtu01¬ : ¬'+%trim(WTU01)+'¬, '
        +'¬wtu02¬ : ¬'+%trim(WTU02)+'¬, '
        +'¬wtu03¬ : ¬'+%trim(WTU03)+'¬, '
        +'¬wtu04¬ : ¬'+%trim(WTU04)+'¬, '
        +'¬wtu05¬ : ¬'+%trim(WTU05)+'¬, '
        +'¬wtu06¬ : ¬'+%trim(WTU06)+'¬, '
        +'¬wtu07¬ : ¬'+%trim(WTU07)+'¬, '
        +'¬wtu08¬ : ¬'+%trim(WTU08)+'¬, '
        +'¬wtu09¬ : ¬'+%trim(WTU09)+'¬, '
        +'¬wttd01¬ : ¬'+%trim(WTTD01)+'¬, '
        +'¬wttd02¬ : ¬'+%trim(WTTD02)+'¬, '
        +'¬wttd03¬ : ¬'+%trim(WTTD03)+'¬, '
        +'¬wttd04¬ : ¬'+%trim(WTTD04)+'¬, '
        +'¬wttd05¬ : ¬'+%trim(WTTD05)+'¬, '
        +'¬wttd06¬ : ¬'+%trim(WTTD06)+'¬, '
        +'¬wttd07¬ : ¬'+%trim(WTTD07)+'¬, '
        +'¬wttd08¬ : ¬'+%trim(WTTD08)+'¬, '
        +'¬wttd09¬ : ¬'+%trim(WTTD09)+'¬, '
        +'¬wttt01¬ : ¬'+%trim(WTTT01)+'¬, '
        +'¬wttt02¬ : ¬'+%trim(WTTT02)+'¬, '
        +'¬wttt03¬ : ¬'+%trim(WTTT03)+'¬, '
        +'¬wttt04¬ : ¬'+%trim(WTTT04)+'¬, '
        +'¬wttt05¬ : ¬'+%trim(WTTT05)+'¬, '
        +'¬wttt06¬ : ¬'+%trim(WTTT06)+'¬, '
        +'¬wttt07¬ : ¬'+%trim(WTTT07)+'¬, '
        +'¬wttt08¬ : ¬'+%trim(WTTT08)+'¬, '
        +'¬wttt09¬ : ¬'+%trim(WTTT09)+'¬, '
        +'¬wttx01¬ : ¬'+%trim(WTTX01)+'¬, '
        +'¬wttx02¬ : ¬'+%trim(WTTX02)+'¬, '
        +'¬wttx03¬ : ¬'+%trim(WTTX03)+'¬, '
        +'¬wttx04¬ : ¬'+%trim(WTTX04)+'¬, '
        +'¬wttx05¬ : ¬'+%trim(WTTX05)+'¬, '
        +'¬wttx06¬ : ¬'+%trim(WTTX06)+'¬, '
        +'¬wttx07¬ : ¬'+%trim(WTTX07)+'¬, '
        +'¬wttx08¬ : ¬'+%trim(WTTX08)+'¬, '
        +'¬wttx09¬ : ¬'+%trim(WTTX09)+'¬, '
        +'¬wttg01¬ : ¬'+%trim(WTTG01)+'¬, '
        +'¬wttg02¬ : ¬'+%trim(WTTG02)+'¬, '
        +'¬wttg03¬ : ¬'+%trim(WTTG03)+'¬, '
        +'¬wttg04¬ : ¬'+%trim(WTTG04)+'¬, '
        +'¬wttg05¬ : ¬'+%trim(WTTG05)+'¬, '
        +'¬wttg06¬ : ¬'+%trim(WTTG06)+'¬, '
        +'¬wttg07¬ : ¬'+%trim(WTTG07)+'¬, '
        +'¬wttg08¬ : ¬'+%trim(WTTG08)+'¬, '
        +'¬wttg09¬ : ¬'+%trim(WTTG09)+'¬}';
      /end-free
     C                   CALL      'JSONFIX'
     C                   PARM                    JSONstring
     C                   CALLP     updHTMLvar2('JSONstring'
     C                                         :%ADDr(JSONstring)
     C                                         :%len(JSONstring))
     C                   CALLP     wrtsection('JSONlin')
      * Skriv JSON-Liste/Array  Avslutning
     C                   EVAL      JSONstring =']'
     C                   CALLP     updHTMLvar2('JSONstring'
     C                                         :%ADDr(JSONstring)
     C                                         :%len(JSONstring))
     C                   CALLP     wrtsection('JSONlin')
      * Skriv JSON-string Avsluttning
     C                   EVAL      JSONstring ='}'
     C                   CALLP     updHTMLvar2('JSONstring'
     C                                         :%ADDr(JSONstring)
     C                                         :%len(JSONstring))
     C                   CALLP     wrtsection('JSONlin')

     C     SLUTT         TAG
     C                   EXSR      EXIT
     C                   return
      *=====================================================================******
      * Parse input
      *=====================================================================******
     C     Parse         BEGSR
     C                   EVAL      LNG     = zhbgetvar('LNG')
     C                   EVAL      WSUSER  = zhbgetvar('USER')
     C     LC:UC         XLATE     WSUSER        WSUSER
     C                   EVAL      WSNA    = zhbgetvar('WSNA')
     C                   EVAL      WSAVD   = zhbgetvar('HEAVD')
     C                   MOVE      *ZEROS        HEAVD
     C                   EVAL      HEAVD = c2n2(WSAVD)
     C                   EVAL      WSOPD   = zhbgetvar('HEOPD')
     C                   MOVE      *ZEROS        HEOPD
     C                   EVAL      HEOPD = c2n2(WSOPD)

     C                   ENDSR
      *=====================================================================******
      *  Display Product codes to select from
      *=====================================================================******
     C     DSPPART       BEGSR
      *
     C     HEADFK        CHAIN     HEADF                              33
     C     *IN(33)       IFEQ      '0'
      * Test kundenr
     C                   IF        XINTERN <> 'J'
     C     1             DO        30            XN2
     C     KN(XN2)       CABEQ     0             SLDSPPART
     C     HEKNA         IFNE      KN(XN2)
     C     TRKNFA        ANDNE     KN(XN2)
     C     HEKNS         ANDNE     KN(XN2)
     C     HEKNSF        ANDNE     KN(XN2)
     C     HEKNK         ANDNE     KN(XN2)
     C     HEKNKF        ANDNE     KN(XN2)
     C                   ELSE
     C                   LEAVE
     C                   ENDIF
     C                   ENDDO
     C                   END

     C     *IN(41)       IFEQ      '0'
     C                   EXSR      lesdok
     C                   END
     C                   END
     C                   IF        HEUR = 'H'
     C                   EVAL      WSETD=TRSDFD
     C                   EVAL      WSETA=TRSDTD
     C                   ELSE
     C                   EVAL      WSETD=HEDTOP
     C                   EVAL      WSETA=HEDTOP
     C                   ENDIF

     C     HEADFK        CHAIN     TRACKT                             33
     C  N33              MOVE      TXATAD        WSATA
     C     WSATA         IFEQ      *ZEROS
     C                   IF        ((HEDTMO <> *ZEROS) AND (HEDTMO <> *BLANKS))
     C                   IF        HEDTMO2 = *BLANKS
     C                   MOVE      HEDTMOD       WSATAD
     C                   MOVE      HEDTMOM       WSATAM
     C                   MOVE      2000          WSATAÅ
     C                   MOVE      HEDTMOÅ       WSATAÅ
     C                   ELSE
     C                   MOVE      HEDTMO        WSATA
     C                   END
     C                   END
     C                   END
     C                   IF        HEUR = 'C'
     C                   MOVE      *BLANKS       KFKOD3
     C                   MOVEL     HERFA03       KFKOD3
     C     KOFASTK3      CHAIN     KOFAST                             33
     C   33KOFASTK5      CHAIN     KOFAST                             33
     C                   MOVE      *BLANKS       XTXT            300
     C                   MOVE      KFTXTE        XTXTA             1
     C                   MOVE      ' '           KFTXTE
     C                   MOVEL     KFTXT         XTXT
     C                   CAT       KFTXTE:0      XTXT
     C     KOFASTK4      CHAIN     KOFAST                             33
     C                   IF        *IN33 = *OFF
     C                   MOVE      KFTXTE        XTXTA             1
     C                   MOVE      ' '           KFTXTE
     C                   CAT       KFTXT:0       XTXT
     C                   CAT       KFTXTE:0      XTXT
     C                   ENDIF
     C                   IF        XTXTA = 'A'
     C                   CAT       HERFA08:0     XTXT
     C                   ENDIF

     C                   ELSE

     C                   MOVE      *BLANKS       XTXT
     C                   IF        (HEGN515 = '00000000000')
     C                             OR(HEGN515 = '           ')
     C                   MOVE      *BLANKS       HEGN
     C                   END
     C                   IF        HEGN04 = *BLANKS

      * 4 første av godnr ER IKKE fylt ut   - AWB
     C                   MOVE      *BLANKS       KFKOD3
     C                   MOVEL     HEGN03        KFKOD3
      * sjekk flyselskap / other ( med kofasttype 'WEBETRACK' )
     C     KOFASTK3      CHAIN     KOFAST                             33
     C   33KOFASTK5      CHAIN     KOFAST                             33
     C                   MOVE      *BLANKS       XTXT            300
     C                   MOVE      KFTXTE        XTXTA             1
     C                   MOVE      ' '           KFTXTE
     C                   MOVEL     KFTXT         XTXT
     C                   CAT       KFTXTE:0      XTXT
     C     KOFASTK4      CHAIN     KOFAST                             33
     C                   IF        *IN33 = *OFF
     C                   MOVE      KFTXTE        XTXTA             1
     C                   MOVE      ' '           KFTXTE
     C                   CAT       KFTXT:0       XTXT
     C                   CAT       KFTXTE:0      XTXT
     C                   ENDIF
     C                   IF        XTXTA = 'A'
     C                   CAT       HEGN08:0      XTXT
     C                   ENDIF
     C                   ENDIF

     C                   ENDIF
      * Skal link til kolli-IF vises
     C                   MOVE      *BLANKS       CLIDLINK        256
     C     DOKUFMKEY     CHAIN     DOKUFM                             33
     C     *IN33         IFEQ      *OFF
     C                   EVAL      ClidLink='/sycgip/syOPCL.pgm?user='
     C                             +%trim(BIBRID)
     C                             +'&avd='+%trim(%editc(HEAVD:'Z'))
     C                             +'&opd='+%trim(%editc(HEOPD:'Z'))+'" '
     C                             +'Target="ClIdWin">Se Kolli-ID/Godsmerke</A>'
     C                   ENDIF
      *
     C     SLDSPPART     TAG
     C                   ENDSR
      *=====================================================================******
      *  Display Faktura-linker (uavh av arkiv)
      *=====================================================================******
     C     DSPFAKT       BEGSR

     C                   MOVE      *ZEROS        FAFAKT
     C                   CLEAR                   FakL
     C     OKFaktLink    IFEQ      'J'
     C                   Z-ADD     1             na
     C     FAKKey        SETLL     Fak8
     C     HEADFK        READE     Fak8                                   33
     C     *IN33         DOWeq     *OFF
     C                   IF            XINTERN <> 'J'                           Intern:ikke KNR-test
     C     1             DO        30            XN2
     C     KN(XN2)       CABEQ     0             NEXTFAK
     C                   IF        FAKUNR = KN(XN2)
     C                   LEAVE
     C                   END
     C                   ENDDO
     C                   END

     C     FAKDA         CABEQ     'K'           NextFak
     C     FAKDA         CABEQ     'D'           NextFak
     C     FAOPKO        CABEQ     'D'           NextFak
     C     FAOPKO        CABEQ     ' '           NextFak
     C     FASK          CABEQ     'I'           NextFak
      * Lest faktura for gitt kunde
     C                   MOVE      HEAVD         AAAVD             4
     C                   MOVE      HEOPD         AAOPD             7
     C                   MOVE      FAFAKT        AAFAKT            7
     C                   EVAL      FakL(na)='/sycgip/esarkF3.pgm'
     C                                 + '?USER=' + %trim(BIBRID)
     C                                 + '&FAKNR=' + AAFAKT
     C                                 + '&AVD=' +AAAVD
     C                                 + '&OPD=' +AAOPD
     C                                 + '" target="_top">'
     C                                 + AAFAKT + '</A>&nbsp'
     C                   ADD       1             na
     C     NextFak       tag
     C                   ADD       1             FAFAKT
     C     FAKKey        SETLL     Fak8
     C     HEADFK        READE     Fak8                                   33
     C  N33              ENDDO
     C                   END
      *
     C                   ENDSR
      *
      *=====================================================================******
      *  Display INFORMATIONS
      *=====================================================================******
     C     DSPFT         BEGSR

     C     FREETXT2K     SETLL     FREETXT2
     C     FREETXT2K     READE     FREETXT2                               33
     C                   EVAL      WSFRTTXT = *BLANKS
     C                   DOW       *IN33 = *OFF
     C                   EVAL      WSFRTTXT = %TRIM(WSFRTTXT)
     C                             + %TRIM(FRTTXT) + ','
     C     FREETXT2K     READE     FREETXT2                               33
     C                   ENDDO

     C     FREETXT2K1    SETLL     FREETXT2
     C     FREETXT2K1    READE     FREETXT2                               33
     C                   DOW       *IN33 = *OFF
     C                   EVAL      WSFRTTXT = %TRIM(WSFRTTXT)
     C                             + %TRIM(FRTTXT) + ','
     C     FREETXT2K1    READE     FREETXT2                               33
     C                   ENDDO

     C                   ENDSR
      *=====================================================================******
      *  Display TRACK & TRACE
      *=====================================================================******
     C     DSPTT         BEGSR

      * VIS TRACKBAR SØKEVEI
     C                   Z-ADD     0             WN                1 0
     C                   EVAL      Snr = *BLANKS
     C     HEADFK        SETLL     FRISOK
     C     HEADFK        READE     FRISOK                                 33
     C                   DOW       *IN33 = *OFF                                 1<-B
     C     FSKODE        CHAIN     KODFRI                             33
     C     *IN33         CABEQ     '1'           NextFri1
     C                   IF        FSKODE = 'IFB'                                2<-B
     C                   EXSR      TstFbr
     C                   IF        Snr = *BLANKS                                 2<-B
     C                   MOVEL     FSSOK         Snr              17
     C                   ELSE                                                    2<-E
     C                   EVAL      Snr    = 'FLERE'
     C                   ENDIF                                                   2<-E
     C                   ENDIF                                                   2<-E
      * Har denne frisok-kode peker til Track&Trace-URL-definisjon?
     C                   EVAL      KFKOD = KFSTTU
     C     KOFASTK1      CHAIN     KOFAST                             33
     C                   IF        *IN33 = *OFF                                  2<-B
      * Verdi som vises i link..
     C                   EVAL      WSSOK = FSSOK
      * URL som skal utføres
     C                   EVAL      WSSOKURL = KFTXT
      * AppEND linje 2 (engelsk tekst når siet tegn er A)
     C                   MOVE      KFTXTE        TstAppEND         1
     C     TstAppEND     IFEQ      'A'                                            3<-B
     C                   MOVE      ' '           KFTXTE
     C                   CAT       KFTXTE:0      WSSOKURL
     C                   END                                                      3<-E
     C                   CAT       FSSOK:0       WSSOKURL
      * Suffix i søkestrengen..
     C     KOFASTK2      CHAIN     KOFAST                             33
     C                   IF        *IN33 = *OFF                                   3<-B
     C                   CAT       KFTXT:0       WSSOKURL
     C                   MOVE      KFTXTE        XTXTA
     C                   MOVE      ' '           KFTXTE
     C     XTXTA         IFEQ      'A'
     C                   CAT       KFTXTE:0      WSSOKURL
     C                   END                                                      3<-E
     C                   END                                                      3<-E

     C     WN            IFLE      9
     C                   ADD       1             WN
     C                   EVAL      WTX(WN)=KFSOTX
     C                   EVAL      WTO(WN)=WSSOK
     C                   EVAL      WTU(WN)=WSSOKURL
     C                   ENDIF
     C     NextFri1      TAG
     C                   END                                                     2<-E
     C     HEADFK        READE     FRISOK                                 33
     C  N33              ENDDO                                                  1<-E
      *------------------------------------------------------------------------------------
      * Vis ikke-trackbar søkevei
     C     HEADFK        SETLL     FRISOK
     C     HEADFK        READE     FRISOK                                 33
     C                   DOW       *IN33 = *OFF                                 1<-B
     C     FSKODE        CHAIN     KODFRI                             33
     C     *IN33         CABEQ     '1'           NextFri2
     C     'A'           LOOKUP    DFS                                    33
     C     *IN33         CABEQ     '0'           NextFri2
     C                   IF        FSKODE = 'IFB'                                2<-B
     C                   EXSR      TstFbr
     C                   END                                                     2<-E
      * Har denne frisok-kode peker til Track&Trace-URL-definisjon?
     C                   EVAL      KFKOD = KFSTTU
     C     KOFASTK1      CHAIN     KOFAST                             33
     C                   IF        *IN33                                         2<-B
     C     WN            IFLE      9
     C                   ADD       1             WN
     C                   EVAL      WTX(WN)=KFSOTX
     C                   EVAL      WTO(WN)=FSSOK
     C                   EVAL      WTU(WN)=*BLANKS
     C                   ENDIF
     C     NextFri2      TAG
     C                   END                                                     2<-E
     C     HEADFK        READE     FRISOK                                 33
     C  N33              ENDDO                                                  1<-E

     C                   EXSR      TRACKINFO

     C                   ENDSR
      *=====================================================================******
      *  TRACKINFO
      *=====================================================================******
     C     TRACKINFO     BEGSR

     C                   Z-ADD     0             Wn
      * Finn antall PODs på oppdraget (vis kun siste)
     C                   MOVE      *ZEROS        PodNr             3 0
     C                   MOVE      *ZEROS        antpod            3 0
     C                   MOVE      *ZEROS        TTFBNR
     C     podkey        setll     trackl02
     C     podkey        reade     trackl02                               50
     C     *IN50         doweq     *OFF
     C                   ADD       1             antpod
     C     podkey        reade     trackl02                               50
     C                   END

     C     TrackKey      setll     trackl01
     C     TrackKey      reade     trackl01                               50
     C     *IN50         doweq     *OFF
     C                   MOVE      ' '           VisWEB
     C                   EVAL      KFKOD = TTACTI
     C     ACTKey        CHAIN     KOFAST
      * Vis kun hendelser på oppdr.nivå - ved POD vis kun siste..
     C     TTFBNR        IFNE      0
     C                   MOVE      ' '           VisWEB
     C                   ELSE
     C     TTACTI        IFEQ      'POD'
     C                   ADD       1             PodNr
     C     PodNr         IFNE      AntPOD
     C                   MOVE      ' '           VisWEB
     C                   END
     C                   END
     C                   END

     C     VISWEB        IFEQ      'J'
     C     TTACTI        IFEQ      'POD'
     C     XSPRÅK        IFEQ      'EN'
     C                   EVAL      UTTEXT = KFTXTB + TTTEXT
     C                   ELSE
     C                   EVAL      UTTEXT = KFTXTB + TTTEXL
     C                   END
     C                   ELSE
     C     XSPRÅK        IFEQ      'EN'
     C                   EVAL      UTTEXT = TTTEXT
     C                   ELSE
     C                   EVAL      UTTEXT = TTTEXL
     C                   END
     C                   END
     C     WN            IFLE      9
     C                   ADD       1             WN
     C                   MOVE      TTDATE        WTTD(WN)
     C                   MOVE      TTTIME        WTTT(WN)
     C                   EVAL      WTTX(WN)=UTTEXT
     C                   EVAL      WTTG(WN)=*BLANKS
     C                   ENDIF
      * Dersom det er kun ett fraktbrevsnr kan evt.  gif vises
     C     HXSNR17       IFNE      *BLANKS
     C                   EVAL      SNR  = HXSNR17
     C                   END
     C     TTacti        IFEQ      'POD'
     C     snr           andne     'FLERE'
     C     snr           andne     *BLANKS
     C                   EXSR      getgif
     C                   END
      * VEDL TRMODUL/UTLAND KAN SENDNR VÆRE  AVD_OPPDNR
     C     TTacti        IFEQ      'POD'
     C     GIFOK         andne     'J'
     C                   MOVEL     Snr           SnrGm            17
     C                   MOVE      HEAVD         DSAVD
     C                   MOVE      '_'           Strek
     C                   MOVE      HEOPD         DSOPD
     C                   EVAL      snr    = DSAVOP
     C                   EXSR      getgif
     C                   MOVEL     SnrGm         Snr
     C                   END

      * Vis evt gif ved COL/TEI/TEU/TE2
     C     TTacti        IFEQ      'COL'
     C     TTacti        oreq      'TEI'
     C     TTacti        oreq      'TEU'
     C     TTacti        oreq      'TE2'
     C                   EXSR      getgif2
     C     GIFOK         IFNE      'J'
     C                   MOVEL     Snr           SnrGm
     C                   MOVE      HEAVD         DSAVD
     C                   MOVE      '_'           Strek
     C                   MOVE      HEOPD         DSOPD
     C                   EVAL      snr    = DSAVOP
     C                   EXSR      getgif2
     C                   MOVEL     SnrGm         Snr
     C                   ENDIF
     C                   ENDIF

     C                   END
     C     TrackKey      reade     trackl01                               50
     C                   END

     C                   ENDSR
      *=====================================================================******
      *  Hent evt grafisk signatur
      *=====================================================================******
     C     GETGIF        BEGSR

     C                   MOVE      'N'           GIFOK             1
     C                   MOVE      *BLANKS       UBANE            70
     C                   MOVEL     '/syspeddev/' UBANE
     C     UBANE         CAT       'signatur/':0 UBANE
     C     UBANE         CAT       SNR:0         UBANE
     C     UBANE         CAT       '.gif':0      UBANE
     C                   CALL      'BHRURLCL'
     C                   PARM                    UBANE
     C                   PARM                    GIFOK
      * gif fantes ikke, prøv med bmp.
     C     GIFOK         IFNE      'J'
     C                   MOVE      *BLANKS       UBANE            70
     C                   MOVEL     '/syspeddev/' UBANE
     C     UBANE         CAT       'signatur/':0 UBANE
     C     UBANE         CAT       SNR:0         UBANE
     C     UBANE         CAT       '.bmp':0      UBANE
     C                   CALL      'BHRURLCL'
     C                   PARM                    UBANE
     C                   PARM                    GIFOK
     C                   END
      * bmp fantes ikke, prøv med jpg.
     C     GIFOK         IFNE      'J'
     C                   MOVE      *BLANKS       UBANE            70
     C                   MOVEL     '/syspeddev/' UBANE
     C     UBANE         CAT       'signatur/':0 UBANE
     C     UBANE         CAT       SNR:0         UBANE
     C     UBANE         CAT       '.jpg':0      UBANE
     C                   CALL      'BHRURLCL'
     C                   PARM                    UBANE
     C                   PARM                    GIFOK
     C                   END
     C     GIFOK         IFEQ      'J'
     C                   MOVE      *BLANKS       uttext
     C     uttext        CAT       UBANE:0       uttext
     C     WN            IFLE      9
     C                   EVAL      WTTG(WN)=UTTEXT
     C                   ENDIF
     C                   MOVE      *BLANKS       uttext
     C                   END
     C                   ENDSR
      *=================================================================
     C     GETGIF2       BEGSR

     C                   MOVE      'N'           GIFOK             1
     C                   MOVE      *BLANKS       UBANE            70
     C                   MOVEL     '/syspeddev/' UBANE
     C     UBANE         CAT       'signatur/':0 UBANE
     C     UBANE         CAT       TTACTI:0      UBANE
     C     UBANE         CAT       '_':0         UBANE
     C     UBANE         CAT       SNR:0         UBANE
     C     UBANE         CAT       '.gif':0      UBANE
     C                   CALL      'BHRURLCL'
     C                   PARM                    UBANE
     C                   PARM                    GIFOK
      * gif fantes ikke, prøv med bmp.
     C     GIFOK         IFNE      'J'
     C                   MOVE      *BLANKS       UBANE            70
     C                   MOVEL     '/syspeddev/' UBANE
     C     UBANE         CAT       'signatur/':0 UBANE
     C     UBANE         CAT       TTACTI:0      UBANE
     C     UBANE         CAT       '_':0         UBANE
     C     UBANE         CAT       SNR:0         UBANE
     C     UBANE         CAT       '.bmp':0      UBANE
     C                   CALL      'BHRURLCL'
     C                   PARM                    UBANE
     C                   PARM                    GIFOK
     C                   END
      * bmp fantes ikke, prøv med jpg.
     C     GIFOK         IFNE      'J'
     C                   MOVE      *BLANKS       UBANE            70
     C                   MOVEL     '/syspeddev/' UBANE
     C     UBANE         CAT       'signatur/':0 UBANE
     C     UBANE         CAT       TTACTI:0      UBANE
     C     UBANE         CAT       '_':0         UBANE
     C     UBANE         CAT       SNR:0         UBANE
     C     UBANE         CAT       '.jpg':0      UBANE
     C                   CALL      'BHRURLCL'
     C                   PARM                    UBANE
     C                   PARM                    GIFOK
     C                   END
     C     GIFOK         IFEQ      'J'
     C                   MOVE      *BLANKS       uttext
     C                   MOVEL     '<p><img bord'uttext
     C     uttext        CAT       'er="0" sr':0 uttext
     C     uttext        CAT       'c="':0       uttext
     C     uttext        CAT       UBANE:0       uttext
     C     uttext        CAT       '"></p>':0    uttext
     C     WN            IFLE      9
     C                   EVAL      WTTG(WN)=UTTEXT
     C                   ENDIF
     C                   MOVE      *BLANKS       uttext
     C                   END
     C                   ENDSR
      ***********************************************
     C     TSTFBR        BEGSR
      ***********************************************
      * Test om transportør på fraktbrev overstyrer T&T-URL-kode
      * hvis innlandsmodul  og dette er inl-fraktbrevet
     C     HEUR          IFEQ      'H'
     C     HEpro         andne     *ZEROS
     C     HXSNR17       andeq     FSSOK
     C     hepro         CHAIN     Turer14                            33
     C     *IN33         IFEQ      '0'
     C                   MOVE      TUKNT2        DFTRAN
     C                   goto      TraTag
     C                   ENDIF
     C                   ENDIF

     C     FSSOK         CHAIN     dokuf7                             33
     C     *IN33         CABEQ     '1'           UtTstFbr
     C     TraTag        tag
     C     DFTRAN        CABEQ     0             UtTstFbr
     C     TranKey       CHAIN     Tran                               33
     C     *IN33         CABEQ     '1'           UtTstFbr
     C     VMINTP        CABEQ     *BLANKS       UtTstFbr
     C                   EVAL      KFSTTU  = VMINTP
     C                   EVAL      KFSOTX  = 'Fr.brevsnr ' + DFNAT
     C     UtTstFbr      ENDSR
      *=====================================================================******
      *  INITIER
      *=====================================================================******
     C     INIT          BEGSR
     C     arkivkey      KLIST
     C                   KFLD                    unkode
     C                   KFLD                    HEAVD
     C                   KFLD                    HEOPD
     C                   MOVE      'A'           unkode            1
     C     HEADFK        klist
     C                   kfld                    HEAVD
     C                   kfld                    HEOPD
     C     FAKKEY        klist
     C                   kfld                    HEAVD
     C                   kfld                    HEOPD
     C                   kfld                    FAFAKT
     C     KOFASTK1      klist
     C                   kfld                    KFTYP1           10
     C                   kfld                    KFKOD
     C                   EVAL      KFTYP1 = 'TRACKPREFI'
     C     KOFASTK2      klist
     C                   kfld                    KFTYP2           10
     C                   kfld                    KFKOD
     C                   EVAL      KFTYP2 = 'TRACKSUFFI'
     C     KOFASTK3      klist
     C                   kfld                    KFTYP3           10
     C                   kfld                    KFKOD3            5
     C                   MOVEL     'WEBETRACK'   KFTYP3
     C     KOFASTK4      klist
     C                   kfld                    KFTYP3
     C                   kfld                    KFKOD4            5
     C                   MOVEL     '   **'       KFKOD4
     C     KOFASTK5      klist
     C                   kfld                    KFTYP3
     C                   kfld                    KFKOD5            5
     C                   MOVEL     'OTHER'       KFKOD5
     C     BrParKey      klist
     C                   kfld                    PABRID
     C                   kfld                    PAKUNR
     C                   kfld                    PAID
     C     TrackKey      KLIST
     C                   KFLD                    HEAVD
     C                   KFLD                    HEOPD
     C     PODKEY        KLIST
     C                   KFLD                    HEAVD
     C                   KFLD                    HEOPD
     C                   KFLD                    TTFBNR
     C                   KFLD                    TTACTI
     C                   MOVEL     'POD'         TTACTI
     C     ActKey        KLIST
     C                   KFLD                    KFTYPT           10
     C                   KFLD                    KFKOD
     C                   MOVEL     'TRACKT'      KFTYPT
     C     TranKey       klist
     C                   kfld                    BIFIRM
     C                   kfld                    DFTRAN
     C     ARKEXTK       KLIST
     C                   KFLD                    ARFIRM
     C                   KFLD                    ARCEXT
     C     FREETXT2K     KLIST
     C                   KFLD                    HEAVD
     C                   KFLD                    HEOPD
     C                   KFLD                    FRTKOD
     C                   MOVE      'A'           FRTKOD
     C     FREETXT2K1    KLIST
     C                   KFLD                    HEAVD
     C                   KFLD                    HEOPD
     C                   KFLD                    XFRTKOD
     C                   MOVE      '1'           XFRTKOD           1
     C     DokufmKey     KLIST
     C                   KFLD                    FMRI
     C                   KFLD                    HEAVD
     C                   KFLD                    HEOPD
     C                   MOVE      'F'           FMRI

     C                   OPEN      BRIDF
     C     WSUSER        CHAIN(N)  BRIDF                              50
      * Ugyldig userID
     C     *IN50         IFEQ      '1'
     C                   close     BRIDF
     C                   EVAL      *INlr = *on
     C                   return
     C                   ENDIF
      * En "standardvariant" libl: CALL bound (INCGI=*MODULE) med parameter.
     C     BILIBL        IFEQ      *BLANKS
     C                   CALLb     'INCGI'
     C                   PARM                    BISTDL
     C                   ELSE
      * Helt egen bibl.liste satt på user - normal CALL (BILIBL er "*pgm")
     C                   CALL      BILIBL
     C                   END
      * Odd/Even/Rowhead-farger,Logobilde,Språk,Intern/Ekstern bruker,  mm
     C                   CALL      'ESGETPAR'
     C                   PARM                    BIBRID
     C                   PARM                    BIFIRM
     C                   PARM                    BIKUNR
     C                   PARM                    BIKNG
     C                   PARM                    RowHead          10
     C                   PARM                    Odd              10
     C                   PARM                    Even             10
     C                   PARM                    LogoImg          50
     C                   PARM                    XSPRÅK            2
     C                   PARM                    XINTERN           1
     C                   PARM                    PARMDS1        1024
     C                   PARM                    PARMDS2        1024
     C                   PARM                    PARMDS3        1024
     C                   MOVE      BIBRID        PABRID
     C                   MOVE      *ZEROS        PAKUNR
     C                   OPEN      HEADF
     C                   OPEN      ARKIVL02
     C                   OPEN      firmarc
     C                   OPEN      FIRM
     C                   OPEN      arktxt
     C                   OPEN      ARKEXT
     C                   OPEN      FRISOK
     C                   OPEN      FRISOL01
     C                   OPEN      HEAD17
     C                   OPEN      KODFRI
     C                   OPEN      DOKUF7
     C                   OPEN      TURER14
     C                   OPEN      TRAN
     C                   OPEN      KOFAST
     C                   OPEN      BRPARF
     C                   OPEN      TRACKL01
     C                   OPEN      TRACKL02
     C                   OPEN      FREETXT2
     C                   OPEN      FAK8
     C                   OPEN      GSSCGL02
     C                   OPEN      TRACKT
     C                   OPEN      DOKUFM

      * Initiere DS (obs - pass at ikke verdier tatt inn i parse  nulles)
     C                   MOVE      *ZEROS        WSATA
     C                   MOVE      *ZEROS        WDsÅMD
     C                   MOVE      *ZEROS        WDsDMÅ

     C     BRPARFK       klist
     C                   kfld                    PABRID
     C                   kfld                    PAKUNR
     C                   kfld                    PAID

     C                   EVAL      PABRID = WSUSER

     C                   MOVEL     'NOTES'       PAID
     C     BRPARFK       CHAIN     BRPARF                             33
     C                   IF        (*IN33 OR
     C                             ((PAVRDA <> 'j') AND
     C                              (PAVRDA <> 'J')))
     C                   MOVE      'N'           XWRKNOTES         1
     C                   ELSE
     C                   MOVE      'J'           XWRKNOTES         1
     C                   END

     C                   MOVEL     'SPRÅK'       PAID
     C     BRPARFK       CHAIN     BRPARF                             33
     C                   IF        (*IN33 OR (PAVRDA <> 'EN'))
     C                   MOVE      *BLANKS       XSPRÅK            2
     C                   ELSE
     C                   MOVE      'EN'          XSPRÅK            2
     C                   END

     C                   MOVE      *ZEROS        KN
     C                   MOVE      *ZEROS        XN2               3 0
     C                   MOVEL     'KUNGR'       PAID
     C     BRPARFK       CHAIN     BRPARF                             33
     C                   IF        (*IN33 OR (PAVRDA = *BLANKS))
     C                   MOVE      BIKUNR        KN(1)
     C                   ELSE
     C                   MOVEL     PAVRDA        CGCG
     C     CGCG          SETLL     GSSCGL02
     C     CGCG          READE     GSSCGL02                               33
     C                   DOW       *IN33 = *OFF
     C                   ADD       1             XN2
     C                   MOVE      CGCNO         KN(XN2)
     C     CGCG          READE     GSSCGL02                               33
     C                   ENDDO
     C                   END
      * LÅNER ARKTY-PARAMETEREN FOR Å AVGJØRE OM BRUKER KAN SE FAKTURALINK
      * sjekk om arkivtypene fa,fs,fx finnes(på førstelinjer) Hvis ikke, N i se fakturalink
      * (sjekk av arkivtyper for å se pdf-dok, sker generelt annet sted)
     C                   MOVE      'N'           OKFaktLink        1
     C                   MOVE      'ARKTY'       PAID
     C     BrParKey      CHAIN     BRPARF                             33
     C     *IN33         IFEQ      '0'
     C     'fa'          scan      Pavrda                                 33
     C  N33'fs'          scan      Pavrda                                 33
     C  N33'fx'          scan      Pavrda                                 33
     C   33              MOVE      'J'           OKFaktLink
     C                   END
      * logikk ved eksternref i parameterstreng
     C     EXTREF        IFNE      *BLANKS
     C     HEAVD         ANDEQ     0
     C     HEOPD         ANDEQ     0
     C                   MOVE      'EXTRE'       PAID
     C     BrParKey      CHAIN     BRPARF                             33
     C     *IN33         IFEQ      '0'
     C                   MOVEL     PAVRDA        FSKODE
     C                   EXSR      finnopd
     C                   ELSE
     C                   EXSR      finnopdh
     C                   END
     C                   END

     C     BIFIRM        CHAIN     FIRM                               33

     C                   ENDSR
      ****************************************************************************
     C     FINNOPD       BEGSR
      ****************************************************************************
     C     FRIHEAD       KLIST
     C                   KFLD                    FSAVD
     C                   KFLD                    FSOPD
     C     FRIKEY0       KLIST
     C                   KFLD                    FSKODE
     C                   KFLD                    FSSOK
     C                   KFLD                    FSDTOP
     C     FRIKEY1       KLIST
     C                   KFLD                    FSKODE
     C                   KFLD                    FSSOK
     C                   EVAL      FSSOK  = EXTREF
     C                   EVAL      FSDTOP = 99999999
     C     FRIKEY0       SETGT     FRISOL01
     C                   setoff                                       33
     C     *IN33         doweq     '0'
     C     FRIKEY1       readpe    FRISOL01                               33
     C     *IN33         IFEQ      '0'
     C     FRIHEAD       CHAIN     HEADF                              34
     C     *IN34         IFEQ      '0'
     C     HEKNA         IFEQ      BIKUNR
     C     TRKNFA        OREQ      BIKUNR
     C                   MOVE      heavd         wsavd
     C                   MOVE      heopd         wsopd
     C                   GOTO      UTFRI
     C                   END
     C                   END
     C                   END
     C                   END
     C                   Z-ADD     0             heavd
     C                   Z-ADD     0             heopd
     C     UTFRI         ENDSR
      ****************************************************************************
     C     FINNOPDH      BEGSR
      ****************************************************************************
     C     H17KEY        KLIST
     C                   KFLD                    HERFA
     C                   EVAL      HERFA  = EXTREF
     C     H17KEY        SETGT     HEAD17
     C                   setoff                                       33
     C     *IN33         doweq     '0'
     C     H17KEY        readpe    HEAD17                                 33
     C     *IN33         IFEQ      '0'
     C     HEKNA         ANDEQ     BIKUNR
     C                   MOVE      heavd         wsavd
     C                   MOVE      heopd         wsopd
     C                   GOTO      UTH17
     C                   END
     C                   END
     C                   Z-ADD     0             heavd
     C                   Z-ADD     0             heopd
     C     UTH17         ENDSR
      *=====================================================================******
      *  AVSLUTT
      *=====================================================================******
     C     EXIT          BEGSR
     C                   close     BRIDF
     C                   close     HEADF
     C                   CLOSE     ARKIVL02
     C                   CLOSE     firmarc
     C                   CLOSE     FIRM
     C                   CLOSE     arktxt
     C                   CLOSE     ARKEXT
     C                   CLOSE     FRISOK
     C                   CLOSE     FRISOL01
     C                   CLOSE     HEAD17
     C                   CLOSE     KODFRI
     C                   CLOSE     KOFAST
     C                   CLOSE     DOKUF7
     C                   CLOSE     TURER14
     C                   CLOSE     TRAN
     C                   close     BRPARF
     C                   CLOSE     TRACKL01
     C                   CLOSE     TRACKL02
     C                   CLOSE     FREETXT2
     C                   CLOSE     FAK8
     C                   CLOSE     GSSCGL02
     C                   CLOSE     TRACKT
     C                   CLOSE     DOKUFM
     C                   CALLP     wrtsection('*fini')
     C                   EVAL      *INlr = *on

     C                   ENDSR
      ***********************************************
     C     genbane       BEGSR
      ***********************************************
     C                   MOVE      ARKLAG        ARCEXT
     C     ARKEXTK       CHAIN     ARKEXT                             33
     C   33ARFIRM        CHAIN     FIRMARC                            33
      * genererer bane for lagring
     C                   MOVE      ARAVD         AAVD              4
     C                   MOVE      AROPD         AOPD              7
     C     UPDF(na)      CAT       '/':0         UPDF(na)
     C     UPDF(na)      CAT       arcane:0      UPDF(na)
     C     UPDF(na)      CAT       '/':0         UPDF(na)
     C     ARLINK        IFNE      *BLANKS
     C     UPDF(na)      CAT       ArLink:0      UPDF(na)
     C                   ELSE
     C     UPDF(na)      CAT       aavd:0        UPDF(na)
      * TEST LINK
     C                   EVAL      UXLINK = '/' + %TRIM(ARCANE)
     C                             + '/' + AAVD + AOPD
     C                             + %TRIM(ARTYPE)
     C                             + %TRIM(ARUNDE)
     C                             + '.pdf'
     C                   MOVE      'J'           UXOK
     C                   CALL      'CHECKLNK'
     C                   PARM                    UXLINK           50
     C                   PARM                    UXOK              1

     C                   IF        UXOK = 'N'
      * GAMMEL DOKUMENT MED 5 SIFRE OPPDRAGSNR
     C                   MOVE      aopd          AOPD5             5
     C                   CAT       aopd5:0       UPDF(NA)
     C                   ELSE
     C     UPDF(na)      CAT       aopd:0        UPDF(na)
     C                   END
     C     UPDF(na)      CAT       artype:0      UPDF(na)
     C     UPDF(na)      CAT       arunde:0      UPDF(na)
     C                   END
     C     '.pdf'        SCAN      updf(na)                               33
     C  N33'.PDF'        SCAN      updf(na)                               33
     C  N33'.'           SCAN      arlink                                 33
     C  N33              IF        ARKLAG = *BLANKS
     C                   CAT       '.pdf':0      UPDF(na)
     C                   END
     C                   IF        ARRFK = *BLANKS
     C                   CAT       ARTXT:0       UPDF(na)
     C                   ELSE
     C                   CAT       ARRFK:0       UPDF(na)
     C                   END
     C     UPDF(na)      CAT       '/syspeddev':0UPDF(na)
     C     UPDF(na)      CAT       '/PDF.gif"':0 UPDF(na)
     C     UPDF(na)      CAT       artxt:0       UPDF(na)

     C                   ENDSR
      **************************************************************
     C     lesdok        BEGSR
      **************************************************************
     C                   z-ADD     1             na                3 0
     C                   MOVEa     *BLANKS       updf
      * Vis kun dokumeter bruker er autorisert for å se...
     C                   MOVE      *BLANKS       ATString
     C                   MOVE      'ARKTY'       PAID
     C     BrParKey      CHAIN     BRPARF                             33
     C     *IN33         CABEQ     '1'           UtDok
     C                   MOVEL     Pavrda        ATstring1
     C     BrParKey      READE     BRPARF                                 33
     C  N33              MOVEL     Pavrda        ATstring2
     C  N33BrParKey      READE     BRPARF                                 33
     C  N33              MOVEL     Pavrda        ATstring3
     C  N33BrParKey      READE     BRPARF                                 33
     C  N33              MOVEL     Pavrda        ATstring4
     C     1             DO        64            ln                2 0
     C                   MOVEa     AT(ln)        A2(ln)
     C                   END

     C                   setoff                                       94
     C     arkivkey      SETLL     ARKIVL02
     C     *IN(94)       doweq     '0'
     C     arkivkey      READE     ARKIVL02                               94
     C  N94na            comp      20                                 94
     C     *IN94         IFEQ      '0'
      * visse typer dokument må "eies" av webkunden
     C     artype        IFEQ      'go'
     C     artype        oreq      'am'
     C     artype        oreq      'fa'
     C     artype        oreq      'fs'
     C     artype        oreq      'fx'
     C     artype        oreq      'dg'
     C     artype        oreq      'ta'
     C                   IF            XINTERN <> 'J'                           Intern:ikke KNR-test
     C     1             DO        30            XN2
     C     KN(XN2)       CABEQ     0             NEXTDOC
     C                   IF        ARKUND = KN(XN2)
     C                   LEAVE
     C                   ENDIF
     C                   ENDDO
     C                   ENDIF
     C                   ENDIF
      * Brukeren må være autorisert for å se aktuell type
     C     artype        lookup    A2                                     33
     C     *IN33         CABEQ     '0'           NextDoc
      * OK
     C     artype        IFEQ      'go'
     C     artype        oreq      'am'
     C     artype        oreq      'fx'
     C     artype        oreq      'fs'
     C                   MOVE      *ZEROS        aravd
     C                   MOVE      *ZEROS        aropd
     C                   END
     C     artype        CHAIN     arktxt                             95
     C  n95              EXSR      genbane
     C  n95              ADD       1             na

     C     NextDoc       TAG
     C                   END
     C                   END

     C     UTDOK         ENDSR
