********************************************************************
      * RETTINGER I DETTE PROGRAM:
PTFnr:*Sek Sig Vers  Beskrivelse...........................
""""""*"""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""
10XXX * 01 SH  PTF10 avvikende momssats .....
10XXX * 02 SH  PTF12 behold bilagsnummer .....
********************************************************************
      *
      *
      * ferdeling bilag mot interrinskonto
      *
N01  FKODWL01   IF   E           K DISK
     Fkosal01   IP   E           K DISK
     FKOSAL02   UF A E           K DISK
     F                                     RENAME(KOSAR:KOSAR02)
     FFIRM      IF   E           K DISK
     FFIRMKOS   IF   E           K DISK
     Fkosbl02   UF A E           K DISK
     FNUMML01   UF   E           K DISK
     FSYSRL01   UF   E           K DISK
     D                 DS
     D  BILDAT                 1      8  0
     D  BILAAR                 1      4  0
     D  BILMND                 5      6  0
     D  BILDAG                 7      8  0
      *
      * INITIERING
      *
     C  N99              EXSR      INIT
     C  N99              SETON                                        99
      *
      * ikke les poster generert av dette program
      *
      *
      * TESTER AVVIKENDE PERIODE
      *
      * ikke les poster generert av dette program
      * de har aktivitektskode = I
      *
     c     aktkod        ifeq      'A'
     c                   EXSR      AVVIK
     C     DIFF          IFEQ      'J'
     C                   EXSR      FORDEL
     C                   END
     C                   END
      * renbumerer linjenummer i bilag
     cLR                 EXSR      RENUM
      ******************************************************
     C     AVVIK         BEGSR
      ******************************************************
      * test om billagsnummer har et avvik
      * setter da DIFF til 'J'
      *
     C                   SETOFF                                       33
     C                   MOVE      'N'           DIFF              1
     C                   MOVE      BILNR         BILNRH            7 0
     C                   MOVE      PERAAR        PERAARH           4 0
     C                   MOVE      PERNR         PERNRH            2 0
      *
     C     KEY           KLIST
     C                   KFLD                    BILNRH
      *
     C     KEY           SETLL     KOSBL02
     C     *IN33         DOWEQ     '0'
     C     KEY           READE     KOSBL02                                33
     C     *IN33         IFEQ      '0'
n02  c     aktkod        andeq     'A'
     C     PERAAR        IFNE      PERAARH
     C     PERNR         ORNE      PERNRH
     C                   MOVE      'J'           DIFF
      *
      * VARIABLE VAT
      *
     C     FITAX         ADD       1             FITAXN            5 4
     C     FITAXD        IFNE      *ZEROS
     C     FITAX2        ANDNE     *ZEROS
     C     BILDAT        ANDLT     FITAXD
     C     FITAX2        ADD       1             FITAXN
     C                   END
     C                   GOTO      AVVIKUT
     C                   ENDIF
     C                   ENDIF
     C                   ENDDO
     C     AVVIKUT       ENDSR
     C*************************************************************
     C     FORDEL        BEGSR
     C*************************************************************
     C     KEYF          KLIST
     C                   KFLD                    BILNRH
     c                   setoff                                       33
      *
     C     KEYF          SETLL     KOSBL02
     C     *IN33         DOWEQ     '0'
     C     KEYF          READE     KOSBL02                                33
     C     *IN33         IFEQ      '0'
n02  c     aktkod        andeq     'A'
      *
      * trekker ut kun de postene som diferrerer fra hovedbillaget
      *
     c     PERAAR        IFNE      PERAARH
     c     PERNR         ORNE      PERNRH
      *
      * LEGGER INTERRIMKONTO PÅ FØRING
      * OG HOVEDBILAGET PERIODE
      *
      * TAR VARE PÅ FØRVERDIENE
      *
     C                   MOVE      KONTO         KONTOT            5 0
     C                   MOVE      PERAAR        PERAART           4 0
     C                   MOVE      PERNR         PERNRT            2 0
     C                   MOVE      KSTED         KSTEDT            4 0
     C                   MOVE      KBARER        KBARERT           4 0
     C                   MOVE      PROSNR        PROSNRT           8 0
     C                   MOVE      BILTXT        BILTXTT          15
     C                   MOVE      MOMSK         MOMSKT            1
      *
      * SETTER KONTERING    TIL HOVEDBILLAGETS PERIODE
      * og oppdaterer dette
      *
     C                   MOVE      PERAARH       PERAAR
     C                   MOVE      PERNRH        PERNR
     C                   MOVE      INTERR        KONTO
     C                   MOVE      *ZEROS        KSTED
     C                   MOVE      *ZEROS        KBARER
     C                   MOVE      *ZEROS        PROSNR
     C                   UPDATE    KOSBR
      *
      *
      *
     C                   EXSR      KONTER
     C                   ENDIF
     C                   ENDIF
     C                   ENDDO
     C                   ENDSR
     C*************************************************************
     C     KONTER        BEGSR
     C*************************************************************
      *
      * KONTERER INTERRIMSFØRINGER
      *
      *
      *
     C     KOSAFK        KLIST
     C                   KFLD                    FIFIRM
     C                   KFLD                    aktint
     C                   KFLD                    PERAAR
     C                   KFLD                    PERNR
     C                   move      'I'           aktint            1
      *
      * POSTERER PÅ KOSTNADSKONTO FØRST
      * IKKE MOMS PÅ INTERRIMSFØRINGENE
      *
     C                   MOVE      KONTOT        KONTO
     C                   MOVE      PERAART       PERAAR
     C                   MOVE      PERNRT        PERNR
     C                   MOVE      KSTEDT        KSTED
     C                   MOVE      KBARERT       KBARER
     C                   MOVE      PROSNRT       PROSNR
      *
      * reduserer brutto hvis moms
      *
     C     MOMSK         IFEQ      '1'
     C     BBELOP        DIV(H)    FITAXN        BBELOP
     C                   END
     C     MOMSK         IFNE      '0'
     C     MOMSK         ANDNE     '1'
     C     MOMSK         ANDNE     '4'
N01   * avvikende moms
N01  C     KODWKY        CHAIN     KODWL01                            84
N01  C     *IN84         IFEQ      *OFF
N01  C     MVAAVI        DIV       100           FITAXB            5 4
N01  C                   ADD       1             FITAXB
N01  C     BBELOP        DIV(H)    FITAXB        BBELOP
N01  C                   END
N01  C                   END
      *
     C                   MOVE      '0'           MOMSK
     C                   EXSR      GETSUR
      *
      *  FINNES RECORD I POSAF ?
      *
     C     KOSAFK        CHAIN     KOSAL02                            34
      *
      * skriv til fil
      *
     C     *IN34         IFEQ      '1'
s02  C*                  EXSR      HENTBN
n02  C                   MOVE      'A'           AKTKOD
n02  C                   MOVE      *BLANKS       VALKOD
     C                   EXSR      GETSUR
     C                   move      'I'           aktkod
     c                   write     kosar02
     C                   END
      *
      *  skriver til     POSBF
      *
     C                   move      'A'           aktkod
     C                   WRITE     KOSBR
     C
      *
      * POSTERER PÅ INTERRIMSKONTOEN
      *
     C                   MOVE      *blanks       BILTXT
     C                   MOVEL     BILNRH        BILTXT
     C                   MOVE      INTERR        KONTO
     C                   MOVE      *ZEROS        KSTED
     C                   MOVE      *ZEROS        KBARER
     C                   MOVE      *ZEROS        PROSNR
     C                   Z-SUB     BBELOP        BBELOP
     C                   EXSR      GETSUR
     C                   WRITE     KOSBR
     C                   ENDSR
     C******************************************
     C     GETSUR        BEGSR
     C******************************************
     C     SYSRKE        KLIST
     C                   KFLD                    FIFIRM
     C                   KFLD                    REGNA
     C                   MOVE      'SYS   '      REGNA             6
     C*
     C* HENT NYTT SURRUGATNR - FRA SYSRF LEGG I "POSLNR"
     C*
     C*
     C     SYSRKE        CHAIN     SYSRL01                            30
     C  N30              ADD       1             SISSGT
     C  N30              UPDATE    SYSRR
     C                   Z-ADD     SISSGT        POSLNR
     C                   ENDSR
      *
      **********************************************************
s02  C*    HENTBN        BEGSR
      **********************************************************
      *
     C* DEFINERER NØKKEL TIL NUMML01
      *
s02  C*    NUMMKY        KLIST
s02  C*                  KFLD                    FIFIRM
s02  C*                  KFLD                    SÅR               4 0
s02  C*                  KFLD                    NOK1
s02  C*                  KFLD                    NOK2
s02  C*                  MOVE      'BILS'        NOK1              4
s02  C*                  MOVE      '    '        NOK2              4
s02  C*                  MOVE      PERAAR        SÅR
      *
      *
s02  C*    NUMMKY        CHAIN     NUMML01                            61
s02  C*    *IN61         IFEQ      '1'
s02  C*                  EXSR      GMLNUM
s02  C*                  END
      *
      *
s02  C* N61              DO
s02  C*                  ADD       1             SBNRNU
s02  C*                  MOVE      SBNRNU        BILNR
s02  C*                  MOVE      SBNRNU        BILNRS            7 0
s02  C*                  UPDATE    NUMMR
s02  C*                  END
s02  C*
s02  C*                  MOVE      'A'           AKTKOD
s02  C*                  MOVE      *BLANKS       VALKOD
s02  C*
s02  C*                  ENDSR
s02  C*
s02  C* ***********************************************************
s02  C*    GMLNUM        BEGSR
s02  C* ***********************************************************
s02  C*
s02  C*    SÅR           DOWGT     2002
s02  C*                  SUB       1             SÅR
s02  C*    NUMMKY        CHAIN     NUMML01                            61
s02  C* N61              LEAVE
s02  C*                  END
s02  C*
s02  C*                  ENDSR
s02  C*
     C*************************************************************
     C     INIT          BEGSR
     C*************************************************************
N01  C     KODWKY        KLIST
N01  C                   KFLD                    FIFIRM
N01  C                   KFLD                    WMVAKD
     C                   KFLD                    MOMSK
     C                   MOVE      *BLANKS       WMVAKD            2
     C                   READ      FIRM                                   33
     C     FIFIRM        CHAIN     FIRMKOS                            33
     c     tillat        ifne      'J'
     c                   seton                                        lr
     c                   return
     c                   end
     C                   ENDSR
      ******************************************************
     C     RENUM         BEGSR
      ******************************************************
      * renummererer bilagene i kosbf
      *
     C                   Z-ADD     0             LINJE             5 0
     C                   z-add     0             BILNR0            7 0
     c                   setoff                                       33
      *
     C     KEY0          KLIST
     C                   KFLD                    BILNR0
      *
     C     KEY0          SETLL     KOSBL02
     C     *IN33         DOWEQ     '0'
     C                   READ      KOSBL02                                33
     C     *IN33         IFEQ      '0'
     C                   ADD       1             LINJE
     C                   Z-ADD     LINJE         POSNR
     C                   UPDATE    KOSBR
     C                   ENDIF
     C                   ENDDO
     c                   exsr      kosafsr
     C                   ENDSR
      ******************************************************
     C     kosafsr       BEGSR
      ******************************************************
      * renummererer bilagene i kosbf
      *
     c                   setoff                                       33
      *
      *
     C     KOSAFK0       KLIST
     C                   KFLD                    FIFIRM
     C                   KFLD                    AKTINT
     C                   move      'I'           aktint            1
      *
     C     KOSAFK0       SETLL     KOSAL02
     C     *IN33         DOWEQ     '0'
     C     KOSAFK0       READE     KOSAL02                                33
     C     *IN33         IFEQ      '0'
     C                   move      'A'           AKTKOD
     C                   UPDATE    KOSAR02
     C                   ENDIF
     C                   ENDDO
     C                   ENDSR
