      *********************************************************************
      *
CRTPG+*  CRTPGM SYSPED/SYTEIW3 MODULE(*LIBL/SYTEIW3
CRTPGM*        *LIBL/CHECKUSR *LIBL/INCGI) ACTGRP(CGI) AUT(*USE)
      *
      *********************************************************************
      * MAIN PROGRAM FLOW
      *********************************************************************
      /copy syspeds/qrpgsrcpy,hspecs
      /copy syspeds/qrpgsrcpy,hspecsbnd
     FBRIDF     UF   E           K DISK    USROPN
     FHENOS     IF   E           K DISK    USROPN
     FHENOK     IF   E           K DISK    USROPN
     FHEADF     IF   E           K DISK    USROPN
     FDOKUFM    IF   E           K DISK    USROPN
     FCUNDL01   IF   E           K DISK    USROPN
      *--------------------------------------------------------------------
      * Prototype defintions and standard system API error structure
      *--------------------------------------------------------------------
      /copy syspeds/qrpgsrcpy,prototypeb
      /copy syspeds/qrpgsrcpy,usec
      *--------------------------------------------------------------------
      * Variables common to CGI programs
      *--------------------------------------------------------------------
      /copy syspeds/qrpgsrcpy,variables3
      *--------------------------------------------------------------------
      * Variables received from the input string
     D OddEven         s             10
     D lng             s              2
     D BckGnd          s             10
     D UsrSpcName      s             10
     D WSUSER          S             10
     D WSNA            S             30
     D Term            s              4
     D XXLNR           s              7
     D Ekod            s              3
     D Ekey            s             35
     D HOLNR           s              7  0
     D XXLNR2          s              3
     D AVD             s              4
     D OPD             s              7
     D VisAChecked     s             10
     D VisAlleS        s              1
     D ANTSND          s              5  0
     D MaxSN           s              5
     D MaxSND          s              5  0
     D ANTRCD          s              5  0
     D MaxRC           s              5
     D MaxRCD          s              5  0
     D PGM             C                   CONST('SYSPED/CHECKUSR')
     D TITLE           C                   CONST('Terminal INN')
      *
     D IfsMultIndicators...
     d                 ds
     D  NoErrors                       n
     D  NameTooLong                    n
     D  NotAccessible                  n
     D  NoFilesUsable                  n
     D  DupSections                    n
     D  FileIsEmpty                    n
     D                 DS
     D  HERFK                  1     35
     D  HXSNDN                 1     20
     D                 DS
     D  FMMRK1                 1     35
     D  FMID                   1     18
     D  FMSTINN               33     33
     D                 DS
     D  WKey2                  1     30
     D  WDsUser                1     10
     D  WDsCLID               11     30
     D                 DS
     D  Wdata                  1    220
     D  WDsDT                  1      8
     D  WDsDTÅÅ                1      4
     D  WDsDTMM                5      6
     D  WDsDTDD                7      8
     D  WDsTID                 9     14
     D  WDsPALL               15     15
      *
      *--------------------------------------------------------------------
      * Prolog common to CGI programs
      * -Receive input from the remote browser
      *--------------------------------------------------------------------
      /copy syspeds/qrpgsrcpy,prolog3
      *=====================================================================******
      * MAIN PROCESS LINE
      *=====================================================================******
      * Get program start time for calculating execution time
     C                   time                    timedata1
      * Parse input
     C                   exsr      Parse
      *
     C                   EXSR      INIT
     C                   CALLB     PGM
     C                   PARM                    BIBRID
     C                   PARM                    UsrSpcName
     C                   PARM                    UINN              1
     C                   IF        UINN = 'N'
     C                   GOTO      SLUTT
     C                   END
      * dato/tid siste vellykkede operasjon.
     C     WSUSER        CHAIN     BRIDF                              50
     C                   CALL      'SYGE15C'
     C                   PARM                    WDT               8
     C                   PARM                    WTM               6
     C                   MOVE      WDT           BIDTF
     C                   MOVE      WTM           BITIDF
     C                   UPDATE    BRIDFR
     C                   MOVE      BIBESK        WINT              3
      *
      * Set output skeleton html member name
     C                   exsr      SetSkl
      *------------------                                                   ******
      * Write HTML sections
      *
      * 1-Section /$top
     C                   exsr      SetTop
     C                   callp     wrtsection('stdtop')
     C                   callp     wrtsection('top')
      * 4-Sections /$tablerow
      *
     c     HOLNR         ifne      *zeros
     c                   exsr      HKLL
     c                   else
     c                   exsr      EKLL
     c                   end
      *
     C                   callp     updHTMLvar('ANTSND':
     C                             %trim(%editc(ANTSND:'3')))
     C                   callp     updHTMLvar('MaxSnd':
     C                             %trim(%editc(MaxSnd:'3')))
     C                   callp     updHTMLvar('ANTRCD':
     C                             %trim(%editc(ANTRCD:'3')))
     C                   callp     updHTMLvar('MaxRcd':
     C                             %trim(%editc(MaxRcd:'3')))
     C                   callp     updhtmlvar('runtime':
     C                             %trim(%editw(sec:'     0 .   ')))
      *
     C                   callp     wrtsection('bot')
     C                   callp     wrtsection('stdbot')
      *
      * 6-Section /$endhtml
     C     endhtml       tag
     C                   exsr      SetEnd
     C     SLUTT         tag
     C                   callp     wrtsection('endhtml')
      * Do not delete the call to wrtsection with section name *fini.  It is needed
      * to ensure that all output html that has been buffered gets output.
     C                   callp     wrtsection('*fini')
     C                   EXSR      EXIT
     C                   return
      *=====================================================================******
      * Parse input
      *=====================================================================******
     C     Parse         begsr
     C                   eval      lng     = zhbgetvar('lng')
     C                   eval      BckGnd  = zhbgetvar('bckgnd')
     C                   EVAL      WSUSER  = zhbgetvar('USER')
     C                   EVAL      UsrSpcName  = zhbgetvar('UsrSpcName')
      *
     C                   eval      term     = zhbgetvar('term')
     C                   eval      XXLNR    = zhbgetvar('HOLNR')
     C                   eval      HOLNR   = c2n2(XXLNR)
     C                   eval      XXLNR2   = zhbgetvar('HSLNR2')
     C                   eval      HSLNR2  = c2n2(XXLNR2)
     C                   eval      AVD      = zhbgetvar('AVD')
     C                   eval      FMAVD   = c2n2(AVD)
     C                   eval      OPD      = zhbgetvar('OPD')
     C                   eval      FMOPD   = c2n2(OPD)
     C                   eval      eKod     = zhbgetvar('ekod')
     C                   eval      eKey     = zhbgetvar('ekey')
      * Checkboks for Vis lager
      *    ved KLIKK på checkboks kommer verdi Y/blank,
      *    ellers kommer verdi fra siste valg via "KunPaBil" som checked / blank(N)
     C     VisAChecked   Ifeq      'checked'
     C                   eval      VisAlleS = 'Y'
     C                   else
     C                   eval      VisAlleS = zhbgetvar('VisAlleS')
     C                   end
      *
     C                   endsr
      *=====================================================================******
      *  Set output variables for section /$top
      *  (search criteria)
      *=====================================================================******
     C     SetTop        begsr
      * Repeat national language for the next invocation
     C                   callp     updhtmlvar('LNG':lng:
     C                             InitHTMLVars)
     C                   callp     updHTMLvar('ROWHEAD':RowHead)
     C                   callp     updHTMLvar('LogoImg':LogoImg)
      * Color for text, background, links, visited links, active links
     C                   callp     updhtmlvar('TXTCOLOR':'black')
     C                   callp     updhtmlvar('BOLD':' ')
     C                   callp     updhtmlvar('BGCOLOR':BIFARG)
     C                   callp     updhtmlvar('LINK':'0000FF')
     C                   callp     updhtmlvar('VLINK':'FF0000')
     C                   callp     updhtmlvar('ALINK':'00FF00')
     C                   callp     updhtmlvar('TITLE':TITLE)
      * KUNDE
     C                   callp     updhtmlvar('WSKN':
     C                             %trim(%editc(BIKUNR:'Z')))
     C     CUNDL01K      CHAIN     CUNDL01                            33
     C                   callp     updhtmlvar('WSNA':KNAVN)
     C                   callp     updhtmlvar('USER':WSUSER)
BODY C                   callp     updhtmlvar('BODYCLASS':'class='+BIFARG)
     C                   callp     updHtmlVar('UsrSpcName':UsrSpcName)
     C                   callp     updHTMLvar('sdato':
     C                             %trim(%editw(BIDTV:'    .  .  ')))
     C                   callp     updHTMLvar('stid':
     C                             %trim(%editw(BITIDV:'  .  .  ')))
      *
     C                   callp     updHTMLvar('TERM':TERM)
     C     VisAlleS      Ifeq      'Y'
     C                   eval      VisAChecked = 'checked'
     C                   end
     C                   callp     updHTMLvar('VisAChecked':VisAChecked)
     C                   callp     updHTMLvar('HOLNR':
     C                             %trim(%editc(HOLNR:'Z')))
     C                   callp     updHTMLvar('EKOD':EKOD)
     C                   callp     updHTMLvar('EKEY':EKEY)
      *
     C     VisAlleS      Ifeq      'Y'
     C                   eval      VisAChecked = 'checked'
     C                   end
     C                   callp     updHTMLvar('VisAChecked':VisAChecked)
     c     HOLNR         ifne      *zeros
     C                   callp     updHTMLvar('TYPE':'Hente-Oppdrag')
     c     HKKey         CHAIN     HENOS
     c                   else
     C                   callp     updHTMLvar('TYPE':'E-sending')
     C     KEYHEA        CHAIN     HEADF                              33
     C                   eval      HSSNDN  = HXSNDN
     C                   eval      HSNAK   = HENAK
     c                   move      headk3        TMPadk           25
     C                   eval      HSSTDK  = TMPadk
     C                   eval      HSANT   = HENT
     c                   end
     C                   callp     updHTMLvar('HOLNR':
     C                             %trim(%editc(HOLNR:'Z')))
     C                   callp     updHTMLvar('HSLNR2':
     C                             %trim(%editc(HSLNR2:'Z')))
     C                   callp     updHTMLvar('AVD':
     C                             %trim(%editc(HEAVD:'Z')))
     C                   callp     updHTMLvar('OPD':
     C                             %trim(%editc(HEOPD:'Z')))
     C                   callp     updHTMLvar('HSSNDN':HSSNDN)
     C                   callp     updHTMLvar('HSNAK ':HSNAK )
     C                   callp     updHTMLvar('HSSTDK':HSSTDK)
     C                   callp     updHTMLvar('KLLTOT':
     C                             %trim(%editc(HSANT:'Z')))
     c                   move      *zeros        KLLSEKV           5 0
      *
     C                   endsr
      *=====================================================================******
      *  Set output variables for section /$tablerow (table row)
      *=====================================================================******
     C     SetTabRow     begsr
      *
     C                   callp     updHTMLvar('HKID ':HKID  )
     C                   callp     updHTMLvar('KLLSEKV':
     C                             %trim(%editc(KLLSEKV:'Z')))
     C                   IF        HKSTIN = ' '
     C                   callp     updHTMLvar('HKSTIN':' ')
     C                   ELSE
     C                   callp     updHTMLvar('HKSTIN':HKSTIN)
     C                   END
     C                   exsr      TstWrk
      *
     C                   endsr
      *
      *********************************************************
     C     TstWrk        begsr
      *********************************************************
      * Sjekk om de ligger i PDA-slyteworkfile, men kun hvis staus blank
     c     HKSTIN        ifne      ' '
     c                   move      *ON           *in33
     c                   goto      UtTstW
     c                   end
      *
     C*                  move      *zeros        WINTEG
     C*    WINTEG        SETLL     WRKCGI
     C*    WINTEG        Reade     WRKCGI                                 33
     C*    *in33         doweq     '0'
     c*    WDsCLID       cabeq     HKID          UtTstW
     C*    WINTEG        Reade     WRKCGI                                 33
     C*                  end
      *
     C     UtTstw        tag
     c     *in33         ifeq      '0'
     C                   callp     updHTMLvar('CSUSER':WDsUser)
     C                   move      WDsTID        CSTID             6 0
     C                   callp     updHTMLvar('CSTID':
     C                             %trim(%editw(CSTID:'  :  :  ')))
     C                   else
     C                   callp     updHTMLvar('CSUSER':'')
     C                   callp     updHTMLvar('CSTID ':'')
     C                   end
     C                   endsr
      *
      *=====================================================================******
      *  Set output variables for section /$tablerow (table row)
      *=====================================================================******
     C     SetTabRowE    begsr
      *
     C                   callp     updHTMLvar('TERM':TERM)
     C                   callp     updHTMLvar('HOLNR':
     C                             %trim(%editc(HOLNR:'Z')))
     C                   callp     updHTMLvar('EKOD':EKOD)
     C                   callp     updHTMLvar('EKEY':EKEY)
      *
     C                   eval      HKID  = '00'+FMID
     C                   eval      HKSTIN= FMSTINN
     C                   callp     updHTMLvar('HKID ':HKID  )
     C                   callp     updHTMLvar('KLLSEKV':
     C                             %trim(%editc(KLLSEKV:'Z')))
     C                   callp     updHTMLvar('HKSTIN':HKSTIN)
     C                   exsr      TstWrk
      *
     C                   endsr
      *=====================================================================******
      *  Set output variables for section /$endhtml
      *=====================================================================******
     C     SetEnd        begsr
      * Compute run time
     C                   time                    timedata2
     C     timedata2     subdur    timedata1     ms:*ms
     C                   eval      sec = ms / 1000000
     C                   callp     updhtmlvar('runtime':
     C                             %trim(%editw(sec:'     0 .   ')))
      *
     C                   endsr
      *=====================================================================******
     C*  Select a Recd
      *=====================================================================******
     C     RecordSlt     begsr
     C                   move      'N'           selected          1
     C                   move      'Y'           selected
      *
     C     RecordSltX    tag
     C                   endsr
      *=====================================================================******
      * Set html output skeleton member before its read into memory
      *=====================================================================******
     C     SetSkl        begsr
      *------------------
      * Set html output skeleton member
     C                   eval      IfsMultIndicators = gethtmlifsmult(
     C                             '/syspeddev/html/Header/eSpedTop.html -
     C                             /syspeddev/html/SYTEIW3.html -
     C                             /syspeddev/html/Footer/eSpedBot.html':
     C                             '/CGITAG/')
      *
     C                   endsr
      *=====================================================================******
      *  FYLL
      *=====================================================================******
     C     HKLL          begsr
      *
     C                   Move      *zeros        AntSnd
     C                   Move      *zeros        AntRcd
     C     MaxSnd        IFEQ      *ZEROS
     C                   Z-add     1000          MaxSnd
     C                   END
     C     MaxRcd        IFEQ      *ZEROS
     C                   Z-add     5000          MaxRcd
     C                   END
      *
     c     HKKey         setLL     HENOK
     c     HKKey         ReadE     HENOK                                  35
      *
     c     *IN35         doweq     '0'
     C                   Add       1             AntRcd
     C     AntRcd        CabGe     MaxRcd        SLHKLL
      *
     c                   add       1             KLLSEKV
     c     VisAlleS      ifne      'Y'
     c     HKSTIN        cabne     ' '           NextRec
     c                   end
      *
     C                   exsr      RecordSlt
     C     selected      ifeq      'Y'
     C                   exsr      SetTabRow
     C                   callp     wrtsection('row')
     C                   Add       1             AntSnd
     C     AntSnd        CabGe     MaxSnd        SLHKLL
     C                   endif
      *
     c     NextRec       Tag
     c     HOLNR         ReadE     HENOS                                  35
     c                   end
      *
     C     SLHKLL        TAG
      *
     C                   endsr
      *
      *=====================================================================******
      *  FYLL
      *=====================================================================******
     C     EKLL          begsr
      *
     C                   Move      *zeros        AntSnd
     C                   Move      *zeros        AntRcd
     C     MaxSnd        IFEQ      *ZEROS
     C                   Z-add     1000          MaxSnd
     C                   END
     C     MaxRcd        IFEQ      *ZEROS
     C                   Z-add     5000          MaxRcd
     C                   END
      *
     c     DokufmKey     setll     Dokufm
     c     DokufmKey     reade     Dokufm                                 35
      *
     c     *IN35         doweq     '0'
      *
     C                   Add       1             AntRcd
     C     AntRcd        CabGe     MaxRcd        SLEKLL
      *
     c                   add       1             KLLSEKV
     c     VisAlleS      ifne      'Y'
     c     FMSTINN       cabne     ' '           NextRecE
     c                   end
      *
     C                   exsr      RecordSlt
     C     selected      ifeq      'Y'
     C                   exsr      SetTabRowE
     C                   callp     wrtsection('row')
     C                   Add       1             AntSnd
     C     AntSnd        CabGe     MaxSnd        SLEKLL
     C                   endif
      *
     c     NextRecE      Tag
     c     DokufmKey     reade     Dokufm                                 35
     c                   end
      *
     C     SLEKLL        TAG
      *
     C                   endsr
      *=====================================================================******
      *  INITIER
      *=====================================================================******
     C     INIT          begsr
     C                   OPEN      BRIDF
     C     WSUSER        CHAIN(N)  BRIDF                              50
     C* En "standardvariant" libl: call bound (INCGI=*MODULE) med parameter.
     C     BILIBL        ifeq      *blanks
     C                   callb     'INCGI'
     C                   parm                    BISTDL
     C                   else
     C* Helt egen bibl.liste satt på user - normal CALL (BILIBL er "*pgm")
     C                   call      BILIBL
     C                   end
OddEv * hent Parametre som går igjen i mange prog:
OddEv *      Odd/Even/Rowhead-farger,Logobilde,Språk,Intern/Ekstern bruker,  mm
OddEvc                   call      'ESGETPAR'
OddEvc                   parm                    BIBRID
OddEvc                   parm                    BIFIRM
OddEvc                   parm                    BIKUNR
OddEvc                   parm                    BIKNG
OddEvc                   parm                    RowHead          10
OddEvc                   parm                    Odd              10
OddEvc                   parm                    Even             10
OddEvc                   parm                    LogoImg          50
OddEvc                   parm                    XSPRÅK            2
OddEvc                   parm                    XINTERN           1
OddEvc                   parm                    ParmDS1        1024
OddEvc                   parm                    ParmDS2        1024
OddEvc                   parm                    ParmDS3        1024
OddEv *
     C                   OPEN      HENOS
     C                   OPEN      HENOK
     C                   OPEN      HEADF
     C                   OPEN      DOKUFM
     C                   OPEN      CUNDL01
      *
     C     HKKey         KLIST
     C                   KFLD                    HOLNR
     C                   KFLD                    HSLNR2
     C     KEYHEA        KLIST
     C                   KFLD                    FMAVD
     C                   KFLD                    FMOPD
     C     DokufmKey     KLIST
     C                   KFLD                    FMRI
     C                   KFLD                    FMAVD
     C                   KFLD                    FMOPD
     C                   move      'F'           FMRI
     C     CUNDL01K      klist
     C                   kfld                    BIFIRM
     C                   kfld                    BIKUNR
      *
     C                   endsr
      *=====================================================================******
      *  AVSLUTT
      *=====================================================================******
     C     EXIT          begsr
     C                   CLOSE     BRIDF
     C                   CLOSE     HENOS
     C                   CLOSE     HENOK
     C                   CLOSE     HEADF
     C                   CLOSE     DOKUFM
     C                   CLOSE     CUNDL01
     C                   eval      *inlr = *on
      *
     C                   endsr
      *
