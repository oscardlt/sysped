      *********************************************************************
      *  Inngang til Print label (full / enkel) samt koble ekstern..
      *********************************************************************
      *
CRTPG+*  CRTPGM SYSPED/esla01 MODULE(*LIBL/esla01 *LIBL/INCGI)
CRTPGM*        ACTGRP(*NEW) AUT(*USE)
      *
********************************************************************
      * RETTINGER I DETTE PROGRAM:
PTFnr:*Sek Sig Vers  Beskrivelse...........................
""""""*"""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""
10XXX * 01 JOV PTF10 FEILMELDING DERSOM......
10188 * 02 JOV PTF10 LABEL PÅ LASER/A4 DERSOM L LABTY(annet enn Z/E )
      *%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
      * 03 JOC PTF11 FJERNER PRINT AV ENKEL LABEL(MED MINIMUM ENDRING)  VED UKJENT
11XXX * 04 JOV PTF11 hvir oppdreget er DUPPET til utkj - skriv label basert på UTK...
      *%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
11XXX * 05 JOV PTF12 Hvis input = 8 lang skriv godsliste på laser-printer "LASPR"
********************************************************************
      /copy syspeds/qrpgsrcpy,hspecs
      /copy syspeds/qrpgsrcpy,hspecsbnd
     FBRIDF     IF   E           K DISK    USROPN
     FBRPARF    IF   E           k disk    usropn
     FWSNRCLI   IF   E           K DISK    USROPN
N04  FHEADF     IF   E           K DISK    USROPN
     FHEAD39    IF   E           K DISK    USROPN
N04  F                                     RENAME(HEADFR:HEADFR39)
     FDokuf7    IF   E           K DISK    USROPN
      *********************************************************************
      *--------------------------------------------------------------------
      * Variables common to all CGIs
      *--------------------------------------------------------------------
      /copy syspeds/qrpgsrcpy,prototypeb
      /copy syspeds/qrpgsrcpy,usec
      *--------------------------------------------------------------------
      * Variables common to CGI programs
      *--------------------------------------------------------------------
      /copy syspeds/qrpgsrcpy,variables3
      *--------------------------------------------------------------------
      * Varibles
     D WSUSER          S             10
     D Funk            S              1
     D Ant             S              4
     D AntK            S              4  0
     D AntKll          S              4
     D PostNr          S              4
     D TEXT            S             20
S02  D*MELDING         S             70
N02  D MELDING         S             90
     D SEMI            s              1
     D TYPE            s              1
     D TKFEILK         s              1
     D Cmd             S             70
     D Fn              s             10
     D Lib             s             10
     D Mbr             s             10
     D Spaces          s             12a   inz('&nbsp;&nbsp;')
     D                 DS
     D  PRT                    1     50
     D  LABTYPE                1      1
     D  LABOUTQ                2     11
     D  TRANSPORTØR           12     31
     D                 DS
     D  SNNR                   1     20
     D  SnnrTst                1      3
     D  Snnr17                 4     20
N01  D                 DS
N01  D  DFBREF                 1     17
N01  D  DFBRTX                 1      5
N01  D  DFBRAV                 6      9
N01  D  DFBRST                10     10
N01  D  DFBROP                11     17
      *--------------------------------------------------------------------
      * Prolog common to CGI programs   (C-specs)
      * -Receive input from the remote browser
      *--------------------------------------------------------------------
      /copy syspeds/qrpgsrcpy,prolog3
      *=====================================================================******
      *
      *=====================================================================
      * MAIN PROCESS LINE
      *=====================================================================
      * Hent / repeter UserID
     C                   EVAL      WSUSER   = zhbgetvar('user')
     C                   EVAL      Funk     = zhbgetvar('funk')
     C                   EVAL      SNNR     = zhbgetvar('snnr')
     C                   EVAL      Ant      = zhbgetvar('ant')
     C                   eval      AntK     = c2n2(ant)
     C                   EVAL      Text     = zhbgetvar('text')
     C                   EVAL      Postnr   = zhbgetvar('Postnr')
     C                   EVAL      PRT      = zhbgetvar('PRT')
     C                   EVAL      SEMI     = zhbgetvar('SEMI')
     C                   EVAL      TYPE     = zhbgetvar('TYPE')
     c
      * Sett libr.list etter UserID
     C                   open      BRIDF                                50
     C     WSUSER        CHAIN     BRIDF                              33
     C     *in33         ifeq      *off
     C     BILIBL        ifeq      *blanks
     C                   callb     'INCGI'
     C                   parm                    BISTDL
     C                   else
     C                   call      BILIBL
     C                   end
     c                   else
     C                   callp     gethtml('HTMLSRC':
     C                             '*LIBL':
     C                             'STS01B':'/CGITAG/')
     c                   move      *blanks       FeilUsr          50
     C                   eval      FeilUsr ='"'+%trim(WSUSER)+'" var ikke '+
     c                             ' rett pålogget!!!'
     C                   callp     updHTMLvar('FEILTXT':FeilUsr)
     C                   callp     updHTMLvar('FEILKODE':'1')
     C                   callp     wrtsection('all')
     C                   callp     wrtsection('*fini')
     C                   CLOSE     BRIDF
     C                   MOVE      *ON           *INLR
     C                   return
     c                   end
     C                   open      wsnrcli
N04  C                   open      HeadF
     C                   open      Head39
     C                   open      dokuf7
      *
      * Initier felte når inn første gang
     c     FUNK          IFEQ      '1'
     c     SEMI          oreq      'Y'
     c     SEMI          Ifne      'Y'
     c                   eval      FUNK    =  ' '
     c                   eval      melding =  'N'
     c                   end
     C                   OPEN      BRPARF
     C     BrParKey      klist
     C                   kfld                    BIBRID
     C                   kfld                    PAKUNR
     C                   kfld                    PAID
     C                   MOVE      'LABTY'       PAID
     C     BrParKey      Chain     BRPARF                             33
     C                   MOVE      PAVRDA        PRT
N05   * eksakt 8 lang input = turnr = print laste/godsliste
N05  c                   if        %subst(SNNR:8:1) <> ' '
N05  c                             and %subst(SNNR:9:1) = ' '
N05  C                   MOVE      'LASPR'       PAID
N05  C     BrParKey      Chain     BRPARF                             33
N05  C                   MOVEL     PAVRDA        LABOUTQ
N05  c                   endif
     C                   CLOSE     BRPARF
     c                   end
      *
     C     ANTK          IFEQ      *ZEROS
     c                   z-add     1             ANTK
     c                   end
      * Set/Read skeleton output html, etc.
     C                   eval      Lib = '*LIBL'
     C                   eval      Fn  = 'HTMLSRC'
     C                   eval      Mbr = 'ESLA01'
     C     Funk          IFEQ      'A'
     C                   eval      Mbr = 'STS02'
     C                   end
     c     SEMI          Ifeq      'Y'
     C                   eval      Mbr = 'ESLA01S'
     C                   end
      *
      * Hent svar-skjema
     C                   callp     gethtml(fn:lib:mbr:'/CGITAG/')
      * Skriv labels dersom P.
     C     Funk          IFEQ      'P'
      * Param LABTY må finnes på USER
     C     LABOUTQ       IFeq      *blanks
     C                   Eval      MELDING   = 'Det er ikke knyttet printer '+
     C                             'til din bruker - Kontakt systemansvarlig.'
     C                   goto      IkkeSkriv
     c                   move      'X'           TKFeilK
     C                   END
      * Kun tillatt dersom Sending ikke i fila eller i oppdrag
     c     SnnrTst       ifeq      '401'
     c     Snnr17        chain     wsnrcli                            33
     C     *in33         IFeq      '0'
     C                   Eval      MELDING   = 'Enkel label finnes alt på det'+
     C                                         'te send.nr ' +
     C                                         '(Koble/Nullstill først.)'
     c                   move      'X'           TKFeilK
     c                   goto      IkkeSkriv
     c                   end
     c                   end
      *
      * DERSOM SENDINGEN ALT FINNES SKAL DET PRINTES BASERT PÅ FBR ELLER OPPDRAG
     c     snnr          ifeq      *blanks
     c                   move      *ON           *IN33
     c                   else
     c                   eval      DF1004 = Snnr17
     c     DF1004        chain     DOKUF7                             33
     c   33              eval      DF1004 = Snnr
     c   33DF1004        chain     DOKUF7                             33
N01   * dersom den er overført til innland - skriv basert på den..(simuler at den ikke fant brev)
N01   * V9= Utk.op:0240/00045  V10=Utk.op:0240/00045 - U.op:0082/0101057
N01  C     *IN33         IFEQ      '0'
N01  C     DFBRTX        ANDEQ     'U.op:'
N01  C     DFBRAV        ANDGE     '0001'
N01  C     DFBRAV        ANDLE     '9999'
N01  C     DFBROP        ANDGE     '0000001'
N01  C     DFBROP        ANDLE     '9999999'
N01  C                   move      *on           *in33
N01  C                   endif
     c   33              eval      DF1004 = *blanks
     c   33Snnr          chain     head39                             33
N04   * Om lest oppdrag har utkjøringsdupp- skriv basert på den
N04  C  N33              IF        TROPD2 <> 0
N04  C     DUPKEY        klist
N04  C                   kfld                    TRAVD2
N04  C                   kfld                    TROPD2
N04  c     DUPKEY        chain     headF                              33
N04  c  N33              eval      DF1004 = *blanks
N04  C                   ENDIF
     c                   end
      * printerstyring
     c     LABTYPE       IFEQ      'E'
     C                   EVAL      RC = DOCMD('OVRPRTF FILE(ZBARC) OUTQ('+
     C                             %trim(LABOUTQ)+') SPLFOWN(*JOB) ' +
     C                             'OVRSCOPE(*JOB)')
     c                   else
     C                   EVAL      RC = DOCMD('OVRPRTF FILE(ZBARC) OUTQ('+
     C                             %trim(LABOUTQ)+') SPLFOWN(*JOB) ' +
     C                             'OVRSCOPE(*JOB)')
N02  C                   EVAL      RC = DOCMD('OVRPRTF FILE(SYFA12SAP) OUTQ('
N02  C                             +%trim(LABOUTQ)+') SPLFOWN(*JOB) '
     c                             +'DEVTYPE(*AFPDS) PAGESIZE(70 80) OVRFLW(70)'
N02  C                             +' LPI(8) CPI(10) OVRSCOPE(*JOB)')
     c                   end
     c     *in33         ifeq      *off
      * Full label når sending er knyttet til oppdrag/fr.brev
     C                   exsr      Full_Lab
     c                   else
      * ellers enkel label / krysskobling i WSNRCLI  ( N03:flyttet til SR)
      * ved kall fra SEMI tillates det kun når det er bevisst.
     c     SEMI          ifeq      'Y'
     c     TYPE          ANDNE     'E'
     C                   Eval      MELDING   = 'Ukjent sending. (REGISTRERES '
     C                             +' FØRST / evt skriv ENKEL label. )'
     c                   move      'X'           TKFeilK
     c                   goto      IkkeSkriv
     c                   end
     C                   exsr      Enke_Lab
     c                   end
      *
     c     IkkeSkriv     tag
     c                   Move      *blanks       SNNR
     c                   z-add     1             ANTK
     c                   Move      *blanks       TEXT
     c                   Move      *blanks       Postnr
     c                   end
      * sett html-variable
     C                   callp     updhtmlvar('USER':WSUSER:
     C                             InitHTMLVars)
BODY C                   callp     updhtmlvar('BODYCLASS':'class='+BIFARG)
     C                   callp     updhtmlvar('SNNR':SNNR)
     C                   callp     updHTMLvar('MELDING':MELDING)
     C                   callp     updHTMLvar('TKfeilK':TKfeilK)
     C                   callp     updhtmlvar('ANT':
     c                             %trim(%editc(ANTK:'Z')))
     C                   callp     updhtmlvar('TEXT':TEXT)
     C                   callp     updhtmlvar('POSTNR':POSTNR)
     C                   callp     updhtmlvar('PRT':PRT)
     C     Funk          IFEQ      'A'
     C                   callp     updHTMLvar('besk':BIBESK)
     C                   callp     updHTMLvar('kunr':
     C                             %trim(%editc(BIKUNR:'Z')))
     C                   callp     updHTMLvar('sdato':
     C                             %trim(%editw(BIDTV:'    .  .  ')))
     C                   callp     updHTMLvar('stid':
     C                             %trim(%editw(BITIDV:'  .  .  ')))
     c                   end
      * Write HTML-section
     C                   callp     wrtsection('all')
      * dummy fini-section
     C                   callp     wrtsection('*fini')
      * Quit
     C                   close     BRIDF                                50
     C                   CLOSE     wsnrcli
N04  C                   CLOSE     HeadF
     C                   CLOSE     Head39
     C                   CLOSE     Dokuf7
     C                   MOVE      *ON           *INLR
     C                   return
      *******************************************************************
     c     Full_Lab      begsr
      *******************************************************************
     c     DF1004        Ifeq      *blanks
     c                   move      'HE'          VMLAYO                         basert på Headf
     C                   move      HEAVD         DFAVD
     C                   move      HEOPD         DFOPD
     C                   move      *zeros        DFFBNR
     c                   else
     c                   move      '  '          VMLAYO                         basert på fbrev
     c                   end
N02  C                   select
S02  c*    LABTYPE       IFEQ      'E'
N02  c     LABTYPE       WHENEQ    'E'
     C                   MOVE      'SYFA12SE  '  LABPGM           10
S02  c*                  else
N02  c     LABTYPE       WHENEQ    'Z'
     C                   MOVE      'SYFA12SN  '  LABPGM           10
S02  c*                  end
N02  c                   other
N02  C                   MOVE      'SYFA12SA  '  LABPGM                         Laser
N02  c                   endsl
     c                   move      'N'           UUKOPI
     C                   Call      LABPGM
     C                   PARM                    BIFIRM
     C                   PARM                    VMLAYO            2
     C                   PARM                    DFAVD
     C                   PARM                    DFOPD
     C                   PARM                    DFFBNR
     C                   PARM                    UUKOPI            1
S03  c*                  Eval      melding = 'Normale labels (adresse mm) er '+
N03  c                   Eval      melding = 'Labels '+
     c                             'skrevet for ' + SNNR
N02  c                             + ' på ' + LABOUTQ
      * bedt om ENKEL, men den var registrert - gi meldingen som alert..
     c     TYPE          ifeq      'E'
     c                   move      'X'           TKFeilK
     c                   end
     c                   endsr
      *******************************************************************
     c     Enke_Lab      begsr
      *******************************************************************
S03   *
S03   * SKRIV ENKEL "LØS" LAPP (KUN KOBLING SENDNR/KOLLIID)
S03   * OBS! styring av ZEBRA/ELTRON via BRPARF (og også transportør)
S03   *
S03  c*    LABTYPE       IFEQ      'E'
S03  C*                  MOVE      'SYFA12SE2 '  LABPGM           10
S03  c*                  else
S03  C*                  MOVE      'SYFA12SN2 '  LABPGM           10
S03  c*                  end
S03  C*                  MOVE      ANTK          ANTKLL
S03  C*                  Call      LABPGM
S03  C*                  PARM                    WSUSER
S03  C*                  PARM                    BIFIRM
S03  C*                  PARM                    SNNR
S03  C*                  PARM                    ANTKLL
S03  C*                  PARM                    POSTNR
S03  C*                  PARM                    TEXT
S03  C*                  PARM                    TRANSPORTØR
S03  C*                  PARM                    FLAGG             1
S03  c*                  Eval      melding = ANT +
S03  c*                            'ENKLE labels (ukjent sending) er '+
S03  c*                            'skrevet for ' + SNNR
S03  c*                            + ' på ' + LABOUTQ
N03  c                   Eval      melding = 'Ukjent sendingsnummer '
N03  c                             + SNNR
     c                   endsr
