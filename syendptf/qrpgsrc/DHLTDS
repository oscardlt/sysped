      *********************************************************************
      *
CRTPG+*  CRTPGM SYSPED/DHLTDS MODULE(*LIBL/DHLTDS *LIBL/INCGI)
CRTPGM*        ACTGRP(CGI) AUT(*USE)
      *
      *********************************************************************
      /copy SYSPEDS/qrpgsrcpy,hspecs
      /copy SYSPEDS/qrpgsrcpy,hspecsbnd
      *********************************************************************
     FBRIDF     UF   E           K DISK    USROPN
     FSVEH      UF A E           K DISK    USROPN
     F                                     PREFIX(X)
     FSVEV1     IF A E           K DISK    USROPN
     FSVEA      UF   E           K DISK    USROPN
     FSVTHA2    IF   E           K DISK    USROPN
     FSADH      IF   E           K DISK    USROPN
     FHEADF     IF   E           K DISK    USROPN
     FCUNDL01   IF   E           K DISK    USROPN
     FFIRM      IF   E             DISK    USROPN
      *--------------------------------------------------------------------
      * Variables common to all CGIs
      *--------------------------------------------------------------------
      /copy SYSPEDS/qrpgsrcpy,prototypeb
      /copy SYSPEDS/qrpgsrcpy,usec
      /copy SYSPEDS/qrpgsrcpy,variables3
      *
      * Varible for
     D P               S              5U 0
     D WSUSER          S             10
     D SVEH_SYAVA      S              4
     D SVEH_SYAV       S              4  0
     D NEWSYAVA        S              4
     D NEWAVD          S              4  0
     D SVEH_SYOPA      S              7
     D SVEH_SYOP       S              7  0
     D NEWOPD          S              7  0
     D WMODE           S              2
     D WSIGN           S              3
     D NEWSIGN         S              3
     D SVEH_SYSG       S              3
     D SVEH_SYST       S              1
     D SVEH_SYDT       S              8
     D SVEH_SYDTN      S              8  0
     D SVEH_MTYP       S              3
     D SVEH_TUID       S             10
     D SVEH_KENH       S             35
     D SVEH_DEK1       S              2
     D SVEH_DEK2       S              1
     D SVEH_TART       S              1
     D SVEH_AVKN       S              8
     D SVEH_AVKNN      S              8  0
     D SVEH_AVEO       S             17
     D SVEH_AVNA       S             35
     D SVEH_AVA1       S             35
     D SVEH_AVA2       S             35
     D SVEH_AVPN       S              9
     D SVEH_AVPA       S             35
     D SVEH_AVLK       S              2
     D SVEH_AVHA       S             35
     D SVEH_AVTL       S             25
     D SVEH_KOTA       S              8
     D SVEH_KOTAN      S              8  0
     D SVEH_RFAB       S             17
     D SVEH_RFAC       S             35
     D SVEH_RFAC2      S             35
     D SVEH_RFAC3      S             35
     D SVEH_MOKN       S              8
     D SVEH_MOKNN      S              8  0
     D SVEH_MOEO       S             17
     D SVEH_MONA       S             35
     D SVEH_MOA1       S             35
     D SVEH_MOA2       S             35
     D SVEH_MOPN       S              9
     D SVEH_MOPA       S             35
     D SVEH_MOLK       S              2
     D SVEH_KVSA       S              1
     D SVEH_DKKN       S              8
     D SVEH_DKKNN      S              8  0
     D SVEH_DKEO       S             17
     D SVEH_DKLK       S              2
     D SVEH_DKNA       S             35
     D SVEH_DKA1       S             35
     D SVEH_DKA2       S             35
     D SVEH_DKPA       S             35
     D SVEH_DKPN       S              9
     D SVEH_OMEO       S             17
     D SVEH_OMTY       S              1
     D SVEH_OMHA       S             35
     D SVEH_OMTL       S             25
     D SVEH_AVUT       S              2
     D SVEH_AUKD       S              2
     D SVEH_AUBE       S              2
     D SVEH_TRID       S             35
     D SVEH_TRLK       S              2
     D SVEH_CONT       S              2
     D SVEH_TRAI       S             35
     D SVEH_TRAL       S              2
     D SVEH_FATY       S              4
     D SVEH_FATX       S             17
     D SVEH_VAKD       S              3
     D SVEH_VAKU       S             10
     D SVEH_VAKUN      S             10  6
     D SVEH_VAOM       S              3
     D SVEH_VAOMN      S              3  0
     D SVEH_FABL       S             11
     D SVEH_FABLN      S             11  3
     D SVEH_TRGR       S              1
     D SVEH_TRIN       S              1
     D SVEH_GRKD       S             17
     D SVEH_GOLK       S              4
     D SVEH_BRUT       S              9
     D SVEH_BRUTN      S              9  0
     D SVEH_SUTI       S             17
     D SVEH_ABUB       S             35
     D SVEH_UPPS       S              1
     D SVEH_KLEO       S             17
     D SVEH_TRNR       S             20
     D SVEH_UTFA       S              8
     D SVEH_LAST       S              3
     D SVEH_TAXD       S              8
     D SVEH_TAXDN      S              8  0
     D SVEH_BEAT       S             12
     D SVEH_BEATN      S             12  0
     D SVEH_BETK       S              1
     D SVEH_KOMR       S             70
     D SVEH_RES1       S              2
     D SVEH_RES2       S              2
     D SVEH_RES3       S              2
     D SVEH_RES4       S              2
     D SVEH_RES5       S              2
     D SVEH_RES6       S              2
     D SVEH_RES7       S              2
     D SVEH_RES8       S              2
     D SVEH_SEL1       S             70
     D SVEH_SEL2       S             70
     D SVEH_SAOM       S              1
     D SVEH_SGDK       S              6
     D SVEH_SGME       S              3
     D SVEH_SGUT       S              6
     D SVEH_SGID       S             10
     D SVEH_SGDT       S             12
     D SVEH_BYTE       S              7
     D SVEH_BYTEN      S              7  0
     D SVEH_0035       S              1
     D JSONstring      S          32000
     D Error           S            150

      *get input-string
      /copy syspeds/qrpgsrcpy,prolog3

      * Parse input
     C                   EXSR      Parse
      * Open files etc
     C                   EXSR      INIT
      *
     c                   callp     gethtmlifs(
     C                             '/syspeddev/html/JSON.html':
     C                             '/CGITAG/')
     C                   callp     wrtsection('top')
      * Teste input og utfør
     C  N50              EXSR      TEST

      * ............................................................................................
      * skriv JSON-Object start..(alltid '{' + x ant param. m/komma mellom (IKKE komma etter siste))
      * ............................................................................................
      *
      /free
        JSONstring='{'
        +'¬user¬ : ¬'+%trim(WSUSER)+'¬, '
        +'¬sveh_syav¬ : ¬'+%trim(%editc(SVEH_SYAV:'Z'))+'¬, '
        +'¬newavd¬ : ¬'+%trim(%editc(NEWAVD:'Z'))+'¬, '
        +'¬sveh_syop¬ : ¬'+%trim(%editc(SVEH_SYOP:'Z'))+'¬, '
        +'¬newopd¬ : ¬'+%trim(%editc(NEWOPD:'Z'))+'¬, '
        +'¬sign¬ : ¬'+%trim(WSIGN)+'¬, '
        +'¬newsign¬ : ¬'+%trim(NEWSIGN)+'¬, '
        +'¬mode¬ : ¬'+%trim(WMODE)+'¬, '
        +'¬errMsg¬ : ¬'+%trim(Error)+'¬, '
        +'¬sveh_tuid¬ : ¬'+%trim(SVEH_TUID)+'¬, '
        +'¬svea_omeo¬ : ¬'+%trim(SVEA_OMEO)+'¬, '
        +'¬svth_namn¬ : ¬'+%trim(SVTH_NAMN)+'¬, '
        +'¬svea_omtl¬ : ¬'+%trim(SVEA_OMTL)+'¬, '
        +'¬svea_omty¬ : ¬'+%trim(SVEA_OMTY)+'¬, '
        +'¬svea_0035¬ : ¬'+%trim(SVEA_0035)+'¬, ';
      /end-free
      * JSONfix escaper " i tekst,  for deretter å bytte ¬->"
     c                   call      'JSONFIX'
     c                   parm                    JSONstring
     C                   callp     updHTMLvar('JSONstring':JSONstring)
     C                   callp     wrtsection('JSONlin')
      *
      * ............................................................................................
      * Skriv JSON-LISTE Start (en liste er EN parameter(fra [ til   )
      * ............................................................................................
     c                   eval      JSONstring ='"orderupdate" : ['
     C                   callp     updHTMLvar('JSONstring':JSONstring)
     C                   callp     wrtsection('JSONlin')
      * ............................................................................................
      * Skriv JSON-Liste/Array  Avslutning
      * ............................................................................................
     c                   eval      JSONstring =']'
     C                   callp     updHTMLvar('JSONstring':JSONstring)
     C                   callp     wrtsection('JSONlin')
      * ............................................................................................
      * Skriv JSON-string Avsluttning
      * ............................................................................................
     c                   eval      JSONstring ='}'
     C                   callp     updHTMLvar('JSONstring':JSONstring)
     C                   callp     wrtsection('JSONlin')
      *
      * Quit
     C                   exsr      Exit


      *=====================================================================
      * Close output html and quit
      *=====================================================================
     C     Exit          begsr
      * Lukk fil
     C                   CLOSE     BRIDF
     C  N50              CLOSE     SVEH
     C  N50              CLOSE     SVEV1
     C  N50              CLOSE     SVEA
     C  N50              CLOSE     SVTHA2
     C  N50              CLOSE     SADH
     C  N50              CLOSE     HEADF
     C  N50              CLOSE     CUNDL01
     C  N50              CLOSE     FIRM

      * Do not delete the call to wrtsection with section name *fini.  It is needed
      * to ensure that all output html that has been buffered gets output.
     C                   callp     wrtsection('*fini')
      * Quit
     C                   MOVE      *ON           *INLR
     C                   return
     C                   endsr
      *
      *********************************************************
     C     Parse         Begsr
      *********************************************************
      * Get input
     C                   EVAL      WSUSER  = zhbgetvar('USER')
     C                   EVAL      SVEH_SYAVA = zhbgetvar('AVD')
     C                   EVAL      SVEH_SYAV  = c2n2(SVEH_SYAVA)
     C                   EVAL      NEWSYAVA = zhbgetvar('NEWAVD')
     C                   EVAL      NEWAVD  = c2n2(NEWSYAVA)
     C                   EVAL      SVEH_SYOPA = zhbgetvar('OPD')
     C                   EVAL      SVEH_SYOP  = c2n2(SVEH_SYOPA)
     C                   EVAL      WMODE  = zhbgetvar('MODE')
     C                   EVAL      SVEH_SYSG  = zhbgetvar('SVEH_SYSG')
     C                   EVAL      WSIGN      = zhbgetvar('SIGN')
     C                   EVAL      NEWSIGN      = zhbgetvar('NEWSIGN')
     C                   EVAL      SVEH_SYST  = zhbgetvar('SVEH_SYST')
     C                   EVAL      SVEH_SYDT=   zhbgetvar('SVEH_SYDT')
     C                   EVAL      SVEH_SYDTN = c2n2(SVEH_SYDT)
     C                   EVAL      SVEH_MTYP=   zhbgetvar('SVEH_MTYP')
     C                   EVAL      SVEH_TUID=   zhbgetvar('SVEH_TUID')
     C                   EVAL      SVEH_KENH=   zhbgetvar('SVEH_KENH')
     C                   EVAL      SVEH_DEK1=   zhbgetvar('SVEH_DEK1')
     C                   EVAL      SVEH_DEK2=   zhbgetvar('SVEH_DEK2')
     C                   EVAL      SVEH_TART=   zhbgetvar('SVEH_TART')
     C                   EVAL      SVEH_AVKN=   zhbgetvar('SVEH_AVKN')
     C                   EVAL      SVEH_AVKNN = c2n2(SVEH_AVKN)
     C                   EVAL      SVEH_AVEO=   zhbgetvar('SVEH_AVEO')
     C                   EVAL      SVEH_AVNA=   zhbgetvar('SVEH_AVNA')
     C                   EVAL      SVEH_AVA1=   zhbgetvar('SVEH_AVA1')
     C                   EVAL      SVEH_AVA2=   zhbgetvar('SVEH_AVA2')
     C                   EVAL      SVEH_AVPN=   zhbgetvar('SVEH_AVPN')
     C                   EVAL      SVEH_AVPA=   zhbgetvar('SVEH_AVPA')
     C                   EVAL      SVEH_AVLK=   zhbgetvar('SVEH_AVLK')
     C                   EVAL      SVEH_AVHA=   zhbgetvar('SVEH_AVHA')
     C                   EVAL      SVEH_AVTL=   zhbgetvar('SVEH_AVTL')
     C                   EVAL      SVEH_KOTA=   zhbgetvar('SVEH_KOTA')
     C                   EVAL      SVEH_KOTAN = c2n2(SVEH_KOTA)
     C                   EVAL      SVEH_RFAB=   zhbgetvar('SVEH_RFAB')
     C                   EVAL      SVEH_RFAC=   zhbgetvar('SVEH_RFAC')
     C                   EVAL      SVEH_RFAC2=  zhbgetvar('SVEH_RFAC2')
     C                   EVAL      SVEH_RFAC3=  zhbgetvar('SVEH_RFAC3')
     C                   EVAL      SVEH_MOKN=   zhbgetvar('SVEH_MOKN')
     C                   EVAL      SVEH_MOKNN = c2n2(SVEH_MOKN)
     C                   EVAL      SVEH_MOEO=   zhbgetvar('SVEH_MOEO')
     C                   EVAL      SVEH_MONA=   zhbgetvar('SVEH_MONA')
     C                   EVAL      SVEH_MOA1=   zhbgetvar('SVEH_MOA1')
     C                   EVAL      SVEH_MOA2=   zhbgetvar('SVEH_MOA2')
     C                   EVAL      SVEH_MOPN=   zhbgetvar('SVEH_MOPN')
     C                   EVAL      SVEH_MOPA=   zhbgetvar('SVEH_MOPA')
     C                   EVAL      SVEH_MOLK=   zhbgetvar('SVEH_MOLK')
     C                   EVAL      SVEH_KVSA=   zhbgetvar('SVEH_KVSA')
     C                   EVAL      SVEH_DKKN=   zhbgetvar('SVEH_DKKN')
     C                   EVAL      SVEH_DKKNN = c2n2(SVEH_DKKN)
     C                   EVAL      SVEH_DKEO=   zhbgetvar('SVEH_DKEO')
     C                   EVAL      SVEH_DKLK=   zhbgetvar('SVEH_DKLK')
     C                   EVAL      SVEH_DKNA=   zhbgetvar('SVEH_DKNA')
     C                   EVAL      SVEH_DKA1=   zhbgetvar('SVEH_DKA1')
     C                   EVAL      SVEH_DKA2=   zhbgetvar('SVEH_DKA2')
     C                   EVAL      SVEH_DKPA=   zhbgetvar('SVEH_DKPA')
     C                   EVAL      SVEH_DKPN=   zhbgetvar('SVEH_DKPN')
     C                   EVAL      SVEH_OMEO=   zhbgetvar('SVEH_OMEO')
     C                   EVAL      SVEH_OMTY=   zhbgetvar('SVEH_OMTY')
     C                   EVAL      SVEH_OMHA=   zhbgetvar('SVEH_OMHA')
     C                   EVAL      SVEH_OMTL=   zhbgetvar('SVEH_OMTL')
     C                   EVAL      SVEH_AVUT=   zhbgetvar('SVEH_AVUT')
     C                   EVAL      SVEH_AUKD=   zhbgetvar('SVEH_AUKD')
     C                   EVAL      SVEH_AUBE=   zhbgetvar('SVEH_AUBE')
     C                   EVAL      SVEH_TRID=   zhbgetvar('SVEH_TRID')
     C                   EVAL      SVEH_TRLK=   zhbgetvar('SVEH_TRLK')
     C                   EVAL      SVEH_CONT=   zhbgetvar('SVEH_CONT')
     C                   EVAL      SVEH_TRAI=   zhbgetvar('SVEH_TRAI')
     C                   EVAL      SVEH_TRAL=   zhbgetvar('SVEH_TRAL')
     C                   EVAL      SVEH_FATY=   zhbgetvar('SVEH_FATY')
     C                   EVAL      SVEH_FATX=   zhbgetvar('SVEH_FATX')
     C                   EVAL      SVEH_VAKD=   zhbgetvar('SVEH_VAKD')
     C                   EVAL      SVEH_VAKU=   zhbgetvar('SVEH_VAKU')
     C                   DUMP
     C                   EVAL      SVEH_VAKUN = c2n2(SVEH_VAKU)
     C                   EVAL      SVEH_VAOM=   zhbgetvar('SVEH_VAOM')
     C                   EVAL      SVEH_VAOMN = c2n2(SVEH_VAOM)
     C                   EVAL      SVEH_FABL=   zhbgetvar('SVEH_FABL')
     C                   EVAL      SVEH_FABLN = c2n2(SVEH_FABL)
     C                   EVAL      SVEH_TRGR=   zhbgetvar('SVEH_TRGR')
     C                   EVAL      SVEH_TRIN=   zhbgetvar('SVEH_TRIN')
     C                   EVAL      SVEH_GRKD=   zhbgetvar('SVEH_GRKD')
     C                   EVAL      SVEH_GOLK=   zhbgetvar('SVEH_GOLK')
     C                   EVAL      SVEH_BRUT=   zhbgetvar('SVEH_BRUT')
     C                   EVAL      SVEH_BRUTN = c2n2(SVEH_BRUT)
     C                   EVAL      SVEH_SUTI=   zhbgetvar('SVEH_SUTI')
     C                   EVAL      SVEH_ABUB=   zhbgetvar('SVEH_ABUB')
     C                   EVAL      SVEH_UPPS=   zhbgetvar('SVEH_UPPS')
     C                   EVAL      SVEH_KLEO=   zhbgetvar('SVEH_KLEO')
     C                   EVAL      SVEH_TRNR=   zhbgetvar('SVEH_TRNR')
     C                   EVAL      SVEH_UTFA=   zhbgetvar('SVEH_UTFA')
     C                   EVAL      SVEH_LAST=   zhbgetvar('SVEH_LAST')
     C                   EVAL      SVEH_TAXD=   zhbgetvar('SVEH_TAXD')
     C                   EVAL      SVEH_TAXDN = c2n2(SVEH_TAXD)
     C                   EVAL      SVEH_BEAT=   zhbgetvar('SVEH_BEAT')
     C                   EVAL      SVEH_BEATN = c2n2(SVEH_BEAT)
     C                   EVAL      SVEH_BETK=   zhbgetvar('SVEH_BETK')
     C                   EVAL      SVEH_KOMR=   zhbgetvar('SVEH_KOMR')
     C                   EVAL      SVEH_RES1=   zhbgetvar('SVEH_RES1')
     C                   EVAL      SVEH_RES2=   zhbgetvar('SVEH_RES2')
     C                   EVAL      SVEH_RES3=   zhbgetvar('SVEH_RES3')
     C                   EVAL      SVEH_RES4=   zhbgetvar('SVEH_RES4')
     C                   EVAL      SVEH_RES5=   zhbgetvar('SVEH_RES5')
     C                   EVAL      SVEH_RES6=   zhbgetvar('SVEH_RES6')
     C                   EVAL      SVEH_RES7=   zhbgetvar('SVEH_RES7')
     C                   EVAL      SVEH_RES8=   zhbgetvar('SVEH_RES8')
     C                   EVAL      SVEH_SEL1=   zhbgetvar('SVEH_SEL1')
     C                   EVAL      SVEH_SEL2=   zhbgetvar('SVEH_SEL2')
     C                   EVAL      SVEH_SAOM=   zhbgetvar('SVEH_SAOM')
     C                   EVAL      SVEH_SGDK=   zhbgetvar('SVEH_SGDK')
     C                   EVAL      SVEH_SGME=   zhbgetvar('SVEH_SGME')
     C                   EVAL      SVEH_SGUT=   zhbgetvar('SVEH_SGUT')
     C                   EVAL      SVEH_SGID=   zhbgetvar('SVEH_SGID')
     C                   EVAL      SVEH_SGDT=   zhbgetvar('SVEH_SGDT')
     C                   EVAL      SVEH_BYTE=   zhbgetvar('SVEH_BYTE')
     C                   EVAL      SVEH_BYTEN = c2n2(SVEH_BYTE)
     C                   EVAL      SVEH_0035=   zhbgetvar('SVEH_0035')
     c                   ENDSR
      *********************************************************
     C     INIT          Begsr
      *********************************************************
     C                   OPEN      BRIDF
      * Test innlogging
     C     WSUSER        CHAIN     BRIDF                              50
     C     BILIBL        ifeq      *blanks
     C                   callb     'INCGI'
     C                   parm                    BISTDL
     C                   else
     C                   call      BILIBL
     C                   end
      *
     C     SvehKey       klist
     C                   kfld                    SVEH_SYAV
     C                   kfld                    SVEH_SYOP
     C     CUNDL01K      KLIST
     C                   KFLD                    FIFIRM
     C                   KFLD                    KUNDNR
     C     *LIKE         DEFINE    SVEH_AVPA     W_PADR
      *
     C   50              eval      Error = 'Invalid userID'
     C  N50              OPEN      SVEH
     C  N50              OPEN      SVEV1
     C  N50              OPEN      SVEA
     C  N50              OPEN      SVTHA2
     C  N50              OPEN      SADH
     C  N50              OPEN      HEADF
     C  N50              OPEN      CUNDL01
     C  N50              OPEN      FIRM
      *_________________________________
      * Hæmta dagens datum och klockslag
      *"""""""""""""""""""""""""""""""""
     C                   CALL      'SYGE15C'
     C                   PARM                    WDT               8
     C                   PARM                    WTM               6
      * Hæmta firmaopplysninger
     C                   READ      FIRM

     c                   endsr
      *
      *______________________________________________________
      * TEST                                             TEST
      *""""""""""""""""""""""""""""""""""""""""""""""""""""""
     C     TEST          BEGSR
      * Hæmta userid
     C     WSUSER        CHAIN     SVTHA2
      * Hæmta ærende
     C     WMODE         IFNE      'A'
     C     SvehKey       CHAIN     SVEH                               55
     C                   ENDIF
      * MODE A=Add  D=Delete  U=Update  S=Skicka till signering   C=Copy  GS=Hæmta från SYSPED
     C                   SELECT
     C     WMODE         WHENEQ    'A'
     C                   eval      Error = *blanks
     C                   EXSR      SRA
     C     WMODE         WHENEQ    'GS'
     C                   eval      Error = *blanks
     C  N55              eval      Error = 'Fel, finns redan'
     C   55              EXSR      SRGS
     C     WMODE         WHENEQ    'C'
     C                   IF        *IN55=*ON
     C                   eval      Error = 'Order not found'
     C                   ELSE
     C                   UPDATE    SVEHR
     C                   eval      Error = *blanks
     C                   EXSR      SRC
     C                   ENDIF
     C     WMODE         WHENEQ    'D'
     C                   IF        *IN55=*ON
     C                   eval      Error = 'Order not found'
     C                   ELSE
     C                   eval      Error = *blanks
     C                   EXSR      SRD
     C                   ENDIF
     C     WMODE         WHENEQ    'S'
     C                   IF        *IN55=*ON
     C                   eval      Error = 'Order not found'
     C                   ELSE
     C                   eval      Error = *blanks
     C                   EXSR      SRS
     C                   ENDIF
     C     WMODE         WHENEQ    'U'
     C                   IF        *IN55=*ON
     C                   eval      Error = 'Order not found'
     C                   ELSE
     C                   eval      Error = *blanks
     C                   EXSR      SRU
     C                   ENDIF
     C                   OTHER
     C                   eval      Error = 'Wrong mode'
     C                   ENDSL
     C                   ENDSR
      *______________________________________________________
      * Add                                               SRA
      *""""""""""""""""""""""""""""""""""""""""""""""""""""""
     C     SRA           BEGSR
     C                   CLEAR                   SVEHR
      * Hæmta uppdragsnummer
     C     SVEH_SYAV     CHAIN     SVEA                               52
     C                   ADD       1             SVEA_SYOP
     C                   UPDATE    SVEAR
     C                   EVAL      XSVEH_SYAV=SVEH_SYAV
     C                   EVAL      SVEH_SYOP=SVEA_SYOP
     C                   EVAL      XSVEH_SYOP=SVEH_SYOP
     C                   EVAL      XSVEH_SYSG=WSIGN
     C                   MOVEL     WDT           XSVEH_SYDT
      * Hæmta tullid
     C                   CALL      'SVG001R'
     C                   PARM                    XSVEH_TUID
     C                   EVAL      SVEH_TUID=XSVEH_TUID
      * Write
     C                   WRITE     SVEHR
     C                   ENDSR
      *______________________________________________________
      * Delete                                            SRD
      *""""""""""""""""""""""""""""""""""""""""""""""""""""""
     C     SRD           BEGSR
     C                   EVAL      XSVEH_SYST='D'
     C                   UPDATE    SVEHR
     C                   ENDSR
      *______________________________________________________
      * Skicka                                            SRS
      *""""""""""""""""""""""""""""""""""""""""""""""""""""""
     C     SRS           BEGSR
     C                   UPDATE    SVEHR
     C                   eval      Error = *blanks
      *____________________
      * Skapa edifact + fil
      *""""""""""""""""""""
     C                   CALL      'SVE021R'
     C                   PARM                    SVEH_SYAV
     C                   PARM                    SVEH_SYOP
     C                   ENDSR
      *______________________________________________________
      * Update                                            SRU
      *""""""""""""""""""""""""""""""""""""""""""""""""""""""
     C     SRU           BEGSR
     C                   EVAL      XSVEH_SYST=SVEH_SYST
     C                   EVAL      XSVEH_MTYP=SVEH_MTYP
     C                   EVAL      XSVEH_KENH=SVEH_KENH
     C                   EVAL      XSVEH_DEK1=SVEH_DEK1
     C                   EVAL      XSVEH_DEK2=SVEH_DEK2
     C                   EVAL      XSVEH_TART=SVEH_TART
     C                   EVAL      XSVEH_AVKN=SVEH_AVKNN
     C                   EVAL      XSVEH_AVEO=SVEH_AVEO
     C                   EVAL      XSVEH_AVNA=SVEH_AVNA
     C                   EVAL      XSVEH_AVA1=SVEH_AVA1
     C                   EVAL      XSVEH_AVA2=SVEH_AVA2
     C                   EVAL      XSVEH_AVPN=SVEH_AVPN
     C                   EVAL      XSVEH_AVPA=SVEH_AVPA
     C                   EVAL      XSVEH_AVLK=SVEH_AVLK
     C                   EVAL      XSVEH_AVHA=SVEH_AVHA
     C                   EVAL      XSVEH_AVTL=SVEH_AVTL
     C                   EVAL      XSVEH_KOTA=SVEH_KOTAN
     C                   EVAL      XSVEH_RFAB=SVEH_RFAB
     C                   EVAL      XSVEH_RFAC=SVEH_RFAC
     C                   EVAL      XSVEH_RFAC2=SVEH_RFAC2
     C                   EVAL      XSVEH_RFAC3=SVEH_RFAC3
     C                   EVAL      XSVEH_MOKN=SVEH_MOKNN
     C                   EVAL      XSVEH_MOEO=SVEH_MOEO
     C                   EVAL      XSVEH_MONA=SVEH_MONA
     C                   EVAL      XSVEH_MOA1=SVEH_MOA1
     C                   EVAL      XSVEH_MOA2=SVEH_MOA2
     C                   EVAL      XSVEH_MOPN=SVEH_MOPN
     C                   EVAL      XSVEH_MOPA=SVEH_MOPA
     C                   EVAL      XSVEH_MOLK=SVEH_MOLK
     C                   EVAL      XSVEH_KVSA=SVEH_KVSA
     C                   EVAL      XSVEH_DKKN=SVEH_DKKNN
     C                   EVAL      XSVEH_DKEO=SVEH_DKEO
     C                   EVAL      XSVEH_DKLK=SVEH_DKLK
     C                   EVAL      XSVEH_DKNA=SVEH_DKNA
     C                   EVAL      XSVEH_DKA1=SVEH_DKA1
     C                   EVAL      XSVEH_DKA2=SVEH_DKA2
     C                   EVAL      XSVEH_DKPA=SVEH_DKPA
     C                   EVAL      XSVEH_DKPN=SVEH_DKPN
     C                   EVAL      XSVEH_OMEO=SVEH_OMEO
     C                   EVAL      XSVEH_OMTY=SVEH_OMTY
     C                   EVAL      XSVEH_OMHA=SVEH_OMHA
     C                   EVAL      XSVEH_OMTL=SVEH_OMTL
     C                   EVAL      XSVEH_AVUT=SVEH_AVUT
     C                   EVAL      XSVEH_AUKD=SVEH_AUKD
     C                   EVAL      XSVEH_AUBE=SVEH_AUBE
     C                   EVAL      XSVEH_TRID=SVEH_TRID
     C                   EVAL      XSVEH_TRLK=SVEH_TRLK
     C                   EVAL      XSVEH_CONT=SVEH_CONT
     C                   EVAL      XSVEH_TRAI=SVEH_TRAI
     C                   EVAL      XSVEH_TRAL=SVEH_TRAL
     C                   EVAL      XSVEH_FATY=SVEH_FATY
     C                   EVAL      XSVEH_FATX=SVEH_FATX
     C                   EVAL      XSVEH_VAKD=SVEH_VAKD
     C                   Z-ADD     SVEH_VAKUN    XSVEH_VAKU
     C                   EVAL      XSVEH_VAOM=SVEH_VAOMN
     C                   EVAL      XSVEH_FABL=SVEH_FABLN
     C                   EVAL      XSVEH_TRGR=SVEH_TRGR
     C                   EVAL      XSVEH_TRIN=SVEH_TRIN
     C                   EVAL      XSVEH_GRKD=SVEH_GRKD
     C                   EVAL      XSVEH_GOLK=SVEH_GOLK
     C                   EVAL      XSVEH_BRUT=SVEH_BRUTN
     C                   EVAL      XSVEH_SUTI=SVEH_SUTI
     C                   EVAL      XSVEH_ABUB=SVEH_ABUB
     C                   EVAL      XSVEH_UPPS=SVEH_UPPS
     C                   EVAL      XSVEH_KLEO=SVEH_KLEO
     C                   EVAL      XSVEH_TRNR=SVEH_TRNR
     C                   EVAL      XSVEH_UTFA=SVEH_UTFA
     C                   EVAL      XSVEH_LAST=SVEH_LAST
     C                   EVAL      XSVEH_TAXD=SVEH_TAXDN
     C                   EVAL      XSVEH_BEAT=SVEH_BEATN
     C                   EVAL      XSVEH_BETK=SVEH_BETK
     C                   EVAL      XSVEH_KOMR=SVEH_KOMR
     C                   EVAL      XSVEH_RES1=SVEH_RES1
     C                   EVAL      XSVEH_RES2=SVEH_RES2
     C                   EVAL      XSVEH_RES3=SVEH_RES3
     C                   EVAL      XSVEH_RES4=SVEH_RES4
     C                   EVAL      XSVEH_RES5=SVEH_RES5
     C                   EVAL      XSVEH_RES6=SVEH_RES6
     C                   EVAL      XSVEH_RES7=SVEH_RES7
     C                   EVAL      XSVEH_RES8=SVEH_RES8
     C                   EVAL      XSVEH_SEL1=SVEH_SEL1
     C                   EVAL      XSVEH_SEL2=SVEH_SEL2
     C                   EVAL      XSVEH_SAOM=SVEH_SAOM
     C                   EVAL      XSVEH_SGDK=SVEH_SGDK
     C                   EVAL      XSVEH_SGME=SVEH_SGME
     C                   EVAL      XSVEH_SGUT=SVEH_SGUT
     C                   EVAL      XSVEH_SGID=SVEH_SGID
     C                   EVAL      XSVEH_SGDT=SVEH_SGDT
     C                   EVAL      XSVEH_BYTE=SVEH_BYTEN
     C                   EVAL      XSVEH_0035=SVEH_0035
     C                   UPDATE    SVEHR
     C                   ENDSR
      *______________________________________________________
      * Copy                                              SRC
      *""""""""""""""""""""""""""""""""""""""""""""""""""""""
     C     SRC           BEGSR
     C                   EVAL      WSIGN=SVEH_SYSG
      * Hæmta uppdragsnummer
     C     NEWAVD        CHAIN     SVEA                               52
     C                   ADD       1             SVEA_SYOP
     C                   UPDATE    SVEAR
     C                   EVAL      XSVEH_SYAV=NEWAVD
     C                   EVAL      XSVEH_SYOP=SVEA_SYOP
     C                   EVAL      NEWOPD=SVEA_SYOP
     C                   EVAL      XSVEH_SYSG=NEWSIGN
     C                   MOVEL     WDT           XSVEH_SYDT
     C                   EVAL      XSVEH_OMEO=SVEA_OMEO
     C                   EVAL      XSVEH_OMHA=SVTH_NAMN
     C                   EVAL      XSVEH_OMTL=SVEA_OMTL
     C                   EVAL      XSVEH_OMTY=SVEA_OMTY
     C                   EVAL      XSVEH_SYST=*BLANKS
     C                   EVAL      XSVEH_0035=SVEA_0035
      * Hæmta tullid
     C                   CALL      'SVG001R'
     C                   PARM                    XSVEH_TUID
     C                   EVAL      SVEH_TUID=XSVEH_TUID
      * Write
     C                   WRITE     SVEHR
      * Kopiera också varuposter
     C                   EVAL      *IN52=*OFF
     C     SvehKey       SETLL     SVEV1
     C     SvehKey       READE     SVEV1                                  52
     C     *IN52         DOWEQ     *OFF

     C                   EVAL      SVEV_SYAV=NEWAVD
     C                   EVAL      SVEV_SYOP=NEWOPD
     C                   WRITE     SVEVR

     C     SvehKey       READE     SVEV1                                  52
     C                   ENDDO
     C                   ENDSR
      *______________________________________________________
      * Hæmta från SAD Import, SYSPED op, eller SVE      SRGS
      *""""""""""""""""""""""""""""""""""""""""""""""""""""""
     C     SRGS          BEGSR
      * Finnes SAD Import ?
     C     SvehKey       CHAIN     SADH                               53
      * Finnes SYSPED Oppdrag ?
     C     SvehKey       CHAIN     HEADF                              54
      * Fel, finns inte varken sad import eller sysped uppdrag
     C                   IF        *IN53
     C                   IF        *IN54
     C                   eval      Error = 'Order not found'
     C                   GOTO      SRGS9
     C                   ENDIF
     C                   ENDIF
      * Skapa gemensam information
     C     SVEH_SYAV     CHAIN(N)  SVEA                               52
     C                   EVAL      XSVEH_SYAV=SVEH_SYAV
     C                   EVAL      XSVEH_SYOP=SVEH_SYOP
     C                   EVAL      XSVEH_SYSG=WSIGN
     C                   MOVEL     WDT           XSVEH_SYDT
     C                   EVAL      XSVEH_OMEO=SVEA_OMEO
     C                   EVAL      XSVEH_OMHA=SVTH_NAMN
     C                   EVAL      XSVEH_OMTL=SVEA_OMTL
     C                   EVAL      XSVEH_OMTY=SVEA_OMTY
     C                   EVAL      XSVEH_0035=SVEA_0035

     C                   CALL      'SVG001R'
     C                   PARM                    XSVEH_TUID
     C                   EVAL      SVEH_TUID=XSVEH_TUID

     C                   EVAL      XSVEH_MTYP='UGE'
     C                   EVAL      XSVEH_TART='1'
     C                   EVAL      XSVEH_DEK1='EU'
     C                   EVAL      XSVEH_DEK2='Z'
     C                   EVAL      XSVEH_UPPS='T'
      * Hæmta från SAD Import
     C  N53              EXSR      SRGSS
      * Hæmta från SYSPED oppdrag
     C   53              EXSR      SRGSO
      * Write
     C                   WRITE     SVEHR
     C     SRGS9         ENDSR
      *______________________________________________________
      * Hæmta från SAD Import                           SRGSS
      *""""""""""""""""""""""""""""""""""""""""""""""""""""""
     C     SRGSS         BEGSR
     C                   EVAL      XSVEH_AVKN=SIKNS
     C                   EVAL      XSVEH_AVNA=SINAS
     C                   EVAL      XSVEH_AVA1=SIADS1
     C                   EVAL      XSVEH_AVA2=SIADS2
     C                   EVAL      P = %SCAN (' ' : SIADS3)
     C                   EVAL      XSVEH_AVPN=%SUBST(SIADS3:1:P)
     C                   EVAL      W_PADR=%SUBST(SIADS3:P+1)
     C                   EVAL      XSVEH_AVPA=%triml(W_PADR)
     C                   EVAL      XSVEH_AVLK='SE'
     C                   EVAL      XSVEH_AVHA=SITARF
     C                   EVAL      XSVEH_AVTL=' '
     C                   EVAL      XSVEH_MOKN=SIKNK
     C                   EVAL      XSVEH_MONA=SINAK
     C                   EVAL      XSVEH_MOA1=SIADK1
     C                   EVAL      XSVEH_MOA2=SIADK2
     C                   EVAL      P = %SCAN (' ' : SIADK3)
     C                   EVAL      XSVEH_MOPN=%SUBST(SIADK3:1:P)
     C                   EVAL      W_PADR=%SUBST(SIADK3:P+1)
     C                   EVAL      XSVEH_MOPA=%triml(W_PADR)
     C                   EVAL      XSVEH_MOLK='NO'
      * Kingsrød spesial, hent mott oppl fra kundereg uansett
     C     XSVEH_MOKN    IFNE      0
     C                   MOVE      XSVEH_MOKN    KUNDNR
     C     CUNDL01K      CHAIN     CUNDL01                            40
     C                   IF        *IN40=*OFF
     C                   EVAL      XSVEH_MONA = KNAVN
     C                   EVAL      XSVEH_MOA1 = ADR1
     C                   EVAL      XSVEH_MOA2 = ADR2
     C                   IF        POSTNR = 0
     C                   EVAL      XSVEH_MOPN = SYPOGE
     C                   ELSE
     C                   EVAL      XSVEH_MOPN = *BLANKS
     C                   MOVEL     POSTNR        XSVEH_MOPN
     C                   ENDIF
     C                   EVAL      XSVEH_MOPA = ADR3
     C                   IF        SYLAND <> *BLANKS
     C                   EVAL      XSVEH_MOLK = SYLAND
     C                   ENDIF
     C                   ENDIF
     C                   ENDIF

     C                   EVAL      XSVEH_OMEO=SVEA_OMEO
     C                   EVAL      XSVEH_OMHA=SVTH_NAMN
     C                   EVAL      XSVEH_OMTL=SVEA_OMTL
     C                   EVAL      XSVEH_OMTY='A'
     C                   EVAL      XSVEH_AVUT='SE'
     C                   EVAL      XSVEH_AUBE='NO'
     C                   EVAL      XSVEH_VAKD=SIVAL3
     C                   EVAL      XSVEH_FABL=SIBEL3
     C                   MOVEL     SITRM         XSVEH_TRGR
     C                   MOVEL     '3'           XSVEH_TRIN
     C                   EVAL      XSVEH_FATY='N380'
     C                   EVAL      XSVEH_FATX=SIFIF
     C                   EVAL      XSVEH_TRID=SITRID
     C                   EVAL      XSVEH_TRAI=SITRID
     C                   EVAL      XSVEH_TRAL=SILKT
     C                   EVAL      XSVEH_CONT=SIKDC
     C                   EVAL      XSVEH_KOTA=SINTK
     C                   EVAL      XSVEH_BRUT=SIVKB
      * hæmta kundinfo
     C     XSVEH_AVKN    IFNE      0
     C                   MOVE      XSVEH_AVKN    KUNDNR
     C     CUNDL01K      CHAIN     CUNDL01                            40
     C                   IF        *IN40=*OFF
     C     XSVEH_AVEO    IFEQ      *BLANKS
     C     EORI          IFNE      *BLANKS
     C                   EVAL      XSVEH_AVEO=EORI
     C                   ELSE
     C                   MOVEL(P)  SYLAND        XSVEH_AVEO
     C                   CAT       SYRG:0        XSVEH_AVEO
     C                   CAT       '00':0        XSVEH_AVEO
     C                   ENDIF
     C                   ENDIF
     C     XSVEH_AVHA    IFEQ      *BLANKS
     C                   EVAL      XSVEH_AVHA = KPERS
     C                   ENDIF
     C     XSVEH_AVTL    IFEQ      *BLANKS
     C                   EVAL      XSVEH_AVTL = TLF
     C                   ENDIF
      * Hent avs.oppl fra kundereg uansett   KINGSRØD
     C                   EVAL      XSVEH_AVHA = KPERS
     C                   EVAL      XSVEH_AVTL = TLF
     C                   EVAL      XSVEH_AVNA = KNAVN
     C                   EVAL      XSVEH_AVA1 = ADR1
     C                   EVAL      XSVEH_AVA2 = ADR2
     C                   IF        POSTNR = 0
     C                   EVAL      XSVEH_AVPA = SYPOGE
     C                   ELSE
     C                   EVAL      XSVEH_AVPA = *BLANKS
     C                   MOVEL     POSTNR        XSVEH_AVPN
     C                   ENDIF
     C                   MOVEL     ADR3          XSVEH_AVPA
     C                   IF        SYLAND <> *BLANKS
     C                   EVAL      XSVEH_AVLK = SYLAND
     C                   ENDIF
     C                   EVAL      XSVEH_AVTL = TLF

     C                   ENDIF
     C                   ENDIF
     C     XSVEH_AVHA    IFEQ      *BLANKS
     C                   EVAL      XSVEH_AVHA=SVTH_NAMN
     C                   EVAL      XSVEH_AVTL=SVEA_OMTL
     C                   ENDIF
      *Og bitte lite til fra HEADF
     C     *IN54         IFEQ      *OFF
     C                   EVAL      XSVEH_TRID=HEHAWB
     C                   EVAL      XSVEH_TRAI=HEHAWB
     C                   ENDIF
      * Kopier varelinjer
     C                   CALL      'SVE009R'
     C                   PARM                    SVEH_SYAV
     C                   PARM                    SVEH_SYOP
      * Kopier varelinjer
     C                   CALL      'SVE009RX'
     C                   PARM                    SVEH_SYAV
     C                   PARM                    SVEH_SYOP

     C                   ENDSR
      *______________________________________________________
      * Hæmta från SYSPED Oppdrag                       SRGSO
      *""""""""""""""""""""""""""""""""""""""""""""""""""""""
     C     SRGSO         BEGSR
     C                   EVAL      XSVEH_AVKN=HEKNS
     C                   EVAL      XSVEH_AVNA=HENAS
     C                   EVAL      XSVEH_AVA1=HEADS1
     C                   EVAL      XSVEH_AVA2=HEADS2
     C                   EVAL      P = %SCAN (' ' : HEADS3)
     C                   EVAL      XSVEH_AVPN=%SUBST(HEADS3:1:P)
     C                   EVAL      W_PADR=%SUBST(HEADS3:P+1)
     C                   EVAL      XSVEH_AVPA=%triml(W_PADR)
     C                   EVAL      XSVEH_AVLK=HELKS
     C                   EVAL      XSVEH_MOKN=HEKNK
     C                   EVAL      XSVEH_MONA=HENAK
     C                   EVAL      XSVEH_MOA1=HEADK1
     C                   EVAL      XSVEH_MOA2=HEADK2
     C                   EVAL      P = %SCAN (' ' : HEADK3)
     C                   EVAL      XSVEH_MOPN=%SUBST(HEADK3:1:P)
     C                   EVAL      W_PADR=%SUBST(HEADK3:P+1)
     C                   EVAL      XSVEH_MOPA=%triml(W_PADR)
     C                   EVAL      XSVEH_MOLK='SE'
      * Kingsrød spesial, hent mott oppl fra kundereg uansett
     C     XSVEH_MOKN    IFNE      0
     C                   MOVE      XSVEH_MOKN    KUNDNR
     C     CUNDL01K      CHAIN     CUNDL01                            40
     C                   IF        *IN40=*OFF
     C                   EVAL      XSVEH_MONA = KNAVN
     C                   EVAL      XSVEH_MOA1 = ADR1
     C                   EVAL      XSVEH_MOA2 = ADR2
     C                   IF        POSTNR = 0
     C                   EVAL      XSVEH_MOPN = SYPOGE
     C                   ELSE
     C                   EVAL      XSVEH_MOPN = *BLANKS
     C                   MOVEL     POSTNR        XSVEH_MOPN
     C                   ENDIF
     C                   EVAL      XSVEH_MOPA = ADR3
     C                   IF        SYLAND <> *BLANKS
     C                   EVAL      XSVEH_MOLK = SYLAND
     C                   ENDIF
     C                   ENDIF
     C                   ENDIF

     C                   EVAL      XSVEH_OMEO=SVEA_OMEO
     C                   EVAL      XSVEH_OMHA=SVTH_NAMN
     C                   EVAL      XSVEH_OMTL=SVEA_OMTL
     C                   EVAL      XSVEH_OMTY='A'
     C                   EVAL      XSVEH_AVUT='SE'
     C                   EVAL      XSVEH_AUBE='NO'
     C                   EVAL      XSVEH_KOTA=HENT
     C                   EVAL      XSVEH_BRUT=HEVKT
     C                   MOVEL     HETRC         XSVEH_CONT
     C                   MOVEL     HETRM         XSVEH_TRGR
     C                   MOVEL     '3'           XSVEH_TRIN
     C                   EVAL      XSVEH_TRAL=HETRI
     C                   EVAL      XSVEH_TRID=HEHAWB
     C                   EVAL      XSVEH_TRAI=HEHAWB
     C     XSVEH_TRAI    IFEQ      *BLANKS
     C                   EVAL      XSVEH_TRAI=HETRCN
     C                   ENDIF
     C     XSVEH_TRID    IFEQ      *BLANKS
     C                   EVAL      XSVEH_TRID=HETRCN
     C                   ENDIF
      * hæmta kundinfo
     C     XSVEH_AVKN    IFNE      0
     C                   MOVE      XSVEH_AVKN    KUNDNR
     C     CUNDL01K      CHAIN     CUNDL01                            40
     C                   IF        *IN40=*OFF
     C     XSVEH_AVEO    IFEQ      *BLANKS
     C     EORI          IFNE      *BLANKS
     C                   EVAL      XSVEH_AVEO=EORI
     C                   ELSE
     C                   MOVEL     SYLAND        XSVEH_AVEO
     C                   CAT       SYRG:00       XSVEH_AVEO
     C                   CAT       '00':0        XSVEH_AVEO
     C                   ENDIF
     C                   ENDIF
     C     XSVEH_AVHA    IFEQ      *BLANKS
     C                   EVAL      XSVEH_AVHA = KPERS
     C                   ENDIF
     C     XSVEH_AVTL    IFEQ      *BLANKS
     C                   EVAL      XSVEH_AVTL = TLF
     C                   ENDIF
      * Hent avs.oppl fra kundereg uansett   KINGSRØD
     C                   EVAL      XSVEH_AVHA = KPERS
     C                   EVAL      XSVEH_AVTL = TLF
     C                   EVAL      XSVEH_AVNA = KNAVN
     C                   EVAL      XSVEH_AVA1 = ADR1
     C                   EVAL      XSVEH_AVA2 = ADR2
     C                   IF        POSTNR = 0
     C                   EVAL      XSVEH_AVPA = SYPOGE
     C                   ELSE
     C                   EVAL      XSVEH_AVPA = *BLANKS
     C                   MOVEL     POSTNR        XSVEH_AVPN
     C                   ENDIF
     C                   MOVEL     ADR3          XSVEH_AVPA
     C                   IF        SYLAND <> *BLANKS
     C                   EVAL      XSVEH_AVLK = SYLAND
     C                   ENDIF
     C                   EVAL      XSVEH_AVTL = TLF

     C                   ENDIF
     C                   ENDIF
     C     XSVEH_AVHA    IFEQ      *BLANKS
     C                   EVAL      XSVEH_AVHA=SVTH_NAMN
     C                   EVAL      XSVEH_AVTL=SVEA_OMTL
     C                   ENDIF
     C                   ENDSR
