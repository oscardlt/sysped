********************************************************************
      * RETTINGER I DETTE PROGRAM:
PTFnr:*Sek Sig Vers  Beskrivelse...........................
""""""*"""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""
10XXX * 01 YBC PTF10 RETTELSE ETTER UTVIDELSE AV OPPDRAGSNR
10XXX * 02 JOV PTF10 Internbelastninger - F=Kun Ferdige/Førte,U=Kun Uferdige/Uførte
      * 03 JOV PTF10 TUR-basert  RAPP - når DAG-del er fylt ut, les via DATO (TURER22)
      * 03 SH  PTF10 ikke lag spool hvis bare til fil
      * 04 SH  PTF11 plukker på regnskapsnivå Ny kode = F
xxxxxx*xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
11118 * 05 YBC PTF11 FILTYPE = 'E' FOR EPOST
********************************************************************
     FFAKGB2    IF   E           K DISK
     F                                     RENAME(FAKTR:FAKTGBR)
     FHEADF     IF   E           K DISK
     F                                     RENAME(HEADFR:HEDFRXX)
     FKODTFM    IF   E           K DISK
     FAVSLUTF   IF   E           K DISK
     FAVSLUTL2  IF   E           K DISK
     F                                     RENAME(AVSLUTFR:AVSLU2)
     FHEADDT    IF   E           K DISK
     F                                     RENAME(HEADFR:HEADDTR)
     FHEAD11    IF   E           K DISK
     F                                     RENAME(HEADFR:HEAD11R)
     FTURER18   IF   E           K DISK
N03  FTURER22   IF   E           K DISK
N03  F                                     RENAME(TURERR:TUR22R)
     FTURER14   IF   E           K DISK
     F                                     RENAME(TURERR:TUR14R)
     FTRAN      IF   E           K DISK
     FFAKT      IF   E           K DISK
     FKOSBU2    IF   E           K DISK
     FKOSBU9    IF   E           K DISK
     F                                     RENAME(KOSBUR:KOSBU9R)
     FKOSTA     IF   E           K DISK
     FKOSTB4    IF   E           K DISK
     FTRAVH1    IF   E           K DISK
     FVALUL01   IF   E           K DISK
     FFIRM      IF   E           K DISK
     FAVDGR     IF   E           K DISK
     FKODTGE    IF   E           K DISK
     FSYKS30W   UF A E           K DISK
     FSYKS30W1  UF A E           K DISK
     F                                     RENAME(SYKS30WR:SYK30W1R)
     FSYKS30W9  UF   E           K DISK
     F                                     RENAME(SYKS30WR:SYK30W9R)
     FSYKS30X   IF   E           K DISK
     FSYKS30S   IF   E           K DISK
     FSYKS30PF  O    E             PRINTER OFLIND(*IN88)
     D AG              S              4  0 DIM(99)
     D                 DS
     D  PARMDS                 1    256
     D  WSOPTU                 1      1
     D  WSFALI                 2      2
     D  WSUFLI                 3      3
     D  WSFKOS                 4      4
     D  WSBKOS                 5      5
     D  WSILIN                 6      6
     D  UUREGT                 7     13
     D  WSREGT                 7     13  0
     D  UUDBGT                14     18
     D  WSDBGT                14     18  2
     D  UURELT                19     25
     D  WSRELT                19     25  0
     D  UUDBLT                26     30
     D  WSDBLT                26     30  2
     D  WSAVRS                31     31
     D  UUPERF                32     37
     D  WSPERF                32     37  0
     D  WSHF                  32     33  0
     D  WSÅF                  34     35  0
     D  WSMF                  36     37  0
     D  UUPERT                38     43
     D  WSPERT                38     43  0
     D  UUAVDF                44     47
     D  WSAVDF                44     47  0
     D  UUAVDT                48     51
     D  WSAVDT                48     51  0
     D  WSAVDG                52     58
     D  WSORAN                59     59
     D  WSPERI                60     60
     D  WSGEIO                61     61
     D  WSGE01                62     64
     D  WSGE02                65     67
     D  WSGE03                68     70
     D  WSGE04                71     73
     D  WSGE05                74     76
     D  WSGE06                77     79
     D  WSGE07                80     82
     D  WSGE08                83     85
     D  WSGE09                86     88
     D  WSGE10                89     91
     D  WSGE11                92     94
     D  WSGE12                95     97
     D  WSGE13                98    100
     D  GE                    62    100
     D                                     DIM(13)
     D  WSSTIO               101    101
     D  WSSTGR               102    111
     D  SG                   102    111
     D                                     DIM(10)
     D  WSAVSL               112    112
     D  WSBAVD               113    113
     D  WSOTYP               114    115
     D  WSGLKJ               116    116
     D  WSPEFD               117    118  0
     D  WSPETD               119    120  0
     D  WSRNAV               121    130
     D  WSSG                 131    133
     D  DUMMY                256    256
n04  D                 DS
n04  D  DSHT                   1      2  0
n04  D  DSÅT                   3      4  0
n04  D  DSMT                   5      6  0
N04  D  DSFAPE                 1      6  0
     D                 DS
     D  TUPERI                 1      6  0
     D  TURACC                 1      2  0
     D  TURAAR                 3      4  0
     D  TURMND                 5      6  0
     D                 DS
     D  FAGGRP                 1      2
     D  FAGIK                  2      2
     D                 DS
     D  HEDTOP                 1      8  0
     D  HEDTC                  1      2  0
     D  HEDTÅ                  3      4  0
     D  HEDTM                  5      6  0
     D  HEDTÅM                 3      6  0
     D                 DS
     D  WFALI                  1     13  2
     D  YFALI                  3     13  2
     D                 DS
     D  WUFLI                  1     13  2
     D  YUFLI                  3     13  2
     D                 DS
     D  WIILIN                 1     13  2
     D  YIILIN                 3     13  2
     D                 DS
     D  WOMS                   1     13  2
     D  YOMS                   3     13  2
     D                 DS
     D  WFKOS                  1     13  2
     D  YFKOS                  3     13  2
     D                 DS
     D  WBKOS                  1     13  2
     D  YBKOS                  3     13  2
     D                 DS
     D  WBTKOS                 1     13  2
     D  YBTKOS                 3     13  2
     D                 DS
     D  WKILIN                 1     13  2
     D  YKILIN                 3     13  2
     D                 DS
     D  WKOS                   1     13  2
     D  YKOS                   3     13  2
     D                 DS
     D  WRES                   1     13  2
     D  YRES                   3     13  2
     D                 DS
     D  ZFALI                  1     13  2
     D  UFALI                  3     13  2
     D                 DS
     D  ZUFLI                  1     13  2
     D  UUFLI                  3     13  2
     D                 DS
     D  ZIILIN                 1     13  2
     D  UIILIN                 3     13  2
     D                 DS
     D  ZOMS                   1     13  2
     D  UOMS                   3     13  2
     D                 DS
     D  ZFKOS                  1     13  2
     D  UFKOS                  3     13  2
     D                 DS
     D  ZBKOS                  1     13  2
     D  UBKOS                  3     13  2
     D                 DS
     D  ZBTKOS                 1     13  2
     D  UBTKOS                 3     13  2
     D                 DS
     D  ZKILIN                 1     13  2
     D  UKILIN                 3     13  2
     D                 DS
     D  ZKOS                   1     13  2
     D  UKOS                   3     13  2
     D                 DS
     D  ZRES                   1     13  2
     D  URES                   3     13  2
      *
      *
     C                   EXSR      INIT
      *
      *   på regnskapsnivå F  fra periode FINANS
      *
N04  C     WSOPTU        IFEQ      'F'
N04  C                   EXSR      LESREGN
N04  C                   EXSR      SKROPD
N04  C                   ELSE
      *
      * f på oppdragsnivå
      *
     C     WSOPTU        IFEQ      'O'
     C                   EXSR      LESOPD
     C                   EXSR      SKROPD
     C                   ELSE
     C                   EXSR      LESTUR
      * 55 on = Meglerrapport (M orinær eller H brudd på h.oppdr)
     C     *IN55         IFEQ      *OFF
     C                   EXSR      SKRTUR
     C                   ELSE
     C                   EXSR      SKRSIG
     C                   END
     C                   END
      *
      * EVT - SISTE AVD.BRUDD
      *
     C     WSBAVD        IFEQ      'J'
     C     WSBAVD        OREQ      'B'
     C     GMAVD         IFNE      *ZEROS
     C                   EXSR      BRUDD
     C                   END
     C                   END
N04  C                   END
      *
      * EVT - SISTE MEGLER/SIGN.-BRUDD
     C     *IN55         IFEQ      *ON
     C     GMSG          ANDNE     *BLANKS
     C                   EXSR      BRUDDM
     C                   END
      *
      * TOTALER..
     C                   EXSR      TOTAL
      *
     C                   SETON                                        LR
     C                   RETURN
      *
     C***********************************************
     C     LESOPD        BEGSR
     C***********************************************
      * OBS - DENNE RUTINEN KALLES OGSÅ NÅR TUR-BEHANDLING,
      * MEN DA PÅ JAKT ETTER OPPDRAG M/TURNR UTENOM TRANSP-MODULEN
     C     FRADAT        SETLL     HEADDT
     C                   READ      HEADDT                                 34
     C     *IN34         DOWEQ     '0'
     C     HEDTOP        IFGT      TILDAT
     C                   GOTO      UTLESO
     C                   END
     C* Når det leses på TURNIVÅ....
     C     WSOPTU        IFNE      'O'
N04  C     WSOPTU        ANDNE     'F'
     C     HEPRO         CABEQ     *ZEROS        NEXTOP                          KUN PÅ TUR
     C     HEUR          CABEQ     'H'           NEXTOP                          FRA TR-MOD.
     C     WSBAVD        IFNE      'J'
     C     WSBAVD        ANDNE     'B'
     C                   MOVE      *ZEROS        WAVD
     C                   ELSE
     C                   MOVE      HEAVD         WAVD
     C                   END
     C                   MOVE      HEPRO         WTUR
     C     WTKEY         CHAIN(N)  SYKS30W1                           35
     C     *IN35         IFEQ      '0'                                           FINNES SOM
     C     WSG           ANDNE     '*S*'                                         TR.DISP-TUR
     C                   GOTO      NEXTOP
     C                   END
     C                   MOVEL     HEDTÅ         TURAAR
     C                   MOVE      HEDTM         TURMND
     C                   END
     C                   EXSR      ETTOPD
     C     NEXTOP        TAG
     C                   READ      HEADDT                                 34
     C                   END
      *
     C     UTLESO        TAG
      *
     C                   exsr      BEREGNDB
     C                   ENDSR
      *
N04  C***********************************************
N04  C     LESREGN       BEGSR
N04  C***********************************************
N04   * OBS - DENNE RUTINEN KALLES OGSÅ NÅR REGNSKAP skal sammenlignes mot
N04   * MEN DA PÅ JAKT ETTER OPPDRAG M/TURNR UTENOM TRANSP-MODULEN
N04  C     keygb2        klist
N04  C                   kfld                    XXcc
N04  c                   kfld                    XXÅR
N04  c                   kfld                    XXmnd
N04  C                   KFLD                    XXAVD
N04  C                   KFLD                    XXOPD
N04   *
N04  C     FAKEY         klist
N04  C                   kfld                    FAAVD
N04  c                   kfld                    FAOPD
N04   *
N04  c                   move      WSHF          XXcc              2 0
N04  c                   move      WSÅF          XXÅR              2 0
N04  c                   move      WSMF          XXMND             2 0
N04  c                   move      *zeros        XXAVD             4 0
N04  c                   move      *ZEROS        XXOPD             7 0
N04   *
N04  C     KEYGB2        SETLL     FAKGB2
N04  C                   READ      FAKGB2                                 34
N04  C     *IN34         DOWEQ     '0'
N04   *
N04  c                   move      facc          DSHT
N04  c                   move      faÅR          DSÅT
N04  c                   move      faMND         DSMT
N04   *
N04  C     DSFAPE        IFGT      WSPERT
N04  C                   GOTO      UTLESR
N04  C                   END
N04  C     FAKDA         IFEQ      'K'
N04  C     FAOPKO        ORNE      'O'
N04  C                   GOTO      NEXTOPR
N04  C                   END
N04  C     FAKEY         CHAIN     HEADF                              33
N04  c                   move      facc          XXcc              2 0
N04  c                   move      faÅr          XXÅR              2 0
N04  c                   move      famnd         XXMND             2 0
N04  c                   move      faavd         XXAVD             4 0
N04  c                   move      faopd         XXOPD             7 0
N04  C  N33              EXSR      ETTOPD
N04  C     KEYGB2        SETGT     FAKGB2
N04  C     NEXTOPR       TAG
N04  C                   READ      FAKGB2                                 34
N04  C                   END
N04   *
N04  C     UTLESR        TAG
N04   *
N04  C                   exsr      BEREGNDB
N04  C                   ENDSR
N04   *
     C***********************************************
     C     LESTUR        BEGSR
     C***********************************************
      * LESER FØRST TURER FRA TRANSPORT-MODULEN. (BEDRE PERI-STYRING)
N03  C     WSPEFD        IFEQ      *ZEROS
     C     TURKEY        SETLL     TURER18
     C                   READ      TURER18                                34
N03  c                   else
N03  C     FRADAT        SETLL     TURER22
N03  C                   READ      TURER22                                34
N03  c                   endif
     C     *IN34         DOWEQ     '0'
      * ANGITT HELE Perioder (dag 00)
     C     WSPEFD        IFEQ      *ZEROS
     C     TUPERI        IFGT      WSPERT
     C                   GOTO      UTLEST
     C                   END
     C                   else
      * .. eller full dato
      * (nøkkel i TURER18 er uansett ÅR/MND, så om turens dato ikke
      *  samsvarer med periode så....)
s03  C*    TUDT          IFLT      FRADAT
s03  C*                  GOTO      NXTTUR
s03  C*                  END
     C     TUDT          IFGT      TILDAT
s03  C*                  GOTO      NXTTUR
N03  C                   GOTO      UTLEST
     C                   END
     C                   end
      * EGENTLIG UNØDIG.. TUDT ULIK 0 SÅ ER NOK LISTE KJØRT....
      * - OBS - IKKE HOPP OVER HENTETURER SELV OM GL IKKE ER KJØRT
     C     TUTST1        IFEQ      ' '
     C     WSGLKJ        ANDEQ     'J'
     C                   GOTO      NXTTUR
     C                   END
      * Finn/akkumuler alle oppdrag på turen
     C     TUPRO         SETLL     HEAD11
     C     TUPRO         READE     HEAD11                                 34
     C     *IN34         DOWEQ     '0'
     C                   EXSR      ETTOPD
     C     TUPRO         READE     HEAD11                                 34
     C                   END
      *
     C     NXTTUR        TAG
N03  C     WSPEFD        IFEQ      *ZEROS
     C                   READ      TURER18                                34
N03  c                   else
N03  C                   READ      TURER22                                34
N03  c                   endif
     C                   END
      *
     C     UTLEST        TAG
      *
      * SPEDISJONSOPPDRAG SKAL IKKE MED VED M/H=MEGLER (=55 ON) eller RUNDtur
     C     *IN55         IFEQ      *OFF
     C     WSOPTU        andne     'R'
      * GÅR SÅ GJENNOM ALLE OPPDRAG FOR Å FANGE SPED-OPPDR. M/TURNR.
     C                   MOVE      '*S*'         TUSG
     C                   EXSR      LESOPD
     C                   END
      *
     C                   exsr      BEREGNDB
     C                   ENDSR
     C***********************************************
     C     ETTOPD        BEGSR
     C***********************************************
      * Slettemerket /mønsteroppdrag
     C     HEST          IFEQ      'S'
     C     HEOPD         ORLT      *ZEROS
     C                   GOTO      UTETTO
     C                   END
      *KUN OPPDRAGSTYPE...
     C     WSOTYP        IFNE      *BLANKS
     C     HEOT          ANDNE     WSOTYP
     C                   GOTO      UTETTO
     C                   END
      *KUN SIGNATURKODE
     C     WSSG          IFNE      *BLANKS
     C     HESG          ANDNE     WSSG
     C                   GOTO      UTETTO
     C                   END
     C* TEST AVSLUTTEDE OPPDRAG
      *
     C     WSAVSL        IFNE      'A'
     C     OPDKEY        CHAIN     AVSLUTF                            33
     C   33HEPRO         IFNE      *ZEROS
     C     HEPRO         CHAIN     AVSLUTL2                           33
     C                   END
     C  N33WSAVSL        IFEQ      'N'
     C                   GOTO      UTETTO
     C                   END
     C   33WSAVSL        IFEQ      'B'
     C                   GOTO      UTETTO
     C                   END
     C                   END
      * Begrenset på avdeling. FRA/TIL
     C     WSAVDF        IFNE      *ZEROS
     C     WSAVDT        ORNE      *ZEROS
     C     HEAVD         IFLT      WSAVDF
     C     HEAVD         ORGT      WSAVDT
     C                   GOTO      UTETTO
     C                   END
     C                   END
      *
      * Begrenset på avd.GRUPPE
     C     WSAVDG        IFNE      *BLANKS
      * NÅR begrepet finnes i -arrayet  ->33 on
     C                   SETOFF                                         33
     C     HEAVD         LOOKUP    AG                                     33
     C  N33              GOTO      UTETTO
     C                   END
      *
      *
     C                   CLEAR                   SYKS30WR
     C                   MOVE      HEPRO         WTUR
     C     WSOPTU        Ifeq      'R'
     C     TRRUND        cabeq     *zeros        UTETTO
     C                   MOVE      TRRUND        WTUR
     c                   end
     C     WSOPTU        IFEQ      'O'
N04  C     WSOPTU        OREQ      'F'
     C                   MOVE      HEAVD         WAVD
     C                   MOVE      HEOPD         WOPD
     C                   MOVE      HESG          WSG
     C                   MOVE      HEDTÅM        WPER
     C     OPDKEY        CHAIN     SYKS30W                            35
     C                   ELSE
     C                   MOVE      TUSG          WSG
     C                   MOVEL     TURAAR        WPER
     C                   MOVE      TURMND        WPER
     C     WSBAVD        IFNE      'J'
     C     WSBAVD        ANDNE     'B'
     C                   MOVE      *ZEROS        WAVD
     C                   ELSE
     C                   MOVE      HEAVD         WAVD
     C                   END
     C     WSOPTU        IFEQ      'H'
     C                   MOVEL     TRKNFA        WTURHK
     C                   MOVEL     HXSNDN        WTURHO
     C                   END
     C     WTKEY         CHAIN     SYKS30W1                           35
     C* For enklere feilfinning stjerne linja foran / aktiver neste ( detaljert til fil)...
     C*                  move      *ON           *IN35
     C                   END
      *
      * AKKUMULER VERDIER BASERT PÅ FAKT.LINJER
     C     OPDKEY        SETLL     FAKT
     C     OPDKEY        READE     FAKT                                   34
     C     *IN34         DOWEQ     '0'
N04  C     WSOPTU        IFEQ      'F'
N04  c                   move      facc          DSHT
N04  c                   move      faÅR          DSÅT
N04  c                   move      faMND         DSMT
N04   *
N04  C     DSFAPE        IFGT      WSPERT
N04  C     DSFAPE        ORLT      WSPERF
N04  C                   GOTO      nestel
N04  C                   END
N04  C                   END
      *
      * Include / Omit basert på GEB-kode
     C                   SETOFF                                       3033
     C     WSGEIO        IFNE      ' '
     C     WSGEIO        IFEQ      'I'
      * Ved include må begrepet finnes i -arrayet (->33 on)
     C     FAVK          LOOKUP    GE                                     33
     C  N33              SETON                                        30
     C                   ELSE
      * Ved omit må begrepet IKKE finnes i -arrayet (->33 off)
     C     FAVK          LOOKUP    GE                                     33
     C   33              SETON                                        30
     C                   END
     C                   END
      *
      * Include / Omit basert på STAT-GRUPPE-KODE
      * Dersom linjen IKKE har gruppe (ufakt/manglet da den ble skapt) hent grp.via geb-kode
     C     FAGGRP        IFEQ      *BLANKS
     C                   MOVE      FAVK          KGEKOD
     C     KODGEK        CHAIN     KODTGE                             33
     C     FASK          IFEQ      'I'
     C     FABELN        IFGT      *ZEROS
     C                   MOVEL     KGEII         FAGGRP
     C                   ELSE
     C                   MOVEL     KGEKI         FAGGRP
     C                   END
     C                   ELSE
     C     FAKDA         IFNE      'K'
     C                   MOVEL     KGEIE         FAGGRP
     C                   ELSE
     C                   MOVEL     KGEKE         FAGGRP
     C                   END
     C                   END
     C                   END
      *
     C     *IN30         IFEQ      *OFF
     C     FAGGRP        ANDNE     *BLANKS
      *
     C                   SETOFF                                       33
     C                   MOVEL     FAGGRP        TSTGRP            1
     C     WSSTIO        IFNE      ' '
     C     WSSTIO        IFEQ      'I'
      * Ved include må begrepet finnes i -arrayet (->33 on)
     C     TSTGRP        LOOKUP    SG                                     33
     C  N33              SETON                                        30
     C                   ELSE
      * Ved omit må begrepet IKKE finnes i -arrayet (->33 off)
     C     TSTGRP        LOOKUP    SG                                     33
     C   33              SETON                                        30
     C                   END
     C                   END
     C                   END
      * ÅPNE I-linjer - ligger kun en vei - hvordan takle de....
      * Åpen I-linje PÅ HOVEDOPPDRAG som peker på samme avd (eller 0)
      * (="skumming") skal uansett ikke tas med..
     C     *in30         IFEQ      *OFF
     C     FASK          andeq     'I'
     C     FAOPKO        andeq     ' '
     C     TRSLAG        Ifne      'FF'
     C     TRSLAG        andne     'VF'
     C     Faavdr        ifeq      faavd
     C     Faavdr        oreq      0
     C                   SETON                                        30
     C                   END
     C                   END
     C                   END
      * Intern Overføringer innen samme avd tas IKKE hensyn til
     C     *in30         IFEQ      *OFF
     c     faopko        andlt     'O'
     C     FASK          andeq     'I'
     C                   move      faavd         tstavdA           4
     C                   move      favt          tstavdB           4
     C     TSTAVDA       IFEQ      TSTAVDB
     C                   SETON                                        30
     C                   END
     C                   END
      * Ikke eliminerte (ved I/O),ikke slettede..
     C     *IN30         IFNE      '1'
     C     FAOPKO        ANDNE     'D'
     C     FAKDA         ANDNE     'D'
      *
      * Geb-koder som mangler grp-kode i KODTGE
     C     FAGIK         IFEQ      ' '
     C                   MOVE      'I'           FAGIK
     C     FAKDA         IFEQ      'K'
     C                   MOVE      'K'           FAGIK
     C                   else
     C     FASK          IFEQ      'I'
     C     FABELN        ANDLT     *ZEROS
     C                   MOVE      'K'           FAGIK
     C                   end
     C                   end
     C                   END
      * Status OVERFØRT til økonomi...
     C     FAOPKO        IFEQ      'O'
     C     FAOPKO        OREQ      'T'
     C     FAOPKO        OREQ      'Z'
      * STATISTISK KODE KAN HA SNUDD INTEKT/KOSTNAD...
      * Linje som skal inn i en KOSTN-kolonne ekst/intern
     C     FAGIK         IFEQ      'K'
     C     WSFKOS        IFEQ      'J'
     C     FASK          IFNE      'I'
     C                   ADD       FABELN        WFKOS
      * Intern
     C                   ELSE
     C     WSILIN        IFEQ      'J'
N02  C     WSILIN        OREQ      'F'
     C     FABELN        IFGT      *ZEROS
     C                   ADD       FABELN        WIILIN
     C                   ELSE
     C                   ADD       FABELN        WKILIN
     C                   END
     C                   END
     C                   END
     C                   END
     C                   ELSE
      * Ikke kostnad, da er det enten...
      * Fakt.linje ..
     C     FASK          IFEQ      'K'
     C     FASK          OREQ      'S'
     C     FASK          OREQ      'X'
     C     FASK          OREQ      'F'
     C     WSFALI        IFEQ      'J'
     C                   ADD       FABELN        WFALI
     C                   END
     C                   ELSE
      * Intern
     C     FASK          IFEQ      'I'
     C     WSILIN        IFEQ      'J'
N02  C     WSILIN        OREQ      'F'
     C     FABELN        IFGT      *ZEROS
     C                   ADD       FABELN        WIILIN
     C                   ELSE
     C                   ADD       FABELN        WKILIN
     C                   END
     C                   END
     C                   END
     C                   END
     C                   END
     C*
     C                   ELSE
      * Ikke overført.....
     C     WSUFLI        IFEQ      'J'
     C     FASK          ANDNE     'F'
      * INTERN (etter PTF15 skal det ikke komme noe her....)
     C     FASK          IFEQ      'I'
     C     WSILIN        IFEQ      'J'
N02  C     WSILIN        OREQ      'U'
     C     FABELN        IFGT      *ZEROS
     C                   ADD       FABELN        WIILIN
     C                   ELSE
     C                   ADD       FABELN        WKILIN
     C                   END
     C                   END
     C                   ELSE
     C     FAGIK         IFEQ      'K'
     C                   ADD       FABELN        WBKOS
     C                   ELSE
     C                   ADD       FABELN        WUFLI
     C                   END
     C                   END
     C                   END
     C                   END
     C*
     C                   END
N04  C     nestel        TAG
     C     OPDKEY        READE     FAKT                                   34
     C                   END
      *
      * I linjer på "Underordnert oppdrag" som ennå ikke er overført!
     C     WSILIN        IFEQ      'J'
N02  C     WSILIN        oreq      'U'
     C     TrOpd1        IFNE      *zeros
     C                   move      travd1        dupavd
     C                   move      tropd1        dupopd
     C                   exsr      DupKost
     C                   end
     C     TrOpd2        IFNE      *zeros
     C                   move      travd2        dupavd
     C                   move      tropd2        dupopd
     C                   exsr      DupKost
     C                   end
     C                   end
      *
      * AKKUMULER VERDIER BASERT PÅ BUDSJ.POSTER
     C     WSBKOS        IFEQ      'J'
     C     KOSB9K        SETLL     KOSBU9
     C     KOSB9K        READE     KOSBU9                                 34
     C     *IN34         DOWEQ     '0'
      * Include / Omit basert på GEB-kode
     C                   SETOFF                                       3033
     C     WSGEIO        IFNE      ' '
     C     WSGEIO        IFEQ      'I'
      * Ved include må begrepet finnes i -arrayet (->33 on)
     C     BUVK          LOOKUP    GE                                     33
     C  N33              SETON                                        30
     C                   ELSE
      * Ved omit må begrepet IKKE finnes i -arrayet (->33 off)
     C     BUVK          LOOKUP    GE                                     33
     C   33              SETON                                        30
     C                   END
     C                   END
      * Include / Omit basert på STAT-GRUPPE-KODE
      *                hent grp.via geb-kode
     C                   MOVE      *BLANKS       FAGGRP
     C                   MOVE      BUVK          KGEKOD
     C     KODGEK        CHAIN     KODTGE                             33
     C                   MOVEL     KGEIE         FAGGRP
     C*
     C     *IN30         IFEQ      *OFF
     C     FAGGRP        ANDNE     *BLANKS
      *
     C                   SETOFF                                       33
     C                   MOVEL     FAGGRP        TSTGRP            1
     C     WSSTIO        IFNE      ' '
     C     WSSTIO        IFEQ      'I'
      * Ved include må begrepet finnes i -arrayet (->33 on)
     C     TSTGRP        LOOKUP    SG                                     33
     C  N33              SETON                                        30
     C                   ELSE
      * Ved omit må begrepet IKKE finnes i -arrayet (->33 off)
     C     TSTGRP        LOOKUP    SG                                     33
     C   33              SETON                                        30
     C                   END
     C                   END
     C                   END
      * IKKE HVIS ELIMINERT...
     C     *IN30         IFNE      '1'
     C                   Z-SUB     BUBL          TMPBL            13 2
     C* Omregn valuta
     C     BUVAL         IFNE      FICURR
     C     VALU1K        CHAIN     VALUL01                            33
     C  N33VALKU1        DIV       OMRFAK        XFAK              9 6
     C  N33              MULT(H)   XFAK          TMPBL
     C                   END
     C                   ADD       TMPBL         WBKOS
     C                   END
     C     KOSB9K        READE     KOSBU9                                 34
     C                   END
      *
      * HENT EVT UFERDIGE KOSTN.BILAG MED REF TIL OPPDRAGET
     C                   EXSR      ÅPKOST
      *
      * Dersom det er TUR-nr, ER det alt kalkulert evt felles-kost?
      * i så fall hvor stor andel gjelder dette oppdrag?
     C                   MOVE      ' '           WBP
     C                   MOVE      ' '           WBV
     C     WTUR          IFNE      *ZEROS
     C     WTUR          CHAIN     SYKS30X                            33
     C     *IN33         IFEQ      '1'
     C                   EXSR      BUDTUR
     C     WTUR          CHAIN     SYKS30X                            33
     C                   END
     C                   MOVE      XBP           WBP
     C     XBEL          IFNE      *ZEROS
     C     HEFBV         IFEQ      *ZEROS
     C                   Z-ADD     HEVKT         HEFBV
     C                   END
     C     HEFBV         IFEQ      *ZEROS
     C                   Z-ADD     1             HEFBV
     C                   END
     C     HEFBV         IFEQ      XVKT                                          =full-load
     C                   ADD       XBEL          WBTKOS
     C                   ELSE
     C     HEFBV         DIV(H)    XVKT          FAKTOR           19 9
     C     XBEL          MULT(H)   FAKTOR        TMPBL
     C                   ADD       TMPBL         WBTKOS
     C                   MOVE      'V'           WBV
     C                   END
     C                   END
     C                   END
      *
     C                   END                                                     WSBKOS=J
      *
      * Legg til i workfile..
     C     WSOPTU        IFEQ      'O'
N04  C     WSOPTU        OREQ      'F'
     C   35              WRITE     SYKS30WR
     C  N35              UPDATE    SYKS30WR
     C                   ELSE
     C   35              Z-ADD     1             WTANT
     C   35              WRITE     SYK30W1R
     C  N35              ADD       1             WTANT
     C  N35              UPDATE    SYK30W1R
     C                   END
      *
     C     UTETTO        ENDSR
      *
      *
     C***********************************************
     C     DupKost       BEGSR
     C***********************************************
      *
      * AKKUMULER VERDIER BASERT PÅ FAKT.LINJER på dup-oppdrag
      * (Dvs - sjekk om det finnes en forventet internkostnad knyttet
      * til underliggende DUP - siden det I kateg Internoverf. IKKE
      * finnes egen kolonne for INT.Forv.Kost plasseres det I-Kostn.)
     C     DUPKEY        SETLL     FAKT
     C     DUPKEY        READE     FAKT                                   34
     C     *IN34         DOWEQ     '0'
      * Kun åpne I-linjer skal hentes fra dup-oppdrag.
     c     FASK          IFNE      'I'
     c     FAOPKO        ORNE      ' '
     c                   goto      NextDup
     c                   end
      * Include / Omit basert på GEB-kode
     C                   SETOFF                                       3033
     C     WSGEIO        IFNE      ' '
     C     WSGEIO        IFEQ      'I'
      * Ved include må begrepet finnes i -arrayet (->33 on)
     C     FAVK          LOOKUP    GE                                     33
     C  N33              SETON                                        30
     C                   ELSE
      * Ved omit må begrepet IKKE finnes i -arrayet (->33 off)
     C     FAVK          LOOKUP    GE                                     33
     C   33              SETON                                        30
     C                   END
     C                   END
      *
      * Include / Omit basert på STAT-GRUPPE-KODE
      * Dersom linjen IKKE har gruppe (ufakt...) hent grp.via geb-kode
      * Det er her snakk om kostnad
     C                   MOVE      FAVK          KGEKOD
     C     KODGEK        CHAIN     KODTGE                             33
     C                   MOVEL     KGEKI         FAGGRP
      *
     C     *IN30         IFEQ      *OFF
     C     FAGGRP        ANDNE     *BLANKS
      *
     C                   SETOFF                                       33
     C                   MOVEL     FAGGRP        TSTGRP            1
     C     WSSTIO        IFNE      ' '
     C     WSSTIO        IFEQ      'I'
      * Ved include må begrepet finnes i -arrayet (->33 on)
     C     TSTGRP        LOOKUP    SG                                     33
     C  N33              SETON                                        30
     C                   ELSE
      * Ved omit må begrepet IKKE finnes i -arrayet (->33 off)
     C     TSTGRP        LOOKUP    SG                                     33
     C   33              SETON                                        30
     C                   END
     C                   END
     C                   END
      * Ikke eliminerte (ved I/O),ikke slettede..
     C     *IN30         IFNE      '1'
      * Her er det KUN ÅPNE I-linjer (positivt beløp på DUP) trekkes på
      * overordnet oppdrag (blir til negativt beløp på overordnet FAKT)
      * (og som nevnt over..  - siden det I kateg Internoverf. IKKE
      * finnes egen kolonne for INT.Forv.Kost plasseres det I-Kostn.)
     C                   SUB       FABELN        WKILIN
     C                   END
     c     NextDup       Tag
     C     DUPKEY        READE     FAKT                                   34
     C                   END
      *
     C                   ENDSR
      *
      *
     C***********************************************
     C     BUDTUR        BEGSR
     C***********************************************
      * stjernemerkede linjer FJERNET fysisk...
     C                   MOVE      ' '           WBP
     C                   MOVE      ' '           WBV
      * Hent inn forv. kostnader som er knyttet KUN til tur.
      *
     C                   MOVE      *ZEROS        TMPBUD           11 2
      *
      * Hent bud-poster KUN knyttet mot turnr..
      * (Budsj.poster knyttet til oppdrag OG tur ER alt hentet)
     C     KOSB2K        SETLL     KOSBU2
     C     KOSB2K        READE     KOSBU2                                 33
     C     *IN33         DOWEQ     '0'
     C     BUOPD         IFEQ      *ZEROS
      * Include / Omit basert på GEB-kode
     C                   SETOFF                                       3033
     C     WSGEIO        IFNE      ' '
     C     WSGEIO        IFEQ      'I'
      * Ved include må begrepet finnes i -arrayet (->33 on)
     C     BUVK          LOOKUP    GE                                     33
     C  N33              SETON                                        30
     C                   ELSE
      * Ved omit må begrepet IKKE finnes i -arrayet (->33 off)
     C     BUVK          LOOKUP    GE                                     33
     C   33              SETON                                        30
     C                   END
     C                   END
      * Include / Omit basert på STAT-GRUPPE-KODE
      *                hent grp.via geb-kode
     C                   MOVE      *BLANKS       FAGGRP
     C                   MOVE      BUVK          KGEKOD
     C     KODGEK        CHAIN     KODTGE                             33
     C                   MOVEL     KGEIE         FAGGRP
     C*
     C     *IN30         IFEQ      *OFF
     C     FAGGRP        ANDNE     *BLANKS
      *
     C                   SETOFF                                       33
     C                   MOVEL     FAGGRP        TSTGRP            1
     C     WSSTIO        IFNE      ' '
     C     WSSTIO        IFEQ      'I'
      * Ved include må begrepet finnes i -arrayet (->33 on)
     C     TSTGRP        LOOKUP    SG                                     33
     C  N33              SETON                                        30
     C                   ELSE
      * Ved omit må begrepet IKKE finnes i -arrayet (->33 off)
     C     TSTGRP        LOOKUP    SG                                     33
     C   33              SETON                                        30
     C                   END
     C                   END
     C                   END
      * IKKE HVIS ELIMINERT...
     C     *IN30         IFNE      '1'
     C* Turkostnad (for en som sender regning) hverken avtalt/estimert
     C* Simuler avregning-legg inn med avt/est.kode="P"(provisj.basert)
     C     BUBL          IFEQ      *ZEROS
     C     BUFER         ANDEQ     'T'
     C     BUTAVD        ANDNE     *ZEROS
     C     BUTUNR        ANDNE     *ZEROS
     C                   MOVE      BUTAVD        XXAVD             4 0
     C                   MOVE      BUTUNR        XXTUNR            8 0
     C                   MOVE      'N'           XXVIS             1
     C                   CALL      'SYTR12A'
     C                   PARM                    XXAVD
     C                   PARM                    XXTUNR
     C                   PARM                    XXVIS
     C                   PARM                    N4                4 0
S01  C*                  PARM                    N5                5 0
N01  C                   PARM                    N7                7 0
     C                   PARM                    N8                8 0
     C* CHAIN FOR Å HENTE TALL FRA AVREGNING
     C     TRAH1K        CHAIN     TRAVH1                             33
     C*          BUBNR     CHAINKOSBU                33
      * HVIS DEN ER!! AVREGNET KAN DEN IKKE OGSÅ VÆRE FORVENTET KOST!
     C  N33THST          IFEQ      'O'
     C                   MOVE      *ZEROS        THTOT
     C                   END
     C  N33              MOVE      FICURR        BUVAL
     C  N33              Z-ADD     THTOT         BUBL
     C  N33THTOT         IFNE      *ZEROS
     C                   MOVE      'P'           WBP
     C                   MOVE      *ON           *IN51
     C                   END
     C                   END
     C                   Z-SUB     BUBL          TMPBL            13 2
     C* Omregn valuta
     C     BUVAL         IFNE      FICURR
     C     VALU1K        CHAIN     VALUL01                            33
     C  N33VALKU1        DIV       OMRFAK        XFAK              9 6
     C  N33              MULT(H)   XFAK          TMPBL
     C                   END
     C                   ADD       TMPBL         TMPBUD
     C                   END
     C                   END
     C     KOSB2K        READE     KOSBU2                                 33
     C                   END
      *
      * UFERDIG-AVREGNING... (TRANSP-KODE 0) OGSÅ UT SOM BUDSJ.KOSTN.
     C     WSAVRS        IFEQ      'J'
     C     WTUR          CHAIN     TURER14                            33
     C     *IN33         IFEQ      '0'
     C     TUAVRE        ANDEQ     ' '
     C     TRAKEY        CHAIN     TRAN                               33
     C     *IN33         IFEQ      '0'
     C     VMINCR        ANDEQ     0
     C                   MOVE      TUAVD         BUTAVD
     C                   MOVE      TUPRO         BUTUNR
     C                   MOVE      TUAVD         XXAVD             4 0
     C                   MOVE      TUPRO         XXTUNR            8 0
     C                   MOVE      'N'           XXVIS             1
     C                   CALL      'SYTR12A'
     C                   PARM                    XXAVD
     C                   PARM                    XXTUNR
     C                   PARM                    XXVIS
     C                   PARM                    N4                4 0
S01  C*                  PARM                    N5                5 0
N01  C                   PARM                    N7                7 0
     C                   PARM                    N8                8 0
     C* CHAIN FOR Å HENTE TALL FRA AVR. (KOSTN. LIGGER MED POS.FORTEGN)
     C     TRAH1K        CHAIN     TRAVH1                             33
      * EKSTRA SJEKK MOT STATUS (BØR VÆRE UNØDVENDIG)
     C  N33THST          IFEQ      'O'
     C                   MOVE      *ZEROS        THTOT
     C                   END
     C  N33              SUB       THTOT         TMPBUD                           SNU
     C                   END
     C                   END
     C                   END
      *
      * LEGG TURENS VEKT(FVEKT)/beløp TOTALT UT I FIL SYKS30X
     C                   CALL      'SYKS30B'
     C                   PARM                    WTUR
     C                   PARM                    TMPBUD
     C                   PARM                    WBP
      *
     C                   ENDSR
      *
      *
     C***********************************************
     C     SKROPD        BEGSR
     C***********************************************
      * Flyttet til SKR..-rutiner for å kunne fange indikator fra LES..
      *
     C* SKRIV 1.PAGE FOR Å VISE PARAMETRE VED KJØRINGEN
N03  C     FIL           IFNE      'F'
N05  C     FIL           ANDNE     'E'
     C                   WRITE     HEAD1P
N03  C                   end
     C* TVING SIDEBRUDD FØR 1. POST
     C                   MOVE      *ON           *IN88
      *
     C     *LOVAL        SETLL     SYKS30W
     C                   READ      SYKS30W                                34
     C     *IN34         DOWEQ     '0'
     C                   EXSR      TSTRES
     C     SKIPP         IFEQ      'J'
     C                   DELETE    SYKS30WR
     C                   ELSE
     C                   UPDATE    SYKS30WR
      *
     C     WSBAVD        IFEQ      'J'
     C     WSBAVD        OREQ      'B'
     C     WAVD          IFNE      GMAVD
     C     GMAVD         ANDNE     *ZEROS
     C                   EXSR      BRUDD
     C                   END
     C                   END
     C                   MOVE      WAVD          GMAVD             4 0
      *
     C     *IN88         IFEQ      *ON
N03  C     FIL           IFNE      'F'
N05  C     FIL           ANDNE     'E'
     C                   WRITE     HEAD0D
N03  C                   end
     C                   MOVE      *OFF          *IN88
     C                   END
      *
     C                   EXSR      DETADD
     C     WSBAVD        IFNE      'B'
N03  C     FIL           IFNE      'F'
N05  C     FIL           ANDNE     'E'
     C                   WRITE     DETO
N03  C                   end
     C                   END
     C                   END
     C                   READ      SYKS30W                                34
     C                   END
      *
     C                   ENDSR
      *
      *
     C***********************************************
     C     SKRTUR        BEGSR
     C***********************************************
      * Flyttet til SKR..-rutiner for å kunne fange indikator fra LES..
      *
     C* SKRIV 1.PAGE FOR Å VISE PARAMETRE VED KJØRINGEN
N03  C     FIL           IFNE      'F'
N05  C     FIL           ANDNE     'E'
     C                   WRITE     HEAD1P
N03  C                   end
     C* TVING SIDEBRUDD FØR 1. POST
     C                   MOVE      *ON           *IN88
      *
      *
     C     *LOVAL        SETLL     SYKS30W1
     C                   READ      SYKS30W1                               34
     C     *IN34         DOWEQ     '0'
     C                   EXSR      TSTRES
     C     SKIPP         IFEQ      'J'
     C                   DELETE    SYK30W1R
     C                   ELSE
      * Dersom "Andel av felles turkost" utgjør HELE,(+/- 1) blank kode
     C     WBTKOS        IFNE      *ZEROS
     C     WBV           ANDEQ     'V'
     C     WTUR          CHAIN     SYKS30X                            33
     C     *IN30         IFEQ      '0'
     C     WBTKOS        SUB       XBEL          TMPBL
     C     TMPBL         IFLT      0
     C                   MULT      -1            TMPBL
     C                   END
     C     TMPBL         IFLE      1
     C                   MOVE      ' '           WBV
     C                   END
     C                   END
     C                   END
     C                   UPDATE    SYK30W1R
      *
     C     WSBAVD        IFEQ      'J'
     C     WSBAVD        OREQ      'B'
     C     WAVD          IFNE      GMAVD
     C     GMAVD         ANDNE     *ZEROS
     C                   EXSR      BRUDD
     C                   END
     C                   END
     C                   MOVE      WAVD          GMAVD             4 0
      *
     C     *IN88         IFEQ      *ON
N03  C     FIL           IFNE      'F'
N05  C     FIL           ANDNE     'E'
     C                   WRITE     HEAD0D
N03  C                   end
     C                   MOVE      *OFF          *IN88
     C                   END
      *
     C                   EXSR      DETADD
     C     WSBAVD        IFNE      'B'
N03  C     FIL           IFNE      'F'
N05  C     FIL           ANDNE     'E'
     C                   WRITE     DETO
N03  C                   end
     C                   END
     C                   END
     C                   READ      SYKS30W1                               34
     C                   END
      *
     C                   ENDSR
      *
      *
     C***********************************************
     C     SKRSIG        BEGSR
     C***********************************************
     C* SKRIV 1.PAGE FOR Å VISE PARAMETRE VED KJØRINGEN
N03  C     FIL           IFNE      'F'
N05  C     FIL           ANDNE     'E'
     C                   WRITE     HEAD1P
N03  C                   end
     C* TVING SIDEBRUDD FØR 1. POST
     C                   MOVE      *ON           *IN88
      *
      *
     C     *LOVAL        SETLL     SYKS30W9
     C                   READ      SYKS30W9                               34
     C     *IN34         DOWEQ     '0'
     C                   EXSR      TSTRES
     C     SKIPP         IFEQ      'J'
     C                   DELETE    SYK30W9R
     C                   ELSE
      * Dersom "Andel av felles turkost" utgjør HELE,(+/- 1) blank kode
     C     WBTKOS        IFNE      *ZEROS
     C     WBV           ANDEQ     'V'
     C     WTUR          CHAIN     SYKS30X                            33
     C     *IN30         IFEQ      '0'
     C     WBTKOS        SUB       XBEL          TMPBL
     C     TMPBL         IFLT      0
     C                   MULT      -1            TMPBL
     C                   END
     C     TMPBL         IFLE      1
     C                   MOVE      ' '           WBV
     C                   END
     C                   END
     C                   END
     C                   UPDATE    SYK30W9R
      *
      * BRUDD PÅ AVD. INNEN SIGNATUR..
     C     WSBAVD        IFEQ      'J'
     C     WSBAVD        OREQ      'B'
     C     WAVD          IFNE      GMAVD
     C     WSG           ORNE      GMSG
     C     GMAVD         IFNE      *ZEROS
     C                   EXSR      BRUDD
     C                   END
     C                   END
     C                   END
      * BRUDD PÅ MEGLER/SIGNATUR..
     C     WSG           IFNE      GMSG
     C     GMSG          ANDNE     *BLANKS
     C                   EXSR      BRUDDM
     C                   END
      *
     C                   MOVE      WAVD          GMAVD             4 0
     C                   MOVE      WSG           GMSG              3
      *
     C     *IN88         IFEQ      *ON
N03  C     FIL           IFNE      'F'
N05  C     FIL           ANDNE     'E'
     C                   WRITE     HEAD0D
N03  C                   end
     C                   MOVE      *OFF          *IN88
     C                   END
      *
     C                   EXSR      DETADD
     C     WSBAVD        IFNE      'B'
N03  C     FIL           IFNE      'F'
N05  C     FIL           ANDNE     'E'
     C                   WRITE     DETO
N03  C                   end
     C                   END
     C*
     C                   END
     C                   READ      SYKS30W9                               34
     C                   END
      *
     C                   ENDSR
     C***********************************************
     C     BEREGNDB      BEGSR
     C***********************************************
      *
     C     *LOVAL        SETLL     SYKS30W
     C                   READ      SYKS30W                                34
     C     *IN34         DOWEQ     '0'
      * Kalkuler omsetn/res./DB1
      * Omsetning
     C     WFALI         ADD       WUFLI         WOMS
     C                   ADD       WIILIN        WOMS
      * Kostnad
     C     WFKOS         ADD       WBKOS         WKOS
     C                   ADD       WBTKOS        WKOS
     C                   ADD       WAVRS         WKOS
     C                   ADD       WKILIN        WKOS
      * Resultat
     C     WOMS          ADD       WKOS          WRES
      * DB1 I %
     C     WOMS          IFEQ      *ZEROS
     C     WRES          IFLT      *ZEROS
     C                   Z-SUB     999.99        WDB1
     C                   ELSE
     C                   MOVE      *ZEROS        WDB1
     C                   END
     C                   ELSE
     C     WRES          DIV(H)    WOMS          DBTMP             7 4
     C     DBTMP         MULT      100           WDB1
     C                   END
     C                   UPDATE    SYKS30WR
     C                   READ      SYKS30W                                34
     C                   END
     C                   ENDSR
      *
     C***********************************************
     C     TSTRES        BEGSR
     C***********************************************
      *
      * Tester mot res/db1
     C                   MOVE      'N'           SKIPP             1            SLUTT-INDIK
      * Større enn linje utfylt....
     C                   MOVE      'N'           SKIPPS            1            ST.ENN-MISS
     C     WSREGT        IFNE      *ZEROS
     C     WRES          ANDLE     WSREGT
     C                   MOVE      'J'           SKIPPS
     C                   END
     C     SKIPPS        IFEQ      'N'
     C     WSDBGT        ANDNE     *ZEROS
     C     WDB1          ANDLE     WSDBGT
     C                   MOVE      'J'           SKIPPS
     C                   END
      * Mindre enn linje utfylt....
     C                   MOVE      'N'           SKIPPM            1            MIN.ENN-MISS
     C     WSRELT        IFNE      *ZEROS
     C     WRES          ANDGT     WSRELT
     C                   MOVE      'J'           SKIPPM
     C                   END
     C     SKIPPM        IFEQ      'N'
     C     WSDBLT        ANDNE     *ZEROS
     C     WDB1          ANDGT     WSDBLT
     C                   MOVE      'J'           SKIPPM
     C                   END
      * AND-betingelse Begge MÅ være UTFYLT OG tilfredsstilt
     C     WSORAN        IFEQ      'A'
     C     SKIPPS        IFEQ      'J'
     C     SKIPPM        OREQ      'J'
     C                   MOVE      'J'           SKIPP
     C                   GOTO      UTTST
     C                   END
     C                   END
      * OR -betingelse HVIS UTFYLT MÅ EN SIDE MATCHE
     C     WSORAN        IFEQ      'O'
     C     WSREGT        IFNE      *ZEROS
     C     WSDBGT        ORNE      *ZEROS
     C     WSRELT        ORNE      *ZEROS
     C     WSDBLT        ORNE      *ZEROS
      * noe er utfylt., side med blank betyr ikke tilfredsstilt...
     C     WSREGT        IFEQ      *ZEROS
     C     WSDBGT        ANDEQ     *ZEROS
     C                   MOVE      'J'           SKIPPS
     C                   END
     C     WSRELT        IFEQ      *ZEROS
     C     WSDBLT        ANDEQ     *ZEROS
     C                   MOVE      'J'           SKIPPM
     C                   END
      * hvis INGEN sider tilftedsstilt - skipp
     C     SKIPPS        IFEQ      'J'
     C     SKIPPM        ANDEQ     'J'
     C                   MOVE      'J'           SKIPP
     C                   GOTO      UTTST
     C                   END
      *
     C                   END
     C                   END
      * ADDERING TIL TOTALER ER FLYTTET TIL SR DETADD UTEN MERKING
      *
     C     UTTST         ENDSR
      *
     C***********************************************
     C     DETADD        BEGSR
     C***********************************************
      *
      * ADDER TIL TOTALER (TANT=ANT POSTER (OPPDRAG, EL TUR-POSTER)
     C                   ADD       1             TANT              5 0
     C                   ADD       WTANT         TTANT             7 0           OPD PÅ TUR
     C                   ADD       WFALI         TFALI
     C                   ADD       WUFLI         TUFLI
     C                   ADD       WIILIN        TIILIN
     C                   ADD       WOMS          TOMS
     C                   ADD       WFKOS         TFKOS
     C                   ADD       WBKOS         TBKOS
     C                   ADD       WBTKOS        TBTKOS
     C                   ADD       WKILIN        TKILIN
     C                   ADD       WKOS          TKOS
     C                   ADD       WRES          TRES
      * ADDER TIL BRUDD-TOTALER DERSOM DET SKAL SKRIVES
     C     WSBAVD        IFEQ      'J'
     C     WSBAVD        OREQ      'B'
     C                   ADD       1             AANT              5 0
     C                   ADD       WTANT         ATANT             7 0           OPD PÅ TUR
     C                   ADD       WFALI         AFALI
     C                   ADD       WUFLI         AUFLI
     C                   ADD       WIILIN        AIILIN
     C                   ADD       WOMS          AOMS
     C                   ADD       WFKOS         AFKOS
     C                   ADD       WBKOS         ABKOS
     C                   ADD       WBTKOS        ABTKOS
     C                   ADD       WKILIN        AKILIN
     C                   ADD       WKOS          AKOS
     C                   ADD       WRES          ARES
     C                   END
      * HVIS KJØRING PÅ MEGLER (TURER PR MEGLER) ANDRE BRUDDTOTALER
     C     *IN55         IFEQ      '1'
     C                   ADD       1             MANT              5 0
     C                   ADD       WTANT         MTANT             7 0           OPD PÅ TUR
     C                   ADD       WFALI         MFALI
     C                   ADD       WUFLI         MUFLI
     C                   ADD       WIILIN        MIILIN
     C                   ADD       WOMS          MOMS
     C                   ADD       WFKOS         MFKOS
     C                   ADD       WBKOS         MBKOS
     C                   ADD       WBTKOS        MBTKOS
     C                   ADD       WKILIN        MKILIN
     C                   ADD       WKOS          MKOS
     C                   ADD       WRES          MRES
     C                   END
     C                   ENDSR
      *
     C***********************************************
     C     BRUDD         BEGSR
     C***********************************************
      *
     C                   MOVE      GMAVD         ZAVD
     C     *IN50         IFEQ      *ON
     C                   Z-ADD     AANT          ZOPD
     C                   MOVE      *ZEROS        ZTANT
     C                   ELSE
     C                   Z-ADD     AANT          ZANT
     C                   Z-ADD     ATANT         ZTANT
     C                   END
     C                   Z-ADD     AFALI         ZFALI
     C                   Z-ADD     AUFLI         ZUFLI
     C                   Z-ADD     AIILIN        ZIILIN
     C                   Z-ADD     AOMS          ZOMS
     C                   Z-ADD     AFKOS         ZFKOS
     C                   Z-ADD     ABKOS         ZBKOS
     C                   Z-ADD     ABTKOS        ZBTKOS
     C                   Z-ADD     AKILIN        ZKILIN
     C                   Z-ADD     AKOS          ZKOS
     C                   Z-ADD     ARES          ZRES
      * DB1 I %
     C     ZOMS          IFEQ      *ZEROS
     C     ZRES          IFLT      *ZEROS
     C                   Z-SUB     999.99        ZDB1
     C                   ELSE
     C                   MOVE      *ZEROS        ZDB1
     C                   END
     C                   ELSE
     C     ZRES          DIV(H)    ZOMS          DBTMP             7 4
     C     DBTMP         MULT      100           ZDB1
     C                   END
      *
      * SKRIV
     C     *IN88         IFEQ      *ON
N03  C     FIL           IFNE      'F'
N05  C     FIL           ANDNE     'E'
     C                   WRITE     HEAD0D
N03  C                   end
     C                   MOVE      *OFF          *IN88
     C                   END
      * NÅR KUN BRUDDSUMMER: IKKE SKRIV STREK/IKKE IND. FOR SIDESKIFT
     C     WSBAVD        IFNE      'B'
N03  C     FIL           IFNE      'F'
N05  C     FIL           ANDNE     'E'
     C                   WRITE     DETB                                          BUNNSTREK
N03  C                   end
     C                   END
N03  C     FIL           IFNE      'F'
N05  C     FIL           ANDNE     'E'
     C                   WRITE     TOT
N03  C                   end
     C     WSBAVD        IFNE      'B'
N03  C     FIL           IFNE      'F'
N05  C     FIL           ANDNE     'E'
     C                   WRITE     DETB                                          BUNNSTREK
N03  C                   end
      * TRIGGER SIDESKIFT FØR NESTE AVD
      * MEN SIDESKIFT PR AVD. NÅR MEGLERRAPPORT.
     C     *IN55         IFEQ      *OFF
     C                   MOVE      *ON           *IN88
     C                   END
     C                   END
      *
      * INITIER BRUDD-VARABLE..
     C                   CLEAR                   AANT
     C                   CLEAR                   ATANT
     C                   CLEAR                   AFALI
     C                   CLEAR                   AUFLI
     C                   CLEAR                   AIILIN
     C                   CLEAR                   AOMS
     C                   CLEAR                   AFKOS
     C                   CLEAR                   ABKOS
     C                   CLEAR                   ABTKOS
     C                   CLEAR                   AKILIN
     C                   CLEAR                   AKOS
     C                   CLEAR                   ARES
      *
     C                   ENDSR
      *
      *
     C***********************************************
     C     BRUDDM        BEGSR
     C***********************************************
      * BRUDD PÅ MEGLER (SIGNATUR)
     C                   MOVE      *ZEROS        ZAVD
     C                   Z-ADD     MANT          ZANT
     C                   Z-ADD     MTANT         ZTANT
     C                   Z-ADD     MFALI         ZFALI
     C                   Z-ADD     MUFLI         ZUFLI
     C                   Z-ADD     MIILIN        ZIILIN
     C                   Z-ADD     MOMS          ZOMS
     C                   Z-ADD     MFKOS         ZFKOS
     C                   Z-ADD     MBKOS         ZBKOS
     C                   Z-ADD     MBTKOS        ZBTKOS
     C                   Z-ADD     MKILIN        ZKILIN
     C                   Z-ADD     MKOS          ZKOS
     C                   Z-ADD     MRES          ZRES
      * DB1 I %
     C     ZOMS          IFEQ      *ZEROS
     C     ZRES          IFLT      *ZEROS
     C                   Z-SUB     999.99        ZDB1
     C                   ELSE
     C                   MOVE      *ZEROS        ZDB1
     C                   END
     C                   ELSE
     C     ZRES          DIV(H)    ZOMS          DBTMP             7 4
     C     DBTMP         MULT      100           ZDB1
     C                   END
      *
      * SKRIV
     C     *IN88         IFEQ      *ON
N03  C     FIL           IFNE      'F'
N05  C     FIL           ANDNE     'E'
     C                   WRITE     HEAD0D
N03  C                   end
     C                   MOVE      *OFF          *IN88
     C                   END
      * DETB=STREK
N03  C     FIL           IFNE      'F'
N05  C     FIL           ANDNE     'E'
     C                   WRITE     DETB                                          BUNNSTREK
     C                   WRITE     TOT
     C                   WRITE     DETB                                          BUNNSTREK
N03  C                   end
      *
      * TRIGGER SIDESKIFT FØR NESTE MEGLER/SIGNATUR
     C                   MOVE      *ON           *IN88
      * INITIER BRUDD-VARABLE..
     C                   CLEAR                   MANT
     C                   CLEAR                   MTANT
     C                   CLEAR                   MFALI
     C                   CLEAR                   MUFLI
     C                   CLEAR                   MIILIN
     C                   CLEAR                   MOMS
     C                   CLEAR                   MFKOS
     C                   CLEAR                   MBKOS
     C                   CLEAR                   MBTKOS
     C                   CLEAR                   MKILIN
     C                   CLEAR                   MKOS
     C                   CLEAR                   MRES
      *
     C                   ENDSR
      *
      *
     C***********************************************
     C     TOTAL         BEGSR
     C***********************************************
      * STORE ENDR. PGA EGET FORMAT (TOT I STEDET FOR DETO)
      * INGEN MERKING
     C                   CLEAR                   GMSG
     C                   CLEAR                   ZAVD
     C     *IN50         IFEQ      *ON
     C                   Z-ADD     TANT          ZOPD
     C                   MOVE      *ZEROS        ZTANT
     C                   ELSE
     C                   Z-ADD     TANT          ZANT
     C                   Z-ADD     TTANT         ZTANT
     C                   END
     C                   Z-ADD     TFALI         ZFALI
     C                   Z-ADD     TUFLI         ZUFLI
     C                   Z-ADD     TIILIN        ZIILIN
     C                   Z-ADD     TOMS          ZOMS
     C                   Z-ADD     TFKOS         ZFKOS
     C                   Z-ADD     TBKOS         ZBKOS
     C                   Z-ADD     TBTKOS        ZBTKOS
     C                   Z-ADD     TKILIN        ZKILIN
     C                   Z-ADD     TKOS          ZKOS
     C                   Z-ADD     TRES          ZRES
      * DB1 I %
     C     ZOMS          IFEQ      *ZEROS
     C     ZRES          IFLT      *ZEROS
     C                   Z-SUB     999.99        ZDB1
     C                   ELSE
     C                   MOVE      *ZEROS        ZDB1
     C                   END
     C                   ELSE
     C     ZRES          DIV(H)    ZOMS          DBTMP             7 4
     C     DBTMP         MULT      100           ZDB1
     C                   END
      *
      * SKRIV
      *
     C     *IN88         IFEQ      *ON
N03  C     FIL           IFNE      'F'
N05  C     FIL           ANDNE     'E'
     C                   WRITE     HEAD0D
N03  C                   end
     C                   MOVE      *OFF          *IN88
     C                   END
      * NÅR BRUDD PR AVD / MED DETALJER KOMMER TOTALER PÅ EGEN SIDE
     C     WSBAVD        IFEQ      'J'
     C     WSBAVD        OREQ      'B'
     C     WSBAVD        IFEQ      'B'
     C                   SETON                                        52         *TOT*
     C                   ELSE
N03  C     FIL           IFNE      'F'
N05  C     FIL           ANDNE     'E'
     C                   WRITE     TOT0                                          LENGRE
N03  C                   end
     C                   SETOFF                                       52          TEKST...
     C                   END
     C                   END
N03  C     FIL           IFNE      'F'
N05  C     FIL           ANDNE     'E'
     C                   WRITE     DETB                                          BUNNSTREK
     C                   WRITE     TOT
     C                   WRITE     DETB                                          BUNNSTREK
N03  C                   end
      *
     C                   ENDSR
      *
      *
     C***********************************************
     C     INIT          BEGSR
     C***********************************************
      *
     C     *ENTRY        PLIST
     C                   PARM                    UUPARM          256
     C     FIL           PARM      FIL           FIL               1
     C     LASER         PARM      LASER         LASER             1
     C     STRING        PARM      STRING        STRING            5
     C     COPYA         PARM      COPYA         COPYA             2
     C                   MOVE      COPYA         COPY              2 0
     C     FIL           IFNE      'F'
N05  C     FIL           ANDNE     'E'
     C     STRING        IFNE      *BLANKS
     C     STRING        CHAIN     KODTFM                             33
     C                   END
     C     LASER         IFEQ      'A'
     C                   SETON                                        89
     C                   END
     C                   END
      *
     C                   MOVE      UUPARM        PARMDS
      * MEGLER/SIGN (55 on) HÅNDTERES STORT SETT  SOM TUR
     C     WSOPTU        COMP      'M'                                    55
      * MEGLER/SIGN pr Hentekunde (56 on) HÅNDTERES STORT SETT  SOM TUR
     C     WSOPTU        COMP      'H'                                    56
      * For printerfil.. . *IN50 ON = Oppdrag  /  *IN50 OFF = Tur
     C     WSOPTU        COMP      'O'                                    50
     C  N50WSOPTU        COMP      'F'                                    50
      * For printerfil.. . *IN51 ON = Skriv "Å/P-tekst" på side 1
     C                   SETOFF                                       51
      *
     C                   MOVEL     WSPERF        FRADAT            8 0
     C                   MOVEL     WSPERT        TILDAT            8 0
     C                   MOVE      31            TILDAT
     C     WSPEFD        IFNE      *ZEROS
     C                   MOVE      WSPEFD        FRADAT
     C                   SETON                                        54         SKRIV FULL
     C                   END                                                     DATO
     C     WSPETD        IFNE      *ZEROS
     C                   MOVE      WSPETD        TILDAT
     C                   SETON                                        54
     C                   END
      * Hent rapportnavn
     C     WSRNAV        CHAIN     SYKS30S
      *
     C                   MOVEL     WSHF          WSHHF             2 0
     C                   MOVEL     WSÅF          WSÅÅF             2 0
     C                   MOVEL     WSMF          WSMMF             2 0
      * Definer hjelpevariable for totaler
     C     *LIKE         DEFINE    WFALI         TFALI
     C     *LIKE         DEFINE    WUFLI         TUFLI
     C     *LIKE         DEFINE    WIILIN        TIILIN
     C     *LIKE         DEFINE    WOMS          TOMS
     C     *LIKE         DEFINE    WFKOS         TFKOS
     C     *LIKE         DEFINE    WBKOS         TBKOS
     C     *LIKE         DEFINE    WBTKOS        TBTKOS
     C     *LIKE         DEFINE    WKILIN        TKILIN
     C     *LIKE         DEFINE    WKOS          TKOS
     C     *LIKE         DEFINE    WRES          TRES
      * Definer hjelpevariable for AVDELINGSBRUDD-totaler
     C     *LIKE         DEFINE    WFALI         AFALI
     C     *LIKE         DEFINE    WUFLI         AUFLI
     C     *LIKE         DEFINE    WIILIN        AIILIN
     C     *LIKE         DEFINE    WOMS          AOMS
     C     *LIKE         DEFINE    WFKOS         AFKOS
     C     *LIKE         DEFINE    WBKOS         ABKOS
     C     *LIKE         DEFINE    WBTKOS        ABTKOS
     C     *LIKE         DEFINE    WKILIN        AKILIN
     C     *LIKE         DEFINE    WKOS          AKOS
     C     *LIKE         DEFINE    WRES          ARES
      * Definer hjelpevariable for SIGN-BRUDD-totaler
     C     *LIKE         DEFINE    WFALI         MFALI
     C     *LIKE         DEFINE    WUFLI         MUFLI
     C     *LIKE         DEFINE    WIILIN        MIILIN
     C     *LIKE         DEFINE    WOMS          MOMS
     C     *LIKE         DEFINE    WFKOS         MFKOS
     C     *LIKE         DEFINE    WBKOS         MBKOS
     C     *LIKE         DEFINE    WBTKOS        MBTKOS
     C     *LIKE         DEFINE    WKILIN        MKILIN
     C     *LIKE         DEFINE    WKOS          MKOS
     C     *LIKE         DEFINE    WRES          MRES
      *
     C     OPDKEY        KLIST
     C                   KFLD                    HEAVD
     C                   KFLD                    HEOPD
     C     DUPKEY        KLIST
     C                   KFLD                    DupAvd            4 0
     C                   KFLD                    DupOpd            7 0
      *
     C     KOSB9K        KLIST
     C                   KFLD                    BUST
     C                   KFLD                    HEAVD
     C                   KFLD                    HEOPD
      *
     C     KOSB2K        KLIST
     C                   KFLD                    BUST
     C                   KFLD                    WTUR
      *
     C     TRAH1K        KLIST
     C                   KFLD                    BUTAVD
     C                   KFLD                    BUTUNR
      *
      *
     C     VALU1K        KLIST
     C                   KFLD                    FIFIRM
     C                   KFLD                    BUVAL
      *
     C     KODGEK        KLIST
     C                   KFLD                    KGEUNI
     C                   KFLD                    KGEKOD
     C                   MOVE      'GE'          KGEUNI
      *
     C     WTKEY         KLIST
     C                   KFLD                    WAVD
     C                   KFLD                    WTUR
     C                   KFLD                    WTURHK
     C                   KFLD                    WTURHO
      *
     C     TURKEY        KLIST
     C                   KFLD                    WSHHF
     C                   KFLD                    WSÅÅF
     C                   KFLD                    WSMMF
     C     TRAKEY        KLIST
     C                   KFLD                    FIFIRM
     C                   KFLD                    TUKNT2
      *
     C                   MOVE      *BLANKS       FIFIRM
     C     FIFIRM        SETLL     FIRM
     C                   READ      FIRM                                   33
      *
      * Dersom Avd-grp- angitt, hent inn i array for å spare ressurser
     C                   CLEAR                   AG
     C     WSAVDG        IFNE      *BLANKS
     C                   MOVE      *ZEROS        NR                3 0
     C     WSAVDG        SETLL     AVDGR
     C     WSAVDG        READE     AVDGR                                  33
     C     *IN33         DOWEQ     '0'
     C                   ADD       1             NR
     C                   MOVE      AAVD          AG(NR)
     C     WSAVDG        READE     AVDGR                                  33
     C                   END
     C                   END
      *
     C                   ENDSR
      *
     C***********************************************
     C     ÅPKOST        BEGSR
     C***********************************************
      *
     C                   MOVE      *ZEROS        TMPBL
      * DETALJ-VERDIER FRA UFERDIGE KOSTNADSBILAG LEGGES OGSÅ I BUDSJ..
     C     OPDKEY        SETLL     KOSTB4
     C     OPDKEY        READE     KOSTB4                                 33
     C     *IN33         DOWEQ     '0'
      * Kun Åpne bilag (status ' ' 'A' 'B' 'G')
     C     KBBNR         CHAIN     KOSTA                              33
     C     *IN33         IFEQ      '0'
     C     KAST          IFEQ      ' '
     C     KAST          OREQ      'A'
     C     KAST          OREQ      'B'
     C     KAST          OREQ      'G'
      * Include / Omit basert på GEB-kode
     C                   SETOFF                                       3033
     C     WSGEIO        IFNE      ' '
     C     WSGEIO        IFEQ      'I'
      * Ved include må begrepet finnes i -arrayet (->33 on)
     C     KBVK          LOOKUP    GE                                     33
     C  N33              SETON                                        30
     C                   ELSE
      * Ved omit må begrepet IKKE finnes i -arrayet (->33 off)
     C     KBVK          LOOKUP    GE                                     33
     C   33              SETON                                        30
     C                   END
     C                   END
      *
      * Include / Omit basert på STAT-GRUPPE-KODE
      *                hent grp.via geb-kode
     C                   MOVE      *BLANKS       FAGGRP
     C                   MOVE      KBVK          KGEKOD
     C     KODGEK        CHAIN     KODTGE                             33
     C                   MOVEL     KGEIE         FAGGRP
      *
     C     *IN30         IFEQ      *OFF
     C     FAGGRP        ANDNE     *BLANKS
     C                   SETOFF                                       33
     C                   MOVEL     FAGGRP        TSTGRP            1
     C     WSSTIO        IFNE      ' '
     C     WSSTIO        IFEQ      'I'
      * Ved include må begrepet finnes i -arrayet (->33 on)
     C     TSTGRP        LOOKUP    SG                                     33
     C  N33              SETON                                        30
     C                   ELSE
      * Ved omit må begrepet IKKE finnes i -arrayet (->33 off)
     C     TSTGRP        LOOKUP    SG                                     33
     C   33              SETON                                        30
     C                   END
     C                   END
     C                   END
      * IKKE HVIS ELIMINERT...
     C     *IN30         IFNE      '1'
     C                   Z-SUB     KBBLHB        TMPBL            13 2
     C* Trekk ut evt moms.
     C     KBKDM         IFEQ      1
      *   finn rett sats utfra bilagsdato..
     C     FITAX         ADD       1             FITAXN            5 4
     C     FITAXD        IFNE      *ZEROS
     C     FITAX2        ANDNE     *ZEROS
     C     KABDT         ANDLT     FITAXD
     C     FITAX2        ADD       1             FITAXN
     C                   END
     C                   DIV(H)    FITAXN        TMPBL
     C                   END                                                    BKDM EQ 1
     C                   END                                                    *IN30 NE'1'
     C                   END                                                    KAST EQ ..
     C                   END                                                    *IN33 EQ'0'
      * Flere...
     C     OPDKEY        READE     KOSTB4                                 33
     C                   END                                                    *IN33 DOW.
      *
      *
     C     TMPBL         IFNE      *ZEROS
     C                   ADD       TMPBL         WBKOS
     C                   MOVE      'Å'           WBÅ
     C                   MOVE      *ON           *IN51
     C                   END
      *
     C                   ENDSR
      *
