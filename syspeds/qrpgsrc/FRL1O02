      *********************************************************************
      *  RPG ILE MODULE *LIBL/FRL1O02
      *
      *
      *  After compiling this RPG MODULE,
      *  create the related program with the following command:
      *
CRTPG+*  CRTPGM SYSPED/FRL1O02 MODULE(*LIBL/FRL1O02 *LIBL/INCGI)
CRTPGM*         ACTGRP(CGI) AUT(*USE)
      *
      *********************************************************************
      /copy syspeds/qrpgsrcpy,hspecs
    +H  debug(*yes)
      /copy syspeds/qrpgsrcpy,hspecsbnd
      * Bookshelves
      * Books
     FBRIDF     UF   e           K DISK    USROPN
     FLAGEL01   IF a e           K DISK    USROPN
     FSTRNL01   IF a e           K DISK    USROPN
     FKUNDL01   IF   e           K DISK    USROPN
     FVADRL01   IF   e           K DISK    USROPN
     FPRISLD2   IF   e           K DISK    USROPN
     FPRISLD1   IF   e           K DISK    USROPN
     F                                     RENAME(PRISLDR:PRISLDR1)
     FVAREL01   IF   e           K DISK    USROPN
     FWKOMML01  uf a e           K DISK    USROPN
     FWOTRAHF   Uf a e           K DISK    USROPN
     FWOTRALSY  UF a e           K DISK    USROPN
      *=====================================================================
      * Includes to be used in all CGIs
      *=====================================================================
      /copy syspeds/qrpgsrcpy,prototypeb
      /copy syspeds/qrpgsrcpy,usec
      /copy syspeds/qrpgsrcpy,variables3
      *--------------------------------------------------------------------
      *  Fields used for parsing the input string
     D IKKEOK          s              1a
     D WDESMAL         s              1a
     D DESMAL          s              1  0
     D action          s             10a
     D subaction       s             10a
     D lng             s              2a
      * User
     D WSUSER          s             10a
      * feilmelding
     D FEILTXT         S            150
      * Feilmeldingsnr
     D FMELDNR         s              2a
      * aktiv Ordre...
     D Ord             s              8a
     D OrdNr           s              8  0
      * Linje
     D lin1ot          s              5  0
     D lin             s              5a
      * Levdato     ..
     D LDATO           s              4a
      * Levdato     ..
     D LDATOH          s              4a
      * antall      ..
     D Ant             s             12a
     D Antnr           s             11  3
      * antall lager..
     D Antl            s              7a
     D Antlnr          s              7  0
      * aktiv pristab.nr
     D Prinr           s              5
     D Prinrn          s              5  0
     D Firma           s              2
      *
      * kundnummer
     D Kundnr          s              8  0
     D KUNDna          s              8a
      * aktiv prodgruppe
     D PRDGRP          s             35a
     D KODTXT          s             30a
     D WSANR           s             15a
     D ARTNR           s             15a
     D ARTTX1          s             35a
     D ARTTX2          s             35a
      * merknader
     D imerk1          S             60a
     D imerk2          S             60a
     D imerk3          S             60a
     D imerk4          S             60a
     D imerk5          S             60a
      * aktiv prodgruppe
     D WSMTxt          S            600
      * for bakgrunnsfarge
     D OddEven         s             10
      * merking
     D WSMERK          s             30a
      * kunref
     D ikunref         s             30a
      * merki
     D imerk0          s             30a
      * Vareadresse
     D IVADRNR         s              3a
     D VADRNRA         s              3a
     D VADRNR          s              3  0
     D VADRNA          s             30a
     D VADRN1          s             30a
     D VADRN2          s             30a
      * Vareadresse
     D INAVN           s             30a
     D IADR1           s             30a
     D IADR2           s             30a
     D IPOST           s              4a
     D IPSTE           s             24a
      *
      *Array for fri-tekster
     D TX              S             60    DIM(10)
     D OPPDBESK1       s            100a
     D LENKE           s            200a
      *
     D htmlsrclib      s             10a
     D htmlsrcfil      s             10a
     D htmlsrcmbr      s             10a
      * "InitSW"- is blank only the first time pgm is called
     DInitSW           S              1a
      *
     Dlinenbr          S              3s 0
     D                 DS
     D  BESTIL                 1     11  3
     D  BESTIL2                1     10  2
     D  BESTIL1                1      9  1
     D  BESTIL0                1      8  0
     D                 DS
     D  HOIREI                 1     15
     D  HOI                    1     15    DIM(15)
     D                 DS
     D  HOIREU                 1     15
     D  HOU                    1     15    DIM(15)
     D                 DS
     D  TXT60                  1     60
     D  T60                    1     60    DIM(60)
     D                 DS
     D  KVTXT                  1    600
     D  KVT                    1    600    DIM(600)
     D                 DS
     D  WTID                   1      6  0
     D  WDD                    7      8  0
     D  WMM                    9     10  0
     D  WAA                   11     14  0
     D  WAAU                  13     14  0
     D  DSTID                  1     14  0
     D                 DS
     D  LDATODS                1      6  0
     D  LDATOAA                1      4  0
     D  LDATOMM                5      6  0
     D                 DS
     D  WWDAT                  1      8  0
     D  WWDATA                 1      4  0
     D  WWDATM                 5      6  0
     D  WWDATD                 7      8  0
     D                 DS
     D  antnrd                 1     11  3
     D  desi3                  9     11  0
     D  desi2                 10     11  0
     D  desi1                 11     11  0
      * Parameterliste VR949
     D VR949DS         DS                  INZ
     D  P_FIRMA                1      2
     D  P_NRAAR                3      6  0
     D  P_NOKK1                7     10
     D  P_NOKK2               11     14
     D  P_BEHKD               15     15
     D  P_NULLS               16     16
     D  P_SBRNR               17     23  0
     D  P_RETKO               24     24
     D  P_STNUM               25     31  0
     D  P_SLNUM               32     38  0
      * Parameterliste til datoprogram VR014
     D VR014         E DS                  EXTNAME(VR014DS) INZ
      *
     D                 DS
     D  INVAAR                 1      4  0
     D  INVUKE                 5      6  0
     D  INVAAU                 1      6  0
     D FMELDING1       C                   CONST('Du må taste ønsket l-
     D                                     everingsår/uke.(ÅÅUU)')
     D FMELDING2       C                   CONST('Du må enten velge v-
     D                                     areadresse eller taste de-
     D                                     n manuelt selv')
     D FMELDING3       C                   CONST('År uke er ikke gyldi-
     D                                     g format. maksimalt ett å-
     D                                     r fram i tid')
     D FMELDING4       C                   CONST('Når navn skrives m-
     D                                     å også postnr og sted tastes')
     D FMELDING5       C                   CONST('År/uke kan ikke væ-
     D                                     re lavere enn inneværende uke')
     D FMELDING6       C                   CONST('Du må taste antall i di-
     D                                     n bestilling')
     D FMELDING7       C                   CONST('Ukenummer må være m-
     D                                     ellom 1 og 52')
     D FMELDING8       C                   CONST('Det er ikke tillat-
     D                                     t med så mange desimaler Max:')
      *=====================================================================
     C                   exsr      SetTimeStr
      *=====================================================================
      * Read remote browser input string and parse it
      *=====================================================================
      /copy syspeds/qrpgsrcpy,prolog3
     C                   exsr      Parse
     C                   if        Action ='BEKREFTH'
     C                   exsr      Parse2
     C                   END
      *
     c     wsuser        ifne      *blanks
     C                   EXSR      INIT
     c                   end
      *=====================================================================
      * Main line
      *=====================================================================
      * Ask the service program to load into core
      * the appropriate output skeleton html member
     C                   exsr      LoadHtml
      *------------------
      * Open database files
     C                   exsr      OpenDbf
      *------------------
      * Action requested (not used)
     C                   eval      action = uppify(action)
      * Bookshelf number and description
     C**
      * =================
      * Vis fra valgte varegruppe kommer fra valg i venstre marg
      * pålogging er utført
     C                   if        Action ='DISPLAY'
     C     wsuser        ifne      *blanks
     c     linkey2       chain     wotrahf                            33
     c     *in33         ifeq      '1'
     c                   eval      action='ORDREHODE'
     c                   else
      * status blank vis linjer
     c     status        ifeq      ' '
     C                   move      '10'          FMELDNR
     C                   exsr      Display
     C                   exsr      Exit
      * status ikke blank   ordre avsluttet
     c                   else
     C                   exsr      SetTop
     C                   callp     wrtsection('top')
      * Gjeldende ordre
     C                   callp     updHTMLvar('ORD':
     C                             %trim(%editc(Ordnot:'Z')))
     C                   callp     wrtsection('takk2')
     C                   callp     wrtsection('takk')
     C                   exsr      Exit
     C                   endif
     C                   endif
     C                   endif
     C                   endif
      * =================
      * ENDRE ORDRE
      * pålogging er utført
      * =================
     C                   if        Action ='ENDREORDRE'
     C     wsuser        ifne      *blanks
     C                   exsr      ENDRE
     C                   exsr      Exit
     C                   endif
     C                   endif
      *
      * =================
      * Sende ordrebestilling
      * sett ok status på ordre
      * =================
     C                   if        Action ='SENDBEST'
     C                   exsr      sendbest
     C                   exsr      Exit
     C                   endif
      * =================
      * Tømm  ordrebestilling
      * sett ok status på ordre
      * =================
     C                   if        Action ='TOMMBEST'
     C                   exsr      tommbest
     C                   exsr      Exit
     C                   endif
      *
      * Pålogging ikke utført
      *
     C                   if        Action ='ORDREHODE'
     C     wsuser        ifeq      *blanks
      * Start html
     C                   exsr      SetTop
     C                   callp     wrtsection('top')
     C                   eval      wrotetop = *on                               For pssr
     C                   callp     wrtsection('initcgi')
     C                   exsr      Exit
     C                   endif
     C                   endif
      *
      *call fra frl1o01
      * kun vise ordrehode hvis ikke finnes fra før
      *
     C                   if        Action ='ORDREHODE1'
     c     linkey2       chain     wotrahf                            33
     c     *in33         ifeq      '0'
     C                   exsr      SetTop
     C                   callp     wrtsection('top')
     C                   eval      wrotetop = *on                               For pssr
     C                   callp     wrtsection('initsok')
     C                   exsr      Exit
     c                   else
     c                   eval      Action ='ORDREHODE'
     C                   endif
     C                   endif
      * Bestill en vare
     C                   if        Action ='ORDER'
     C                   exsr      Order
     C                   exsr      Display
     C                   exsr      Exit
     C                   endif
      * Tilbaketast
     C                   if        Action ='TILBAKE'
     C                   exsr      Display
     C                   exsr      Exit
     C                   endif
      * forsøk på å bekrefte ordre
     C                   if        Action ='BEKREFTH'
     C                   exsr      bekrefth
     C                   exsr      Exit
     C                   endif
      * valg endre ordrehode
     C                   if        Action ='ORDREHODE'
     C                   exsr      ordrehode
     C                   exsr      Exit
     C                   endif
      * 2-Avslutt ordre etter at vareadresse er tastet manuelt eller valgt
      *********************************************************************
     C     Display       begsr
      *********************************************************************
      *=====================================================================
      * Vise ordre i produktgruppe fra prilslisten
      *=====================================================================
      * Start html
     C                   exsr      SetTop
     C                   callp     wrtsection('top')
     C                   eval      wrotetop = *on                               For pssr
     c     linkey2       chain     wotrahf                            33
     c   33              move      *blanks       ldato
     c  N33              move      levaar        levaar2
     c  N33              movel     levaar2       ldato
     c  N33              move      levmnd        ldato
     C  N33              MOVE      ldato         ldatoh            4
     C                   callp     updHTMLvar('LDATOH':LDATOH)
      *
      * nullstille ordreelinje
      *
      *
     c                   z-add     0             lin1ot
     C                   callp     updhtmlvar('LIN':
     C                             %trim(%editc(LIN1OT:'M')))
      *
      *
      *
      * ==========================================================
      * START DIREKTE PÅ VARENUMMER ETTER SØK
      * VERDI KOMMER FRA FRL1O01  (HTML)
      * ==========================================================
      *
      *
      *
     C     WSANR         IFNE      *BLANKS
     C     action        andne     'TILBAKE'
     C                   move      '10'          FMELDNR
     C                   callp     updHTMLvar('FMELDNR':FMELDNR)
     C                   eval      PRD_ANRS=WSANR
      *
      * finner vare i prisfilen
      *
     c     PrGrKeye      chain     prisld1                            33
     c     *in(33)       ifeq      '1'
     c                   move      WSANR         hoirei
     c                   exsr      hoiresr
     c                   move      hoireu        PRD_ANRS
     c     PrGrKeye      chain     prisld1                            33
     c                   end
     C     Lagekey       chain     VAREL01                            55
     C                   callp     wrtsection('leg2')
     C                   eval      linenbr = 1
     C                   exsr      SetLeg2Row
     C                   callp     wrtsection('leg2row')
     C                   callp     wrtsection('leg2row02tx')
     C                   callp     wrtsection('leg2row01')
     C                   callp     wrtsection('leg2rowb')
      *
      *
      * ==========================================================
      * Ellers leses på produktgruppe
      * ==========================================================
      *
      *
     C                   ELSE
      *
      * finner riktig returrecord for TILBAKETAST
      *
     C     action        ifeq      'TILBAKE'
     C                   eval      WSANR      = zhbgetvar('ARTNR     ')
     C                   eval      PRD_ANRS=WSANR
     c                   move      ARTNR         VARENR
     c     PrGrKeye      chain     prisld1                            33
     c     *in(33)       ifeq      '1'
     c                   move      WSANR         hoirei
     c                   exsr      hoiresr
     c                   move      hoireu        PRD_ANRS
     c     PrGrKeye      chain     prisld1                            33
     C                   eval      varenr=PRD_ANRS
     c                   end
     c                   end
      *
      * Start right leg  (header)
     c     prdgrp        ifeq      *blanks
     C                   callp     wrtsection('leg2b')
     c                   else
     C                   callp     wrtsection('leg2')
     C                   callp     wrtsection('leg2rowdisp0')
      * Fill right leg  (varer som kan legges i vogna)
     C                   eval      linenbr = 0
     C     PrGrKeyStr    setll     PRISLD2
      *
     C     PrGrKey       readE     PRISLD2
      *
      *
      * ==========================================================
      * produktgruppe løkke
      * ==========================================================
      *
      *
     C                   dow       not%eof
     C     Lagekey       chain     VAREL01                            55
     C                   eval      linenbr = linenbr +1
     C                   exsr      SetLeg2Row
     C                   callp     wrtsection('leg2row')
     C                   callp     wrtsection('leg2rowdisp')
     C                   callp     wrtsection('leg2row01')
     C                   callp     wrtsection('leg2rowb')
     C
     C     PrGrKey       readE     PRISLD2
     C                   enddo
     c                   end
     c                   end
      *
      * End right leg
     C                   callp     wrtsection('leg2end')
     C                   endsr
      *********************************************************************
     C     ENDRE         begsr
      *********************************************************************
      *=====================================================================
      * Endre ordre
      *=====================================================================
      * Start html
     C                   move      '10'          FMELDNR
     C                   exsr      SetTop
     C                   callp     updhtmlvar('LIN':
     C                             %trim(%editc(LIN1OT:'M')))
     C                   callp     wrtsection('top')
     C                   eval      wrotetop = *on                               For pssr
      * =================
      * Start right leg  (header)
     C                   callp     wrtsection('leg2')
      * Fill right leg  (varer som kan legges i vogna)
      *
      *
     c     orderfeil     ifne      'J'
     C                   eval      linenbr = 1
     C                   exsr      endreflytt
     c                   else
     C                   exsr      feilflytt
     c                   end
     C                   callp     wrtsection('leg2row')
     c     orderfeil     ifne      'J'
     C                   callp     wrtsection('leg2row02tx')
     C                   callp     wrtsection('leg2rowe')
     C                   callp     wrtsection('tilbake')
     c                   else
     C                   callp     wrtsection('leg2row02tx')
     C                   callp     wrtsection('leg2row01')
     C                   callp     wrtsection('leg2rowb')
     c                   end
      *
      * Diverse tester
      *
     c                   clear                   feiltxt
      * antall
     c     antnr         ifeq      0
     C                   movel     fmelding6     FEILTXT
     C                   move      '10'          FMELDNR
     C                   callp     updhtmlvar('FEILTXT':FEILTXT)
     C                   callp     wrtsection('leg2feil')
     C                   callp     wrtsection('tilbake')
     c                   goto      utf
     c                   end
      * antall desimaler
      *
     c     action        ifne      'ENDREORDRE'
     c                   exsr      testdesi
     c     feil          ifeq      'J'
     c                   move      '10'          FMELDNR
     C                   callp     updhtmlvar('FEILTXT':FEILTXT)
     C                   callp     wrtsection('leg2feil')
     C                   callp     wrtsection('tilbake')
     c                   goto      utf
     c                   end
     c                   end
      * aar uke
      *
     c                   exsr      testaaruke
     c     feil          ifeq      'J'
     C                   callp     updhtmlvar('FEILTXT':FEILTXT)
     C                   callp     wrtsection('leg2feil')
     C                   callp     wrtsection('tilbake')
     c                   end
     c     utf           tag
      * End right leg
     C                   callp     wrtsection('leg2end')
     C                   endsr
      *********************************************************************
     C     ordrehode     begsr
      *********************************************************************
      * hent eventuelle data fra wotrahf
     c     vadrnraa      ifne      '***'
     c     linkey2       chain(n)  wotrahf                            33
     c     *in33         ifeq      '0'
     c                   end
     c* Fast vareadresse ?
     c     *in33         ifeq      '1'
     c     vadrku        ifne      *zeros
     c     IVADRNRN      ifeq      *zeros
     c                   z-add     vadrku        vadrnr
     c                   z-add     vadrku        IVADRNRN
     c                   exsr      movehg
     c                   end
     c                   end
     c                   end
     c
     c     *in33         ifeq      '0'
     c     FEILTXT       andeq     *blanks
     c     IVADRNRN      ifne      *zeros
     c                   move      IVADRNRN      vadrnr
     c                   end
     c                   exsr      movehf
     c                   end
     c                   end
      * Start html
     C                   exsr      SetTop
     C                   callp     wrtsection('top')
     C                   eval      wrotetop = *on                               For pssr
      * =================
      * Start right leg  (header)
     C                   callp     updHTMLvar('VADRNRA':
     C                             %trim(%editc(VADRNR:'Z')))
     C                   callp     updHTMLvar('IVADRNR':
     C                             %trim(%editc(VADRNR:'Z')))
     C     VADRNR        IFEQ      0
     c                   eval      vadrna='Plukk fra adresselisten'
     C                   ELSE
     c                   eval      vadrna='= Valgt leveringsadresse'
     C                   END
     C                   callp     updhtmlvar('VADRNA':VADRNA)
     C                   callp     updhtmlvar('VADRN1':*blanks)
     C                   callp     updhtmlvar('VADRN2':*blanks)
     C     LDATO         ifeq      *zeros
     C     LDATO         oreq      *blanks
     C                   move      '02'          fmeldnr
     C                   eval      LDATO='    '
     c                   end
     C                   callp     updhtmlvar('LDATO':LDATO)
     C                   callp     updhtmlvar('IKUNREF':IKUNREF)
     C                   callp     updhtmlvar('IMERK0':IMERK0)
      * kundedata
     c                   exsr      htmlkundf
      *
     C                   callp     wrtsection('Avsleg2')
     C                   callp     wrtsection('TypSltStr')
     C                   callp     wrtsection('TypSltRow')
     c
      *
     C                   callp     updHTMLvar('VADRNRA':
     C                             %trim(%editc(VADRNR:'Z')))
     C                   callp     updHTMLvar('IVADRNR':'***')
     c                   eval      vadrna='Ikke leveringsadresse / manuell'
     C                   callp     updhtmlvar('VADRNA':VADRNA)
     C                   callp     updhtmlvar('VADRN1':*blanks)
     C                   callp     updhtmlvar('VADRN2':*blanks)
     C                   callp     wrtsection('TypSltRow')
      *
     c                   move      vadrnr        vadrnrfil         3 0
     C     Vadrkey       setll     VADRL01
     C     Vadrkey       reade     VADRL01                                40
     C     *in40         doweq     '0'
      * Vareadresse
     C                   callp     updHTMLvar('IVADRNR':
     C                             %trim(%editc(VADRNR:'Z')))
     C                   callp     updhtmlvar('VADRNA':VADRNA)
     C                   callp     updhtmlvar('VADRN1':VADRN1)
     C                   callp     updhtmlvar('VADRN2':VADRN2)
     C                   callp     wrtsection('TypSltRow')
     C     Vadrkey       reade     VADRL01                                40
     C                   enddo
      * initier manuell adresse og merking
      *
     C                   callp     updHTMLvar('VADRNRA':
     C                             %trim(%editc(VADRNRFIL:'Z')))
     C                   callp     updhtmlvar('INAVN':INAVN)
     C                   callp     updhtmlvar('IADR1':IADR1)
     C                   callp     updhtmlvar('IADR2':IADR2)
     C     IPOST         ifeq      '0000'
     C                   move      *blanks       IPOST
     c                   end
     C                   callp     updhtmlvar('IPOST':IPOST)
     C                   callp     updhtmlvar('IPSTE':IPSTE)
     C                   callp     updhtmlvar('IMERK1':IMERK1)
     C                   callp     updhtmlvar('IMERK2':IMERK2)
     C                   callp     updhtmlvar('IMERK3':IMERK3)
     C                   callp     updhtmlvar('IMERK4':IMERK4)
     C                   callp     updhtmlvar('IMERK5':IMERK5)
     C                   callp     updhtmlvar('FEILTXT':FEILTXT)
     c
      * Manuell inntasting
     C                   callp     wrtsection('TypSltMan')
      * End right leg
     C                   callp     wrtsection('TypSltEnd')
      *
      *
     C     uta1          endsr
      *********************************************************************
     C     sendbest      begsr
      *********************************************************************
      * sende bestilling/avslutte ordre
      *
      *
     c     linkey2       chain     wotrahf                            33
     c     vadrkey       chain     kundl01                            34
     c  N34              exsr      htmlkundf
     c     *in33         ifeq      *off
     C                   callp     updhtmlvar('IMERK0':MERK)
     c                   z-add     ordnot        xordno            7 0
     c                   move      'F'           status
      * Oppdaterer med L1 ordrenummer
     c                   exsr      l1ord
     c                   z-add     P_SBRNR       ordweb
     c                   update    otrahr
     c                   exsr      oppdatdet
     c                   end
      * =================
      * initier manuell adresse
     c
      * Start right leg  (header)
     C                   callp     updHTMLvar('ORDWEBU':
     C                             %trim(%editc(ORDWEB:'Z')))
     C                   callp     wrtsection('takk')
     C                   callp     wrtsection('skrivbuttom')
      *
      *
     C                   endsr
      *********************************************************************
     C     tommbest      begsr
      *********************************************************************
      * sende bestilling avslutte ordre
      *
     c     linkey2       chain     wotrahf                            33
     c  N33              delete    otrahr
     c                   move      *zeros        ldatoh
     c                   move      *zeros        ldato
      *tømmer kommentarer
     C                   exsr      slettkomm
      *tømmer detaljposter
     C                   exsr      slettotra
     C                   exsr      ordrehode
     C                   exsr      exit
      * =================
      * initier manuell adresse
     c
      *
      *
     C                   endsr
      *=====================================================================
      * Order a book  (SETT PÅ ORD)
      *=====================================================================
      *********************************************************************
     C     Order         begsr
      *********************************************************************
     c                   z-add     ORDNR         ORDNOT
      *
      * ved endring
      *
     c     lin1ot        ifne      0
     c                   exsr      slettkomm
     c     endrekey      chain     wotralsy                           35
     c                   else
     c                   seton                                        35
     c                   exsr      getlin
     c                   end
      *
     c     ldato         ifeq      *blanks
     c                   move      ldatoh        ldato
     c                   end
      *
      * chain kunde for å få variable derfra
      *
     c     vadrkey       chain     kundl01                            33
      *
      * test antall
      *
     c     antnr         ifeq      0
     c                   move      'J'           orderfeil         1
     c                   exsr      endre
     c                   exsr      exit
     c                   end
      * antall desimaler
      *
     c                   exsr      testdesi
      *
     c     feil          ifeq      'J'
     c                   move      'J'           orderfeil
     c                   exsr      endre
     c                   exsr      exit
     c                   end
      *
      * test   aar uke
      *
     c                   exsr      testaaruke
     c     feil          ifeq      'J'
     c                   move      'J'           orderfeil
     c                   exsr      endre
     c                   exsr      exit
     c                   end
      * lev dato
      *
     c                   move      LDATO         LDATODS
     c                   movel     '20'          ldatods
     c                   move      LDATOAA       LEVAAR
     c                   MOVE      LDATOMM       LEVMND
     c                   MOVE      *zeros        LEVDAG
     c                   move      WAA           ordaot
     c                   MOVE      WMM           ordmot
     c                   MOVE      WDD           orddot
     c                   MOVE      'O'           ordtyp
     c                   z-add     ANTNR         BESTIL
     c                   move      ARTNR         VARENR
     c                   CALL      'PRI99R'
     c                   PARM                    VARENR
     c                   movel     ARTTX1        VARTE1
     c                   movel     ARTTX2        VARTE2
     c                   movel     wsuser        USEROT
     c                   movel     wsuser        XSEROT           10
     c                   movel     wsmerk        merk
     c                   move      '1'           trans
     c   35              WRITE     WOTRAR
     c  N35              UPDATE    WOTRAR
     c                   movel     XSEROT        USEROT
     c                   exsr      lesfritxt
     C                   endsr
      *=====================================================================
      * Set variables in html section "top"
      *=====================================================================
      *********************************************************************
     C     SetTop        begsr
      *********************************************************************
OddEvC                   callp     updHTMLvar('ROWHEAD':RowHead)
OddEvC                   callp     updHTMLvar('LogoImg':LogoImg)
BODY C                   callp     updhtmlvar('BODYCLASS':'class='+BIFARG)
      * Gjeldende bruker
     C                   callp     updHTMLvar('USER':WSUSER)
      * Gjeldende ordre
     C                   callp     updHTMLvar('ORD':
     C                             %trim(%editc(OrdNr:'Z')))
      * Levdato
     C*                  callp     updHTMLvar('LDATO':LDATO)
      * Gjeldende prod-gruppe
     C                   callp     updHTMLvar('PRDGRP':PRDGRP)
     C                   callp     updHTMLvar('KODTXT':KODTXT)
      * Prislistenr
     C                   callp     updHTMLvar('PRINR':
     C                             %trim(%editc(PRINRN:'Z')))
     C                   callp     updHTMLvar('KUNDNA':
     C                             %trim(%editc(Kundnr:'Z')))
     C                   callp     updHTMLvar('FIRMA':Firma)
     C                   endsr
      *=====================================================================
      * Set variables in html section "leg2row"
      *=====================================================================
      *********************************************************************
     C     SetLeg2Row    begsr
      *********************************************************************
      * Line number
     C                   callp     updHTMLvar('linenbr':
     C                             %trim(%editc(linenbr:'Z')))
     C                   callp     updhtmlvar('LIN':
     C                             %trim(%editc(LIN1OT:'M')))
      * Antall desimaler
     C                   callp     updHTMLvar('WDESMAL':
     C                             %trim(%editc(desmal:'Z')))
      * Oppdr- beskrivelse 1 / 2
     C                   eval      OPPDBESK1 = %trim(PRD_PTX)
     C     OPPDBESK1     CAT       PRD_PTX2:1    OPPDBESK1
     C                   EXSR      GENLENKE
     c                   exsr      lagerstatus0
     C                   callp     updHTMLvar('OPPDBESK1':OPPDBESK1)
     C                   callp     updHTMLvar('LENKE':LENKE)
      *
      *
     C                   z-add     0             PRD_ANTK          2 0
     C                   callp     updHTMLvar('ANT':
     C                             %trim(%editc(PRD_ANTK:'M')))
     C                   callp     updHTMLvar('ANTL':
     C                             %trim(%editc(ANTLNR:'Z')))
      * Art.nr for Key
     C                   callp     updHTMLvar('ARTNR':PRD_ANRS)
     C                   callp     updHTMLvar('ARTTX1':PRD_PTX)
     C                   callp     updHTMLvar('ARTTX2':PRD_PTX2)
      * Merking
     C                   CLEAR                   WSMERK
      * Kommentar
     C                   CLEAR                   WSMTXT
     C                   callp     updhtmlvar('WSMtxt':WSMtxt)
     C                   callp     updHTMLvar('WSMERK':WSMERK)
     C                   callp     updHTMLvar('LDATO':LDATO)
     c     OddEven       IFEQ      ODD
     c                   eval      OddEven = EVEN
     c                   else
     c                   eval      OddEven = ODD
     c                   end
     C                   callp     updHTMLvar('ODDEVEN':OddEven)
      *
     C                   endsr
      *********************************************************************
     C     endreflytt    begsr
      *********************************************************************
      *
      *  key til prisfil for endring
      *
     C     PrGrKeye      Klist
     C                   KFLD                    FIRMA
     C                   KFLD                    Prinrn
     C                   KFLD                    PRD_ANRS
      *  key til WOTRA   for endring
     c     endrekey      klist
     c                   kfld                    firma
     c                   kfld                    kundnr
     c                   kfld                    ORDNOT
     c                   kfld                    lin1ot
      * Merking
     C                   CLEAR                   WSMERK
      * Kommentar
     C                   CLEAR                   WSMTXT
     c     endrekey      chain(N)  wotralsy                           33
     c     *in33         ifeq      '0'
     C                   eval      PRD_ANRS=VARENR
     c     PrGrKeye      chain     prisld1                            33
     c     *in(33)       ifeq      '1'
     c                   move      varenr        hoirei
     c                   exsr      hoiresr
     c                   move      hoireu        varenr
     C                   eval      PRD_ANRS=VARENR
     c     PrGrKeye      chain     prisld1                            33
     c                   end
     C     Lagekey       chain     VAREL01                            55
     C                   MOVE      DESMAL        WDESMAL
     C                   callp     updHTMLvar('WDESMAL':WDESMAL)
      * hent kommentarer
     c                   exsr      hentkomm
      * hent kommentarer
     c                   eval      WSMERK = MERK
      * flytte data ved endring
      * Line number
     C                   callp     updHTMLvar('linenbr':
     C                             %trim(%editc(linenbr:'Z')))
     C                   eval      OPPDBESK1 = %trim(PRD_PTX)
     C     OPPDBESK1     CAT       PRD_PTX2:1    OPPDBESK1
     C                   EXSR      GENLENKE
     c                   exsr      lagerstatus0
     C                   callp     updHTMLvar('OPPDBESK1':OPPDBESK1)
     C                   callp     updHTMLvar('LENKE':LENKE)
      *
      *
     C                   z-add     bestil        antnr
     c     desmal        ifeq      3
     C                   callp     updhtmlvar('ANt':
     C                             %trim(%editc(BESTIL:'M')))
     c                   else
     c     desmal        ifeq      2
     C                   callp     updhtmlvar('ANt':
     C                             %trim(%editc(BESTIL2:'M')))
     c                   else
     c     desmal        ifeq      1
     C                   callp     updhtmlvar('ANt':
     C                             %trim(%editc(BESTIL1:'M')))
     c                   else
     C                   callp     updhtmlvar('ANt':
     C                             %trim(%editc(BESTIL0:'M')))
     c                   end
     c                   end
     c                   end
     C                   callp     updHTMLvar('ANTL':
     C                             %trim(%editc(ANTLNR:'Z')))
      * Art.nr for Key
     C                   callp     updHTMLvar('ARTNR':PRD_ANRS)
     C                   callp     updHTMLvar('ARTTX1':PRD_PTX)
     C                   callp     updHTMLvar('ARTTX2':PRD_PTX2)
     C                   callp     updhtmlvar('WSMtxt':WSMtxt)
     C                   callp     updHTMLvar('WSMERK':WSMERK)
     c                   move      levaar        levaar2           2 0
     c                   movel     levaar2       ldato
     c                   move      levmnd        ldato
     C                   callp     updHTMLvar('LDATO':LDATO)
     c     OddEven       IFEQ      ODD
     c                   eval      OddEven = EVEN
     c                   else
     c                   eval      OddEven = ODD
     c                   end
     C                   callp     updHTMLvar('ODDEVEN':OddEven)
     c                   end
      *
     C                   endsr
      *********************************************************************
     C     feilflytt     begsr
      *********************************************************************
     C                   eval      PRD_ANRS=ARTNR
     c     PrGrKeye      chain     prisld1                            33
     c     *in(33)       ifeq      '1'
     c                   move      ARTNR         hoirei
     c                   exsr      hoiresr
     c                   move      hoireu        PRD_ANRS
     c     PrGrKeye      chain     prisld1                            33
     c                   end
      * Oppdr- beskrivelse 1 / 2
     C                   eval      OPPDBESK1 = %trim(PRD_PTX)
     C     OPPDBESK1     CAT       PRD_PTX2:1    OPPDBESK1
     C                   EXSR      GENLENKE
     c                   exsr      lagerstatus0
     C                   callp     updHTMLvar('OPPDBESK1':OPPDBESK1)
     C                   callp     updHTMLvar('LENKE':LENKE)
      *
     C                   callp     updhtmlvar('WDESMAL':WDESMAL)
      *
     C                   z-add     0             PRD_ANTK          2 0
     C                   callp     updHTMLvar('ANT':
     C                             %trim(%editc(PRD_ANTK:'M')))
     C                   callp     updHTMLvar('ANTL':
     C                             %trim(%editc(ANTLNR:'Z')))
     C                   callp     updHTMLvar('ANT':
     C                             %trim(%editc(ANTNR:'M')))
     c     WSMERK        IFEQ      *blanks
     c     linkey2       chain     wotrahf                            55
     c  N55              MOVEL     merk          xmerk            30
     c                   eval      WSMERK  = XMERK
     c                   end
     C                   callp     updHTMLvar('WSMERK':WSMERK)
     C                   callp     updHTMLvar('LDATO':LDATO)
     C                   callp     updHTMLvar('ARTNR':ARTNR)
     C                   callp     updHTMLvar('ARTTX1':ARTTX1)
     C                   callp     updHTMLvar('ARTTX2':ARTTX2)
     C                   callp     updhtmlvar('WSMtxt':WSMtxt)
     c     OddEven       IFEQ      ODD
     c                   eval      OddEven = EVEN
     c                   else
     c                   eval      OddEven = ODD
     c                   end
     C                   callp     updHTMLvar('ODDEVEN':OddEven)
      *
     C                   endsr
      *=====================================================================
      * Ask the service program to load into core
      * the appropriate output skeleton html member
      *=====================================================================
      *********************************************************************
     C     LoadHtml      begsr
      *********************************************************************
      * Read externally defined output html
     C                   eval      HtmlSrcLib = '*LIBL'
     C                   eval      HtmlSrcFil = 'HTMLSRC' + lng
     C                   eval      HtmlSrcMbr = 'FRL1O02'
     C                   callp     gethtml(HtmlSrcFil:HtmlSrcLib:HtmlSrcMbr:
     C                             '/CGITAG/')
      *
     C                   endsr
      *=====================================================================
      * Open database files
      *=====================================================================
     C     OpenDbf       begsr
     C     PrGrKey       Klist
     C                   KFLD                    FIRMA
     C                   KFLD                    Prinrn
     C                   KFLD                    PRDGRP
      *
     C     PrGrKeyStr    Klist
     C                   KFLD                    FIRMA
     C                   KFLD                    Prinrn
     C                   KFLD                    PRDGRP
      *
     C                   call      'INCGITALG'
OddEv * hent Parametre som går igjen i mange prog:
OddEv *      Odd/Even/Rowhead-farger,Logobilde,Språk,Intern/Ekstern bruker,  mm
OddEvc                   call      'ESGETPAR'
OddEvc                   parm                    BIBRID
OddEvc                   parm                    BIFIRM
OddEvc                   parm                    BIKUNR
OddEvc                   parm                    BIKNG
OddEvc                   parm                    RowHead          10
OddEvc                   parm                    Odd              10
OddEvc                   parm                    Even             10
OddEvc                   parm                    LogoImg          50
OddEvc                   parm                    XSPRÅK            2
OddEvc                   parm                    XINTERN           1
OddEvc                   parm                    ParmDS1        1024
OddEvc                   parm                    ParmDS2        1024
OddEvc                   parm                    ParmDS3        1024
      *
      *  Open bookshelves
      *  Open books
     C                   open      KUNDL01
     C                   open      PRISLD1
     C                   open      PRISLD2
     C                   open      VAREL01
     C                   open      VADRL01
     C                   open      WOTRAHF
     C                   open      WKOMML01
     C                   open      WOTRALSY
     C                   open      lagel01
     C                   open      STRNL01
     C* Hent kundopplysninger
     C     vadrkey       chain     kundl01                            33
      *
     C                   endsr
      *=====================================================================
      * Close database files
      *=====================================================================
      *********************************************************************
     C     CloseDbf      begsr
      *********************************************************************
      *  Close bookshelves
      *  Close books
     C                   close     KUNDL01
     C                   close     PRISLD1
     C                   close     PRISLD2
     C                   close     VAREL01
     C                   close     VADRL01
     C                   close     WOTRAHF
     C                   close     WKOMML01
     C                   close     WOTRALSY
     C                   close     lagel01
     C                   close     STRNL01
     C                   close     bridf
     C                   endsr
      *=====================================================================
      *  Time started
      *=====================================================================
      *********************************************************************
     C     SetTimeStr    begsr
      *********************************************************************
     C                   time                    TimeStart
     C                   TIME                    DSTID            14 0
      *
     C                   BITON     '457'         XSTEGN1           1
     C                   BITOFF    '01236'       XSTEGN1
     C                   BITON     '257'         XSTEGN2           1
     C                   BITOFF    '01346'       XSTEGN2
     C                   endsr
      *=====================================================================
      *  Time ended and time elapsed elapsed
      *=====================================================================
      *********************************************************************
     C     SetTimeEnd    begsr
      *********************************************************************
     C                   time                    TimeEnd
     C     TimeEnd       subdur    TimeStart     MsElaps:*ms
     C                   eval      SecElaps = MsElaps / 1000000
     C                   endsr
      *=====================================================================
      * Send response html and quit
      *=====================================================================
      *********************************************************************
     C     Exit          begsr
      *********************************************************************
      * Close database files
     C                   exsr      CloseDbf
      *
     C                   exsr      SetTimeEnd
      *
      * Skriver form med felles variable
      *
     C                   callp     updHTMLvar('FMELDNR':FMELDNR)
     C                   callp     wrtsection('FELLES')
      *
     C                   callp     updhtmlvar('RUNTIME':
     C                             %trim(%editw(SecElaps:'     0 .   ')))
     C                   callp     wrtsection('end')
      * Do not delete the call to wrtsection with section name *fini.  It is needed
      * to ensure that all output html that has been buffered gets output.
     C                   callp     wrtsection('*fini')
      * Quit
     C                   move      *on           *INLR
     C                   return
     C                   endsr
      *=====================================================================
      * Parse the input string
      *=====================================================================
      *********************************************************************
     C     Parse         begsr
      *********************************************************************
     C                   move      *blanks       FMELDNR
     c                   move      *zeros        ldatods
     C                   eval      WSUSER     = zhbgetvar('USER      ')
     c     wsuser        ifne      *blanks
     C                   eval      action     = zhbgetvar('action    ')
     C                   eval      subaction  = zhbgetvar('subaction ')
     C                   eval      lng        = zhbgetvar('lng       ')
     C                   eval      Ord        = zhbgetvar('ORD       ')
     C                   eval      OrdNr      = c2n2(ord)
     c                   z-add     ORDNR         ORDNOT
     C                   eval      wdesmal    = zhbgetvar('WDESMAL   ')
     C                   eval      desmal     = c2n2(WDESMAL)
      * selektert varenummer
     C                   eval      WSANR      = zhbgetvar('WSANR     ')
     C                   eval      LDATO      = zhbgetvar('LDATO     ')
     C                   eval      LDATOH     = zhbgetvar('LDATOH    ')
     C                   eval      Ant        = zhbgetvar('ANT       ')
     C                   eval      Antnr      = c2n2(ant)
     C                   eval      Antl       = zhbgetvar('ANTL      ')
     C                   eval      Antlnr     = c2n2(antl)
     C                   eval      PriNR      = zhbgetvar('PRINR     ')
     C                   eval      Prinrn     = c2n2(PriNR)
     C                   eval      PRDGRP     = zhbgetvar('PRDGRP    ')
     C                   eval      KODTXT     = zhbgetvar('KODTXT    ')
     C                   eval      ARTNR      = zhbgetvar('ARTNR     ')
      *
     C                   eval      ARTTX1     = zhbgetvar('ARTTX1    ')
     C                   eval      ARTTX2     = zhbgetvar('ARTTX2    ')
     C                   eval      WSMERK     = zhbgetvar('WSMERK    ')
     C                   eval      FIRMA      = zhbgetvar('FIRMA     ')
     C                   eval      KUNDNA     = zhbgetvar('KUNDNA    ')
     C                   eval      IKKEOK     = zhbgetvar('IKKEOK    ')
     C                   eval      Kundnr     = c2n2(KUNDNA)
     C                   eval      WSMtxt     = zhbgetvar('WSMTXT')
     C                   eval      LIN        = zhbgetvar('LIN       ')
     C                   eval      lin1ot     = c2n2(LIN)
     c                   else
     c                   eval      Ord        = *blanks
     c                   eval      PRDGRP     = *blanks
     c                   eval      KODTXT     = *blanks
     c                   eval      OrdNr      = *zeros
     C                   eval      action     = zhbgetvar('action    ')
     c                   end
     C                   ENDSR
      *********************************************************************
     C     Parse2        begsr
      *********************************************************************
     c                   move      *blanks       vadrnraa          3
     c                   z-add     0             IVADRNRN          3 0
     C                   eval      vadrnraa   = zhbgetvar('IVADRNR   ')
     c     vadrnraa      ifne      '***'
     C                   eval      IVADRNRN   = c2n2(VADRNRAA)
     C                   move      IVADRNRN      vadrnra
     C                   eval      INAVN      = zhbgetvar('INAVN     ')
     C                   eval      IADR1      = zhbgetvar('IADR1     ')
     C                   eval      IADR2      = zhbgetvar('IADR2     ')
     C                   eval      IPOST      = zhbgetvar('IPOST     ')
     C                   eval      IPSTE      = zhbgetvar('IPSTE     ')
     c                   else
     C                   eval      IVADRNRN   = 0
     C                   move      IVADRNRN      vadrnra
     c                   move      *zeros        vadrnr
     c                   end
     C                   eval      LDATO      = zhbgetvar('LDATO     ')
     C                   eval      IMERK1     = zhbgetvar('IMERK1    ')
     C                   eval      IMERK2     = zhbgetvar('IMERK2    ')
     C                   eval      IMERK3     = zhbgetvar('IMERK3    ')
     C                   eval      IMERK4     = zhbgetvar('IMERK4    ')
     C                   eval      IMERK5     = zhbgetvar('IMERK5    ')
     C                   eval      IMERK0     = zhbgetvar('IMERK0    ')
     C                   eval      IKUNREF    = zhbgetvar('IKUNREF   ')
     C                   endsr
     C***********************************************
     C     genlenke      BEGSR
     C***********************************************
     c                   move      *BLANKS       LENKE
     C     PRD_HTMB      IFNE      *BLANKS
     c                   movel     '<a href="'   LENKE
     C     LENKE         CAT       PRD_HTMB:0    LENKE
     C     LENKE         CAT       '" target="':0LENKE
     C     LENKE         CAT       '_BLANK"':0   LENKE
     C     LENKE         CAT       '">':0        LENKE
     C     LENKE         CAT       OPPDBESK1:0   LENKE
     C     LENKE         CAT       '</a>':0      LENKE
     C                   ELSE
     C                   EVAL      LENKE=OPPDBESK1
     c                   end
     c                   endsr
      *********************************************************************
     C     getlin        begsr
      *********************************************************************
     c                   z-add     1             lin1ot
     c                   z-add     vadrnr        vadrnrv           3 0
     C     linkey        Klist
     C                   KFLD                    FIRMA
     C                   KFLD                    KUNDNR
     C                   KFLD                    ORDNOT
     C                   KFLD                    LINMAX            5 0
     c                   z-add     99999         linmax
     C     linkey2       Klist
     C                   KFLD                    FIRMA
     C                   KFLD                    KUNDNR
     C                   KFLD                    ORDNOT
     C     linkey3       Klist
     C                   KFLD                    FIRMA
     C                   KFLD                    KUNDNR
     C                   KFLD                    XORDNO
     C     Vadrkey       Klist
     C                   KFLD                    FIRMA
     C                   KFLD                    KUNDNR
     C     Vadrkey2      Klist
     C                   KFLD                    FIRMA
     C                   KFLD                    KUNDNR
     C                   KFLD                    VADRNR
     C     Vadrkey3      Klist
     C                   KFLD                    FIRMA
     C                   KFLD                    KUNDNR
     C                   KFLD                    IVADRNRN
     C     Lagekey       Klist
     C                   KFLD                    FIRMA
     C                   KFLD                    PRD_ANRS
     c     linkey        setgt     wotralsy
     c     linkey2       readpe(n) wotralsy                               33
     c  N33lin1ot        add       1             lin1ot
     c                   z-add     vadrnrv       vadrnr
     c                   endsr
      *********************************************************************
     c     lesfritxt     begsr
      *********************************************************************
      * Melding til mottaker....
     c     WSMtxt        Ifne      *blanks
     C                   EVAL      KVTXT = WSMTXT
     C                   Z-ADD     60            XLINL             3 0
     C                   EXSR      KVTLIN
     c                   exsr      SkrivFrt
     c                   end
     c                   endsr
      *********************************************************************
     C     KVTLIN        BEGSR
      *********************************************************************
      *=====================================================================
      *  FINNE LINJE
      *=====================================================================
     C                   Z-ADD     60            XLINL             3 0
     C                   MOVE      *BLANKS       T60
     C                   MOVE      *BLANKS       TX
     C                   MOVE      *ZEROS        XN1               3 0
     C                   MOVE      *ZEROS        XN2               3 0
     C     XLINL         MULT      10            XN5               3 0
     C     1             DO        XN5           XN3               3 0
     C                   ADD       1             XN2
     C                   SELECT
     C                   WHEN      XN2 > XLINL
     C                   ADD       1             XN1
     C                   MOVEL     TXT60         TX(XN1)
     C     XN1           CABEQ     10            SLKVTLIN
     C                   MOVE      *BLANKS       T60
     C                   Z-ADD     1             XN2
     C                   MOVE      KVT(XN3)      T60(XN2)
     C                   WHEN      KVT(XN3) = XSTEGN1
     C     XN3           ADD       1             XN4               3 0
     C                   IF        KVT(XN4) = XSTEGN2
     C                   ADD       1             XN1
     C                   MOVEL     TXT60         TX(XN1)
     C                   MOVE      *BLANKS       T60
     C                   MOVE      *ZEROS        XN2
     C                   EVAL      XN3 = XN4
     C                   END
     C                   OTHER
     C                   MOVE      KVT(XN3)      T60(XN2)
     C                   ENDSL
     C                   ENDDO
      *
     C     SLKVTLIN      ENDSR
      *********************************************************************
     C     SKRIVFRT      begsr
      *********************************************************************
      *
      *=====================================================================
      *  Skriv fritekst til fil
      *=====================================================================
     C                   TIME                    DSTID            14 0
     c                   move      'A'           aktkod
     c                   move      'O'           otbkod
     c                   move      'J'           UTSKDO
     c                   move      'J'           UTSKDP
     c                   move      'J'           UTSKDF
     c                   move      WAA           OTBAAR
     c                   z-add     ORDNR         OTBNR
     c                   z-add     LIN1OT        OTBLNR
     c                   z-add     0             LNrKOM
     c     1             Do        10            NR                2 0
     c     TX(NR)        Ifne      *blanks
     c                   add       1             LNRKOM
     c                   move      TX(NR)        OTBKOM
     c                   write     WKOMMR
     c                   end
     c                   end
      *
     C                   endsr
      *********************************************************************
     C     lagerstatus0  begsr
      *********************************************************************
     c                   move      *zeros        antlnr
      * ta vare på hovedvare
      *
     C     strukey       Klist
     C                   KFLD                    FIRMA
     C                   KFLD                    PRD_ANRS
      *
     c                   move      PRD_ANRS      VARENR
     c                   move      PRD_ANRS      KOMP
     c                   move      'J'           runde1            1
     C     strukey       chain     STRNL01                            33
     c     *in(33)       ifeq      '1'
     c                   exsr      lagerstatus
     c                   z-add     gsum          antlnr
     c                   else
     c*
     C     strukey       setll     STRNL01
     C     strukey       readE     STRNL01
     C                   dow       not%eof
     c                   exsr      lagerstatus
     c     runde1        ifeq      'J'
     c                   z-add     gsum          antlnr
     c                   move      'N'           runde1            1
     c                   end
     C     gsum          iflt      antlnr
     c                   z-add     gsum          antlnr
     c                   end
     C     strukey       readE     STRNL01
     C                   enddo
     c                   end
     C                   endsr
      *********************************************************************
     C     lagerstatus   begsr
      *********************************************************************
     C     kompkey       Klist
     C                   KFLD                    FIRMA
     C                   KFLD                    KOMP
     c                   clear                   gsum             11 3
     c                   clear                   bsum
     c                   clear                   usum
     c                   clear                   rsum
     c                   clear                   xsum
      *
     C     kompkey       setll     lagel01
     C     kompkey       readE     lagel01
     C                   dow       not%eof
     C                   add       behold        bsum             11 3
     C                   add       utlev         usum             11 3
     C                   add       resta         rsum             11 3
     C                   add       reserv        xsum             11 3
     C     kompkey       readE     lagel01
     C                   enddo
     c     bsum          sub       usum          gsum
     c                   sub       rsum          gsum
     c     gsum          iflt      0
     c                   z-add     0             gsum
     c                   end
     c                   endsr
      *********************************************************************
     C     movehf        begsr
      *********************************************************************
      * flytt data fra WOTRAHF til skjermvariable
      *Hvis vareadresse er valg hent data
     c     vadrnr        ifne      *zeros
     c     vadrkey2      chain     vadrl01                            33
     c                   end
      *variabelnavn er like så data flyttes uansett
     c                   move      VADRNR        VADRNRA
     C                   eval      INAVN=VADRNA
     C                   EVAL      IADR1=VADRN1
     c                   eval      IADR2=VADRN2
     c                   move      VPOSTN        ipost
     c                   EVAL      IPSTE=VADRN3
      * flytter over merknadslinjer
     c                   eval      imerk1=otbko1
     c                   eval      imerk2=otbko2
     c                   eval      imerk3=otbko3
     c                   eval      imerk4=otbko4
     c                   eval      imerk5=otbko5
     c                   eval      imerk0=merk
     c                   eval      ikunref=kunref
     c                   move      levaar        levaar2
     c                   movel     levaar2       ldato
     c                   move      levmnd        ldato
     c                   endsr
      *********************************************************************
     C     movehg        begsr
      *********************************************************************
      *Flytt fast vareadresse
     c     vadrnr        ifne      *zeros
     c     vadrkey2      chain     vadrl01                            33
     c                   end
      *variabelnavn er like så data flyttes uansett
     c                   move      VADRNR        VADRNRA
     C                   eval      INAVN=VADRNA
     C                   EVAL      IADR1=VADRN1
     c                   eval      IADR2=VADRN2
     c                   move      VPOSTN        ipost
     c                   EVAL      IPSTE=VADRN3
     c                   endsr
      *********************************************************************
     C     bekrefth      begsr
      *********************************************************************
      * Bekreftelse av odrehode
      *
     c                   exsr      testhode
     c     FEILTXT       ifne      *blanks
     c     vadrnraa      oreq      '***'
     c     IKKEOK        oreq      'Y'
     c                   exsr      ordrehode
     c                   exsr      exit
     c                   end
      * flytt data fra skjerm til fil OTRAHF
     c                   exsr      opdhead
     C                   exsr      display
     c                   exsr      exit
      *
      *
     C                   endsr
      *********************************************************************
     C     opdhead       begsr
      *********************************************************************
     c     ordnr         ifne      0
     c                   z-add     ORDNR         ORDNOT
     c     linkey2       chain     wotrahf                            33
     c     *in33         ifeq      '0'
     c                   MOVEL     merk          xmerk            30
     c                   end
      * flytt data fra skjerm til fil
      *Hvis vareadresse er valg hent data
     c     IVADRNRN      ifne      *zeros
     c     vadrkey3      chain     vadrl01                            34
     c                   else
      * flytter manuell vareadresse
     c                   z-add     0             vadrnr
     C                   eval      VADRNA=INAVN
     C                   EVAL      VADRN1=IADR1
     c                   eval      VADRN2=IADR2
     c                   move      ipost         vpostn
     c                   EVAL      VADRN3=IPSTE
     c                   end
      * flytter over marknadslinjer
     c                   eval      otbko1=imerk1
     c                   eval      otbko2=imerk2
     c                   eval      otbko3=imerk3
     c                   eval      otbko4=imerk4
     c                   eval      otbko5=imerk5
     c                   eval      merk=imerk0
     c                   eval      kunref=ikunref
     c                   move      LDATO         LDATODS
     c                   movel     '20'          LDATODS
     c                   move      LDATOAA       LEVAAR
     c                   MOVE      LDATOMM       LEVMND
     c                   MOVE      *zeros        LEVDAG
     c                   movel     USEROT        XSEROT           10
     c                   movel     *blanks       USEROT
     c   33              write     otrahr
     c  N33              update    otrahr
     c                   movel     XSEROT        USEROT
     c                   MOVEL     merk          xmerk            30
     c                   end
     c                   endsr
      *********************************************************************
     C     testhode      begsr
      *********************************************************************
     c                   move      *blanks       FEILTXT
     c                   move      *blanks       FMELDNR
      *
      * vareadresse tastet
      *
     c     IVADRNRN      ifne      *zeros
     C                   EXSR      HENTVADR
     C                   ELSE
      * postnummer må testes hvis navn er utfyylt
     c     INAVN         IFNE      *blanks
     c     IPOST         ifeq      *blanks
     c     IPSTE         oreq      *blanks
     C                   movel     fmelding4     FEILTXT
     C                   move      '03'          FMELDNR
     C                   goto      uthode
     C                   end
     c                   end
     C                   end
     c
     c                   exsr      testaaruke
     c*
     c     feil          ifeq      'J'
     C                   move      '02'          FMELDNR
     c                   end
      *
     c     uthode        endsr
      *
      *********************************************************************
     C     hentvadr      begsr
      *********************************************************************
     C     vadrkey3      chain     vadrL01                            33
     C                   MOVE      VADRNR        VADRNRA
     C                   EVAL      INAVN=VADRNA
     C                   EVAL      IADR1=VADRN1
     C                   EVAL      IADR2=VADRN2
     c                   move      VPOSTN        IPOST
     C                   EVAL      IPSTE=VADRN3
     c                   endsr
      *********************************************************************
     C     hentkomm      begsr
      *********************************************************************
     c     komKey        KLIST
     C                   kfld                    FIRMA
     C                   kfld                    OTBKOD
     C                   kfld                    OTBAAR
     C                   kfld                    ORDNOT
     C                   kfld                    LIN1OT
     C                   BITON     '457'         XSTEGN1           1
     C                   BITOFF    '01236'       XSTEGN1
     C                   move      'O'           OTBKOD
     C                   TIME                    DSTID            14 0
     c                   move      WAA           OTBAAR
     C     komkey        setll     WKOMML01
      *
     c*                  z-add     0             NR                2 0
     C     Komkey        reade     WKOMML01
     C                   dow       not%eof
     C     wsmtxt        cat       OTBKOM:0      wsmtxt
     C                   cat       xstegn1:0     wsmtxt
     C     Komkey        reade(N)  WKOMML01
     C                   enddo
     C
     C                   endsr
      *********************************************************************
     C     slettkomm     begsr
      *********************************************************************
     C                   move      'O'           OTBKOD
     C                   TIME                    DSTID            14 0
     c                   move      WAA           OTBAAR
      *
      * slett kommentarer
     C     komkey        setll     WKOMML01
      *
     C     Komkey        reade     WKOMML01
     C                   dow       not%eof
     C                   delete    wkommr
     C     Komkey        reade     WKOMML01
     C                   enddo
     c                   endsr
      *********************************************************************
     C     oppdatdet     begsr
      *********************************************************************
     C                   move      'O'           OTBKOD
     C     KOMML01K      KLIST
     C                   kfld                    FIRMA
     C                   kfld                    OTBKOD
     C                   kfld                    LEVAAR
     C                   kfld                    ORDNOT
     C                   kfld                    LIN1OT
      *
     C                   exsr      SetTop
     C                   callp     wrtsection('top')
     C                   eval      wrotetop = *on                               For pssr
     C     INAVN         ifeq      *blanks
     C                   eval      INAVN=VADRNA
     C                   EVAL      IADR1=VADRN1
     c                   eval      IADR2=VADRN2
     c                   move      VPOSTN        ipost
     c                   EVAL      IPSTE=VADRN3
     c                   endif
     c                   EVAL      IKUNREF=KUNREF
     C                   callp     updHTMLvar('INAVN':INAVN)
     C                   callp     updHTMLvar('IADR1':IADR1)
     C                   callp     updHTMLvar('IADR2':IADR2)
     C     IPOST         ifeq      '0000'
     C                   move      *blanks       IPOST
     c                   end
     C                   callp     updHTMLvar('IPOST':IPOST)
     C                   callp     updHTMLvar('IPSTE':IPSTE)
     C                   callp     updHTMLvar('IKUNREF':IKUNREF)
     C                   callp     wrtsection('takk0')
     c     inavn         ifne      *blanks
     C                   callp     wrtsection('takk0lev')
     c                   end
     C                   callp     updHTMLvar('IMERK1':otbko1)
     C                   callp     updHTMLvar('IMERK2':otbko2)
     C                   callp     updHTMLvar('IMERK3':otbko3)
     C                   callp     updHTMLvar('IMERK4':otbko4)
     C                   callp     updHTMLvar('IMERK5':otbko5)
     C                   callp     wrtsection('takk1')
      * oppdater detaljer
     C     linkey3       setll     WOTRALSY
      *
     C     linkey3       reade(n)  WOTRALSY
     C                   dow       not%eof
     C                   EVAL      LENKE=VARTE1
     C                   EVAL      ANTLNR=BESTIL
     C                   callp     updHTMLvar('LENKE':LENKE)
     C                   callp     updHTMLvar('ANTL':
     C                             %trim(%editc(ANTLNR:'Z')))
     c     OddEven       IFEQ      ODD
     c                   eval      OddEven = EVEN
     c                   else
     c                   eval      OddEven = ODD
     c                   end
     C                   callp     updHTMLvar('ODDEVEN':OddEven)
     c                   callp     wrtsection('leg2rowprt')
      *
     C                   IF        MERK <> *BLANKS
     C                   callp     updHTMLvar('LENKE':MERK)
     C                   callp     updHTMLvar('ANTL':'')
     C                   callp     wrtsection('leg2rowprt')
     C                   END
     C     KOMML01K      setll     WKOMML01
     C     KOMML01K      reade     WKOMML01                               33
     C                   DOW       *IN33 = *OFF
     C                   callp     updHTMLvar('LENKE':OTBKOM)
     C                   callp     updHTMLvar('ANTL':'')
     C                   callp     wrtsection('leg2rowprt')
     C     KOMML01K      reade     WKOMML01                               33
     C                   ENDDO
     C                   callp     updHTMLvar('LENKE':'')
     C                   callp     updHTMLvar('ANTL':'')
     C                   callp     wrtsection('leg2rowprt')
      *
     C     linkey3       reade     WOTRALSY
     C                   enddo
      *
     c                   endsr
      *
      *********************************************************************
     C     slettotra     begsr
      *********************************************************************
      *
      * slett detaljlinjer
     C     linkey2       setll     WOTRALSY
      *
     C     linkey2       reade     WOTRALSY
     C                   dow       not%eof
     C                   delete    WOTRAR
     C     linkey2       reade     WOTRALSY
     C                   enddo
     c                   endsr
      *********************************************************************
     C     hoiresr       begsr
      *********************************************************************
     c                   clear                   hoireu
     c                   z-add     15            nr1               2 0
     c                   z-add     15            nr2               2 0
     c                   do        15
     c     hoi(nr1)      ifne      *blanks
     c                   move      hoi(nr1)      hou(nr2)
     c                   sub       1             nr2
     c                   endif
     c                   sub       1             nr1
     c                   enddo
     c                   endsr
      *////////////////////////////////////////////////////////////
      *=====================================================================
      *  Initier
      *=====================================================================
      *
     C     INIT          begsr
      * Get program start time for calculating execution time
      *
     C                   open      BRIDF                                50
     C     WSUSER        CHAIN(N)  BRIDF                              50
      *
     C* En "standardvariant" libl: call bound (INCGI=*MODULE) med parameter.
     C     BILIBL        ifeq      *blanks
     C                   callb     'INCGI'
     C                   parm                    BISTDL
     C                   else
     C* Helt egen bibl.liste satt på user - normal CALL (BILIBL er "*pgm")
     C                   call      BILIBL
     C                   end
      *
     C                   endsr
      *
     c*****************************************************
     c     finnaaruke    begsr
     c*****************************************************
     C     PARM3         PLIST
     C                   PARM                    VR014
      *
     C                   TIME                    DSTID
     C*
     C                   CLEAR                   VR014
     C                   MOVE      '3'           ÅTYPE
     C                   MOVE      WDD           WWDATD
     C                   MOVE      WMM           WWDATM
     C                   MOVE      WAA           WWDATA
     C                   Z-ADD     WWDAT         ÅDATO1
     C                   CALL      'VR014'       PARM3
     C                   Z-ADD     ÅAAR          INVAAR
     C                   Z-ADD     ÅUKE          INVUKE
     c                   endsr
     c*****************************************************
     c     testaaruke    begsr
     c*****************************************************
     c                   move      'N'           feil
     c     LDATO         ifeq      *BLANKS
     c     LDATO         oreq      *zeros
     C                   movel     fmelding1     FEILTXT
     C                   move      'J'           FEIL              1
     C                   move      '11'          FMELDNR
     C                   goto      utfeil
     c                   end
      *
     C                   MOVEL     LDATO         XN02              2 0
     C     UYEAR         ADD       1             XNESTEÅR          2 0
     C                   IF        ((XN02 <> UYEAR) AND (XN02 <> XNESTEÅR))
     C                   movel     fmelding1     FEILTXT
     C                   move      'J'           FEIL              1
     C                   move      '11'          FMELDNR
     C                   goto      utfeil
     C                   END
      * UKE FRA 01 - 52
     c                   move      ldato         ttuke             2 0
     c     ttuke         iflt      1
     c     ttuke         orgt      52
     c                   move      fmelding7     feiltxt
     C                   move      'J'           FEIL
     C                   move      '11'          FMELDNR
     C                   goto      utfeil
     c                   end
      * ønsket levering år uke mindre enn inneværende uke
     c                   exsr      finnaaruke
     C                   move      INVAAU        LDATO4A           4
     c     LDATO         iflt      LDATO4A
     C                   movel     fmelding5     FEILTXT
     C                   move      'J'           FEIL
     C                   goto      utfeil
     c                   end
     c     utfeil        tag
     c                   endsr
     c*****************************************************
     c     testdesi      begsr
     c*****************************************************
     c                   move      'N'           feil
     c                   move      antnr         antnrd
     c     WDESMAL       ifeq      '0'
     c     WDESMAL       oreq      ' '
     C     desi3         ifne      0
     C                   movel     fmelding8     FEILTXT
     C     FEILTXT       CAT       WDESMAL:1     FEILTXT
     C                   move      'J'           FEIL              1
     C                   goto      utfeild
     c                   end
     c                   end
     c     WDESMAL       ifeq      '1'
     C     desi2         andne     0
     C                   movel     fmelding8     FEILTXT
     C     FEILTXT       CAT       WDESMAL:1     FEILTXT
     C                   move      'J'           FEIL              1
     C                   goto      utfeild
     c                   end
     c     WDESMAL       ifeq      '2'
     C     desi1         andne     0
     C                   movel     fmelding8     FEILTXT
     C     FEILTXT       CAT       WDESMAL:1     FEILTXT
     C                   move      'J'           FEIL              1
     C                   goto      utfeild
     c                   end
     c     utfeild       tag
     c     feil          ifeq      'J'
     C                   move      '11'          FMELDNR
     c                   end
     c                   endsr
     c*****************************************************
     c     l1ord         begsr
     c*****************************************************
      *  Parameterliste VR949
     C     VR949         PLIST
     C                   PARM                    VR949DS
      *
     C                   EVAL      P_FIRMA = FIRMA
     C                   EVAL      P_NRAAR = WAA
     C                   EVAL      P_NOKK1 = 'TILB'
     C                   EVAL      P_NOKK2 = *BLANKS
     C                   EVAL      P_BEHKD = 'H'
     C                   CALL      'VR949'       VR949
     C                   IF        P_RETKO = 'F'
     C                   EVAL      *IN74 = *ON
     C                   EVAL      P_SBRNR=999999
     C                   ENDIF
     c                   endsr
     c*****************************************************
     c     htmlkundf     begsr
     c*****************************************************
      * setter variable fra kundf
      *
     C                   callp     updhtmlvar('KNAVN':KNAVN)
     C                   callp     updhtmlvar('ADR1':ADR1)
     C                   callp     updhtmlvar('ADR2':ADR2)
     C                   move      postnr        postnra           4
     C                   callp     updhtmlvar('POSTNRA':POSTNRA)
     C                   callp     updhtmlvar('ADR3':ADR3)
     C                   endsr
