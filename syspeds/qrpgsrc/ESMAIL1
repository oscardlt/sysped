      *********************************************************************
      *
CRTPG+*  CRTPGM SYSPED/ESMAIL1 MODULE(*LIBL/ESMAIL1
CRTPGM*        *LIBL/CHECKUSR *LIBL/INCGI) ACTGRP(CGI) AUT(*USE)
      *
      *********************************************************************
      * MAIN PROGRAM FLOW
      *********************************************************************
      /copy syspeds/qrpgsrcpy,hspecs
      /copy syspeds/qrpgsrcpy,hspecsbnd
     FBRIDF     UF   E           K DISK    USROPN
     FMAILPRTF  IF   E           K DISK    USROPN
     FCUNDL01   IF   E           K DISK    USROPN
     Fmailspl3  IF   E           K DISK    usropn
      *--------------------------------------------------------------------
      * Prototype defintions and standard system API error structure
      *--------------------------------------------------------------------
      /copy syspeds/qrpgsrcpy,prototypeb
      /copy syspeds/qrpgsrcpy,usec
      *--------------------------------------------------------------------
      * Variables common to CGI programs
      *--------------------------------------------------------------------
      /copy syspeds/qrpgsrcpy,variables3
      *--------------------------------------------------------------------
      * Variables received from the input string
     D OddEven         s             10
     D lng             s              2
     D BckGnd          s             10
     D UsrSpcName      s             10
     D WSUSER          S             10
     D WSNA            S             30
     D U_name          S             10
     D wsuse           s             10
     D DATO            s             10
     D FraDT6          s              6  0
     D DATOT           s             10
     D TilDT6          s              6  0
     D DATONF          s              6  0
     D Kunr2           s              8
     D Kunr2N          s              8  0
     D DATONT          s              6  0
     D ANTSND          s              5  0
     D MaxSN           s              5
     D MaxSND          s              5  0
     D ANTRCD          s              5  0
     D MaxRC           s              5
     D MaxRCD          s              5  0
     D PGM             C                   CONST('SYSPED/CHECKUSR')
     D Spaces          s             12a   inz('&nbsp;&nbsp;')
     D TITLE           C                   CONST('Vis sendte eposter')
     D IfsMultIndicators...
     d                 ds
     D  NoErrors                       n
     D  NameTooLong                    n
     D  NotAccessible                  n
     D  NoFilesUsable                  n
     D  DupSections                    n
     D  FileIsEmpty                    n
      *
     D  XXDATO                 1      6  0
     D  XXDATOD                1      2  0
     D  XXDATOM                3      4  0
     D  XXDATOÅ                5      6  0
     D                 DS
     D  DATON                  1      6  0
     D  DATOND                 1      2  0
     D  DATONM                 3      4  0
     D  DATONÅ                 5      6  0
     D                 DS
     D  Wdata                  1    220
     D  XSTAT                  1      1
     D  XUSER                  2     11
     D  XJOBNA                12     21
     D  XJOBNO                22     27
     D  XFILE                 28     37
     D  XSNRBA                38     39
     D  XUSRDT                40     49
     D  XTIL                  50    119
     D  XDATE                120    125  0
     D  XXdtÅ                120    121  0
     D  XXdtM                122    123  0
     D  XXdtD                124    125  0
     D  XKUNDN               126    133  0
     D  XNAVN                134    163
     D  XSNBRA               164    165
      *
      *--------------------------------------------------------------------
      * Prolog common to CGI programs
      * -Receive input from the remote browser
      *--------------------------------------------------------------------
      /copy syspeds/qrpgsrcpy,prolog3
      *=====================================================================******
      * MAIN PROCESS LINE
      *=====================================================================******
      * Get program start time for calculating execution time
     C                   time                    timedata1
      * Parse input
     C                   exsr      Parse
      *
     C                   EXSR      INIT
     C                   CALLB     PGM
     C                   PARM                    BIBRID
     C                   PARM                    UsrSpcName
     C                   PARM                    UINN              1
     C                   IF        UINN = 'N'
     C                   GOTO      SLUTT
     C                   END
      * dato/tid siste vellykkede operasjon.
     C     WSUSER        CHAIN     BRIDF                              50
     C                   CALL      'SYGE15C'
     C                   PARM                    WDT               8
     C                   PARM                    WTM               6
     C                   MOVE      WDT           BIDTF
     C                   MOVE      WTM           BITIDF
     C                   UPDATE    BRIDFR
      *
      * Set output skeleton html member name
     C                   exsr      SetSkl
      *------------------                                                   ******
      * Write HTML sections
      *
      * 1-Section /$top
     C                   exsr      SetTop
     C                   callp     wrtsection('stdtop')
     C                   callp     wrtsection('top')
      * 4-Sections /$tablerow
      *
     C                   EXSR      HENTEM
      *
     C                   callp     updHTMLvar('ANTSND':
     C                             %trim(%editc(ANTSND:'3')))
     C                   callp     updHTMLvar('MaxSnd':
     C                             %trim(%editc(MaxSnd:'3')))
     C                   callp     updHTMLvar('ANTRCD':
     C                             %trim(%editc(ANTRCD:'3')))
     C                   callp     updHTMLvar('MaxRcd':
     C                             %trim(%editc(MaxRcd:'3')))
     C                   callp     updhtmlvar('runtime':
     C                             %trim(%editw(sec:'     0 .   ')))
      *
     C                   callp     wrtsection('bot')
     C                   callp     wrtsection('stdbot')
      *
      * 6-Section /$endhtml
     C     endhtml       tag
     C                   exsr      SetEnd
     C     SLUTT         tag
     C                   callp     wrtsection('endhtml')
      * Do not delete the call to wrtsection with section name *fini.  It is needed
      * to ensure that all output html that has been buffered gets output.
     C                   callp     wrtsection('*fini')
     C                   EXSR      EXIT
     C                   return
      *=====================================================================******
      * Parse input
      *=====================================================================******
     C     Parse         begsr
     C                   eval      lng     = zhbgetvar('lng')
     C                   eval      BckGnd  = zhbgetvar('bckgnd')
     C                   eval      WSUSER   = zhbgetvar('USER')
     C                   EVAL      WSNA    = zhbgetvar('WSNA')
     C                   EVAL      UsrSpcName  = zhbgetvar('UsrSpcName')
      *
     C                   eval      DATO     = zhbgetvar('DATO')
     C                   eval      DATON    = c2n2(DATO)
     C                   eval      KUNR2    = zhbgetvar('KUNR2')
     C                   eval      KUNR2N   = c2n2(KUNR2)
      *
     C                   endsr
      *=====================================================================******
      *  Set output variables for section /$top
      *  (search criteria)
      *=====================================================================******
     C     SetTop        begsr
      * Repeat national language for the next invocation
     C                   callp     updhtmlvar('LNG':lng:
     C                             InitHTMLVars)
     C                   callp     updHTMLvar('ROWHEAD':RowHead)
     C                   callp     updHTMLvar('LogoImg':LogoImg)
      * Color for text, background, links, visited links, active links
     C                   callp     updhtmlvar('TXTCOLOR':'black')
     C                   callp     updhtmlvar('BOLD':' ')
     C                   callp     updhtmlvar('BGCOLOR':BIFARG)
     C                   callp     updhtmlvar('LINK':'0000FF')
     C                   callp     updhtmlvar('VLINK':'FF0000')
     C                   callp     updhtmlvar('ALINK':'00FF00')
     C                   callp     updhtmlvar('TITLE':TITLE)
      *
     c                   move      KUNR2N        BIKUNR
     C     CUNDL01K      CHAIN     Cundl01                            33
      *
     C                   callp     updHTMLvar('USER':WSUSER)
     C                   callp     updHtmlVar('UsrSpcName':UsrSpcName)
     C                   callp     updHTMLvar('BESK':BIBESK)
     C                   callp     updHtmlVar('KUNDE':
     C                             %trim(%editc(BIKUNR:'Z')))
     C                   callp     updHTMLvar('KNAVN':KNAVN)
     C                   callp     updHtmlVar('WSNA':KNAVN)
      *
     C                   callp     updHTMLvar('DATO':
     C                             %trim(%editw(DATONF:'  .  .  ')))
     C                   callp     updHTMLvar('DATOT':
     C                             %trim(%editw(DATONT:'  .  .  ')))
     C                   callp     updHTMLvar('Kunr2':Kunr2)
      *
     C                   endsr
      *=====================================================================******
      *  Set output variables for section /$tablerow (table row)
      *=====================================================================******
     C     SetTabRow     begsr
      *
     c                   eval      WSUSE = XUSER  + '  Brukerid.'
     C                   callp     updHTMLvar('XTIL':XTIL)
      * statustekst
     c                   clear                   xstatt            7
     c     xstat         ifeq      'S'
     c                   eval      xstatt = 'Sendt'
     c                   end
     c     xstat         ifeq      ' '
     c                   eval      xstatt = 'Klar '
     c                   end
     c     xstat         ifeq      'D'
     c                   eval      xstatt = 'Slettet'
     c                   end
     C                   callp     updHTMLvar('XSTATT':XSTATT)
      * filnavn
     c                   clear                   ARTXT2
     c     xfile         chain     mailprtf                           33
     C                   callp     updHTMLvar('ARTXT2':ARTXT2)
     C                   move      XXdtÅ         XXDATOÅ
     C                   move      XXdtM         XXDATOM
     C                   move      XXdtD         XXDATOD
     C                   callp     updHTMLvar('XXDATO':
     C                             %trim(%editw(XXDATO:'  .  .  ')))
     C                   exsr      pdfurl
     C                   callp     updHTMLvar('UPDF':UPDF)
      *
     C                   endsr
      *=====================================================================******
      *  Set output variables for section /$endhtml
      *=====================================================================******
     C     SetEnd        begsr
      * Compute run time
     C                   time                    timedata2
     C     timedata2     subdur    timedata1     ms:*ms
     C                   eval      sec = ms / 1000000
     C                   callp     updhtmlvar('runtime':
     C                             %trim(%editw(sec:'     0 .   ')))
      *
     C                   endsr
      *=====================================================================******
     C*  Select a Recd
      *=====================================================================******
     C     RecordSlt     begsr
     C                   move      'N'           selected          1
      *
     C                   IF        TILDT6 = 0 OR XDATE >= TILDT6
     C                   move      'J'           selected
     C                   end
      *
     C                   endsr
      *
      *=====================================================================******
      * Set html output skeleton member before its read into memory
      *=====================================================================******
     C     SetSkl        begsr
      *------------------
      * Set html output skeleton member
     C                   eval      IfsMultIndicators = gethtmlifsmult(
     C                             '/syspeddev/html/Header/eSpedTop.html -
     C                             /syspeddev/html/ESMAIL1.html -
     C                             /syspeddev/html/Footer/eSpedBot.html':
     C                             '/CGITAG/')
      *
     C                   endsr
      *=====================================================================******
      * HENT EPOST
      *=====================================================================******
     C     HENTEM        BEGSR
      *
     C                   Move      *zeros        AntSnd
     C                   Move      *zeros        AntRcd
     C     MaxSnd        IFEQ      *ZEROS
     C                   Z-add     1000          MaxSnd
     C                   END
     C     MaxRcd        IFEQ      *ZEROS
     C                   Z-add     5000          MaxRcd
     C                   END
      *
     c     FraKey        setLL     MAILSPL3
     c     FrakeyE       ReadE     MAILSPL3                               35
      *
     C     *in35         doweq     '0'
     C                   Add       1             AntRcd
     C     AntRcd        CabGe     MaxRcd        SLHENTEM
      *
     C                   exsr      RecordSlt
      *
     C     selected      ifeq      'Y'
     C                   exsr      SetTabRow
     C                   callp     wrtsection('row')
     C                   Add       1             AntSnd
     C     AntSnd        CabGe     MaxSnd        SLHENTEM
     C                   endif
      *
     c     FrakeyE       ReadE     MAILSPL3                               35
     C                   ENDDO                                                  *hival
      *
     C     SLHENTEM      ENDSR
      *
      *=====================================================================******
      *  INITIER
      *=====================================================================******
     C     INIT          begsr
     C                   OPEN      BRIDF
     C     WSUSER        CHAIN(N)  BRIDF                              50
     C* En "standardvariant" libl: call bound (INCGI=*MODULE) med parameter.
     C     BILIBL        ifeq      *blanks
     C                   callb     'INCGI'
     C                   parm                    BISTDL
     C                   else
     C* Helt egen bibl.liste satt på user - normal CALL (BILIBL er "*pgm")
     C                   call      BILIBL
     C                   end
OddEv * hent Parametre som går igjen i mange prog:
OddEv *      Odd/Even/Rowhead-farger,Logobilde,Språk,Intern/Ekstern bruker,  mm
OddEvc                   call      'ESGETPAR'
OddEvc                   parm                    BIBRID
OddEvc                   parm                    BIFIRM
OddEvc                   parm                    BIKUNR
OddEvc                   parm                    BIKNG
OddEvc                   parm                    RowHead          10
OddEvc                   parm                    Odd              10
OddEvc                   parm                    Even             10
OddEvc                   parm                    LogoImg          50
OddEvc                   parm                    XSPRÅK            2
OddEvc                   parm                    XINTERN           1
OddEvc                   parm                    ParmDS1        1024
OddEvc                   parm                    ParmDS2        1024
OddEvc                   parm                    ParmDS3        1024
OddEv *
     C                   OPEN      CUNDL01
     C                   OPEN      MAILPRTF
     C                   OPEN      MAILSPl3
      *
     C     CUNDL01K      klist
     C                   kfld                    BIFIRM
     C                   kfld                    BIKUNR
     C     FraKey        KLIST
     C                   KFLD                    WSUSER
     C                   KFLD                    XXdato
     C     FraKeyE       KLIST
     C                   KFLD                    WSUSER
      *
     C     CUNDL01K      CHAIN     CUNDL01                            50
      *
     C                   endsr
      *=====================================================================******
      *  AVSLUTT
      *=====================================================================******
     C     EXIT          begsr
     C                   close     CUNDL01
     C                   CLOSE     MAILPRTF
     C                   CLOSE     MAILSPL3
     C                   eval      *inlr = *on
      *
     C                   endsr
      *
      ***********************************************
     C     pdfurl        BEGSR
      ***********************************************
     C* genererer bane for lagring av pdf
     c                   move      xdate         adate             6
     C                   move      *blanks       UPDF
     c     XSTAT         IFEQ      'S'
     c                   movel     '<a href="'   UPDF            200
     C     UPDF          CAT       '/':0         UPDF
     C     UPDF          CAT       'ep':0        UPDF
     C     UPDF          CAT       '/':0         UPDF
     C     UPDF          CAT       XUSER:0       UPDF
     C     UPDF          CAT       '/':0         UPDF
     C     UPDF          CAT       adate:0       UPDF
     C     UPDF          CAT       '_':0         UPDF
     C     UPDF          CAT       xjobna:0      UPDF
     C     UPDF          CAT       '_':0         UPDF
     C     UPDF          CAT       xjobno:0      UPDF
     C     UPDF          CAT       '_':0         UPDF
     C     UPDF          CAT       xsnbra:0      UPDF
     C     UPDF          CAT       '.pdf" ':0    UPDF
     C     UPDF          CAT       'target="_s':1UPDF
     C     UPDF          CAT       'elf">':0     UPDF
     C     UPDF          CAT       '<img src="':0UPDF
     C     UPDF          CAT       '/syspeddev':0UPDF
     C     UPDF          CAT       '/PDF.gif">':0UPDF
     c                   END
     c                   endsr
