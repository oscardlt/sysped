********************************************************************
      * RETTINGER I DETTE PROGRAM:
PTFnr:*Sek Sig Vers  Beskrivelse...........................
""""""*"""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""
12085 * 02 CB  PTF12 Oppdater extern referanse
12XXX * 03 CB  PTF12 Skapa nytt ärende via extern referans
12163 * 04 CB  PTF12 Signera direkt
12XXX * 05 CB  PTF12 Hardkoding valutakurs för SEK
12XXX * 06 YBC PTF12 Oppdatering av SVIH_RFAB
12257 * 07 YBC PTF12  3 nye felter og SVIH_MTYP endret til 5A
12265 * 08 YBC PTF12  2 nye felter
12269 * 09 YBC PTF12 Selger og kjøper
12XXX * 10 YBC PTF12 Send status b ved svih_mtyp starter med IMD
12283 * 11 YBC PTF12 2 nye felter
********************************************************************
      *********************************************************************
CRTPG+*  CRTPGM SYSPED/TSVI002R MODULE(*LIBL/TSVI002R *LIBL/INCGI)
CRTPGM*        ACTGRP(*NEW) AUT(*USE)
      *********************************************************************
      /copy SYSPEDS/qrpgsrcpy,hspecs
      /copy SYSPEDS/qrpgsrcpy,hspecsbnd
      *********************************************************************
     FBRIDF     IF   E           K DISK    USROPN
     FSVIH      UF A E           K DISK    USROPN
     F                                     PREFIX(X)
     FSVIV1     IF A E           K DISK    USROPN
     FSVIA      UF   E           K DISK    USROPN
     FSVIF      O    E             DISK    USROPN
     FSVTHA2    IF   E           K DISK    USROPN
     FSAEH      IF   E           K DISK    USROPN
     FHEADF     UF   E           K DISK    USROPN
     FCUNDL01   IF   E           K DISK    USROPN
KING FKUNDL01   IF   E           K DISK    PREFIX(X_)
KING F                                     RENAME(KUNDR:KUNDRX)
     F                                     USROPN
     FFIRM      IF   E             DISK    USROPN
     FSYPARL1   IF   E           K DISK    USROPN
N01  FFRISOK    UF A E           K DISK    USROPN
N03  FFRISOL01  IF   E           K DISK    USROPN
     F                                     RENAME(FRISOKR:FRISOKRL)
N04  FEDIC      UF   E             DISK    USROPN
N04  FSVTFI     IF   E             DISK    USROPN
N04  FEDIM      O  A E             DISK    USROPN
      *--------------------------------------------------------------------
      * Variables common to all CGIs
      *--------------------------------------------------------------------
      /copy SYSPEDS/qrpgsrcpy,prototypeb
      /copy SYSPEDS/qrpgsrcpy,usec
      /copy SYSPEDS/qrpgsrcpy,variables3
      *
      * Varible for
     D P               S              5U 0
     D WSUSER          S             10
     D SVIH_SYAVA      S              4
     D SVIH_SYAV       S              4  0
     D NEWSYAVA        S              4
     D NEWAVD          S              4  0
     D SVIH_SYOPA      S              7
     D SVIH_SYOP       S              7  0
     D NEWOPD          S              7  0
     D WMODE           S              2
     D WSIGN           S              3
     D NEWSIGN         S              3
     D SVIH_SYSG       S              3
     D SVIH_SYST       S              1
     D SVIH_SYDT       S              8
     D SVIH_SYDTN      S              8  0
S07  D*SVIH_MTYP       S              3
N07  D SVIH_MTYP       S              5
     D SVIH_TUID       S             10
     D SVIH_KENH       S             35
     D SVIH_DEK1       S              2
     D SVIH_DEK2       S              1
     D SVIH_TART       S              1
     D SVIH_AVKN       S              8
     D SVIH_AVKNN      S              8  0
     D SVIH_AVEO       S             17
     D SVIH_AVNA       S             35
     D SVIH_AVA1       S             35
     D SVIH_AVA2       S             35
     D SVIH_AVPN       S              9
     D SVIH_AVPA       S             35
     D SVIH_AVLK       S              2
     D SVIH_KOTA       S              8
     D SVIH_KOTAN      S              8  0
     D SVIH_RFAB       S             17
     D SVIH_RFAC       S             35
     D SVIH_RFAC2      S             35
     D SVIH_MOKN       S              8
     D SVIH_MOKNN      S              8  0
     D SVIH_MOEO       S             17
     D SVIH_MONA       S             35
     D SVIH_MOA1       S             35
     D SVIH_MOA2       S             35
     D SVIH_MOPN       S              9
     D SVIH_MOPA       S             35
     D SVIH_MOLK       S              2
     D SVIH_MOHA       S             35
     D SVIH_MOTL       S             25
     D SVIH_VUFO       S             11
     D SVIH_VUFON      S             11  3
     D SVIH_VUFR       S             11
     D SVIH_VUFRN      S             11  3
     D SVIH_VUVA       S              3
     D SVIH_VUKU       S              7
     D SVIH_VUKUN      S              7  4
     D SVIH_OVKO       S             11
     D SVIH_OVKON      S             11  3
     D SVIH_KARA       S             11
     D SVIH_KARAN      S             11  3
     D SVIH_ANRA       S             11
     D SVIH_ANRAN      S             11  3
     D SVIH_KVSA       S              1
     D SVIH_DKKN       S              8
     D SVIH_DKKNN      S              8  0
     D SVIH_DKEO       S             17
     D SVIH_DKLK       S              2
     D SVIH_DKNA       S             35
     D SVIH_DKA1       S             35
     D SVIH_DKA2       S             35
     D SVIH_DKPA       S             35
     D SVIH_DKPN       S              9
     D SVIH_DKHA       S             35
     D SVIH_DKTL       S             25
N09  D SVIH_SEKN       S              8
N09  D SVIH_SEKNN      S              8  0
N09  D SVIH_SEEO       S             17
N09  D SVIH_SENA       S             35
N09  D SVIH_SEA1       S             35
N09  D SVIH_SEA2       S             35
N09  D SVIH_SEPN       S              9
N09  D SVIH_SEPA       S             35
N09  D SVIH_SELK       S              2
N09  D SVIH_SEHA       S             35
N09  D SVIH_SETL       S             25
N09  D SVIH_KOKN       S              8
N09  D SVIH_KOKNN      S              8  0
N09  D SVIH_KOEO       S             17
N09  D SVIH_KONA       S             35
N09  D SVIH_KOA1       S             35
N09  D SVIH_KOA2       S             35
N09  D SVIH_KOPN       S              9
N09  D SVIH_KOPA       S             35
N09  D SVIH_KOLK       S              2
N09  D SVIH_KOHA       S             35
N09  D SVIH_KOTL       S             25
N11  D SVIH_TRKD       S              3
N11  D SVIH_TRBI       S             35
     D SVIH_OMEO       S             17
     D SVIH_OMTY       S              1
     D SVIH_OMHA       S             35
     D SVIH_OMTL       S             25
     D SVIH_AVUT       S              2
     D SVIH_AUKD       S              2
     D SVIH_TRID       S             35
     D SVIH_TRLK       S              2
     D SVIH_CONT       S              2
     D SVIH_LEKD       S              3
     D SVIH_LEOR       S             25
     D SVIH_TRAI       S             35
     D SVIH_TRAL       S              2
     D SVIH_FATY       S              4
     D SVIH_FATX       S             17
     D SVIH_VAKD       S              3
     D SVIH_VAKU       S              7
     D SVIH_VAKUN      S              7  4
     D SVIH_FABL       S             11
     D SVIH_FABLN      S             11  3
     D SVIH_TRGR       S              1
     D SVIH_TRIN       S              1
     D SVIH_GRKD       S             17
     D SVIH_GOLK       S              4
     D SVIH_BRUT       S             12
     D SVIH_BRUTN      S             12  3
     D SVIH_SUTI       S             17
     D SVIH_ABUB       S             35
     D SVIH_EUP1       S              4
     D SVIH_EUP2       S              3
     D SVIH_UPPS       S              1
     D SVIH_KLEO       S             17
     D SVIH_TRNR       S             20
     D SVIH_SGDK       S              6
     D SVIH_SGME       S              3
     D SVIH_SGUT       S              6
     D SVIH_SGID       S             10
     D SVIH_SGDT       S             12
     D SVIH_BYTE       S              7
     D SVIH_BYTEN      S              7  0
     D SVIH_KVAL       S              1
     D SVIH_GODN       S             15
     D SVIH_0035       S              1
N07  D SVIH_SYST2      S              3
N07  D SVIH_LRN        S             22
N07  D SVIH_MRN        S             22
N08  D SVIH_OMEM       S             35
N08  D SVIH_DKEM       S             35
N01  D H_XREF          S             35
N03  D WSVIH_XREF      S             35
     D JSONstring      S          32000
     D Error           S            150
N04   *   SYEDI data area
N04  D EDIDTA          DS           256
N04  D  UELIBF               171    180

      *get input-string
      /copy syspeds/qrpgsrcpy,prolog3

      * Parse input
     C                   EXSR      Parse
      * Open files etc
     C                   EXSR      INIT
      *
     c                   callp     gethtmlifs(
     C                             '/syspeddev/html/JSON.html':
     C                             '/CGITAG/')
     C                   callp     wrtsection('top')
      * Teste input og utfør
     C  N50              EXSR      TEST

      * ............................................................................................
      * skriv JSON-Object start..(alltid '{' + x ant param. m/komma mellom (IKKE komma etter siste))
      * ............................................................................................
      *
      /free
        JSONstring='{'
        +'¬user¬ : ¬'+%trim(WSUSER)+'¬, '
        +'¬svih_syav¬ : ¬'+%trim(%editc(SVIH_SYAV:'Z'))+'¬, '
        +'¬newavd¬ : ¬'+%trim(%editc(NEWAVD:'Z'))+'¬, '
        +'¬svih_syop¬ : ¬'+%trim(%editc(SVIH_SYOP:'Z'))+'¬, '
        +'¬newopd¬ : ¬'+%trim(%editc(NEWOPD:'Z'))+'¬, '
        +'¬sign¬ : ¬'+%trim(WSIGN)+'¬, '
        +'¬newsign¬ : ¬'+%trim(NEWSIGN)+'¬, '
        +'¬mode¬ : ¬'+%trim(WMODE)+'¬, '
        +'¬errMsg¬ : ¬'+%trim(Error)+'¬, '
        +'¬svih_tuid¬ : ¬'+%trim(SVIH_TUID)+'¬, '
        +'¬svih_omeo¬ : ¬'+%trim(SVIH_OMEO)+'¬, '
        +'¬svth_namn¬ : ¬'+%trim(SVTH_NAMN)+'¬, '
        +'¬svth_tlf¬ : ¬'+%trim(SVTH_TLF)+'¬, '
        +'¬svia_omty¬ : ¬'+%trim(SVIA_OMTY)+'¬, '
        +'¬svia_0035¬ : ¬'+%trim(SVIA_0035)+'¬, ';
      /end-free
      * JSONfix escaper " i tekst,  for deretter å bytte ¬->"
     c                   call      'JSONFIX'
     c                   parm                    JSONstring
     C                   callp     updHTMLvar('JSONstring':JSONstring)
     C                   callp     wrtsection('JSONlin')
      *
      * ............................................................................................
      * Skriv JSON-LISTE Start (en liste er EN parameter(fra [ til   )
      * ............................................................................................
     c                   eval      JSONstring ='"orderupdate" : ['
     C                   callp     updHTMLvar('JSONstring':JSONstring)
     C                   callp     wrtsection('JSONlin')
      * ............................................................................................
      * Skriv JSON-Liste/Array  Avslutning
      * ............................................................................................
     c                   eval      JSONstring =']'
     C                   callp     updHTMLvar('JSONstring':JSONstring)
     C                   callp     wrtsection('JSONlin')
      * ............................................................................................
      * Skriv JSON-string Avsluttning
      * ............................................................................................
     c                   eval      JSONstring ='}'
     C                   callp     updHTMLvar('JSONstring':JSONstring)
     C                   callp     wrtsection('JSONlin')
      *
      * Quit
     C                   exsr      Exit


      *=====================================================================
      * Close output html and quit
      *=====================================================================
     C     Exit          begsr
      * Lukk fil
     C                   CLOSE     BRIDF
     C  N50              CLOSE     SVIH
     C  N50              CLOSE     SVIV1
     C  N50              CLOSE     SVIA
     C  N50              CLOSE     SVTHA2
     C  N50              CLOSE     SAEH
     C  N50              CLOSE     HEADF
     C  N50              CLOSE     CUNDL01
     C  N50              CLOSE     KUNDL01
     C  N50              CLOSE     FIRM
     C  N50              CLOSE     SVIF
     C  N50              CLOSE     SYPARL1
N01  C  N50              CLOSE     FRISOK
N03  C  N50              CLOSE     FRISOL01
N04  C  N50              CLOSE     EDIC
N04  C  N50              CLOSE     SVTFI
N04  C  N50              CLOSE     EDIM

      * Do not delete the call to wrtsection with section name *fini.  It is needed
      * to ensure that all output html that has been buffered gets output.
     C                   callp     wrtsection('*fini')
      * Quit
     C                   MOVE      *ON           *INLR
     C                   return
     C                   endsr
      *
      *********************************************************
     C     Parse         Begsr
      *********************************************************
      * Get input
     C                   EVAL      WSUSER  = zhbgetvar('USER')
     C                   EVAL      SVIH_SYAVA = zhbgetvar('AVD')
     C                   EVAL      SVIH_SYAV  = c2n2(SVIH_SYAVA)
     C                   EVAL      NEWSYAVA = zhbgetvar('NEWAVD')
     C                   EVAL      NEWAVD  = c2n2(NEWSYAVA)
     C                   EVAL      SVIH_SYOPA = zhbgetvar('OPD')
     C                   EVAL      SVIH_SYOP  = c2n2(SVIH_SYOPA)
     C                   EVAL      WMODE  = zhbgetvar('MODE')
     C                   EVAL      SVIH_SYSG  = zhbgetvar('SVIH_SYSG')
     C                   EVAL      WSIGN      = zhbgetvar('SIGN')
     C                   EVAL      NEWSIGN      = zhbgetvar('NEWSIGN')
     C                   EVAL      SVIH_SYST  = zhbgetvar('SVIH_SYST')
     C                   EVAL      SVIH_SYDT=   zhbgetvar('SVIH_SYDT')
     C                   EVAL      SVIH_SYDTN = c2n2(SVIH_SYDT)
     C                   EVAL      SVIH_MTYP=   zhbgetvar('SVIH_MTYP')
     C                   EVAL      SVIH_TUID=   zhbgetvar('SVIH_TUID')
     C                   EVAL      SVIH_KENH=   zhbgetvar('SVIH_KENH')
     C                   EVAL      SVIH_DEK1=   zhbgetvar('SVIH_DEK1')
     C                   EVAL      SVIH_DEK2=   zhbgetvar('SVIH_DEK2')
     C                   EVAL      SVIH_TART=   zhbgetvar('SVIH_TART')
     C                   EVAL      SVIH_AVKN=   zhbgetvar('SVIH_AVKN')
     C                   EVAL      SVIH_AVKNN = c2n2(SVIH_AVKN)
     C                   EVAL      SVIH_AVEO=   zhbgetvar('SVIH_AVEO')
     C                   EVAL      SVIH_AVNA=   zhbgetvar('SVIH_AVNA')
     C                   EVAL      SVIH_AVA1=   zhbgetvar('SVIH_AVA1')
     C                   EVAL      SVIH_AVA2=   zhbgetvar('SVIH_AVA2')
     C                   EVAL      SVIH_AVPN=   zhbgetvar('SVIH_AVPN')
     C                   EVAL      SVIH_AVPA=   zhbgetvar('SVIH_AVPA')
     C                   EVAL      SVIH_AVLK=   zhbgetvar('SVIH_AVLK')
     C                   EVAL      SVIH_KOTA=   zhbgetvar('SVIH_KOTA')
     C                   EVAL      SVIH_KOTAN = c2n2(SVIH_KOTA)
S06  C*                  EVAL      SVIH_RFAB=   zhbgetvar('SVIH_RFAB')
     C                   EVAL      SVIH_RFAC=   zhbgetvar('SVIH_RFAC')
     C                   EVAL      SVIH_RFAC2=  zhbgetvar('SVIH_RFAC2')
     C                   EVAL      SVIH_MOKN=   zhbgetvar('SVIH_MOKN')
     C                   EVAL      SVIH_MOKNN = c2n2(SVIH_MOKN)
     C                   EVAL      SVIH_MOEO=   zhbgetvar('SVIH_MOEO')
     C                   EVAL      SVIH_MONA=   zhbgetvar('SVIH_MONA')
     C                   EVAL      SVIH_MOA1=   zhbgetvar('SVIH_MOA1')
     C                   EVAL      SVIH_MOA2=   zhbgetvar('SVIH_MOA2')
     C                   EVAL      SVIH_MOPN=   zhbgetvar('SVIH_MOPN')
     C                   EVAL      SVIH_MOPA=   zhbgetvar('SVIH_MOPA')
     C                   EVAL      SVIH_MOLK=   zhbgetvar('SVIH_MOLK')
     C                   EVAL      SVIH_MOHA=   zhbgetvar('SVIH_MOHA')
     C                   EVAL      SVIH_MOTL=   zhbgetvar('SVIH_MOTL')
     C                   EVAL      SVIH_VUFO=   zhbgetvar('SVIH_VUFO')
     C                   EVAL      SVIH_VUFON = c2n2(SVIH_VUFO)
     C                   EVAL      SVIH_VUFR=   zhbgetvar('SVIH_VUFR')
     C                   EVAL      SVIH_VUFRN = c2n2(SVIH_VUFR)
     C                   EVAL      SVIH_VUVA=   zhbgetvar('SVIH_VUVA')
     C                   EVAL      SVIH_VUKU=   zhbgetvar('SVIH_VUKU')
     C                   EVAL      SVIH_VUKUN = c2n2(SVIH_VUKU)
N05  C                   IF        SVIH_VUVA='SEK'
N05  C                   EVAL      SVIH_VUKUN = 1
N05  C                   ENDIF
     C                   EVAL      SVIH_OVKO=   zhbgetvar('SVIH_OVKO')
     C                   EVAL      SVIH_OVKON = c2n2(SVIH_OVKO)
     C                   EVAL      SVIH_KARA=   zhbgetvar('SVIH_KARA')
     C                   EVAL      SVIH_KARAN = c2n2(SVIH_KARA)
     C                   EVAL      SVIH_ANRA=   zhbgetvar('SVIH_ANRA')
     C                   EVAL      SVIH_ANRAN = c2n2(SVIH_ANRA)
     C                   EVAL      SVIH_KVSA=   zhbgetvar('SVIH_KVSA')
     C                   EVAL      SVIH_DKKN=   zhbgetvar('SVIH_DKKN')
     C                   EVAL      SVIH_DKKNN = c2n2(SVIH_DKKN)
     C                   EVAL      SVIH_DKEO=   zhbgetvar('SVIH_DKEO')
     C                   EVAL      SVIH_DKLK=   zhbgetvar('SVIH_DKLK')
     C                   EVAL      SVIH_DKNA=   zhbgetvar('SVIH_DKNA')
     C                   EVAL      SVIH_DKA1=   zhbgetvar('SVIH_DKA1')
     C                   EVAL      SVIH_DKA2=   zhbgetvar('SVIH_DKA2')
     C                   EVAL      SVIH_DKPA=   zhbgetvar('SVIH_DKPA')
     C                   EVAL      SVIH_DKPN=   zhbgetvar('SVIH_DKPN')
     C                   EVAL      SVIH_DKHA=   zhbgetvar('SVIH_DKHA')
     C                   EVAL      SVIH_DKTL=   zhbgetvar('SVIH_DKTL')
N09  C                   EVAL      SVIH_SEKN=   zhbgetvar('SVIH_SEKN')
N09  C                   EVAL      SVIH_SEKNN = c2n2(SVIH_SEKN)
N09  C                   EVAL      SVIH_SEEO=   zhbgetvar('SVIH_SEEO')
N09  C                   EVAL      SVIH_SENA=   zhbgetvar('SVIH_SENA')
N09  C                   EVAL      SVIH_SEA1=   zhbgetvar('SVIH_SEA1')
N09  C                   EVAL      SVIH_SEA2=   zhbgetvar('SVIH_SEA2')
N09  C                   EVAL      SVIH_SEPN=   zhbgetvar('SVIH_SEPN')
N09  C                   EVAL      SVIH_SEPA=   zhbgetvar('SVIH_SEPA')
N09  C                   EVAL      SVIH_SELK=   zhbgetvar('SVIH_SELK')
N09  C                   EVAL      SVIH_SEHA=   zhbgetvar('SVIH_SEHA')
N09  C                   EVAL      SVIH_SETL=   zhbgetvar('SVIH_SETL')
N09  C                   EVAL      SVIH_KOKN=   zhbgetvar('SVIH_KOKN')
N09  C                   EVAL      SVIH_KOKNN = c2n2(SVIH_KOKN)
N09  C                   EVAL      SVIH_KOEO=   zhbgetvar('SVIH_KOEO')
N09  C                   EVAL      SVIH_KONA=   zhbgetvar('SVIH_KONA')
N09  C                   EVAL      SVIH_KOA1=   zhbgetvar('SVIH_KOA1')
N09  C                   EVAL      SVIH_KOA2=   zhbgetvar('SVIH_KOA2')
N09  C                   EVAL      SVIH_KOPN=   zhbgetvar('SVIH_KOPN')
N09  C                   EVAL      SVIH_KOPA=   zhbgetvar('SVIH_KOPA')
N09  C                   EVAL      SVIH_KOLK=   zhbgetvar('SVIH_KOLK')
N09  C                   EVAL      SVIH_KOHA=   zhbgetvar('SVIH_KOHA')
N09  C                   EVAL      SVIH_KOTL=   zhbgetvar('SVIH_KOTL')
N11  C                   EVAL      SVIH_TRKD=   zhbgetvar('SVIH_TRKD')
N11  C                   EVAL      SVIH_TRBI=   zhbgetvar('SVIH_TRBI')
     C                   EVAL      SVIH_OMEO=   zhbgetvar('SVIH_OMEO')
     C                   EVAL      SVIH_OMTY=   zhbgetvar('SVIH_OMTY')
     C                   EVAL      SVIH_OMHA=   zhbgetvar('SVIH_OMHA')
     C                   EVAL      SVIH_OMTL=   zhbgetvar('SVIH_OMTL')
     C                   EVAL      SVIH_AVUT=   zhbgetvar('SVIH_AVUT')
     C                   EVAL      SVIH_AUKD=   zhbgetvar('SVIH_AUKD')
     C                   EVAL      SVIH_TRID=   zhbgetvar('SVIH_TRID')
     C                   EVAL      SVIH_TRLK=   zhbgetvar('SVIH_TRLK')
     C                   EVAL      SVIH_CONT=   zhbgetvar('SVIH_CONT')
     C                   EVAL      SVIH_LEKD=   zhbgetvar('SVIH_LEKD')
     C                   EVAL      SVIH_LEOR=   zhbgetvar('SVIH_LEOR')
     C                   EVAL      SVIH_TRAI=   zhbgetvar('SVIH_TRAI')
     C                   EVAL      SVIH_TRAL=   zhbgetvar('SVIH_TRAL')
     C                   EVAL      SVIH_FATY=   zhbgetvar('SVIH_FATY')
     C                   EVAL      SVIH_FATX=   zhbgetvar('SVIH_FATX')
     C                   EVAL      SVIH_VAKD=   zhbgetvar('SVIH_VAKD')
     C                   EVAL      SVIH_VAKU=   zhbgetvar('SVIH_VAKU')
     C                   EVAL      SVIH_VAKUN = c2n2(SVIH_VAKU)
N05  C                   IF        SVIH_VAKD='SEK'
N05  C                   EVAL      SVIH_VAKUN = 1
N05  C                   ENDIF
     C                   EVAL      SVIH_FABL=   zhbgetvar('SVIH_FABL')
     C                   EVAL      SVIH_FABLN = c2n2(SVIH_FABL)
     C                   EVAL      SVIH_TRGR=   zhbgetvar('SVIH_TRGR')
     C                   EVAL      SVIH_TRIN=   zhbgetvar('SVIH_TRIN')
     C                   EVAL      SVIH_GRKD=   zhbgetvar('SVIH_GRKD')
     C                   EVAL      SVIH_GOLK=   zhbgetvar('SVIH_GOLK')
     C                   EVAL      SVIH_BRUT=   zhbgetvar('SVIH_BRUT')
     C                   EVAL      SVIH_BRUTN = c2n2(SVIH_BRUT)
     C                   EVAL      SVIH_SUTI=   zhbgetvar('SVIH_SUTI')
     C                   EVAL      SVIH_ABUB=   zhbgetvar('SVIH_ABUB')
     C                   EVAL      SVIH_EUP1=   zhbgetvar('SVIH_EUP1')
     C                   EVAL      SVIH_EUP2=   zhbgetvar('SVIH_EUP2')
     C                   EVAL      SVIH_UPPS=   zhbgetvar('SVIH_UPPS')
     C                   EVAL      SVIH_KLEO=   zhbgetvar('SVIH_KLEO')
     C                   EVAL      SVIH_TRNR=   zhbgetvar('SVIH_TRNR')
     C                   EVAL      SVIH_SGDK=   zhbgetvar('SVIH_SGDK')
     C                   EVAL      SVIH_SGME=   zhbgetvar('SVIH_SGME')
     C                   EVAL      SVIH_SGUT=   zhbgetvar('SVIH_SGUT')
     C                   EVAL      SVIH_SGID=   zhbgetvar('SVIH_SGID')
     C                   EVAL      SVIH_SGDT=   zhbgetvar('SVIH_SGDT')
     C                   EVAL      SVIH_BYTE=   zhbgetvar('SVIH_BYTE')
     C                   EVAL      SVIH_KVAL=   zhbgetvar('SVIH_KVAL')
     C                   EVAL      SVIH_BYTE=   zhbgetvar('SVIH_BYTE')
     C                   EVAL      SVIH_BYTEN = c2n2(SVIH_BYTE)
     C                   EVAL      SVIH_KVAL=   zhbgetvar('SVIH_KVAL')
     C                   EVAL      SVIH_GODN=   zhbgetvar('SVIH_GODN')
     C                   EVAL      SVIH_0035=   zhbgetvar('SVIH_0035')
N07  C                   EVAL      SVIH_SYST2 = zhbgetvar('SVIH_SYST2')
N07  C                   EVAL      SVIH_LRN =   zhbgetvar('SVIH_LRN')
N07  C                   EVAL      SVIH_MRN =   zhbgetvar('SVIH_MRN')
N08  C                   EVAL      SVIH_OMEM  = zhbgetvar('SVIH_OMEM')
N08  C                   EVAL      SVIH_DKEM  = zhbgetvar('SVIH_DKEM')
N01  C                   EVAL      H_XREF=      zhbgetvar('H_XREF')
N01  C                   EVAL      WSVIH_XREF=      zhbgetvar('SVIH_XREF')
     c                   ENDSR
      *********************************************************
     C     INIT          Begsr
      *********************************************************
     C                   OPEN      BRIDF
      * Test innlogging
     C     WSUSER        CHAIN     BRIDF                              50
     C  N50BILIBL        ifeq      *blanks
     C                   callb     'INCGI'
     C                   parm                    BISTDL
     C                   else
     C                   call      BILIBL
     C                   end
      *
     C     SVIHKey       klist
     C                   kfld                    SVIH_SYAV
     C                   kfld                    SVIH_SYOP
     C     CUNDL01K      KLIST
     C                   KFLD                    FIFIRM
     C                   KFLD                    KUNDNR
     C     SYPARKEY      KLIST
     C                   KFLD                    WSYKUNR
     C                   KFLD                    WSYPAID
N01  C     FRIKEY        klist
N01  C                   kfld                    SVIH_SYAV
N01  C                   kfld                    SVIH_SYOP
N01  C                   kfld                    WFSKODE           3
N03  C     FRIKEY01      KLIST
N03  C                   KFLD                    WFSKODE
N03  C                   KFLD                    WSVIH_XREF
     C     *LIKE         DEFINE    SVIH_AVPA     W_PADR
     C     *LIKE         DEFINE    SYKUNR        WSYKUNR
     C     *LIKE         DEFINE    SYPAID        WSYPAID
     C                   EVAL      WSYPAID='SEMVA'
N01  C                   EVAL      WFSKODE='*CR'
      *
     C   50              eval      Error = 'Invalid userID'
     C  N50              OPEN      SVIH
     C  N50              OPEN      SVIV1
     C  N50              OPEN      SVIA
     C  N50              OPEN      SVTHA2
     C  N50              OPEN      SAEH
     C  N50              OPEN      HEADF
     C  N50              OPEN      CUNDL01
     C  N50              OPEN      KUNDL01
     C  N50              OPEN      FIRM
     C  N50              OPEN      SVIF
     C  N50              OPEN      SYPARL1
N01  C  N50              OPEN      FRISOK
N03  C  N50              OPEN      FRISOL01
N04  C  N50              OPEN      EDIC
N04  C  N50              OPEN      SVTFI
N04  C  N50              OPEN      EDIM
N04   * Hæmta firmaupplysningar
N04  C  N501             CHAIN     SVTFI                              51
N04   * Hæmta næsta meddelandenummer
N04  C     WMODE         IFEQ      'S'
N04  C     *IN50         IFEQ      *OFF
N04  C     1             CHAIN     EDIC
N04  C                   ADD       1             CMN
N04  C                   UPDATE    EDICR
N04  C                   ENDIF
N04  C                   ENDIF
N04   * Åpne dataarea
N04  C     *DTAARA       DEFINE                  EDIDTA
N04  C                   IN        EDIDTA
      *_________________________________
      * Hæmta dagens datum och klockslag
      *"""""""""""""""""""""""""""""""""
     C                   CALL      'SYGE15C'
     C                   PARM                    WDT               8
     C                   PARM                    WTM               6
      * Hæmta firmaopplysninger
     C  N50              READ      FIRM

      * MODE=GS
     C     WMODE         IFEQ      'GS'
     C     WSVIH_XREF    ANDNE     *BLANKS
     C     *IN50         ANDEQ     *OFF
     C     FRIKEY01      CHAIN     FRISOL01                           56
     C                   IF        *IN56=*OFF
     C                   EVAL      SVIH_SYAV=FSAVD
     C                   EVAL      SVIH_SYOP=FSOPD
     C                   ENDIF
     C                   ENDIF

     c                   endsr
      *
      *______________________________________________________
      * TEST                                             TEST
      *""""""""""""""""""""""""""""""""""""""""""""""""""""""
     C     TEST          BEGSR
      * Hæmta userid
     C     WSUSER        CHAIN     SVTHA2
      * Hæmta ærende
     C     WMODE         IFNE      'A'
     C     SVIHKey       CHAIN     SVIH                               55
     C                   ENDIF
      * MODE A=Add  D=Delete  U=Update  S=Skicka till signering   C=Copy  GS=Hæmta från SYSPED
     C                   SELECT
     C     WMODE         WHENEQ    'A'
     C                   eval      Error = *blanks
     C                   EXSR      SRA
     C     WMODE         WHENEQ    'GS'
     C                   eval      Error = *blanks
     C  N55              eval      Error = 'Fel, finns redan'
     C   55              EXSR      SRGS
     C     WMODE         WHENEQ    'C'
     C                   IF        *IN55=*ON
     C                   eval      Error = 'Order not found'
     C                   ELSE
     C                   UPDATE    SVIHR
     C                   eval      Error = *blanks
     C                   EXSR      SRC
     C                   ENDIF
     C     WMODE         WHENEQ    'D'
     C                   IF        *IN55=*ON
     C                   eval      Error = 'Order not found'
     C                   ELSE
     C                   eval      Error = *blanks
     C                   EXSR      SRD
     C                   ENDIF
     C     WMODE         WHENEQ    'S'
     C                   IF        *IN55=*ON
     C                   eval      Error = 'Order not found'
     C                   ELSE
     C                   eval      Error = *blanks
     C                   EXSR      SRS
     C                   ENDIF
     C     WMODE         WHENEQ    'U'
     C                   IF        *IN55=*ON
     C                   eval      Error = 'Order not found'
     C                   ELSE
     C                   eval      Error = *blanks
     C                   EXSR      SRU
     C                   ENDIF
     C                   OTHER
     C                   eval      Error = 'Wrong mode'
     C                   ENDSL
     C                   ENDSR
      *______________________________________________________
      * Add                                               SRA
      *""""""""""""""""""""""""""""""""""""""""""""""""""""""
     C     SRA           BEGSR
     C                   CLEAR                   SVIHR
      * Hæmta uppdragsnummer
     C     SVIH_SYAV     CHAIN     SVIA                               52
     C                   ADD       1             SVIA_SYOP
     C                   UPDATE    SVIAR
     C                   EVAL      XSVIH_SYAV=SVIH_SYAV
     C                   EVAL      SVIH_SYOP=SVIA_SYOP
     C                   EVAL      XSVIH_SYOP=SVIH_SYOP
     C                   EVAL      XSVIH_SYSG=WSIGN
     C                   MOVEL     WDT           XSVIH_SYDT
      * Hæmta tullid
     C                   CALL      'SVG001R'
     C                   PARM                    XSVIH_TUID
     C                   EVAL      SVIH_TUID=XSVIH_TUID
      * Write
N06  C                   MOVEL     XSVIH_SYAV    XVIH_RFAB        11
N06  C                   MOVE      XSVIH_SYOP    XVIH_RFAB
N06  C                   MOVEL     XVIH_RFAB     XSVIH_RFAB
     C                   WRITE     SVIHR
     C                   ENDSR
      *______________________________________________________
      * Delete                                            SRD
      *""""""""""""""""""""""""""""""""""""""""""""""""""""""
     C     SRD           BEGSR
     C                   EVAL      XSVIH_SYST='D'
     C                   UPDATE    SVIHR
     C                   ENDSR
      *______________________________________________________
      * Skicka                                            SRS
      *""""""""""""""""""""""""""""""""""""""""""""""""""""""
     C     SRS           BEGSR
      * Tvungen testindikator ?
     C     XSVIH_0035    IFEQ      *BLANKS
     C     XSVIH_SYAV    CHAIN(N)  SVIA
     C     SVIA_0035     IFNE      *BLANKS
     C                   EVAL      XSVIH_0035=SVIA_0035
     C                   ENDIF
     C                   ENDIF

     C                   UPDATE    SVIHR
     C                   eval      Error = *blanks
      *____________________
      * Skapa edifact + fil
      *""""""""""""""""""""
     C                   CALL      'SVI021R'
     C                   PARM                    SVIH_SYAV
     C                   PARM                    SVIH_SYOP
N04   *_____________
N04   * Ændra status
N04   *"""""""""""""
N04  C     SVIHKEY       CHAIN     SVIH
N10  C                   IF        %SUBST(xsvih_mtyp:1:3) = 'IMD'
N10  C                   EVAL      XSVIH_SYST='q'
N10  C                   ELSE
N04  C                   EVAL      XSVIH_SYST='A'
N10  C                   END
N04  C                   UPDATE    SVIHR
N04   *_______________
N04   * Skriv til EDIM
N04   *"""""""""""""""
N10  C                   IF        %SUBST(xsvih_mtyp:1:3) <> 'IMD'
N04  C                   CLEAR                   EDIMR
N04  C                   EVAL      M0004=SVTF_0004
N04  C                   EVAL      M0010=SVTF_0010
N04  C                   EVAL      M0035=XSVIH_0035
N04  C                   MOVEL     XSVIH_SYAV    W0062            11
N04  C                   MOVE      XSVIH_SYOP    W0062
N04  C                   EVAL      M0062=W0062
N04  C                   EVAL      M0065='CUSDEC'
N04  C                   EVAL      M1001=XSVIH_MTYP
N04  C                   EVAL      M1004=XSVIH_TUID
N04  C                   EVAL      M1225=XSVIH_MTYP
N04  C                   EVAL      M1N07='SVI'
N04  C                   EVAL      MMN=CMN
N04  C                   EVAL      MSR='S'
N04  C                   MOVEL     WDT           MDT
N04  C                   MOVEL     WTM           MTM
N04  C                   EVAL      MAVD=XSVIH_SYAV
N04  C                   EVAL      MTDN=XSVIH_SYOP
N04
N04  C                   WRITE     EDIMR
N10  C                   END
     C                   ENDSR
      *______________________________________________________
      * Update                                            SRU
      *""""""""""""""""""""""""""""""""""""""""""""""""""""""
     C     SRU           BEGSR
     C                   EVAL      XSVIH_SYST=SVIH_SYST
     C                   EVAL      XSVIH_SYSG=SVIH_SYSG
     C                   EVAL      XSVIH_MTYP=SVIH_MTYP
     C                   EVAL      XSVIH_KENH=SVIH_KENH
     C                   EVAL      XSVIH_DEK1=SVIH_DEK1
     C                   EVAL      XSVIH_DEK2=SVIH_DEK2
     C                   EVAL      XSVIH_TART=SVIH_TART
     C                   EVAL      XSVIH_AVKN=SVIH_AVKNN
     C                   EVAL      XSVIH_AVEO=SVIH_AVEO
     C                   EVAL      XSVIH_AVNA=SVIH_AVNA
     C                   EVAL      XSVIH_AVA1=SVIH_AVA1
     C                   EVAL      XSVIH_AVA2=SVIH_AVA2
     C                   EVAL      XSVIH_AVPN=SVIH_AVPN
     C                   EVAL      XSVIH_AVPA=SVIH_AVPA
     C                   EVAL      XSVIH_AVLK=SVIH_AVLK
     C                   EVAL      XSVIH_KOTA=SVIH_KOTAN
S06  C*                  EVAL      XSVIH_RFAB=SVIH_RFAB
     C                   EVAL      XSVIH_RFAC=SVIH_RFAC
     C                   EVAL      XSVIH_RFAC2=SVIH_RFAC2
     C                   EVAL      XSVIH_MOKN=SVIH_MOKNN
     C                   EVAL      XSVIH_MOEO=SVIH_MOEO
     C                   EVAL      XSVIH_MONA=SVIH_MONA
     C                   EVAL      XSVIH_MOA1=SVIH_MOA1
     C                   EVAL      XSVIH_MOA2=SVIH_MOA2
     C                   EVAL      XSVIH_MOPN=SVIH_MOPN
     C                   EVAL      XSVIH_MOPA=SVIH_MOPA
     C                   EVAL      XSVIH_MOLK=SVIH_MOLK
     C                   EVAL      XSVIH_MOHA=SVIH_MOHA
     C                   EVAL      XSVIH_MOTL=SVIH_MOTL
     C                   EVAL      XSVIH_VUFO=SVIH_VUFON
     C                   EVAL      XSVIH_VUFR=SVIH_VUFRN
     C                   EVAL      XSVIH_VUVA=SVIH_VUVA
     C                   EVAL      XSVIH_VUKU=SVIH_VUKUN
     C                   EVAL      XSVIH_OVKO=SVIH_OVKON
     C                   EVAL      XSVIH_KARA=SVIH_KARAN
     C                   EVAL      XSVIH_ANRA=SVIH_ANRAN
      *
     C                   EVAL      XSVIH_KVSA=SVIH_KVSA
     C                   EVAL      XSVIH_DKKN=SVIH_DKKNN
     C                   EVAL      XSVIH_DKEO=SVIH_DKEO
     C                   EVAL      XSVIH_DKLK=SVIH_DKLK
     C                   EVAL      XSVIH_DKNA=SVIH_DKNA
     C                   EVAL      XSVIH_DKA1=SVIH_DKA1
     C                   EVAL      XSVIH_DKA2=SVIH_DKA2
     C                   EVAL      XSVIH_DKPA=SVIH_DKPA
     C                   EVAL      XSVIH_DKPN=SVIH_DKPN
     C                   EVAL      XSVIH_DKHA=SVIH_DKHA
     C                   EVAL      XSVIH_DKTL=SVIH_DKTL
N09   *
N09  C                   EVAL      XSVIH_SEKN=SVIH_SEKNN
N09  C                   EVAL      XSVIH_SEEO=SVIH_SEEO
N09  C                   EVAL      XSVIH_SENA=SVIH_SENA
N09  C                   EVAL      XSVIH_SEA1=SVIH_SEA1
N09  C                   EVAL      XSVIH_SEA2=SVIH_SEA2
N09  C                   EVAL      XSVIH_SEPN=SVIH_SEPN
N09  C                   EVAL      XSVIH_SEPA=SVIH_SEPA
N09  C                   EVAL      XSVIH_SELK=SVIH_SELK
N09  C                   EVAL      XSVIH_SEHA=SVIH_SEHA
N09  C                   EVAL      XSVIH_SETL=SVIH_SETL
N09  C                   EVAL      XSVIH_KOKN=SVIH_KOKNN
N09  C                   EVAL      XSVIH_KOEO=SVIH_KOEO
N09  C                   EVAL      XSVIH_KONA=SVIH_KONA
N09  C                   EVAL      XSVIH_KOA1=SVIH_KOA1
N09  C                   EVAL      XSVIH_KOA2=SVIH_KOA2
N09  C                   EVAL      XSVIH_KOPN=SVIH_KOPN
N09  C                   EVAL      XSVIH_KOPA=SVIH_KOPA
N09  C                   EVAL      XSVIH_KOLK=SVIH_KOLK
N09  C                   EVAL      XSVIH_KOHA=SVIH_KOHA
N09  C                   EVAL      XSVIH_KOTL=SVIH_KOTL
N09   *
     C                   EVAL      XSVIH_OMEO=SVIH_OMEO
     C                   EVAL      XSVIH_OMTY=SVIH_OMTY
     C                   EVAL      XSVIH_OMHA=SVIH_OMHA
     C                   EVAL      XSVIH_OMTL=SVIH_OMTL
     C                   EVAL      XSVIH_AVUT=SVIH_AVUT
     C                   EVAL      XSVIH_AUKD=SVIH_AUKD
     C                   EVAL      XSVIH_TRID=SVIH_TRID
     C                   EVAL      XSVIH_TRLK=SVIH_TRLK
     C                   EVAL      XSVIH_CONT=SVIH_CONT
     C                   EVAL      XSVIH_LEKD=SVIH_LEKD
     C                   EVAL      XSVIH_LEOR=SVIH_LEOR
     C                   EVAL      XSVIH_TRAI=SVIH_TRAI
     C                   EVAL      XSVIH_TRAL=SVIH_TRAL
     C                   EVAL      XSVIH_FATY=SVIH_FATY
     C                   EVAL      XSVIH_FATX=SVIH_FATX
     C                   EVAL      XSVIH_VAKD=SVIH_VAKD
     C*                  EVAL      XSVIH_VAKU=SVIH_VAKUN
     C                   Z-ADD     SVIH_VAKUN    XSVIH_VAKU
     C                   EVAL      XSVIH_FABL=SVIH_FABLN
     C                   EVAL      XSVIH_TRGR=SVIH_TRGR
     C                   EVAL      XSVIH_TRIN=SVIH_TRIN
     C                   EVAL      XSVIH_GRKD=SVIH_GRKD
     C                   EVAL      XSVIH_GOLK=SVIH_GOLK
     C                   EVAL      XSVIH_BRUT=SVIH_BRUTN
     C                   EVAL      XSVIH_SUTI=SVIH_SUTI
     C                   EVAL      XSVIH_ABUB=SVIH_ABUB
     C                   EVAL      XSVIH_EUP1=SVIH_EUP1
     C                   EVAL      XSVIH_EUP2=SVIH_EUP2
     C                   EVAL      XSVIH_UPPS=SVIH_UPPS
     C                   EVAL      XSVIH_KLEO=SVIH_KLEO
     C                   EVAL      XSVIH_TRNR=SVIH_TRNR
     C                   EVAL      XSVIH_SGDK=SVIH_SGDK
     C                   EVAL      XSVIH_SGME=SVIH_SGME
     C                   EVAL      XSVIH_SGUT=SVIH_SGUT
     C                   EVAL      XSVIH_SGID=SVIH_SGID
     C                   EVAL      XSVIH_SGDT=SVIH_SGDT
     C                   EVAL      XSVIH_BYTE=SVIH_BYTEN
     C                   EVAL      XSVIH_KVAL=SVIH_KVAL
     C                   EVAL      XSVIH_GODN=SVIH_GODN
     C                   EVAL      XSVIH_0035=SVIH_0035
N07  C                   EVAL      XSVIH_SYST2=SVIH_SYST2
N07  C                   EVAL      XSVIH_LRN  =SVIH_LRN
N07  C                   EVAL      XSVIH_MRN  =SVIH_MRN
N08  C                   EVAL      XSVIH_OMEM =SVIH_OMEM
N08  C                   EVAL      XSVIH_DKEM =SVIH_DKEM
      * Tvungen testindikator ?
     C     XSVIH_0035    IFEQ      *BLANKS
     C     XSVIH_SYAV    CHAIN(N)  SVIA
     C     SVIA_0035     IFNE      *BLANKS
     C                   EVAL      XSVIH_0035=SVIA_0035
     C                   ENDIF
     C                   ENDIF
     C                   UPDATE    SVIHR
      * Oppdater oppdraget med godsnummer hvis blankt
     C                   IF        FILAND='SE'
     C     SVIHKEY       CHAIN     HEADF                              40
     C                   IF        *IN40=*OFF
     C                   IF        HEGN=*BLANKS
     C                   EVAL      HEGN=SVIH_GODN
     C                   UPDATE    HEADFR
     C                   ENDIF
     C                   ENDIF
     C                   ENDIF
N01   * Extern referanse ?
N01  C     FRIKEY        CHAIN     FRISOK                             56
N01  C                   IF        *IN56
N01  C                   CLEAR                   FRISOKR
N01  C                   EVAL      FSAVD=SVIH_SYAV
N01  C                   EVAL      FSOPD=SVIH_SYOP
N01  C                   EVAL      FSKODE='*CR'
N01  C                   EVAL      FSSOK=H_XREF
N01  C                   MOVE      WDT           FSDTOP
N01  C                   WRITE     FRISOKR
N01  C                   ELSE
N01  C                   EVAL      FSSOK=H_XREF
N01  C                   UPDATE    FRISOKR
N01  C                   ENDIF
     C                   ENDSR
      *______________________________________________________
      * Copy                                              SRC
      *""""""""""""""""""""""""""""""""""""""""""""""""""""""
     C     SRC           BEGSR
     C                   EVAL      WSIGN=SVIH_SYSG
      * Hæmta uppdragsnummer
     C     NEWAVD        CHAIN     SVIA                               52
     C                   ADD       1             SVIA_SYOP
     C                   UPDATE    SVIAR
     C                   EVAL      XSVIH_SYAV=NEWAVD
     C                   EVAL      XSVIH_SYOP=SVIA_SYOP
     C                   EVAL      NEWOPD=SVIA_SYOP
     C                   EVAL      XSVIH_SYSG=NEWSIGN
     C                   MOVEL     WDT           XSVIH_SYDT
     C                   EVAL      XSVIH_OMEO=SVIA_OMEO
     C                   EVAL      XSVIH_OMHA=SVTH_NAMN
     C                   EVAL      XSVIH_OMTL=SVTH_TLF
     C                   EVAL      XSVIH_OMTY=SVIA_OMTY
     C                   EVAL      XSVIH_SYST=*BLANKS
     C                   EVAL      XSVIH_0035=SVIA_0035
      * Hæmta tullid
     C                   CALL      'SVG001R'
     C                   PARM                    XSVIH_TUID
     C                   EVAL      SVIH_TUID=XSVIH_TUID
      * Andre variabler
     C*                  GOTO      SRC1
     C                   EVAL      XSVIH_VAKD=*BLANKS
     C                   EVAL      XSVIH_VAKU=*ZEROS
     C                   EVAL      XSVIH_FABL=*ZEROS
     C                   EVAL      XSVIH_FATX=*BLANKS
     C                   EVAL      XSVIH_FATY=*BLANKS
     C                   EVAL      XSVIH_TRID=*BLANKS
     C                   EVAL      XSVIH_TRLK=*BLANKS
     C                   EVAL      XSVIH_KOTA=*ZEROS
     C                   EVAL      XSVIH_BRUT=*ZEROS
     C                   EVAL      XSVIH_RFAC=*BLANKS
     C                   EVAL      XSVIH_RFAC2=*BLANKS
     C                   EVAL      XSVIH_OVKO=*ZEROS
     C                   EVAL      XSVIH_KARA=*ZEROS
     C                   EVAL      XSVIH_ANRA=*ZEROS
     C*    SRC1          TAG
      * Write
N06  C                   MOVEL     XSVIH_SYAV    XVIH_RFAB        11
N06  C                   MOVE      XSVIH_SYOP    XVIH_RFAB
N06  C                   MOVEL     XVIH_RFAB     XSVIH_RFAB
     C                   WRITE     SVIHR
      * Kopiera också varuposter
     C                   GOTO      SRC9
     C                   EVAL      *IN52=*OFF
     C     SVIHKey       SETLL     SVIV1
     C     SVIHKey       READE     SVIV1                                  52
     C     *IN52         DOWEQ     *OFF

     C                   EVAL      SVIV_SYAV=NEWAVD
     C                   EVAL      SVIV_SYOP=NEWOPD
     C                   WRITE     SVIVR

     C     SVIHKey       READE     SVIV1                                  52
     C                   ENDDO
     C     SRC9          TAG
     C                   ENDSR
      *______________________________________________________
      * Hæmta från SAD Export, SYSPED op, eller SVI      SRGS
      *""""""""""""""""""""""""""""""""""""""""""""""""""""""
     C     SRGS          BEGSR
      * Finnes SAD Export ?
     C     SvihKey       CHAIN     SAEH                               53
      * Finnes SYSPED Oppdrag ?
     C     SvihKey       CHAIN(N)  HEADF                              54
      * Fel, finns inte varken sad eksport eller sysped uppdrag
     C                   IF        *IN53
     C                   IF        *IN54
     C                   eval      Error = 'Order not found'
     C                   GOTO      SRGS9
     C                   ENDIF
     C                   ENDIF
      * Skapa gemensam information
     C     SVIH_SYAV     CHAIN(N)  SVIA                               52
     C                   EVAL      XSVIH_SYAV=SVIH_SYAV
     C                   EVAL      XSVIH_SYOP=SVIH_SYOP
     C                   EVAL      XSVIH_SYSG=WSIGN
     C                   MOVEL     WDT           XSVIH_SYDT
     C                   EVAL      XSVIH_OMEO=SVIA_OMEO
     C                   EVAL      XSVIH_OMHA=SVTH_NAMN
     C                   EVAL      XSVIH_OMTL=SVTH_TLF
     C                   EVAL      XSVIH_OMTY=SVIA_OMTY
     C                   EVAL      XSVIH_0035=SVIA_0035

     C                   CALL      'SVG001R'
     C                   PARM                    XSVIH_TUID
     C                   EVAL      SVIH_TUID=XSVIH_TUID

     C                   EVAL      XSVIH_MTYP='DNK'
     C                   EVAL      XSVIH_TART='1'
     C                   EVAL      XSVIH_DEK1='EU'
     C                   EVAL      XSVIH_DEK2='A'
     C                   EVAL      XSVIH_UPPS=' '
     C                   EVAL      XSVIH_EUP1='4000'
      * Hæmta från SAD Export
     C  N53              EXSR      SRGSS
      * Hæmta från SYSPED oppdrag
     C   53              EXSR      SRGSO
      * Write
     C                   WRITE     SVIHR
     C     SRGS9         ENDSR
      *______________________________________________________
      * Hæmta från SAD Export                           SRGSS
      *""""""""""""""""""""""""""""""""""""""""""""""""""""""
     C     SRGSS         BEGSR
     C                   EVAL      XSVIH_AVKN=SEKNK
     C                   EVAL      XSVIH_AVNA=SENAK
     C                   EVAL      XSVIH_AVA1=SEADK1
     C                   EVAL      XSVIH_AVA2=SEADK2
     C                   EVAL      P = %SCAN (' ' : SEADK3)
     C                   EVAL      XSVIH_AVPN=%SUBST(SEADK3:1:P)
     C                   EVAL      W_PADR=%SUBST(SEADK3:P+1)
     C                   EVAL      XSVIH_AVPA=%triml(W_PADR)
     C                   EVAL      XSVIH_AVLK='NO'
      * Spesial kingsrød, hent avs. oppl fra kundereg uansett
     C     XSVIH_AVKN    IFNE      0
     C                   MOVE      XSVIH_AVKN    KUNDNR
     C     CUNDL01K      CHAIN     CUNDL01                            35
KING C     CUNDL01K      CHAIN     KUNDL01
     C                   IF        *IN35=*OFF
     C                   EVAL      XSVIH_AVNA = KNAVN
     C                   EVAL      XSVIH_AVA1 = ADR1
     C                   EVAL      XSVIH_AVA2 = ADR2
     C                   IF        POSTNR = 0

     C                   EVAL      P = %SCAN ('-' : SYPOGE)
     C     9             SUB       P             Q                 1 0
     C                   ADD       1             P
     C                   EVAL      XSVIH_AVPN=%SUBST(SYPOGE:P:Q)

     C                   ELSE
     C                   EVAL      XSVIH_AVPN = *BLANKS
     C                   MOVEL     POSTNR        XSVIH_AVPN
     C                   ENDIF
     C                   MOVEL     ADR3          XSVIH_AVPA
     C                   IF        SYLAND <> *BLANKS
     C                   EVAL      XSVIH_AVLK = SYLAND
     C                   ENDIF
     C                   ENDIF
     C                   ENDIF

     C                   EVAL      XSVIH_MOKN=SEKNS
     C                   EVAL      XSVIH_MONA=SENAS
     C                   EVAL      XSVIH_MOA1=SEADS1
     C                   EVAL      XSVIH_MOA2=SEADS2
     C                   EVAL      P = %SCAN (' ' : SEADS3)
     C                   EVAL      XSVIH_MOPN=%SUBST(SEADS3:1:P)
     C                   EVAL      W_PADR=%SUBST(SEADS3:P+1)
     C                   EVAL      XSVIH_MOPA=%triml(W_PADR)
     C                   EVAL      XSVIH_MOLK=SELKB
     C                   EVAL      XSVIH_MOHA=*BLANKS
     C                   EVAL      XSVIH_MOTL=' '
     C                   EVAL      XSVIH_OMEO=SVIA_OMEO
     C                   EVAL      XSVIH_OMHA=SVTH_NAMN
     C                   EVAL      XSVIH_OMTL=SVTH_TLF
     C                   EVAL      XSVIH_OMTY='2'
     C                   EVAL      XSVIH_AVUT='NO'
     C                   EVAL      XSVIH_VAKD=SEVAL1
     C                   EVAL      XSVIH_FABL=SEBEL1
     C                   MOVEL     '3'           XSVIH_TRGR
     C                   MOVEL     '3'           XSVIH_TRIN
     C                   EVAL      XSVIH_FATY='N380'
     C                   EVAL      XSVIH_FATX=SEFIF
     C                   EVAL      XSVIH_TRAI=SETRID
     C                   EVAL      XSVIH_TRAL=SELKT
     C                   EVAL      XSVIH_CONT=SEKDC
     C                   EVAL      XSVIH_LEKD=SELV
     C     XSVIH_LEKD    IFEQ      'DDP'
     C                   MOVEL     XSVIH_MOPA    XSVIH_LEOR
     C                   ENDIF
     C                   EVAL      XSVIH_KOTA=SENTK
     C                   EVAL      XSVIH_BRUT=SEVKB
      * hæmta kundinfo
     C     XSVIH_MOKN    IFNE      0
     C                   MOVE      XSVIH_MOKN    KUNDNR
     C     CUNDL01K      CHAIN     CUNDL01                            40
KING C     CUNDL01K      CHAIN     KUNDL01
     C                   IF        *IN40=*OFF
     C     XSVIH_MOEO    IFEQ      *BLANKS
     C     EORI          IFNE      *BLANKS
     C                   EVAL      XSVIH_MOEO=EORI
     C                   ELSE
     C                   MOVEL(P)  SYLAND        XSVIH_MOEO
     C                   CAT       SYRG:0        XSVIH_MOEO
     C                   CAT       '00':0        XSVIH_MOEO
     C                   IF        SYRG=*BLANKS
     C                   MOVEL(P)  SYLAND        XSVIH_MOEO
     C                   CAT       VATKKU:0      XSVIH_MOEO
     C                   ENDIF
     C                   ENDIF
     C                   ENDIF
     C     XSVIH_MOHA    IFEQ      *BLANKS
     C                   EVAL      XSVIH_MOHA = KPERS
     C                   ENDIF
     C     XSVIH_MOTL    IFEQ      *BLANKS
     C                   EVAL      XSVIH_MOTL = TLF
     C                   ENDIF
     C     XSVIH_MOLK    IFEQ      *BLANKS
     C                   EVAL      XSVIH_MOLK = SYLAND
     C                   ENDIF
      * Spesial for Kingrød, hent mott.oppl fra kundereg uansett
     C                   EVAL      XSVIH_MONA = KNAVN
     C                   EVAL      XSVIH_MOA1 = ADR1
     C                   EVAL      XSVIH_MOA2 = ADR2
     C                   IF        POSTNR = 0

     C                   EVAL      P = %SCAN ('-' : SYPOGE)
     C     9             SUB       P             Q                 1 0
     C                   ADD       1             P
     C                   EVAL      XSVIH_MOPN=%SUBST(SYPOGE:P:Q)

     C                   ELSE
     C                   EVAL      XSVIH_MOPN = *BLANKS
     C                   MOVEL     POSTNR        XSVIH_MOPN
     C                   ENDIF
     C                   EVAL      XSVIH_MOPA = ADR3
     C                   IF        SYLAND <> *BLANKS
     C                   EVAL      XSVIH_MOLK = SYLAND
     C                   ENDIF
     C                   EVAL      XSVIH_MOTL = TLF
      * Hent godslokalkode fra CUNDF
     C     XSVIH_GOLK    IFEQ      *BLANKS
     C                   EVAL      XSVIH_GOLK=GOLK
     C                   ENDIF

     C                   ENDIF
     C                   ENDIF
     C     XSVIH_MOHA    IFEQ      *BLANKS
     C                   EVAL      XSVIH_MOHA=SVTH_NAMN
     C                   EVAL      XSVIH_MOTL=SVTH_TLF
     C                   ENDIF
      *Og bitte lite til fra HEADF
     C     SVIHKEY       CHAIN(N)  HEADF                              52
     C     *IN52         IFEQ      *OFF
     C                   EVAL      XSVIH_TRAI=HEHAWB
     C                   IF        FILAND='SE'
     C                   EVAL      XSVIH_GODN=HEGN
     C                   ENDIF
     C                   ENDIF
      * Førfarande
     C     XSVIH_MOLK    IFNE      'SE'
     C     XSVIH_MOLK    IFNE      *BLANKS
     C                   EVAL      XSVIH_EUP1='4200'
     C                   ENDIF
     C                   ENDIF
      * Kopier varelinjer
     C                   CALL      'SVI009R'
     C                   PARM                    XSVIH_SYAV
     C                   PARM                    XSVIH_SYOP
     C                   PARM                    XSVIH_EUP1
      * Legg in standardtext i rubrik 44 om PROC=4200
     C                   IF        XSVIH_EUP1='4200'

     C     XSVIH_OMEO    IFNE      *BLANKS
     C                   CLEAR                   SVIFR
     C                   EVAL      SVIF_SYAV=XSVIH_SYAV
     C                   EVAL      SVIF_SYOP=XSVIH_SYOP
     C                   EVAL      SVIF_FATY='Y040'
     C                   EVAL      SVIF_FATX=XSVIH_OMEO
     C                   EVAL      WSYKUNR=XSVIH_AVKN
     C     SYPARKEY      CHAIN     SYPARL1                            40
     C     *IN40         IFEQ      *OFF
     C     SYVRDA        ANDNE     *BLANKS
     C                   MOVE      *BLANKS       SVIF_FATX
     C                   MOVEL     SYVRDA        SVIF_FATX
     C                   ENDIF
     C                   WRITE     SVIFR
     C                   ENDIF

     C     XSVIH_MOEO    IFNE      *BLANKS
     C                   CLEAR                   SVIFR
     C                   EVAL      SVIF_SYAV=XSVIH_SYAV
     C                   EVAL      SVIF_SYOP=XSVIH_SYOP
     C                   EVAL      SVIF_FATY='Y041'
     C                   EVAL      SVIF_FATX=XSVIH_MOEO
     C                   WRITE     SVIFR
     C                   ENDIF

     C                   ENDIF
     C                   ENDSR
      *______________________________________________________
      * Hæmta från SYSPED Oppdrag                       SRGSO
      *""""""""""""""""""""""""""""""""""""""""""""""""""""""
     C     SRGSO         BEGSR
     C                   EVAL      XSVIH_AVKN=HEKNS
     C                   EVAL      XSVIH_AVNA=HENAS
     C                   EVAL      XSVIH_AVA1=HEADS1
     C                   EVAL      XSVIH_AVA2=HEADS2
     C                   EVAL      P = %SCAN (' ' : HEADS3)
     C                   EVAL      XSVIH_AVPN=%SUBST(HEADS3:1:P)
     C                   EVAL      W_PADR=%SUBST(HEADS3:P+1)
     C                   EVAL      XSVIH_AVPA=%triml(W_PADR)
     C                   EVAL      XSVIH_AVLK=HELKS
      * Spesial kingsrød, hent avs. oppl fra kundereg uansett
     C     XSVIH_AVKN    IFNE      0
     C                   MOVE      XSVIH_AVKN    KUNDNR
     C     CUNDL01K      CHAIN     CUNDL01                            35
KING C     CUNDL01K      CHAIN     KUNDL01
     C                   IF        *IN35=*OFF
     C                   EVAL      XSVIH_AVNA = KNAVN
     C                   EVAL      XSVIH_AVA1 = ADR1
     C                   EVAL      XSVIH_AVA2 = ADR2
     C                   IF        POSTNR = 0

     C                   EVAL      P = %SCAN ('-' : SYPOGE)
     C     9             SUB       P             Q                 1 0
     C                   ADD       1             P
     C                   EVAL      XSVIH_AVPN=%SUBST(SYPOGE:P:Q)

     C                   ELSE
     C                   EVAL      XSVIH_AVPN = *BLANKS
     C                   MOVEL     POSTNR        XSVIH_AVPN
     C                   ENDIF
     C                   MOVEL     ADR3          XSVIH_AVPA
     C                   IF        SYLAND <> *BLANKS
     C                   EVAL      XSVIH_AVLK = SYLAND
     C                   ENDIF
     C                   ENDIF
     C                   ENDIF

     C                   EVAL      XSVIH_MOKN=HEKNK
     C                   EVAL      XSVIH_MONA=HENAK
     C                   EVAL      XSVIH_MOA1=HEADK1
     C                   EVAL      XSVIH_MOA2=HEADK2
     C                   EVAL      P = %SCAN (' ' : HEADK3)
     C                   EVAL      XSVIH_MOPN=%SUBST(HEADK3:1:P)
     C                   EVAL      W_PADR=%SUBST(HEADK3:P+1)
     C                   EVAL      XSVIH_MOPA=%triml(W_PADR)
     C                   EVAL      XSVIH_MOLK='  '
     C                   EVAL      XSVIH_OMEO=SVIA_OMEO
     C                   EVAL      XSVIH_OMHA=SVTH_NAMN
     C                   EVAL      XSVIH_OMTL=SVTH_TLF
     C                   EVAL      XSVIH_OMTY='2'
     C                   EVAL      XSVIH_AVUT=HELKA
     C                   EVAL      XSVIH_KOTA=HENT
     C                   EVAL      XSVIH_BRUT=HEVKT
     C                   MOVEL     HETRC         XSVIH_CONT
     C                   MOVEL     '3'           XSVIH_TRGR
     C                   MOVEL     '3'           XSVIH_TRIN
     C                   EVAL      XSVIH_TRAL=HETRI
     C                   EVAL      XSVIH_LEKD=HEFR
     C     XSVIH_LEKD    IFEQ      'DDP'
     C                   MOVEL     XSVIH_MOPA    XSVIH_LEOR
     C                   ENDIF
     C                   EVAL      XSVIH_TRAI=HEHAWB
     C     XSVIH_TRAI    IFEQ      *BLANKS
     C                   EVAL      XSVIH_TRAI=HETRCN
     C                   ENDIF
     C                   IF        FILAND='SE'
     C                   EVAL      XSVIH_GODN=HEGN
     C                   ENDIF
     C                   EVAL      XSVIH_FATY='N380'
      * hæmta kundinfo
     C     XSVIH_MOKN    IFNE      0
     C                   MOVE      XSVIH_MOKN    KUNDNR
     C     CUNDL01K      CHAIN     CUNDL01                            40
KING C     CUNDL01K      CHAIN     KUNDL01
     C                   IF        *IN40=*OFF
     C     XSVIH_MOEO    IFEQ      *BLANKS
     C     EORI          IFNE      *BLANKS
     C                   EVAL      XSVIH_MOEO=EORI
     C                   ELSE
     C                   MOVEL(P)  SYLAND        XSVIH_MOEO
     C                   CAT       SYRG:0        XSVIH_MOEO
     C                   CAT       '00':0        XSVIH_MOEO
     C                   IF        SYRG=*BLANKS
     C                   MOVEL(P)  SYLAND        XSVIH_MOEO
     C                   CAT       VATKKU:0      XSVIH_MOEO
     C                   ENDIF
     C                   ENDIF
     C                   ENDIF
     C     XSVIH_MOHA    IFEQ      *BLANKS
     C                   EVAL      XSVIH_MOHA = KPERS
     C                   ENDIF
     C     XSVIH_MOTL    IFEQ      *BLANKS
     C                   EVAL      XSVIH_MOTL = TLF
     C                   ENDIF
     C     XSVIH_MOLK    IFEQ      *BLANKS
     C                   EVAL      XSVIH_MOLK = SYLAND
     C                   ENDIF
      * Spesial for Kingrød, hent mott.oppl fra kundereg uansett
     C                   EVAL      XSVIH_MONA = KNAVN
     C                   EVAL      XSVIH_MOA1 = ADR1
     C                   EVAL      XSVIH_MOA2 = ADR2
     C                   IF        POSTNR = 0

     C                   EVAL      P = %SCAN ('-' : SYPOGE)
     C     9             SUB       P             Q                 1 0
     C                   ADD       1             P
     C                   EVAL      XSVIH_MOPN=%SUBST(SYPOGE:P:Q)

     C                   ELSE
     C                   EVAL      XSVIH_MOPN = *BLANKS
     C                   MOVEL     POSTNR        XSVIH_MOPN
     C                   ENDIF
     C                   EVAL      XSVIH_MOPA = ADR3
     C                   IF        SYLAND <> *BLANKS
     C                   EVAL      XSVIH_MOLK = SYLAND
     C                   ENDIF
     C                   EVAL      XSVIH_MOTL = TLF
      * Hent godslokalkode fra CUNDF
     C     XSVIH_GOLK    IFEQ      *BLANKS
     C                   EVAL      XSVIH_GOLK=GOLK
     C                   ENDIF

     C                   ENDIF
     C                   ENDIF
     C     XSVIH_MOHA    IFEQ      *BLANKS
     C                   EVAL      XSVIH_MOHA=SVTH_NAMN
     C                   EVAL      XSVIH_MOTL=SVTH_TLF
     C                   ENDIF
      * Førfarande
     C     XSVIH_MOLK    IFNE      'SE'
     C     XSVIH_MOLK    IFNE      *BLANKS
     C                   EVAL      XSVIH_EUP1='4200'
     C                   ENDIF
     C                   ENDIF
      * Legg in standardtext i rubrik 44 om PROC=4200
     C                   IF        XSVIH_EUP1='4200'

     C     XSVIH_OMEO    IFNE      *BLANKS
     C                   CLEAR                   SVIFR
     C                   EVAL      SVIF_SYAV=XSVIH_SYAV
     C                   EVAL      SVIF_SYOP=XSVIH_SYOP
     C                   EVAL      SVIF_FATY='Y040'
     C                   EVAL      SVIF_FATX=XSVIH_OMEO
     C                   EVAL      WSYKUNR=XSVIH_AVKN
     C     SYPARKEY      CHAIN     SYPARL1                            40
     C     *IN40         IFEQ      *OFF
     C     SYVRDA        ANDNE     *BLANKS
     C                   MOVE      *BLANKS       SVIF_FATX
     C                   MOVEL     SYVRDA        SVIF_FATX
     C                   ENDIF
     C                   WRITE     SVIFR
N16  C                   ENDIF


     C     XSVIH_MOEO    IFNE      *BLANKS
     C                   CLEAR                   SVIFR
     C                   EVAL      SVIF_SYAV=XSVIH_SYAV
     C                   EVAL      SVIF_SYOP=XSVIH_SYOP
     C                   EVAL      SVIF_FATY='Y041'
     C                   EVAL      SVIF_FATX=XSVIH_MOEO
     C                   WRITE     SVIFR
     C                   ENDIF

     C                   ENDIF
     C                   ENDSR
