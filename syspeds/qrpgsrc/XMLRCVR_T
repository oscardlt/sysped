********************************************************************
      * Dette programmet PARSER xml via SCOTT KLEMETs HTTPAPI og
      * legger ut XMLTAGGER / VERDIER mm i nøkkelbaserte DATABASEfiler
********************************************************************
      * RETTINGER I DETTE PROGRAM:
PTFnr:*Sek Sig Vers  Beskrivelse...........................
""""""*"""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""
10XXX * 01 JOV PTF10 FEILMELDING DERSOM......
********************************************************************
     H DFTACTGRP(*NO) BNDDIR('HTTPAPI')

     FQSYSPRT   O    F  132        PRINTER OFLIND(*INOF)
     FXMLRCVF   O  A E             DISK
     FXMLRCLF   O  A E             DISK
     FXMLRCAF   O  A E             DISK
s01  F*EDIC      UF   E             DISK
      /copy qrpglesrc,httpapi_h
      /copy qrpglesrc,ifsio_h

     D Incoming        PR
     D   userdata                      *   value
     D   depth                       10I 0 value
     D   name                      1024A   varying const
     D   path                     24576A   varying const
     D   value                    32767A   varying const
     D   Attrs                         *   dim(32767)
     D                                     const options(*varsize)

     D PrintLine       s            132A
     D filename        s            120A   varying
     D XCLIENTID       s             10A
     D XCLIENTNAME     s             50A
     D XDEPTH          s              3  0
     D XVALUE1         S            512A
     D XVALUE2         S            442A
     D XATN            S             35A   DIM(30)
     D XATV            S             70A   DIM(30)
      *

     C*    *ENTRY        PLIST
     C*                  PARM                    UFILNVN         256
     C*                  PARM                    USN               7
     C                   MOVE      *BLANKS       UFILNVN         256
     C                   MOVE      '0000131'     USN               7

n01  C*    1             CHAIN     EDIC                               20
n01  C*                  ADD       1             CSN
n01  C*                  UPDATE    EDICR
n01  C*                  MOVE      CSN           XRSN
n01  C*                  MOVE      CSN           USN
N01  C                   MOVE      USN           XRSN

      /free


        //
        // ****************************************************
        //   parse the XML from the temp file.  (hopp ut ved feil)
        // ****************************************************

        //  filename = %trim(UFILNVN);
        //  filename = '/tmp/BLIT1838943.xml';
        filename = '/SYSPEDF/EDIRE1K/BACKUP/SKYMan_2010-08-10-08.08.25.xml';
       http_debug(*ON);
        if (http_parse_xml_stmf( filename
                               : HTTP_XML_CALC
                               : *null
                               : %paddr(Incoming)
                               : *null ) < 0 );
           PrintLine = http_error();
           except;

           *inlr = *on;
           return;
        endif;

        // ****************************************************
        //  http_parse-funksjonen er n} vellykket avsluttet
        // ****************************************************
           *inlr = *on;
           return;

      /end-free

      *
     OQSYSPRT   E
     O                       PrintLine          132

      *
      *+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
     P Incoming        B
     D Incoming        PI
     D   userdata                      *   value
     D   depth                       10I 0 value
     D   name                      1024A   varying const
     D   path                     24576A   varying const
     D   value                    32767A   varying const
     D   attrs                         *   dim(32767)
     D                                     const options(*varsize)

     D count           s             10I 0
     D attrname        s            100A   varying
     D attrval         s            100A   varying

     D X               s             10I 0
     D X2              s              3I 0

      /free

       // Skriv en linje pr attributt for sist behandlede/avsluttede tag
       //  ved å løse opp "rem-ede linjer" bare ved gitte tag-navn  / gitte attributt-navn
       // OBS| skal en ha med variablene UT av prosedyr m} variablene defineres globalt (toppen)

           XRNV   = NAME;
           XVALUE1 = VALUE;
      /end-free
     C                   MOVE      XVALUE1       XVALUE2
      * DUMMY FOR DEBUG..
     C*                  IF        XRNV ='ConsignorAccount'
     C                   IF        XVALUE1 = 'P0502'
     C                   MOVE      'X'           DUMMY             1
     C                   ENDIF
      /free
           IF (XVALUE2 = *BLANKS);
           XRVERD = VALUE;
           ELSE;
           XRVERD = '*EXT, TILLEGGSFIL';
           ENDIF;
           XRPATH = PATH;
           X2     = DEPTH - XDEPTH;
           select;
           WHEN (DEPTH  = XDEPTH);
              select;
              WHEN (DEPTH  = 1);
              WHEN (DEPTH  = 2);
               XRLEV1 = XRLEV1 + 1;
              WHEN (DEPTH  = 3);
               XRLEV2 = XRLEV2 + 1;
              WHEN (DEPTH  = 4);
               XRLEV3 = XRLEV3 + 1;
              WHEN (DEPTH  = 5);
               XRLEV4 = XRLEV4 + 1;
              WHEN (DEPTH  = 6);
               XRLEV5 = XRLEV5 + 1;
              WHEN (DEPTH  = 7);
               XRLEV6 = XRLEV6 + 1;
              WHEN (DEPTH  = 8);
               XRLEV7 = XRLEV7 + 1;
              WHEN (DEPTH  = 8);
               XRLEV8 = XRLEV8 + 1;
              OTHER;
               XRLEV9 = XRLEV9 + 1;
              ENDSL;
           WHEN (DEPTH  > XDEPTH);
              select;
              WHEN (DEPTH  = 1);
               XRLEV1 = 0;
               XRLEV2 = 0;
               XRLEV3 = 0;
               XRLEV4 = 0;
               XRLEV5 = 0;
               XRLEV6 = 0;
               XRLEV7 = 0;
               XRLEV8 = 0;
               XRLEV9 = 0;
              WHEN (DEPTH  = 2);
               XRLEV1 = XRLEV1 + 1;
               XRLEV2 = 0;
               XRLEV3 = 0;
               XRLEV4 = 0;
               XRLEV5 = 0;
               XRLEV6 = 0;
               XRLEV7 = 0;
               XRLEV8 = 0;
               XRLEV9 = 0;
              WHEN (DEPTH  = 3);
               XRLEV1 = XRLEV1 + 1;
               XRLEV2 = XRLEV2 + 1;
               XRLEV3 = 0;
               XRLEV4 = 0;
               XRLEV5 = 0;
               XRLEV6 = 0;
               XRLEV7 = 0;
               XRLEV8 = 0;
               XRLEV9 = 0;
              WHEN (DEPTH  = 4);
               IF (X2 > 1);
               XRLEV1 = XRLEV1 + 1;
               ENDIF;
               XRLEV2 = XRLEV2 + 1;
               XRLEV3 = XRLEV3 + 1;
               XRLEV4 = 0;
               XRLEV5 = 0;
               XRLEV6 = 0;
               XRLEV7 = 0;
               XRLEV8 = 0;
               XRLEV9 = 0;
              WHEN (DEPTH  = 5);
               IF (X2 > 2);
               XRLEV1 = XRLEV1 + 1;
               ENDIF;
               IF (X2 > 1);
               XRLEV2 = XRLEV2 + 1;
               ENDIF;
               XRLEV3 = XRLEV3 + 1;
               XRLEV4 = XRLEV4 + 1;
               XRLEV5 = 0;
               XRLEV6 = 0;
               XRLEV7 = 0;
               XRLEV8 = 0;
               XRLEV9 = 0;
              WHEN (DEPTH  = 6);
               IF (X2 > 3);
               XRLEV1 = XRLEV1 + 1;
               ENDIF;
               IF (X2 > 2);
               XRLEV2 = XRLEV2 + 1;
               ENDIF;
               IF (X2 > 1);
               XRLEV3 = XRLEV3 + 1;
               ENDIF;
               XRLEV4 = XRLEV4 + 1;
               XRLEV5 = XRLEV5 + 1;
               XRLEV6 = 0;
               XRLEV7 = 0;
               XRLEV8 = 0;
               XRLEV9 = 0;
              WHEN (DEPTH  = 7);
               IF (X2 > 4);
               XRLEV1 = XRLEV1 + 1;
               ENDIF;
               IF (X2 > 3);
               XRLEV2 = XRLEV2 + 1;
               ENDIF;
               IF (X2 > 2);
               XRLEV3 = XRLEV3 + 1;
               ENDIF;
               IF (X2 > 1);
               XRLEV4 = XRLEV4 + 1;
               ENDIF;
               XRLEV5 = XRLEV5 + 1;
               XRLEV6 = XRLEV6 + 1;
               XRLEV7 = 0;
               XRLEV8 = 0;
               XRLEV9 = 0;
              WHEN (DEPTH  = 8);
               IF (X2 > 5);
               XRLEV1 = XRLEV1 + 1;
               ENDIF;
               IF (X2 > 4);
               XRLEV2 = XRLEV2 + 1;
               ENDIF;
               IF (X2 > 3);
               XRLEV3 = XRLEV3 + 1;
               ENDIF;
               IF (X2 > 2);
               XRLEV4 = XRLEV4 + 1;
               ENDIF;
               IF (X2 > 1);
               XRLEV5 = XRLEV5 + 1;
               ENDIF;
               XRLEV6 = XRLEV6 + 1;
               XRLEV7 = XRLEV7 + 1;
               XRLEV8 = 0;
               XRLEV9 = 0;
              WHEN (DEPTH  = 9);
               IF (X2 > 6);
               XRLEV1 = XRLEV1 + 1;
               ENDIF;
               IF (X2 > 5);
               XRLEV2 = XRLEV2 + 1;
               ENDIF;
               IF (X2 > 4);
               XRLEV3 = XRLEV3 + 1;
               ENDIF;
               IF (X2 > 3);
               XRLEV4 = XRLEV4 + 1;
               ENDIF;
               IF (X2 > 2);
               XRLEV5 = XRLEV5 + 1;
               ENDIF;
               IF (X2 > 1);
               XRLEV6 = XRLEV6 + 1;
               ENDIF;
               XRLEV7 = XRLEV7 + 1;
               XRLEV8 = XRLEV8 + 1;
               XRLEV9 = 0;
              OTHER;
               IF (X2 > 7);
               XRLEV1 = XRLEV1 + 1;
               ENDIF;
               IF (X2 > 6);
               XRLEV2 = XRLEV2 + 1;
               ENDIF;
               IF (X2 > 5);
               XRLEV3 = XRLEV3 + 1;
               ENDIF;
               IF (X2 > 4);
               XRLEV4 = XRLEV4 + 1;
               ENDIF;
               IF (X2 > 3);
               XRLEV5 = XRLEV5 + 1;
               ENDIF;
               IF (X2 > 2);
               XRLEV6 = XRLEV6 + 1;
               ENDIF;
               IF (X2 > 1);
               XRLEV7 = XRLEV7 + 1;
               ENDIF;
               XRLEV8 = XRLEV8 + 1;
               XRLEV9 = XRLEV9 + 1;
              ENDSL;
           OTHER;
              select;
              WHEN (DEPTH  = 1);
               XRLEV1 = 0;
               XRLEV2 = 0;
               XRLEV3 = 0;
               XRLEV4 = 0;
               XRLEV5 = 0;
               XRLEV6 = 0;
               XRLEV7 = 0;
               XRLEV8 = 0;
               XRLEV9 = 0;
              WHEN (DEPTH  = 2);
               XRLEV2 = 0;
               XRLEV3 = 0;
               XRLEV4 = 0;
               XRLEV5 = 0;
               XRLEV6 = 0;
               XRLEV7 = 0;
               XRLEV8 = 0;
               XRLEV9 = 0;
              WHEN (DEPTH  = 3);
               XRLEV3 = 0;
               XRLEV4 = 0;
               XRLEV5 = 0;
               XRLEV6 = 0;
               XRLEV7 = 0;
               XRLEV8 = 0;
               XRLEV9 = 0;
              WHEN (DEPTH  = 4);
               XRLEV4 = 0;
               XRLEV5 = 0;
               XRLEV6 = 0;
               XRLEV7 = 0;
               XRLEV8 = 0;
               XRLEV9 = 0;
              WHEN (DEPTH  = 5);
               XRLEV5 = 0;
               XRLEV6 = 0;
               XRLEV7 = 0;
               XRLEV8 = 0;
               XRLEV9 = 0;
              WHEN (DEPTH  = 6);
               XRLEV6 = 0;
               XRLEV7 = 0;
               XRLEV8 = 0;
               XRLEV9 = 0;
              WHEN (DEPTH  = 7);
               XRLEV7 = 0;
               XRLEV8 = 0;
               XRLEV9 = 0;
              WHEN (DEPTH  = 8);
               XRLEV8 = 0;
               XRLEV9 = 0;
              OTHER;
               XRLEV9 = 0;
              ENDSL;
           ENDSL;

           WRITE XMLRCVFR;

       // Skriv verdi til tilleggsfil ved verdi er større enn 70 tegn
           IF (XVALUE2 <> *BLANKS);
           XRVRD = XVALUE1;
           WRITE XMLRCLFR;
           ENDIF;
           XDEPTH = DEPTH;

       // Skriv parameter av attributt til fil
            count = 1;
            dow attrs(count) <> *NULL;
               attrname = %str(attrs(count));
               count = count + 1;
               attrval = %str(attrs(count));
               count = count + 1;
               XRATN = ATTRNAME;
               XRATV = ATTRVAL;
               WRITE XMLRCAFR;
            enddo;

      /end-free
     P                 E

