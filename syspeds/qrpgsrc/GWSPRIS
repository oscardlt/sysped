      *
     H DFTACTGRP(*NO) BNDDIR('HTTPAPI')

     FQSYSPRT   O    F  132        PRINTER OFLIND(*INOF)

      /copy qrpglesrc,httpapi_h
      /copy qrpglesrc,ifsio_h

     D Incoming        PR
     D   userdata                      *   value
     D   depth                       10I 0 value
     D   name                      1024A   varying const
     D   path                     24576A   varying const
     D   value                    32767A   varying const
     D   Attrs                         *   dim(32767)
     D                                     const options(*varsize)
     D Add_LogonHead   PR
     D   Header                    1024A   varying
     D   UserData                      *   value
     D SERVER          s             30A
     D ESUSER          s             10A
     D UserPass64      s            200A
      *
     D sysknr          s              8  0
     D fraLk           s              2
     D fraSt           s              5
     D tilLk           s              2
     D tilSt           s              5
     D ant             s              7  0
     D vkt             s              9  0
     D M3              s              7  3
     D LM              s              4  2
     D prod            s              1
     D farlig          s              1
     D varme           s              1
     D lengde          s              1
      *.. For full prisbereging - ikke bare farkt
     D Frank           s              3
     D Otype           s              2
     D Tjeneste        s             20
      *
      *
     D FRAKT           s             13  2
     D ANNET           s             13  2
     D ANN_1           s             13  2
     D ANN_2           s             13  2
     D ANN_3           s             13  2
     D ANN_4           s             13  2
     D ANN_5           s             13  2
      *
     D FeeCode         s              3
     D FeeText         s             50
     D Amount          s             13  2
     D VatCode         s              1
      *
     D rc              s             10I 0
     D url             s          32767A   varying
     D PrintLine       s            132A
     D filename        s             45A   varying
     D Enc             s                   like(HTTP_URL_ENCODER)
     D result          s              5I 0
     D wait            s              1A
      *

     C                   EXSR      INIT

      /free
        http_debug(*ON);
        *inlr = *on;


        // ****************************************************
        //  Sett sammen URL/parametre
        // ****************************************************
          url ='http://'+%trim(server)+'/sycgip/swspris.pgm?userenv='
               +%trim(ESUSER)
               +'&sysknr='   + %trim(%editc(sysknr:'Z'))
               +'&fraLk='    + fraLK
               +'&fra='      + %trim(fraSt)
               +'&tilLk='    + tilLK
               +'&til='      + %trim(tilSt)
               +'&ant='      + %trim(%editc(ant:'3'))
               +'&vkt='      + %trim(%editc(vkt:'3'))
               +'&m3='       + %trim(%editw(M3:'   0 ,   '))
               +'&lm='       + %trim(%editw(LM:' 0 ,  '))
               +'&prod='     + %trim(prod)
               +'&farlig'    + %trim(farlig)
               +'&varme='    + %trim(varme)
               +'&lengde'    + %trim(lengde)
               +'&frank='    + %trim(frank)
               +'&oType='    + %trim(oType)
               +'&tjeneste=' + %trim(tjeneste);
        // ****************************************************
        //  Definer temporær IFS fil, KJØR URLen som en GET
        // ****************************************************
        filename = http_tempfile() + '.xml';

        // Pålogging sendes som Headerifo først
        // UserPass64 = 'Sk9WTzpERU1P';     // = JOVO:DEMO
        // UserPass64 = 'Sk9WTzpGT1JEOTk='; // = JOVO:FORD99
         http_xproc( HTTP_POINT_ADDL_HEADER
                   : %paddr(Add_LogonHead) );


        //rc = http_url_get( url : filename );       - default = 60 sek, endrer til 10
        rc = http_url_get( url : filename : 10 );
        if (rc <> 1);
           PrintLine = http_error();
           except;
           unlink(filename);
           return;
        endif;

        // ****************************************************
        //   parse the XML from the temp file.  (hopp ut ved feil)
        // ****************************************************

        if (http_parse_xml_stmf( filename
                               : HTTP_XML_CALC
                               : *null
                               : %paddr(Incoming)
                               : *null ) < 0 );
           PrintLine = http_error();
           except;
           unlink(filename);
           return;
        endif;

        // ****************************************************
        //  Slett responsfila
        // ****************************************************
           unlink(filename);
        // dsply result ' ' wait;
        // return;

      /end-free
      *  HER KOMMER VURDERING AV RESuLTAT / NYTT FORSØK MM...
     C*                  MOVE      xxxxx         yyyy
     C*                  xxxxx
     C                   SETON                                        LR
     C                   RETURN

      ***********************************************
     C     INIT          BEGSR
      ***********************************************
     c     *entry        plist
     c                   parm                    SERVER
     c                   parm                    ESUSER
     c                   parm                    UserPass64
      * beregningsparametre Frakt
     c                   parm                    sysknr
     c                   parm                    fraLk
     c                   parm                    fraSt
     c                   parm                    tilLk
     c                   parm                    tilSt
     c                   parm                    ant
     c                   parm                    vkt
     c                   parm                    M3
     c                   parm                    LM
     c                   parm                    prod
     c                   parm                    farlig
     c                   parm                    varme
     c                   parm                    lengde
      *.. For full prisbereging - ikke bare farkt
     c                   parm                    Frank
     c                   parm                    Otype
     c                   parm                    Tjeneste
      * retur-parametre
     c                   parm                    Frakt
     c                   parm                    Annet
     c                   parm                    ANN_1
     c                   parm                    ANN_2
     c                   parm                    ANN_3
     c                   parm                    ANN_4
     c                   parm                    ANN_5
      *
     c                   move      *blanks       Testedt          30
     c                   eval      Testedt = %trim(%editw(M3:'    ,   '))
      *
     C                   ENDSR
      *

     OQSYSPRT   E
     O                       PrintLine          132

      *
      *  The DEPTH parameter indicates the nesting depth of the
      *  element received.  In the above example, the "item" tag
      *  would be found at depth=3, since it's inside the "rss"
      *  and "channel" tags.
      *
      *  The NAME parameter is the name of the XML element that
      *  has been received.  It might be something like "channel"
      *  or "title" or "link".
      *
      *  Note that in the above example, there are two different
      *  depths that have "title" and "link".  They are featured
      *  inside the "channel" tag, and also inside the "item" tag.
      *  the "path" parameter will help us sort that out.
      *
      *  The PATH indicates the elements that the current element
      *  is found inside. So, the channel title is found when the
      *  path is "/rss/channel" and the name of the element is "title".
      *  the article titles, however, have a path of "/rss/channel/item"
      *  and a name of "title".
      *
      *  The VALUE parameter gives us the text that's inside that
      *  element.
      *+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
     P Incoming        B
     D Incoming        PI
     D   userdata                      *   value
     D   depth                       10I 0 value
     D   name                      1024A   varying const
     D   path                     24576A   varying const
     D   value                    32767A   varying const
     D   attrs                         *   dim(32767)
     D                                     const options(*varsize)

     D count           s             10I 0
     D attrname        s            100A   varying
     D attrval         s            100A   varying
      /free

           select;
           when name = 'FeeCode';
              eval FeeCode = value;
           when name = 'FeeText';
              eval FeeText = value;
           when name = 'Amount';
              eval Amount = %float(value);
           when name = 'VATcode';
              eval VatCode = value;
              if FeeCode = 'FRA';
                 Frakt = Frakt + Amount;
              else;
                 Annet = Annet + Amount;
              endif;
           endsl;


      /end-free
     P                 E
      *+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
      * HTTPAPI will call this (because we set it with http_xproc)
      * just before sending the HTTP headers to the remote server.
      * This procedure lets us add any header we like to the
      * HTTP request.
      *
      * In this example, I'll use it to supply the LogonHead
      * This way, I can supply a HEADER     that's up to
      * 1024 characters long.
      *
      * NOTE: Make sure you leave off the SOAPAction header on the
      *       HTTP_url_post_xml, above, otherwise you'll send two
      *       of them¤
      *+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
     P Add_LogonHead   B
     D Add_LogonHead   PI
     D   Header                    1024A   varying
     D   UserData                      *   value
      /free
         Header = 'Authorization: Basic '
                + %trim(UserPass64)
                + x'0d25';
      /end-free
     P                 E
