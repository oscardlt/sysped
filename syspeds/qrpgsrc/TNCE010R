      *********************************************************************
      *
CRTPG+*  CRTPGM SYSPED/TNCE010R MODULE(*LIBL/TNCE010R *LIBL/INCGI)
CRTPGM*        ACTGRP(CGI) AUT(*USE)
      *
      *********************************************************************
      /copy SYSPEDS/qrpgsrcpy,hspecs
      /copy SYSPEDS/qrpgsrcpy,hspecsbnd
      *********************************************************************
     FBRIDF     IF   E           K DISK    USROPN
     FSVXV      IF   E           K DISK    USROPN
     FSVXVAM    IF   E           K DISK    USROPN
     FSVXVMN    IF   E           K DISK    USROPN
      *--------------------------------------------------------------------
      * Variables common to all CGIs
      *--------------------------------------------------------------------
      /copy SYSPEDS/qrpgsrcpy,prototypeb
      /copy SYSPEDS/qrpgsrcpy,usec
      /copy SYSPEDS/qrpgsrcpy,variables3
      *
      * Varible for
     D WSUSER          S             10
     D TVAVD_A         S              4
     D TVAVD           S              4  0
     D TVTDN_A         S              7
     D TVTDN           S              7  0
     D JSONstring      S          32000
     D Error           S            150
     D AntLest         S              9  0
     D                 DS
     D  TVMN1                  1     17
     D  TVMN2                 18     34
     D  TVMN3                 35     51
     D  TVMN4                 52     68
     D  TVMN5                 69     85
     D  MN1                    1     85    DIM(5)
     D                 DS
     D  TVEH1                  1      2
     D  TVEH2                  3      4
     D  TVEH3                  5      6
     D  TVEH4                  7      8
     D  TVEH5                  9     10
     D  MN2                    1     10    DIM(5)
     D                 DS
     D  TVNT1                  1      5  0
     D  TVNT2                  6     10  0
     D  TVNT3                 11     15  0
     D  TVNT4                 16     20  0
     D  TVNT5                 21     25  0
     D  MN3                    1     25  0 DIM(5)
     D                 DS
     D  TVNTEH1                1      5  0
     D  TVNTEH2                6     10  0
     D  TVNTEH3               11     15  0
     D  TVNTEH4               16     20  0
     D  TVNTEH5               21     25  0
     D  MN4                    1     25  0 DIM(5)

      *get input-string
      /copy syspeds/qrpgsrcpy,prolog3

      * Parse input
     C                   exsr      Parse
      * Open files etc
     C                   EXSR      INIT
      *
     c                   callp     gethtmlifs(
     C                             '/syspeddev/html/JSON.html':
     C                             '/CGITAG/')
     C                   callp     wrtsection('top')
      *
      * ............................................................................................
      * skriv JSON-Object start..(alltid '{' + x ant param. m/komma mellom (IKKE komma etter siste))
      * ............................................................................................
      *
      /free
        JSONstring='{'
        +'¬user¬ : ¬'+%trim(WSUSER)+'¬, '
        +'¬tvavd¬ : ¬'+%trim(%editc(TVAVD:'Z'))+'¬, '
        +'¬tvtdn¬ : ¬'+%trim(%editc(TVTDN:'Z'))+'¬, '
        +'¬errMsg¬ : ¬'+%trim(Error)+'¬, ';
      /end-free
      * JSONfix escaper " i tekst,  for deretter å bytte ¬->"
     c                   call      'JSONFIX'
     c                   parm                    JSONstring
     C*                  callp     updHTMLvar('JSONstring':JSONstring)
     C                   CALLP     updHTMLvar2('JSONstring'
     C                                         :%addr(JSONstring)
     C                                         :%len(JSONstring))
     C                   callp     wrtsection('JSONlin')
      *
      * ............................................................................................
      * Skriv JSON-LISTE Start (en liste er EN parameter(fra [ til   )
      * ............................................................................................
     c                   eval      JSONstring ='"orderList" : ['
     C*                  callp     updHTMLvar('JSONstring':JSONstring)
     C                   CALLP     updHTMLvar2('JSONstring'
     C                                         :%addr(JSONstring)
     C                                         :%len(JSONstring))
     C                   callp     wrtsection('JSONlin')
      *
      * Liste Ærende
      *
     c     Error         ifeq      *blanks
     C                   MOVE      *BLANKS       MN1
     C                   MOVE      *BLANKS       MN2
     C                   MOVE      *ZEROS        MN3
     C                   MOVE      *ZEROS        MN4
     C     SVXVkey       setll     SVXV
     C     SVXVkey       READE     SVXV                                   55
     C     *IN55         DOWEQ     '0'
     C                   MOVE      TVMN          MN1(1)
     C                   MOVE      TVEH          MN2(1)
     C                   MOVE      TVNT          MN3(1)
     C                   MOVE      TVNTEH        MN4(1)
     C     SVXVAMK       CHAIN     SVXVAM                             33
     C                   IF        *IN33
     C                   EVAL      TVKNS  = 0
     C                   EVAL      TVNAS  = *BLANKS
     C                   EVAL      TVADS1 = *BLANKS
     C                   EVAL      TVPNS  = *BLANKS
     C                   EVAL      TVPSS  = *BLANKS
     C                   EVAL      TVLKS  = *BLANKS
     C                   EVAL      TVSKS  = *BLANKS
     C                   EVAL      TVTINS = *BLANKS
     C                   EVAL      TVKNK  = 0
     C                   EVAL      TVNAK  = *BLANKS
     C                   EVAL      TVADK1 = *BLANKS
     C                   EVAL      TVPNK  = *BLANKS
     C                   EVAL      TVPSK  = *BLANKS
     C                   EVAL      TVLKK  = *BLANKS
     C                   EVAL      TVSKK  = *BLANKS
     C                   EVAL      TVTINK = *BLANKS
     C                   END
      *
     C                   Z-ADD     1             XN                3 0
     C     SVXVAMK       SETLL     SVXVMN
     C     SVXVAMK       READE     SVXVMN                                 33
     C                   DOW       *IN33 = *OFF
     C                   ADD       1             XN                3 0
     C                   MOVE      TVMN          MN1(XN)
     C                   MOVE      TVEH          MN2(XN)
     C                   MOVE      TVNT          MN3(XN)
     C                   MOVE      TVNTEH        MN4(XN)
     C     SVXVAMK       READE     SVXVMN                                 33
     C  N33              ENDDO
      *
     C                   Add       1             AntLest
      * ............................................................................................
      * Skriv en JSON-Array-linje pr menypunkt - komma før hvert nytt element
      * ............................................................................................
      /free
       if AntLest=1;
          JSONstring=*blanks;
          else;
          JSONstring=', ';
          endif;
       JSONstring=%trim(JSONstring)+'{'
          +'¬tvavd¬ : ¬'+%trim(%editc(TVAVD:'Z'))+'¬, '
          +'¬tvtdn¬ : ¬'+%trim(%editc(TVTDN:'Z'))+'¬, '
          +'¬tvli¬ : ¬'+%trim(%editc(TVLI:'Z'))+'¬, '
          +'¬tvvnt¬ : ¬'+%trim(%editc(TVVNT:'4'))+'¬, '
          +'¬tvdk¬ : ¬'+%trim(TVDK)+'¬, '
          +'¬tvvt¬ : ¬'+%trim(TVVT)+'¬, '
          +'¬tvvtsk¬ : ¬'+%trim(TVVTSK)+'¬, '
          +'¬tvvktb¬ : ¬'+%trim(%editc(TVVKTB:'4'))+'¬, '
          +'¬tvvktn¬ : ¬'+%trim(%editc(TVVKTN:'4'))+'¬, '
          +'¬tvalk¬ : ¬'+%trim(TVALK)+'¬, '
          +'¬tvblk¬ : ¬'+%trim(TVBLK)+'¬, '
          +'¬tvtdt¬ : ¬'+%trim(TVTDT)+'¬, '
          +'¬tvtdr¬ : ¬'+%trim(TVTDR)+'¬, '
          +'¬tvtdsk¬ : ¬'+%trim(TVTDSK)+'¬, '
          +'¬tvtdo¬ : ¬'+%trim(TVTDO)+'¬, '
          +'¬tvtdos¬ : ¬'+%trim(TVTDOS)+'¬, '
          +'¬tvdty¬ : ¬'+%trim(TVDTY)+'¬, '
          +'¬tvdref¬ : ¬'+%trim(TVDREF)+'¬, '
          +'¬tvdsk¬ : ¬'+%trim(TVDSK)+'¬, '
          +'¬tvdo¬ : ¬'+%trim(TVDO)+'¬, '
          +'¬tvdosk¬ : ¬'+%trim(TVDOSK)+'¬, '
          +'¬tvmtxt¬ : ¬'+%trim(TVMTXT)+'¬, '
          +'¬tvmsk¬ : ¬'+%trim(TVMSK)+'¬, '
          +'¬tvtlo¬ : ¬'+%trim(TVTLO)+'¬, '
          +'¬tvexkd¬ : ¬'+%trim(%editc(TVEXKD:'Z'))+'¬, '
          +'¬tvexlk¬ : ¬'+%trim(TVEXLK)+'¬, '
          +'¬tvavd2¬ : ¬'+%trim(%editc(TVAVD2:'Z'))+'¬, '
          +'¬tvtdn2¬ : ¬'+%trim(%editc(TVTDN2:'Z'))+'¬, '
          +'¬tvcnr¬ : ¬'+%trim(TVCNR)+'¬, '
          +'¬tvmn¬ : ¬'+%trim(TVMN1)+'¬, '
          +'¬tvmn2¬ : ¬'+%trim(TVMN2)+'¬, '
          +'¬tvmn3¬ : ¬'+%trim(TVMN3)+'¬, '
          +'¬tvmn4¬ : ¬'+%trim(TVMN4)+'¬, '
          +'¬tvmn5¬ : ¬'+%trim(TVMN5)+'¬, '
          +'¬tvmnsk¬ : ¬'+%trim(TVMNSK)+'¬, '
          +'¬tveh¬ : ¬'+%trim(TVEH1)+'¬, '
          +'¬tveh2¬ : ¬'+%trim(TVEH2)+'¬, '
          +'¬tveh3¬ : ¬'+%trim(TVEH3)+'¬, '
          +'¬tveh4¬ : ¬'+%trim(TVEH4)+'¬, '
          +'¬tveh5¬ : ¬'+%trim(TVEH5)+'¬, '
          +'¬tvnt¬ : ¬'+%trim(%editc(TVNT1:'Z'))+'¬, '
          +'¬tvnt2¬ : ¬'+%trim(%editc(TVNT2:'Z'))+'¬, '
          +'¬tvnt3¬ : ¬'+%trim(%editc(TVNT3:'Z'))+'¬, '
          +'¬tvnt4¬ : ¬'+%trim(%editc(TVNT4:'Z'))+'¬, '
          +'¬tvnt5¬ : ¬'+%trim(%editc(TVNT5:'Z'))+'¬, '
          +'¬tvnteh¬ : ¬'+%trim(%editc(TVNTEH1:'Z'))+'¬, '
          +'¬tvnteh2¬ : ¬'+%trim(%editc(TVNTEH2:'Z'))+'¬, '
          +'¬tvnteh3¬ : ¬'+%trim(%editc(TVNTEH3:'Z'))+'¬, '
          +'¬tvnteh4¬ : ¬'+%trim(%editc(TVNTEH4:'Z'))+'¬, '
          +'¬tvnteh5¬ : ¬'+%trim(%editc(TVNTEH5:'Z'))+'¬, '
          +'¬tvfv¬ : ¬'+%trim(TVFV)+'¬, '
          +'¬tvfvnt¬ : ¬'+%trim(%editc(TVFVNT:'4'))+'¬, '
          +'¬tvkns¬ : ¬'+%trim(%editc(TVKNS:'Z'))+'¬, '
          +'¬tvnas¬ : ¬'+%trim(TVNAS)+'¬, '
          +'¬tvads1¬ : ¬'+%trim(TVADS1)+'¬, '
          +'¬tvpns¬ : ¬'+%trim(TVPNS)+'¬, '
          +'¬tvpss¬ : ¬'+%trim(TVPSS)+'¬, '
          +'¬tvlks¬ : ¬'+%trim(TVLKS)+'¬, '
          +'¬tvsks¬ : ¬'+%trim(TVSKS)+'¬, '
          +'¬tvtins¬ : ¬'+%trim(TVTINS)+'¬, '
          +'¬tvknk¬ : ¬'+%trim(%editc(TVKNK:'Z'))+'¬, '
          +'¬tvnak¬ : ¬'+%trim(TVNAK)+'¬, '
          +'¬tvadk1¬ : ¬'+%trim(TVADK1)+'¬, '
          +'¬tvpnk¬ : ¬'+%trim(TVPNK)+'¬, '
          +'¬tvpsk¬ : ¬'+%trim(TVPSK)+'¬, '
          +'¬tvlkk¬ : ¬'+%trim(TVLKK)+'¬, '
          +'¬tvskk¬ : ¬'+%trim(TVSKK)+'¬, '
          +'¬tvtink¬ : ¬'+%trim(TVTINK)+'¬, '
          +'¬tvln¬ : ¬'+%trim(%editc(TVLN:'Z'))+'¬, '
          +'¬tvrefl¬ : ¬'+%trim(%editc(TVREFL:'Z'))+'¬}';
      /end-free
     C                   call      'JSONFIX'
     C                   parm                    JSONstring
     C*                  callp     updHTMLvar('JSONstring':JSONstring)
     C                   CALLP     updHTMLvar2('JSONstring'
     C                                         :%addr(JSONstring)
     C                                         :%len(JSONstring))
     C                   callp     wrtsection('JSONlin')
      *
     C     SVXVkey       READE     SVXV                                   55
     C                   ENDDO
     c                   endif
      * ............................................................................................
      * Skriv JSON-Liste/Array  Avslutning
      * ............................................................................................
     c                   eval      JSONstring =']'
     C*                  callp     updHTMLvar('JSONstring':JSONstring)
     C                   CALLP     updHTMLvar2('JSONstring'
     C                                         :%addr(JSONstring)
     C                                         :%len(JSONstring))
     C                   callp     wrtsection('JSONlin')
      * ............................................................................................
      * Skriv JSON-string Avsluttning
      * ............................................................................................
     c                   eval      JSONstring ='}'
     C*                  callp     updHTMLvar('JSONstring':JSONstring)
     C                   CALLP     updHTMLvar2('JSONstring'
     C                                         :%addr(JSONstring)
     C                                         :%len(JSONstring))
     C                   callp     wrtsection('JSONlin')
      *
      * Quit
     C                   exsr      Exit


      *=====================================================================
      * Close output html and quit
      *=====================================================================
     C     Exit          begsr
      * Lukk fil
     C                   CLOSE     BRIDF
     C  N50              CLOSE     SVXV
     C  N50              CLOSE     SVXVAM
     C  N50              CLOSE     SVXVMN

      * Do not delete the call to wrtsection with section name *fini.  It is needed
      * to ensure that all output html that has been buffered gets output.
     C                   callp     wrtsection('*fini')
      * Quit
     C                   MOVE      *ON           *INLR
     C                   return
     C                   endsr
      *
      *********************************************************
     C     Parse         Begsr
      *********************************************************
      * Get input
     C                   EVAL      WSUSER  = zhbgetvar('USER')
     C                   EVAL      TVAVD_A = zhbgetvar('AVD')
     C                   EVAL      TVAVD   = c2n2(TVAVD_A)
     C                   EVAL      TVTDN_A = zhbgetvar('OPD')
     C                   EVAL      TVTDN   = c2n2(TVTDN_A)
     c                   endsr
      *
      *********************************************************
     C     INIT          Begsr
      *********************************************************
     C                   OPEN      BRIDF
      * Test innlogging
     C     WSUSER        CHAIN     BRIDF                              50
     C     BILIBL        ifeq      *blanks
     C                   callb     'INCGI'
     C                   parm                    BISTDL
     C                   else
     C                   call      BILIBL
     C                   end
      *
     C     SVXVkey       klist
     C                   kfld                    TVAVD
     C                   kfld                    TVTDN
     C     SVXVAMK       klist
     C                   kfld                    TVAVD
     C                   kfld                    TVTDN
     C                   kfld                    TVLI
      *
     C   50              eval      Error = 'Invalid userID'
     C  N50              OPEN      SVXV
     C  N50              OPEN      SVXVAM
     C  N50              OPEN      SVXVMN

     c                   endsr
      *
