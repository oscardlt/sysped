********************************************************************
      * RETTINGER I DETTE PROGRAM:
PTFnr:*Sek Sig Vers  Beskrivelse...........................
""""""*"""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""
12XXX * 01 CB  PTF12 Nå med kundenavn
12069 * 02 CB  PTF12 Egen behandling av omberegning
12069 * 03 SH  PTF12 bestilling foretaksnummer
12XXX * 04 CB  PTF12 Ny logisk fil SADH15
********************************************************************
     h decedit(',') DftActGrp( *No ) debug(*yes)
N03  fcundlfo   if   e           k disk
N03  ffirm      if   e           k disk
S04  f*sadh2b    if   e           k disk
N04  fsadh15    if   e           k disk
     fsadf      if   e           k disk
     ffrisok    if   e           k disk
     fsad62aw   if   e           k disk
     fsad62bw   if   e           k disk
     fsad62cw   uf a e             disk
     d                 ds
     d sidtg                         10
     d  sidtg8                        8    overlay(sidtg)

     d  siavda         s              4
     d  sitdna         s              7
     d  wfirst         s              1
     d  wfirst2        s              1
     ‚*  Prototype for sad62r3
     d sad62r3         pr
     d wsiknka_                            like(wsiknka)
     d wforet_                             like(wforet)
     d wdatof_                             like(wdatof)
     d wdatot_                             like(wdatot)
     d wfilnam_                            like(wfilnam)
     ‚*  Prototype for 'SAD62R4'
     d sad62r4         pr                  extpgm('SAD62R4')
     d siavd_                              like(siavd)
     d sitdn_                              like(sitdn)
     ‚*  Prototype for 'SAD62R5'
     d sad62r5         pr                  extpgm('SAD62R5')
     d wfilnam_                            like(wfilnam)
     ‚*  *ENTRY Interface for Main Procedure
     d sad62r3         pi
     d wsiknka                        8
N03  d wforet                         9
     d wdatof                         8
     d wdatot                         8
     d wfilnam                      256
     ‚*----------------------------------------------------------------------
     ‚* Stand Alone Fields - TOP
     ‚*----------------------------------------------------------------------
     d wsiknk          s                   like(siknk)
N02  d wsitdn          s                   like(sitdn)
     ‚*----------------------------------------------------------------------
     ‚* Stand Alone Fields - BOTTOM
     ‚*----------------------------------------------------------------------
      /free
          dump;
       ///////////////
       // Hodelogikk /
       ///////////////

           if wforet<>*blanks;
       exsr sr0;
       else;
       exsr sra;
       exsr srb;
       exsr src;
       exsr srd;
       endif;
       *inlr = *on;
       //////////////////////////////////////////////////////////////
       //  looper på foretaksnummer                             SR0 /
       //////////////////////////////////////////////////////////////
       begsr sr0;
      /end-free
     ‚*_________________
     ‚* Input parametere
     ‚*"""""""""""""""""
     c                   eval      syrg=wforet
     c                   read      firm                                   33
      /free
         setll (fifirm: syrg) cundlfo;
         reade (fifirm: syrg) cundlfo;
         *in53 = %eof;

         dow *in53 = *off;

         wsiknk=kundnr;
         exsr srb;
         exsr src;
         exsr srd;

         reade (fifirm: syrg) cundlfo;
         *in53 = %eof;
         enddo;
       endsr;
       //////////////////////////////////////////////////////////////
       //  Initiering                                           SRA /
       //////////////////////////////////////////////////////////////
       begsr sra;
      /end-free
     ‚*_________________
     ‚* Input parametere
     ‚*"""""""""""""""""
     c                   move      wsiknka       wsiknk
N04  c                   MOVEL     wdatof        wdatof10         10
N04  C     WKEY1         KLIST
N04  C                   KFLD                    WSIKNK
N04  C                   KFLD                    WDATOF10
      /free
       endsr;
       //////////////////////////////////////////////////////////////
       //  Detaljer                                             SRB /
       //////////////////////////////////////////////////////////////
       begsr srb;

         setll wkey1 sadh15;
         reade wsiknk sadh15;
         *in51 = %eof;

         dow *in51 = *off;

                               IF        SITLL <> *BLANKS;
                               IF        SIDTG8 >= WDATOF;
                               IF        SIDTG8 <= WDATOT;
           if simva = 'J';
             if si0035 = ' ';
          // if sikddk = ' ';
               exsr srba;
          // endif;
             endif;
           endif;
                               ENDIF;
                               ENDIF;
                               ENDIF;

           reade wsiknk sadh15;
           *in51 = %eof;
         enddo;
       endsr;
       //////////////////////////////////////////////////////////////
       //  Summer og sorter avgifter per deklarasjon          SRBA /
       //////////////////////////////////////////////////////////////
       begsr srba;
         // Fix data i arbetsfiler
         sad62r4 ( siavd : sitdn );
         // Skriv detaljer til resultatfil
         exsr srbaa;
       endsr;
       //////////////////////////////////////////////////////////////
       //  Skriv detaljer til resultatfil                    SRBAA /
       //////////////////////////////////////////////////////////////
       begsr srbaa;

         wfirst=*blanks;

         setll ( siavd : sitdn ) sad62aw;
         reade ( siavd : sitdn ) sad62aw;
         *in52 = %eof;
         dow *in52 = *off;

           if wfirst=*blanks;
             wfirst='X';
             clear sad62cwr;
             write sad62cwr;
           endif;

           clear sad62cwr;
           sad62c1='D';
           sad62c2=sidtg8;
           sad62c3=sitle;
           sad62c4=sitll;
           siavda = %editc(siavd:'X');
           sitdna = %editc(sitdn:'X');
           sad62c5=siavda+'/'+sitdna+'/'+sisg;
           sad62c6=sad62a4;
           sad62c7 = %editc(sad62a5:'L');
           sad62c8 = %editc(sad62a6:'L');
           sad62c9 = %editc(sad62a7:'L');
           sad62ca=wdatof;
           sad62cb=wdatot;
           exsr srbaaa;
           exsr srbaab;

N02          if sitdn < 0;
N02            wsitdn = sitdn * -1;
N02            sitdna = %editc(wsitdn:'X');
N02            sad62c5=siavda+'/'+sitdna+'/'+sisg;
N02            sad62c1='O';
N02          endif;

           write sad62cwr;

           reade ( siavd : sitdn ) sad62aw;
           *in52 = %eof;
         enddo;

       endsr;
       //////////////////////////////////////////////////////////////
       //  Skriv detaljer til resultatfil, kunderef         SRBAAA //
       //////////////////////////////////////////////////////////////
       begsr srbaaa;
         wfirst2=*blanks;

         chain ( siavd : sitdn ) sadf;
         *in54 = not %found;
         if *in54;
        // sad62cc=sifif;
           sad62cc=%trimr(sinak)+'_'+%trimr(sifif);
         else;

           setll ( siavd : sitdn ) sadf;
           reade ( siavd : sitdn ) sadf;
           *in55 = %eof;
           dow *in55 = *off;
             if wfirst2=*blanks;
               wfirst2='X';
          //   sad62cc=%trimr(sftxt);
               sad62cc=%trimr(sinak)+'_'+%trimr(sftxt);
             else;
               sad62cc=%trimr(sad62cc)+'_'+%trimr(sftxt);
             endif;

             reade ( siavd : sitdn ) sadf;
             *in55 = %eof;
           enddo;
         endif;

       endsr;
       //////////////////////////////////////////////////////////////
       //  Skriv detaljer til resultatfil, Vår ref          SRBAAB
       //////////////////////////////////////////////////////////////
       begsr srbaab;

         chain ( siavd : sitdn : '*CR') frisok;
         if %found;
           sad62c5=*blanks;
           sad62c5=fssok;
         endif;

       endsr;
       //////////////////////////////////////////////////////////////
       //  Skriv total til resultatfil                         SRC /
       //////////////////////////////////////////////////////////////
       begsr src;

         clear sad62cwr;
         write sad62cwr;

         setll *loval sad62bw;
         read sad62bw;
         *in56 = %eof;
         dow *in56 = *off;

           if sad62b4='MV';
             clear sad62cwr;
             sad62c1='T';
             sad62c6=sad62b4;
             sad62c7 = %editc(sad62b5:'L');
             sad62c8 = %editc(sad62b6:'L');
             sad62c9 = %editc(sad62b7:'L');
             sad62ca=wdatof;
             sad62cb=wdatot;
             write sad62cwr;
           endif;

           read sad62bw;
           *in56 = %eof;
         enddo;

       endsr;
       //////////////////////////////////////////////////////////////
       //  Lag semikolonseparert resultatfil                   SRD /
       //////////////////////////////////////////////////////////////
       begsr srd;
         sad62r5 ( wfilnam );
       endsr;
      /end-free
