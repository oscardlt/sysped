      *********************************************************************
      *
CRTPG+*  CRTPGM SYSPED/TJETUR05LH MODULE(*LIBL/TJETUR05LH *LIBL/INCGI)
CRTPGM*        ACTGRP(*NEW) AUT(*USE) tgtrls(*CURRENT)
      *
********************************************************************
      * RETTINGER I DETTE PROGRAM:
PTFnr:*Sek Sig Vers  Beskrivelse...........................
""""""*"""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""
12XXX * 01 JOV PTF12 ved søk via frie søkeveier gå på tvers av avdelinhger ubetinget..
********************************************************************
      *********************************************************************
      /copy SYSPEDS/qrpgsrcpy,hspecs
      /copy SYSPEDS/qrpgsrcpy,hspecsbnd
      *********************************************************************
     FBRIDF     IF   E           K DISK    USROPN
     FBRPARF    IF   E           K DISK    USROPN
     FHEADF     IF   E           K DISK    USROPN
     FDISP      IF   E           K DISK    USROPN
     FKODTA     IF   E           K DISK    USROPN
     FDOKUF     IF   E           K DISK    USROPN
     FCUNDL01   IF   E           K DISK    USROPN
     FVADR      IF   E           K DISK    USROPN
     FFREETXT2  IF   E           K DISK    USROPN
     FFRISOL01  IF   E           K DISK    USROPN
     FDOKUFM1   IF   E           K DISK    USROPN
     FTRACKL02  IF   E           K DISK    USROPN
      *--------------------------------------------------------------------
      * Variables common to all CGIs
      *--------------------------------------------------------------------
      /copy SYSPEDS/qrpgsrcpy,prototypeb
      /copy SYSPEDS/qrpgsrcpy,usec
      /copy SYSPEDS/qrpgsrcpy,variables3
     ‚*  Prototype for 'JSONFIX'
     d jsonfix         pr                  extpgm('JSONFIX')
     d jsonstring_                         like(jsonstring)
     ‚*  Prototype for 'INCGI'
     d incgi           pr                  extproc('INCGI')
     d bistdl_                             like(bistdl)
     ‚*  Prototype for variabel program
     D Varpgm          Pr                  ExtPgm(BILIBL)
TMP  d DISTA1          s              1
TMP  d WsToll          s              4
      * for å bygge tekstkonstanter som skal inn i SQL-kommandoen
     d SelectC         s          10000                                         Select kolonner...
     d WhereC          s           5000                                         Utvalgs-Vilkår
     d OrderC          s            500                                         Order by = sortering
     d LimitC          s             20                                         Limit statement
     d AvdGrpC         s            500                                         avd-gruppe
     d SqlStm          s          10000
     d FirstW          s              1
     d VisSqlCmd       s              1
     d cQuote          c                   const('''')
     D WSUSER          S             10
     D WSSAVD          S              4
     D WBSAVD          S              4  0
     D WSSOPD          S              7
     D WBSOPD          S              7  0
     D WBETD           S              8  0
     D WBETA           S              8  0
     D WBATD           S              8  0
     D WBATA           S              8  0
     D WSSDF           S              8
     D WSSDT           S              8
     D WSOT            S              2
     D WSSG            S              3
     D WSRFA           S             35
     D WSDISTA         S              1                                         Dispstatus *=alle
     D WSGN            S             15
     D WSSNDN          S             20
     D WSCLID          S             35
     D MaxClId         S             35
     D WSOPDGI         S             20
     D WSOPDGIN        S              8  0
     D WSAVS           S             20
     D WSAVSN          S              8  0
     D WSMOT           S             20
     D WSMOTN          S              8  0
     D WSTUR           S              8
     D WSTURN          S              8  0
     D WSTRA           S              8
     D WSTRAN          S              8  0
     D WSFSKOD         S              3
     D WSFSSOK         S             35
     D MaxFsSok        S             35
     D TstSte          S              8
     D MaxSte          S              8
     D WOPDTF          S              8
     D WOPDTFN         S              8  0
     D WOPDTT          S              8
     D WOPDTTN         S              8  0
     D WSPREBOOK       S              1
     D PostOK          S              1
     D HENLEV          s              6
     D JSONstring      s          32000
     D Error           S            150
     D WSLIMIT         S              5
     D WSLIMITN        S              5  0
     D AntLest         S              9  0
     d X               S             10  0
     D InternInfo      S            700
     D HENASutv        S            150
     D HENAKutv        S            150
     D Num4            S              4  0
     D Seconds         S             15  3
     D Runtime         S             50
      * Array/datastrukttur som mottar rows fra SQL mor HEADF
     d DsHeadfSize     s             10i 0
      * OBS!! rekkefølgen må være 100% lik feltene/kolonnene i Select (se sr SelCol..)
     d HeadfDs         ds                  Qualified  dim(500)
     d  heur                               like(heur    )
     d  heavd                              like(heavd   )
     d  heopd                              like(heopd   )
     d  hesg                               like(hesg    )
     d  hedtop                             like(hedtop  )
     d  hedtr                              like(hedtr   )
     d  hesdff                             like(hesdff  )
     d  hesdf                              like(hesdf   )
     d  hesdt                              like(hesdt   )
     d  hesdvt                             like(hesdvt  )
     d  hegn                               like(hegn    )
     d  hegnn                              like(hegnn   )
     d  hepro                              like(hepro   )
     d  heplan                             like(heplan  )
     d  trrund                             like(trrund  )
     d  hepos1                             like(hepos1  )
     d  hepos2                             like(hepos2  )
     d  trknfa                             like(trknfa  )
     d  henao                              like(henao   )
     d  hekna                              like(hekna   )
     d  henaa                              like(henaa   )
     d  herfa                              like(herfa   )
     d  hesaml                             like(hesaml  )
     d  hehawb                             like(hehawb  )
     d  hesdla                             like(hesdla  )
     d  hesdl                              like(hesdl   )
     d  hevalt                             like(hevalt  )
     d  hevalp                             like(hevalp  )
     d  heknt                              like(heknt   )
     d  helka                              like(helka   )
     d  hekns                              like(hekns   )
     d  henas                              like(henas   )
     d  heads1                             like(heads1  )
     d  heads2                             like(heads2  )
     d  hepns                              like(hepns   )
     d  heads3                             like(heads3  )
     d  helks                              like(helks   )
     d  heknh                              like(heknh   )
     d  henah                              like(henah   )
     d  headh1                             like(headh1  )
     d  headh2                             like(headh2  )
     d  hepnh                              like(hepnh   )
     d  headh3                             like(headh3  )
     d  helkh                              like(helkh   )
     d  hehbre                             like(hehbre  )
     d  hehlen                             like(hehlen  )
     d  hehblk                             like(hehblk  )
     d  hekdfs                             like(hekdfs  )
     d  hevals                             like(hevals  )
     d  heknsf                             like(heknsf  )
     d  heans                              like(heans   )
     d  henasf                             like(henasf  )
     d  heknk                              like(heknk   )
     d  henak                              like(henak   )
     d  headk1                             like(headk1  )
     d  headk2                             like(headk2  )
     d  hepnk                              like(hepnk   )
     d  headk3                             like(headk3  )
     d  helkk                              like(helkk   )
     d  heknl                              like(heknl   )
     d  henal                              like(henal   )
     d  headl1                             like(headl1  )
     d  headl2                             like(headl2  )
     d  hepnl                              like(hepnl   )
     d  headl3                             like(headl3  )
     d  helkl                              like(helkl   )
     d  helbre                             like(helbre  )
     d  hellen                             like(hellen  )
     d  helblk                             like(helblk  )
     d  hekdfk                             like(hekdfk  )
     d  hevalk                             like(hevalk  )
     d  heknkf                             like(heknkf  )
     d  heank                              like(heank   )
     d  henakf                             like(henakf  )
     d  heot                               like(heot    )
     d  hekdpl                             like(hekdpl  )
     d  hefr                               like(hefr    )
     d  hent                               like(hent    )
     d  hevs1                              like(hevs1   )
     d  hevs2                              like(hevs2   )
     d  hegm1                              like(hegm1   )
     d  hegm2                              like(hegm2   )
     d  hevkt                              like(hevkt   )
     d  helm                               like(helm    )
     d  hem3                               like(hem3    )
     d  hefbv                              like(hefbv   )
     d  hekf                               like(hekf    )
     d  hekft1                             like(hekft1  )
     d  heft1                              like(heft1   )
     d  hedtcp                             like(hedtcp  )
     d  hedtÅp                             like(hedtÅp  )
     d  hedtmp                             like(hedtmp  )
     d  hekdkk                             like(hekdkk  )
     d  hefngk                             like(hefngk  )
     d  hefngs                             like(hefngs  )
     d  hekdtm                             like(hekdtm  )
     d  hetrm                              like(hetrm   )
     d  hetri                              like(hetri   )
     d  hetrc                              like(hetrc   )
     d  hetrcn                             like(hetrcn  )
     d  hefbk                              like(hefbk   )
     d  hetle                              like(hetle   )
     d  hetll                              like(hetll   )
     d  hetlku                             like(hetlku  )
     d  hentvs                             like(hentvs  )
     d  hevn                               like(hevn    )
     d  hentf                              like(hentf   )
     d  hebelt                             like(hebelt  )
     d  hebelm                             like(hebelm  )
     d  hesgm                              like(hesgm   )
     d  hedtmo                             like(hedtmo  )
     d  heklmo                             like(heklmo  )
     d  hepk1                              like(hepk1   )
     d  hepk2                              like(hepk2   )
     d  hepk3                              like(hepk3   )
     d  hepk4                              like(hepk4   )
     d  hepk5                              like(hepk5   )
     d  hepk6                              like(hepk6   )
     d  hepk7                              like(hepk7   )
     d  hepk8                              like(hepk8   )
     d  hepk9                              like(hepk9   )
     d  hekdl                              like(hekdl   )
     d  helb                               like(helb    )
     d  helkfr                             like(helkfr  )
     d  hesdfr                             like(hesdfr  )
     d  hestfr                             like(hestfr  )
     d  herfk                              like(herfk   )
     d  trslag                             like(trslag  )
     d  travd0                             like(travd0  )
     d  tropd0                             like(tropd0  )
     d  travd1                             like(travd1  )
     d  tropd1                             like(tropd1  )
     d  travd2                             like(travd2  )
     d  tropd2                             like(tropd2  )
     d  trsffd                             like(trsffd  )
     d  trsffk                             like(trsffk  )
     d  trsdfd                             like(trsdfd  )
     d  trsdfk                             like(trsdfk  )
     d  trsdtd                             like(trsdtd  )
     d  trsdtk                             like(trsdtk  )
     d  trsvtd                             like(trsvtd  )
     d  trsvtk                             like(trsvtk  )
     d  trkdak                             like(trkdak  )
     d  trkdff                             like(trkdff  )
     d  trverv                             like(trverv  )
     d  trverb                             like(trverb  )
     d  trettv                             like(trettv  )
     d  trettb                             like(trettb  )
     d  trfrak                             like(trfrak  )
     d  trfrav                             like(trfrav  )
     d  trfrab                             like(trfrab  )
     d  trmva                              like(trmva   )
     d  trfa11                             like(trfa11  )
     d  trfa12                             like(trfa12  )
     d  trflP1                             like(trflP1  )
     d  trfa21                             like(trfa21  )
     d  trfa22                             like(trfa22  )
     d  trflp2                             like(trflp2  )
     d  trtsta                             like(trtsta  )
     d  trstaf                             like(trstaf  )
     d  trstae                             like(trstae  )
     d  trsta1                             like(trsta1  )
     d  trsta2                             like(trsta2  )
     d  trsta3                             like(trsta3  )
     d  trsta4                             like(trsta4  )
     d  trkm                               like(trkm    )
     d  he01                               like(he01    )
     d  hestd                              like(hestd   )
     d  hxsndn                             like(hxsndn  )
     d  hxpall                             like(hxpall  )
     d  hxblgk                             like(hxblgk  )
     d  hxLkod                             like(hxLkod  )
     d  hxllst                             like(hxllst  )
     d  hxedik                             like(hxedik  )
     d  hxteri                             like(hxteri  )
     d  hehakn                             like(hehakn  )
     d  hehaan                             like(hehaan  )
     d  helakn                             like(helakn  )
     d  helaan                             like(helaan  )
     d  helmla                             like(helmla  )
     d  hepoen                             like(hepoen  )
     d  hestl1                             like(hestl1  )
     d  hestl2                             like(hestl2  )
     d  hestl3                             like(hestl3  )
     d  hestl4                             like(hestl4  )
     d  hestn1                             like(hestn1  )
     d  hestn2                             like(hestn2  )
     d  hestn3                             like(hestn3  )
     d  hestn4                             like(hestn4  )
     d  hestn5                             like(hestn5  )
     d  hestn6                             like(hestn6  )
     d  hestn7                             like(hestn7  )
     d  hestn8                             like(hestn8  )
     d  hestn9                             like(hestn9  )
     d  herfed                             like(herfed  )
     d  helib                              like(helib   )
     d  hefile                             like(hefile  )
     d  hembr                              like(hembr   )
     d  hetype                             like(hetype  )
     d  helvl                              like(helvl   )
     d  hesnn                              like(hesnn   )
     d  heunik                             like(heunik  )
     d  hereff                             like(hereff  )

      *get input-string
      /copy syspeds/qrpgsrcpy,prolog3

      /free
       timedata1 = %timestamp();
       exsr ParseSr;
       exsr init;

       // flagg J/N for om SQL-kommando skal vises i Json (rett etter liste)
       visSqlCmd = 'J';

       gethtmlifs(
       '/syspeddev/html/JSON.html':
       '/CGITAG/');
       wrtsection('top');

       //...........................................................................................
       //skriv JSON-Object start (alltid '{' + x ant param. m/komma mellom (IKKE komma etter siste))
       //...........................................................................................

        JSONstring='{'
          +'¬user¬ : ¬'+%trim(WSUSER)+'¬, '
          +'¬errMsg¬ : ¬'+%trim(Error)+'¬, ';

       //JSONfix escaper " i tekst,  for deretter å bytte ¬->"

       jsonfix ( jsonstring );

       updhtmlvar2('JSONstring'
                  :%addr(jsonstring)
                  :%len(jsonstring));
       wrtsection('JSONlin');

       //...........................................................................................
       // Skriv JSON-LISTE Start (en liste er EN parameter(fra [ til   )
       //..........................................................................................
       jsonstring ='"orderlistlandled" : [';

       updhtmlvar2('JSONstring'
                  :%addr(jsonstring)
                  :%len(jsonstring));
       wrtsection('JSONlin');

       if error = *blanks;
          // først div søk som ikke etr nbasert på HEADF
         select;
         // Frie søkeveier
         when WSFSKOD <> *blanks and WSFSSOK <> *blanks;
           exsr LesSrFS;
         // Fraktbrevsnr (via Frie søkeveier IFB)
         // MED TIDEN ta høyde for at dette også kan være via HEAD39../ SQL
         when WSSNDN <> *blanks;
           WSFSKOD = 'IFB';
           if %subst(WSSNDN:1:3)='401' and %subst(WSSNDN:20:1)<>' ';
             WSFSSOK = %subst(WSSNDN:4:17);
           else;
             WSFSSOK = WSSNDN;
           endif;
           exsr LesSrFS;
         // Kolli-ID / Godsmerke
         when WSCLID <> *blanks;
           if %subst(WSCLID:1:2)='00' and %subst(WSCLID:20:1)<>' ';
             WSCLID  = %subst(WSCLID:3:18);
           else;
             WSCLID  = WSCLID;
           endif;
           exsr LesSrCL;
         // ALT basert på HEAD via SQL
         other;
           exsr SelSr;
           if DsHeadfSize > 0        // egentlig tull - alltid fast verdi (500)
              and error = *blanks;
             exsr LesSr;
           endif;
         endsl;
       endif;
       // ..........................................................................................
       // Skriv JSON-Liste/Array  Avslutning
       // ..........................................................................................
       jsonstring =']';
       updhtmlvar2('JSONstring'
                  :%addr(jsonstring)
                  :%len(jsonstring));
       wrtsection('JSONlin');
       // ..........................................................................................
       // legg ut benytte sql Statement (hvis valgt..)
       // ..........................................................................................
       if visSqlCmd = 'J';
         jsonstring =', "sqlStm" : "'+%trim(SQLStm)+'"';
         updhtmlvar2('JSONstring'
                    :%addr(jsonstring)
                    :%len(jsonstring));
         wrtsection('JSONlin');
         // ant Records i JSON
         jsonstring =', "antRecs" : "'+%trim(%editc(AntLest:'Z'))+'"';
         updhtmlvar2('JSONstring'
                    :%addr(jsonstring)
                    :%len(jsonstring));
         // Tid i sek (3 desim)
         timedata2 = %timestamp();
         Seconds  = %DIFF (timedata2 : timedata1 : *MS)/1000000;
         RunTime =  %trim(%editc(Seconds:'4'));
         wrtsection('JSONlin');
         jsonstring =', "runTime" : "'+%trim(RUNtime)+' sec"';
         updhtmlvar2('JSONstring'
                    :%addr(jsonstring)
                    :%len(jsonstring));
         wrtsection('JSONlin');
       endif;
       // ..........................................................................................
       // Skriv JSON-string Avsluttning
       // ..........................................................................................
       jsonstring ='}';
       updhtmlvar2('JSONstring'
                  :%addr(jsonstring)
                  :%len(jsonstring));
       wrtsection('JSONlin');
       exsr Exit;

       //*****************************************************************
       begsr     ParseSr;
       //*****************************************************************
       // hent input
          wsUser   = zhbgetvar('user');
          WSDISTA  = zhbgetvar('WSDISTA');     // PR 2018.12.06 - alltid Alle (= *)
          WSSDF    = uppify(zhbgetvar('WSSDF'));
          WSSDT    = uppify(zhbgetvar('WSSDT'));
          WSSAVD   = uppify(zhbgetvar('WSSAVD'));
          WBSAVD   = c2n2(WSSAVD);                // normal er Avs numerisk
          WSSOPD   = zhbgetvar('WSSOPD');
          WBSOPD   = c2n2(WSSOPD);
          WOPDTF   = zhbgetvar('WOPDTF');
          WOPDTFN  = c2n2(WOPDTF);
          WOPDTT   = zhbgetvar('WOPDTT');
          WOPDTTN  = c2n2(WOPDTT);
          WSOT    = uppify(zhbgetvar('WSSOT'));
          WSSG    = uppify(zhbgetvar('WSSSG'));
          WSRFA   = uppify(zhbgetvar('WSRFA'));
          WSGN    = uppify(zhbgetvar('WSGN'));
          WSOPDGI = uppify(zhbgetvar('WSOPDGI'));
          WSOPDGIN= c2n2(WSOPDGI);               // Hvis  numerisk
          if  WSOPDGIN <> *zeros;
            WSOPDGI = *blanks;
          endif;
          WSAVS   = uppify(zhbgetvar('WSAVS'));
          WSAVSN  = c2n2(WSAVS);                 // Hvis  numerisk
          if  WSAVSN <> *zeros;
            WSAVS = *blanks;
          endif;
          WSMOT   = uppify(zhbgetvar('WSMOT'));
          WSMOTN  = c2n2(WSMOT);                 // Hvis  numerisk
          if  WSMOTN <> *zeros;
            WSMOT = *blanks;
          endif;
          WSTUR   = uppify(zhbgetvar('WSTUR'));
          WSTURN  = c2n2(WSTUR);
          WSTRA   = uppify(zhbgetvar('WSTRA'));
          WSTRAN  = c2n2(WSTRA);
          WSSNDN   = zhbgetvar('WSSNDN');
          WSCLID   = zhbgetvar('WSCLID');
          WSFSKOD  = zhbgetvar('WSFSKOD');
          WSFSSOK  = zhbgetvar('WSFSSOK');
          WSPREBOOK= zhbgetvar('WSPREBOOK');

          WSLIMIT  = uppify(zhbgetvar('WSLIMIT'));
          WSLIMITN = c2n2(WSLIMIT);

        endsr;

       //*******************************************************************
       begsr     SelSr;
       //*******************************************************************
       // Select fra fil via SQL

       // A) Select .... Hent kolonner (var SelsectC: Select AAA, BBB, CCC, ... )
         exsr SqlSelCol;

       // B) Where ..... Diverse utvalgsvilkår (var WhereC: Where XXX = 'ABC' and YY. )
         exsr SqlWhere;

       // C) Order by .. Sortering  (var OrderC: Order by XXX desc )
          exsr SqlOrder;

         DsHeadfSize = %elem(HeadfDs);  // denne er uansett statisk 500  (har lite for seg...)
         if WSLIMITN > 0 and WSLIMITN < DsHeadfSize;
           LimitC = 'Limit '+%trim(%editc(WSLIMITN:'Z'));
         endif;

         SqlStm = %trim(SelectC)
                + ' from HEADF '
                +  %trim(WhereC) +' '
                +  %trim(OrderC) +' '
                +  %trim(LimitC) +' '
                + 'FOR READ ONLY ';

         Exec SQL PREPARE DynSel from :SqlStm;
         Exec SQL DECLARE  HeadfCurs  cursor for DynSel;
         Exec SQL OPEN HeadfCurs;
         Exec SQL FETCH HeadfCurs for :DsHeadfSize rows INTO :HeadfDs;
         Exec SQL CLOSE HeadfCurs;

       endsr;
       //*****************************************************************
       begsr     SqlSelCol;
       //*****************************************************************
       // klargjør Select - delen av Sql statement
       // kolonnene må samsvare 100 % med datastrukturen de skal inn i
       // setter kun ett felt pr linje her da det lettet copy paste fra datastrukturen
       SelectC = 'Select '
               + 'heur   , '
               + 'heavd  , '
               + 'heopd  , '
               + 'hesg   , '
               + 'hedtop , '
               + 'hedtr  , '
               + 'hesdff , '
               + 'hesdf  , '
               + 'hesdt  , '
               + 'hesdvt , '
               + 'hegn   , '
               + 'hegnn  , '
               + 'hepro  , '
               + 'heplan , '
               + 'trrund , '
               + 'hepos1 , '
               + 'hepos2 , '
               + 'trknfa , '
               + 'henao  , '
               + 'hekna  , '
               + 'henaa  , '
               + 'herfa  , '
               + 'hesaml , '
               + 'hehawb , '
               + 'hesdla , '
               + 'hesdl  , '
               + 'hevalt , '
               + 'hevalp , '
               + 'heknt  , '
               + 'helka  , '
               + 'hekns  , '
               + 'henas  , '
               + 'heads1 , '
               + 'heads2 , '
               + 'hepns  , '
               + 'heads3 , '
               + 'helks  , '
               + 'heknh  , '
               + 'henah  , '
               + 'headh1 , '
               + 'headh2 , '
               + 'hepnh  , '
               + 'headh3 , '
               + 'helkh  , '
               + 'hehbre , '
               + 'hehlen , '
               + 'hehblk , '
               + 'hekdfs , '
               + 'hevals , '
               + 'heknsf , '
               + 'heans  , '
               + 'henasf , '
               + 'heknk  , '
               + 'henak  , '
               + 'headk1 , '
               + 'headk2 , '
               + 'hepnk  , '
               + 'headk3 , '
               + 'helkk  , '
               + 'heknl  , '
               + 'henal  , '
               + 'headl1 , '
               + 'headl2 , '
               + 'hepnl  , '
               + 'headl3 , '
               + 'helkl  , '
               + 'helbre , '
               + 'hellen , '
               + 'helblk , '
               + 'hekdfk , '
               + 'hevalk , '
               + 'heknkf , '
               + 'heank  , '
               + 'henakf , '
               + 'heot   , '
               + 'hekdpl , '
               + 'hefr   , '
               + 'hent   , '
               + 'hevs1  , '
               + 'hevs2  , '
               + 'hegm1  , '
               + 'hegm2  , '
               + 'hevkt  , '
               + 'helm   , '
               + 'hem3   , '
               + 'hefbv  , '
               + 'hekf   , '
               + 'hekft1 , '
               + 'heft1  , '
               + 'hedtcp , '
               + 'hedtÅp , '
               + 'hedtmp , '
               + 'hekdkk , '
               + 'hefngk , '
               + 'hefngs , '
               + 'hekdtm , '
               + 'hetrm  , '
               + 'hetri  , '
               + 'hetrc  , '
               + 'hetrcn , '
               + 'hefbk  , '
               + 'hetle  , '
               + 'hetll  , '
               + 'hetlku , '
               + 'hentvs , '
               + 'hevn   , '
               + 'hentf  , '
               + 'hebelt , '
               + 'hebelm , '
               + 'hesgm  , '
               + 'hedtmo , '
               + 'heklmo , '
               + 'hepk1  , '
               + 'hepk2  , '
               + 'hepk3  , '
               + 'hepk4  , '
               + 'hepk5  , '
               + 'hepk6  , '
               + 'hepk7  , '
               + 'hepk8  , '
               + 'hepk9  , '
               + 'hekdl  , '
               + 'helb   , '
               + 'helkfr , '
               + 'hesdfr , '
               + 'hestfr , '
               + 'herfk  , '
               + 'trslag , '
               + 'travd0 , '
               + 'tropd0 , '
               + 'travd1 , '
               + 'tropd1 , '
               + 'travd2 , '
               + 'tropd2 , '
               + 'trsffd , '
               + 'trsffk , '
               + 'trsdfd , '
               + 'trsdfk , '
               + 'trsdtd , '
               + 'trsdtk , '
               + 'trsvtd , '
               + 'trsvtk , '
               + 'trkdak , '
               + 'trkdff , '
               + 'trverv , '
               + 'trverb , '
               + 'trettv , '
               + 'trettb , '
               + 'trfrak , '
               + 'trfrav , '
               + 'trfrab , '
               + 'trmva  , '
               + 'trfa11 , '
               + 'trfa12 , '
               + 'trflP1 , '
               + 'trfa21 , '
               + 'trfa22 , '
               + 'trflp2 , '
               + 'trtsta , '
               + 'trstaf , '
               + 'trstae , '
               + 'trsta1 , '
               + 'trsta2 , '
               + 'trsta3 , '
               + 'trsta4 , '
               + 'trkm   , '
               + 'he01   , '
               + 'hestd  , '
               + 'hxsndn , '
               + 'hxpall , '
               + 'hxblgk , '
               + 'hxLkod , '
               + 'hxllst , '
               + 'hxedik , '
               + 'hxteri , '
               + 'hehakn , '
               + 'hehaan , '
               + 'helakn , '
               + 'helaan , '
               + 'helmla , '
               + 'hepoen , '
               + 'hestl1 , '
               + 'hestl2 , '
               + 'hestl3 , '
               + 'hestl4 , '
               + 'hestn1 , '
               + 'hestn2 , '
               + 'hestn3 , '
               + 'hestn4 , '
               + 'hestn5 , '
               + 'hestn6 , '
               + 'hestn7 , '
               + 'hestn8 , '
               + 'hestn9 , '
               + 'herfed , '
               + 'helib  , '
               + 'hefile , '
               + 'hembr  , '
               + 'hetype , '
               + 'helvl  , '
               + 'hesnn  , '
               + 'heunik , '
               + 'hereff';

       endsr;

       //*****************************************************************
       begsr     SqlWhere;
       //*****************************************************************
       // klargjør Where -  delen av Sql statement
       // .. sr AddAnd legger til and mellom hver (forran hver ny , men ikke første)

         // Opprinnelseskode MÅ være H / dette service-prog er KUN for transportmodul
         WhereC = 'HEUR = '+ cQuote + 'H' + cQuote;
         FirstW =   'N';   // flagg i senere AddAnd

         // avdeling
         if WBSAVD > 0;
           Exsr  AddAnd;
           WhereC =  %trim(WhereC)  +
                  ' HEAVD  = ' + %editc(WBSAVD:'3');
         endIf;

         // avdelingsGruppe
         if AvdGrpC <> *blanks;
           Exsr  AddAnd;
           WhereC =  %trim(WhereC)  +
                  ' HEAVD  In (' + %trim(AvdGrpC) + ')';
         endIf;

         // oppdragsnr
         if WBSOPD > 0;
           Exsr  AddAnd;
           WhereC =  %trim(WhereC)  +
                  ' HEOPD  = ' + %editc(WBSOPD:'3');
         endIf;

         // Turnummer
         if WSTURN > 0;
           Exsr  AddAnd;
           WhereC =  %trim(WhereC)  +
                  ' HEPRO = ' + %editc(WSTURN:'3');
         endIf;

         // Signatur   e
         If WSSG   <> *blanks;
           Exsr  AddAnd;
           Eval  WhereC =  %trim(WhereC)  +
           ' HESG = ' + cQuote + WSSG + cQuote;
         EndIf;

         // Oppdragstype
         If WSOT   <> *blanks;
           Exsr  AddAnd;
           Eval  WhereC =  %trim(WhereC)  +
           ' HEOT = ' + cQuote + WSOT + cQuote;
         EndIf;

         // Bookingtype -Prebook/Ordinær   HESTN7
         // kun de med P
         If WSPREBOOK   =  'P';
           Exsr  AddAnd;
           Eval  WhereC =  %trim(WhereC)  +
           ' HESTN7 = ' + cQuote + 'P' + cQuote;
         EndIf;
         // Kun de med blank (F=ferdfig booket / blank i prebookmerke)
         If WSPREBOOK   =  'F';
           Exsr  AddAnd;
           Eval  WhereC =  %trim(WhereC)  +
           ' HESTN7 = ' + cQuote + ' ' + cQuote;
         EndIf;

         // PO Senders ref (bør utvides til å teste HERFA OR HERFK )
         If WSRFA  <> *blanks;
           Exsr  AddAnd;
           Eval  WhereC =  %trim(WhereC)  +
           ' HERFA like ' + cQuote +'%'+ %trim(WSRFA) +'%'+ cQuote;
         EndIf;

         // Frasted (foreløpig test kun mot postnr-felt  / utvides til evt LK-Postnr )
         If WSSDF  <> *blanks;
           Exsr  AddAnd;
           Eval  WhereC =  %trim(WhereC)  +
           ' HESDF like ' + cQuote +'%'+ %trim(WSSDF) +'%'+ cQuote;
         EndIf;

         // TILsted (foreløpig test kun mot postnr-felt  / utvides til evt LK-Postnr )
         If WSSDT  <> *blanks;
           Exsr  AddAnd;
           Eval  WhereC =  %trim(WhereC)  +
           ' HESDT like ' + cQuote +'%'+ %trim(WSSDT) +'%'+ cQuote;
         EndIf;

         // Fra og med Oppddato
         If    WOPDTFN  > 0;
           Exsr  AddAnd;
           WhereC =  %trim(WhereC)  +
                  ' HEDTOP  >= ' + %editc(WOPDTFN:'3');
         EndIf;

         // til og med Oppddato
         If    WOPDTTN  > 0;
           Exsr  AddAnd;
           WhereC =  %trim(WhereC)  +
                  ' HEDTOP  <= ' + %editc(WOPDTTN:'3');
         EndIf;

         // Godsnr - wildcard på slutten
         If WSGN   <> *blanks;
           Exsr  AddAnd;
           Eval  WhereC =  %trim(WhereC)  +
           ' HEGN like ' + cQuote + %trim(WSGN) +'%'+ cQuote;
         EndIf;

         // Transportør via  kunde-nummer
         if WSTRAN > 0;
           Exsr  AddAnd;
           WhereC =  %trim(WhereC)  +
                  ' HEKNT = ' + %editc(WSTRAN:'3');
         endIf;

         // Oppdgiver via kunde-nummer
         if WSOPDGIN > 0;
           Exsr  AddAnd;
           WhereC =  %trim(WhereC)  +
                  ' TRKNFA = ' + %editc(WSOPDGIN:'3');
         endIf;

         // Avsender via kunde-nummer
         if WSAVSN > 0;
           Exsr  AddAnd;
           WhereC =  %trim(WhereC)  +
                  ' HEKNS  = ' + %editc(WSAVSN:'3');
         endIf;

         // Mottaker via kunde-nummer
         if WSMOTN > 0;
           Exsr  AddAnd;
           WhereC =  %trim(WhereC)  +
                  ' HEKNK  = ' + %editc(WSMOTN:'3');
         endIf;

         // Oppdragsgiver  navn - wildcard foran / bak
         // MED TIDEN bytte ut med DB-felt HENAO som er klargjort, men ennå "lånes" Agents navn
         If WSOPDGI <> *blanks;
           Exsr  AddAnd;
           Eval  WhereC =  %trim(WhereC)  +
           ' Upper(HENAA) like ' + cQuote +'%'+ %trim(WSOPDGI) +'%'+ cQuote;
         EndIf;

         // Avsender navn - wildcard foran / bak
         If WSAVS  <> *blanks;
           Exsr  AddAnd;
           Eval  WhereC =  %trim(WhereC)  +
           ' Upper(HENAS) like ' + cQuote +'%'+ %trim(WSAVS) +'%'+ cQuote;
         EndIf;

         // Mottakers navn - wildcard foran / bak
         If WSMOT  <> *blanks;
           Exsr  AddAnd;
           Eval  WhereC =  %trim(WhereC)  +
           ' Upper(HENAK) like ' + cQuote +'%'+ %trim(WSMOT) +'%'+ cQuote;
         EndIf;

         // den endelige where-strengen
         if WhereC <> *blanks;
           eval      WhereC =  ' Where ' + %trim(WhereC);
         endif;



       endsr;

       //*****************************************************************
       begsr     SqlOrder;
       //*****************************************************************
       // klargjør Order by - delen av Sql statement
       // PR NÅ styres sorteringe uansett av klientside/tablesort ...
       // På serverside er det KUN av betydnming når en skal ha XX ferskeste/siste på gitt avdeling
       // Har her også koblet en limit på den for å unngå å få de 500 siste (unødig tungt)
       // Dette er default søkevei når en går INN førts hgang på Historsik-taben
         select;
         when WBSAVD > 0
           and WOPDTFN = 0
           and WOPDTTN = 0;
           OrderC = 'Order by HEOPD desc';
           LimitC = 'Limit 200';
         other;
           OrderC = 'Order by HEDTOP asc';
         endsl;
       endsr;

       //*****************************************************************
       begsr     DsToFileVar;
       //*****************************************************************
       // Flytte far DS/array til vilvariable
       // Dette gjør de enhetlig (dersom en henter opåp liste via DISP og så chainer headf)
                  heur   = HeadfDs(x).heur  ;
                  heavd  = HeadfDs(x).heavd ;
                  heopd  = HeadfDs(x).heopd ;
                  hesg   = HeadfDs(x).hesg  ;
                  hedtop = HeadfDs(x).hedtop;
                  hedtr  = HeadfDs(x).hedtr ;
                  hesdff = HeadfDs(x).hesdff;
                  hesdf  = HeadfDs(x).hesdf ;
                  hesdt  = HeadfDs(x).hesdt ;
                  hesdvt = HeadfDs(x).hesdvt;
                  hegn   = HeadfDs(x).hegn  ;
                  hegnn  = HeadfDs(x).hegnn ;
                  hepro  = HeadfDs(x).hepro ;
                  heplan = HeadfDs(x).heplan;
                  trrund = HeadfDs(x).trrund;
                  hepos1 = HeadfDs(x).hepos1;
                  hepos2 = HeadfDs(x).hepos2;
                  trknfa = HeadfDs(x).trknfa;
                  henao  = HeadfDs(x).henao ;
                  hekna  = HeadfDs(x).hekna ;
                  henaa  = HeadfDs(x).henaa ;
                  herfa  = HeadfDs(x).herfa ;
                  hesaml = HeadfDs(x).hesaml;
                  hehawb = HeadfDs(x).hehawb;
                  hesdla = HeadfDs(x).hesdla;
                  hesdl  = HeadfDs(x).hesdl ;
                  hevalt = HeadfDs(x).hevalt;
                  hevalp = HeadfDs(x).hevalp;
                  heknt  = HeadfDs(x).heknt ;
                  helka  = HeadfDs(x).helka ;
                  hekns  = HeadfDs(x).hekns ;
                  henas  = HeadfDs(x).henas ;
                  heads1 = HeadfDs(x).heads1;
                  heads2 = HeadfDs(x).heads2;
                  hepns  = HeadfDs(x).hepns ;
                  heads3 = HeadfDs(x).heads3;
                  helks  = HeadfDs(x).helks ;
                  heknh  = HeadfDs(x).heknh ;
                  henah  = HeadfDs(x).henah ;
                  headh1 = HeadfDs(x).headh1;
                  headh2 = HeadfDs(x).headh2;
                  hepnh  = HeadfDs(x).hepnh ;
                  headh3 = HeadfDs(x).headh3;
                  helkh  = HeadfDs(x).helkh ;
                  hehbre = HeadfDs(x).hehbre;
                  hehlen = HeadfDs(x).hehlen;
                  hehblk = HeadfDs(x).hehblk;
                  hekdfs = HeadfDs(x).hekdfs;
                  hevals = HeadfDs(x).hevals;
                  heknsf = HeadfDs(x).heknsf;
                  heans  = HeadfDs(x).heans ;
                  henasf = HeadfDs(x).henasf;
                  heknk  = HeadfDs(x).heknk ;
                  henak  = HeadfDs(x).henak ;
                  headk1 = HeadfDs(x).headk1;
                  headk2 = HeadfDs(x).headk2;
                  hepnk  = HeadfDs(x).hepnk ;
                  headk3 = HeadfDs(x).headk3;
                  helkk  = HeadfDs(x).helkk ;
                  heknl  = HeadfDs(x).heknl ;
                  henal  = HeadfDs(x).henal ;
                  headl1 = HeadfDs(x).headl1;
                  headl2 = HeadfDs(x).headl2;
                  hepnl  = HeadfDs(x).hepnl ;
                  headl3 = HeadfDs(x).headl3;
                  helkl  = HeadfDs(x).helkl ;
                  helbre = HeadfDs(x).helbre;
                  hellen = HeadfDs(x).hellen;
                  helblk = HeadfDs(x).helblk;
                  hekdfk = HeadfDs(x).hekdfk;
                  hevalk = HeadfDs(x).hevalk;
                  heknkf = HeadfDs(x).heknkf;
                  heank  = HeadfDs(x).heank ;
                  henakf = HeadfDs(x).henakf;
                  heot   = HeadfDs(x).heot  ;
                  hekdpl = HeadfDs(x).hekdpl;
                  hefr   = HeadfDs(x).hefr  ;
                  hent   = HeadfDs(x).hent  ;
                  hevs1  = HeadfDs(x).hevs1 ;
                  hevs2  = HeadfDs(x).hevs2 ;
                  hegm1  = HeadfDs(x).hegm1 ;
                  hegm2  = HeadfDs(x).hegm2 ;
                  hevkt  = HeadfDs(x).hevkt ;
                  helm   = HeadfDs(x).helm  ;
                  hem3   = HeadfDs(x).hem3  ;
                  hefbv  = HeadfDs(x).hefbv ;
                  hekf   = HeadfDs(x).hekf  ;
                  hekft1 = HeadfDs(x).hekft1;
                  heft1  = HeadfDs(x).heft1 ;
                  hedtcp = HeadfDs(x).hedtcp;
                  hedtÅp = HeadfDs(x).hedtÅp;
                  hedtmp = HeadfDs(x).hedtmp;
                  hekdkk = HeadfDs(x).hekdkk;
                  hefngk = HeadfDs(x).hefngk;
                  hefngs = HeadfDs(x).hefngs;
                  hekdtm = HeadfDs(x).hekdtm;
                  hetrm  = HeadfDs(x).hetrm ;
                  hetri  = HeadfDs(x).hetri ;
                  hetrc  = HeadfDs(x).hetrc ;
                  hetrcn = HeadfDs(x).hetrcn;
                  hefbk  = HeadfDs(x).hefbk ;
                  hetle  = HeadfDs(x).hetle ;
                  hetll  = HeadfDs(x).hetll ;
                  hetlku = HeadfDs(x).hetlku;
                  hentvs = HeadfDs(x).hentvs;
                  hevn   = HeadfDs(x).hevn  ;
                  hentf  = HeadfDs(x).hentf ;
                  hebelt = HeadfDs(x).hebelt;
                  hebelm = HeadfDs(x).hebelm;
                  hesgm  = HeadfDs(x).hesgm ;
                  hedtmo = HeadfDs(x).hedtmo;
                  heklmo = HeadfDs(x).heklmo;
                  hepk1  = HeadfDs(x).hepk1 ;
                  hepk2  = HeadfDs(x).hepk2 ;
                  hepk3  = HeadfDs(x).hepk3 ;
                  hepk4  = HeadfDs(x).hepk4 ;
                  hepk5  = HeadfDs(x).hepk5 ;
                  hepk6  = HeadfDs(x).hepk6 ;
                  hepk7  = HeadfDs(x).hepk7 ;
                  hepk8  = HeadfDs(x).hepk8 ;
                  hepk9  = HeadfDs(x).hepk9 ;
                  hekdl  = HeadfDs(x).hekdl ;
                  helb   = HeadfDs(x).helb  ;
                  helkfr = HeadfDs(x).helkfr;
                  hesdfr = HeadfDs(x).hesdfr;
                  hestfr = HeadfDs(x).hestfr;
                  herfk  = HeadfDs(x).herfk ;
                  trslag = HeadfDs(x).trslag;
                  travd0 = HeadfDs(x).travd0;
                  tropd0 = HeadfDs(x).tropd0;
                  travd1 = HeadfDs(x).travd1;
                  tropd1 = HeadfDs(x).tropd1;
                  travd2 = HeadfDs(x).travd2;
                  tropd2 = HeadfDs(x).tropd2;
                  trsffd = HeadfDs(x).trsffd;
                  trsffk = HeadfDs(x).trsffk;
                  trsdfd = HeadfDs(x).trsdfd;
                  trsdfk = HeadfDs(x).trsdfk;
                  trsdtd = HeadfDs(x).trsdtd;
                  trsdtk = HeadfDs(x).trsdtk;
                  trsvtd = HeadfDs(x).trsvtd;
                  trsvtk = HeadfDs(x).trsvtk;
                  trkdak = HeadfDs(x).trkdak;
                  trkdff = HeadfDs(x).trkdff;
                  trverv = HeadfDs(x).trverv;
                  trverb = HeadfDs(x).trverb;
                  trettv = HeadfDs(x).trettv;
                  trettb = HeadfDs(x).trettb;
                  trfrak = HeadfDs(x).trfrak;
                  trfrav = HeadfDs(x).trfrav;
                  trfrab = HeadfDs(x).trfrab;
                  trmva  = HeadfDs(x).trmva ;
                  trfa11 = HeadfDs(x).trfa11;
                  trfa12 = HeadfDs(x).trfa12;
                  trflP1 = HeadfDs(x).trflP1;
                  trfa21 = HeadfDs(x).trfa21;
                  trfa22 = HeadfDs(x).trfa22;
                  trflp2 = HeadfDs(x).trflp2;
                  trtsta = HeadfDs(x).trtsta;
                  trstaf = HeadfDs(x).trstaf;
                  trstae = HeadfDs(x).trstae;
                  trsta1 = HeadfDs(x).trsta1;
                  trsta2 = HeadfDs(x).trsta2;
                  trsta3 = HeadfDs(x).trsta3;
                  trsta4 = HeadfDs(x).trsta4;
                  trkm   = HeadfDs(x).trkm  ;
                  he01   = HeadfDs(x).he01  ;
                  hestd  = HeadfDs(x).hestd ;
                  hxsndn = HeadfDs(x).hxsndn;
                  hxpall = HeadfDs(x).hxpall;
                  hxblgk = HeadfDs(x).hxblgk;
                  hxLkod = HeadfDs(x).hxLkod;
                  hxllst = HeadfDs(x).hxllst;
                  hxedik = HeadfDs(x).hxedik;
                  hxteri = HeadfDs(x).hxteri;
                  hehakn = HeadfDs(x).hehakn;
                  hehaan = HeadfDs(x).hehaan;
                  helakn = HeadfDs(x).helakn;
                  helaan = HeadfDs(x).helaan;
                  helmla = HeadfDs(x).helmla;
                  hepoen = HeadfDs(x).hepoen;
                  hestl1 = HeadfDs(x).hestl1;
                  hestl2 = HeadfDs(x).hestl2;
                  hestl3 = HeadfDs(x).hestl3;
                  hestl4 = HeadfDs(x).hestl4;
                  hestn1 = HeadfDs(x).hestn1;
                  hestn2 = HeadfDs(x).hestn2;
                  hestn3 = HeadfDs(x).hestn3;
                  hestn4 = HeadfDs(x).hestn4;
                  hestn5 = HeadfDs(x).hestn5;
                  hestn6 = HeadfDs(x).hestn6;
                  hestn7 = HeadfDs(x).hestn7;
                  hestn8 = HeadfDs(x).hestn8;
                  hestn9 = HeadfDs(x).hestn9;
                  herfed = HeadfDs(x).herfed;
                  helib  = HeadfDs(x).helib ;
                  hefile = HeadfDs(x).hefile;
                  hembr  = HeadfDs(x).hembr ;
                  hetype = HeadfDs(x).hetype;
                  helvl  = HeadfDs(x).helvl ;
                  hesnn  = HeadfDs(x).hesnn ;
                  heunik = HeadfDs(x).heunik;
                  hereff = HeadfDs(x).hereff;

       endsr;
        // **************************************************
       begsr LesSr;
        // **************************************************
        // Læs array
       for x = 1 to DsHeadfSize;

         if HeadfDs(x).HEAVD = *zeros;
           leave;
         endif;
        // ekstra filter som ikke er fanget i SQL ...
         exsr OpdFilter;
         if PostOK= 'J';
           // Flytt array-felt til filvariable
           // Dette gjør de enhetlig (hente også liste via DISP og så chainer headf?)
           exsr DsToFileVar;
           //
           // Fix div felt
           chain (HEAVD: HEOPD) DISP;
           chain ( 'F':HEAVD: HEOPD:001 ) DOKUF;
           if DFTOLL=*zeros;
             WSTOLL = *blanks;
           else;
             WSTOLL = %editc(DFTOLL:'X');
           endif;
           exsr FixIntern;
           // Hvis avd/mottaker oppgitt (kundenr) og avvikfra hente/levadr- vis i HENAS/HENAK
           exsr FixNavn;
            // Skriv en JSON-Array-linje pr menypunkt - komma før hvert nytt element
           // hent T&YT-status
           exsr TTstatus;

           // Lægg ut Json stræng
           AntLest = AntLest + 1;
           exsr SkrivOppdrag;

         endif;

        endfor;

       endsr;
        // **************************************************
       begsr LesSrFS;
        // **************************************************
        // Læs array
       eval MaxFsSok = %trim(WSFSSOK)+'99999999999999999999';
       setll ( WSFSKOD : WSFSSOK ) frisol01;
       reade ( WSFSKOD ) frisol01;
       dow not %eof;

         if FSSOK > MaxFsSok;
           leave;
         endif;
        //div vilkår for å skrive posten (driter i avd-gruppe mm inntil SQL..)
         eval Postok='J';
         // sjekk avd mm kun når kort input
         //  dvs - hvis 17 lang er det fult sendingsnr slå oppp uavh. av avd mm
         if %subst(WSFSSOK:17:1)=' ';
S01      //if WBSAVD<>*zeros and  WBSAVD<>FSAVD;
S01      //  eval Postok='N';
S01      //endif;
           if WOPDTFN<>*zeros and  FSDTOP < WOPDTFN;
             eval Postok='N';
           endif;
           if WOPDTTN<>*zeros and  FSDTOP > WOPDTTN;
             eval Postok='N';
           endif;
         endif;
         if Postok='J';
           chain (FSAVD: FSOPD) HEADF;
           if not %found or HEST ='S';
             eval Postok='N';
           endif;
         endif;

         if Postok='J';
           // Fix div felt
           chain (HEAVD: HEOPD) DISP;
           chain ( 'F':HEAVD: HEOPD:001 ) DOKUF;
           if DFTOLL=*zeros;
             WSTOLL = *blanks;
           else;
             WSTOLL = %editc(DFTOLL:'X');
           endif;
           exsr FixIntern;
           // Hvis avd/mottaker oppgitt (kundenr) og avvikfra hente/levadr- vis i HENAS/HENAK
           exsr FixNavn;
            // Skriv en JSON-Array-linje pr menypunkt - komma før hvert nytt element

           // Lægg ut Json stræng
           AntLest = AntLest + 1;
           exsr SkrivOppdrag;

         endif;

       reade ( WSFSKOD ) frisol01;
       enddo;

       endsr;
        // **************************************************
       begsr LesSrCL;
        // **************************************************
        // Læs array
       eval MaxClId = %trim(WSCLID)+'99999999999999999999';
       setll WSCLID dokufm1;
       read  dokufm1;
       dow not %eof;

         if FMMRK1 > MaxClId;
           leave;
         endif;
        //div vilkår for å skrive posten (driter i avd-gruppe mm inntil SQL..)
         eval Postok='J';
         chain (FMAVD: FMOPD) HEADF;
         if not %found or HEST ='S';
           eval Postok='N';
         endif;
         // sjekk avd mm kun når kort input -
         //  dvs - hvis 18 lag er det full kolliID = slå oppp uavh. av avd mm
         if %subst(WSCLID:18:1)=' ';
S01      //if WBSAVD<>*zeros and  WBSAVD<>FMAVD;
S01      //  eval Postok='N';
S01      //endif;
           if WOPDTFN<>*zeros and  HEDTOP < WOPDTFN;
             eval Postok='N';
           endif;
           if WOPDTTN<>*zeros and  HEDTOP > WOPDTTN;
             eval Postok='N';
           endif;
         endif;

         if Postok='J';
           // Fix div felt
           chain (HEAVD: HEOPD) DISP;
           chain ( 'F':HEAVD: HEOPD:001 ) DOKUF;
           if DFTOLL=*zeros;
             WSTOLL = *blanks;
           else;
             WSTOLL = %editc(DFTOLL:'X');
           endif;
           exsr FixIntern;
           // Hvis avd/mottaker oppgitt (kundenr) og avvikfra hente/levadr- vis i HENAS/HENAK
           exsr FixNavn;
            // Skriv en JSON-Array-linje pr menypunkt - komma før hvert nytt element

           // Lægg ut Json stræng
           AntLest = AntLest + 1;
           exsr SkrivOppdrag;

         endif;

       read dokufm1;
       enddo;

       endsr;
       //********************************************************
       begsr OpdFilter;
       //********************************************************
       PostOK = 'J';
       //Test 1
       //if xx = yy;
       //PostOK = 'N';
       //LeaveSr;
       //endif;
       //
       //Test 2
       //..
       //
       endsr;

       //********************************************************
       begsr SkrivOppdrag;
       //********************************************************

       if AntLest=1;
          JSONstring=*blanks;
       else;
          JSONstring=', ';
       endif;
       JSONstring=%trim(JSONstring)+'{'
        +'¬dista1¬ : ¬'+%trim(DISTA1)+'¬, '
        +'¬heur¬ : ¬'+%trim(HEUR)+'¬, '
        +'¬heavd¬ : ¬'+%trim(%editc(HEAVD:'Z'))+'¬, '
        +'¬heopd¬ : ¬'+%trim(%editc(HEOPD:'Z'))+'¬, '
        +'¬hesg¬ : ¬'+%trim(HESG)+'¬, '
        +'¬hedtop¬ : ¬'+%trim(%editc(HEDTOP:'Z'))+'¬, '
        +'¬hedtr¬ : ¬'+%trim(%editc(HEDTR:'Z'))+'¬, '
        +'¬hesdff¬ : ¬'+%trim(HESDFF)+'¬, '
        +'¬hesdf¬ : ¬'+%trim(HESDF)+'¬, '
        +'¬hesdt¬ : ¬'+%trim(HESDT)+'¬, '
        +'¬hesdvt¬ : ¬'+%trim(HESDVT)+'¬, '
        +'¬hegn¬ : ¬'+%trim(HEGN)+'¬, '
        +'¬hegnn¬ : ¬'+%trim(HEGNN)+'¬, '
        +'¬hepro¬ : ¬'+%trim(%editc(HEPRO:'Z'))+'¬, '
        +'¬heplan¬ : ¬'+%trim(HEPLAN)+'¬, '
        +'¬trrund¬ : ¬'+%trim(%editc(TRRUND:'Z'))+'¬, '
        +'¬hepos1¬ : ¬'+%trim(HEPOS1)+'¬, '
        +'¬hepos2¬ : ¬'+%trim(%editc(HEPOS2:'Z'))+'¬, '
        +'¬trknfa¬ : ¬'+%trim(%editc(TRKNFA:'Z'))+'¬, '
        +'¬henao¬ : ¬'+%trim(HENAO)+'¬, '
        +'¬hekna¬ : ¬'+%trim(%editc(HEKNA:'Z'))+'¬, '
        +'¬henaa¬ : ¬'+%trim(HENAA)+'¬, '
        +'¬herfa¬ : ¬'+%trim(HERFA)+'¬, '
        +'¬hesaml¬ : ¬'+%trim(HESAML)+'¬, '
        +'¬hehawb¬ : ¬'+%trim(HEHAWB)+'¬, '
        +'¬hesdla¬ : ¬'+%trim(HESDLA)+'¬, '
        +'¬hesdl¬ : ¬'+%trim(HESDL)+'¬, '
        +'¬hevalt¬ : ¬'+%trim(HEVALT)+'¬, '
        +'¬hevalp¬ : ¬'+%trim(%editc(HEVALP:'4'))+'¬, '
        +'¬heknt¬ : ¬'+%trim(%editc(HEKNT:'Z'))+'¬, '
        +'¬helka¬ : ¬'+%trim(HELKA)+'¬, '
        +'¬hekns¬ : ¬'+%trim(%editc(HEKNS:'Z'))+'¬, '
        +'¬henas¬ : ¬'+%trim(HENASutv)+'¬, '
        +'¬heads1¬ : ¬'+%trim(HEADS1)+'¬, '
        +'¬heads2¬ : ¬'+%trim(HEADS2)+'¬, '
        +'¬hepns¬ : ¬'+%trim(HEPNS)+'¬, '
        +'¬heads3¬ : ¬'+%trim(HEADS3)+'¬, '
        +'¬helks¬ : ¬'+%trim(HELKS)+'¬, '
        +'¬heknh¬ : ¬'+%trim(%editc(HEKNH:'Z'))+'¬, '
        +'¬henah¬ : ¬'+%trim(HENAH)+'¬, '
        +'¬headh1¬ : ¬'+%trim(HEADH1)+'¬, '
        +'¬headh2¬ : ¬'+%trim(HEADH2)+'¬, '
        +'¬hepnh¬ : ¬'+%trim(HEPNH)+'¬, '
        +'¬headh3¬ : ¬'+%trim(HEADH3)+'¬, '
        +'¬helkh¬ : ¬'+%trim(HELKH)+'¬, '
        +'¬hehbre¬ : ¬'+%trim(%editc(HEHBRE:'4'))+'¬, '
        +'¬hehlen¬ : ¬'+%trim(%editc(HEHLEN:'4'))+'¬, '
        +'¬hehblk¬ : ¬'+%trim(HEHBLK)+'¬, '
        +'¬hekdfs¬ : ¬'+%trim(HEKDFS)+'¬, '
        +'¬hevals¬ : ¬'+%trim(HEVALS)+'¬, '
        +'¬heknsf¬ : ¬'+%trim(%editc(HEKNSF:'Z'))+'¬, '
        +'¬heans¬ : ¬'+%trim(%editc(HEANS:'Z'))+'¬, '
        +'¬henasf¬ : ¬'+%trim(HENASF)+'¬, '
        +'¬heknk¬ : ¬'+%trim(%editc(HEKNK:'Z'))+'¬, '
        +'¬henak¬ : ¬'+%trim(HENAKutv)+'¬, '
        +'¬headk1¬ : ¬'+%trim(HEADK1)+'¬, '
        +'¬headk2¬ : ¬'+%trim(HEADK2)+'¬, '
        +'¬hepnk¬ : ¬'+%trim(HEPNK)+'¬, '
        +'¬headk3¬ : ¬'+%trim(HEADK3)+'¬, '
        +'¬helkk¬ : ¬'+%trim(HELKK)+'¬, '
        +'¬heknl¬ : ¬'+%trim(%editc(HEKNL:'Z'))+'¬, '
        +'¬henal¬ : ¬'+%trim(HENAL)+'¬, '
        +'¬headl1¬ : ¬'+%trim(HEADL1)+'¬, '
        +'¬headl2¬ : ¬'+%trim(HEADL2)+'¬, '
        +'¬hepnl¬ : ¬'+%trim(HEPNL)+'¬, '
        +'¬headl3¬ : ¬'+%trim(HEADL3)+'¬, '
        +'¬helkl¬ : ¬'+%trim(HELKL)+'¬, '
        +'¬helbre¬ : ¬'+%trim(%editc(HELBRE:'4'))+'¬, '
        +'¬hellen¬ : ¬'+%trim(%editc(HELLEN:'4'))+'¬, '
        +'¬helblk¬ : ¬'+%trim(HELBLK)+'¬, '
        +'¬hekdfk¬ : ¬'+%trim(HEKDFK)+'¬, '
        +'¬hevalk¬ : ¬'+%trim(HEVALK)+'¬, '
        +'¬heknkf¬ : ¬'+%trim(%editc(HEKNKF:'Z'))+'¬, '
        +'¬heank¬ : ¬'+%trim(%editc(HEANK:'Z'))+'¬, '
        +'¬henakf¬ : ¬'+%trim(HENAKF)+'¬, '
        +'¬heot¬ : ¬'+%trim(HEOT)+'¬, '
        +'¬hekdpl¬ : ¬'+%trim(HEKDPL)+'¬, '
        +'¬hefr¬ : ¬'+%trim(HEFR)+'¬, '
        +'¬hent¬ : ¬'+%trim(%editc(HENT:'Z'))+'¬, '
        +'¬hevs1¬ : ¬'+%trim(HEVS1)+'¬, '
        +'¬hevs2¬ : ¬'+%trim(HEVS2)+'¬, '
        +'¬hegm1¬ : ¬'+%trim(HEGM1)+'¬, '
        +'¬hegm2¬ : ¬'+%trim(HEGM2)+'¬, '
        +'¬hevkt¬ : ¬'+%trim(%editc(HEVKT:'4'))+'¬, '
        +'¬helm¬ : ¬'+%trim(%editc(HELM:'4'))+'¬, '
        +'¬hem3¬ : ¬'+%trim(%editc(HEM3:'4'))+'¬, '
        +'¬hefbv¬ : ¬'+%trim(%editc(HEFBV:'4'))+'¬, '
        +'¬hekf¬ : ¬'+%trim(HEKF)+'¬, '
        +'¬hekft1¬ : ¬'+%trim(HEKFT1)+'¬, '
        +'¬heft1¬ : ¬'+%trim(HEFT1)+'¬, '
        +'¬hedtcp¬ : ¬'+%trim(%editc(HEDTCP:'Z'))+'¬, '
        +'¬hedtap¬ : ¬'+%trim(%editc(HEDTÅP:'Z'))+'¬, '
        +'¬hedtmp¬ : ¬'+%trim(%editc(HEDTMP:'Z'))+'¬, '
        +'¬hekdkk¬ : ¬'+%trim(HEKDKK)+'¬, '
        +'¬hefngk¬ : ¬'+%trim(%editc(HEFNGK:'Z'))+'¬, '
        +'¬hefngs¬ : ¬'+%trim(%editc(HEFNGS:'Z'))+'¬, '
        +'¬hekdtm¬ : ¬'+%trim(HEKDTM)+'¬, '
        +'¬hetrm¬ : ¬'+%trim(%editc(HETRM:'Z'))+'¬, '
        +'¬hetri¬ : ¬'+%trim(HETRI)+'¬, '
        +'¬hetrc¬ : ¬'+%trim(%editc(HETRC:'Z'))+'¬, '
        +'¬hetrcn¬ : ¬'+%trim(HETRCN)+'¬, '
        +'¬hefbk¬ : ¬'+%trim(%editc(HEFBK:'4'))+'¬, '
        +'¬hetle¬ : ¬'+%trim(HETLE)+'¬, '
        +'¬hetll¬ : ¬'+%trim(HETLL)+'¬, '
        +'¬hetlku¬ : ¬'+%trim(HETLKU)+'¬, '
        +'¬hentvs¬ : ¬'+%trim(%editc(HENTVS:'Z'))+'¬, '
        +'¬hevn¬ : ¬'+%trim(%editc(HEVN:'Z'))+'¬, '
        +'¬hentf¬ : ¬'+%trim(%editc(HENTF:'Z'))+'¬, '
        +'¬hebelt¬ : ¬'+%trim(%editc(HEBELT:'4'))+'¬, '
        +'¬hebelm¬ : ¬'+%trim(%editc(HEBELM:'4'))+'¬, '
        +'¬hesgm¬ : ¬'+%trim(HESGM)+'¬, '
        +'¬hedtmo¬ : ¬'+%trim(HEDTMO)+'¬, '
        +'¬heklmo¬ : ¬'+%trim(%editc(HEKLMO:'Z'))+'¬, '
        +'¬ttstat¬ : ¬'+%trim(HenLev)+'¬, '
        +'¬hepk1¬ : ¬'+%trim(HEPK1)+'¬, '
        +'¬dftoll¬ : ¬'+%trim(WSTOLL)+'¬, '     //tollsted
        +'¬hepk2¬ : ¬'+%trim(HEPK2)+'¬, '
        +'¬hepk3¬ : ¬'+%trim(HEPK3)+'¬, '
        +'¬hepk4¬ : ¬'+%trim(HEPK4)+'¬, '
        +'¬hepk5¬ : ¬'+%trim(HEPK5)+'¬, '
        +'¬hepk6¬ : ¬'+%trim(HEPK6)+'¬, '
        +'¬hepk7¬ : ¬'+%trim(HEPK7)+'¬, '
        +'¬hepk8¬ : ¬'+%trim(HEPK8)+'¬, '
        +'¬hepk9¬ : ¬'+%trim(HEPK9)+'¬, '
        +'¬hekdl¬ : ¬'+%trim(HEKDL)+'¬, '
        +'¬helb¬ : ¬'+%trim(HELB)+'¬, '
        +'¬helkfr¬ : ¬'+%trim(HELKFR)+'¬, '
        +'¬hesdfr¬ : ¬'+%trim(HESDFR)+'¬, '
        +'¬hestfr¬ : ¬'+%trim(HESTFR)+'¬, '
        +'¬herfk¬ : ¬'+%trim(HERFK)+'¬, '
        +'¬trslag¬ : ¬'+%trim(TRSLAG)+'¬, '
        +'¬travd0¬ : ¬'+%trim(%editc(TRAVD0:'Z'))+'¬, '
        +'¬tropd0¬ : ¬'+%trim(%editc(TROPD0:'Z'))+'¬, '
        +'¬travd1¬ : ¬'+%trim(%editc(TRAVD1:'Z'))+'¬, '
        +'¬tropd1¬ : ¬'+%trim(%editc(TROPD1:'Z'))+'¬, '
        +'¬travd2¬ : ¬'+%trim(%editc(TRAVD2:'Z'))+'¬, '
        +'¬tropd2¬ : ¬'+%trim(%editc(TROPD2:'Z'))+'¬, '
        +'¬trsffd¬ : ¬'+%trim(%editc(TRSFFD:'Z'))+'¬, '
        +'¬trsffk¬ : ¬'+%trim(%editc(TRSFFK:'Z'))+'¬, '
        +'¬trsdfd¬ : ¬'+%trim(%editc(TRSDFD:'Z'))+'¬, '
        +'¬trsdfk¬ : ¬'+%trim(%editc(TRSDFK:'Z'))+'¬, '
        +'¬trsdtd¬ : ¬'+%trim(%editc(TRSDTD:'Z'))+'¬, '
        +'¬trsdtk¬ : ¬'+%trim(%editc(TRSDTK:'Z'))+'¬, '
        +'¬trsvtd¬ : ¬'+%trim(%editc(TRSVTD:'Z'))+'¬, '
        +'¬trsvtk¬ : ¬'+%trim(%editc(TRSVTK:'Z'))+'¬, '
        +'¬trkdak¬ : ¬'+%trim(TRKDAK)+'¬, '
        +'¬trkdff¬ : ¬'+%trim(TRKDFF)+'¬, '
        +'¬trverv¬ : ¬'+%trim(TRVERV)+'¬, '
        +'¬trverb¬ : ¬'+%trim(%editc(TRVERB:'Z'))+'¬, '
        +'¬trettv¬ : ¬'+%trim(TRETTV)+'¬, '
        +'¬trettb¬ : ¬'+%trim(%editc(TRETTB:'Z'))+'¬, '
        +'¬trfrak¬ : ¬'+%trim(TRFRAK)+'¬, '
        +'¬trfrav¬ : ¬'+%trim(TRFRAV)+'¬, '
        +'¬trfrab¬ : ¬'+%trim(%editc(TRFRAB:'4'))+'¬, '
        +'¬trmva¬ : ¬'+%trim(TRMVA)+'¬, '
        +'¬trfa11¬ : ¬'+%trim(TRFA11)+'¬, '
        +'¬trfa12¬ : ¬'+%trim(TRFA12)+'¬, '
        +'¬trflP1¬ : ¬'+%trim(%editc(TRFLP1:'Z'))+'¬, '
        +'¬trfa21¬ : ¬'+%trim(TRFA21)+'¬, '
        +'¬trfa22¬ : ¬'+%trim(TRFA22)+'¬, '
        +'¬trflp2¬ : ¬'+%trim(%editc(TRFLP2:'Z'))+'¬, '
        +'¬trtsta¬ : ¬'+%trim(TRTSTA)+'¬, '
        +'¬trstaf¬ : ¬'+%trim(TRSTAF)+'¬, '
        +'¬trstae¬ : ¬'+%trim(TRSTAE)+'¬, '
        +'¬trsta1¬ : ¬'+%trim(TRSTA1)+'¬, '
        +'¬trsta2¬ : ¬'+%trim(TRSTA2)+'¬, '
        +'¬trsta3¬ : ¬'+%trim(TRSTA3)+'¬, '
        +'¬trsta4¬ : ¬'+%trim(TRSTA4)+'¬, '
        +'¬trkm¬ : ¬'+%trim(%editc(TRKM:'Z'))+'¬, '
        +'¬he01¬ : ¬'+%trim(HE01)+'¬, '
        +'¬hestd¬ : ¬'+%trim(%editc(HESTD:'Z'))+'¬, '
        +'¬hxsndn¬ : ¬'+%trim(HXSNDN)+'¬, '
        +'¬hxpall¬ : ¬'+%trim(%editc(HXPALL:'Z'))+'¬, '
        +'¬hxblgk¬ : ¬'+%trim(HXBLGK)+'¬, '
        +'¬hxLkod¬ : ¬'+%trim(HXLKOD)+'¬, '
        +'¬hxllst¬ : ¬'+%trim(HXLLST)+'¬, '
        +'¬hxedik¬ : ¬'+%trim(HXEDIK)+'¬, '
        +'¬hxteri¬ : ¬'+%trim(HXTERI)+'¬, '
S01     +'¬hehakn¬ : ¬'+%trim(%editc(HEHAKN:'Z'))+'¬, '
S01     +'¬hehaan¬ : ¬'+%trim(%editc(HEHAAN:'Z'))+'¬, '
S01     +'¬helakn¬ : ¬'+%trim(%editc(HELAKN:'Z'))+'¬, '
S01     +'¬helaan¬ : ¬'+%trim(%editc(HELAAN:'Z'))+'¬, '
TMS     +'¬helmla¬ : ¬'+%trim(%editc(HELMLA:'Z'))+'¬, '
TMS     +'¬hepoen¬ : ¬'+%trim(%editc(HEPOEN:'Z'))+'¬, '
TMS     +'¬hestl1¬ : ¬'+%trim(HESTL1)+'¬, '
TMS     +'¬hestl2¬ : ¬'+%trim(HESTL2)+'¬, '
TMS     +'¬hestl3¬ : ¬'+%trim(HESTL3)+'¬, '
TMS     +'¬hestl4¬ : ¬'+%trim(HESTL4)+'¬, '
TMS     +'¬hestn1¬ : ¬'+%trim(HESTN1)+'¬, '
TMS     +'¬hestn2¬ : ¬'+%trim(HESTN2)+'¬, '
TMS     +'¬hestn3¬ : ¬'+%trim(HESTN3)+'¬, '
TMS     +'¬hestn4¬ : ¬'+%trim(HESTN4)+'¬, '
TMS     +'¬hestn5¬ : ¬'+%trim(HESTN5)+'¬, '
TMS     +'¬hestn6¬ : ¬'+%trim(HESTN6)+'¬, '
TMS     +'¬hestn7¬ : ¬'+%trim(HESTN7)+'¬, '
TMS     +'¬hestn8¬ : ¬'+%trim(HESTN8)+'¬, '
TMS     +'¬hestn9¬ : ¬'+%trim(HESTN9)+'¬, '
TMS     +'¬herfed¬ : ¬'+%trim(HERFED)+'¬, '
        +'¬helib¬ : ¬'+%trim(HELIB)+'¬, '
        +'¬hefile¬ : ¬'+%trim(HEFILE)+'¬, '
        +'¬hembr¬ : ¬'+%trim(HEMBR)+'¬, '
        +'¬hetype¬ : ¬'+%trim(HETYPE)+'¬, '
        +'¬helvl¬ : ¬'+%trim(HELVL)+'¬, '
        +'¬hesnn¬ : ¬'+%trim(%editc(HESNN:'Z'))+'¬, '
        +'¬heunik¬ : ¬'+%trim(%editc(HEUNIK:'Z'))+'¬, '
        +'¬hereff¬ : ¬'+%trim(HEREFF)+'¬, '
        +'¬interninfo¬ : ¬'+%trim(InternInfo)+'¬}';
         jsonfix (JSONstring);
       updhtmlvar2('JSONstring'
                  :%addr(jsonstring)
                  :%len(jsonstring));
         wrtsection ('JSONlin');

       endsr;

       //*****************************************************************
       begsr     AddAnd;
       //*****************************************************************
       // Set inn "AND" mellom where settninger
       If        FirstW =   'N';
         Eval      WhereC =  %trim(WhereC) + ' and ';
       EndIf;
         Eval      FirstW =   'N';
       endsr;


       // **************************************************
       begsr exit;
       // **************************************************
       // Close output html and quit
         // Lukk fil
         close bridf;
         close headf;
         close disp;
         close brparf;
         close kodta;
         close dokuf;
         close freetxt2;
         close cundl01;
         close vadr;
         close frisol01;
         close dokufm1;
         close trackl02;

         wrtsection('*fini');
         *inlr = *on;
         return;
       endsr;
      /end-free
      **
      ** Inntil videre konverteres ikke en rekke SR hentet fra TJETUR05LL
      ** Med tiden slå sammen begge prog/alt i freeform
      ***************************************************************
     C     INIT          BEGSR
      ***************************************************************
     C                   OPEN      BRIDF
     C     WSUSER        CHAIN     BRIDF                              50
      * En "standardvariant" libl: CALL bound (INCGI=*MODULE) med parameter.
     C     BILIBL        IFEQ      *blanks
     C                   CALLB     'INCGI'
     C                   PARM                    BISTDL
     C                   ELSE
      * Helt egen bibl.liste satt på user - normal CALL (BILIBL er "*pgm")
     C                   CALL      BILIBL
     C                   ENDIF

      * hent Parametre som går igjen i mange prog:
      *      Odd/Even/Rowhead-farger,Logobilde,Språk,Intern/Ekstern bruker,  mm
     C                   CALL      'ESGETPAR'
     C                   PARM                    BIBRID
     C                   PARM                    BIFIRM
     C                   PARM                    BIKUNR
     C                   PARM                    BIKNG
     C                   PARM                    RowHead          10
     C                   PARM                    Odd              10
     C                   PARM                    Even             10
     C                   PARM                    LogoImg          50
     C                   PARM                    XSPRÅK            2
     C                   PARM                    XINTERN           1
     C                   PARM                    PARMDS1        1024
     C                   PARM                    PARMDS2        1024
     C                   PARM                    PARMDS3        1024
      * HENTER PARAMETER
     C                   CALL      'ESGETOS'
     C                   PARM                    BIBRID
     C                   PARM                    BIFIRM
     C                   PARM                    BIKUNR
     C                   PARM                    BIKNG
     C                   PARM                    PARMOS1        1024

     C   50              EVAL      Error = 'Invalid userID'
     c   50              goto      UtIni
      * Pr nå (2018.11.29) er det ikke behov for å åpne fila
      *    MEN om/når den utvides for Udisponerte = SQL mot DISP / Chain mot headf trengs det..
     C                   OPEN      HEADF
     C                   OPEN      BRPARF
     C                   OPEN      DISP
     C                   OPEN      KODTA
     C                   OPEN      DOKUF
     C                   OPEN      FREETXT2
     C                   OPEN      CUNDL01
     C                   OPEN      VADR
     C                   OPEN      FRISOL01
     C                   OPEN      DOKUFM1
     C                   OPEN      TRACKL02

     C     TT02KEY       KLIST
     C                   KFLD                    HEAVD
     C                   KFLD                    HEOPD
     C                   KFLD                    TTFBNR
     C                   KFLD                    TTACTI
      *
     C     BrParKey      KLIST
     C                   KFLD                    PABRID
     C                   KFLD                    PAKUNR
     C                   KFLD                    PAID
     C                   MOVE      BIBRID        PABRID
     C                   MOVE      *zeros        PAKUNR

      * Brukers standard avdeling  benyttes dersom blank i input
     c                   if        WBSAVD = *zeros
     C                   MOVE      'LTAVD'       PAID
     C     BrParKey      CHAIN     BRPARF                             33
     C                   if        %found
     c                   eval      WBSAVD = PAVRDN
     c                   endif
     c                   endif
      *
      * Alfa = avd-gruppe ??
     c                   eval      AvdGrpC = *blanks
     c                   if        WSSAVD <> *blanks and
     c                             WSSAVD <  '0000'                             mindre enn..=Alfa
     c                   exsr      AvdGruppe
     C                   endif
      *
      * Om avdgruppe er oppgitt - blank eksprlisit/std avd
     c                   if        AvdGrpC<>*blanks or
     c                             WSSAVD='ALL'
     c                   eval      WBSAVD = *zeros
     c                   endif
     c
      * initier array/numeriske felt
     c                   clear                   HeadfDs

     C     UtIni         ENDSR
      *
      ****************************************************************
     c     AvdGruppe     BEGSR
      ****************************************************************
     c                   move      *zeros        aNr               2 0
     c                   move      *zeros        TmpAvd1           4 0
     c
      * Gruppering basert på KODTA ...
     C                   IF        WSSAVD='ALL'                                 ALL = ikke filter
     c                   goto      UtavdGrp
     C                   endif
     C                   IF        WSSAVD='IN ' OR WSSAVD='OUT' OR
     C                             WSSAVD='IMP' OR WSSAVD='EXP' OR
     C                             WSSAVD='DOM'
     C     *loval        SETLL     KODTA
     C                   READ      KODTA
     C                   DOW       not %eof(KODTA)
     C                   EXSR      AVDFILTER
     C                   IF        XVIS = 'J'
     c                   add       1             aNr
     c                   if        AvdGrpC=*blanks
     C                   eval      AvdGrpC=%trim(%editc(KOAAVD:'3'))
     c                   eval      TmpAvd1 = KOAAVD
     c                   else
     C                   eval      AvdGrpC=%trim(AvdGrpC)+', '
     C                                    +%trim(%editc(KOAAVD:'3'))
     c                   endif
     c                   endif
     C                   READ      KODTA
     C                   ENDDO
     c                   goto      UtavdGrp
     c                   endif
      *
      * MYDP = My Departments - alle av type
     c                   if        WSSAVD = 'MYDP'
     C                   MOVE      'LTAVD'       PAID
     C     BrParKey      setll     BRPARF
     C     BrParKey      reade     BRPARF
     C                   DOW       not %eof(BRPARF)
     c                   add       1             aNr
     c                   eval      Num4 = PAVRDN
     c                   if        AvdGrpC=*blanks
     C                   eval      AvdGrpC=%trim(%editc(Num4:'3'))
     c                   eval      TmpAvd1 = Num4
     c                   else
     C                   eval      AvdGrpC=%trim(AvdGrpC)+', '
     C                                    +%trim(%editc(Num4:'3'))
     c                   endif
     C     BrParKey      reade     BRPARF
     c                   enddo
     c                   ELSE
      * .. navngitt avd-gruppe, primært på User/sekundært på Firma
     C                   MOVE      'LTAGD'       PAID
     C     StrLes        tag
     C     BrParKey      setll     BRPARF
     C     BrParKey      reade     BRPARF
     C                   DOW       not %eof(BRPARF)
     C                   if        %subst(PAVRDA:1:4) = WSSAVD
     c                   add       1             aNr
     c                   eval      Num4 = PAVRDN
     c                   if        AvdGrpC=*blanks
     C                   eval      AvdGrpC=%trim(%editc(Num4:'3'))
     c                   eval      TmpAvd1 = Num4
     c                   else
     C                   eval      AvdGrpC=%trim(AvdGrpC)+', '
     C                                    +%trim(%editc(Num4:'3'))
     c                   endif
     c                   endif
     C     BrParKey      reade     BRPARF
     c                   enddo
      * ingen på user-nivå - prøv firmanivå
     c                   if        aNr = *zeros and
     c                             %subst(PABRID:1:8) <> '*KUNDFT*'
     C                   eval      PABRID    = '*KUNDFT*'+BIFIRM
     C                   goto      StrLes
     c                   endif
     c
     c                   ENDIF
     c
     c     UTAVDGRP      tag
      * Gruppe på mindre enn 2 tels ikke  / en og bare 1 i gruppa = ordinært avd-søk ikke GRP-søk
     c                   if        aNr < 2
     c                   eval      AvdGrpC=*blanks
     c                   if        aNr = 1 and TmpAvd1 <> *zeros
     c                   eval      WBSAVD = TmpAvd1
     c                   endif
     c                   endif
     c
     C                   ENDSR
      *
      ****************************************************
     C     AVDFILTER     begsr
      ****************************************************

     C                   MOVE      'J'           XVIS              1
      * skrevet om fra individuell IF.. til Select - ingen merking
     C                   select
      *  IN - kun inngående avdelinger innland
     C                   when      WSSAVD = 'IN '
     C                   if        KOAIE <> '2'
     C                   eval      XVIS='N'
     C                   endif
      *  OUT- kun utgående  avdelinger innland
     C                   when      WSSAVD = 'OUT'
     C                   if        KOAIE <> '1'
     C                   eval      XVIS='N'
     C                   endif
      *  DOM- kun domestic (D/1/2)
     C                   when      WSSAVD = 'DOM'
     C                   if        KOAIE<>'D' and KOAIE<>'1' and KOAIE<>'2'
     C                   eval      XVIS='N'
     C                   endif
      *  IMP- kun import
     C                   when      WSSAVD = 'IMP'
     C                   if        KOAIE <> 'I'
     C                   eval      XVIS='N'
     C                   endif
      *  EXP- kun eksport
     C                   when      WSSAVD = 'EXP'
     C                   if        KOAIE <> 'E'
     C                   eval      XVIS='N'
     C                   endif
      *
     C                   endsl
      *
     C     SlavdFilt     endsr
      ************************************************************************
     C     FixIntern     BEGSR
      ************************************************************************
     C     FREEKey       KLIST
     C                   kfld                    HEAVD
     C                   kfld                    HEOPD
     C                   KFLD                    FRTKOD                         = Blank
     c                   eval      InternInfo=*blanks
      *
     C     FREEKey       SETLL     FREETXT2
     C     FREEKey       READE     FREETXT2
     c                   dow       not %eof
     c                   if        InternInfo<>*blanks
     c                   eval      InternInfo=%trim(InternInfo)+'<br>'
     c                   endif
     c                   eval      InternInfo=%trim(InternInfo)+FRTTXT
     C     FREEKey       READE     FREETXT2
     C                   enddo
     C                   ENDSR
      ************************************************************************
     C     FixNavn       BEGSR
      ************************************************************************
     C     KunKey        KLIST
     C                   kfld                    BIFIRM
     C                   kfld                    KUNDNR
     C     VadrKey       KLIST
     C                   kfld                    BIFIRM
     C                   kfld                    KUNDNR
     C                   kfld                    VADRNR
     C                   z-add     1             VADRNR
      * Utgangspunktet er hente / leveringsadresse
     C                   eval      HENASutv = HENAS
     C                   eval      HENAKutv = HENAK
      * Avsender ?? (var i ferd med å sjekke både navn/adr1/adr2/ men KUN NAVN vises jo i kolonna)
     C                   if        HEKNS <> *zeros
     c                   eval      KUNDNR = HEKNS
     c     VadrKey       chain     VADR
     c                   if        not %found
     c     KunKey        chain     Cundl01
     C                   eval      VADRNA = KNAVN
     C                   endif
     C                   move      HENAS         Test1            30
     C                   move      VADRNA        Test2            30
     c                   eval      Test1 = uppify(Test1)
     c                   eval      Test2 = uppify(Test2)
     c                   if        Test1 <> Test2
     C                   eval      HENASutv =%trim(VADRNA)+'/ '+HENAS
     C                   endif
     C                   endif
      * Mottaker ?? (var i ferd med å sjekke både navn/adr1/adr2/ men KUN NAVN vises jo i kolonna)
     C                   if        HEKNK <> *zeros
     c                   eval      KUNDNR = HEKNK
     c     VadrKey       chain     VADR
     c                   if        not %found
     c     KunKey        chain     Cundl01
     C                   eval      VADRNA = KNAVN
     C                   endif
     C                   move      HENAK         Test1            30
     C                   move      VADRNA        Test2            30
     c                   eval      Test1 = uppify(Test1)
     c                   eval      Test2 = uppify(Test2)
     c                   if        Test1 <> Test2
     C                   eval      HENAKutv =%trim(VADRNA)+'/ '+HENAK
     C                   endif
     C                   endif
      *
     C                   ENDSR
     C***********************************************
     C     TTstatus      BEGSR
     C***********************************************
      * Status m.h.t. T&Tevents hentet / levert...
     C                   eval      HENLEV='Levert'
      * sjekk om den er levert / evt hentet
      * LEVERT ??
     C                   MOVE      'POD'         TTACTI
     c     TT02key       Chain     TRACKl02                           33
     C                   if        *in33=*on and TRSLAG='FF'
     C   33              MOVE      'TEI'         TTACTI
     c   33TT02key       Chain     TRACKl02                           33
     c                   endif
     C     *in33         ifeq      *ON
     C                   MOVE      'TE2'         TTACTI
     c     TT02key       setll     TRACKl02
     c     TT02key       reade     TRACKl02                               33
     c     *in33         doweq     '0'
     c                   if        %subst(TTTEXT:1:9)='Signed by'
     c                   leave
     c                   endif
     c     TT02key       reade     TRACKl02                               33
     c                   enddo
     c                   endif
      * er ikke levert...
      * HENTET ??
     C     *in33         ifeq      *ON
     C                   eval      HENLEV='Hentet'
     C                   MOVE      'COL'         TTACTI
     c     TT02key       Chain     TRACKl02                           33
     C   33              MOVE      'TEU'         TTACTI
     c   33TT02key       Chain     TRACKl02                           33
      * heller ikke hentet
     C   33              Movea     '10'          *IN(57)
     C   33              eval      HENLEV='Urørt'
      * På term ?
     c     *in33         ifeq      '1'
     C                   MOVE      'TEI'         TTACTI
     c     TT02key       Chain     TRACKl02                           33
     C   33              MOVE      'TE2'         TTACTI
     c   33TT02key       Chain     TRACKl02                           33
     C  N33              eval      HENLEV='På Term'
     c                   endif
     c                   endif
      *
     c                   ENDSR
     C*
