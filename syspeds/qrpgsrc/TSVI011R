      *********************************************************************
      *
CRTPG+*  CRTPGM SYSPED/TSVI011R MODULE(*LIBL/TSVI011R *LIBL/INCGI)
CRTPGM*        ACTGRP(*NEW) AUT(*USE)
      *
      *********************************************************************
      /copy SYSPEDS/qrpgsrcpy,hspecs
      /copy SYSPEDS/qrpgsrcpy,hspecsbnd
      *********************************************************************
     FBRIDF     IF   E           K DISK    USROPN
     FSVIV      IF   E           K DISK    USROPN
     FSVIVA     IF   E           K DISK    USROPN
      *--------------------------------------------------------------------
      * Variables common to all CGIs
      *--------------------------------------------------------------------
      /copy SYSPEDS/qrpgsrcpy,prototypeb
      /copy SYSPEDS/qrpgsrcpy,usec
      /copy SYSPEDS/qrpgsrcpy,variables3
      *
      * Varible for
     D WSUSER          S             10
     D AVD             S              4
     D AVDN            S              4  0
     D OPD             S              7
     D OPDN            S              7  0
     D LIN             S              5
     D LINN            S              5  0
     D JSONstring      s          32000
     D Error           S            150
     D AntLest         S              9  0
     D                 DS
     D  Å01                    1     15
     D                                     DIM(5)
     D  Å01A                   1      3
     D  Å01B                   4      6
     D  Å01C                   7      9
     D  Å01D                  10     12
     D  Å01E                  13     15
     D                 DS
     D  Å02                    1     55  3
     D                                     DIM(5)
     D  Å02A                   1     11S 3
     D  Å02B                  12     22S 3
     D  Å02C                  23     33S 3
     D  Å02D                  34     44S 3
     D  Å02E                  45     55S 3
     D                 DS
     D  Å03                    1     45  4
     D                                     DIM(5)
     D  Å03A                   1      9S 4
     D  Å03B                  10     18S 4
     D  Å03C                  19     27S 4
     D  Å03D                  28     36S 4
     D  Å03E                  37     45S 4
     D                 DS
     D  Å04                    1     20
     D                                     DIM(5)
     D  Å04A                   1      4
     D  Å04B                   5      8
     D  Å04C                   9     12
     D  Å04D                  13     16
     D  Å04E                  17     20
     D                 DS
     D  Å05                    1     45  0
     D                                     DIM(5)
     D  Å05A                   1      9S 0
     D  Å05B                  10     18S 0
     D  Å05C                  19     27S 0
     D  Å05D                  28     36S 0
     D  Å05E                  37     45S 0

      *get input-string
      /copy syspeds/qrpgsrcpy,prolog3

      * Parse input
     C                   EXSR      Parse
      * Open files etc
     C                   EXSR      INIT

     C                   CALLP     gethtmlifs(
     C                             '/syspeddev/html/JSON.html':
     C                             '/CGITAG/')
     C                   CALLP     wrtsection('top')
      * ............................................................................................
      * skriv JSON-Object start..(alltid '{' + x ant param. m/komma mellom (IKKE komma etter siste))
      * ............................................................................................
      /free
        JSONstring='{'
        +'¬user¬ : ¬'+%trim(WSUSER)+'¬, '
        +'¬avd¬ : ¬'+%trim(%editc(AVDN:'Z'))+'¬, '
        +'¬opd¬ : ¬'+%trim(%editc(OPDN:'Z'))+'¬, '
        +'¬lin¬ : ¬'+%trim(%editc(LINN:'Z'))+'¬, '
        +'¬errMsg¬ : ¬'+%trim(Error)+'¬, ¬oneline¬ : [';
      /end-free
      * JSONfix escaper " i tekst,  for deretter å bytte ¬->"
     C                   CALL      'JSONFIX'
     C                   PARM                    JSONstring
     C                   CALLP     updHTMLvar2('JSONstring'
     C                                         :%addr(JSONstring)
     C                                         :%len(JSONstring))
     C                   CALLP     wrtsection('JSONlin')
      * Hæmta detta ena ærendet.

     C     Error         IFEQ      *blanks
     C     SVIVKey       CHAIN     SVIV                               55
     C     *IN55         IFEQ      '0'
      * Hæmta avgifter
     C                   EXSR      AVG
      * ............................................................................................
      * Skriv en JSON-Array-linje pr menypunkt - komma før hvert nytt element
      * ............................................................................................
      /free
          JSONstring=*blanks;
       JSONstring=%trim(JSONstring)+'{'
          +'¬sviv_syav¬ : ¬'+%trim(%editc(SVIV_SYAV:'Z'))+'¬, '
          +'¬sviv_syop¬ : ¬'+%trim(%editc(SVIV_SYOP:'Z'))+'¬, '
          +'¬sviv_syli¬ : ¬'+%trim(%editc(SVIV_SYLI:'Z'))+'¬, '
          +'¬sviv_kota¬ : ¬'+%trim(%editc(SVIV_KOTA:'Z'))+'¬, '
          +'¬sviv_kot2¬ : ¬'+%trim(%editc(SVIV_KOT2:'Z'))+'¬, '
          +'¬sviv_kot3¬ : ¬'+%trim(%editc(SVIV_KOT3:'Z'))+'¬, '
          +'¬sviv_kot4¬ : ¬'+%trim(%editc(SVIV_KOT4:'Z'))+'¬, '
          +'¬sviv_kot5¬ : ¬'+%trim(%editc(SVIV_KOT5:'Z'))+'¬, '
          +'¬sviv_kosl¬ : ¬'+%trim(SVIv_kosl)+'¬, '
          +'¬sviv_kos2¬ : ¬'+%trim(SVIv_kos2)+'¬, '
          +'¬sviv_kos3¬ : ¬'+%trim(SVIv_kos3)+'¬, '
          +'¬sviv_kos4¬ : ¬'+%trim(SVIv_kos4)+'¬, '
          +'¬sviv_kos5¬ : ¬'+%trim(SVIv_kos5)+'¬, '
          +'¬sviv_vasl¬ : ¬'+%trim(SVIv_vasl)+'¬, '
          +'¬sviv_vas2¬ : ¬'+%trim(SVIv_vas2)+'¬, '
          +'¬sviv_vas3¬ : ¬'+%trim(SVIv_vas3)+'¬, '
          +'¬sviv_vas4¬ : ¬'+%trim(SVIv_vas4)+'¬, '
          +'¬sviv_godm¬ : ¬'+%trim(SVIv_godm)+'¬, '
          +'¬sviv_god2¬ : ¬'+%trim(SVIv_god2)+'¬, '
          +'¬sviv_god3¬ : ¬'+%trim(SVIv_god3)+'¬, '
          +'¬sviv_god4¬ : ¬'+%trim(SVIv_god4)+'¬, '
          +'¬sviv_god5¬ : ¬'+%trim(SVIv_god5)+'¬, '
          +'¬sviv_vano¬ : ¬'+%trim(%editc(SVIv_vano:'Z'))+'¬, '
          +'¬sviv_vata¬ : ¬'+%trim(SVIv_vata)+'¬, '
          +'¬sviv_vati¬ : ¬'+%trim(SVIv_vati)+'¬, '
          +'¬sviv_vat4¬ : ¬'+%trim(SVIv_vat4)+'¬, '
          +'¬sviv_vat5¬ : ¬'+%trim(SVIv_vat5)+'¬, '
          +'¬sviv_ulkd¬ : ¬'+%trim(SVIv_ulkd)+'¬, '
          +'¬sviv_brut¬ : ¬'+%trim(%editc(SVIv_brut:'4'))+'¬, '
          +'¬sviv_fokd¬ : ¬'+%trim(SVIv_fokd)+'¬, '
          +'¬sviv_eup1¬ : ¬'+%trim(SVIv_eup1)+'¬, '
          +'¬sviv_eup2¬ : ¬'+%trim(SVIv_eup2)+'¬, '
          +'¬sviv_neto¬ : ¬'+%trim(%editc(SVIv_neto:'4'))+'¬, '
          +'¬sviv_kono¬ : ¬'+%trim(SVIv_kosl)+'¬, '
          +'¬sviv_ankv¬ : ¬'+%trim(%editc(SVIv_ankv:'Z'))+'¬, '
          +'¬sviv_suko¬ : ¬'+%trim(SVIv_suko)+'¬, '
          +'¬sviv_suk6¬ : ¬'+%trim(SVIv_suk6)+'¬, '
          +'¬sviv_sukb¬ : ¬'+%trim(SVIv_sukB)+'¬, '
          +'¬sviv_sutx¬ : ¬'+%trim(SVIv_sutx)+'¬, '
          +'¬sviv_sut2¬ : ¬'+%trim(SVIv_sut2)+'¬, '
          +'¬sviv_sut3¬ : ¬'+%trim(SVIv_sut3)+'¬, '
          +'¬sviv_sut4¬ : ¬'+%trim(SVIv_sut4)+'¬, '
          +'¬sviv_sut5¬ : ¬'+%trim(SVIv_sut5)+'¬, '
          +'¬sviv_sut6¬ : ¬'+%trim(SVIv_sut6)+'¬, '
          +'¬sviv_sut7¬ : ¬'+%trim(SVIv_sut7)+'¬, '
          +'¬sviv_sut8¬ : ¬'+%trim(SVIv_sut8)+'¬, '
          +'¬sviv_sut9¬ : ¬'+%trim(SVIv_sut9)+'¬, '
          +'¬sviv_suta¬ : ¬'+%trim(SVIv_suta)+'¬, '
          +'¬sviv_sutb¬ : ¬'+%trim(SVIv_sutb)+'¬, '
          +'¬sviv_sutc¬ : ¬'+%trim(SVIv_sutc)+'¬, '
          +'¬sviv_sutd¬ : ¬'+%trim(SVIv_sutd)+'¬, '
          +'¬sviv_sute¬ : ¬'+%trim(SVIv_sute)+'¬, '
          +'¬sviv_sutf¬ : ¬'+%trim(SVIv_sutf)+'¬, '
          +'¬sviv_suok¬ : ¬'+%trim(%editc(SVIv_suok:'Z'))+'¬, '
          +'¬sviv_sukr¬ : ¬'+%trim(%editc(SVIv_sukr:'Z'))+'¬, '
          +'¬sviv_suar¬ : ¬'+%trim(%editc(SVIv_suar:'Z'))+'¬, '
          +'¬sviv_atin¬ : ¬'+%trim(SVIv_atin)+'¬, '
          +'¬sviv_stva¬ : ¬'+%trim(%editc(SVIv_stva:'4'))+'¬, '
          +'¬sviv_stva2¬ : ¬'+%trim(%editc(SVIv_stva2:'4'))+'¬, '
          +'¬sviv_fabl¬ : ¬'+%trim(%editc(SVIv_fabl:'4'))+'¬, '
          +'¬sviv_bit1¬ : ¬'+%trim(SVIv_bit1)+'¬, '
          +'¬sviv_bit2¬ : ¬'+%trim(SVIv_bit2)+'¬, '
          +'¬sviv_bit3¬ : ¬'+%trim(SVIv_bit3)+'¬, '
          +'¬sviv_bit4¬ : ¬'+%trim(SVIv_bit4)+'¬, '
          +'¬sviv_bit5¬ : ¬'+%trim(SVIv_bit5)+'¬, '
          +'¬sviv_bit6¬ : ¬'+%trim(SVIv_bit6)+'¬, '
          +'¬sviv_bit7¬ : ¬'+%trim(SVIv_bit7)+'¬, '
          +'¬sviv_bit8¬ : ¬'+%trim(SVIv_bit8)+'¬, '
          +'¬sviv_bit9¬ : ¬'+%trim(SVIv_bit9)+'¬, '
          +'¬sviv_bii1¬ : ¬'+%trim(SVIv_bii1)+'¬, '
          +'¬sviv_bii2¬ : ¬'+%trim(SVIv_bii2)+'¬, '
          +'¬sviv_bii3¬ : ¬'+%trim(SVIv_bii3)+'¬, '
          +'¬sviv_bii4¬ : ¬'+%trim(SVIv_bii4)+'¬, '
          +'¬sviv_bii5¬ : ¬'+%trim(SVIv_bii5)+'¬, '
          +'¬sviv_bii6¬ : ¬'+%trim(SVIv_bii6)+'¬, '
          +'¬sviv_bii7¬ : ¬'+%trim(SVIv_bii7)+'¬, '
          +'¬sviv_bii8¬ : ¬'+%trim(SVIv_bii8)+'¬, '
          +'¬sviv_bii9¬ : ¬'+%trim(SVIv_bii9)+'¬, '
          +'¬sviv_co01¬ : ¬'+%trim(SVIv_co01)+'¬, '
          +'¬sviv_co02¬ : ¬'+%trim(SVIv_co02)+'¬, '
          +'¬sviv_co03¬ : ¬'+%trim(SVIv_co03)+'¬, '
          +'¬sviv_co04¬ : ¬'+%trim(SVIv_co04)+'¬, '
          +'¬sviv_co05¬ : ¬'+%trim(SVIv_co05)+'¬, '
          +'¬sviv_co06¬ : ¬'+%trim(SVIv_co06)+'¬, '
          +'¬sviv_co07¬ : ¬'+%trim(SVIv_co07)+'¬, '
          +'¬sviv_co08¬ : ¬'+%trim(SVIv_co08)+'¬, '
          +'¬sviv_co09¬ : ¬'+%trim(SVIv_co09)+'¬, '
          +'¬sviv_co10¬ : ¬'+%trim(SVIv_co10)+'¬, '
          +'¬sviv_co11¬ : ¬'+%trim(SVIv_co11)+'¬, '
          +'¬sviv_co12¬ : ¬'+%trim(SVIv_co12)+'¬, '
          +'¬sviv_co13¬ : ¬'+%trim(SVIv_co13)+'¬, '
          +'¬sviv_co14¬ : ¬'+%trim(SVIv_co14)+'¬, '
          +'¬sviv_co15¬ : ¬'+%trim(SVIv_co15)+'¬, '
          +'¬sviv_co16¬ : ¬'+%trim(SVIv_co16)+'¬, '
          +'¬sviv_co17¬ : ¬'+%trim(SVIv_co17)+'¬, '
          +'¬sviv_co18¬ : ¬'+%trim(SVIv_co18)+'¬, '
          +'¬sviv_co19¬ : ¬'+%trim(SVIv_co19)+'¬, '
          +'¬sviv_co20¬ : ¬'+%trim(SVIv_co20)+'¬, '
          +'¬sviv_tik1¬ : ¬'+%trim(SVIv_tik1)+'¬, '
          +'¬sviv_tik2¬ : ¬'+%trim(SVIv_tik2)+'¬, '
          +'¬sviv_tik3¬ : ¬'+%trim(SVIv_tik3)+'¬, '
          +'¬sviv_tik4¬ : ¬'+%trim(SVIv_tik4)+'¬, '
          +'¬sviv_tik5¬ : ¬'+%trim(SVIv_tik5)+'¬, '
          +'¬sviv_tik6¬ : ¬'+%trim(SVIv_tik6)+'¬, '
          +'¬sviv_tik7¬ : ¬'+%trim(SVIv_tik7)+'¬, '
          +'¬sviv_tik8¬ : ¬'+%trim(SVIv_tik8)+'¬, '
          +'¬sviv_tik9¬ : ¬'+%trim(SVIv_tik9)+'¬, '
          +'¬sviv_tit1¬ : ¬'+%trim(SVIv_tit1)+'¬, '
          +'¬sviv_tit2¬ : ¬'+%trim(SVIv_tit2)+'¬, '
          +'¬sviv_tit3¬ : ¬'+%trim(SVIv_tit3)+'¬, '
          +'¬sviv_tit4¬ : ¬'+%trim(SVIv_tit4)+'¬, '
          +'¬sviv_tit5¬ : ¬'+%trim(SVIv_tit5)+'¬, '
          +'¬sviv_tit6¬ : ¬'+%trim(SVIv_tit6)+'¬, '
          +'¬sviv_tit7¬ : ¬'+%trim(SVIv_tit7)+'¬, '
          +'¬sviv_tit8¬ : ¬'+%trim(SVIv_tit8)+'¬, '
          +'¬sviv_tit9¬ : ¬'+%trim(SVIv_tit9)+'¬, '
          +'¬sviv_tix1¬ : ¬'+%trim(SVIv_tix1)+'¬, '
          +'¬sviv_tix2¬ : ¬'+%trim(SVIv_tix2)+'¬, '
          +'¬sviv_tix3¬ : ¬'+%trim(SVIv_tix3)+'¬, '
          +'¬sviv_tix4¬ : ¬'+%trim(SVIv_tix4)+'¬, '
          +'¬sviv_tix5¬ : ¬'+%trim(SVIv_tix5)+'¬, '
          +'¬sviv_tix6¬ : ¬'+%trim(SVIv_tix6)+'¬, '
          +'¬sviv_tix7¬ : ¬'+%trim(SVIv_tix7)+'¬, '
          +'¬sviv_tix8¬ : ¬'+%trim(SVIv_tix8)+'¬, '
          +'¬sviv_tix9¬ : ¬'+%trim(SVIv_tix9)+'¬, '
          +'¬sviv_lagi¬ : ¬'+%trim(SVIv_lagi)+'¬, '
          +'¬sviv_lagt¬ : ¬'+%trim(SVIv_lagt)+'¬, '
          +'¬sviv_lagl¬ : ¬'+%trim(SVIV_lagl)+'¬, '

          +'¬sviva_abk1¬ : ¬'+%trim(Å01A)+'¬, '
          +'¬sviva_abg1¬ : ¬'+%trim(%editc(Å02A:'4'))+'¬, '
          +'¬sviva_abs1¬ : ¬'+%trim(%editc(Å03A:'4'))+'¬, '
          +'¬sviva_abx1¬ : ¬'+%trim(Å04A)+'¬, '
          +'¬sviva_abb1¬ : ¬'+%trim(%editc(Å05A:'4'))+'¬, '

          +'¬sviva_abk2¬ : ¬'+%trim(Å01B)+'¬, '
          +'¬sviva_abg2¬ : ¬'+%trim(%editc(Å02B:'4'))+'¬, '
          +'¬sviva_abs2¬ : ¬'+%trim(%editc(Å03B:'4'))+'¬, '
          +'¬sviva_abx2¬ : ¬'+%trim(Å04B)+'¬, '
          +'¬sviva_abb2¬ : ¬'+%trim(%editc(Å05B:'4'))+'¬, '

          +'¬sviva_abk3¬ : ¬'+%trim(Å01C)+'¬, '
          +'¬sviva_abg3¬ : ¬'+%trim(%editc(Å02C:'4'))+'¬, '
          +'¬sviva_abs3¬ : ¬'+%trim(%editc(Å03C:'4'))+'¬, '
          +'¬sviva_abx3¬ : ¬'+%trim(Å04C)+'¬, '
          +'¬sviva_abb3¬ : ¬'+%trim(%editc(Å05C:'4'))+'¬, '

          +'¬sviva_abk4¬ : ¬'+%trim(Å01D)+'¬, '
          +'¬sviva_abg4¬ : ¬'+%trim(%editc(Å02D:'4'))+'¬, '
          +'¬sviva_abs4¬ : ¬'+%trim(%editc(Å03D:'4'))+'¬, '
          +'¬sviva_abx4¬ : ¬'+%trim(Å04D)+'¬, '
          +'¬sviva_abb4¬ : ¬'+%trim(%editc(Å05D:'4'))+'¬, '

          +'¬sviva_abk5¬ : ¬'+%trim(Å01E)+'¬, '
          +'¬sviva_abg5¬ : ¬'+%trim(%editc(Å02E:'4'))+'¬, '
          +'¬sviva_abs5¬ : ¬'+%trim(%editc(Å03E:'4'))+'¬, '
          +'¬sviva_abx5¬ : ¬'+%trim(Å04E)+'¬, '
          +'¬sviva_abb5¬ : ¬'+%trim(%editc(Å05E:'4'))+'¬, '

          +'¬sviv_err¬ : ¬'+%trim(SVIV_ERR)+'¬, '
          +'¬sviv_call¬ : ¬'+%trim(SVIV_call)+'¬}';
      /end-free
     C                   CALL      'JSONFIX'
     C                   PARM                    JSONstring
     C                   CALLP     updHTMLvar2('JSONstring'
     C                                         :%addr(JSONstring)
     C                                         :%len(JSONstring))
     C                   CALLP     wrtsection('JSONlin')

     C                   ENDIF
     C                   ENDIF
      * ............................................................................................
      * Skriv JSON-string Avsluttning
      * ............................................................................................
     C                   EVAL      JSONstring =']}'
     C                   CALLP     updHTMLvar2('JSONstring'
     C                                         :%addr(JSONstring)
     C                                         :%len(JSONstring))
     C                   CALLP     wrtsection('JSONlin')
      * Quit
     C                   EXSR      EXIT
      *=====================================================================
      * Close output html and quit
      *=====================================================================
     C     EXIT          BEGSR
      * Lukk fil
     C                   CLOSE     BRIDF
     C  N50              CLOSE     SVIV
     C  N50              CLOSE     SVIVA

      * Do not delete the CALL to wrtsection with section name *fini.  It is needed
      * to ensure that all output html that has been buffered gets output.
     C                   CALLP     wrtsection('*fini')
      * Quit
     C                   MOVE      *ON           *INLR
     C                   RETURN
     C                   ENDSR
      *********************************************************
     C     Parse         BEGSR
      *********************************************************
      * Get input
     C                   EVAL      WSUSER  = zhbgetvar('USER')
     C                   EVAL      AVD     = zhbgetvar('AVD')
     C                   EVAL      AVDN    = c2n2(AVD)
     C                   EVAL      OPD     = zhbgetvar('OPD')
     C                   EVAL      OPDN    = c2n2(OPD)
     C                   EVAL      LIN     = zhbgetvar('LIN')
     C                   EVAL      LINN    = c2n2(LIN)
     C                   ENDSR
      *********************************************************
     C     INIT          BEGSR
      *********************************************************
     C                   OPEN      BRIDF
      * Test innlogging
     C     WSUSER        CHAIN     BRIDF                              50
     C     BILIBL        IFEQ      *blanks
     C                   CALLb     'INCGI'
     C                   PARM                    BISTDL
     C                   else
     C                   CALL      BILIBL
     C                   end

     C     SVIVKey       klist
     C                   kfld                    AVDN
     C                   kfld                    OPDN
     C                   kfld                    LINN
     C                   MOVEA     *ZEROS        Å02
     C                   MOVEA     *ZEROS        Å03
     C                   MOVEA     *ZEROS        Å05
     C                   Z-ADD     1             X                 3 0
     C                   Z-ADD     0             WX                3 0

     C   50              EVAL      Error = 'Invalid userID'
     C  N50              OPEN      SVIV
     C  N50              OPEN      SVIVA

     C                   ENDSR
      *********************************************************
     C     AVG           BEGSR
      *********************************************************
      * Sjekker først om det finnes noen verdier å vise
     C     SVIVKEY       SETLL     SVIVA
     C     SVIVKEY       READE(N)  SVIVA                                  56
     C     *IN56         DOWEQ     *OFF
     C                   MOVE      SVIVA_ABK     Å01(X)
     C                   MOVE      SVIVA_ABG     Å02(X)
     C                   MOVE      SVIVA_ABS     Å03(X)
     C                   MOVE      SVIVA_ABX     Å04(X)
     C                   MOVE      SVIVA_ABB     Å05(X)
     C                   ADD       1             X
     C     X             IFGT      5
     C                   LEAVE
     C                   ENDIF
     C     SVIVKEY       READE(N)  SVIVA                                  56
     C                   ENDDO
     C                   ENDSR
