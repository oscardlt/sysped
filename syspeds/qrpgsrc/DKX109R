     H Option( *SrcStmt ) DftActGrp( *No ) BndDir( 'QC2LE' )
     FEDIS      O  A E             DISK
     FEDIM      O  A E             DISK
     FEDIC      UF   E             DISK
     FDKTFI     IF   E             DISK
      *____________________
      * DS for input string
      *""""""""""""""""""""
     D                 DS
     D  A                      1  30000    DIM(30000)
     D  ADS                    1  30000
      *_____________________
      * DS for output string
      *"""""""""""""""""""""
     D                 DS
     D  B                      1  30000    DIM(30000)
     D  BDS                    1  30000
     D                 DS
     D  SEMBR                  1     10
     D  SEMBR1                 1      1
     D  SEMBR2                 2     10
     D                 DS
     D  DKTF_0004T             1     35
     D  WREGSENR               1      8
     D                 DS
     D  WSSN                   1      9S 0
     D  WSSNA                  1      9
      *__________
      * Variabler
      *""""""""""
     D FILE_o          s               *
     D String          s            512a
     D rc              s             10i 0
     D Data            s          30000a   Varying
     D Codepage        s              5a   Varying
      *___________________________
      * IFS Stream file funksjoner
      *"""""""""""""""""""""""""""
     Dopen             Pr              *   ExtProc( '_C_IFS_fopen' )
     D                                 *   Value Options( *String )
     D                                 *   Value Options( *String )

     Dfputs            Pr            10i 0 ExtProc( '_C_IFS_fputs' )
     D                                 *   Value Options( *String )
     D                                 *   Value

     Dclose            Pr            10i 0 ExtProc( '_C_IFS_fclose' )
     D                                 *   Value
     D RunCmd          PR                  EXTPGM('QCMDEXC')
     D  Cmd                         200A   CONST
     D  Len                          15P 5 CONST
      *   SYEDI data area
     D EDIDTA          DS           256
     D  UELIBF               171    180
      *//////////////
      *  Hodelogikk /
      *//////////////
      * Initiering av variabler og nøkler
     C                   EXSR      SRA
      * LAGE KVITTERINGS FIL
     C                   EXSR      SRC
      *
     C                   EXSR      SREDIM
     C                   EXSR      SREDIS
      *
     C                   MOVE      '1'           *INLR
      *
      *////////////////////////////////////////////////////////////
      *  Initiering                                           SRA /
      *////////////////////////////////////////////////////////////
     C     SRA           BEGSR
      *__________________
      * Definiere Nøkkler
      *""""""""""""""""""
      *_____________
      * Init av felt
      *"""""""""""""
      * Hente dagens dato og klokkeslett.
     C                   CALL      'SYGE15C'
     C                   PARM                    WDT               8
     C                   PARM                    WTM               6
      *
      * Workfields for Array's
     C                   Z-ADD     0             AX                2 0          Index for A
     C                   Z-ADD     1             BX                5 0          Index for B
     C                   Z-ADD     0             AXV               5 0          Leftindx A
     C                   Z-ADD     0             AXH               5 0          Rightindx A
     C                   MOVE      'R'           WDIR              1            Search direction
     C                   MOVE      *BLANKS       WCHAR             1            Test character
     C                   MOVE      'Y'           WCHART            1            Test character
      * Workfields for separation character  '
     C                   BITON     '123457'      WAPSTR            1
     C                   BITOFF    '06'          WAPSTR
      *_________________
      * Input parametrer
      *"""""""""""""""""
     C     *ENTRY        PLIST
     C                   PARM                    UAVD              4
     C                   PARM                    UTDN              7
     C                   PARM                    USG               3
     C                   PARM                    UA0004           35
     C                   PARM                    UA0007            4
     C                   PARM                    UA0008           14
     C                   PARM                    UM0010           35
     C                   PARM                    UM0007            4
     C                   PARM                    UM0008           14
     C                   PARM                    U0020            14
     C                   PARM                    U0022            14
     C                   PARM                    U0035             1
     C                   PARM                    U1225             3
      *
     C     1             CHAIN     EDIC                               32
     C                   ADD       1             CMN
     C                   ADD       1             CSN
     C                   UPDATE    EDICR
     C                   MOVE      *BLANKS       SEMBR
     C                   MOVE      'K'           SEMBR1
     C                   MOVEL     CSN           SEMBR2
      *
      *_______________________________
      * Hente firmarecord
      *"""""""""""""""""""""""""""""""
     C                   READ      DKTFI                                  33
      * Åpne dataarea
     C     *DTAARA       DEFINE                  EDIDTA
     C                   IN        EDIDTA
     C                   ENDSR
      *
      *////////////////////////////////////////////////////////////
      *  Les meldinger                                        SRC /
      *////////////////////////////////////////////////////////////
     C     SRC           BEGSR
      *
     C                   EXSR      UNA00
     C                   EXSR      UNB00
     C                   EXSR      UNH00
     C                   EXSR      UCI00
     C                   EXSR      UNT00
     C                   EXSR      UNZ00
      *
     C                   ENDSR
      *
      *////////////////////////////////////////////////////////////
      *  SENDINGSTART                                       UNA00 /
      *////////////////////////////////////////////////////////////
     C     UNA00         BEGSR
     C                   EVAL      ADS = 'UNA:+.? ' + WAPSTR
     C                   Z-ADD     1             AXV
     C                   Z-ADD     9             AXH
     C                   MOVE      'N'           WCHART
     C                   EXSR      SRÅ
      *
     C                   ENDSR
      *
      *////////////////////////////////////////////////////////////
      *  Sendningsstart                                     UNB00 /
      *////////////////////////////////////////////////////////////
     C     UNB00         BEGSR
      *______________
      * START SEGMENT
      *""""""""""""""
     C                   MOVE      *BLANKS       ADS
     C                   MOVEL     'UNB+'        ADS
     C                   Z-ADD     1             AXV
     C                   Z-ADD     4             AXH
     C                   MOVE      'N'           WCHART
     C                   EXSR      SRÅ
      *______________________
      * SYNTAX IDENTIFIKASJON
      *""""""""""""""""""""""
      * Identifikasjon og versjon
     C                   MOVE      *BLANKS       ADS
     C                   MOVEL     'UNOC:3+'     ADS
     C                   Z-ADD     1             AXV
     C                   Z-ADD     7             AXH
     C                   MOVE      'N'           WCHART
     C                   EXSR      SRÅ
      *____________________
      * OVERFØRINGSAVSENDER
      *""""""""""""""""""""
      * Identifikasjon
     C                   MOVE      *BLANKS       ADS
     C                   MOVEL     UA0004        ADS
     C                   Z-ADD     1             AXV
     C                   Z-ADD     35            AXH
     C                   EXSR      SRÅ
      *
     C                   IF        ((UA0007 <> *BLANKS) OR (UA0008 <> *BLANKS))
     C                   EVAL      ADS = ':' + UA0007
     C                   Z-ADD     1             AXV
     C                   Z-ADD     5             AXH
     C                   MOVE      'N'           WCHART
     C                   EXSR      SRÅ
      *
     C                   IF        UA0008 <> *BLANKS
     C                   EVAL      ADS = ':' + UA0008
     C                   Z-ADD     1             AXV
     C                   Z-ADD     4             AXH
     C                   MOVE      'N'           WCHART
     C                   EXSR      SRÅ
     C                   END
      *
     C                   END
      *
     C                   MOVE      *BLANKS       ADS
     C                   MOVEL     '+'           ADS
     C                   Z-ADD     1             AXV
     C                   Z-ADD     1             AXH
     C                   MOVE      'N'           WCHART
     C                   EXSR      SRÅ
      *____________________
      * OVERFØRINGSMOTTAKER
      *""""""""""""""""""""
      * Identifikasjon og Qualifier
     C                   EVAL      ADS = UM0010
     C                   Z-ADD     1             AXV
     C                   Z-ADD     35            AXH
     C                   EXSR      SRÅ
      *
     C                   IF        ((UM0007 <> *BLANKS) OR (UM0008 <> *BLANKS))
     C                   EVAL      ADS = ':' + UM0007
     C                   Z-ADD     1             AXV
     C                   Z-ADD     5             AXH
     C                   MOVE      'N'           WCHART
     C                   EXSR      SRÅ
      *
     C                   IF        UM0008 <> *BLANKS
     C                   EVAL      ADS = ':' + UM0008
     C                   Z-ADD     1             AXV
     C                   Z-ADD     4             AXH
     C                   MOVE      'N'           WCHART
     C                   EXSR      SRÅ
     C                   END
      *
     C                   END
      *
     C                   MOVE      *BLANKS       ADS
     C                   MOVEL     '+'           ADS
     C                   Z-ADD     1             AXV
     C                   Z-ADD     1             AXH
     C                   MOVE      'N'           WCHART
     C                   EXSR      SRÅ
      *__________________________________________
      * DATO/TID FOR FREMSTILLING AV OVERFØRINGEN
      *""""""""""""""""""""""""""""""""""""""""""
      * Dato
     C                   MOVE      *BLANKS       ADS
     C                   MOVEL     WDT           ADS
     C                   Z-ADD     3             AXV
     C                   Z-ADD     8             AXH
     C                   EXSR      SRÅ
      *
     C                   MOVE      *BLANKS       ADS
     C                   MOVEL     ':'           ADS
     C                   Z-ADD     1             AXV
     C                   Z-ADD     1             AXH
     C                   MOVE      'N'           WCHART
     C                   EXSR      SRÅ
      * Tid
     C                   MOVE      *BLANKS       ADS
     C                   MOVEL     WTM           ADS
     C                   Z-ADD     1             AXV
     C                   Z-ADD     4             AXH
     C                   EXSR      SRÅ
      *
     C                   MOVE      *BLANKS       ADS
     C                   MOVEL     '+'           ADS
     C                   Z-ADD     1             AXV
     C                   Z-ADD     1             AXH
     C                   MOVE      'N'           WCHART
     C                   EXSR      SRÅ
      *________________________
      * OVERFØRINGENS REFERANSE
      *""""""""""""""""""""""""
     C                   MOVE      *BLANKS       ADS
     C                   MOVEL     U0020         ADS
     C                   Z-ADD     1             AXV
     C                   Z-ADD     14            AXH
     C                   EXSR      SRÅ
      *
     C                   MOVE      *BLANKS       ADS
     C                   MOVEL     '+'           ADS
     C                   Z-ADD     1             AXV
     C                   Z-ADD     1             AXH
     C                   MOVE      'N'           WCHART
     C                   EXSR      SRÅ
      *________________________
      * RECIPENT'S REFERENCE
      *""""""""""""""""""""""""
     C                   EVAL      ADS = U0022
     C                   Z-ADD     1             AXV
     C                   Z-ADD     14            AXH
     C                   EXSR      SRÅ
      *
     C                   MOVE      *BLANKS       ADS
     C                   MOVEL     '+'           ADS
     C                   Z-ADD     1             AXV
     C                   Z-ADD     1             AXH
     C                   MOVE      'N'           WCHART
     C                   EXSR      SRÅ
      *______________________________________________
      * APPLIKASJONSREFERANSE
      *""""""""""""""""""""""""""""""""""""""""""""""
     C                   EVAL      ADS = 'CONTRLTI-KV'
     C                   Z-ADD     1             AXV
     C                   Z-ADD     14            AXH
     C                   EXSR      SRÅ
      *______________
      * TESTINDIKATOR
      *""""""""""""""
     C                   IF        U0035 > '0'                                  <----------I
     C                   EVAL      ADS = '++++'                                            I
     C                   Z-ADD     1             AXV                                       I
     C                   Z-ADD     4             AXH                                       I
     C                   MOVE      'N'           WCHART                                    I
     C                   EXSR      SRÅ                                                     I
      *                                                               I                    I
     C                   MOVE      *BLANKS       ADS                                       I
     C                   MOVEL     U0035         ADS                                       I
     C                   Z-ADD     1             AXV                                       I
     C                   Z-ADD     1             AXH                                       I
     C                   EXSR      SRÅ                                                     I
     C                   END                                                    <----------I
      *______________
      * SLUTT SEGMENT
      *""""""""""""""
     C                   MOVE      *BLANKS       ADS
     C                   MOVEL     WAPSTR        ADS
     C                   Z-ADD     1             AXV
     C                   Z-ADD     1             AXH
     C                   MOVE      'N'           WCHART
     C                   EXSR      SRÅ
      *
     C                   ENDSR
      *
      *////////////////////////////////////////////////////////////
      *  Meldingsstart                                      UNH00 /
      *////////////////////////////////////////////////////////////
     C     UNH00         BEGSR
      * Segmentnavn
     C                   MOVE      *BLANKS       ADS
     C                   MOVEL     'UNH+'        ADS
     C                   Z-ADD     1             AXV
     C                   Z-ADD     4             AXH
     C                   MOVE      'N'           WCHART
     C                   EXSR      SRÅ
      * Meldingsreferanse
     C                   EVAL      ADS = UAVD + UTDN + USG
     C                   Z-ADD     1             AXV
     C                   Z-ADD     14            AXH
     C                   EXSR      SRÅ
      *
     C                   MOVE      *BLANKS       ADS
     C                   MOVEL     '+'           ADS
     C                   Z-ADD     1             AXV
     C                   Z-ADD     1             AXH
     C                   MOVE      'N'           WCHART
     C                   EXSR      SRÅ
      * Meldingstype
      *
     C                   MOVE      *BLANKS       ADS
     C                   EVAL      ADS = 'CONTRL:D:3:UN:DKC02A'
     C                   Z-ADD     1             AXV
     C                   Z-ADD     20            AXH
     C                   MOVE      'N'           WCHART
     C                   EXSR      SRÅ
      * Slutt segment
     C                   MOVE      *BLANKS       ADS
     C                   MOVEL     WAPSTR        ADS
     C                   Z-ADD     1             AXV
     C                   Z-ADD     1             AXH
     C                   MOVE      'N'           WCHART
     C                   EXSR      SRÅ
      *
     C                   ENDSR
      *
      *////////////////////////////////////////////////////////////
      *  INTERCHARGE RESPONSE                               UCI00 /
      *////////////////////////////////////////////////////////////
     C     UCI00         BEGSR
      * Segmentnavn
     C                   EVAL      ADS = 'UCI+' + U0020
     C                   Z-ADD     1             AXV
     C                   Z-ADD     18            AXH
     C                   MOVE      'N'           WCHART
     C                   EXSR      SRÅ
      *
     C                   MOVE      *BLANKS       ADS
     C                   MOVEL     '+'           ADS
     C                   Z-ADD     1             AXV
     C                   Z-ADD     1             AXH
     C                   MOVE      'N'           WCHART
     C                   EXSR      SRÅ
      *
     C                   EVAL      ADS = UM0010
     C                   Z-ADD     1             AXV
     C                   Z-ADD     35            AXH
     C                   EXSR      SRÅ
      *
     C                   IF        ((UM0007 <> *BLANKS) OR (UM0008 <> *BLANKS))
     C                   EVAL      ADS = ':' + UM0007
     C                   Z-ADD     1             AXV
     C                   Z-ADD     5             AXH
     C                   MOVE      'N'           WCHART
     C                   EXSR      SRÅ
      *
     C                   IF        UM0008 <> *BLANKS
     C                   EVAL      ADS = ':' + UM0008
     C                   Z-ADD     1             AXV
     C                   Z-ADD     4             AXH
     C                   MOVE      'N'           WCHART
     C                   EXSR      SRÅ
     C                   END
      *
     C                   END
      *
     C                   MOVE      *BLANKS       ADS
     C                   MOVEL     '+'           ADS
     C                   Z-ADD     1             AXV
     C                   Z-ADD     1             AXH
     C                   MOVE      'N'           WCHART
     C                   EXSR      SRÅ
      *
     C                   EVAL      ADS = UA0004
     C                   Z-ADD     1             AXV
     C                   Z-ADD     35            AXH
     C                   EXSR      SRÅ
      *
     C                   IF        ((UA0007 <> *BLANKS) OR (UA0008 <> *BLANKS))
     C                   EVAL      ADS = ':' + UA0007
     C                   Z-ADD     1             AXV
     C                   Z-ADD     5             AXH
     C                   MOVE      'N'           WCHART
     C                   EXSR      SRÅ
      *
     C                   IF        UA0008 <> *BLANKS
     C                   EVAL      ADS = ':' + UA0008
     C                   Z-ADD     1             AXV
     C                   Z-ADD     4             AXH
     C                   MOVE      'N'           WCHART
     C                   EXSR      SRÅ
     C                   END
      *
     C                   END
      *
     C                   MOVE      *BLANKS       ADS
     C                   MOVEL     '+7'          ADS
     C                   Z-ADD     1             AXV
     C                   Z-ADD     2             AXH
     C                   MOVE      'N'           WCHART
     C                   EXSR      SRÅ
      * Slutt segment
     C                   MOVE      *BLANKS       ADS
     C                   MOVEL     WAPSTR        ADS
     C                   Z-ADD     1             AXV
     C                   Z-ADD     1             AXH
     C                   MOVE      'N'           WCHART
     C                   EXSR      SRÅ
      *
     C                   ENDSR
      *
      *////////////////////////////////////////////////////////////
      *  Meldingsslutt                                      UNT00 /
      *////////////////////////////////////////////////////////////
     C     UNT00         BEGSR
      * Segmentnavn
     C                   EVAL      ADS = 'UNT+3+' + UAVD + UTDN + USG
     C                   Z-ADD     1             AXV
     C                   Z-ADD     20            AXH
     C                   MOVE      'N'           WCHART
     C                   EXSR      SRÅ
      * Slutt segment
     C                   MOVE      *BLANKS       ADS
     C                   MOVEL     WAPSTR        ADS
     C                   Z-ADD     1             AXV
     C                   Z-ADD     1             AXH
     C                   MOVE      'N'           WCHART
     C                   EXSR      SRÅ
      *
     C                   ENDSR
      *
      *////////////////////////////////////////////////////////////
      *  Sendningsslutt                                     UNZ00 /
      *////////////////////////////////////////////////////////////
     C     UNZ00         BEGSR
      * Start segment
     C                   EVAL      ADS = 'UNZ+1+' + U0020
     C                   Z-ADD     1             AXV
     C                   Z-ADD     20            AXH
     C                   MOVE      'N'           WCHART
     C                   EXSR      SRÅ
      * Slutt segment
     C                   MOVE      *BLANKS       ADS
     C                   MOVEL     WAPSTR        ADS
     C                   Z-ADD     1             AXV
     C                   Z-ADD     1             AXH
     C                   MOVE      'N'           WCHART
     C                   EXSR      SRÅ
      *___________________________________
      * Lag streng for katalognavn/filnavn
      *"""""""""""""""""""""""""""""""""""
     C                   MOVE      *BLANKS       WFILNAM         256
     C                   EVAL      WfilNam = '/' + %trimr(UELIBF)
     C                             + '/EDISE/'
     C                             + WREGSENR
     C                             + '_'
     C                             + WDT
     C                             + '_'
     C                             + SEMBR2
     C                             + '.tri'
      *_____________________________
      * Lag fil og set codepage (pc)
      *"""""""""""""""""""""""""""""
     C                   EVAL      Codepage = '819'
     C                   EVAL      FILE_o = open( %TrimR( WfilNam )
     C                             : 'w, codepage=' + Codepage )

     C                   EVAL      rc = close( FILE_o )
      *________________________________________
      * Åpne fil, med tegnkonvertering for jobb
      *""""""""""""""""""""""""""""""""""""""""
     C                   EVAL      FILE_o = open( %TrimR( WfilNam )
     C                             : 'w' )

     C                   IF        FILE_o <> *Null
     C                   EVAL      Data = %trimr(BDS)
     C                   EVAL      rc = fputs(Data : File_o)
     C                   EVAL      rc = close( FILE_o )
     C                   ENDIF
      *________________________
      * Aktivisera ftp-sændning
      *""""""""""""""""""""""""
     C                   CALL      'QSNDDTAQ'
     C                   PARM      'DKDTAQ    '  QTNAME           10
     C                   PARM      '*LIBL     '  QTLIB            10
     C                   PARM      1             QTLEN             5 0
     C                   PARM      'X'           QTFIEL            1

     C                   ENDSR
      *
      *////////////////////////////////////////////////////////////
      * SR for output string, read input from left              SRÅ
      *////////////////////////////////////////////////////////////
     C     SRÅ           BEGSR
      *_________________
      * Trim left blanks
      *"""""""""""""""""
     C                   MOVEL(P)  ADS           ADS2          30000
     C                   EVAL      ADS=*BLANKS
     C                   EVAL      ADS=%TRIML(ADS2)
      *_______________
      * Find positions
      *""""""""""""""""
     C                   EVAL      AXV=1
     C     ' '           CHECKR    ADS           AXH
      *________________________________________________
      * Read input string and place it in output string
      *""""""""""""""""""""""""""""""""""""""""""""""""
     C     AXV           DO        AXH           AXV
     C                   MOVE      A(AXV)        WCHAR
      * If invalid character (' + : ?) then replace with 'Ø'
     C     WCHART        IFEQ      'Y'
     C     WDIR          ANDEQ     'R'
     C     WCHAR         IFEQ      ';'
     C                   EVAL      WCHAR=':'
     C                   ENDIF
     C     WCHAR         COMP      WAPSTR                                 83
     C  N83WCHAR         COMP      '+'                                    83
     C  N83WCHAR         COMP      ':'                                    83
     C  N83WCHAR         COMP      '?'                                    83
     C   83              EXSR      SRÅA
     C                   ENDIF
      * Move to output string
     C                   MOVE      WCHAR         B(BX)
     C                   ADD       1             BX

     C                   ENDDO

     C                   EVAL      WCHART='Y'
     C                   EVAL      ADS=*BLANKS

     C                   ENDSR
      *////////////////////////////////////////////////////////////
      * SR for replace control characters                      SRÅA
      *////////////////////////////////////////////////////////////
     C     SRÅA          BEGSR
      * Move '?' before the character
     C                   MOVE      '?'           B(BX)
     C                   ADD       1             BX
     C                   ENDSR
      *////////////////////////////////////////////////////////////
      * OPPDATER EDIM                                      SREDIM /
      *////////////////////////////////////////////////////////////
     C     SREDIM        BEGSR
      *
     C                   EVAL      M0004 = UA0004
     C                   EVAL      M0010 = UM0010
     C                   EVAL      M0035 = U0035
     C                   EVAL      M0062 = UAVD + UTDN + USG
     C                   EVAL      M0065 = 'CONTRL'
     C                   EVAL      M0068 = UAVD + UTDN + USG
     C                   EVAL      M1001 = 'DTE'
     C                   EVAL      M1004 = U0022
     C                   EVAL      M1225 = U1225
     C                   EVAL      MSN   = CSN
     C                   EVAL      MMN   = CMN
     C                   EVAL      MSR   = 'S'
     C                   EVAL      MST   = 'C'
     C                   MOVE      WDT           MDT
     C                   MOVE      WTM           MTM
     C                   EVAL      M1N07 = 'C02'
     C                   MOVE      UAVD          MAVD
     C                   MOVE      UTDN          MTDN
     C                   WRITE     EDIMR
      *
     C                   ENDSR
      *
      *////////////////////////////////////////////////////////////
      * OPPDATER EDIS                                      SREDIS /
      *////////////////////////////////////////////////////////////
     C     SREDIS        BEGSR
      *
     C                   EVAL      S0004 = UA0004
     C                   EVAL      S0010 = UM0010
     C                   EVAL      S0020 = U0020
     C                   EVAL      S0026 = 'CONTRLTI-KV'
     C                   EVAL      S0035 = U0035
     C                   EVAL      S0036 = 1
     C                   EVAL      SSN   = CSN
     C                   EVAL      SSR   = 'S'
     C                   EVAL      SST   = 'A'
     C                   MOVE      SDT           MDT
     C                   MOVE      STM           MTM
     C                   EVAL      SLIB  = '*LIBL'
     C                   EVAL      SFILE = '*IFS'
     C                   EVAL      SMBR  = SEMBR
     C                   EVAL      SIFS = WfilNam
     C                   WRITE     EDISR
      *
     C                   ENDSR
      *
