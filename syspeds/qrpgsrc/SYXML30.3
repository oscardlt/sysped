      *
      ***********************************************************
      *** PROGRAM SKAL SENDE XML-FAKTURA EHF                  ***
      *** INDIKATORER 01 - 26 KUN CMD-TASTER / ROLL TASTER    ***
      *** LEDIGE INDIKATORER 01-26                            ***
      *** LEDIGE INDIKATORER 27-32 34-49 51-99                ***
      ***********************************************************
     FFIRM      IF   E           K DISK
     FXMLUFL1   UF   E           K DISK
     FECMSG     IF   E           K DISK
     FKODWL01   IF   E           K DISK    USROPN
     FKODTA     IF   E           K DISK    USROPN
     FKODTGE    IF   E           K DISK    USROPN
     FKODTG2    IF   E           K DISK    USROPN
     FKODTFR    IF   E           K DISK    USROPN
     FKODTOTY   IF   E           K DISK    USROPN
     FKODTSF    IF   E           K DISK    USROPN
     FCUNDL01   IF   E           K DISK    USROPN
     FFAIN      IF   E           K DISK    USROPN
     FHEADF     IF   E           K DISK    USROPN
     FFAK8      IF   E           K DISK    USROPN
     FFAKTXT    IF   E           K DISK    USROPN
     FFRISOK    IF   E           K DISK    USROPN
     FKODFRI    IF   E           K DISK    USROPN
     FFREETXT2  IF   E           K DISK
     FFIRMARC   IF   E           K DISK
     FARKIVL02  IF   E           K DISK
     FARKTXT    IF   E           K DISK
     FARKEXT    IF   E           K DISK
     FARKVEDK   IF   E           K DISK
     FEDIC      UF A E             DISK    USROPN
     FEDIS      UF A E             DISK    USROPN
     FEDIM      O  A E             DISK    USROPN
     FEDISE1K   O  A E             DISK    USROPN
     D TXT             S             80    DIM(9) CTDATA PERRCD(1)
     D VEDL            S             70    DIM(900)
     D XSNV            S              7  0 DIM(100)
     D                 DS
     D  XTXT05                 1      5
     D  XT05                   1      5    DIM(5)
     D                 DS
     D  XTXT40                 1     40
     D  XT40                   1     40    DIM(40)
     D                 DS
     D  XTXT801                1     80
     D  XT801                  1     80    DIM(80)
     D                 DS
     D  XTXT802                1     80
     D  XT802                  1     80    DIM(80)
     D                 DS
     D  ØN152                  1     15  2
     D  ØA152H                 1     13
     D  ØA152X                 5     13
     D  ØA152D                14     15
     D                 DS
     D  ØA12                   1     12
     D  Ø12                    1     12
     D                                     DIM(12)                              Num edit
     D                 DS
     D  XMBR                   1     10
     D  XMBRA                  1      1
     D  XMBRB                  2     10S 0
     D                 DS
     D  WDT                    1      8
     D  WDTÅ                   1      4
     D  WDTM                   5      6
     D  WDTD                   7      8
     D                 DS
     D  WTM                    1      6
     D  WTMH                   1      2
     D  WTMM                   3      4
     D  WTMS                   5      6
     D                 DS
     D  HEAVD                  1      4  0
     D  XXSTREKK1              5      5
     D  HEOPD                  6     12  0
     D  XXSTREKK2             13     13
     D  HESG                  14     16
     D  SYSPEDREF              1     16
     D                 DS
     D  HEDTOP                 1      8  0
     D  HEDTOPÅ                1      4
     D  HEDTOPM                5      6
     D  HEDTOPD                7      8
     D                 DS
     D  FADATO                 1      8  0
     D  FADATOÅ                1      4
     D  FADATOM                5      6
     D  FADATOD                7      8
     D                 DS
     D  FADAFF                 1      8  0
     D  FADAFFÅ                1      4
     D  FADAFFM                5      6
     D  FADAFFD                7      8
     D                 DS
     D  FAVT                   1     20
     D  FAVT01                 1      1
     D  FAVT02                 2     20
     D                 DS
     D  SYKT8                  1      8
     D  SYFR02                 1      1
     D  SYKT7                  2      7
     D  SYKONT                 2      8  0
     D                 DS
     D  XMLT1                  1     44  2 DIM(11)
     D  XFMS01                 1      4  2
     D  XFMS02                 5      8  2
     D  XFMS03                 9     12  2
     D  XFMS04                13     16  2
     D  XFMS05                17     20  2
     D  XFMS06                21     24  2
     D  XFMS07                25     28  2
     D  XFMS08                29     32  2
     D  XFMS09                33     36  2
     D  XFMS10                37     40  2
     D  XFMS11                41     44  2
     D                 DS
     D  XMLT2                  1     33    DIM(11)
     D  XFMV01                 1      3
     D  XFMV02                 4      6
     D  XFMV03                 7      9
     D  XFMV04                10     12
     D  XFMV05                13     15
     D  XFMV06                16     18
     D  XFMV07                19     21
     D  XFMV08                22     24
     D  XFMV09                25     27
     D  XFMV10                28     30
     D  XFMV11                31     33
     D                 DS
     D  XMLT3                  1    143  2 DIM(11)
     D  XFMGN1                 1     13  2
     D  XFMGN2                14     26  2
     D  XFMGN3                27     39  2
     D  XFMGN4                40     52  2
     D  XFMGN5                53     65  2
     D  XFMGN6                66     78  2
     D  XFMGN7                79     91  2
     D  XFMGN8                92    104  2
     D  XFMGN9               105    117  2
     D  XFMGNA               118    130  2
     D  XFMGNB               131    143  2
     D                 DS
     D  XMLT4                  1    143  2 DIM(11)
     D  XFMGV1                 1     13  2
     D  XFMGV2                14     26  2
     D  XFMGV3                27     39  2
     D  XFMGV4                40     52  2
     D  XFMGV5                53     65  2
     D  XFMGV6                66     78  2
     D  XFMGV7                79     91  2
     D  XFMGV8                92    104  2
     D  XFMGV9               105    117  2
     D  XFMGVA               118    130  2
     D  XFMGVB               131    143  2
     D                 DS
     D  FSDOKK                 1     10
     D  DFS                    1     10    DIM(10)
     D                 DS
     D  SYRG                   1     14
     D  SYRG9                  1      9
     D                 DS
     D  AVKVED                 1     60
     D  AVK                    1     60    DIM(30)
     D                 DS
     D  TRSDFD                 1      8  0
     D  TRSDFDAA               1      4
     D  TRSDFDMM               5      6
     D  TRSDFDDD               7      8
     D                 DS
     D  TRSDTD                 1      8  0
     D  TRSDTDAA               1      4
     D  TRSDTDMM               5      6
     D  TRSDTDDD               7      8
      *
     C                   EXSR      INIT
      *
      * Teller antall fakturaer
     C     START         TAG
     C                   MOVE      *ZEROS        S0036
     C     XMLUFL1K      SETLL     XMLUFL1
     C     XMLUFL1K      READE     XMLUFL1                                50
     C   50              GOTO      SLUTT
     C                   MOVE      XFKN          XXKN              8 0
     C                   MOVE      ' '           XSINGEL           1
     C                   MOVE      'N'           XOK               1
     C                   DOW       *IN50 = *OFF
     C                   IF        XFKN = XXKN
     C     ECMSGK        CHAIN     ECMSG                              33
     C                   IF        *IN33 = *OFF
     C                   MOVE      'J'           XOK
      *
     C                   SELECT
     C                   WHEN      XSINGEL = ' '
     C                   IF        XFSAML = 'J'
     C                   MOVE      'N'           XSINGEL
     C                   ELSE
     C                   MOVE      'J'           XSINGEL
     C                   END
     C                   WHEN      XSINGEL = 'J'
     C     XFSAML        CABEQ     'J'           XNESTE
     C                   OTHER
     C     XFSAML        CABEQ     'N'           XNESTE
     C                   ENDSL
      *
     C                   ADD       1             S0036
     C                   MOVE      'A'           XFST
     C                   ELSE
     C                   MOVE      'V'           XFST
     C                   END
     C                   END
     C     XNESTE        TAG
     C                   UPDATE    XMLUFFR
      *
     C                   IF        XSINGEL = 'N'
     C                   LEAVE
     C                   END
      *
     C     XMLUFL1K      READE     XMLUFL1                                50
     C                   ENDDO
     C     XOK           CABNE     'J'           START
      *
      * TEST OM DET FINNES SENDING.
      * ÅRSAK KAN VÆRE KUNDE IKKE ER DEFINERT I ECMSG.
     C                   MOVE      'A'           XXST
     C     XMLUFL1K      CHAIN     XMLUFL1                            50
     C   50              GOTO      SLUTT
      *
     C                   EXSR      SRSNDST
      *
     C                   MOVE      'A'           XXST
     C     XMLUFL1K      SETLL     XMLUFL1
     C     START1        TAG
     C     XMLUFL1K      READE     XMLUFL1                                50
     C                   IF        *IN50
     C                   EXSR      SRSNDSL
     C                   EXSR      SRCLOSE
     C                   MOVE      ' '           XXST
     C                   GOTO      START
     C                   END
      *
     C                   EXSR      SRINVOICE
      * Oppdate EDIM
     C                   IF        XFSAML = 'N'
     C                   EXSR      OPDEDIM
     C                   END
      * Oppdater XMLUFF
     C                   MOVE      'C'           XFST
     C                   MOVE      WDT           XFDTS
     C                   MOVE      WTM           XFTDS
     C                   UPDATE    XMLUFFR
      *
     C                   GOTO      START1
      *
     C     SLUTT         TAG
     C                   MOVE      *ON           *INLR
     C                   RETURN
      *
      ***********************************************
     C     SRSNDST       BEGSR
      ***********************************************
     C                   OPEN      KODWL01
     C                   OPEN      KODTA
     C                   OPEN      KODTGE
     C                   OPEN      KODTG2
     C                   OPEN      KODTFR
     C                   OPEN      KODTOTY
     C                   OPEN      KODTSF
     C                   OPEN      CUNDL01
     C                   OPEN      FAIN
     C                   OPEN      HEADF
     C                   OPEN      FAK8
     C                   OPEN      FAKTXT
     C                   OPEN      FRISOK
     C                   OPEN      KODFRI
     C                   OPEN      EDIC
     C                   OPEN      EDIS
     C                   OPEN      EDIM
     C                   OPEN      EDISE1K
     C                   MOVE      *ZEROS        XSNV
     C                   MOVE      *ZEROS        XSNVN             3 0
      *
     C     ECMSGK        CHAIN     ECMSG                              33
     C     1             CHAIN     EDIC                               33
     C                   ADD       1             CSN
     C                   UPDATE    EDICR
      *
     C                   MOVE      *BLANKS       XMBR
     C                   MOVE      'F'           XMBRA
     C                   MOVE      CSN           XMBRB
     C                   MOVE      XMBR          SEMBR
     C                   MOVE      *BLANKS       SDATA
     C                   CALL      'SYGE15C'
     C                   PARM                    WDT
     C                   PARM                    WTM
      *
     C                   EVAL      S0004 = ECIIDI
     C                   EVAL      S0010 = ECIIDC
     C                   EVAL      S0020 = SEMBR
     C                   EVAL      SSN   = CSN
     C                   EVAL      SSR   = 'S'
     C                   EVAL      SST   = 'X'
     C                   MOVE      WDT           SDT
     C                   MOVE      WTM           STM
     C                   EVAL      SLIB  = '*LIBL'
     C                   EVAL      SFILE = 'EDISE1K'
     C                   EVAL      SMBR  = SEMBR
     C                   EVAL      SMBRS  = 0
     C                   EVAL      SIFS   = '.xml'
     C                   WRITE     EDISR
      *
     C                   EVAL      XSSN = SSN
     C                   MOVE      *ZEROS        XANTMSG           5 0
      *
     C                   EVAL      SDATA = TXT(001)
     C                   EXSR      TILFIL
     C                   EVAL      SDATA = TXT(002)
     C                   EXSR      TILFIL
      *
     C                   ENDSR
      *
      ***********************************************
     C     SRINVOICE     BEGSR
      ***********************************************
     C                   MOVE      XXKN          KUNDNR
     C     XFFN          CHAIN     FAIN                               33
     C     CUNDL01K      CHAIN     CUNDL01                            33
     C     HEADFK        CHAIN     HEADF                              33
     C     FAK8K         SETLL     FAK8
     C     FAK8K         READE     FAK8                                   33
      *
      * <Invoice
     C                   EVAL      SDATA = %TRIM(TXT(003)) + %TRIM(TXT(004))
     C                             + %TRIM(TXT(005)) + %TRIM(TXT(006))
     C                             + %TRIM(TXT(007)) + %TRIM(TXT(008))
     C                   EXSR      TILFIL
      * <cbc:UBLVersionID>
     C*                  EVAL      SDATA = '<cbc:UBLVersionID>' + '2.1'
     C                   EVAL      SDATA = '<cbc:UBLVersionID>' + '2.0'
     C                             + '</cbc:UBLVersionID>'
     C                   EXSR      TILFIL
      * <cbc:CustomizationID>
     C                   EVAL      SDATA = '<cbc:CustomizationID>'
     C                             + 'urn:www.cenbii.eu:transaction:'
     C                             + 'biitrns010:ver1.0:extended:tionId'
     C                             + 'urn:www.peppol.eu:bis:peppol4a:'
     C                             + 'ver1.0:extended:'
     C                             + 'urn:www.difi.no:ehf:faktura:ver1'
     C                             + '</cbc:CustomizationID>'
     C*                            + 'biitrns010:ver2.0:extended:tionId'
     C*                            + 'urn:www.peppol.eu:bis:peppol5a:'
     C*                            + 'ver2.0:extended:'
     C*                            + 'urn:www.difi.no:ehf:faktura:ver2.0'
     C                   EXSR      TILFIL
      * <cbc:ProfileID>
     C                   EVAL      SDATA = '<cbc:ProfileID>'
     C                             + 'urn:www.cenbii.eu:profile:bii05:ver1.0'
     C                             + '</cbc:ProfileID>'
     C*                            + 'urn:www.cenbii.eu:profile:bii05:ver2.0'
     C                   EXSR      TILFIL
      * <cbc:ID>
     C                   MOVEL     XFFN          XAN07             7
     C                   EVAL      SDATA = '<cbc:ID>'
     C                             + %TRIM(XAN07) + '</cbc:ID>'
     C                   EXSR      TILFIL
      * <cbc:IssueDate>
     C                   EVAL      SDATA = '<cbc:IssueDate>'
     C                             + %TRIM(FADATOÅ) + '-'
     C                             + %TRIM(FADATOM) + '-'
     C                             + %TRIM(FADATOD) + '</cbc:IssueDate>'
     C                   EXSR      TILFIL
      * <cbc:DocumentCurrencyCode>
     C                   EVAL      SDATA = '<cbc:DocumentCurrencyCode>'
     C                             + %TRIM(XFVAL)+'</cbc:DocumentCurrencyCode>'
     C                   EXSR      TILFIL
      *
      * Kreditnote: Send orginal fakturanr.
     C                   IF        XFFK = 'K'
      * <cac:BillingReference> start
     C                   EVAL      SDATA = '<cac:BillingReference>'
     C                   EXSR      TILFIL
      * <cac:InvoiceDocumentReference> start
     C                   EVAL      SDATA = '<cac:InvoiceDocumentReference>'
     C                   EXSR      TILFIL
      * <cbc:ID>
     C                   SELECT
     C                   WHEN      FASK = 'K' AND XFFN <> HEFNGK
     C                   MOVEL     HEFNGK        XAN07             7
     C                   EVAL      SDATA = '<cbc:ID>'
     C                             + %TRIM(XAN07) + '</cbc:ID>'
     C                   WHEN      FASK = 'S' AND XFFN <> HEFNGS
     C                   MOVEL     HEFNGK        XAN07             7
     C                   EVAL      SDATA = '<cac:ID>'
     C                             + %TRIM(XAN07) + '</cbc:ID>'
     C                   OTHER
     C*                  EVAL      SDATA = '<cbc:ID>See orderref.</cbc:ID>'
     C                   EVAL      SDATA = '<cbc:ID>'
     C                             + %TRIM(SYSPEDREF) + '</cbc:ID>'
     C                   ENDSL
     C                   EXSR      TILFIL
      * </cac:InvoiceDocumentReference> start
     C                   EVAL      SDATA = '</cac:InvoiceDocumentReference>'
     C                   EXSR      TILFIL
      * </cac:BillingReference> slutt
     C                   EVAL      SDATA = '</cac:BillingReference>'
     C                   EXSR      TILFIL
      *
     C                   END
      *
     C                   IF        XFFK = 'F'
      * <cac:OrderReference> start
     C                   EVAL      SDATA = '<cac:OrderReference>'
     C                   EXSR      TILFIL
      * <cbc:ID>
     C                   EVAL      SDATA = '<cbc:ID>'
     C                             + %TRIM(SYSPEDREF) + '</cbc:ID>'
     C                   EXSR      TILFIL
      * </cac:OrderReference> slutt
     C                   EVAL      SDATA = '</cac:OrderReference>'
     C                   EXSR      TILFIL
     C                   END
      * Andre ref.
     C     HEADFK        SETLL     FRISOK
     C     HEADFK        READE     FRISOK                                 33
     C                   DOW       *IN33 = *OFF                                 1<-B
     C                   IF        FSSOK <> *BLANKS                              2<-b
     C                   SORTA     DFS
     C     DFS(10)       IFNE      ' '                                            3<-B
     C                   MOVE      '0'           *IN34
     C     FASK          LOOKUP    DFS                                    34
     C  N34'B'           LOOKUP    DFS                                    33
     C                   IF        *IN34                                           4<-B
      * <cac:AdditionalDocumentReference> start
     C                   EVAL      SDATA = '<cac:AdditionalDocumentReference>'
     C                   EXSR      TILFIL
      * <cbc:ID>
     C                   EVAL      SDATA = '<cbc:ID>'
     C                             + %TRIM(FSSOK) + '</cbc:ID>'
     C                   EXSR      TILFIL
      * <cbc:DocumentType>
     C                   EVAL      SDATA = '<cbc:DocumentType>'
     C                             + %TRIM(FSKODE) + '</cbc:DocumentType>'
     C                   EXSR      TILFIL
      * </cac:AdditionalDocumentReference> slutt
     C                   EVAL      SDATA = '</cac:AdditionalDocumentReference>'
     C                   EXSR      TILFIL
      *
     C                   END                                                       4<-E
     C                   END                                                      3<-E
     C                   END                                                     2<-E
     C     HEADFK        READE     FRISOK                                 33
     C  N33              ENDDO                                                  1<-E
      *
     C                   EXSR      SRATTACH
     C                   EXSR      SRPARTY
     C                   EXSR      SRPAYMENT
     C                   EXSR      SRTOTAL
      *
     C                   EXSR      SRINVLINE
      *
      * </Invoice> slutt
     C                   EVAL      SDATA = %TRIM(TXT(009))
     C                   EXSR      TILFIL
      *
     C                   ENDSR
      *
      ***********************************************
     C     SRATTACH      BEGSR
      ***********************************************
      *
     C     ARKVEDKK      CHAIN     ARKVEDK                            33
     C   33              MOVE      *BLANKS       AVKVED
     C                   IF        XFSAML = 'J'                                 1<-B
     C                   MOVE      'fs'          ARTYPE
     C                   MOVE      'fs'          AVTYPE
     C                   ELSE                                                   1
     C                   MOVE      'fa'          ARTYPE
     C                   MOVE      'fa'          AVTYPE
     C                   END                                                    1<-E
     C                   MOVEL     FIFN          ARUNDE
     C     ARKIVL02K     CHAIN     ARKIVL02                           33
     C                   IF        *IN33 = *OFF                                 1<-B
     C     TAGATTACH     TAG
     C                   IF        ((ARTYPE = AVTYPE) OR (ARTYPE = 'fx'))        2<-B
     C                   MOVEL     ARUNDE        XFN               7 0
     C     XFN           CABNE     FIFN          NESTEVEDL
     C                   ELSE                                                    2
     C     1             DO        30            XN                3 0            3<-B
     C                   SELECT                                                    4<-B
     C                   WHEN      AVK(XN) = ARTYPE                                4
     C                   LEAVE
     C                   WHEN      AVK(XN) = *BLANKS                               4
     C                   GOTO      NESTEVEDL
     C                   ENDSL                                                     4<-E
     C                   ENDDO                                                    3<-E
     C                   END                                                     2<-E
      *
     C     ARTYPE        CHAIN     ARKTXT                             33
     C                   IF        ARKLAG <> *BLANKS                             2<-B
     C     ARKLAGK       CHAIN     ARKEXT                             33
     C                   ELSE                                                    2
     C     FIFIRM        CHAIN     FIRMARC                            33
     C                   END                                                     2<-E
      *
      * <cac:AdditionalDocumentReference> start
     C                   EVAL      SDATA = '<cac:AdditionalDocumentReference>'
     C                   EXSR      TILFIL
      * <cbc:ID>
     C                   EVAL      SDATA = '<cbc:ID>'
     C                             + %TRIM(ARLINK) + '</cbc:ID>'
     C                   EXSR      TILFIL
      * <cbc:DocumentType>
     C                   EVAL      SDATA = '<cbc:DocumentType>'
     C                             + %TRIM(ARTXT) + '</cbc:DocumentType>'
     C                   EXSR      TILFIL
      * <cac:Attachment> start
     C                   EVAL      SDATA = '<cac:Attachment>'
     C                   EXSR      TILFIL
      * <cac:ExternalReference> start
     C                   EVAL      SDATA = '<cac:ExternalReference>'
     C                   EXSR      TILFIL
      * <cbc:URI>
     C                   EVAL      SDATA = '<cbc:URI>'
     C                             + 'http://' + %TRIM(ARCPAE) + '/'
     C                   IF        ARCANE <> *BLANKS                             2<-B
     C                   EVAL      SDATA = %TRIM(SDATA) + %TRIM(ARCANE) + '/'
     C                   END                                                     2<-E
     C                   EVAL      SDATA = %TRIM(SDATA) + %TRIM(ARLINK)
     C     '.'           SCAN      ARLINK                                 33
     C  N33              EVAL      SDATA = %TRIM(SDATA) + '.pdf'
     C                             + '</cbc:URI>'
     C                   EXSR      TILFIL
      * </cac:ExternalReference> slutt
     C                   EVAL      SDATA = '</cac:ExternalReference>'
     C                   EXSR      TILFIL
      * </cac:Attachment> slutt
     C                   EVAL      SDATA = '</cac:Attachment>'
     C                   EXSR      TILFIL
      * </cac:AdditionalDocumentReference> slutt
     C                   EVAL      SDATA = '</cac:AdditionalDocumentReference>'
     C                   EXSR      TILFIL
      *
      * Send vedlegg som binært objekt
     C                   IF        *IN33 AND *IN33 = *OFF
      * <cac:AdditionalDocumentReference> start
     C                   EVAL      SDATA = '<cac:AdditionalDocumentReference>'
     C                   EXSR      TILFIL
      * <cbc:ID>
     C                   EVAL      SDATA = '<cbc:ID>'
     C                             + %TRIM(ARLINK) + '</cbc:ID>'
     C                   EXSR      TILFIL
      * <cbc:DocumentType>
     C                   EVAL      SDATA = '<cbc:DocumentType>'
     C                             + %TRIM(ARTXT) + '</cbc:DocumentType>'
     C                   EXSR      TILFIL
      * <cac:Attachment> start
     C                   EVAL      SDATA = '<cac:Attachment>'
     C                   EXSR      TILFIL
      * <cbc:EmbeddedDocumentBinaryObject
     C                   CALL      'SYXML31'
     C                   PARM                    SEMBR
     C                   PARM                    ARCANE
     C                   PARM                    ARLINK
     C*                  EVAL      SDATA = '<cbc:EmbeddedDocumentBinaryObject '
     C*                            + 'mimeCode="application/pdf">'
     C*                            + %TRIM(ARLINK)
     C*    '.'           SCAN      ARLINK                                 33
     C* N33              EVAL      SDATA = %TRIM(SDATA) + '.pdf'
     C*                            + '</cbc:EmbeddedDocumentBinaryObject>'
     C*                  EXSR      TILFIL
      * </cac:Attachment> slutt
     C                   EVAL      SDATA = '</cac:Attachment>'
     C                   EXSR      TILFIL
      * </cac:AdditionalDocumentReference> slutt
     C                   EVAL      SDATA = '</cac:AdditionalDocumentReference>'
     C                   EXSR      TILFIL
     C                   END
      *
     C     NESTEVEDL     TAG
     C     ARKIVL02K     READE     ARKIVL02                               33
     C  N33              GOTO      TAGATTACH
     C                   END                                                    1<-E
      *
     C                   ENDSR
      *
      ***********************************************
     C     SRPARTY       BEGSR
      ***********************************************
      * Avsender
     C     KODTAK        CHAIN     KODTA                              33
     C                   MOVE      KOAKNR        KUNDNR
     C     CUNDL01K      CHAIN     CUNDL01                            33
      *
      * <cac:AccountingSupplierParty> start
     C                   EVAL      SDATA = '<cac:AccountingSupplierParty>'
     C                   EXSR      TILFIL
      * <cac:Party> start
     C                   EVAL      SDATA = '<cac:Party>'
     C                   EXSR      TILFIL
      * <cbc:EndpointID>
     C                   EVAL      SDATA = '<cbc:EndpointID>'
     C                             + '9908:' + %TRIM(SYRG)
     C                             + '</cbc:EndpointID>'
     C*                  EVAL      SDATA = '<cbc:EndpointID schemeID="NO:ORGNR">'
     C*                            + %TRIM(SYRG)
     C                   EXSR      TILFIL
      * <cac:PartyName> start
     C                   EVAL      SDATA = '<cac:PartyName>'
     C                   EXSR      TILFIL
      * <cbc:Name>
     C                   EVAL      XTXT801 = KNAVN
     C                   Z-ADD     30            XN53              3 0
     C                   EXSR      KNVST
     C                   EVAL      SDATA = '<cbc:Name>'
     C                             + %TRIM(XTXT802) + '</cbc:Name>'
     C                   EXSR      TILFIL
      * </cac:PartyName> slutt
     C                   EVAL      SDATA = '</cac:PartyName>'
     C                   EXSR      TILFIL
      * <cac:PostalAddress> start
     C                   EVAL      SDATA = '<cac:PostalAddress>'
     C                   EXSR      TILFIL
      * <cbc:Postbox>
     C                   EVAL      XTXT801 = %TRIM(ADR2)
     C                   Z-ADD     30            XN53              3 0
     C                   EXSR      KNVST
     C                   EVAL      SDATA = '<cbc:Postbox>'
     C                             + %TRIM(XTXT802) + '</cbc:Postbox>'
     C                   EXSR      TILFIL
      * <cbc:StreetName>
     C                   EVAL      XTXT801 = %TRIM(ADR1)
     C                   Z-ADD     30            XN53              3 0
     C                   EXSR      KNVST
     C                   EVAL      SDATA = '<cbc:StreetName>'
     C                             + %TRIM(XTXT802) + '</cbc:StreetName>'
     C                   EXSR      TILFIL
      * <cbc:CityName>
     C                   EVAL      XTXT801 = %TRIM(ADR3)
     C                   Z-ADD     61            XN53              3 0
     C                   EXSR      KNVST
     C                   EVAL      SDATA = '<cbc:CityName>'
     C                             + %TRIM(XTXT802) + '</cbc:CityName>'
     C                   EXSR      TILFIL
      * <cbc:PostalZone>
     C                   IF        POSTNR = 0
     C                   EVAL      XTXT801 = SYPOGE
     C                   ELSE
     C                   EVAL      XTXT801 = *BLANKS
     C                   MOVEL     POSTNR        XTXT801
     C                   END
     C                   Z-ADD     10            XN53              3 0
     C                   EXSR      KNVST
     C                   EVAL      SDATA = '<cbc:PostalZone>'
     C                             + %TRIM(XTXT802) + '</cbc:PostalZone>'
     C                   EXSR      TILFIL
      * <cac:Country> start
     C                   EVAL      SDATA = '<cac:Country>'
     C                   EXSR      TILFIL
      * <cbc:IdentificationCode>
     C                   IF        SYLAND = *BLANKS
     C                   EVAL      SYLAND = FILAND
     C                   END
     C                   EVAL      SDATA = '<cbc:IdentificationCode>'
     C                             + SYLAND + '</cbc:IdentificationCode>'
     C                   EXSR      TILFIL
      * </cac:Country> slutt
     C                   EVAL      SDATA = '</cac:Country>'
     C                   EXSR      TILFIL
      * </cac:PostalAddress> slutt
     C                   EVAL      SDATA = '</cac:PostalAddress>'
     C                   EXSR      TILFIL
      * <cac:PartyTaxScheme> start
     C                   EVAL      SDATA = '<cac:PartyTaxScheme>'
     C                   EXSR      TILFIL
      * <cbc:CompanyID>
     C                   EVAL      SDATA = '<cbc:CompanyID>'
     C                             + 'NO' + %TRIM(SYRG) + 'MVA'
     C                             + '</cbc:CompanyID>'
     C*                  EVAL      SDATA = '<cbc:CompanyID schemeID="NO:VAT" '
     C*                            + 'schemAgencyID="82">' + %TRIM(SYRG) + 'MVA'
     C                   EXSR      TILFIL
      * <cac:TaxScheme> start
     C                   EVAL      SDATA = '<cac:TaxScheme>'
     C                   EXSR      TILFIL
      * <cbc:ID
      *
     C                   EVAL      SDATA = '<cbc:ID schemeID="UN/ECE 5153" '
     C                             + 'schemeAgencyID="6">VAT</cbc:ID>'
     C                   EXSR      TILFIL
      * </cac:TaxScheme> slutt
     C                   EVAL      SDATA = '</cac:TaxScheme>'
     C                   EXSR      TILFIL
      * </cac:PartyTaxScheme> start
     C                   EVAL      SDATA = '</cac:PartyTaxScheme>'
     C                   EXSR      TILFIL
      * <cac:PartyLegalEntity> start
     C                   EVAL      SDATA = '<cac:PartyLegalEntity>'
     C                   EXSR      TILFIL
      * <cbc:RegistrationName>
     C                   EVAL      XTXT801 = KNAVN
     C                   Z-ADD     30            XN53              3 0
     C                   EXSR      KNVST
     C                   EVAL      SDATA = '<cbc:RegistrationName>'
     C                             + %TRIM(XTXT802) + '</cbc:RegistrationName>'
     C                   EXSR      TILFIL
      * <cbc:CompanyID
     C                   EVAL      SDATA = '<cbc:CompanyID schemeID="NO:ORGNR" '
     C                             + 'schemeName="Foretaksregisteret" '
     C                             + 'schemeAgencyID="82">'
     C                             + %TRIM(SYRG) + '</cbc:CompanyID>'
     C                   EXSR      TILFIL
      * </cac:PartyLegalEntity> slutt
     C                   EVAL      SDATA = '</cac:PartyLegalEntity>'
     C                   EXSR      TILFIL
      * <cac:Contact> start
     C                   EVAL      SDATA = '<cac:Contact>'
     C                   EXSR      TILFIL
      * <cbc:ID>
     C     KODTSFK       CHAIN     KODTSF                             33
     C                   EVAL      XTXT801 = KOSFNV
     C                   Z-ADD     30            XN53              3 0
     C                   EXSR      KNVST
     C                   EVAL      SDATA = '<cbc:ID>'
     C                             + %TRIM(XTXT802) + '</cbc:ID>'
     C                   EXSR      TILFIL
      * </cac:Contact> slutt
     C                   EVAL      SDATA = '</cac:Contact>'
     C                   EXSR      TILFIL
      * </cac:Party> slutt
     C                   EVAL      SDATA = '</cac:Party>'
     C                   EXSR      TILFIL
      * </cac:AccountingSupplierParty> slutt
     C                   EVAL      SDATA = '</cac:AccountingSupplierParty>'
     C                   EXSR      TILFIL
      *
      * Mottaker
     C                   MOVE      XXKN          KUNDNR
     C     CUNDL01K      CHAIN     CUNDL01                            33
      *
      * <cac:AccountingCustomerParty> start
     C                   EVAL      SDATA = '<cac:AccountingCustomerParty>'
     C                   EXSR      TILFIL
      * <cac:Party> start
     C                   EVAL      SDATA = '<cac:Party>'
     C                   EXSR      TILFIL
      * <cbc:EndpointID>
     C                   EVAL      SDATA = '<cbc:EndpointID>'
     C                             + '9908:' + %TRIM(SYRG)
     C                             + '</cbc:EndpointID>'
     C*                  EVAL      SDATA = '<cbc:EndpointID schemeID="NO:ORGNR">'
     C*                            + %TRIM(SYRG)
     C                   EXSR      TILFIL
      * <cac:PartyIdentification> start
     C                   EVAL      SDATA = '<cac:PartyIdentification>'
     C                   EXSR      TILFIL
      * <cbc:ID>
     C                   EVAL      SDATA = '<cbc:ID>'
     C                             + %TRIM(%EDITC(XFKN:'Z')) + '</cbc:ID>'
     C                   EXSR      TILFIL
      * </cac:PartyIdentification> slutt
     C                   EVAL      SDATA = '</cac:PartyIdentification>'
     C                   EXSR      TILFIL
      * <cac:PartyName> start
     C                   EVAL      SDATA = '<cac:PartyName>'
     C                   EXSR      TILFIL
      * <cbc:Name>
     C                   EVAL      XTXT801 = KNAVN
     C                   Z-ADD     30            XN53              3 0
     C                   EXSR      KNVST
     C                   EVAL      SDATA = '<cbc:Name>'
     C                             + %TRIM(XTXT802) + '</cbc:Name>'
     C                   EXSR      TILFIL
      * </cac:PartyName> slutt
     C                   EVAL      SDATA = '</cac:PartyName>'
     C                   EXSR      TILFIL
      * <cac:PostalAddress> start
     C                   EVAL      SDATA = '<cac:PostalAddress>'
     C                   EXSR      TILFIL
      * <cbc:Postbox>
     C                   EVAL      XTXT801 = %TRIM(ADR2)
     C                   Z-ADD     30            XN53              3 0
     C                   EXSR      KNVST
     C                   EVAL      SDATA = '<cbc:Postbox>'
     C                             + %TRIM(XTXT802) + '</cbc:Postbox>'
     C                   EXSR      TILFIL
      * <cbc:StreetName>
     C                   EVAL      XTXT801 = %TRIM(ADR1)
     C                   Z-ADD     30            XN53              3 0
     C                   EXSR      KNVST
     C                   EVAL      SDATA = '<cbc:StreetName>'
     C                             + %TRIM(XTXT802) + '</cbc:StreetName>'
     C                   EXSR      TILFIL
      * <cbc:CityName>
     C                   EVAL      XTXT801 = %TRIM(ADR3)
     C                   Z-ADD     61            XN53              3 0
     C                   EXSR      KNVST
     C                   EVAL      SDATA = '<cbc:CityName>'
     C                             + %TRIM(XTXT802) + '</cbc:CityName>'
     C                   EXSR      TILFIL
      * <cbc:PostalZone>
     C                   IF        POSTNR = 0
     C                   EVAL      XTXT801 = SYPOGE
     C                   ELSE
     C                   EVAL      XTXT801 = *BLANKS
     C                   MOVEL     POSTNR        XTXT801
     C                   END
     C                   Z-ADD     10            XN53              3 0
     C                   EXSR      KNVST
     C                   EVAL      SDATA = '<cbc:PostalZone>'
     C                             + %TRIM(XTXT802) + '</cbc:PostalZone>'
     C                   EXSR      TILFIL
      * <cac:Country> start
     C                   EVAL      SDATA = '<cac:Country>'
     C                   EXSR      TILFIL
      * <cbc:IdentificationCode>
     C                   IF        SYLAND = *BLANKS
     C                   EVAL      SYLAND = FILAND
     C                   END
     C                   EVAL      SDATA = '<cbc:IdentificationCode>'
     C                             + SYLAND + '</cbc:IdentificationCode>'
     C                   EXSR      TILFIL
      * </cac:Country> slutt
     C                   EVAL      SDATA = '</cac:Country>'
     C                   EXSR      TILFIL
      * </cac:PostalAddress> slutt
     C                   EVAL      SDATA = '</cac:PostalAddress>'
     C                   EXSR      TILFIL
      * <cac:PartyLegalEntity> start
     C                   EVAL      SDATA = '<cac:PartyLegalEntity>'
     C                   EXSR      TILFIL
      * <cbc:RegistrationName>
     C                   EVAL      XTXT801 = KNAVN
     C                   Z-ADD     30            XN53              3 0
     C                   EXSR      KNVST
     C                   EVAL      SDATA = '<cbc:RegistrationName>'
     C                             + %TRIM(XTXT802) + '</cbc:RegistrationName>'
     C                   EXSR      TILFIL
      * <cbc:CompanyID
     C                   EVAL      SDATA = '<cbc:CompanyID>'
     C                             + %TRIM(SYRG) + '</cbc:CompanyID>'
     C*                  EVAL      SDATA = '<cbc:CompanyID schemeID="NO:VAT" '
     C*                            + 'schemAgencyID="82">' + %TRIM(SYRG) + 'MVA'
     C                   EXSR      TILFIL
      * </cac:PartyLegalEntity> slutt
     C                   EVAL      SDATA = '</cac:PartyLegalEntity>'
     C                   EXSR      TILFIL
      *
      * <cac:Contact> start
     C                   EVAL      SDATA = '<cac:Contact>'
     C                   EXSR      TILFIL
      * <cbc:ID>
     C                   IF        KPERS = *BLANKS
     C                   EVAL      XTXT801 = '.'
     C                   ELSE
     C                   EVAL      XTXT801 = KPERS
     C                   END
     C                   Z-ADD     30            XN53              3 0
     C                   EXSR      KNVST
     C                   EVAL      SDATA = '<cbc:ID>'
     C                             + %TRIM(XTXT802) + '</cbc:ID>'
     C                   EXSR      TILFIL
      * </cac:Contact> slutt
     C                   EVAL      SDATA = '</cac:Contact>'
     C                   EXSR      TILFIL
      *
      * </cac:Party> slutt
     C                   EVAL      SDATA = '</cac:Party>'
     C                   EXSR      TILFIL
      * </cac:AccountingCustomerParty> slutt
     C                   EVAL      SDATA = '</cac:AccountingCustomerParty>'
     C                   EXSR      TILFIL
      *
      * DeliveryPart
      *
      * <cac:Delivery> start
     C                   EVAL      SDATA = '<cac:Delivery>'
     C                   EXSR      TILFIL
      * <cbc:ActualDeliveryDate>
     C                   EVAL      SDATA = '<cbc:ActualDeliveryDate>'
     C                             + HEDTOPÅ + '-' + HEDTOPM + '-' + HEDTOPD
     C                             + '</cbc:ActualDeliveryDate>'
     C                   EXSR      TILFIL
      * <cac:DeliveryLocation> start
     C                   EVAL      SDATA = '<cac:DeliveryLocation>'
     C                   EXSR      TILFIL
      * <cac:Address> start
     C                   EVAL      SDATA = '<cac:Address>'
     C                   EXSR      TILFIL
      * <cbc:StreetName>
     C                   IF        FASK = 'S'
     C                   EVAL      XTXT801 = HENAS
     C                   ELSE
     C                   EVAL      XTXT801 = HENAK
     C                   END
     C                   Z-ADD     30            XN53              3 0
     C                   EXSR      KNVST
     C                   EVAL      SDATA = '<cbc:StreetName>'
     C                             + %TRIM(XTXT802) + '</cbc:StreetName>'
     C                   EXSR      TILFIL
      * <cbc:BuildingNumber>
     C                   IF        FASK = 'S'
     C                   EVAL      XTXT801 = HEADS1
     C                   ELSE
     C                   EVAL      XTXT801 = HEADK1
     C                   END
     C                   Z-ADD     30            XN53              3 0
     C                   EXSR      KNVST
     C                   EVAL      SDATA = '<cbc:BuildingNumber>'
     C                             + %TRIM(XTXT802) + '</cbc:BuildingNumber>'
     C                   EXSR      TILFIL
      * <cbc:CityName>
     C                   IF        FASK = 'S'
     C                   IF        HEADS3 = *BLANKS
     C                   EVAL      XTXT801 = HEADS2
     C                   ELSE
     C                   EVAL      XTXT801 = HEADS3
     C                   END
     C                   ELSE
     C                   IF        HEADK3 = *BLANKS
     C                   EVAL      XTXT801 = HEADK2
     C                   ELSE
     C                   EVAL      XTXT801 = HEADK3
     C                   END
     C                   END
     C                   Z-ADD     30            XN53              3 0
     C                   EXSR      KNVST
     C                   EVAL      SDATA = '<cbc:CityName>'
     C                             + %TRIM(XTXT802) + '</cbc:CityName>'
     C                   EXSR      TILFIL
      * <cbc:PostalZone>
     C                   IF        FASK = 'S'
     C                   IF        HEADS3 = *BLANKS
     C                   EVAL      XTXT801 = %SUBST(HEADS2:1:5)
     C                   ELSE
     C                   EVAL      XTXT801 = %SUBST(HEADS3:1:5)
     C                   END
     C                   ELSE
     C                   IF        HEADK3 = *BLANKS
     C                   EVAL      XTXT801 = %SUBST(HEADK2:1:5)
     C                   ELSE
     C                   EVAL      XTXT801 = %SUBST(HEADK3:1:5)
     C                   END
     C                   END
     C                   Z-ADD     30            XN53              3 0
     C                   EXSR      KNVST
     C                   EVAL      SDATA = '<cbc:PostalZone>'
     C                             + %TRIM(XTXT802) + '</cbc:PostalZone>'
     C                   EXSR      TILFIL
      * <cac:Country> start
     C                   EVAL      SDATA = '<cac:Country>'
     C                   EXSR      TILFIL
      * <cbc:IdentificationCode>
     C                   EVAL      SDATA = '<cbc:IdentificationCode>'
     C                             + SYLAND + '</cbc:IdentificationCode>'
     C                   EXSR      TILFIL
      * </cac:Country> slutt
     C                   EVAL      SDATA = '</cac:Country>'
     C                   EXSR      TILFIL
      * </cac:Address> slutt
     C                   EVAL      SDATA = '</cac:Address>'
     C                   EXSR      TILFIL
      * </cac:DeliveryLocation> slutt
     C                   EVAL      SDATA = '</cac:DeliveryLocation>'
     C                   EXSR      TILFIL
      * </cac:Delivery> slutt
     C                   EVAL      SDATA = '</cac:Delivery>'
     C                   EXSR      TILFIL
      *
     C                   ENDSR
      *
      ***********************************************
     C     SRPAYMENT     BEGSR
      ***********************************************
      * <cac:PaymentMeans> start
     C                   EVAL      SDATA = '<cac:PaymentMeans>'
     C                   EXSR      TILFIL
      * <cbc:PaymentMeansCode>
     C                   EVAL      SDATA = '<cbc:PaymentMeansCode>'
     C                             + %TRIM(XFBB) + '</cbc:PaymentMeansCode>'
     C                   EXSR      TILFIL
      * <cbc:PaymentDueDate>
     C                   EVAL      SDATA = '<cbc:PaymentDueDate>'
     C                             + FADAFFÅ + '-' + FADAFFM + '-' + FADAFFD
     C                             + '</cbc:PaymentDueDate>'
     C                   EXSR      TILFIL
      * <cbc:PaymentID>
     C                   EVAL      SDATA = '<cbc:PaymentID>'
     C                             + %TRIM(XFKID) + '</cbc:PaymentID>'
     C                   EXSR      TILFIL
      * <cac:PayeeFinancialAccount> start
     C                   EVAL      SDATA = '<cac:PayeeFinancialAccount>'
     C                   EXSR      TILFIL
      * <cbc:ID
     C                   EVAL      SDATA = '<cbc:ID schemeID="BANK">'
     C                             + %TRIM(XFKT) + '</cbc:ID>'
     C                   EXSR      TILFIL
      * </cac:PayeeFinancialAccount> slutt
     C                   EVAL      SDATA = '</cac:PayeeFinancialAccount>'
     C                   EXSR      TILFIL
      * </cac:PaymentMeans> start
     C                   EVAL      SDATA = '</cac:PaymentMeans>'
     C                   EXSR      TILFIL
      *
     C                   ENDSR
      *
      ***********************************************
     C     SRTOTAL       BEGSR
      ***********************************************
      *
     C                   MOVE      *ZEROS        XXMVAT           13 2
     C     1             DO        11            XN01              3 0
     C                   IF        XMLT1(XN01) > 0
     C                   IF        XMLT2(XN01) = *BLANKS
     C                   EVAL      XMLT2(XN01) = FICURR
     C                   END
     C                   IF        XMLT2(XN01) = FICURR
     C                   EVAL(H)   XXMVAT = XXMVAT+XMLT1(XN01)*XMLT3(XN01)/100
     C                   ELSE
     C                   EVAL(H)   XXMVAT = XXMVAT+XMLT1(XN01)*XMLT4(XN01)/100
     C                   END
     C                   END
     C                   ENDDO
     C     XFTOT         SUB       XXMVAT        XX0MVAGR         13 2
      *
      * Total moms
      * <cac:TaxTotal> start
     C                   EVAL      SDATA = '<cac:TaxTotal>'
     C                   EXSR      TILFIL
      * <cbc:TaxAmount
     C                   IF        XXMVAT < 0
     C                   Z-SUB     XXMVAT        XXMVAT
     C                   END
     C                   EVAL      ØN152 = XXMVAT
     C                   MOVE      'J'           XBELØP
     C                   EXSR      SRNE
     C                   EVAL      SDATA = '<cbc:TaxAmount '
     C                             + 'currencyID="' + %TRIM(XFVAL) + '">'
     C                             + %TRIM(ØAN) + '</cbc:TaxAmount>'
     C                   EXSR      TILFIL
      *
      * Del moms
     C     1             DO        11            XN01              3 0
      *
     C                   IF        XMLT1(XN01) > 0
      *
     C                   IF        XMLT2(XN01) = *BLANKS
     C                   EVAL      XMLT2(XN01) = FICURR
     C                   END
     C                   IF        XMLT2(XN01) = FICURR
     C                   EVAL(H)   XXMVAG = XMLT3(XN01)
     C                   EVAL(H)   XXMVA = XMLT1(XN01)*XMLT3(XN01)/100
     C                   ELSE
     C                   EVAL(H)   XXMVAG = XMLT4(XN01)
     C                   EVAL(H)   XXMVA = XMLT1(XN01)*XMLT4(XN01)/100
     C                   END
      * <cac:TaxSubtotal> start
     C                   EVAL      SDATA = '<cac:TaxSubtotal>'
     C                   EXSR      TILFIL
      * Momsgrunnlag
      * <cbc:TaxableAmount
     C                   IF        XXMVAG < 0
     C                   Z-SUB     XXMVAG        XXMVAG
     C                   END
     C                   EVAL      ØN152 = XXMVAG
     C                   MOVE      'J'           XBELØP
     C                   EXSR      SRNE
     C                   EVAL      SDATA = '<cbc:TaxableAmount '
     C                             + 'currencyID="' + %TRIM(XMLT2(XN01)) + '">'
     C                             + %TRIM(ØAN) + '</cbc:TaxableAmount>'
     C                   EXSR      TILFIL
      * Moms
      * <cbc:TaxAmount
     C                   IF        XXMVA < 0
     C                   Z-SUB     XXMVA         XXMVA
     C                   END
     C                   EVAL      ØN152 = XXMVA
     C                   MOVE      'J'           XBELØP
     C                   EXSR      SRNE
     C                   EVAL      SDATA = '<cbc:TaxAmount '
     C                             + 'currencyID="' + %TRIM(XMLT2(XN01)) + '">'
     C                             + %TRIM(ØAN) + '</cbc:TaxAmount>'
     C                   EXSR      TILFIL
      * <cac:TaxCategory> start
     C                   EVAL      SDATA = '<cac:TaxCategory>'
     C                   EXSR      TILFIL
      * <cbc:ID>
     C                   SELECT
     C                   WHEN      XMLT1(XN01) = 0
     C                   EVAL      SDATA = '<cbc:ID>E</cbc:ID>'
     C                   WHEN      XMLT1(XN01) = FITAX * 100
     C                   EVAL      SDATA = '<cbc:ID>S</cbc:ID>'
     C                   WHEN      XMLT1(XN01) = 8
     C                   EVAL      SDATA = '<cbc:ID>AA</cbc:ID>'
     C                   WHEN      XMLT1(XN01) = 15
     C                   EVAL      SDATA = '<cbc:ID>H</cbc:ID>'
     C                   OTHER
     C                   EVAL      SDATA = '<cbc:ID>H</cbc:ID>'
     C                   ENDSL
     C                   EXSR      TILFIL
      * <cbc:Percent>
     C                   EVAL      ØN152 = XMLT1(XN01)
     C                   MOVE      'N'           XBELØP            1
     C                   EXSR      SRNE
     C                   EVAL      SDATA = '<cbc:Percent>'
     C                             + %TRIM(ØAN) + '</cbc:Percent>'
     C                   EXSR      TILFIL
      * <cac:TaxScheme> start
     C                   EVAL      SDATA = '<cac:TaxScheme>'
     C                   EXSR      TILFIL
      * <cbc:ID>
     C                   EVAL      SDATA = '<cbc:ID>VAT</cbc:ID>'
     C                   EXSR      TILFIL
      * </cac:TaxScheme> slutt
     C                   EVAL      SDATA = '</cac:TaxScheme>'
     C                   EXSR      TILFIL
      * </cac:TaxCategory> slutt
     C                   EVAL      SDATA = '</cac:TaxCategory>'
     C                   EXSR      TILFIL
      * </cac:TaxSubtotal> slutt
     C                   EVAL      SDATA = '</cac:TaxSubtotal>'
     C                   EXSR      TILFIL
      *
     C                   END
      *
     C                   ENDDO
      *
      * </cac:TaxTotal> slutt
     C                   EVAL      SDATA = '</cac:TaxTotal>'
     C                   EXSR      TILFIL
      *
      * <cac:LegalMonetaryTotal> start
     C                   EVAL      SDATA = '<cac:LegalMonetaryTotal>'
     C                   EXSR      TILFIL
      *
     C                   MOVE      XFTOT         XFTOT2           13 2
     C                   IF        XFFK = 'F'
     C                   IF        XFTOT2 < 0
     C                   CAT       '-':0         SDATA
     C                   Z-SUB     XFTOT2        XFTOT2
     C                   END
     C                   ELSE
     C                   IF        XFTOT2 > 0
     C                   CAT       '-':0         SDATA
     C                   ELSE
     C                   Z-SUB     XFTOT2        XFTOT2
     C                   END
     C                   END
      * Linjesum
      * <cbc:LineExtensionAmount
     C                   EVAL      ØN152 = XFTOT2 - XXMVAT
     C                   MOVE      'J'           XBELØP
     C                   EXSR      SRNE
     C                   EVAL      SDATA = '<cbc:LineExtensionAmount '
     C                             + 'currencyID="' + %TRIM(XFVAL) + '">'
     C                             + %TRIM(ØAN) + '</cbc:LineExtensionAmount>'
     C                   EXSR      TILFIL
      * Beløp uten moms
      * <cbc:TaxExclusiveAmount
     C                   EVAL      ØN152 = XFTOT2 - XXMVAT
     C                   MOVE      'J'           XBELØP
     C                   EXSR      SRNE
     C                   EVAL      SDATA = '<cbc:TaxExclusiveAmount '
     C                             + 'currencyID="' + %TRIM(XFVAL) + '">'
     C                             + %TRIM(ØAN) + '</cbc:TaxExclusiveAmount>'
     C                   EXSR      TILFIL
      * Beløp med moms
      * <cbc:TaxInclusiveAmount
     C                   EVAL      ØN152 = XFTOT2
     C                   MOVE      'J'           XBELØP
     C                   EXSR      SRNE
     C                   EVAL      SDATA = '<cbc:TaxInclusiveAmount '
     C                             + 'currencyID="' + %TRIM(XFVAL) + '">'
     C                             + %TRIM(ØAN) + '</cbc:TaxInclusiveAmount>'
     C                   EXSR      TILFIL
      * Betalings beløp
      * <cbc:PayableAmount
     C                   EVAL      ØN152 = XFTOT2
     C                   MOVE      'J'           XBELØP
     C                   EXSR      SRNE
     C                   EVAL      SDATA = '<cbc:PayableAmount '
     C                             + 'currencyID="' + %TRIM(XFVAL) + '">'
     C                             + %TRIM(ØAN) + '</cbc:PayableAmount>'
     C                   EXSR      TILFIL
      * <c/ac:LegalMonetaryTotal> slutt
     C                   EVAL      SDATA = '</cac:LegalMonetaryTotal>'
     C                   EXSR      TILFIL
      *
     C                   ENDSR
      *
      ***********************************************
     C     SRINVLINE     BEGSR
      ***********************************************
     C     FAK8K         SETLL     FAK8
     C     FAK8K         READE     FAK8                                   33
     C                   MOVE      *ZEROS        XXLNR             5 0
     C                   DOW       *IN33 = *OFF                                 1<-B
      *
     C                   IF        FAOPKO <> 'D'                                 2<-B
     C                   IF        ((XFVAL = FICURR) OR (XFVAL = *BLANKS))        3<-B
     C                   EVAL      XXBEL = FABELN
     C                   ELSE                                                     3
     C                   EVAL      XXBEL = FABELV
     C                   END                                                      3<-E
      * Fortegn
     C                   MOVE      ' '           XFORTEGN          1
     C                   IF        XFFK = 'F'
     C                   IF        XXBEL < 0
     C                   MOVE      '-'           XFORTEGN
     C                   Z-SUB     XXBEL         XXBEL
     C                   END
     C                   ELSE
     C                   IF        XXBEL > 0
     C                   MOVE      '-'           XFORTEGN
     C                   ELSE
     C                   Z-SUB     XXBEL         XXBEL
     C                   END
     C                   END
      *
      * <cac:InvoiceLine> start
     C                   EVAL      SDATA = '<cac:InvoiceLine>'
     C                   EXSR      TILFIL
      * <cbc:ID>
     C                   ADD       1             XXLNR
     C                   EVAL      SDATA = '<cbc:ID>'
     C                             + %TRIM(%EDITC(XXLNR:'Z'))
     C                             + '</cbc:ID>'
     C                   EXSR      TILFIL
      * <cbc:InvoicedQuantity
     C                   EVAL      SDATA = '<cbc:InvoicedQuantity '
     C                             + 'unitCode="NMP">1'
     C                             + '</cbc:InvoicedQuantity>'
     C                   EXSR      TILFIL
      * <cbc:LineExtensionAmount
     C                   EVAL      SDATA = '<cbc:LineExtensionAmount '
     C                             + 'currencyID="' + XFVAL + '">'
     C                             + %TRIM(%EDITC(XXBEL:'4'))
     C                             + '</cbc:LineExtensionAmount>'
     C                   EXSR      TILFIL
      * <cac:TaxTotal> start
     C                   EVAL      SDATA = '<cac:TaxTotal>'
     C                   EXSR      TILFIL
      * <cbc:TaxAmount
     C                   SELECT                                                   3<-B
     C                   WHEN      FAKDM = 'N'
     C                   EVAL      MVAAVI = 0
     C                   WHEN      FAKDM = 'J'
     C                   EVAL      MVAAVI = FITAX * 100
     C                   OTHER
     C     KODWL01K      CHAIN     KODWL01                            33
     C   33              EVAL      MVAAVI = 0
     C                   ENDSL                                                    3<-E
     C                   EVAL      XXMVA = XXBEL * MVAAVI / 100
     C                   EVAL      ØN152 = XXMVA
     C                   MOVE      'J'           XBELØP
     C                   EXSR      SRNE
     C                   EVAL      SDATA = '<cbc:TaxAmount '
     C                             + 'currencyID="' + XFVAL + '">'
     C*                            + %TRIM(%EDITC(XXMVA:'3'))
     C*                            + '</cbc:TaxAmount>'
     C                             + %TRIM(ØAN) + '</cbc:TaxAmount>'
     C                   EXSR      TILFIL
      * </cac:TaxTotal> slutt
     C                   EVAL      SDATA = '</cac:TaxTotal>'
     C                   EXSR      TILFIL
      * <cac:Item> start
     C                   EVAL      SDATA = '<cac:Item>'
     C                   EXSR      TILFIL
      * <cbc:Name>
     C                   EVAL      SDATA = *BLANKS
     C                   IF        FAVT01 = 'X'                                   3<-B
      * KUN TEST FRA FAVT
     C                   EVAL      XTXT801 = FAVT02
     C                   Z-ADD     40            XN53              3 0
     C                   EXSR      KNVST
     C                   CAT       XTXT802:0     SDATA
     C                   ELSE                                                     3
     C                   IF        FAVT <> *BLANKS                                 4<-B
     C                   EVAL      XTXT801 = FAVT
     C                   Z-ADD     40            XN53              3 0
     C                   EXSR      KNVST
     C                   CAT       XTXT802:0     SDATA
     C                   CAT       ',':0         SDATA
     C                   END                                                       4<-E
     C     KODTGEK       CHAIN     KODTGE                             33
     C     KODTG2K       CHAIN     KODTG2                             33
     C                   SELECT                                                    4<-B
     C                   WHEN      SPRAAK = 'E'
     C                   EVAL      XTXT801 = KGEENT
     C                   WHEN      SPRAAK = 'T'
     C                   EVAL      XTXT801 = KG2TYT
     C                   OTHER
     C                   EVAL      XTXT801 = KGENOT
     C                   ENDSL                                                     4<-E
     C                   Z-ADD     40            XN53              3 0
     C                   EXSR      KNVST
     C                   CAT       XTXT802:0     SDATA
     C                   END                                                      3<-E
     C                   MOVE      XAN13BLANK    SDATA
     C                   EVAL      SDATA = '<cbc:Name>'
     C                             + %TRIM(SDATA) + '</cbc:Name>'
     C                   EXSR      TILFIL
      * <cac:ClassifiedTaxCategory> start
     C                   EVAL      SDATA = '<cac:ClassifiedTaxCategory>'
     C                   EXSR      TILFIL
      * <cbc:ID>
     C                   IF        MVAAVI = 0
     C                   EVAL      SDATA = '<cbc:ID>F</cbc:ID>'
     C                   ELSE
     C                   EVAL      SDATA = '<cbc:ID>S</cbc:ID>'
     C                   END
     C                   EXSR      TILFIL
      * <cbc:Percent>
     C                   EVAL      ØN152 = MVAAVI
     C                   MOVE      'N'           XBELØP            1
     C                   EXSR      SRNE
     C                   EVAL      SDATA = '<cbc:Percent>'
     C                             + %TRIM(ØAN) + '</cbc:Percent>'
     C                   EXSR      TILFIL
      * <cac:TaxScheme> start
     C                   EVAL      SDATA = '<cac:TaxScheme>'
     C                   EXSR      TILFIL
      * <cbc:ID>
     C                   EVAL      SDATA = '<cbc:ID>VAT</cbc:ID>'
     C                   EXSR      TILFIL
      * </cac:TaxScheme> slutt
     C                   EVAL      SDATA = '</cac:TaxScheme>'
     C                   EXSR      TILFIL
      * </cac:ClassifiedTaxCategory> slutt
     C                   EVAL      SDATA = '</cac:ClassifiedTaxCategory>'
     C                   EXSR      TILFIL
      * </cac:Item> slutt
     C                   EVAL      SDATA = '</cac:Item>'
     C                   EXSR      TILFIL
      * <cac:Price> start
     C                   EVAL      SDATA = '<cac:Price>'
     C                   EXSR      TILFIL
      * <cbc:PriceAmount
     C                   EVAL      SDATA = '<cbc:PriceAmount '
     C                             + 'currencyID="' + XFVAL + '">'
     C                             + %TRIM(%EDITC(XXBEL:'4'))
     C                             + '</cbc:PriceAmount>'
     C                   EXSR      TILFIL
      * </cac:Price> slutt
     C                   EVAL      SDATA = '</cac:Price>'
     C                   EXSR      TILFIL
      * </cac:InvoiceLine> slutt
     C                   EVAL      SDATA = '</cac:InvoiceLine>'
     C                   EXSR      TILFIL
      *
     C                   END                                                     2<-E
      *
     C     FAK8K         READE     FAK8                                   33
     C                   ENDDO                                                  1<-E
      *
     C                   ENDSR
      *
      ***********************************************
     C     SRCLOSE       BEGSR
      ***********************************************
     C                   CLOSE     KODWL01
     C                   CLOSE     KODTA
     C                   CLOSE     KODTGE
     C                   CLOSE     KODTG2
     C                   CLOSE     KODTFR
     C                   CLOSE     KODTOTY
     C                   CLOSE     KODTSF
     C                   CLOSE     CUNDL01
     C                   CLOSE     FAIN
     C                   CLOSE     HEADF
     C                   CLOSE     FAK8
     C                   CLOSE     FAKTXT
     C                   CLOSE     FRISOK
     C                   CLOSE     KODFRI
     C                   CLOSE     EDIC
     C                   CLOSE     EDIS
     C                   CLOSE     EDIM
     C                   CLOSE     EDISE1K
      *
     C                   ENDSR
      *
      ***********************************************
     C     SRSNDSL       BEGSR
      ***********************************************
      *
     C     XSSN          CHAIN     EDIS                               33
     C  N33              MOVE      'X'           SST
     C  N33              UPDATE    EDISR
     C     1             DO        100           XSNVN
     C     XSNV(XSNVN)   CHAIN     EDIS                               33
     C  N33              MOVE      'X'           SST
     C  N33              UPDATE    EDISR
     C                   ENDDO
      *
     C                   ENDSR
      *
      ***********************************************
     C     OPDEDIM       BEGSR
      ***********************************************
     C     1             CHAIN     EDIC                               33
     C                   ADD       1             CMN
     C                   UPDATE    EDICR
      *
     C                   EVAL      M0004 = S0004
     C                   EVAL      M0010 = S0010
     C                   MOVEL     CMN           M0062
     C                   EVAL      M0065 = 'INVXML'
     C                   MOVEL     XFFN          M0068
     C                   IF        XFFK = 'F'
     C                   MOVEL     '380'         M1001
     C                   ELSE
     C                   MOVEL     '381'         M1001
     C                   END
     C                   MOVEL     XFFN          M1004
     C                   IF        XFSAML = 'N'
     C                   MOVE      'SIN'         M1225
     C                   ELSE
     C                   MOVE      'SAM'         M1225
     C                   END
     C                   EVAL      MSN = SSN
     C                   EVAL      MMN = CMN
     C                   EVAL      MSR = 'S'
     C                   EVAL      MST = 'C'
     C                   MOVE      WDT           MDT
     C                   MOVE      WTM           MTM
     C                   IF        XFSAML = 'N'
     C                   EVAL      MAVD = FIAVD
     C                   EVAL      MTDN = FIOPD
     C                   ELSE
     C                   EVAL      MAVD = 0
     C                   EVAL      MTDN = 0
     C                   END
     C                   WRITE     EDIMR
      *
     C                   ENDSR
      *
      *////////////////////////////////////////////////////////////
      *  Venstrestill numeriske verdier                      SRNE /
      *////////////////////////////////////////////////////////////
     C     SRNE          BEGSR
     C                   IF        ØN152 < 0
     C                   MOVE      '-'           XAN01             1
     C                   Z-SUB     ØN152         ØN152
     C                   ELSE
     C                   MOVE      ' '           XAN01
     C                   END
      * Flytte in rett verdi i Alfa 12-felt
     C                   MOVE      *ZEROS        ØA12
     C     ØA152D        IFEQ      '00'                                         <-------------I
     C     XBELØP        ANDEQ     'N'                                                        I
     C                   MOVE      ØA152H        ØA12                                         I
     C                   ELSE                                                   <-------------I
     C                   MOVEL     ØA152X        ØA12                                         I
     C                   MOVE      '.  '         ØA12                                         I
     C                   MOVE      ØA152D        ØA12                                         I
     C     XBELØP        IFEQ      'N'
     C     Ø12(12)       IFEQ      '0'
     C                   MOVE      ' '           Ø12(12)
     C     Ø12(11)       IFEQ      '0'
     C                   MOVE      ' '           Ø12(11)
     C                   END
     C                   END
     C                   END
     C                   END                                                    <-------------I
      * lete fra venstre og finn foerste siffer over 0
     C     1             DO        11            ØX                             <-------------I
     C     Ø12(ØX)       IFNE      '0'                                           <-----------II
     C                   GOTO      SRNE1                                                     II
     C                   END                                                     <-----------II
     C                   END                                                    <-------------I
     C     SRNE1         TAG
      * Venstrestill til et nytt felt
     C                   MOVE      *BLANKS       XXA12            12
     C     Ø12(ØX)       IFEQ      '.'
     C                   SUB       1             ØX
     C                   END
     C                   MOVEA     Ø12(ØX)       XXA12
     C                   IF        XAN01 = '-'
     C                   EVAL      ØAN = XAN01
     C                   CAT       XXA12:0       ØAN
     C                   ELSE
     C                   EVAL      ØAN = XXA12
     C                   END
      *
     C                   ENDSR
      ***********************************************
     C     TILFIL        BEGSR
      ***********************************************
     C                   WRITE     EDISER
      *
     C                   ENDSR
      *
      ***********************************************
     C     KNVST         BEGSR
      ***********************************************
     C     XN53          SUB       4             XN54              3 0
     C     XN53          SUB       5             XN55              3 0
     C     XN53          SUB       6             XN56              3 0
     C                   Z-ADD     0             XN52              3 0
     C                   MOVE      *BLANKS       XTXT802
     C     1             DO        80            XN51              3 0
     C                   IF        (((((XT801(XN51) = '&') OR
     C                                 (XT801(XN51) = '"')) OR
     C                                 (XT801(XN51) = XAPS)) OR
     C                                 (XT801(XN51) = '<')) OR
     C                                 (XT801(XN51) = '>'))
     C                   IF        XN52 < XN53
     C                   ADD       1             XN52
     C                   SELECT
     C                   WHEN      XT801(XN51) = '&'
     C                   IF        XN51 < XN55
     C                   MOVEA     '&amp;'       XT802(XN52)
     C                   ADD       4             XN52
     C                   ELSE
     C                   SUB       1             XN52
     C                   END
     C                   WHEN      XT801(XN51) = '"'
     C                   IF        XN51 < XN56
     C                   MOVEA     '&quot;'      XT802(XN52)
     C                   ADD       5             XN52
     C                   ELSE
     C                   SUB       1             XN52
     C                   END
     C                   WHEN      XT801(XN51) = XAPS
     C                   IF        XN51 < XN56
     C                   MOVEA     '&apos;'      XT802(XN52)
     C                   ADD       5             XN52
     C                   ELSE
     C                   SUB       1             XN52
     C                   END
     C                   WHEN      XT801(XN51) = '>'
     C                   IF        XN51 < XN54
     C                   MOVEA     '&gt;'        XT802(XN52)
     C                   ADD       3             XN52
     C                   ELSE
     C                   SUB       1             XN52
     C                   END
     C                   WHEN      XT801(XN51) = '<'
     C                   IF        XN51 < XN54
     C                   MOVEA     '&lt;'        XT802(XN52)
     C                   ADD       3             XN52
     C                   ELSE
     C                   SUB       1             XN52
     C                   END
     C                   ENDSL
     C                   END
     C                   ELSE
     C                   IF        XN52 < XN53
     C                   ADD       1             XN52
     C                   MOVE      XT801(XN51)   XT802(XN52)
     C                   ELSE
     C                   LEAVE
     C                   END
     C                   END
     C                   ENDDO
      *
     C                   ENDSR
      *
      ***********************************************
     C     INIT          BEGSR
      ***********************************************
     C     XMLUFL1K      KLIST
     C                   KFLD                    XXST
     C                   KFLD                    FIFIRM
     C                   KFLD                    XXTYPE
     C     ECMSGK        KLIST
     C                   KFLD                    FIFIRM
     C                   KFLD                    XXKN
     C                   KFLD                    ECSR
     C                   KFLD                    EC0065
     C     HEADFK        KLIST
     C                   KFLD                    FIAVD
     C                   KFLD                    FIOPD
     C     FAK8K         KLIST
     C                   KFLD                    FIAVD
     C                   KFLD                    FIOPD
     C                   KFLD                    FIFN
     C     FAKTXTK       KLIST
     C                   KFLD                    FAAVD
     C                   KFLD                    FAOPD
     C                   KFLD                    FALI
     C     KODWL01K      KLIST
     C                   KFLD                    FIFIRM
     C                   KFLD                    MOMSTW
     C                   KFLD                    FAKDM
     C     KODTAK        KLIST
     C                   KFLD                    KOAUNI
     C                   KFLD                    FIAVD
     C     KODTAKX       KLIST
     C                   KFLD                    KOAUNI
     C                   KFLD                    XFAVD
     C     KODTGEK       KLIST
     C                   KFLD                    KGEUNI
     C                   KFLD                    FAVK
     C     KODTG2K       KLIST
     C                   KFLD                    KG2UNI
     C                   KFLD                    FAVK
     C     KODTFRK       KLIST
     C                   KFLD                    KFRUNI
     C                   KFLD                    HEFR
     C     KODTOTYK      KLIST
     C                   KFLD                    KO1UNI
     C                   KFLD                    HEOT
     C     KODTSFK       KLIST
     C                   KFLD                    KOSFUN
     C                   KFLD                    HESG
     C     CUNDL01K      KLIST
     C                   KFLD                    FIFIRM
     C                   KFLD                    KUNDNR
     C     FREETK        KLIST
     C                   KFLD                    HEAVD
     C                   KFLD                    HEOPD
     C                   KFLD                    FASK
     C                   KFLD                    FIFN
     C     FRISOKK       KLIST
     C                   KFLD                    HEAVD
     C                   KFLD                    HEOPD
     C                   KFLD                    XFSKODE           3
     C     ARKIVL02K     KLIST
     C                   KFLD                    ARSTAT
     C                   KFLD                    FIAVD
     C                   KFLD                    FIOPD
     C     ARKVEDKK      KLIST
     C                   KFLD                    FIFIRM
     C                   KFLD                    XXKN
     C                   KFLD                    AVTYPE
     C     ARKLAGK       KLIST
     C                   KFLD                    FIFIRM
     C                   KFLD                    ARKLAG
      *
     C     *LOVAL        SETLL     FIRM
     C                   READ      FIRM                                   33
      *
     C     *LIKE         DEFINE    SSN           XSSN
     C     *LIKE         DEFINE    SSN           XSSNVEDL
     C                   Z-ADD     0             ØX                2 0
     C                   MOVE      *BLANKS       ØAN              12
     C                   MOVE      *ZEROS        XXBEL            13 2
     C                   MOVE      *ZEROS        XXMVA            13 2
     C                   MOVE      *ZEROS        XXMVAG           13 2
     C                   MOVE      *BLANKS       XAN13BLANK       13
     C                   MOVE      ' '           XXST              1
     C                   MOVE      'EHF  '       XXTYPE            5
     C                   MOVE      'A'           KOAUNI
     C                   MOVEL     'GE'          KGEUNI
     C                   MOVEL     'G2'          KG2UNI
     C                   MOVEL     'FR'          KFRUNI
     C                   MOVEL     'OTY'         KO1UNI
     C                   MOVEL     'SF'          KOSFUN
     C                   MOVE      'PO '         XFSKODE
     C                   MOVE      'A'           ARSTAT
     C                   MOVEL     'S'           ECSR
     C                   MOVEL     'INVXML'      EC0065
     C                   MOVE      '/'           XXSTREKK1
     C                   MOVE      '/'           XXSTREKK2
     C                   MOVE      *BLANKS       UFIL             70
     C                   MOVE      *BLANKS       UKAT             70
     C                   BITON     '123457'      XAPS              1
     C                   BITOFF    '06'          XAPS
      *
     C                   ENDSR
      *
** TXT
<?xml version="1.0" encoding="UTF-8"?>                                          001
<?xml-stylesheet type='text/xsl' href='EHF-faktura_små.xslt'?>                  002
<Invoice xsi:schemaLocation="urn:oasis:names:specification:ubl:schema:xsd:Invoic003
e-2 UBL-Invoice-2.0.xsd" xmlns="urn:oasis:names:specification:ubl:schema:xsd:Inv004
oice-2" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:cac="urn:oas005
is:names:specification:ubl:schema:xsd:CommonAggregateComponents-2" xmlns:cbc="ur006
n:oasis:names:specification:ubl:schema:xsd:CommonBasicComponents-2" xmlns:ext="u007
rn:oasis:names:specification:ubl:schema:xsd:CommonExtensionComponents-2">       008
</Invoice>                                                                      009
