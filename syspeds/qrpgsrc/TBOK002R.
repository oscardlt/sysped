      *********************************************************************
      *
CRTPG+*  CRTPGM SYSPED/TBOK002R MODULE(*LIBL/TBOK002R *LIBL/INCGI)
CRTPGM*        ACTGRP(CGI) AUT(*USE)
      *
      *********************************************************************
      /copy SYSPEDS/qrpgsrcpy,hspecs
      /copy SYSPEDS/qrpgsrcpy,hspecsbnd
      *********************************************************************
     FBRIDF     IF   E           K DISK    USROPN
     FFIRM      IF   E           K DISK    USROPN
     FZEADL05   IF A E           K DISK    USROPN
     FZREETXT1  IF A E           K DISK    USROPN
     FZRISOL02  IF A E           K DISK    USROPN
     FCUNDL01   IF   E           K DISK    USROPN
     FKUNKO1    IF   E           K DISK    USROPN
     FKUNKO2    IF   E           K DISK    USROPN
     F                                     RENAME(KUNKOR:KUNKOR2)
     F                                     PREFIX(K2_)
     FVADR      IF   E           K DISK    USROPN
     FSTED2     IF   E           K DISK    USROPN
     FSTED2D    IF   E           K DISK    USROPN
     F                                     RENAME(STED2R:STED2RD)
     FBRPARF    if   e           k disk    usropn
     FKODTOTY   if   e           k disk    usropn
     FKODTFR    if   e           k disk    usropn
     FZTELL     UF   E           K DISK    USROPN
     FKUFAST    IF   E           K DISK    USROPN
     FAVFRH     IF   E           K DISK    USROPN
      *--------------------------------------------------------------------
      * Variables common to all CGIs
      *--------------------------------------------------------------------
      /copy SYSPEDS/qrpgsrcpy,prototypeb
      /copy SYSPEDS/qrpgsrcpy,usec
      /copy SYSPEDS/qrpgsrcpy,variables3
      *
      * Varible for
     D WSUSER          S             10
     D REFF            S             17
     D UNIK            S              9
     D UNIKN           S              9  0
     D DTOP            S              8
     D DTOPN           S              8  0
     D SDTD            S              8
     D SDTDN           S              8  0
     D OREF            S             17
     D KNS             S              8
     D KNSN            S              8  0
     D KNSVA           S              5
     D NAS             S             30
     D ADS1            S             30
     D ADS2            S             30
     D ADS3            S             30
     D KNK             S              8
     D KNKN            S              8  0
     D KNKVA           S              5
     D NAK             S             30
     D ADK1            S             30
     D ADK2            S             30
     D ADK3            S             30
     D GN              S             15
     D LKF             S              2
     D SDF             S              5
     D LKT             S              2
     D SDT             S              5
     D OT              S              2
     D FR              S              3
     D KDPL            S              1
     D NT              S              7
     D NTN             S              7  0
     D VKT             S              9
     D VKTN            S              9  0
     D M3              S              8
     D M3N             S              7  3
     D LM              S              5
     D LMN             S              4  2
     D VS1             S             25
     D VS2             S             25
     D GM1             S             15
     D GM2             S             15
     D MTXT            S           6300
     D TTXT            S           6300
     D STXT            S           6300
     D EP1             S             70
     D TLF1            S             15
     D SMS1            S             15
     D JSONstring      s          32000
     D Error           S            150
     D AntLest         S              9  0

      *get input-string
      /copy syspeds/qrpgsrcpy,prolog3

      * Parse input
     C                   exsr      Parse
      * Open files etc
     C                   EXSR      INIT
      *
     c                   callp     gethtmlifs(
     C                             '/syspeddev/html/JSON.html':
     C                             '/CGITAG/')
     C                   callp     wrtsection('top')
      *
      * ............................................................................................
      * skriv JSON-Object start..(alltid '{' + x ant param. m/komma mellom (IKKE komma etter siste))
      * ............................................................................................
      *
      /free
        JSONstring='{'
        +'¬user¬ : ¬'+%trim(WSUSER)+'¬, '
        +'¬hereff¬ : ¬'+%trim(REFF)+'¬, '
        +'¬heunik¬ : ¬'+%trim(%editc(UNIK:'Z'))+'¬, '
        +'¬dtop¬ : ¬'+%trim(%editc(DTOP:'Z'))+'¬, '
        +'¬sdtd¬ : ¬'+%trim(%editc(SDTD:'Z'))+'¬, '
        +'¬errMsg¬ : ¬'+%trim(Error)+'¬, ';
      /end-free
      * JSONfix escaper " i tekst,  for deretter å bytte ¬->"
     c                   call      'JSONFIX'
     c                   parm                    JSONstring
     C                   CALLP     updHTMLvar2('JSONstring'
     C                                         :%addr(JSONstring)
     C                                         :%len(JSONstring))
     C                   callp     wrtsection('JSONlin')
      *
      * ............................................................................................
      * Skriv JSON-LISTE Start (en liste er EN parameter(fra [ til   )
      * ............................................................................................
     C                   eval      JSONstring ='"oneorder" : ['
     C                   CALLP     updHTMLvar2('JSONstring'
     C                                         :%addr(JSONstring)
     C                                         :%len(JSONstring))
     C                   callp     wrtsection('JSONlin')
      *
      * Hæmta detta ena ærendet.
      *
     c     Error         ifeq      *blanks
     C     ZEADL05K      CHAIN     DKIH                               55
     C  N55FRIKEY        CHAIN     FRISOK                             56
     C   56              EVAL      FSSOK=*BLANKS
     C     *IN55         IFEQ      '0'
      * ............................................................................................
      * Skriv en JSON-Array-linje pr menypunkt - komma før hvert nytt element
      * ............................................................................................
      /free
          JSONstring=*blanks;
       JSONstring=%trim(JSONstring)+'{'
          +'¬dkih_syav¬ : ¬'+%trim(%editc(DKIH_SYAV:'Z'))+'¬, '
          +'¬dkih_syop¬ : ¬'+%trim(%editc(DKIH_SYOP:'Z'))+'¬, '
          +'¬dkih_sysg¬ : ¬'+%trim(DKIH_SYSG)+'¬, '
          +'¬dkih_syst¬ : ¬'+%trim(DKIH_SYST)+'¬, '
          +'¬dkih_sydt¬ : ¬'+%trim(%editc(DKIH_SYDT:'Z'))+'¬, '
          +'¬dkih_0035¬ : ¬'+%trim(DKIH_0035)+'¬, '
          +'¬dkih_godt¬ : ¬'+%trim(%editc(DKIH_GODT:'Z'))+'¬, '
          +'¬dkih_vadt¬ : ¬'+%trim(%editc(DKIH_VADT:'Z'))+'¬, '
          +'¬dkih_sadt¬ : ¬'+%trim(%editc(DKIH_SADT:'Z'))+'¬, '
          +'¬dkih_andt¬ : ¬'+%trim(%editc(DKIH_ANDT:'Z'))+'¬, '
          +'¬dkih_1004¬ : ¬'+%trim(DKIH_1004)+'¬, '
          +'¬dkih_xref¬ : ¬'+%trim(FSSOK)+'¬, '
          +'¬dkih_a¬ : ¬'+%trim(DKIH_A)+'¬, '
          +'¬dkih_dtm1¬ : ¬'+%trim(%editc(DKIH_DTM1:'Z'))+'¬, '
          +'¬dkih_dtm2¬ : ¬'+%trim(%editc(DKIH_DTM2:'Z'))+'¬, '
          +'¬dkih_ajou¬ : ¬'+%trim(DKIH_AJOU)+'¬, '
          +'¬dkih_ensf¬ : ¬'+%trim(DKIH_ENSF)+'¬, '
          +'¬dkih_bega¬ : ¬'+%trim(DKIH_BEGA)+'¬, '
          +'¬dkih_begb¬ : ¬'+%trim(DKIH_BEGB)+'¬, '
          +'¬dkih_begc¬ : ¬'+%trim(DKIH_BEGC)+'¬, '
          +'¬dkih_begd¬ : ¬'+%trim(DKIH_BEGD)+'¬, '
          +'¬dkih_r011¬ : ¬'+%trim(DKIH_R011)+'¬, '
          +'¬dkih_r012¬ : ¬'+%trim(DKIH_R012)+'¬, '
          +'¬dkih_aart¬ : ¬'+%trim(DKIH_AART)+'¬, '
          +'¬dkih_avkn¬ : ¬'+%trim(%editc(DKIH_AVKN:'Z'))+'¬, '
          +'¬dkih_02a¬ : ¬'+%trim(DKIH_02A)+'¬, '
          +'¬dkih_02b¬ : ¬'+%trim(DKIH_02B)+'¬, '
          +'¬dkih_02c¬ : ¬'+%trim(DKIH_02C)+'¬, '
          +'¬dkih_02d¬ : ¬'+%trim(DKIH_02D)+'¬, '
          +'¬dkih_02e¬ : ¬'+%trim(DKIH_02E)+'¬, '
          +'¬dkih_02f¬ : ¬'+%trim(DKIH_02F)+'¬, '
          +'¬dkih_06¬ : ¬'+%trim(%editc(DKIH_06:'Z'))+'¬, '
          +'¬dkih_07¬ : ¬'+%trim(DKIH_07)+'¬,'
          +'¬dkih_07a¬ : ¬'+%trim(DKIH_07A)+'¬,'
          +'¬dkih_07b¬ : ¬'+%trim(DKIH_07B)+'¬, '
          +'¬dkih_07c¬ : ¬'+%trim(DKIH_07C)+'¬, '
          +'¬dkih_07d¬ : ¬'+%trim(DKIH_07D)+'¬, '
          +'¬dkih_mokn¬ : ¬'+%trim(%editc(DKIH_MOKN:'Z'))+'¬, '
          +'¬dkih_08a¬ : ¬'+%trim(DKIH_08A)+'¬, '
          +'¬dkih_08b¬ : ¬'+%trim(DKIH_08B)+'¬, '
          +'¬dkih_08c¬ : ¬'+%trim(DKIH_08C)+'¬, '
          +'¬dkih_08d¬ : ¬'+%trim(DKIH_08D)+'¬, '
          +'¬dkih_08e¬ : ¬'+%trim(DKIH_08E)+'¬, '
          +'¬dkih_08f¬ : ¬'+%trim(DKIH_08F)+'¬, '
          +'¬dkih_rekn¬ : ¬'+%trim(%editc(DKIH_REKN:'Z'))+'¬, '
          +'¬dkih_reeo¬ : ¬'+%trim(DKIH_REEO)+'¬, '
          +'¬dkih_trkn¬ : ¬'+%trim(%editc(DKIH_TRKN:'Z'))+'¬, '
          +'¬dkih_treo¬ : ¬'+%trim(DKIH_TREO)+'¬, '
          +'¬dkih_trna¬ : ¬'+%trim(DKIH_TRNA)+'¬, '
          +'¬dkih_trga¬ : ¬'+%trim(DKIH_TRGA)+'¬, '
          +'¬dkih_trpo¬ : ¬'+%trim(DKIH_TRPO)+'¬, '
          +'¬dkih_trby¬ : ¬'+%trim(DKIH_trby)+'¬, '
          +'¬dkih_trlk¬ : ¬'+%trim(DKIH_trlk)+'¬, '
          +'¬dkih_nikn¬ : ¬'+%trim(%editc(DKIH_NIKN:'Z'))+'¬, '
          +'¬dkih_nieo¬ : ¬'+%trim(DKIH_nieo)+'¬, '
          +'¬dkih_nina¬ : ¬'+%trim(DKIH_NINA)+'¬, '
          +'¬dkih_niga¬ : ¬'+%trim(DKIH_NIGA)+'¬, '
          +'¬dkih_nipo¬ : ¬'+%trim(DKIH_NIPO)+'¬, '
          +'¬dkih_niby¬ : ¬'+%trim(DKIH_NIBY)+'¬, '
          +'¬dkih_nilk¬ : ¬'+%trim(DKIH_NILK)+'¬, '
          +'¬dkih_12¬ : ¬'+%trim(%editc(DKIH_12:'4'))+'¬, '
          +'¬dkih_12e¬ : ¬'+%trim(%editc(DKIH_12E:'4'))+'¬, '
          +'¬dkih_14a¬ : ¬'+%trim(DKIH_14A)+'¬, '
          +'¬dkih_14b¬ : ¬'+%trim(DKIH_14B)+'¬, '
          +'¬dkih_15¬ : ¬'+%trim(DKIH_15)+'¬, '
          +'¬dkih_s17¬ : ¬'+%trim(DKIH_S17)+'¬, '
          +'¬dkih_s18¬ : ¬'+%trim(DKIH_S18)+'¬, '
          +'¬dkih_s28¬ : ¬'+%trim(DKIH_S28)+'¬, '
          +'¬dkih_s32¬ : ¬'+%trim(DKIH_S32)+'¬, '
          +'¬dkih_181¬ : ¬'+%trim(DKIH_181)+'¬, '
          +'¬dkih_201¬ : ¬'+%trim(DKIH_201)+'¬, '
          +'¬dkih_202¬ : ¬'+%trim(DKIH_202)+'¬, '
          +'¬dkih_211¬ : ¬'+%trim(DKIH_211)+'¬, '
          +'¬dkih_221¬ : ¬'+%trim(DKIH_221)+'¬, '
          +'¬dkih_221b¬ : ¬'+%trim(%editc(DKIH_221B:'4'))+'¬, '
          +'¬dkih_221c¬ : ¬'+%trim(%editc(DKIH_221C:'Z'))+'¬, '
          +'¬dkih_222¬ : ¬'+%trim(%editc(DKIH_222:'4'))+'¬, '
          +'¬dkih_25¬ : ¬'+%trim(DKIH_25)+'¬, '
          +'¬dkih_26¬ : ¬'+%trim(DKIH_26)+'¬, '
          +'¬dkih_28a¬ : ¬'+%trim(DKIH_28A)+'¬, '
          +'¬dkih_28b¬ : ¬'+%trim(DKIH_28B)+'¬, '
          +'¬dkih_28c¬ : ¬'+%trim(%editc(DKIH_28C:'Z'))+'¬, '
          +'¬dkih_s29¬ : ¬'+%trim(DKIH_S29)+'¬, '
          +'¬dkih_301¬ : ¬'+%trim(DKIH_301)+'¬, '
          +'¬dkih_302¬ : ¬'+%trim(DKIH_302)+'¬, '
          +'¬dkih_303¬ : ¬'+%trim(DKIH_303)+'¬, '
          +'¬dkih_304¬ : ¬'+%trim(DKIH_304)+'¬, '
          +'¬dkih_49¬ : ¬'+%trim(DKIH_49)+'¬, '
          +'¬dkih_brut¬ : ¬'+%trim(%editc(DKIH_BRUT:'4'))+'¬, '
          +'¬dkih_genb¬ : ¬'+%trim(DKIH_GENB)+'¬, '
          +'¬dkih_t04a¬ : ¬'+%trim(DKIH_T04A)+'¬, '
          +'¬dkih_t04b¬ : ¬'+%trim(%editc(DKIH_T04B:'Z'))+'¬, '
          +'¬dkih_t05a¬ : ¬'+%trim(DKIH_T05A)+'¬, '
          +'¬dkih_t05b¬ : ¬'+%trim(%editc(DKIH_T05B:'Z'))+'¬, '
          +'¬dkih_t06a¬ : ¬'+%trim(DKIH_T06A)+'¬, '
          +'¬dkih_t06b¬ : ¬'+%trim(%editc(DKIH_T06B:'Z'))+'¬, '
          +'¬dkih_t07a¬ : ¬'+%trim(DKIH_T07A)+'¬, '
          +'¬dkih_t07b¬ : ¬'+%trim(DKIH_T07B)+'¬, '
          +'¬dkih_t07c¬ : ¬'+%trim(DKIH_T07C)+'¬, '
          +'¬dkih_t07d¬ : ¬'+%trim(DKIH_T07D)+'¬, '
          +'¬dkih_t08a¬ : ¬'+%trim(DKIH_T08A)+'¬, '
          +'¬dkih_t08b¬ : ¬'+%trim(DKIH_T08B)+'¬, '
          +'¬dkih_t08c¬ : ¬'+%trim(DKIH_T08C)+'¬, '
          +'¬dkih_t09a¬ : ¬'+%trim(DKIH_T09A)+'¬, '
          +'¬dkih_t09b¬ : ¬'+%trim(DKIH_T09B)+'¬}';
      /end-free
     C                   call      'JSONFIX'
     C                   parm                    JSONstring
     C                   CALLP     updHTMLvar2('JSONstring'
     C                                         :%addr(JSONstring)
     C                                         :%len(JSONstring))
     C                   callp     wrtsection('JSONlin')
      *
     C                   ENDIF
     c                   endif
     c                   eval      JSONstring =']'
     C                   CALLP     updHTMLvar2('JSONstring'
     C                                         :%addr(JSONstring)
     C                                         :%len(JSONstring))
     C                   callp     wrtsection('JSONlin')
      * ............................................................................................
      * Skriv JSON-string Avsluttning
      * ............................................................................................
     c                   eval      JSONstring ='}'
     C                   CALLP     updHTMLvar2('JSONstring'
     C                                         :%addr(JSONstring)
     C                                         :%len(JSONstring))
     C                   callp     wrtsection('JSONlin')
      *
      * Quit
     C                   exsr      Exit


      *=====================================================================
      * Close output html and quit
      *=====================================================================
     C     Exit          begsr
      * Lukk fil
     C                   CLOSE     BRIDF
     C  N50              CLOSE     DKIH
     C  N50              CLOSE     FRISOK

      * Do not delete the call to wrtsection with section name *fini.  It is needed
      * to ensure that all output html that has been buffered gets output.
     C                   callp     wrtsection('*fini')
      * Quit
     C                   MOVE      *ON           *INLR
     C                   return
     C                   endsr
      *
      *********************************************************
     C     Parse         Begsr
      *********************************************************
      * Get input
     C                   EVAL      WSUSER  = zhbgetvar('USER')
     C                   eval      REFF    = zhbgetvar('HEREFF')
     C                   eval      UNIK    = zhbgetvar('HEUNIK')
     C                   eval      UNIKN   = c2n2(UNIK)
     C                   eval      DTOP    = zhbgetvar('HEDTOP')
     C                   eval      DTOPN   = c2n2(DTOP)
     C                   EVAL      SDTD    = zhbgetvar('TRSDTD')
     C                   eval      SDTDN   = c2n2(SDTD)
     C                   EVAL      OREF    = zhbgetvar('XXOREF')
     C                   eval      OREF    = uppify(OREF)
     C                   eval      KNS     = zhbgetvar('HEKNS')
     C                   eval      KNSN    = c2n2(KNS)
     C                   eval      KNSVA   = zhbgetvar('XXKNSVA')
     C                   eval      NAS     = zhbgetvar('HENAS')
     C                   eval      NAS     = uppify(NAS)
     C                   eval      ADS1    = zhbgetvar('HEADS1')
     C                   eval      ADS1    = uppify(ADS1)
     C                   eval      ADS2    = zhbgetvar('HEADS2')
     C                   eval      ADS2    = uppify(ADS2)
     C                   eval      ADS3    = zhbgetvar('HEADS3')
     C                   eval      ADS3    = uppify(ADS3)
     C                   eval      KNK     = zhbgetvar('HEKNK')
     C                   eval      KNKN    = c2n2(KNK)
     C                   eval      KNKVA   = zhbgetvar('XXKNKVA')
     C                   eval      NAK     = zhbgetvar('HENAK')
     C                   eval      NAK     = uppify(NAK)
     C                   eval      ADK1    = zhbgetvar('HEADK1')
     C                   eval      ADK1    = uppify(ADK1)
     C                   eval      ADK2    = zhbgetvar('HEADK2')
     C                   eval      ADK2    = uppify(ADK2)
     C                   eval      ADK3    = zhbgetvar('HEADK3')
     C                   eval      ADK3    = uppify(ADK3)
     C                   eval      GN      = zhbgetvar('HEGN')
     C                   eval      GN      = uppify(GN)
     C                   eval      LKF     = zhbgetvar('XXLKF')
     C                   eval      LKF     = uppify(LKF)
     C                   eval      SDF     = zhbgetvar('HESDF')
     C                   eval      SDF     = uppify(SDF)
     C                   eval      LKT     = zhbgetvar('XXLKT')
     C                   eval      LKT     = uppify(LKT)
     C                   eval      SDT     = zhbgetvar('HESDT')
     C                   eval      SDT     = uppify(SDT)
     C                   eval      OT      = zhbgetvar('HEOT')
     C                   eval      OT      = uppify(OT)
     C                   eval      FR      = zhbgetvar('HEFR')
     C                   eval      FR      = uppify(FR)
     C                   eval      KDPL    = zhbgetvar('HEKDPL')
     C                   eval      NT      = zhbgetvar('HENT')
     C                   eval      NTN     = c2n2(NT)
     C                   eval      VKT     = zhbgetvar('HEVKT')
     C                   eval      VKTN    = c2n2(VKT)
     C                   eval      M3      = zhbgetvar('HEM3')
     C                   eval      M3N     = c2n2(M3)
     C                   eval      LM      = zhbgetvar('HELM')
     C                   eval      LMN     = c2n2(LM)
     C                   eval      VS1     = zhbgetvar('HEVS1')
     C                   eval      VS1     = uppify(VS1)
     C                   eval      VS2     = zhbgetvar('HEVS2')
     C                   eval      VS2     = uppify(VS2)
     C                   eval      GM1     = zhbgetvar('HEGM1')
     C                   eval      GM1     = uppify(GM1)
     C                   eval      GM2     = zhbgetvar('HEGM2')
     C                   eval      GM2     = uppify(GM2)
     C                   eval      MTXT    = zhbgetvar('XXMTXT')
     C                   eval      MTXT    = uppify(MTXT)
     C                   eval      TTXT    = zhbgetvar('XXTTXT')
     C                   eval      TTXT    = uppify(TTXT)
     C                   eval      STXT    = zhbgetvar('XXSTXT')
     C                   eval      STXT    = uppify(STXT)
     C                   eval      EP1     = zhbgetvar('XXEP1')
     C                   eval      TLF1    = zhbgetvar('XXTLF1')
     C                   eval      SMS1    = zhbgetvar('XXSMS1')

     c                   endsr
      *
      *********************************************************
     C     INIT          Begsr
      *********************************************************
     C                   OPEN      BRIDF
      * Test innlogging
     C     WSUSER        CHAIN     BRIDF                              50
     C     BILIBL        ifeq      *blanks
     C                   callb     'INCGI'
     C                   parm                    BISTDL
     C                   else
     C                   call      BILIBL
     C                   end
      *
     C     DKIHKey       klist
     C                   kfld                    AVDN
     C                   kfld                    OPDN
     C     FRIKEY        klist
     C                   kfld                    AVDN
     C                   kfld                    OPDN
     C                   kfld                    WFSKODE           3

     C                   EVAL      WFSKODE='*CR'

     C   50              eval      Error = 'Invalid userID'
     C  N50              OPEN      DKIH
     C  N50              OPEN      FRISOK

     c                   endsr
      *
