********************************************************************
     H DECEDIT(',') debug(*yes)
      ***********************************************************
      *** PROGRAM for arkivering
********************************************************************
      * RETTINGER I DETTE PROGRAM:
PTFnr:*Sek Sig Vers  Beskrivelse...........................
""""""*"""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""
11XXX * 01 YBC PTF11 FLERE NYE PARAMETRE VED KALL PÅ ARC009CL
11XXX * 01 SH  PTF11 ENDA FLERE NYE PARAMETRE VED KALL PÅ ARC009CL
12XXX * 02 SH  PTF12 OGSÅ VEDLEGG TIL SAMLEFAKTURA
********************************************************************
      ***********************************************************
     FDISTLH    IF   E           K DISK
     FCUNDC     IF   E             DISK
     F*                                    RENAME(cundcr:cundcr2)
     FARC026FM  CF   E             WORKSTN
     FFAK9      IF   E           K DISK
     FARUSERL1  IF   E           K DISK
     FARKTXT    IF   E           K DISK
     FARKEPO    UF A E           K DISK
     FARKIVL06  IF   E           K DISK
     Fcundl01   IF   E           K DISK
     FFIRM      IF   E           K DISK
     FFIRMARC   IF   E           K DISK
     F*UNDC03   IF   E           K DISK
     D                 DS
     D  FADATO                 1      8  0
     D  FAAA                   3      4
     D  FAMM                   5      6
     D  FADG                   7      8
     D                SDS
     D  UUSR                 254    263
     D                 DS
     D  USØKKN                 1     30
     D  USØKKO                 1      2
     D  URRN                   3     12
     D  epofax                13     13
     D UP              C                   CONST('ABCDEFGHIJKLMNOPQRST-
     D                                     UVWXYZ')
     D LO              C                   CONST('abcdefghijklmnopqrst-
     D                                     uvwxyz')
     D                 DS
     D vedleggf        C                   CONST('Fakturaen er sendt -
     D                                     som PDF-vedlegg')
     D trykkf          C                   CONST('Trykk på link for å -
     D                                     se på faktura')
     D vedleggfe       C                   CONST('Invoice is sent as -
     D                                     PDF-attachment')
     D trykkfe         C                   CONST('Press link to open -
     D                                     invoice')
     D trykkae         C                   CONST('Press link to open -
     D                                     invoice')
      *
     c                   exsr      init
     C*
     c     start         tag
     c                   exfmt     bilde
     c   03              goto      slutt
     c     *in04         ifeq      '1'
     c                   setoff                                       307172
     c                   exsr      soksr
     c                   goto      start
     c                   end
     c                   exsr      test
     c   30              goto      start
      *
     c     *in10         ifeq      '1'
     c     neste         tag
     c                   movel     franr         FAKT10
     c     key1          chain     arkivl06                           34
     c   34key2          chain     arkivl06                           34
     c  N34              exsr      pdfinv
     c                   add       1             franr
     c     franr         ifle      tilnr
     c                   goto      neste
     c                   end
     c                   clear                   bilde
     c                   end
     c                   goto      start
     c     slutt         tag
     c                   seton                                        lr
     c                   return
      *
     C*
     C***********************************************
     C     PDFINV        BEGSR
     C***********************************************
     C                   MOVEL     ARUNDE        fafakt            7 0
     c     fafakt        setll     fak9
     c                   setoff                                       66
     c     les9n         tag
     c     fafakt        reade     fak9                                   66
     c     *in66         ifeq      '0'
     c     fakda         cabeq     'K'           les9n
     c                   end
     C                   MOVEL     ARUNDE        AFAK              7
     c* ordner start av linken med forståelig info
     C*
     c     artype        chain     ARKTXT                             33
     c     CUNDK         klist
     c                   kfld                    fifirm
     c                   kfld                    KUNDNR
      *
      *
      * Singel faktura til arkiv
      *
     C                   exsr      genbane
      *
      * test om PDF finnes
      *
     c                   movel     ubane         ub50             50
     c                   call      'ARC001CL'
     c                   parm                    ub50
     c                   parm                    janei             1
     c     janei         ifeq      'N'
     c                   goto      avbryt
     c                   end
      *
     c                   moveL     artxt         wstex1           30
      *
      * eventuelt mail til seg selv   skjekk dette
      * gjøres kun 1 gang når kunde er ulik 0
      *
     c                   move      *blanks       eplink
     c                   move      *blanks       epline
     c                   move      *blanks       epbane
      *
      * slett eventuellt gamle poster
      *
     c                   exsr      delark
     c                   move      *blanks       wstex2
     c     CUNDK         CHAIN     CUNDL01                            33
     C     spraak        ifeq      'E'
     c     spraak        oreq      'T'
     C                   movel     'Invoiceno:'  wstex2           60
     C     wstex2        CAT       afak:1        wstex2
     C     wstex2        CAT       'Invoiceda':1 wstex2
     C     wstex2        CAT       'te:':0       wstex2
     c                   else
     C                   movel     'Fakturanr:'  wstex2
     C     wstex2        CAT       afak:1        wstex2
     C     wstex2        CAT       'fakturada':1 wstex2
     C     wstex2        CAT       'to:':0       wstex2
     c                   end
     C     wstex2        CAT       fadg:1        wstex2
     C     wstex2        CAT       '.':0         wstex2
     C     wstex2        CAT       famm:0        wstex2
     C     wstex2        CAT       '.':0         wstex2
     C     wstex2        CAT       faaa:0        wstex2
     C  N33wstex2        cat       'Til:':1      wstex2
     C  N33wstex2        cat       knavn:1       wstex2
     c                   move      uusr          epuser
     c                   movel     uhttpi        eplink
     c                   movel     uhttpe        epline
     c                   move      'V'           clive
     C     CLIVE         IFEQ      'V'
     c                   eval      EPBANE = UBANE
     C                   END
      *
      * skjekk om mailbruker  er intern
      *
     C                   MOVE      'E'           inteks
     C     CEMAIL        CHAIN     ARUSERL1                           33
     C  N33arinek        ifeq      'I'
     C                   MOVE      'I'           inteks
     c                   end
     c                   moveL     wstex1        eptex1
     c                   move      wstex2        eptex2
     c                   write     arkepor
      *
      *spesifikasjon
n02   *
n02  c     key3          chain     arkivl06                           34
n02  c     *in34         ifeq      '0'
n02   *
n02  C                   exsr      genbane
n02   *
n02   * skjekk om mailbruker  er intern
n02   *
n02  c                   movel     uhttpi        eplink
n02  c                   movel     uhttpe        epline
n02  c                   move      'V'           clive
n02  C     CLIVE         IFEQ      'V'
n02  c                   eval      EPBANE = UBANE
n02  C                   END
n02  C                   MOVE      'E'           inteks
n02  C     CEMAIL        CHAIN     ARUSERL1                           33
n02  C  N33arinek        ifeq      'I'
n02  C                   MOVE      'I'           inteks
n02  c                   end
n02  c                   move      *blanks       wstex1           30
n02  C     spraak        ifeq      'E'
n02  c     spraak        oreq      'T'
n02  c                   moveL     'Spesificatio'wste13           13
n02  c                   move      'n'           wste13
n02  c                   else
n02  c                   moveL     'Spesifikasjo'wste13           13
n02  c                   move      'n'           wste13
n02  c                   end
n02  c                   moveL     wste13        wstex1           30
n02  c                   movel     wstex1        eptex1
n02  c                   move      wstex2        eptex2
n02  c                   write     arkepor
n02  c                   end
     C                   move      *blanks       wscvp1
     C     spraak        ifeq      'E'
     c     spraak        oreq      'T'
     C                   movel     'Invoice from'wscvp1
     c                   else
     C                   movel     'Faktura fra:'wscvp1
     c                   end
     C     wscvp1        cat       fift:1        wscvp1
     C     wscvp1        CAT       'no:':1       wscvp1
     C     wscvp1        CAT       afak:0        wscvp1
     C     wscvp1        CAT       'Date:':1     wscvp1
     C     wscvp1        CAT       fadg:1        wscvp1
     C     wscvp1        CAT       '.':0         wscvp1
     C     wscvp1        CAT       famm:0        wscvp1
     C     wscvp1        CAT       '.':0         wscvp1
     C     wscvp1        CAT       faaa:0        wscvp1
     C     CLIVE         IFNE      'V'
     C     spraak        ifeq      'E'
     c     spraak        oreq      'T'
     C                   movel     trykkfe       wscvp2
     c                   else
     C                   movel     trykkf        wscvp2
     c                   end
     C                   else
     C     spraak        ifeq      'E'
     c     spraak        oreq      'T'
     c                   movel     vedleggfe     wscvp2
     c                   else
     c                   movel     vedleggf      wscvp2
     c                   end
     C                   end
     C                   EVAL      CEMAIL=EPOST
     c                   call      'ARC009CL'
     c                   parm                    CEMAIL
     c                   parm                    wscvp1           80
     c                   parm                    wscvp2           80
     c                   parm                    wscvp3           80
     c                   parm                    wscvp4           80
     C                   parm                    wscvp5           80
     C                   parm                    wscvp6           80
     C                   parm                    wscvp7           80
     C                   parm                    wscvp8           80
     C                   parm                    wscvp9           80
     C                   parm                    wscv10           80
     C                   parm                    wscv11           80
     C                   parm                    wscv12           80
     C                   parm                    inteks            1
N01  C                   parm                    UAVD              4
N01  C                   parm                    UOPD              7
N01  C                   parm                    UTU               8
N01  C                   parm                    UKU               8
N01  C                   parm                    UMRG              1
     C     avbryt        ENDSR
     C***********************************************
     C     delark        BEGSR
     C***********************************************
     c                   move      *blanks       epbane
     c                   move      '0'           *in(39)
     c     uusr          setll     arkepo
     c     *in(39)       doweq     '0'
     c     uusr          reade     arkepo                                 39
     c     *in(39)       ifeq      '0'
     c                   delete    arkepor
     c                   end
     c                   end
     c                   endsr
     C*
     C***********************************************
     C     genbane       BEGSR
     C***********************************************
      * genererer bane for PDF
      *
      *
      *
      * lager http for interne brukere
      *
     C                   move      *blanks       uhttpi
     c                   movel     uhttpista     uhttpi           76
     C     uhttpi        CAT       arlink:0      uhttpi
     C     uhttpi        CAT       '.pdf':0      uhttpi
      * lager http for interne brukere
     C                   move      *blanks       uhttpe           76
     c                   movel     uhttpesta     uhttpe
     C     uhttpe        CAT       arlink:0      uhttpe
     C     uhttpe        CAT       '.pdf':0      uhttpe
      *
      * lager bane til IFS
      *
     C                   move      *blanks       ubane            50
     C                   movel     ubanesta      ubane
     C     ubane         CAT       arlink:0      ubane
     C     ubane         CAT       '.pdf':0      ubane
     c                   endsr
     C***********************************************
     C     init          BEGSR
     C***********************************************
      *
     C     KEY1          KLIST
     C                   KFLD                    FIFIRM            2
     C                   KFLD                    TYPEFA            2
     C                   KFLD                    FAKT10           10
     C                   MOVE      'fa'          TYPEFA
      *
      *
     C     KEY2          KLIST
     C                   KFLD                    FIFIRM            2
     C                   KFLD                    TYPEFS            2
     C                   KFLD                    FAKT10           10
     C                   MOVE      'fs'          TYPEFS
n02  C     KEY3          KLIST
n02  C                   KFLD                    FIFIRM            2
n02  C                   KFLD                    TYPEFX            2
n02  C                   KFLD                    FAKT10           10
n02  C                   MOVE      'fx'          TYPEFX
      *
      *
     c                   read      firm                                   33
     c                   read      firmarc                                33
     c     *in33         ifeq      '1'
     c                   seton                                        lr
     c                   return
     c                   end
      *
      *
      * med vennlig hilsen
      *
     c                   movel     '.'           wscvp3
     c                   movel     'Med vennlig 'wscvp4
     C     wscvp4        CAT       'hilsen':1    wscvp4
     C                   movel     fift          wscvp5
     c*
      * lager http for interne brukere
      *
      * intern
      *
     C                   move      *blanks       uhttpista        76
     c                   movel     'http://'     uhttpista
     C     uhttpista     CAT       arcpad:0      uhttpista
     C     uhttpista     CAT       '/':0         uhttpista
     C     uhttpista     CAT       arcane:0      uhttpista
     C     uhttpista     CAT       '/':0         uhttpista
      *
      * ekstern
      *
     C                   move      *blanks       uhttpesta        76
     c                   movel     'http://'     uhttpesta
     C     uhttpesta     CAT       arcpae:0      uhttpesta
     C     uhttpesta     CAT       '/':0         uhttpesta
     C     uhttpesta     CAT       arcane:0      uhttpesta
     C     uhttpesta     CAT       '/':0         uhttpesta
      *
      * lager bane til IFS
      *
     C                   movel     '/'           ubanesta         70
     C     ubanesta      CAT       arcane:0      ubanesta
     C     ubanesta      CAT       '/':0         ubanesta
     c                   endsr
     C***********************************************
     C     soksr         BEGSR
     C***********************************************
     C     LO:UP         XLATE     EPOST         usok
     C                   CALL      'VCUNDC2R'
     C                   PARM                    FIFIRM
     C                   PARM                    USOK             30
     C                   PARM                    URRN2            10 0
     c                   parm                    epofax            1
     C     URRN2         IFNE      *ZEROS
     C                   MOVE      URRN2         URRN
     C                   MOVE      'KP'          USØKKO
     c                   else
     c                   movel     usok          epost
     C                   END
     C* RETUR MED KONTAKTPERS
     C     USØKKO        IFEQ      'KP'
     C                   MOVE      URRN          RRN              10 0
     C     RRN           CHAIN     CUNDC                              31
     C  N31              MOVEL     CEMAIL        EPOST
     C  N31              MOVE      CCOMPN        KUNDNR
     C                   END
     C                   ENDSR
     C*
     C***********************************************
     C     TEST          BEGSR
     C***********************************************
     C
      *
      *
     c                   setoff                                       30
     c                   setoff                                       707172
     C
      *
      *
      *
      * IKKE EPOST-ADRESSE LAGT INN
      *
     C     EPOST         ifeq      *BLANKS
     C                   SETON                                        3072
     C                   z-add     6             LINNBR
     C                   z-add     10            POSNBR
     C                   MOVE      'SHU0835'     MSGNR
     C                   GOTO      SLTB
      *
      * adresse må inneholde @
      *
     c                   else
     c                   movel     epost         star              1
     c     star          ifeq      '*'
     c                   movel     epost         dis7              7
     c                   move      dis7          dis6              6
     c     dis6          chain     distlh                             72
     c     *in(72)       ifeq      '1'
     C                   SETON                                        3072
     C                   MOVE      'SHU0915'     MSGNR
     C                   z-add     6             LINNBR
     C                   z-add     10            POSNBR
     C                   GOTO      SLTB
     c                   end
     c                   else
     C     '@'           SCAN      EPOST                                  62
     c     *in(62)       ifeq      '0'
     C                   SETON                                        3072
     C                   MOVE      'SHU0848'     MSGNR
     C                   z-add     6             LINNBR
     C                   z-add     10            POSNBR
     C                   GOTO      SLTB
     C                   END
     C                   END
     C                   END
     c     tilnr         ifeq      0
     c                   move      franr         tilnr
     c                   end
      *
     c     franr         ifeq      0
     c     franr         orgt      tilnr
     C                   MOVE      'SHU1260'     MSGNR
     c                   seton                                        3071
     C                   z-add     9             LINNBR
     C                   z-add     24            POSNBR
     c                   end
      *
     C*
     C     SLTB          ENDSR
     C*
