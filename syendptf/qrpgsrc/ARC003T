********************************************************************
********************************************************************
      * RETTINGER I DETTE PROGRAM:
PTFnr:*Sek Sig Vers  Beskrivelse...........................
""""""*"""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""
12XXX * 01 SH  PTF12 http rettelse
********************************************************************
""""""*"""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""
12XXX * XX XXX
      *
      ***********************************************************
      *** PROGRAM Som viser arkiverte dokumenter transp avregn***
      ***********************************************************
      *
     Faruserf   IF   E           K DISK
     FARKEXT    IF   E           K DISK
     FCUNDL01   IF   E           K DISK
     FTRAN      IF   E           K DISK
     FARKTXT    IF   E           K DISK
     FFIRMARC   IF   E           K DISK
     FFIRM      IF   E           K DISK
     FARKEPOW   UF A E           K DISK
     FARKIVL04  IF   E           K DISK
     FARKIVL04W IF   E           K DISK
     F                                     RENAME(arkivr:arkivr4)
     FARC003FT  CF   E             WORKSTN
     F                                     SFILE(SUBFIL:ZRECNO)
     F                                     INFDS(FBAREA)
     D                SDS
     D  UUSER                254    263
     D FBAREA          DS
     D  WSCLOC               370    371B 0
     D  WSSUBN               378    379B 0
n11  D                 DS
N11  D  ARUNDE                 1     10
N11  D  ARUND2                 1      2
n11  D                 DS
N11  D  ARDATE                 1      8  0
N11  D  ARAA                   3      4
N11  D  ARMM                   5      6
N11  D  ARDG                   7      8
n23  D                 DS
N23  D  WSDATO                 1      6  0
N23  D  WSDGA                  1      2
N23  D  WSMMA                  3      4
N23  D  WSAAA                  5      6
N13  D                 DS
N13  D  WSDATE                 1      8  0
N13  D  WSAA                   1      4
N13  D  WSMM                   5      6
N13  D  WSDD                   7      8
N13  D                 DS
N13  D  WSDATI                 1      6  0
N13  D  WSDDI                  1      2
N13  D  WSMMI                  3      4
N13  D  WSAAI                  5      6
N21  D                 DS
N21  D  XULTID                 1     14  0
N21  D  XULTM                  1      6  0
N21  D  XULDD                  7      8  0
N21  D  XULMM                  9     10  0
N21  D  XULÅÅ                 11     14  0
N21  D                 DS
N21  D  ULÅÅ                   1      4  0
N21  D  ULMM                   5      6  0
N21  D  ULDD                   7      8  0
N21  D  ULDT                   1      8  0
     C*
     C                   EXSR      INIT
     C*
     C     START         TAG
     C                   MOVE      '1'           *IN93
     C                   WRITE     SUBCTL
     C                   MOVEA     '00'          *IN(93)
     C                   Z-ADD     *ZEROS        ZRECNO
      *_____________
      * Fyll Subfile
      *"""""""""""""
     C     KEYS          SETGT     ARKIVL04
     C     START1        TAG
     C     KEYR          READPE    ARKIVL04                               94
     C  N94ARUND2        comp      'T:'                                   94
      *
      *
     C     START2        TAG
      *
N15  C                   DOW       *IN94 = *OFF
     C                   ADD       1             ZRECNO
     c                   move      'I'           IE                1
     c                   exsr      genbane
     c                   move      'E'           IE
     c                   exsr      genbane
     c     arinek        ifeq      'E'
n03  C                   movel     wsline        wslinw
     c                   else
n03  C                   movel     wslink        wslinw
     c                   end
N23  C                   move      artype        gmtype            2
n03  C                   movel     ARLINK        GMLINK          152
     C                   WRITE     SUBFIL
     C     KEYR2         chain     ARKIVL04w                          33
     c     *in33         ifeq      '0'
     C                   ADD       1             ZRECNO
     c                   move      'I'           IE                1
     c                   exsr      genbane
     c                   move      'E'           IE
     c                   exsr      genbane
     c     arinek        ifeq      'E'
n03  C                   movel     wsline        wslinw
     c                   else
n03  C                   movel     wslink        wslinw
     c                   end
N23  C                   move      artype        gmtype            2
n03  C                   movel     ARLINK        GMLINK          152
     C                   WRITE     SUBFIL
     c                   end
      *
     c     Next          tag
     C     KEYR          READPE    ARKIVL04                               94
     C  N94ARUND2        comp      'T:'                                   94
      *
      *
      * leser neste hvis både type og lenke er den samme
      *
     C                   END
N15   *
     C                   Z-ADD     ZRECNO        YRECNO            5 0
N15  C                   IF        ZRECNO > 1
N15  C                   EVAL      ZRECNO = 1
N15  C                   END
     C                   Z-ADD     6             LINNBR
     C                   Z-ADD     2             POSNBR
     C     START3        TAG
     C                   MOVEA     '11'          *IN(91)
     C     ZRECNO        IFEQ      0
     C                   write     NYWRK
     c                   goto      start6b
     C                   ELSE
     C                   WRITE     SUBCTL
     C                   EXFMT     BUNN
     C                   END
     C*
     C***
     C     WSCLOC        DIV       256           LINNBR
     C                   MVR                     POSNBR
     C                   Z-ADD     WSSUBN        XRECNO            4 0
     C     XRECNO        IFEQ      0
     C                   Z-ADD     ZRECNO        XRECNO            4 0
     C                   END
     C***
     C*
     C                   SETOFF                                       9899
     C*
     C*** AVSLUTT
     C   03              GOTO      SLUTT
     C   12              GOTO      SLUTT
     C*
     C*** FRISK OPP
     C   05              GOTO      START
     C*
     C*** SØK FRA
     C   08              GOTO      START6
     C*** skilleark
     C*
     C*   sende epost
     C*
     c     *in(10)       ifeq      '1'
N08  c     wsant         ifeq      0
     C                   MOVE      'SHU1298'     MSGNR
     c                   seton                                        30
n08  c                   goto      start
n08  c                   end
     c                   call      'ARC004'
n12  c                   parm                    aavd
n12  c                   parm                    aopd
n12  c                   parm                    atur              8
n12  c                   parm                    akun
     c                   exsr      antsr
     c                   goto      start
     c                   end
     C*
     c     *in(11)       ifeq      '1'
     c                   exsr      toemm
     c                   goto      start
     c                   end
     C*
     C*
     C     ZRECNO        IFNE      0
     C                   EXSR      HENTsr
     C                   END
     C   98XRECNO        IFNE      0
     C                   Z-ADD     XRECNO        ZRECNO
     C                   END
N04  C     ENDRET        IFEQ      'J'
N04  C                   GOTO      START
N04  C                   END
     C                   GOTO      START3
      *
      *** SØK FRA
      *
     C     START6        TAG
     C*
     C                   Z-ADD     22            LINNBR
     C                   Z-ADD     15            POSNBR
     C                   EXFMT     VAREL2
     C                   Z-ADD     6             LINNBR
     C                   Z-ADD     2             POSNBR
     C   12              GOTO      START3
     C   03              GOTO      slutt
     c     *in04         ifeq      '1'
     C     START6b       TAG
N56  C                   CALL      'SYTR04AA'
N56  C                   PARM                    VMTRAN
     c     vmtran        ifeq      0
     c                   goto      slutt
     c                   end
     c     keytran       chain     tran                               33
     c  N33              move      vmtrku        arkund
     c     keykun        CHAIN     CUNDL01                            33
     c                   goto      start
     c                   end
     c
     C                   GOTO      START
     C*
     C     SLUTT         TAG
     C                   SETON                                        LR
     C                   RETURN
     C*
     C*
     C***********************************************
     C     HENTSR        BEGSR
     C***********************************************
N04  C                   MOVE      ' '           ENDRET            1
     C                   Z-ADD     0             LINNBR
     C                   SETOFF                                       919299
     C     *IN98         DOWEQ     '0'
     C                   READC     SUBFIL                                 98
      * SLUTT PÅ FIL
     C   98              DO
     C   99              SETOFF                                       98
     C                   Z-ADD     1             LINNBR
     C                   GOTO      SLHENT
     C                   END
      * CURSOR
     C     ZRECNO        DIV       14            LINNBR
     C                   MVR                     XLIN              2 0
     C     XLIN          IFEQ      0
     C                   Z-ADD     14            LINNBR
     C                   ELSE
     C                   Z-ADD     XLIN          LINNBR
     C                   END
      *
     C     WSNR          IFEQ      'L'
     C     WSNR          oreq      'V'
N20  C     WSNR          oreq      'H'
N20  C     WSNR          oreq      'I'
N20  C     WSNR          oreq      'J'
N20  C     WSNR          oreq      'K'
     c                   exsr      EPOSR
     C                   MOVE      ' '           WSNR
     c                   update    subfil
     C                   END
      *
     C     SLHENT        TAG
     C                   ADD       5             LINNBR
     C                   Z-ADD     2             POSNBR
     c                   end
     C*
n18  C     SLHENT2       TAG
     C                   ENDSR
     C*
     C***********************************************
     C     INIT          BEGSR
     C***********************************************
     c     *entry        plist
     c                   parm                    transpa           8
     c                   move      transpa       arkund            8 0
     c                   move      'ta'          artype1
     c                   movel     '9999999'     arundem          10
     c                   move      *blanks       arbhis           30
      *
N21  C                   TIME                    XULTID
N21  C                   MOVE      XULDD         ULDD
N21  C                   MOVE      XULMM         ULMM
N21  C                   MOVE      XULÅÅ         ULÅÅ
      *
n20  C                   MOVE      ' '           EPMAIN
     C     keys          KLIST
     C                   KFLD                    ARKUND
     C                   KFLD                    ARTYPE1           2
     C                   KFLD                    ARUNDEM
     C     keyr2         KLIST
     C                   KFLD                    ARKUND
     C                   KFLD                    ARTYPE2
     C                   KFLD                    ARUNDE
     c                   move      'tb'          artype2           2
     C     keyr          KLIST
     C                   KFLD                    ARKUND
     C                   KFLD                    ARTYPE1
     C     keyepo        KLIST
     C                   KFLD                    UUSER
     C                   KFLD                    WSLINK
     C     keyep2        KLIST
     C                   KFLD                    UUSER
     C     arklagk       KLIST
     C                   KFLD                    fifirm
     C                   KFLD                    arklag
     C*
     c                   read      firm                                   33
     c     fifirm        chain     firmarc                            33
     c  n33uuser         chain     aruserf                            39
     c                   exsr      antsr
N04  C     KEYTRAN       KLIST
N04  C                   KFLD                    FIFIRM
N04  C                   KFLD                    VMTRAN
N04  C     KEYKUN        KLIST
N04  C                   KFLD                    FIFIRM
N04  C                   KFLD                    arKUND
     c     keykun        CHAIN     CUNDL01                            33
      *
N13  C                   MOVE      *ZEROS        WSDATE
     C                   ENDSR
     C*
     C***********************************************
     C     genbane       BEGSR
     C***********************************************
N23   * formater dato
N23  c                   move      ARAA          WSAAA
N23  c                   move      ARMM          WSMMA
N23  c                   move      ARDG          WSDGA
     c     keyext        klist
     c                   kfld                    fifirm
     c                   kfld                    arcext
s03  c*                  move      *blanks       wbane            70
n03  c                   move      *blanks       wbane           140
     c     artype        chain     ARKTXT                             33
     C     ARKLAG        IFNE      *blanks
     c     arklagk       chain     arkext
     c                   else
     c     fifirm        chain     firmarc                            33
     c                   end
     c
     C* genererer bane for lagring
     c     IE            ifeq      'I'
     c                   move      *blanks       wstex1
     c                   move      *blanks       wstex2
     c                   end
     C                   MOVE      'N'           vise              1
     C                   MOVE      ARAVD         AAVD              4
     C                   MOVE      AROPD         AOPD              7
     C                   move      *blanks       updf
n03  c                   movel     'http://'     updf            152
     c     ie            ifeq      'I'
N01  c                   if        ARCPSI='J'
N01  c                   eval      updf = 'https://'
N01  c                   endif
n17  c     arcpad        ifne      *blanks
     C     updf          CAT       arcpad:0      updf
n17  C     updf          CAT       '/':0         updf
n17  c                   end
     c                   else
n17  c     arcpae        ifne      *blanks
     C     updf          CAT       arcpae:0      updf
n17  C     updf          CAT       '/':0         updf
n17  c                   end
     c                   end
     c                   movel     '/'           wbane
     c     arcane        ifne      *blanks
N27  c     arbhis        ifne      *blanks
n27  c                   eval      arcane=arbhis
N27  c                   end
     C     updf          CAT       arcane:0      updf
     C     updf          CAT       '/':0         updf
     C     wbane         CAT       arcane:0      wbane
     C     wbane         CAT       '/':0         wbane
     c                   end
     C     updf          CAT       arlink:0      updf
     C     wbane         CAT       arlink:0      wbane
     C     '.pdf'        SCAN      updf                                   33
     C  N33'.PDF'        SCAN      updf                                   33
     C  N33'.'           SCAN      arlink                                 33
     C     arklag        IFeq      *blanks
     C     *in33         andeq     '0'
     C     updf          CAT       '.pdf':0      updf
     C     wbane         CAT       '.pdf':0      wbane
     C                   END
     c     ie            ifeq      'I'
     C                   movel     updf          wslink
     c     artype        chain     ARKTXT                             33
     c  n33              move      artxt         wstex1
N15  C                   END
      *faktura
     c                   move      *blanks       wstex2
     C                   movel     'Fanr:'       wstex2
     c                   movel     arunde        var07             7
     C     wstex2        CAT       var07:1       wstex2
     c                   move      var07         wsfanr            7 0
     C     wstex2        cat       'Til:':1      wstex2
     C     wstex2        cat       knavn:1       wstex2
     C                   movel     updf          wsline
      * tekst i  fritt felt kunderef skjøtes på..
     C     ARRFK         ifne      *blanks
S04  c     IE            andeq     'E'
     C                   CAT       ',':0         wstex2
     C                   CAT       ARRFK:1       wstex2
     c                   end
     c                   endsr
     C*
     C***********************************************
     C     eposr         BEGSR
     C***********************************************
     c                   setoff                                       30
     C* skriver til epost
     c     keyepo        chain     arkepow                            33
     C  n33              MOVE      'SHU0861'     MSGNR
     c  N33              seton                                        30
     c  N33              update    arkepor
     c     *in(33)       ifeq      '1'
     c                   move      uuser         epuser
     c                   movel     wslink        eplink
     c                   movel     wsline        epline
     c                   move      wstex1        eptex1
     c                   move      wstex2        eptex2
     C                   MOVE      *BLANKS       EPBANE
N20  c                   move      'N'           epmain
     c     wsnr          ifeq      'V'
N20  c     wsnr          oreq      'H'
N20  C     WSNR          oreq      'I'
N20  C     WSNR          oreq      'J'
N20  C     WSNR          oreq      'K'
     c                   move      wbane         epbane
N20  c                   move      wsnr          epmain
N20  c     wsnr          ifeq      'V'
N20  c                   move      'N'           epmain
N20  c                   end
     c                   end
     c                   write     arkepor
     c                   add       1             wsant
N12   *
N12   * tar vare på info fra siste dokument
N12   *
N12  c                   move      aravd         aavd              4
N12  c                   move      aropd         aopd              7
N12  c                   move      arkund        akun              8
N12  c                   movel     arunde        ar2               2
     c                   end
     c                   endsr
     C*
     C***********************************************
     C     antsr         BEGSR
     C***********************************************
     c                   z-add     0             wsant
     c     keyep2        setll     arkepow
     c                   setoff                                       34
     c     *in(34)       doweq     '0'
     c     keyep2        reade(N)  arkepow                                34
     c     *in(34)       ifeq      '0'
     c                   add       1             wsant
     c                   end
     c                   end
     c                   endsr
     C***********************************************
     C     toemm         BEGSR
     C***********************************************
     c                   setoff                                       34
     c     keyep2        setll     arkepow
     c     *in(34)       doweq     '0'
     c     keyep2        reade     arkepow                                34
     C*
     c     *in(34)       ifeq      '0'
     c                   delete    arkepor
     c                   end
     c                   end
     c                   z-add     0             wsant
     c                   endsr
N04  C*
