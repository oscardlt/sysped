     H Option( *SrcStmt ) DftActGrp( *No ) BndDir( 'QC2LE' )
      ****************************************************************************************
      * Hente-oppdrag,  Send instruksjonsmail                                                *
      ****************************************************************************************
********************************************************************
      * RETTINGER I DETTE PROGRAM:
PTFnr:*Sek Sig Vers  Beskrivelse...........................
""""""*"""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""
11XXX * 01 JOV PTF12 paramter for språk/webuser - hent avs-mailadrees (ved web)
********************************************************************
     FTurer14   IF   E           K DISK
     FHead11    IF   E           K DISK
     FFREETXT2  IF   E           K DISK
     FBRPARF    IF   E           K DISK
     FSYPARL3   IF   E           K DISK
     FFIRM      IF   E           K DISK
     FFIRMARC   IF   E           K DISK
     FFRISOK    IF   E           K DISK
      *__________
      * Variabler
      *""""""""""
     D FILE_o          s               *
     D String          s            512a
     D rc              s             10i 0
     D Data            s             80a   Varying
     D Codepage        s              5a   Varying
     D CmdLine         S            512
     D CmdLen          S             15  5
     D SDATA           S           1000
     D WFilNam         S            256
     D SMS             S             15
      *___________
      * Konstanter
      *"""""""""""
     D LF              c                   x'25'
      *___________________________
      * IFS Stream file funksjoner
      *"""""""""""""""""""""""""""
     Dopen             Pr              *   ExtProc( '_C_IFS_fopen' )
     D                                 *   Value Options( *String )
     D                                 *   Value Options( *String )

     Dfputs            Pr            10i 0 ExtProc( '_C_IFS_fputs' )
     D                                 *   Value Options( *String )
     D                                 *   Value

     Dclose            Pr            10i 0 ExtProc( '_C_IFS_fclose' )
     D                                 *   Value
     D                SDS
     D  ZUSER                254    263
      *
     D LINK            S            150
     D LINK2           S            150
     D MailSMS         S             70
     D Emne            S             70
     D AvAd            S             50
     D AvNa            S             50
     D Madr            S             50
     D timedata1       S               z                                        z=Timestamfield
     D                 DS
     D  HXSNDN                 1     20
     D  Snd17                  4     20
      *
     C                   EXSR      INIT
      *
      *
     C                   EXSR      LAGHENTM
     C                   EXSR      SendMail
      *
     C     SLUTT         TAG
     C                   MOVE      *ON           *INLR
     C                   RETURN
      *
      ******************************************************************************
     C     LAGHENTM      BEGSR
      ******************************************************************************
      * Lag fil og set codepage (pc)
     C                   time                    Timedata1
     C                   movel     timedata1     TS26             26            må være 26 lang
     C                   movel     TS26          TS               22
      *                                                 typisk TS er nå  2012-09-08-17.39.49.73
     C                   EVAL      WFilNam ='/SYSPEDDEV/TEMP/'
     C                                     + TS + '_' + TURNR + '.html'
     C                   EVAL      FILE_o = open( %TrimR( WFilNam )
     C                             : 'w, codepage=850' )
     C                   EVAL      rc = close( FILE_o )
     C                   EVAL      FILE_o = open( %TrimR( WFilNam )
     C                             : 'w' )
      *
      * LEGG UT HTML TOP / STYLE MM  (se f.esk SYSPED/HTMLSRC.EISO15 for inlin css.)
     C                   EVAL      SDATA  = '<HTML>'
     C                             + '<style type="text/css"> '
     c                             + 'th {font-size: 15pt; '
     c                             +    'font-family: arial, helvetica, helv; '
     c                             +    'font-weight: bold;}'
     c                             + 'td {font-size: 10pt; '
     c                             +    'font-family: arial, helvetica, helv; '
     c                             +    'font-weight: bold;}'
     c                             + 'BODY {'
     c                             + '  font-size:10pt;'
     c                             + '  font-family: arial,'
     c                             + '  helvetica, helv;'
     c**                           + '  background-color: #E6E6FA;'
     c                             + '  margin-top: 50px;'
     c                             + '  margin-right: 5px;'
     c                             + '  margin-bottom: 5px;'
     c                             + '  margin-left: 50px;'
     c                             + '} '
     c                             + '</style>  '
      * slå på Border ved utvikling (om en lager EN linje som ikke dekker 2 kolonner blir det surr.)
     c*                            + '<Body><table width="500" border="1">'
     c                             + '<Body><table width="500">'
     C                   EVAL      rc = fputs(%trimr(SDATA) + LF: File_o)       Skriv til IFS-fil
      *
      *
     C                   Eval      EMNE  =  %trim(FIFT)
     C                                    +' Godsliste for tur '
     C                                    +%trim(%editc(TUPRO:'Z'))
     C                                    +' Bil: ' +TUBILN
      *
      * merknad gitt i bestillingsbildet ?
     c                   if        UUMERK <> *blanks
     C                   EVAL      SDATA  = '<tr><td colspan=2>'
     C                                    + '<b>Merknad: '+%trim(UUMERK)+'</b>'
     c                                    + '</td></tr>'
     C                   EVAL      rc = fputs(%trimr(SDATA) + LF: File_o)
      * <hr> = horisontal line
     C                   EVAL      SDATA  = '<tr><td colspan=2><hr></td></tr>'
     C                   EVAL      rc = fputs(%trimr(SDATA) + LF: File_o)
     c                   endif
      *
      *
     C     TUPRO         setll     HEAD11
     C     TUPRO         reade     HEAD11
     C                   dow       not %eof
      *
     C                   EXSR      HOVED
      *
     C     TUPRO         reade     HEAD11
     c                   enddo
     C                   EXSR      BUNN
      * close file
     C                   EVAL      rc = close( FILE_o )
      *
     C                   ENDSR
      *
      ******************************************************************************
     C     HOVED         BEGSR
      ******************************************************************************
      *
     C                   Movel     HEAVD         AvdOpd           11
     C                   Move      HEOPD         AvdOpd
      * Fraktbrevsnr fra frie søkeveier ..
     c                   if        Snd17 = *blanks
     c     IFBkey        chain     FRISOK
     c                   if        %found
     c                   eval      Snd17 = FSSOK
     c                   endif
     c                   endif
      *
     C                   EVAL      SDATA  = '<tr><td colspan=2>'
     C                                    + '<b>Posisjon: ' + %trim(HEPOS1)
     C                                    + '&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'
     C                                    + '</b>Senders ref: ' + %trim(HERFA)
     C                                    + '&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'
     C                                    + 'Vår ref:'
     C                                    + %trim(%editc(HEAVD:'Z'))+'/'
     C                                    + %trim(%editc(HEOPD:'Z'))
     C                                    + '&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'
     C                                    + 'Sendingsnr: '+Snd17
     c                                    + '</td></tr>'
     C                   EVAL      rc = fputs(%trimr(SDATA) + LF: File_o)
      *
     C                   EVAL      SDATA  = '<tr><td>'
     C                             + 'Hentested/tid: <b>'
     C                             + %trim(%editw(TRSDFD:'    .  .  '))
     C                             + ' '
     C                             + %trim(%editw(TRSDFK:'  :  '))
     C                             + '</b></td><td>'
     C                             + 'Lever.sted/tid: <b>'
     C                             + %trim(%editw(TRSDTD:'    .  .  '))
     C                             + ' '
     C                             + %trim(%editw(TRSDTK:'  :  '))
     C                             + '</b></td><td></tr>'
     C                   EVAL      SDATA  = %trim(SDATA )
     c                                    + '</td></tr>'
     C                   EVAL      rc = fputs(%trimr(SDATA) + LF: File_o)
      *
     C                   EVAL      SDATA  = '<tr><td>'
     C                             + '&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'
     c                             + HENAS  + '</td><td>'
     C                             + '&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'
     c                             + HENAK  + '</td></tr>'
     C                   EVAL      rc = fputs(%trimr(SDATA) + LF: File_o)
      *
     C                   EVAL      SDATA  = '<tr><td>'
     C                             + '&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'
     c                             + HEADS1 + '</td><td>'
     C                             + '&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'
     c                             + HEADK1 + '</td></tr>'
     C                   EVAL      rc = fputs(%trimr(SDATA) + LF: File_o)
      *
     c                   IF        HEADS2<>*blanks or HEADK2<>*blanks
     C                   EVAL      SDATA  = '<tr><td>'
     C                             + '&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'
     c                             + HEADS2 + '</td><td>'
     C                             + '&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'
     c                             + HEADK2 + '</td></tr>'
     C                   EVAL      rc = fputs(%trimr(SDATA) + LF: File_o)
     C                   endif
      *
     C                   EVAL      SDATA  = '<tr><td>'
     C                             + '&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'
     c                             + HEADS3 + '</td><td>'
     C                             + '&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'
     c                             + HEADK3 + '</td></tr>'
     C                   EVAL      rc = fputs(%trimr(SDATA) + LF: File_o)
      *
      *
     C                   EVAL      SDATA  = '<tr><td colspan=2>&nbsp;</td></tr>'        Blank
     C                   EVAL      rc = fputs(%trimr(SDATA) + LF: File_o)
      *
      * Varelinje/gosmerke på samme linje..
     C                   EVAL      SDATA  = '<tr><td colspan=2><b>'
     C                                    + %trim(%editc(HENT:'Z'))
     C                             + '</b> ' + %trim(HEVS1)
     C                   if        HEVS2<>' '
     C                   EVAL      SDATA  = %trim(SDATA ) +', '
     C                             + %trim(HEVS2)
     c                   endif
     C                   EVAL      SDATA  = %trim(SDATA )
     C                             + '&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'
     C                             + 'Vekt: <b>'+ %trim(%editc(HEVKT:'Z'))
     C                             + '</b>'
     C                   if        HEM3<>0
     C                   EVAL      SDATA  = %trim(SDATA )
     C                             + '&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'
     C                             + 'Volum M3: <b>'+ %trim(%editc(HEM3:'4'))
     C                             + '</b>'
     c                   endif
     C                   if        HELM<>0
     C                   EVAL      SDATA  = %trim(SDATA )
     C                             + '&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'
     C                             + 'Lastemeter: <b>'
     C                             + %trim(%editc(HELM:'4'))
     C                             + '</b>'
     c                   endif
     c                   if        HEGM1<>' '
     C                   EVAL      SDATA  = %trim(SDATA )
     C                             + '&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'
     C                             + 'Merking: '+ %trim(HEGM1)
     c                   endif
     C                   if        HEGM2<>' '
     C                   EVAL      SDATA  = %trim(SDATA ) +', '
     C                             + %trim(HEGM2)
     c                   endif
     C                   EVAL      SDATA  = %trim(SDATA ) + '</td></tr>'
     C                   EVAL      rc = fputs(%trimr(SDATA) + LF: File_o)
      *
      *
     C                   EVAL      SDATA  = '<tr><td colspan=2>&nbsp;</td></tr>'          Blank
     C                   EVAL      rc = fputs(%trimr(SDATA) + LF: File_o)
      * LINKER SKRIVES 2 OG 2 (EN I HVER KOLONNE)
      * selve linken for fraktbrevsprint
     C                   EVAL      LINK   = 'http://'
     C                             + %trim(ARCPAE) + '/sycgip/syfa12es.pgm'
     c                             +'?user='+%trim(SYVRDA)
     c                             +'&avd='+%trim(%editc(HEAVD:'Z'))
     c                             +'&opd='+%trim(%editc(HEOPD:'Z'))
      *
      * selve linken for CMR
     C                   EVAL      LINK2  = 'http://'
     C                             + %trim(ARCPAE) + '/sycgip/esop11cm.pgm'
     c                             +'?user='+%trim(SYVRDA)
     c                             +'&avd='+%trim(%editc(HEAVD:'Z'))
     c                             +'&opd='+%trim(%editc(HEOPD:'Z'))
      *
     C                   EVAL      SDATA  = '<tr><td>'
     C                                    + '<a href="'+%trim(LINK)
     c                                    + '" target="PfW">'
     c                                    + 'Klikk her for å skrive ut '
     c                                    + 'fraktbrev.'
     c                                    + '</a></td><td>'
     C                                    + '<a href="'+%trim(LINK2)
     c                                    + '" target="PfW">'
     c                                    + 'Klikk her for å skrive ut '
     c                                    + 'CMR-fraktbrev.'
     c                                    + '</a></td></tr>'
     C                   EVAL      rc = fputs(%trimr(SDATA) + LF: File_o)
      *
      * selve linken for labelprint
     C                   EVAL      LINK   = 'http://'
     C                             + %trim(ARCPAE) + '/sycgip/ss115.pgm'
     c                             +'?user='+%trim(SYVRDA)+'&curtur='+AvdOpd
     c                             +'&labeltyp=L&lay=HE&copyprt=J'
      * linken for spørring oppdrag
     C                   EVAL      LINK2  = 'http://'
     C                             + %trim(ARCPAE) + '/sycgip/syso02.pgm'
     c                             +'?user='+%trim(SYVRDA)
     c                             +'&UsrSpcName=InT5WXz4BJ'
     c                             +'&heavd='+%trim(%editc(HEAVD:'Z'))
     c                             +'&heopd='+%trim(%editc(HEOPD:'Z'))
     C                   EVAL      SDATA  = '<tr><td>'
     C                                    + '<a href="'+%trim(LINK)
     c                                    + '" target="PmW">'
     c                                    + 'Klikk her for å skrive ut '
     c                                    + 'merkelapper.'
     c                                    + '</a></td><td>'
     C                                    + '<a href="'+%trim(LINK2)
     c                                    + '" target="SoW">'
     c                                    + 'Klikk her for oppdragsstatus og '
     c                                    + 'flere detaljer'
     c                                    + '</a></td></tr>'
     C                   EVAL      rc = fputs(%trimr(SDATA) + LF: File_o)
      *
     C                   EVAL      SDATA  = '<tr><td colspan=2>&nbsp;</td></tr>'          Blank
     C                   EVAL      rc = fputs(%trimr(SDATA) + LF: File_o)
      * meld til transp
     C                   EXSR      FRITRANS
      *
      * <hr> = horisontal line
     C                   EVAL      SDATA  = '<tr><td colspan=2><hr></td></tr>'
     C                   EVAL      rc = fputs(%trimr(SDATA) + LF: File_o)
      *
      *
     C                   ENDSR
      *
      *
      ******************************************************************************
     C     FRITRANS      BEGSR
      ******************************************************************************
      *
     C                   MOVE      'N'           XLEDERTXT         1
     C                   EVAL      FRTKOD = 'G'
     C     FREETXT2K     SETLL     FREETXT2
     C     FREETXT2K     READE     FREETXT2                               33
     C                   DOW       *IN33 = *OFF
      *
     C                   IF        XLEDERTXT = 'N'
     C                   EVAL      SDATA  = '<tr><td colspan=2>'
     C                                    + 'Melding til transportør:'
     c                                    + '</td></tr>'
     C                   EVAL      rc = fputs(%trimr(SDATA) + LF: File_o)
     C                   MOVE      'J'           XLEDERTXT         1
     C                   END
      *
     C                   EVAL      SDATA  = '<tr><td colspan=2>'
     C                             + '&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b>'
     C                             + %trim(FRTTXT)
     c                             + '</b></td></tr>'
     C                   EVAL      rc = fputs(%trimr(SDATA) + LF: File_o)
      *
     C     FREETXT2K     READE     FREETXT2                               33
     C                   ENDDO
      *
     C                   ENDSR
      *
      *
      ******************************************************************************
     C     BUNN          BEGSR
      ******************************************************************************
      *
     C                   EVAL      SDATA  = '<tr><td>&nbsp;</td></tr>'          blank
     C                   EVAL      rc = fputs(%trimr(SDATA) + LF: File_o)
      *
     C                   EVAL      SDATA  = '<tr><td colspan=2>'
     C                                    + 'Med vennlig hilsen'
     c                                    + '</td></tr>'
     C                   EVAL      rc = fputs(%trimr(SDATA) + LF: File_o)
     C                   EVAL      SDATA  = '<tr><td colspan=2>'
     C                                    + FIFT
     c                                    + '</td></tr>'
     C                   EVAL      rc = fputs(%trimr(SDATA) + LF: File_o)
      *
     C                   EVAL      SDATA  = '<tr><td colspan=2>'
     C                                    + '<img src="http://'+%trim(ARCPAE)
     c                                    + '/syspeddev/systematop1.jpg">'
     c                                    + '</td></tr>'
     C                   EVAL      rc = fputs(%trimr(SDATA) + LF: File_o)
      *
     C                   EVAL      SDATA  = '<tr><td colspan=2>'
     C                                    + 'Telefon ' + TLF
     C                                    + '</td></tr>'
     C                   EVAL      rc = fputs(%trimr(SDATA) + LF: File_o)
      *
     C                   EVAL      SDATA  = '<tr><td colspan=2>'
     C                                    + 'Denne eposten er skapt'
     C                             + ' automatisk av booking systemet.'
     c                                    + '</td></tr>'
     C                   EVAL      rc = fputs(%trimr(SDATA) + LF: File_o)
      *
     C                   EVAL      SDATA  = '<tr><td colspan=2>'
     C                                    + 'Vennligst ikke svar på den.'
     c                                    + '</td></tr>'
     C                   EVAL      rc = fputs(%trimr(SDATA) + LF: File_o)
      *
     C                   EVAL      SDATA  = '</table></Body></HTML>'
     C                   EVAL      rc = fputs(%trimr(SDATA) + LF: File_o)
      *
     C                   ENDSR
      *
      *
      ******************************************************************************
     C     INIT          BEGSR
      ******************************************************************************
     C     *ENTRY        PLIST
     C                   PARM                    TURNR             8
     C                   PARM                    UUMAIL           50
     C                   PARM                    UUMERK           50
     c                   parm                    WebUser          10            Blank
     c                   parm                    WSSPRAK           2
      *
     C                   MOVE      TURNR         TUPRO
     C     TUPRO         CHAIN     TURER14
     c                   if        not %found
     c                   seton                                        LR
     c                   return
     c                   endif
      *
N01  c                   move      ZUSER         WSUSER           10
N01  c                   if        WebUser <> *blanks
N01  C                   MOVE      WebUser       PABRID
N01  C                   MOVE      'ASUSR'       PAID
N01  C     BrParKey      chain     BRPARF                             33
N01  C  N33              MOVEL     PAVRDA        WSUSER
N01  C                   endif
      *
S01  c*                  call      'SYGE73CL'
S01  c*                  parm                    epostf           70
S01  c                   call      'EPOS04'
N01  c                   parm                    WSUSER
N01  c                   parm                    DIRENA            8
N01  c                   parm                    DIREAD            8
N01  c                   parm                    epostf           70
     C                   EVAL      AvNa =epostf
     C                   EVAL      AvAd =epostf
     C                   EVAL      Madr   = UUMAIL
     c     FREETXT2K     klist
     c                   kfld                    HEAVD
     c                   kfld                    HEOPD
     c                   kfld                    FRTKOD
     c     IFBkey        klist
     c                   kfld                    HEAVD
     c                   kfld                    HEOPD
     c                   kfld                    FSKODE
     c                   move      'IFB'         FSKODE
      *
     c     sypak         klist
     c                   kfld                    sykd              5
     c                   move      'ESUSR'       SYKD
     c     sypak         chain     SYPARL3                            33
     C   33              EVAL      SYVRDA = 'NN'
      *
     C     *LOVAL        SETLL     FIRM
     C                   READ      FIRM                                   33
      *
     C     FIFIRM        CHAIN     FIRMARC                            33
      *
      * hent telefonnr
     C     BrParKey      klist
     C                   kfld                    PABRID
     C                   kfld                    PAKUNR
     C                   kfld                    PAID
     C                   EVAL      PABRID = '*KUNDFT*' + %TRIM(FIFIRM)
     C                   MOVE      'TLF  '       PAID
     C     BrParKey      CHAIN     BRPARF                             33
     c  n33              movel     PAVRDA        TLF              20
      *
     C                   CALL      'SYGE15C'
     C                   PARM                    WDT               8
     C                   PARM                    WTM               6
     C                   ENDSR
      *
      *
      ******************************************************************************
     C     SendMail      BEGSR
      ******************************************************************************
      * Send via MMAIL
     C                   EVAL      CmdLine = 'ADDLIBLE MMAIL'
     C                   EVAL      CmdLen = %len(%trim(CmdLine))
     C                   CALL      'QCMDEXC'                            98
     C                   PARM                    CmdLine
     C                   PARM                    Cmdlen
      *
      * Appo i Emne gir error/sender ikke i MMMAIL (uten at bruker får varsel)
     c     x'7D':'"'     xlate     EMNE          EMNE
     C                   EVAL      CmdLine = 'EMLHTML SUBJECT('+ X'7D'
     C                             + %trimr(Emne) + X'7D' + ') '
     C                             + 'FROMNAME(' + X'7D'
     C                             + %trimr(AvNa) + X'7D' + ') '
     C                             + 'FROMADDR('  + X'7D'
     C                             + %trimr(AvAd) + X'7D' + ') '
     C                             + 'TO('+ X'7D'+%trimr(Madr)+ X'7D'+'/'+ X'7D'
     C                             + %trimr(Madr)+ X'7D'+'/*TO) '
     C                             + 'STMF('+ X'7D'+%trimr(WFilNam)+ X'7D'+ ')'
     C                   EVAL      CmdLen = %len(%trim(CmdLine))
     C                   CALL      'QCMDEXC'                            98
     C                   PARM                    CmdLine
     C                   PARM                    Cmdlen
      *
     C                   EVAL      CmdLine = 'RMVLIBLE MMAIL'
     C                   EVAL      CmdLen = %len(%trim(CmdLine))
     C                   CALL      'QCMDEXC'                            98
     C                   PARM                    CmdLine
     C                   PARM                    Cmdlen
      *
     C                   ENDSR
      *
