     FTRIH09    IF   E           K DISK
     FEDIM2     IF   E           K DISK
     FKALENDER  IF   E           K DISK
     FKALENDER1 IF   E           K DISK    RENAME(KALENDERR:KALENDERR1)
     FKALENDER2 IF   E           K DISK    RENAME(KALENDERR:KALENDERR2)
     FTR077D    CF   E             WORKSTN
     F                                     SFILE(SUBFIL:ZRECNO)
     D                 DS
     D  TIGN                   1     35
     D  TIGN15                 1     15
     D  TIGN1                  1      4
     D  TIGN2                 10     12
     D  TIGN3                 15     15
      *//////////////
      *  Hodelogikk /
      *//////////////
     C                   EXSR      SRA
      *
     C     START         TAG
     C                   EXFMT     BILDE
     C                   MOVEA     '000'         *IN(97)
     C   03              GOTO      SLUTT
      *
     C     WSDTF         CHAIN     KALENDER                           99
     C   99              GOTO      START
     C     WSDTT         CHAIN     KALENDER                           98
     C   98              GOTO      START
     C     WSDTF         COMP      WSDTT                              97
     C   97              GOTO      START
      *
     C                   EXSR      SRB
     C   12              GOTO      START
      *
     C     SLUTT         TAG
     C                   MOVE      '1'           *INLR
     C                   RETURN
      *
      *////////////////////////////////////////////////////////////
      *  Initiering                                           SRA /
      *////////////////////////////////////////////////////////////
     C     SRA           BEGSR
      *__________________
      * Definiere Nøkkler
      *""""""""""""""""""
     C     KALENDER2K    KLIST
     C                   KFLD                    KAYEAR
     C                   KFLD                    KADGNR
     C     EDIM2K        KLIST
     C                   KFLD                    TIAVD
     C                   KFLD                    TITDN
      *
     C                   MOVE      *ZEROS        WSDTF
     C                   MOVE      *ZEROS        WSDTT
     C                   MOVE      'N'           WSADJN
      *
     C                   ENDSR
      *
      *////////////////////////////////////////////////////////////
      *  Bearbeide Formater                                   SRB /
      *////////////////////////////////////////////////////////////
     C     SRB           BEGSR
      *______________
      * Tømme Subfile
      *""""""""""""""
     C     SRB1          TAG
     C                   MOVE      '1'           *IN93
     C                   WRITE     SUBCTL
     C                   MOVEA     '00'          *IN(93)
     C                   Z-ADD     *ZERO         ZRECNO
      *_____________
      * Fyll Subfile
      *"""""""""""""
     C     WSDTF         SETLL     TRIH09
     C     SRB2          TAG
     C                   READ      TRIH09                                 94
     C  N94WSDTT         COMP      TIDT                                 94
     C                   IF        *IN94
     C                   EVAL      *IN12 = '1'
     C                   GOTO      SRB9
     C                   END
     C                   EXSR      SRSJDT
     C     XOK           CABNE     'J'           SRB2
      *
     C     SRB4          TAG
      *
     C  N94              DO
     C                   DO        16
     C                   ADD       1             ZRECNO
     C                   WRITE     SUBFIL
     C     SRB41         TAG
     C                   READ      TRIH09                                 94
     C  N94WSDTT         COMP      TIDT                                 94
     C  N94              EXSR      SRSJDT
     C  N94XOK           CABNE     'J'           SRB41
     C  N94              END
     C                   END
      *
     C  N94              MOVE      TIAVD         X_AVD             4 0
     C  N94              MOVE      TITDN         X_TDN             7 0
     C  N94              MOVE      TIGN          X_GN             35
     C  N94              MOVE      TITRNR        X_TRNR           18
     C  N94              MOVE      WSGDT         X_GDT             8 0
     C  N94              MOVE      WSADT         X_ADT             8 0
     C  N94              MOVE      WSANTD        X_ANTD            3 0
      *_______________
      * Behandle bilde
      *"""""""""""""""
     C     VISSUB        TAG
     C                   MOVEA     '11'          *IN(91)
     C                   WRITE     BUNN
     C                   EXFMT     SUBCTL
      *
     C     *IN03         CABEQ     '1'           SRB9
     C     *IN05         CABEQ     '1'           SRB1
     C     *IN12         CABEQ     '1'           SRB9
      *
     C                   MOVEA     '00'          *IN(91)
      *_______
      * ROLLUP
      *"""""""
     C     *IN25         IFEQ      '1'
     C                   MOVE      '0'           *IN25
     C                   GOTO      SRB4
     C                   END
      *
     C                   EXSR      HENT
     C                   GOTO      VISSUB
      *
     C     SRB9          ENDSR
      *
     C***********************************************
     C     HENT          BEGSR
     C***********************************************
     C                   Z-ADD     ZRECNO        GMREC             5 0
     C                   SETOFF                                       98
     C     *IN98         DOWEQ     '0'
     C                   READC     SUBFIL                                 98
     C     *IN98         IFEQ      '0'

     C                   SELECT
     C     WSNR          WHENEQ    5
     C                   EXSR      DSPTRH
     C     WSNR          WHENEQ    9
     C                   EXSR      DSPTVI
     C     WSNR          WHENEQ    45
     C                   EXSR      DLSTRH
     C                   ENDSL
     C                   END
     C                   END
      *
      *
     C                   MOVE      X_AVD         TIAVD
     C                   MOVE      X_TDN         TITDN
     C                   MOVE      X_GN          TIGN
     C                   MOVE      X_TRNR        TITRNR
     C                   MOVE      X_GDT         WSGDT
     C                   MOVE      X_ADT         WSADT
     C                   MOVE      X_ANTD        WSANTD
     C                   Z-ADD     GMREC         ZRECNO
      *
     C                   ENDSR
      *
     C***********************************************
     C     SRSJDT        BEGSR
     C***********************************************
     C                   MOVE      'N'           XOK               1
     C                   IF        TIGN3 <> ' '
      * HENT GODSDATO
     C                   MOVE      TIGN1         KAYEAR
     C                   MOVE      TIGN2         KADGNR
     C     KALENDER2K    CHAIN     KALENDER2                          33
     C                   MOVE      KADATE        WSGDT
      *
     C                   IF        WSADJN = 'J'
      * HENT GODSDATO + 1 ARBEIDSDAG
     C     WSGDT         SETGT     KALENDER1
     C                   READ      KALENDER1                              33
     C                   ELSE
      * HENT GODSDATO + 1 DAG
     C     WSGDT         SETGT     KALENDER
     C                   READ      KALENDER                               33
     C                   END
     C                   MOVE      KADATE        WSGDT1            8 0
      * HENT IE44-DATO
     C                   MOVE      *ZEROS        WSADT
     C     EDIM2K        SETLL     EDIM2
     C     EDIM2K        READE     EDIM2                                  33
     C                   DOW       *IN33 = *OFF
     C                   IF        M1N07 = '044'
     C                   MOVE      MDT           WSADT
     C                   END
     C     EDIM2K        READE     EDIM2                                  33
     C                   ENDDO
      *
     C*                  IF        WSGDT >= WSADT - 1 AND WSADT <> 0
     C                   IF        WSGDT1 < WSADT OR WSADT = 0
     C                   MOVE      'J'           XOK               1
      * BEREGN ANTALL DAGER
     C                   IF        WSADT = 0
     C                   EVAL      WSANTD = 999
     C                   ELSE
     C     WSGDT         CHAIN     KALENDER                           33
     C                   EVAL      WSANTD = 0
     C                   DOW       *IN33 = *OFF
     C                   READ      KALENDER                               33
     C  N33              EVAL      WSANTD = WSANTD + 1
     C  N33WSADT         COMP      KADATE                               3333
     C                   ENDDO
     C                   END
     C                   END
      *
     C                   END
      *
     C                   ENDSR
      *
     C***********************************************
     C     DSPTRH        BEGSR
     C***********************************************
     C                   MOVE      'DSP'         XTYPE             3
     C                   CALL      'TR061C'
     C                   PARM                    TIAVD
     C                   PARM                    TITDN
     C                   PARM                    TISG
     C                   PARM                    XTYPE
     C                   PARM                    UFLAGG            1 0
     C     UFLAGG        IFEQ      3
     C                   MOVE      '1'           *INLR
     C                   RETURN
     C                   END
     C                   MOVE      *ZEROS        WSNR
     C                   UPDATE    SUBFIL
      *
     C                   ENDSR
      *
     C***********************************************
     C     DSPTVI        BEGSR
     C***********************************************
     C                   MOVE      '3'           WIN03             1
     C                   CALL      'SAD003'
     C                   PARM      TIAVD         TIAVD
     C                   PARM      TITDN         TITDN
     C                   PARM                    WIN03
     C     WIN03         IFEQ      '1'
     C                   MOVE      '1'           *INLR
     C                   RETURN
     C                   END
     C                   MOVE      *ZEROS        WSNR
     C                   UPDATE    SUBFIL
      *
     C                   ENDSR
      *
     C***********************************************
     C     DLSTRH        BEGSR
     C***********************************************
     C                   MOVE      'DSP'         XTYPE             3
     C                   CALL      'TR064C'
     C                   PARM                    TIAVD
     C                   PARM                    TITDN
     C                   PARM                    XTYPE
     C                   PARM                    UFLAGG            1 0
     C                   MOVE      *ZEROS        WSNR
     C                   UPDATE    SUBFIL
      *
     C                   ENDSR
      *
