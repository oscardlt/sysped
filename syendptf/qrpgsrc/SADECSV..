********************************************************************
      * RETTINGER I DETTE PROGRAM:
PTFnr:*Sek Sig Vers  Beskrivelse...........................
""""""*"""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""
12XXX * 01 SH  PTF12 skriv til sadl
12XXX * 02 SH  PTF12 lager arkivpost for PDF
12147 * 03 SH  PTF12 innført syge111
12147 *    SH  PTF12 *TOTALT OMSKREVET *  uten merking
12147 * 04 SH  PTF12 REGISTER  AUTOFORTOLLING
12147 * 05 SH  PTF12 skriver ikke tomme pdf
********************************************************************
      * sad eksport inn fra CSV fil
      *
N04  FNAVAUTKE  IF   E           K DISK
     Fautokunde IF   E           K DISK
     FEDIS4     UF   E           K DISK
N02  FARKIVP    o  a e             DISK
N02  FFIRMNA    IF   E           K DISK
N02  FFIRM      IF   E           K DISK
     FTARI      IF   E           K DISK
     FEDIRE1K   IF   E           K DISK
     FZTELL     UF   E           K DISK
s01  F*ADL      IF   E           K DISK
n01  FSADL      IF A E           K DISK
     FZAEF      O    E             DISK
     FZAEV      O    E             DISK
     FKODTVAL2  IF   E           K DISK
N02  D                 DS
N02  D  dtafld                 1  54000
N02  D                                     DIM(180)
     D                 DS
     D  RDATA                  1   1024
     D  RTYP1                  1      6
     D  RTYP2                 13     22
     D                 DS
     D  FE                     1    256
     D                                     DIM(256)
     D  FELT                   1    256
     D                 DS
     D  AA                     1   1024
     D                                     DIM(1024)
     D  AADS                   1   1024
     D                 DS
     D  ZDEC                   1      7  6
     D  ZDEC6                  2      7
     D  ZHEL                  11     22  0
     D                 DS
     D  A                      1     79
     D                                     DIM(79)
     D                 DS
     D  B                      1     18
     D                                     DIM(18)
     D                 DS
     D  WTARIFF                1     10
     D  WTAR08                 1      8
     D  WTAR06                 1      6
     C                   EXSR      SRINIT
     C     UMBR          SETLL     EDIRE1K
     C     UMBR          READE     EDIRE1K                                91
     C     *IN91         DOWEQ     *OFF

     C     'Export'      SCAN      RDATA                                  33
     C  N33'Ekspor'      SCAN      RDATA                                  33
     C                   SELECT
     C                   WHEN      *IN33
     C                   EXSR      SRFAKT
     C                   OTHER
     C                   EXSR      SRVAR
     C                   ENDSL

     C     UMBR          READE     EDIRE1K                                91
     C                   ENDDO

N02  C                   exsr      arksr
     C     LR            TAG
     C                   MOVE      '1'           *INLR
      *****************************************************************
     C     SRINIT        BEGSR
      *****************************************************************
     C     *ENTRY        PLIST
     C                   PARM                    UMBR             10
      * Hente dagens dato og tid
     C                   CALL      'SYGE15C'
     C                   PARM                    WDT               8
     C                   PARM                    WTM               6
      *
     C     KODVAK        KLIST
     C                   KFLD                    SFVK28
     C                   KFLD                    WKVADT
      * Definisjon av arbetsfelt
     C     *LIKE         DEFINE    SVLI          WVLI
     C     *LIKE         DEFINE    KVADT         WKVADT
     C                   MOVEL     WDT           WKVADT
      * Hent unikt nummer for Z-filer
N02  c                   read      firm                                   33
N02  C     FIFIRM        CHAIN     FIRMNA                             33
s02  C*    '01'          CHAIN     ZTELL
N02  C     FIFIRM        CHAIN     ZTELL
     C                   ADD       1             ZUNIK
     C                   UPDATE    ZTELLR
      *
     C                   ENDSR
      *********************************************************************
     C     SRFAKT        BEGSR
      *********************************************************************
N03  C                   MOVEL     RDATA         UDATA          4096
n03  C                   MOVEL     *BLANKS       UARRA         54000
n03  C                   MOVE      ';'           SKILLET           1
n03  C                   CALL      'SYGE111'
n03  C                   PARM                    SKILLET
n03  C                   PARM                    UDATA
n03  C                   PARM                    UARRA
n03  c                   movea     uarra         dtafld
      *
      * Header opplysninger
      * Init
     C                   EVAL      SFUNIK = ZUNIK
     C                   MOVEL     RDATA         AADS
     C                   Z-ADD     1             WX                4 0
      * 1. Fast verdi export tollklarering
      *
      *
      * 2.  kundenummer
      *
     C                   MOVEA     dtafld(2)     A
     C                   EXSR      GETNUM
     C                   Z-ADD     ZNUM          SLKNR
     C                   Z-ADD     0             NULLKU            8 0
n04  C     Slknr         CHAIN     NAVAUTKE                           44
     C     SLKNR         CHAIN     AUTOKUNDE                          44
     C   44NULLKU        CHAIN     AUTOKUNDE                          44
      *
      *
      * 3. Fakturanr
     C                   EVAL      SFTXT=dtafld(3)
     C                   EVAL      SFREFF=dtafld(3)
     c                   move      *blanks       s0020n           30
     C                   EVAL      S0020N = %TRIM(SFTXT) + ':' +
     c                             %trim(%editc(SLKNR:'Z'))
     c     umbr          chain     edis4                              66
     c     *in66         ifeq      '0'
     c                   movel     s0020n        s0020
     c                   update    edisr
     c                   end
      * 4. Eksportdate
     C                   MOVEA     dtafld(4)     A
     C                   EXSR      GETNUM
     C                   Z-ADD     ZNUM          SFDT
      * 5. Valutakode
     C                   EVAL      SFVK28=dtafld(5)
     C     SFVK28        IFEQ      *blanks
     C                   MOVE      'NOK'         SFVK28
     c                   end
      *
     C     KODVAK        SETGT     KODTVAL2
     C     SFVK28        READPE    KODTVAL2                               33
     C                   IF        *IN33 = *OFF
     C                   EVAL      SFKR28 = KVAKRS
     C                   EVAL      SFOM28 = KVAOMR
N02  C                   end
      *
      * 6. fakturabeløp
     C                   MOVEA     dtafld(6)     A
     C                   EXSR      GETNUM
     C                   Z-ADD     ZNUM          SFBL28
      *
      * 7. Bruttovekt
     C                   MOVEA     dtafld(7)     A
     C                   EXSR      GETNUM
     C                   Z-ADD     ZNUM          Bruttov          13 2
      *
      * 8. Fil pdf
N02  C                   move      *blanks       filpdf           60
     C                   EVAL      FILPDF=dtafld(8)
      *
S02  C*                  ENDIF
      *
N01  C                   move      slknr         SFXXX
     C                   WRITE     SADFR
      *
     C                   ENDSR
      *
      ***************************************************************
     C     SRVAR         BEGSR
      ***************************************************************
N03  C                   MOVEL     RDATA         UDATA          4096
n03  C                   MOVEL     *BLANKS       UARRA         54000
n03  C                   MOVE      ';'           SKILLET           1
n03  C                   CALL      'SYGE111'
n03  C                   PARM                    SKILLET
n03  C                   PARM                    UDATA
n03  C                   PARM                    UARRA
n03  c                   movea     uarra         dtafld
     C                   CLEAR                   SAEVR
     C                   ADD       1             WVLI
     C                   MOVE      WVLI          SVLI
     C                   EVAL      SVUNIK = SFUNIK
     C                   EVAL      SVREFF = SFREFF
      * Init
     C                   Z-ADD     1             WX                4 0
n04  C                   EVAL      SVPRE = NAVPRE
      * 1. Fylkeskode
      *
      * FYLKE
      *
     c                   EVAL      SVFYL=dtafld(FYL)
     C
      * 2. Artikkelnummer
     c                   EVAL      SLALFA=dtafld(art)
     c                   EVAL      SVFT01=dtafld(art)
     c                   EVAL      SVEXR03=dtafld(art)
      * 3. Beskrivelse
     c                   EVAL      SLTXT=dtafld(BES)
     c                   EVAL      SVVT01=dtafld(bes)
      * 4. Tolltariffnummer
     c                   movel     dtafld(TAN)   tatanr
     C     tatanr        CHAIN     TARI                               89
     c     *in89         ifeq      '0'
     C                   MOVE      tatanr        SVVNT
     C                   ELSE
      *
      * EVENTUELT hent fra sadl
      *
     C                   EXSR      SADLSR
     C                   ENDIF
N01   *
N01   * evt skriv til sadl
N01   *
N01  c     slalfa        ifne      *blanks
N01  C     SADLK         CHAIN     SADL                               88
N01  C                   MOVE      tatanr        SLTANR
N01  c     *in88         ifeq      '1'
N01  c                   write     sadlr
N01  C                   end
N01  C                   end
     c
      * 5. Bruttovekt
     C                   MOVEA     dtafld(BRV)   A
     C                   EXSR      GETNUM
     C                   Z-ADD     ZNUM          SVVKTB
      * 6. Nettovekt
     C                   MOVEA     dtafld(NEV)   A
     C                   EXSR      GETNUM
     C                   Z-ADD     ZNUM          SVVKTN
      * 7. Tollverdi
     C                   MOVEA     dtafld(VER)   A
     C                   EXSR      GETNUM
     C                   Z-ADD     ZNUM          SVBELT
      *  8. Antall
     C                   MOVEA     dtafld(ANT)   A
     C                   EXSR      GETNUM
     C                   Z-ADD     ZNUM          SVNTM
      *
      * Beregener vekter
      *
n04  c     NAVnb         IFEQ      0
N04  C                   Z-ADD     0.9           NAVNB
n04  C                   END
      * BRUTTO OPPGITT MED IKKE NETTO
      *
     C     SVVKTB        IFNE      0
     C     SVVKTN        ANDEQ     0
S04  C*                  EVAL(H)   SVVKTN = SVVKTB * 0.9
N04  C                   EVAL(H)   SVVKTN = SVVKTB * navnb
     C                   END
      *
      * NETTO  OPPGITT MED IKKE BRUTTO
      *
     C     SVVKTB        IFEQ      0
     C     SVVKTN        ANDNE     0
S04  C*                  EVAL(H)   SVVKTB = SVVKTN / 0.9
N04  C                   EVAL(H)   SVVKTB = SVVKTN / NAVNB
     C                   END
      *
      * INGER VEKT OPPGITT PÅ LINJE BEREGN HVIS BRUTTO TOTAL FINNES
      *
     C     SVVKTB        IFEQ      0
     C     SVVKTN        ANDEQ     0
     c     sfbl28        ANDNE     0
     C     SVBELT        div       SFBL28        faktor           15 5
     c     faktor        mult      bruttov       SVVKTB
     C                   EVAL(H)   SVVKTN = SVVKTB * 0.9
     c                   end
      *
      *
     C                   WRITE     SAEVR

     C                   ENDSR
      ****************************************************************
     C     GETNUM        BEGSR
      ****************************************************************
      *
     c                   move      'N'           minus             1
     C                   MOVE      *ZEROS        ZHEL
     C                   MOVE      *ZEROS        ZDEC
     C                   MOVE      *ZEROS        B
     C                   Z-ADD     1             AX                2 0
     C                   Z-ADD     1             BX                2 0
      * minus
     c     A(AX)         ifeq      '-'
     c                   move      'J'           minus             1
     c                   add       1             ax
     c                   end
      * Get Integer
     C     A(AX)         DOWGE     '0'
     C     ZHEL          MULT      10            ZHEL
     C                   MOVE      A(AX)         ZHEL
     C                   ADD       1             AX
     C                   ENDDO
      * Decimal point ?
     C     A(AX)         IFEQ      '.'
     C     A(AX)         OREQ      ','
     C                   ADD       1             AX
     C     A(AX)         DOWGE     '0'
     C                   MOVE      A(AX)         B(BX)
     C                   ADD       1             AX
     C                   ADD       1             BX
     C                   ENDDO
     C                   MOVEA     B             ZDEC6
     C                   ENDIF
      * Concatenate
     C                   Z-ADD     ZHEL          ZNUM             18 6
     C                   ADD       ZDEC          ZNUM
     c     minus         ifeq      'J'
     c                   z-sub     znum          znum
     c                   end
     C                   ENDSR
      *************************************************************************
     C     SADLSR        BEGSR
      *************************************************************************
     C     SADLK         KLIST
     C                   KFLD                    SLKNR
     C                   KFLD                    SLALFA
     C     SADLK         CHAIN     SADL                               88
     C     *in88         ifeq      '0'
     c                   z-add     sltanr        SVVNT
N04  C*    SLPRE         IFNE      ' '
N04  C*                  EVAL      SVPRE=SLPRE
N04  C*                  END
     c                   else
     c                   movel     tatanr        tata06            6
     c                   movel     tata06        SVVNT
     c                   end
     c                   endsr
N02   ********************************************************************
N02  C     ARKSR         BEGSR
N02   ********************************************************************
N02   * Skriv til ARKIVP
N02  C                   CLEAR                   ARKIVR
N02
N02  C                   CALL      'SYGE15C'
N02  C                   PARM                    WDT               8
N02  C                   PARM                    WTM               6
N02  C                   EVAL      ARSTAT = 'A'
N02  C                   EVAL      ARTYPE = NADTDH
N02  C                   EVAL      ARFIRM = FIFIRM
N02  C                   EVAL      ARAVD  = 0
N02  C                   EVAL      AROPD  = 0
N02  C                   MOVEL     sftxt         ARUNDE
N02  C                   MOVEL     sftxt         ARRFK
N02  C                   EVAL      ARUSER = 'NAVITRO'
N02  C                   move      WDT           ARDATE
N02  C                   movel     WTM           ARTIME
N02  C                   EVAL      ARKUND = 0
N02   *unikt filnavn
N02  C                   EVAL      ARLINK = filpdf
N05  c     arlink        ifne      *blanks
N02
N02  C                   WRITE     ARKIVR
n05  c                   end
N02  c*                  dump
N02
N02  C                   ENDSR
