BHR   * BHR - Spesial ved rett kontor
      *********************************************************************
      *  After compiling this RPG MODULE,
      *  create the related program with the following command:
      *
CRTPG+*  CRTPGM SYSPED/STSI01R MODULE(*LIBL/STSI01R *LIBL/INCGI)
CRTPGM*         ACTGRP(*NEW) AUT(*USE)
      *
********************************************************************
      * RETTINGER I DETTE PROGRAM:
PTFnr:*Sek Sig Vers  Beskrivelse...........................
""""""*"""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""
10XXX * 01 JOV PTF10 OPPDNR 7 LANG FEIL (0001/0155013), 8 SISTE AV WSCLID BLANK...
********************************************************************
      *
      /copy syspeds/qrpgsrcpy,hspecs
      /copy syspeds/qrpgsrcpy,hspecsbnd
      *--------------------------------------------------------------------
      * Data base files
      *--------------------------------------------------------------------
     FBRIDF     if   e           k disk    usropn
     FKODTA     if   e           k disk    usropn
     FHEADF     IF   E           K DISK    usropn
     FHEAD39    IF   E           K DISK    usropn
     F                                     RENAME(HEADFR:HEADFR39)
     FHEAD11    IF   E           K DISK    usropn
     F                                     RENAME(HEADFR:HEADFR11)
     FHEAD17    IF   E           K DISK    usropn
     F                                     RENAME(HEADFR:HEADFR17)
     FTELLGE    UF A E           K DISK    usropn
     FFRISOK    IF   E           K DISK    usropn
     FFRISOL01  IF   E           K DISK    usropn
     F                                     RENAME(FRISOKR:FRISOK1R)
     FDOKUF     IF   E           K DISK    usropn
     FDOKUF7    IF   E           K DISK    usropn
     F                                     RENAME(DOKUFR:DOKUF7R)
     FDOKUFM    IF   E           K DISK    usropn
     FDOKUFM1   IF   E           K DISK    usropn
     F                                     RENAME(DOKUFMR:DOKUFMR1)
     FSTSTUR    UF A E           K DISK    usropn
     FSTSOPD    UF A E           K DISK    usropn
     FSTSOPD2   IF   E           K DISK    usropn
     F                                     RENAME(STSOPDR:STSOPDR2)
     FSTSFBR    UF A E           K DISK    usropn
     FSTSCLI    UF A E           K DISK    usropn
     FSTSCLI1   UF   E           K DISK    usropn
     F                                     RENAME(STSCLIR:STSCLIR1)
      *--------------------------------------------------------------------
      * Prototype defintions and standard system API error structure
      *--------------------------------------------------------------------
      /copy syspeds/qrpgsrcpy,prototypeb
      /copy syspeds/qrpgsrcpy,usec
      *
      *Array over adresser en vil sende mankomail til
     D MAIL            S             70    DIM(5)
      *--------------------------------------------------------------------
      * Variables common to CGI programs
      *--------------------------------------------------------------------
      /copy syspeds/qrpgsrcpy,variables3
      *--------------------------------------------------------------------
      * Variables received from the input string
     DTurNr            s              8
     DwsPro            s              8  0
     DManAnt           s              4
     DManAntN          s              4  0
     DManTxt           s             30
     DManu             s              1
     Dxxmrk1           s             35
     DWsClId           s             20
     Dwsclid18         s             18
     Dxxavd            s             10
     Dxxopd            s             10
     DViaFrbr          s              1
     DUser             s             10
     D PALLV           s              1
     DImpTur           s              1
     DImpTur8          s              8
     DImpTur8n         s              8  0
      * andre variabler
     D WsAnOM          s              4  0
     D BridSw          s              1
     D WsAnFb          s              4  0
     D WsAnFk          s              4  0
     D WsAnFM          s              4  0
     D WsAnKi          s              4  0
     D WsAnKk          s              4  0
     D WsAnTP          s              4  0
     D WsAnKM          s              4  0
     D Fn              s             10
     D Lib             s             10
     D Mbr             s             10
     D Feil            s            150
     D FeilKode        s              1
     D FeilIni         s              1
     D RefrTur         s              1
     D RefrTurA        s              1
      *
     D                 DS
     D  DFBREF                 1     17
     D  WSBRTX                 1      7
     D  WSBRAV                 8     11
     D  WSBRST                12     12
     D  WSBROP                13     17
      *
     D                 DS
     D  XXREF                  1     48
     D  XTAB                   1     48    DIM(48)
     D                 DS
     D  XXREF2                 1     20
     D  XTAB2                  1     20    DIM(20)
     D                 DS
     D  FMAI00                 1      2
     D  FMMRK1                 3     37
     D  FMMRK18                3     20
     D  FMCLID                 1     20
     D                 DS
     D  XDT                    1      8  0
     D  XDTÅÅ                  1      4  0
     D  XDTMM                  5      6  0
     D  XDTDD                  7      8  0
     D                 DS
     D  XTIME                  1     14  0
     D  XTID                   1      4  0
     D  XDD                    7      8  0
     D  XMM                    9     10  0
     D  XÅÅ                   11     14  0
      *--------------------------------------------------------------------
      * Prolog common to CGI programs
      * -Receive input from the remote browser
      *--------------------------------------------------------------------
      /copy syspeds/qrpgsrcpy,prolog3
      *=====================================================================******
      * MAIN PROCESS LINE
      *=====================================================================******
      * Parse input string
     C                   EXSR      PARSE
      ***
      * User  - Set libl ..
     C                   exsr      Init
      * Set output skeleton html member name
     C                   exsr      SetSkl
      * Read skeleton output html, etc.
     C                   callp     gethtml(fn:lib:mbr:'/CGITAG/')
      *------------------
      * Write sections of HTML.
      *
      * Her er HOVED logikk-rutine
     C                   exsr      SetTop
      *
     C                   callp     wrtsection('top')
     C     FeilIni       IFNE      'X'
     C                   callp     wrtsection('Bot')
     C                   else
     C                   callp     wrtsection('FeilI')
     C                   end
     C                   callp     wrtsection('Bott')
      *
      * Do not delete the call to wrtsection with section name *fini.  It is needed
      * to ensure that all output html that has been buffered gets output.
     C                   callp     wrtsection('*fini')
      *
      *
     C                   close     BRIDF
     C                   close     KODTA
     C                   close     HEADF
     C                   close     HEAD11
     C                   close     HEAD17
     C                   close     HEAD39
     C                   close     FRISOK
     C                   close     FRISOL01
     C                   close     tellge
     C                   close     DOKUF
     C                   close     DOKUF7
     C                   close     DOKUFM
     C                   close     DOKUFM1
     C                   close     STSTUR
     C                   close     STSOPD
     C                   close     STSOPD2
     C                   close     STSFBR
     C                   close     STSCLI
     C                   close     STSCLI1
     C                   eval      *inlr = *on
     C                   RETURN
      *
      *=====================================================================******
      * Parse input
      *=====================================================================******
     C     Parse         begsr
     C                   eval      USER     = zhbgetvar('USER')
     C                   eval      TURNR    = zhbgetvar('TURNR')
     C                   eval      WSPRO    = c2n2(TURNR)
     C                   eval      WSCLID   = zhbgetvar('CLID')
     C                   eval      PALLV    = zhbgetvar('PALLV')
     C                   eval      ImpTur   = zhbgetvar('ImpTur')
     C                   eval      ManAnt   = zhbgetvar('Ant')
     C                   eval      ManAntN  = c2n2(ManAnt)
     C                   eval      ManTxt   = zhbgetvar('Txt')
     C                   eval      Manu     = zhbgetvar('Manu')
     C     Manu          ifeq      'Y'
     C     ManAntN       andeq     *zeros
     C     ManTxt        andeq     *blanks
     C                   eval      ManTxt = 'SHORT!'
     C                   end
     C     ImpTur        comp      'Y'                                    50
      *
     C                   endsr
      *=====================================================================
      * EXECUTE LOGIC / Set html output variables for section /$top
      *=====================================================================
     C     SetTop        begsr
      *
     C     ImpTur        IFEQ      'Y'
     C                   EXSR      ImpTurSR
     C                   else
     C     WSCLID        IFNE      *BLANKS
     C                   EXSR      TESTB2
     C                   END
     C                   END
      *
      *
      * HENT ANTALL FOR Å VISE PÅ SKJERMEN
     C                   EXSR      HANTS
      *
      * Turstatus ulik ' ' - avbryt / overstyrer andre meldinger..
     C     STSTAT        IFNE      ' '
     C                   eval      feil = 'Tur ferdig skutt ('+STSTAT+
     C                             ') Trykk Avbryt!!'
     C                   Move      'X'           FeilINI
     C                   Move      'X'           FeilKode
     C                   end
      *
     C                   callp     updhtmlvar('FEILKOD':FeilKode)
     C                   callp     updhtmlvar('FEILTXT':Feil)
      *
      * Repeat UserId for the next invocation
     C                   callp     updhtmlvar('BODYCLASS':'class='+BIFARG)
     C                   callp     updhtmlvar('User':user)
     C                   MOVE      WSPRO         TURNR             8
     C                   callp     updhtmlvar('TURNR':turnr)
     C                   callp     updhtmlvar('YTYPE':YTYPE)
      *
     C* Ant. oppdrag totalt / kontrollert/Manko
     C                   callp     updhtmlvar('OPD':
     C                             %trim(%editc(stanop:'3')))
     C                   callp     updhtmlvar('OPDK':
     C                             %trim(%editc(stanok:'3')))
     C     Stanop        sub       stanok        WsAnOm
     c     WsAnOm        IFLT      *ZEROS
     c                   MOVE      *ZEROS        WsAnOm
     C                   end
     C                   callp     updhtmlvar('OPDM':
     C                             %trim(%editc(Wsanom:'3')))
     C* Ant. oppdrag totalt / kontrollert/Manko
     C                   callp     updhtmlvar('FBR':
     C                             %trim(%editc(Wsanfb:'3')))
     C                   callp     updhtmlvar('FBRK':
     C                             %trim(%editc(wsanfk:'3')))
     C     wsanfb        sub       wsanfk        wsanfm
     c     wsanfm        IFLT      *ZEROS
     c                   MOVE      *ZEROS        wsanfm
     C                   end
     C                   callp     updhtmlvar('FBRM':
     C                             %trim(%editc(wsanfm:'3')))
     C* Ant. oppdrag totalt / kontrollert/Manko
     C                   callp     updhtmlvar('KLI':
     C                             %trim(%editc(wsanki:'3')))
     C                   callp     updhtmlvar('KLIK':
     C                             %trim(%editc(wsankk:'3')))
     C                   callp     updhtmlvar('ANTP':
     C                             %trim(%editc(wsantP:'3')))
     C     wsanki        sub       wsankk        wsankm
     c     wsankm        IFLT      *ZEROS
     c                   MOVE      *ZEROS        wsankm
     C                   end
     C                   callp     updhtmlvar('KLIM':
     C                             %trim(%editc(wsankm:'3')))
      *
      * Hvis manuelt fra oppdr. og det finnes flere, vis oppdragsliste på ny.
     C     Manu          ifeq      'Y'
     C     Feilkode      andeq     ' '
     C     *in30         andeq     '0'
     C                   callp     updhtmlvar('FEILKOD':'O')
     C                   End
      *
     C                   endsr
      *
     C***********************************************
     C     ImpTurSR      BEGSR
     C***********************************************
     C                   Move      *blanks       Feil
     C                   Move      'X'           FeilKode
     C                   Movel     WSCLID        Imptur8
     C                   eval      Imptur8N = c2n2(Imptur8)
     C*                  move      *blanks       AWBNR            15
     C                   move      *blanks       AWBNR            35
      * Turnr ikke oppgitt
     C     Imptur8       ifeq      *blanks
     C                   eval      feil = 'Turnr el. awbnr må oppgis(i kll) '
     C                             +'For å legge importtur til i skytlista.'
     C                   goto      UtImpTur
     c                   end
      * Legg i skytelista (de posisjoner som ikke fins fra før..)
     C     Imptur8n      comp      *zeros                                 33
     C  N33Imptur8n      Chain     Head11                             33
     C     *in33         Ifeq      *ON
     C                   movel     WSCLID        AWBNR
     C     AWBNR         Chain     Head17                             33
     C                   end
     C     *in33         Ifeq      *ON
     C                   eval      feil = 'Gitt tur/AWB-nr er ikke gyldig'
     c                   else
     C     wspro         Ifeq      *zeros
     C                   exsr      INITTUR
     c                   else
     c                   exsr      REFRESH
     c                   end
     C  N30              eval      feil = 'Oppdragene i ' + %trim(WSCLID) +
     C                             ' er tilføyd i skytlista.'
     c                   end
     C     UtImptur      endsr
      *
      *
     C***********************************************
     C     TESTB2        BEGSR
     C***********************************************
      * SR KJØRES KUN NÅR WSCLID ULIK BLANK
     C                   MOVE      *BLANKS       WSCLID3           3
S01  C*                  MOVE      *BLANKS       WSCLID10         10
N01  C                   MOVE      *BLANKS       WSCLID08         08
     C                   MOVE      *BLANKS       xxavd
     C                   MOVE      *BLANKS       xxopd
     C                   MOVEL     WSCLID        WSCLID3
S01  C*                  MOVE      WSCLID        WSCLID10
N01  C                   MOVE      WSCLID        WSCLID08
     c     '/'           scan      WSCLID        xx                2 0
     c     xx            ifne      *zeros
     c                   eval      xxavd  = %SUBST(WSCLID:1:XX-1)
     c                   eval      xxopd  = %SUBST(WSCLID:XX+1:10)
     c                   end
     C                   MOVEA     '00000'       *IN(41)
     C                   move      'N'           RefrTur
     C                   move      'N'           RefrTurA
     C                   move      'N'           ViaFrbr
     C                   Move      *blanks       FeilINI
     C                   Move      *blanks       Feil
     C                   Move      *blanks       FeilKode
      *
     C     WSCLID        IFEQ      'RESTOK'                                     1<-B
     C                   Exsr      RestOK
     c                   goto      UtTestb
     c                   end
      * ER DET FRAKTBREV SOM ER SKUTT?
      * (begynner på 401 eller gml 10 lang, elle avd-oppdr (OBS V10 0001/0155013 12 LANG))
     C     WSCLID3       IFEQ      '401'                                        1<-B
S01  C*    WSCLID10      OREQ      *BLANKS                                      1<-B
N01  C     WSCLID08      OREQ      *BLANKS                                      1<-B
     C                   EXSR      SR401
     C                   ELSE
     C                   EXSR      SR003
     C                   END
      *
     C   30              eval      feilKode = 'X'
     c   30              goto      UtTestb
      *
     C                   TIME                    XTIME
     C                   MOVE      XDD           XDTDD
     C                   MOVE      XMM           XDTMM
     C                   MOVE      XÅÅ           XDTÅÅ
     C                   MOVE      XDT           SCDT
     C                   MOVE      XTID          SCTID
     C                   MOVE      User          SCUSER
     C                   MOVE      'X'           SCSTAT
     C     PALLV         IFEQ      'X'
     C                   MOVE      'P'           SCSTAT
     C                   END
     C     FBRK1         CHAIN     STSFBR                             33
     C     FlereFb       Tag
     C     ViaFrbr       IFNE      'J'
     C                   ADD       1             SFANKK                          *FIL
     C                   ADD       1             WSANKK                          *PÅ SKJERM
     c                   ELSE
     C                   z-add     SFANKI        SFANKK
     c                   END
     C     SFANKK        IFGE      SFANKI                                         3<-B
     C                   MOVE      'X'           SFSTAT
     C     OPDK1         CHAIN     STSOPD                             33
     C                   ADD       1             SOANFK                          *FIL
     C                   ADD       1             WSANFK                          *PÅ SKJERM
     C                   z-add     ManAntN       SOAMKK
     C                   movel     ManTxt        SOMERK
     C     SOANFK        IFGE      SOANFB                                          4<-B
     C                   MOVE      'X'           SOSTAT
     C     TURKEY        CHAIN     STSTUR                             33         *FIL
     C                   ADD       1             STANOK                          *SKJERM/FIL
     C     STANOK        IFGE      STANOP                                           5<-B
     C                   END                                                        5<-E
     C                   UPDATE    STSTURR
     C                   END                                                       4<-E
     C                   UPDATE    STSOPDR
     C                   END                                                      3<-E
     C                   UPDATE    STSFBRR
      * Når lest på fr.brevsnivå skal ikke STSCLI oppdateres..
     C     ViaFrbr       IFNE      'J'
     C                   UPDATE    STSCLIR1
     C                   Else                                                   1<-E
     C                   add       1             scfbnr
     C     FBRK1         CHAIN     STSFBR                             33
     C  N33              goto      FlereFb
     C                   END                                                    1<-E
      *
     C     UTTESTB       ENDSR
      *
     C***********************************************
     C     SR003         BEGSR
     C***********************************************
     C                   move      'N'           RefrTur
     C     Str003        tag
     C     CLIK1         CHAIN     STSCLI1                            30
      *
      * finner ikke kolli-id i skyte-fila
      * ER WORKFIL ETABLERT - HVIS IKKE GØR DET NÅ
     C     *IN30         IFEQ      '1'                                          1<-B
     C                   MOVE      *OFF          *IN30
      * Finn oppdraget som er basis for å INITIERE skytefil
     C                   MOVE      WSCLID        WSCLID18
     C                   MOVEL     WSCLID18      XXMRK1
     C     DOKFM1K       SETLL     DOKUFM1
     C                   READ      DOKUFM1                                30
     C  N30FMMRK18       COMP      WSCLID18                           3030
     C  N30HEAKEY        CHAIN     HEADF                              30
bhr   * Ved INNGÅENDE    er det kun HOVED-oppdrag
bhr  C* N30TRSLAG        IFNE      'HO'
bhr  C*                  READ      DOKUFM1                                30
bhr  C* N30FMMRK18       COMP      WSCLID18                           3030
bhr  C* N30HEAKEY        CHAIN     HEADF                              30
bhr  C*                  END
      *
bhr   * Sjekk at lest KolliID/send. tilhører rett "kontor"
bhr   * (skal finnes max 2 like - da pga OMEX...)
bhr  C* N30WSPRO         IFNE      *ZEROS
bhr  c*    wspro         ifge      80000000
bhr   * Oslo-tur..
bhr  c*    heavd         iflt      8000
bhr  C*                  READ      DOKUFM1                                30
bhr  C* N30FMMRK18       COMP      WSCLID18                           3030
bhr  C* N30HEAKEY        CHAIN     HEADF                              30
bhr  c*                  end
bhr  c*                  else
bhr   * Drm.-tur..
bhr  c*    heavd         ifge      8000
bhr  C*                  READ      DOKUFM1                                30
bhr  C* N30FMMRK18       COMP      WSCLID18                           3030
bhr  C* N30HEAKEY        CHAIN     HEADF                              30
bhr  c*                  end
bhr  c*                  end
bhr  c*                  end
     C     WSPRO         Ifeq      *Zeros
     C  N30              exsr      INITTUR
      * skytefil er etablert - prøv på ny
     c  N30              goto      str003
     C                   eval      feil = 'UKjent kolli-ID lest'
     c                   goto      Ut003
     C                   else
     C     RefrTur       Ifeq      'N'
     C                   move      'J'           RefrTur
     C                   EXSR      REFRESH
     c                   goto      str003
     C                   end
     C                   end
     C                   end
      *
     C     *IN30         IFEQ      *ON
     C                   eval      feil = 'Kolli-ID finnes ikke i skytefila'
     c                   goto      Ut003
     C                   END
      *
      * KOLLI-ID finnes i skytelista - vellykket les.
     C     SCSTAT        IFEQ      'X'                                           2<-B
     C     SCSTAT        OREQ      'P'                                           2<-B
      * KOLLI-ID ER KONTROLLERT FRA FØR.
     C                   MOVE      *ON           *IN30
      * Den som alt finnes har IKKE pall
     C     SCSTAT        IFEQ      'X'
     C     PALLV         IFEQ      'X'
     C                   eval      feil = wsclid+ ' er alt skutt ' +
     C                                    'PALLE er ØKT med 1'
     c                   move      'P'           SCSTAT
     c                   else
     C                   eval      feil = wsclid+ ' er alt skutt'
     c                   end
     c                   else
      * Den som alt finnes VAR PÅ PALL
     C     PALLV         IFEQ      'X'
     C                   eval      feil = wsclid+ ' er alt skutt'
     c                   else
     C                   eval      feil = wsclid+ ' er alt skutt ' +
     C                                    'PALLE er REDUSERT med 1'
     c                   move      'X'           SCSTAT
     c                   end
     c                   end
     c                   update    stsclir1
     C     FBRK1         CHAIN(N)  STSFBR                             33
     C     OPDK1         CHAIN(N)  STSOPD                             33
     C     TURKEY        CHAIN(N)  STSTUR                             33         *FIL
     C                   End                                                     2
      *
     C     UT003         ENDSR
      *
     C***********************************************
     C     SR401         BEGSR
     C***********************************************
     C                   move      'N'           RefrTur
      * Skyting basert på Sendingsnr...
      * sendingen må finnes..
     C     xxopd         ifne      *blanks
     C                   eval      FMAVD    = c2n2(xxavd)
     C                   eval      FMOPD    = c2n2(xxopd)
     C     HEAKEY        CHAIN     HEADF                              30
     c     *in30         Ifeq      *ON
     C                   eval      feil = 'UKjent sending lest'
     c                   goto      Ut401
     c                   else
     c                   goto      OkSndnr
     c                   end
     c                   end
     C     wsclid        SETLL     HEAD39
     C     wsclid        READE     HEAD39                                 30
bhr   * Ved utgående - les kun HOVEDOPPDRAG
bhr  C* N30TRSLAG        IFNE      'HO'
BHR  C*    wsclid        READE     HEAD39                                 30
bhr  c*                  end
bhr   * Sjekk at lest send. tilhører rett "kontor"
bhr   * (skal finnes max 2 like - da pga OMEX...)
bhr  C* N30WSPRO         IFNE      *ZEROS
bhr  c*    wspro         ifge      80000000
bhr   * Oslo-tur..
bhr  c*    heavd         iflt      8000
BHR  C*    wsclid        READE     HEAD39                                 30
bhr  c*                  end
bhr  c*                  else
bhr   * Drm.-tur..
bhr  c*    heavd         ifge      8000
BHR  C*    wsclid        READE     HEAD39                                 30
bhr  c*                  end
bhr  c*                  end
bhr  c*                  end
      *    *in30         ifeq      *on
     C                   move      wsclid        Fbr17            17
     C                   movel     fbr17         Fbr35            35
     C     Fbr35         chain     dokuf7                             30
     C     *in30         ifeq      *off
     C                   eval      FMAVD    = DFAVD
     C                   eval      FMOPD    = DFOPD
     C     HEAKEY        CHAIN     HEADF                              30
     c     *in30         Ifeq      *ON
     C                   eval      feil = 'UKjent sending lest'
     c                   goto      Ut401
     c                   else
     c                   goto      OkSndnr
     c                   end
     C                   end
     C     *in30         IFEQ      '1'
     C                   eval      feil = 'UKjent sending lest'
     c   30              goto      Ut401
     C                   end
      *
      * OK sending lest
     C     OkSndnr       tag
      *
      * ER WORKFIL ETABLERT - HVIS IKKE GØR DET NÅ (basert på lest oppd
     C     WSPRO         IFEQ      *ZEROS
     C                   exsr      INITTUR
     c   30              goto      Ut401
     C                   end
      *
      * Sending må finnes i "skyteliste" for aktuell tur
     C     Str401        tag
     C     OPDKEY        CHAIN(N)  STSFBR                             33
     C     *iN33         IFeq      '1'
     C     WSPRO         Ifne      *Zeros
     C     RefrTur       andeq     'N'
     C                   move      'J'           RefrTur
     C                   EXSR      REFRESH
     c                   goto      str401
     C                   end
     C                   SETON                                        30
     C                   eval      feil = 'Sendingen IKKE i skyteliste'
     c   30              goto      Ut401
     C                   end
      *
      * Fraktbrev må ikke være skutt før..
     c     SFSTAT        IFNE      ' '
     C                   SETON                                        30
     C                   eval      feil = 'Sendingen ER alt skutt'
     c   30              goto      Ut401
     C                   end
      *
      * skal IKKE finnes i Koli-id fila
     C     OPDKEY        CHAIN(N)  STSCLI                             33
     c     *IN33         IFEQ      *OFF
     C                   SETON                                        30
     C                   eval      feil = 'Sendingen er Kolli-Merket, +
     C                             skyt Kolli'
     C                   goto      ut401
     C                   end
      *
      * ALT OK.
      * Klargjør nøkkel for oppdat av STSFBR/STSOPD... i sr "settop"
     C                   MOVE      'J'           ViaFrbr
     c                   move      ' '           scstat
     c                   move      heavd         scavd
     c                   move      heopd         scopd
     c                   z-add     1             scfbnr
      *
     C     Ut401         ENDSR
      *
     C***********************************************
     C     RESTOK        BEGSR
     C***********************************************
     C                   MOVE      *BLANKS       WSCLID
     C                   MOVE      *BLANKS       WSCLID3           3
S01  C*                  MOVE      *BLANKS       WSCLID10         10
N01  C                   MOVE      *BLANKS       WSCLID08
      * Resten som ikke er merket... (men hvis kollimerket gods KAN det være ulovlig)
     c     Turkey        setll     STSFBR
     C     Turkey        reade     STSFBR                                 33
     c     *in33         doweq     '0'
     C     SFSTAT        cabeq     'X'           NxtRest
     C     KunUmRest     Ifeq      'J'
     C     SFANKI        cabne     0             NxtRest
     c                   end
     C                   MOVE      'X'           SFSTAT
     C     OPDK1         CHAIN     STSOPD                             33
     C                   ADD       1             SOANFK
     C                   exsr      TstCLI
     c     TsACli        ifeq      0
     C                   eval      SOMERK   =    'Rest OK!'
     c                   else
     c     TsACliK       ifeq      0
     C                   eval      SOMERK   =    'SHORT! '
     c                   else
     C                   eval      SOMERK   =    'Unloaded/checked: '
     c                             + %trim(%editc(TsAClik:'3'))+' of '
     c                             + %trim(%editc(TsACli:'3'))
     c                   end
     c                   end
     C     SOANFK        IFGE      SOANFB
     C                   MOVE      'X'           SOSTAT
     C     TURKEY        CHAIN     STSTUR                             33
     C                   ADD       1             STANOK
     C                   UPDATE    STSTURR
     C                   END
     C                   UPDATE    STSOPDR
     C     NxtRest       tag
     C                   UPDATE    STSFBRR
     C     Turkey        reade     STSFBR                                 33
     C                   END
      *
     C                   ENDSR
      *
      *
     C***********************************************
     C     TstCLI        BEGSR
     C***********************************************
     C                   MOVE      *ZEROS        TsACli            5 0
     C                   MOVE      *ZEROS        TsACliK           5 0
     C     TsCLIK        SETLL     STSCLI
     C     TsCLIK        READE(N)  STSCLI                                 33
     C     *IN33         DOWEQ     '0'                                          1<-B
     C                   ADD       1             TsACli
     C     SCSTAT        IFNE      ' '
     C                   ADD       1             TsACliK
     C                   END
     C     TsCLIK        READE(N)  STSCLI                                 33
     C  N33              ENDDO                                                  1<-E
      *
     C                   ENDSR
      *
     C***********************************************
     C     INITTUR       BEGSR
     C***********************************************
      * gyldig kolli eller f.br. er lest -
      *  - finnes f.brev alt i skytefila med denne TERMkode (YTYPE)
      *  - i så fall hent "tur-header derfra"
     C     OPDK2         CHAIN     STSOPD2                            33
     C     *in33         ifeq      *OFF
      * tildel "turnr" fra teller
     C                   move      SOPRO         WSPro             8 0
     c                   else
     C                   Movel     'ESTURSTS'    GECO
     C     GECO          Chain     TellGE                             33
     C   33              Z-add     1             GENO
     C                   Z-add     GENO          WSPRO
     C                   add       1             GENO
     C   33              Write     TELLGER
     C  N33              Update    TELLGER
     c                   end
      *
     C     TURKEY        CHAIN(N)  STSTUR                             33
     C     *IN33         IFEQ      '1'                                          1<-B
      * finnes IKKE fra før...
      * TØM FØRST EVT GAMLE DATA PÅ STATUSFIL UNDERREGISTER OPD/FBR/CLI
     C                   EXSR      TØMUNDER
      * legg ut STSTURR - kjør så "refresh")
     C                   CLEAR                   STSTURR
     C                   MOVE      YTYPE         STTYPE
     C                   MOVE      WSPRO         STPRO
     C                   WRITE     STSTURR
      * refresh både ved ny / gjenopptakelse av skyting
     C                   EXSR      REFRESH
     C                   ELSE                                                   1<-E
      * finnes fra før... ferdig skutt? (melding flyttet ti SETTOP)
     C     STSTAT        COMP      ' '                                3030
     C  N30              EXSR      REFRESH
     C                   END                                                    1<-E
      *
     C                   ENDSR
      *
     C***********************************************
     C     TØMUNDER      BEGSR
     C***********************************************
      * OPD
     C     TURKEY        SETLL     STSOPD
     C     TURKEY        READE     STSOPD                                 33
     C     *IN33         DOWEQ     '0'                                           2<-B
     C                   DELETE    STSOPDR
     C     TURKEY        READE     STSOPD                                 33
     C  N33              ENDDO                                                   2<-E
      * FBR
     C     TURKEY        SETLL     STSFBR
     C     TURKEY        READE     STSFBR                                 33
     C     *IN33         DOWEQ     '0'                                           2<-B
     C                   DELETE    STSFBRR
     C     TURKEY        READE     STSFBR                                 33
     C  N33              ENDDO                                                   2<-E
      * CLI
     C     TURKEY        SETLL     STSCLI
     C     TURKEY        READE     STSCLI                                 33
     C     *IN33         DOWEQ     '0'                                           2<-B
     C                   DELETE    STSCLIR
     C     TURKEY        READE     STSCLI                                 33
     C  N33              ENDDO                                                   2<-E
      *
      *
     C                   ENDSR
      *
     C***********************************************
     C     HETTOPD       BEGSR
     C***********************************************
     C                   ADD       1             STANOP
     C                   CLEAR                   STSOPDR
     C                   MOVE      STTYPE        SOTYPE
     C                   MOVE      WSPRO         SOPRO
     C                   MOVE      HEAVD         SOAVD
     C                   MOVE      HEOPD         SOOPD
      *
     C                   EXSR      HFBR
      *
     C                   WRITE     STSOPDR
      *
     C                   ENDSR
      *
     C***********************************************
     C     HFBR          BEGSR
     C***********************************************
     C     DOKUFK        SETLL     DOKUF
     C     DOKUFK        READE     DOKUF                                  33
      * ingen fraktbrev, simuler nr 001 ("frittstående" edimottatte CLID!!!)
     C     *in33         ifeq      '1'
     c                   move      *blanks       DFBREF
     C                   Z-add     1             DFFBNR
     C                   goto      dummyf
     C                   end
     C     *IN33         DOWEQ     '0'
     C     dummyf        tag
     C                   ADD       1             SOANFB
     C                   CLEAR                   STSFBRR
     C                   MOVE      SOTYPE        SFTYPE
     C                   MOVE      WSPRO         SFPRO
     C                   MOVE      HEAVD         SFAVD
     C                   MOVE      HEOPD         SFOPD
     C                   MOVE      DFFBNR        SFFBNR
      *
     C                   EXSR      HCLI
      *
     C                   WRITE     STSFBRR
     C     DOKUFK        READE     DOKUF                                  33
     C  N33              ENDDO
      *
     C                   ENDSR
      *
     C***********************************************
     C     HCLI          BEGSR
     C***********************************************
     C                   MOVE      SFAVD         FMAVD
     C                   MOVE      SFOPD         FMOPD
     C                   MOVE      SFFBNR        FMFBNR
      * hvis brevet er DUPPet så ligger Kolli-IDs under DUPEN (/fb 1)
     C     WSBRTX        ifeq      'Utk.op:'
     C                   MOVE      WSBRAV        FMAVD
     C                   MOVE      WSBROP        FMOPD
     C                   z-add     1             FMFBNR
     C                   end
      *
     C     DOKFMK        SETLL     DOKUFM
     C     DOKFMK        READE     DOKUFM                                 33
     C     *IN33         DOWEQ     '0'
     C                   ADD       1             SFANKI
     C                   CLEAR                   STSCLIR
     C                   MOVE      SFTYPE        SCTYPE
     C                   MOVE      WSPRO         SCPRO
     C                   MOVE      SFAVD         SCAVD
     C                   MOVE      SFOPD         SCOPD
     C                   MOVE      FMFBNR        SCFBNR
     C                   MOVE      FMCLID        SCCLID
     C                   WRITE     STSCLIR
     C     DOKFMK        READE     DOKUFM                                 33
     C  N33              ENDDO
      *
     C                   ENDSR
      *
     C***********************************************
     C     HANTS         BEGSR
     C***********************************************
      * HENT TURENS TOTALER FOR VISING PÅ SKJERM
     C     TURKEY        CHAIN(N)  STSTUR                             33
     C   33              MOVE      *BLANKS       STSTAT
      * FRAKTBREV / FBR. KONTROLLERT.
     C                   MOVE      *ZEROS        WSANFB
     C                   MOVE      *ZEROS        WSANFK
     C     TURKEY        SETLL     STSOPD
     C     TURKEY        READE(N)  STSOPD                                 33
     C     *IN33         DOWEQ     '0'                                          1<-B
     C                   ADD       SOANFB        WSANFB
     C                   ADD       SOANFK        WSANFK
     C     TURKEY        READE(N)  STSOPD                                 33
     C  N33              ENDDO                                                  1<-E
      * KOLLIID / KLID KONTROLLERT.
     C                   MOVE      *ZEROS        WSANKI
     C                   MOVE      *ZEROS        WSANKK
     C     TURKEY        SETLL     STSFBR
     C     TURKEY        READE(N)  STSFBR                                 33
     C     *IN33         DOWEQ     '0'                                          1<-B
     C                   ADD       SFANKI        WSANKI
     C                   ADD       SFANKK        WSANKK
     C     TURKEY        READE(N)  STSFBR                                 33
     C  N33              ENDDO                                                  1<-E
      *  Antall Paller
     C                   MOVE      *ZEROS        WSANTP
     C     TURKEY        SETLL     STSCLI
     C     TURKEY        READE(N)  STSCLI                                 33
     C     *IN33         DOWEQ     '0'                                          1<-B
     C     SCSTAT        IFEQ      'P'
     C                   ADD       1             WSANTP
     C                   END
     C     TURKEY        READE(N)  STSCLI                                 33
     C  N33              ENDDO                                                  1<-E
      *
     C     Feilkode      IFeq      ' '                                              5<-B
     C     STANOK        andNE     *ZEROS                                           5<-B
     C     STANOK        andGE     STANOP                                           5<-B
     C                   eval      feil = 'FERDIG SKUTT, Fullfør, Parker ' +
     C                                    'eller skyt flere.'
     C                   eval      feilKode = 'X'
     C                   END                                                    1<-E
      *
     C                   ENDSR
      *
     C***********************************************
     C     REFRESH       BEGSR
     C***********************************************
      * 1. finn ut om det er skyting på enkelt-ordrenivå eller "turnivå"
      *     dersom det finnes fri søkevei kode E_S (Edi Send.nr...).
     C     Frisokkey     Chain     FRISOK                             33
     C   33              Move      'EDS'         FSKODE
     C   33Frisokkey     Chain     FRISOK                             33
     C   33              Move      *blanks       Fssok
      *
     C     TURKEY        CHAIN     STSTUR                             33
     C     *IN33         IFEQ      '0'
      * REFRESH DATA (=HENT NYE POSISJONER)
      * 50 ON = Import tur / 50 off basert på lest kolli-fr.brev
     C     AWBNR         Ifeq      *blanks
     C   50Imptur8n      setll     Head11
     C   50Imptur8n      reade     Head11                                 33
     C                   else
     C   50AWBNR         setll     Head17
     C   50AWBNR         reade     Head17                                 33
     C                   end
     c  N50FSSOK         CABEQ     *blanks       KunEtt
     C  N50Fris1Key      SETLL     FRISOL01
     C  N50Fris1Key      READE     FRISOL01                               33
     C     *IN33         DOWEQ     '0'
     C  N50              MOVE      FSAVD         HEAVD
     C  N50              MOVE      FSOPD         HEOPD
     c   50AWBNR         Ifne      *blanks
     c     HEUR          andeq     'H'
     c                   goto      NextAwb
     c                   end
     C     KunEtt        tag
     C     OPDKEY        CHAIN     STSOPD                             34
     C     *IN34         IFEQ      '1'
     C                   EXSR      HETTOPD
     C                   MOVE      *BLANKS       STSTAT
     C                   ELSE
     C                   EXSR      HFBR2
     C                   UPDATE    STSOPDR
     C                   END
     c     NextAwb       tag
     C     AWBNR         Ifeq      *blanks
     C   50Imptur8n      reade     Head11                                 33
     C                   else
     C   50AWBNR         reade     Head17                                 33
     C                   end
     c  N50FSSOK         CABEQ     *blanks       KunEttSl
     C  N50Fris1Key      READE     FRISOL01                               33
     C  N33              ENDDO
      *
     C     KunEttSl      tag
     C                   UPDATE    STSTURR
      *
     C                   END
      *
     C                   ENDSR
      *
      *
     C***********************************************
     C     DLTTST        BEGSR
     C***********************************************
     C                   MOVE      SCAVD         FMAVD
     C                   MOVE      SCOPD         FMOPD
     C     HEAKEY        CHAIN     HEADF                              33
     C     *IN33         IFEQ      *OFF
     C     HEPRO         ANDNE     WSPRO
     C     ViaFrbr       IFNE      'J'
     C                   UPDATE    STSCLIR1
     C                   END                                                    1<-E
     C                   SETON                                        30
     C                   eval      feil = 'Send. er FJERNET fra turen'
     C                   EXSR      DLTSND
     C                   END
      *
     C                   ENDSR
      *
     C***********************************************
     C     DLTSND        BEGSR
     C***********************************************
     C                   MOVE      FMAVD         SFAVD
     C                   MOVE      FMOPD         SFOPD
      * FJERN OPPDRAG/REDUSER ANT I TUR.
     C     OPDK1         CHAIN     STSOPD                             33
     C     *IN33         IFEQ      *OFF
     C                   DELETE    STSOPDR
     C     TURKEY        CHAIN     STSTUR                             33         *FIL
     C     *IN33         IFEQ      *OFF
     C                   SUB       1             STANOP
     C     SOSTAT        IFEQ      'X'
     C                   SUB       1             STANOK
     C                   END
     C                   UPDATE    STSTURR
     C                   END
     C                   END
      * FRAKTBREV
     C     OPDK1         SETLL     STSFBR
     C     OPDK1         READE     STSFBR                                 33
     C     *IN33         DOWEQ     '0'
     C                   DELETE    STSFBRR
     C     OPDK1         READE     STSFBR                                 33
     C                   END
      * KOLLI
     C     OPDK1         SETLL     STSCLI
     C     OPDK1         READE     STSCLI                                 33
     C     *IN33         DOWEQ     '0'
     C                   DELETE    STSCLIR
     C     OPDK1         READE     STSCLI                                 33
     C                   END
      *
     C                   ENDSR
      *
     C***********************************************
     C     HFBR2         BEGSR
     C***********************************************
     C     DOKUFK        SETLL     DOKUF
     C     DOKUFK        READE     DOKUF                                  33
     C     *IN33         DOWEQ     '0'                                          1<-B
     C     FBRKEY        CHAIN     STSFBR                             33
     C     *IN33         IFEQ      '1'                                           2<-B
     C                   EXSR      HCLI
     C                   MOVE      *BLANKS       STSTAT
     C                   MOVE      *BLANKS       SOSTAT
     C                   ELSE                                                    2
      * HENT NYE DATA
     C                   EXSR      HCLI2
      *
     C                   UPDATE    STSFBRR
     C                   END                                                     2<-E
     C     DOKUFK        READE     DOKUF                                  33
     C  N33              ENDDO                                                  1<-E
      *
     C                   ENDSR
      *
     C***********************************************
     C     HCLI2         BEGSR
     C***********************************************
     C                   MOVE      SFAVD         FMAVD
     C                   MOVE      SFOPD         FMOPD
     C                   MOVE      SFFBNR        FMFBNR
      * hvis brevet er DUPPet så ligger Kolli-IDs under DUPEN (/fb 1)
     C     WSBRTX        ifeq      'Utk.op:'
     C                   MOVE      WSBRAV        FMAVD
     C                   MOVE      WSBROP        FMOPD
     C                   z-add     1             FMFBNR
     C                   end
      *
     C     DOKFMK        SETLL     DOKUFM
     C     DOKFMK        READE     DOKUFM                                 33
     C     *IN33         DOWEQ     '0'                                          1<-B
     C     CLIKEY        CHAIN(N)  STSCLI                             33
     C     *IN33         IFEQ      '1'                                           2<-B
     C                   MOVE      *BLANKS       STSTAT
     C                   MOVE      *BLANKS       SOSTAT
     C                   MOVE      *BLANKS       SFSTAT
     C                   ADD       1             SFANKI
     C                   CLEAR                   STSCLIR
     C                   MOVE      SFTYPE        SCTYPE
     C                   MOVE      WSPRO         SCPRO
     C                   MOVE      FMAVD         SCAVD
     C                   MOVE      FMOPD         SCOPD
     C                   MOVE      FMFBNR        SCFBNR
     C                   MOVE      FMCLID        SCCLID
     C                   WRITE     STSCLIR
     C                   END                                                     2<-E
     C     DOKFMK        READE     DOKUFM                                 33
     C  N33              ENDDO                                                  1<-E
      *
     C                   ENDSR
      *
      *=====================================================================******
      *  Different User than last invocation
      *=====================================================================******
     C     Init          begsr
     C                   open      BRIDF
     C     User          CHAIN     BRIDF                              30
      *
     C* En "standardvariant" libl: call bound (INCGI=*MODULE) med parameter.
     C* (bedre ressursmessig). MODUL må da være med comp. av dette pgm!!
     C     BILIBL        ifeq      *blanks
     C                   callb     'INCGI'
     C                   parm                    BISTDL
     C                   else
     C* Helt egen bibl.liste satt på user - normal CALL (BILIBL er "*pgm")
     C                   call      BILIBL
     C                   end
      *
     C                   open      KODTA
     C                   open      HEADF
     C                   open      HEAD11
     C                   open      HEAD17
     C                   open      HEAD39
     C                   open      FRISOK
     C                   open      FRISOL01
     C                   open      DOKUF
     C                   open      DOKUF7
     C                   open      DOKUFM
     C                   open      DOKUFM1
     C                   open      tellge
     C                   open      STSTUR
     C                   open      STSOPD
     C                   open      STSOPD2
     C                   open      STSFBR
     C                   open      STSCLI
     C                   open      STSCLI1
      * Om brukerid ikke har kundenr (anonym) bruk avdelings knr
      *    (for å kunne sende mail....)
     C     BIKUNR        IFEQ      *ZEROS
     C     *LOVAL        SETLL     KODTA
     C                   READ      KODTA
     C                   MOVE      KOAKNR        BIKUNR
     C                   END
      *
      * definer KEYS m.m.
      *
     C     *LIKE         DEFINE    STTYPE        YTYPE
     C                   MOVE      'TERIN'       YTYPE
      *
     C     TURKEY        KLIST
     C                   KFLD                    YTYPE
     C                   KFLD                    WSPRO
     C     FrisokKey     KLIST
     C                   KFLD                    HEAVD
     C                   KFLD                    HEOPD
     C                   KFLD                    FSKODE
     c                   move      'E_S'         FSKODE
     C     Fris1Key      KLIST
     C                   KFLD                    FSKODE
     C                   KFLD                    FSSOK
     C     OPDKEY        KLIST
     C                   KFLD                    YTYPE
     C                   KFLD                    WSPRO
     C                   KFLD                    HEAVD
     C                   KFLD                    HEOPD
     C     FBRKEY        KLIST
     C                   KFLD                    YTYPE
     C                   KFLD                    WSPRO
     C                   KFLD                    DFAVD
     C                   KFLD                    DFOPD
     C                   KFLD                    DFFBNR
     C     CLIKEY        KLIST
     C                   KFLD                    YTYPE
     C                   KFLD                    WSPRO
     C                   KFLD                    FMAVD
     C                   KFLD                    FMOPD
     C                   KFLD                    FMFBNR
     C                   KFLD                    FMCLID
     C                   move      '00'          FMAI00
     C     OPDK1         KLIST
     C                   KFLD                    YTYPE
     C                   KFLD                    WSPRO
     C                   KFLD                    SFAVD
     C                   KFLD                    SFOPD
     C     OPDK2         KLIST
     C                   KFLD                    YTYPE
     C                   KFLD                    HEAVD
     C                   KFLD                    HEOPD
     C     FBRK1         KLIST
     C                   KFLD                    YTYPE
     C                   KFLD                    WSPRO
     C                   KFLD                    SCAVD
     C                   KFLD                    SCOPD
     C                   KFLD                    SCFBNR
     C     CLIK1         KLIST
     C                   KFLD                    YTYPE
     C                   KFLD                    WSPRO
     C                   KFLD                    WSCLID
     C     TsCLIK        KLIST
     C                   KFLD                    YTYPE
     C                   KFLD                    WSPRO
     C                   KFLD                    SFAVD
     C                   KFLD                    SFOPD
     C                   KFLD                    SFFBNR
     C     DOKUFK        KLIST
     C                   KFLD                    DFRI
     C                   KFLD                    HEAVD
     C                   KFLD                    HEOPD
     C     DOKFMK        KLIST
     C                   KFLD                    DFRI
     C                   KFLD                    FMAVD
     C                   KFLD                    FMOPD
     C                   KFLD                    FMFBNR
     C     DOKFM1K       KLIST
     C                   KFLD                    XXMRK1
     C     HEAKEY        KLIST
     C                   KFLD                    FMAVD
     C                   KFLD                    FMOPD
      *
     C                   MOVE      'F'           DFRI
      * Kun umerket gods (IKKE KOLLIMERKET) ved all merk Reste
      * (bør parametersettes, NÅ hadkodet som variabe for enkel kundespesial)
     C*                  MOVE      'J'           KunUmRest         1
     C                   MOVE      'N'           KunUmRest         1
     C                   endsr
      *
      *=====================================================================******
      * Set html output skeleton member before its read into memory
      *=====================================================================******
     C     SetSkl        begsr
      *------------------
      * Set html output skeleton member
     C                   eval      Lib = '*LIBL'
     C                   eval      Fn  = 'HTMLSRC'
     C                   eval      Mbr = 'STSI01'
      *------------------
     C                   endsr
