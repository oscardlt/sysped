      *
      ************************************************************
      *** PROGRAM for å generere importfil for Autoroute       ***
      ***         Alle biler i et gitt område                  ***
      ************************************************************
      *
     FDISPL04   IF   E           K DISK
     FHEADF     IF   E           K DISK
     FTKUSER    IF   E           K DISK
     FTKAREA    IF   E           K DISK
     FQ1024     O  A F 1024        DISK
     FSYTK12FM  CF   E             WORKSTN
     D Path            s            100
     D Post1           s              1
     D FeilOmr         s              1
     D Streng          s           1024
     D SJNR            s              1  0
     D Info1           s            100
     D Info2           s            100
     D Info3           s            100
     D Info4           s            100
     D CurrTime        s               z
     D MinDs           ds
     D  Min                            z
     D  MinYear                       4    overlay(Min:1)
     D  MinMonth                      2    overlay(Min:6)
     D  MinDay                        2    overlay(Min:9)
     D  MinHour                       2    overlay(Min:12)
     D  MinMin                        2    overlay(Min:15)
     D  MinSec                        2    overlay(Min:18)
      *
     D MiniDs          ds
     D MiniDtTi                1     14  0
     D MiniYear                1      4  0
     D MiniMonth               5      6  0
     D MiniDay                 7      8  0
     D Today                   1      8  0
     D MiniHour                9     10  0
     D MiniMin                11     12  0
     D MiniSec                13     14  0
     D TodayA                  1      8
     D TodayHMSA               9     14
      *
     D TkdtDs          ds
     D TKDTTI                  1     14  0
     D TKDT                    1      8  0
     D TKTI                    9     14  0
      *___________________________
      * Finner username
      *"""""""""""""""""""""""""""
     D                SDS
     D  ZJOB                 244    253
     D  ZUSER                254    263
     D  ZJOBNR               264    269  0
      *
      *
     C     *entry        Plist
     C                   Parm                    PATH
      *
     C     KEYAll        KLIST
     C                   KFLD                    DISTA1
     C                   KFLD                    DITUR
     C     KEYAvd        KLIST
     C                   KFLD                    DISTA1
     C                   KFLD                    DITUR
     C                   KFLD                    WSavd
     C     KEYHead       KLIST
     C                   KFLD                    DIAVD
     C                   KFLD                    DIOPD
      * Defaulter
     C     ZUSER         Chain     TKUSER                             33
     C   33'*DFT      '  Chain     TKUSER                             33
     c                   move      MAMAPP        WSMAPP
      * låner MiniDS for å finne "Today"
     C                   time                    Min
     c                   move      MinYear       MiniYear
     c                   move      MinMonth      MiniMonth
     c                   move      MinDay        MiniDay
     c                   move      MinHour       MiniHour
     c                   move      MinMin        MiniMin
     c                   move      MinSec        MiniSec
     c                   eval      WSFIL = 'Oppdr_'+TodayA+'_'+TodayHMSA
     C*
     C     STBILD        TAG
     C                   EXFMT     BILDE01
     C*
     C     *in12         cabeq     *ON           Slutt
     c                   exsr      TestBi
     c     *IN30         cabeq     '1'           STBILD
      * Lag fil:
     C                   Exsr      LagFil
     c                   move      WSAVD         WSAVDA            4
     c                   eval      Path = %trim(WSMAPP)+'/' +
     c                                    %trim(WSFIL)+'_' +
     c                                    %trim(WSOMR)+'_' +
     c                                    %trim(WSAVDA)+'.csv'
      *
     C     Slutt         Tag
     C                   SETON                                        LR
     C                   RETURN
     C*
      ***************************************************************************
     C     TESTBI        BEGSR
      ***************************************************************************
     C                   move      *off          *IN30
     C                   ENDSR
      ***************************************************************************
     C     Lagfil        BEGSR
      ***************************************************************************
      * 1.post - kolonneheadere...
     C                   move      'J'           Post1
      *
     C     Wsavd         Ifeq      *zeros
     C     KeyAll        setll     DISPL04
     C     KeyAll        reade     DISPL04                                50
     c                   else
     C     KeyAvd        setll     DISPL04
     C     KeyAvd        reade     DISPL04                                50
     c                   end
     c     *in50         doweq     '0'
      * Post funnet,
     c     KeyHead       Chain     HEADF                              33
     C     *in33         cabeq     '1'           Skipp
      *  test om den er i rette område
     C     WsOmr         IFNE      *blanks
     C                   exsr      TstOmr
     C     FeilOmr       cabeq     'J'           Skipp
     C                   end
      ***
     C                   exsr      EnPost
      ***
     C     Skipp         tag
     C     Wsavd         Ifeq      *zeros
     C     KeyAll        reade     DISPL04                                50
     c                   else
     C     KeyAvd        reade     DISPL04                                50
     c                   end
     C                   END
      *
     C     wsomr         ifeq      *blank
     c**                 movel     'ALL'         WSOMR
     c                   end
      *
     C                   ENDSR
      ***************************************************************************
     C     TstOmr        BEGSR
      ***************************************************************************
     C                   Move      'J'           FeilOmr
      *
     C     WsOmr         setll     TKAREA
     C     WsOmr         READE     TKAREA                                 35
     C     WsOmr         READE     TKAREA                                 35
     C     *IN35         DOWEQ     '0'
      * Funnet område definert av Vestre/Nordre/Ørstre/Søndre linje i et rektangel
      * (breddegrader = nord/sør - lengdegrader=Øst-vest)
      * ER bilen innenfor dette området?
     C                   Move      'N'           FeilOmr
     C     WsOmr         READE     TKAREA                                 35
     C                   END
     C     UtTstOmr      ENDSR
      ***************************************************************************
     C     EnPost        BEGSR
      ***************************************************************************
      * Predefinerte "datatyper"/overskrifter..
      * når disse benyttes vises data som default med ledetekst
      * Name,Name 2,Address 1,Address 2,Address 3,City,Postcode,Latitude,Longitude, mm.
     C     Post1         Ifeq      'J'
     C                   eval      Streng = 'Name,'+
     C                             'Address 1,'+
     C                             'Address 2,'+
     C                             'City,'+
     C                             'Ant/vkt mm,'+
     C                             ''
     C                   EXCEPT    Qdata
     C                   move      'N'           Post1
     C                   end
      * Dersom interessant -settes sammen dynamisk fra oppdrag
     C                   eval      Info1 ='15 kll 250 kg 3,5 M3'
      * Hentes fra oppdraget/kunden
     C                   MOVE      *zeros        OPbre             8 6
     C                   MOVE      *zeros        OPlen             9 6
     C                   eval      Streng = %trim(HENAS) + ',' +
     C                             %trim(HEADS1) + ',' +
     C                             %trim(HEADS2) + ',' +
     C                             %trim(%subst(HEADS3:6:24)) + ',' +
     C                             ''
     C                   EXCEPT    Qdata
     C                   ENDSR
     OQ1024     EADD         Qdata
     O                       STRENG            1024
