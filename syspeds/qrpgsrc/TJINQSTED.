      *********************************************************************
      *
CRTPG+*  CRTPGM SYSPED/TJINQSTED MODULE(*LIBL/TJINQSTED *LIBL/INCGI)
CRTPGM*        ACTGRP(CGI) AUT(*USE)
      *
      *********************************************************************
      /copy SYSPEDS/qrpgsrcpy,hspecs
      /copy SYSPEDS/qrpgsrcpy,hspecsbnd
      *********************************************************************
     FBRIDF     IF   E           K DISK    USROPN
     FSted2A    IF   E           K DISK    USROPN
     FSted2S    IF   E           K DISK    USROPN
     F                                     RENAME(STED2R:STED2RS)
n04   *--------------------------------------------------------------------
      * Variables common to all CGIs
      *--------------------------------------------------------------------
      /copy SYSPEDS/qrpgsrcpy,prototypeb
      /copy SYSPEDS/qrpgsrcpy,usec
      /copy SYSPEDS/qrpgsrcpy,variables3
     D SOKLK           s              2
     D SOKNVN          s             30    varying
     D SOKNVN2         s             30
     D USER            s             10
     D VARLK           s             10
     D WST2KOD         s              5
     D WSKUNPA         s              1
     D MaxV            s              5
     D MaxVis          s              5  0
     D JSONstring      S          32000
     D Error           S            150
     D AntLest         S              9  0
      *get input-string
      /copy syspeds/qrpgsrcpy,prolog3

     C                   exsr      Parse

     C                   EXSR      INIT

     c                   callp     gethtmlifs(
     C                             '/syspeddev/html/JSON.html':
     C                             '/CGITAG/')
     C                   callp     wrtsection('top')

      /free
        JSONstring='{'
        +'¬user¬ : ¬'+%trim(USER)+'¬, '
        +'¬soklk¬ : ¬'+%trim(SOKLK)+'¬, '
        +'¬soknvn¬ : ¬'+%trim(SOKNVN)+'¬, '
        +'¬varlk¬ : ¬'+%trim(VARLK)+'¬, '
        +'¬wst2kod¬ : ¬'+%trim(WST2KOD)+'¬, '
        +'¬wskunpa¬ : ¬'+%trim(WSKUNPA)+'¬, '
        +'¬error¬ : ¬'+%trim(ERROR)+'¬, ';
      /end-free
      * JSONfix escaper " i tekst,  for deretter å bytte ¬->"
     c                   call      'JSONFIX'
     c                   parm                    JSONstring
     C                   CALLP     updHTMLvar2('JSONstring'
     C                                         :%addr(JSONstring)
     C                                         :%len(JSONstring))
     C                   callp     wrtsection('JSONlin')
      * Find/send lines
     c     Error         IFEQ      *blanks
     C                   exsr      LINES
     C                   ENDIF

     c                   eval      JSONstring ='}'
     C                   CALLP     updHTMLvar2('JSONstring'
     C                                         :%addr(JSONstring)
     C                                         :%len(JSONstring))
     C                   callp     wrtsection('JSONlin')
      * Quit
     C                   exsr      Exit
      *=====================================================================
      * Parse input / cvt to numeric
      *=====================================================================
     C     Parse         begsr
      * Parse variables from QUERY_STRING environment variable
     C                   eval      SOKLK   = zhbgetvar('SOKLK')
     C                   eval      SOKLK   = uppify(SOKLK)
     C                   eval      SOKNVN  = zhbgetvar('SOKNVN')
     C                   eval      SOKNVN  = uppify(SOKNVN)
     C                   eval      MaxV    = zhbgetvar('MaxV')
     C                   eval      MaxVis  = c2n2(MaxV)
     C                   eval      VARLK   = zhbgetvar('VARLK')
     C                   eval      WST2KOD = zhbgetvar('WST2KOD')
      * Vis kun Postnr (P) eller vis kun Alfakode (A)
     C                   eval      WSKUNPA = zhbgetvar('WSKUNPA')
     c     MaxVis        ifeq      *zeros
     c                   z-add     50            MaxVis
     c                   end
      * Userid.....
     C                   eval      USER = zhbgetvar('USER')
     C                   endsr
      *=====================================================================
      * Close output html and quit
      *=====================================================================
     C     Exit          begsr
      * Do not delete the call to wrtsection with section name *fini.  It is needed
      * to ensure that all output html that has been buffered gets output.
     C                   callp     wrtsection('*fini')
      * Quit
     C                   CLOSE     BRIDF
     C  N50              CLOSE     Sted2A
     C  N50              CLOSE     Sted2S
     C                   MOVE      *ON           *INLR
     C                   return
     C                   endsr
      *=====================================================================
      * Fine lins - send to browser
      *=====================================================================
     C     Lines         begsr

     c                   eval      JSONstring ='"postnrlist" : ['
     C                   CALLP     updHTMLvar2('JSONstring'
     C                                         :%addr(JSONstring)
     C                                         :%len(JSONstring))
     C                   callp     wrtsection('JSONlin')

     c                   Move      *zeros        AntVist           5 0
     c                   eval      SOKNVN2   = SOKNVN
     C     SOKNVN        IFEQ      *BLANKS
     C     SOKLK         andeq     *BLANKS
     C*                  GOTO      UTLES
     C                   EVAL      SOKNVN2='A'
     C                   END

     C     SOKLK         IFNE      *BLANKS
     C     LkNvnKey      setll     Sted2A
     C     SOKLK         reade     Sted2A                                 33
     C                   ELSE
     C     NvnKey        setll     Sted2S
     C                   read      Sted2S                                 33
     C                   END
     C     *in33         DOWEQ     *OFF
     C     SOKNVN        Ifne      *blanks
     C     SOKNVN        SCAN      ST2NVN                                 34
     c     *IN34         CaBEQ     *OFF          UtLes
     c                   end
     C                   exsr      exclude
     c     EXCL          IFEQ      'N'

     C                   Add       1             AntLest
      /free
       if AntLest=1;
          JSONstring=*blanks;
          else;
          JSONstring=', ';
          endif;
       JSONstring=%trim(JSONstring)+'{'
          +'¬st2kod¬ : ¬'+%trim(ST2KOD)+'¬, '
          +'¬st2nvn¬ : ¬'+%trim(ST2NVN)+'¬, '
          +'¬st2lk¬ : ¬'+%trim(ST2LK)+'¬}';
      /end-free
     C                   call      'JSONFIX'
     C                   parm                    JSONstring
     C                   CALLP     updHTMLvar2('JSONstring'
     C                                         :%addr(JSONstring)
     C                                         :%len(JSONstring))
     C                   callp     wrtsection('JSONlin')


     c                   Add       1             AntVist           5 0
     c     AntVist       cabge     MaxVis        UtLes
     C                   END
     C     SOKLK         IFNE      *BLANKS
     C     SOKLK         reade     Sted2A                                 33
     C                   ELSE
     C                   read      Sted2S                                 33
     C                   END
     C                   end

     C     UTLES         TAG
     c                   eval      JSONstring =']'
     C                   CALLP     updHTMLvar2('JSONstring'
     C                                         :%addr(JSONstring)
     C                                         :%len(JSONstring))
     C                   callp     wrtsection('JSONlin')
     C                   endsr
      *=====================================================================******
      *  Eksluder post basert på...
      *=====================================================================******
     C     EXCLUDE       begsr
     C                   Move      'J'           EXCL              1
      * diverse tester - om ikke bestått hopp ut (med J i EXCL)
      * vis kun postnummer (numeriske)
     c     WSKUNPA       Ifeq      'P'
     c     ST2KOD        cablt     '00000'       UtExcl
     c     ST2KOD        cabgt     '99999'       UtExcl
     c                   end
      * vis kun Alfakoder
     c     WSKUNPA       Ifeq      'A'
     c     ST2KOD        andge     '00000'
     c     ST2KOD        andle     '99999'
     c                   Goto      UtExcl
     c                   end
      * Kun en kode
     c     WST2KOD       IFNE      *BLANKS
     c     WST2KOD       ANDNE     ST2KOD
     c                   Goto      UtExcl
     c                   ENDIF
      * Posten skal med på liste
     C                   Move      'N'           EXCL              1
      *
     C     UTEXCL        endsr
      *=====================================================================******
      *  INITIER
      *=====================================================================******
     C     INIT          begsr
     C                   OPEN      BRIDF
     C     USER          CHAIN     BRIDF                              50
      * En "standardvariant" libl: call bound (INCGI=*MODULE) med parameter.
     C     BILIBL        ifeq      *blanks
     C                   callb     'INCGI'
     C                   parm                    BISTDL
     C                   else
      * Helt egen bibl.liste satt på user - normal CALL (BILIBL er "*pgm")
     C                   call      BILIBL
     C                   end
      * hent Parametre som går igjen i mange prog:
      *      Odd/Even/Rowhead-farger,Logobilde,Språk,Intern/Ekstern bruker,  mm
     c                   call      'ESGETPAR'
     c                   parm                    BIBRID
     c                   parm                    BIFIRM
     c                   parm                    BIKUNR
     c                   parm                    BIKNG
     c                   parm                    RowHead          10
     c                   parm                    Odd              10
     c                   parm                    Even             10
     c                   parm                    LogoImg          50
     c                   parm                    XSPRÅK            2
     c                   parm                    XINTERN           1
     c                   parm                    ParmDS1        1024
     c                   parm                    ParmDS2        1024
     c                   parm                    ParmDS3        1024
     C  N50              OPEN      Sted2A
     C  N50              OPEN      Sted2S
      * Key for Sted2A  landkode + stedsnavn
     C     LkNvnKey      KLIST
     C                   KFLD                    SOKLK
     C                   KFLD                    SOKNVN2
      * Key for Sted2S - Stedsnavn
     C     NvnKey        KLIST
     C                   KFLD                    SOKNVN2
     C                   endsr
