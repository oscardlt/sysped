********************************************************************
      * RETTINGER I DETTE PROGRAM:
PTFnr:*Sek Sig Vers  Beskrivelse...........................
""""""*"""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""
12XXX * XX SH  PTF12 forbedringer
********************************************************************
********************************************************************
      * les regneark finne verdier
     Fautoini   IP   E             DISK
     FEDIRE1K   IF   E           K DISK
     FFIRM      IF   E           K DISK
     D                 DS
     D  dtafld                 1  54000
     D                                     DIM(180)
     D                 DS
     D  RDATA                  1   1024
     D  RTYP                   1      6
     D  RTYP4                  1      4
     D  RTYP4B                 4      7
     D                 DS
     D  ZDEC                   1      7  6
     D  ZDEC6                  2      7
     D  ZHEL                  11     22  0
     D                 DS
     D  DAFM                   1      3
     D  DAF                    1      3
     D                                     DIM(3)
     D                 DS
     D  FADA                   1     10
     D  FA                     1     10
     D                                     DIM(10)
     D                 DS
     D  nyda                   1      8
     D  aar                    1      4  0
     D  mnd                    5      6  0
     D  dag                    7      8  0
     D                 DS
     D  UNDER                  1     40
     D  UNDERT                 1      5
     D  UNDER1                 1      4
     D  UNDER2                 6     40
     D                 DS
     D  A                      1     79
     D                                     DIM(79)
     D                 DS
     D  B                      1     18
     D                                     DIM(18)
      * gjør om blanke til 0
     D TIL             C                   CONST('0')
     D FRA             C                   CONST(' ')
      */////////////
      * MAIN LOGIC /
      */////////////
     c     *in99         ifne      '1'
     C                   EXSR      INIT
     c                   move      '1'           *in99
     c                   end
     c     knra          ifeq      *blanks
     C                   EXSR      FINNFI
     c     knra          ifne      *blanks
     c                   exsr      finnda
     c                   exsr      fixpara
     C                   MOVE      '1'           *INLR
     c                   return
     c                   end
     c                   end
      *
      *****************************************************************
     C     INIT          BEGSR
      *****************************************************************
      *
     c                   eval      retur='Import_toll;'
      *
     C     *ENTRY        PLIST
     C                   PARM                    UMBR             10
     C                   PARM                    RETUR            80
     C                   MOVE      *ZEROS        NYDA
     c                   read      firm                                   33
     C                   ENDSR
      *
      *************************************************************
     C     GETNUM        BEGSR
      *************************************************************
      *
     c                   move      'N'           minus             1
     C                   MOVE      *ZEROS        ZHEL
     C                   MOVE      *ZEROS        ZDEC
     C                   MOVE      *ZEROS        B
     C                   Z-ADD     1             AX                2 0
     C                   Z-ADD     1             BX                2 0
      * minus
     c     A(AX)         ifeq      '-'
     c                   move      'J'           minus             1
     c                   add       1             ax
     c                   end
      * Get Integer
     C     A(AX)         DOWGE     '0'
     C     ZHEL          MULT      10            ZHEL
     C                   MOVE      A(AX)         ZHEL
     C                   ADD       1             AX
     C                   ENDDO
      * Decimal point ?
     C     A(AX)         IFEQ      '.'
     C     A(AX)         OREQ      ','
     C                   ADD       1             AX
     C     A(AX)         DOWGE     '0'
     C                   MOVE      A(AX)         B(BX)
     C                   ADD       1             AX
     C                   ADD       1             BX
     C                   ENDDO
     C                   MOVEA     B             ZDEC6
     C                   ENDIF
      * Concatenate
     C                   Z-ADD     ZHEL          ZNUM             18 6
     C                   ADD       ZDEC          ZNUM
     c     minus         ifeq      'J'
     c                   z-sub     znum          znum
     c                   end
     C                   ENDSR
      ********************************************************************
     C     FINNFI        BEGSR
      ********************************************************************
      *
     C     UMBR          SETLL     EDIRE1K
     C     UMBR          READE     EDIRE1K                                91
     C     *IN91         DOWEQ     *OFF
      *
      * Kaller eksternt program og legger felt i array
      *
     C                   MOVEL     RDATA         UDATA          4096
     C                   MOVEL     *BLANKS       UARRA         54000
     C                   MOVE      ';'           SKILLET           1
     C                   CALL      'SYGE111'
     C                   PARM                    SKILLET
     C                   PARM                    UDATA
     C                   PARM                    UARRA
     c                   movea     uarra         dtafld

      * LESER LINJE 1
     C     dtafld(navk)  IFEQ      NAV
     c                   move      knr           knra              8
     c     retur         cat       knra:0        retur
     c     retur         cat       ';':0         retur
     c                   goto      utfir
     c                   end

     C     UMBR          READE     EDIRE1K                                91
     C                   ENDDO
     c     utfir         endsr
      ********************************************************************
     C     FINNDA        BEGSR
      ********************************************************************
      *
     C     UMBR          SETLL     EDIRE1K
     C     UMBR          READE     EDIRE1K                                91
     C     *IN91         DOWEQ     *OFF
      *
      * Kaller eksternt program og legger felt i array
      *
     C                   MOVEL     RDATA         UDATA          4096
     C                   MOVEL     *BLANKS       UARRA         54000
     C                   MOVE      ';'           SKILLET           1
     C                   CALL      'SYGE111'
     C                   PARM                    SKILLET
     C                   PARM                    UDATA
     C                   PARM                    UARRA
     c                   movea     uarra         dtafld

      * fakturanummer
     c     intk          ifne      *zeros
     C     dtafld(intk)  IFEQ      INT
     c                   movel     dtafld(invk)  fanr             15
     c                   end
     c                   end
      * fakturadao
     C     dtafld(datk)  IFEQ      dat
     c                   movel     dtafld(davk)  fada             10
     c                   exsr      fiksda
     c                   end

      * VALUTAKODE
     c     valu          ifeq      *blanks
     C     valk          ifne      0
     C     dtafld(valk)  IFEQ      val
     c                   movel     dtafld(vavk)  valu              3
     c                   end
     c                   else
     c                   move      ficurr        valu
     c                   end
     c                   end
      * beløp
     c     belk          ifne      0
     C     dtafld(belk)  IFEQ      BEL
     c                   movel     dtafld(bevk)  belo             15
     c                   end
     c                   end
     C     UMBR          READE     EDIRE1K                                91
     C                   ENDDO
     c                   endsr
      ********************************************************************
     C     FIKSDA        BEGSR
      ********************************************************************
      *
      * Kaller eksternt program og legger felt i array
      *
     c                   move      *blanks       UDATA
     C                   MOVEL     fada          UDATA          4096
     C                   MOVEL     *BLANKS       UARRA         54000
     C                   MOVE      DASK          SKILLET           1
     C                   CALL      'SYGE111'
     C                   PARM                    SKILLET
     C                   PARM                    UDATA
     C                   PARM                    UARRA
     c                   movea     uarra         dtafld
     c* felt 1
     c     1             do        3             nr                2 0
     c     daf(nr)       ifeq      'D'
     c                   movea     dtafld(nr)    A
     C                   EXSR      GETNUM
     C                   Z-ADD     ZNUM          dag
     c                   end
     c     daf(nr)       ifeq      'M'
     c                   movea     dtafld(nr)    A
     C                   EXSR      GETNUM
     C                   Z-ADD     ZNUM          mnd
     c                   end
     c     daf(nr)       ifeq      'Y'
     c                   movea     dtafld(nr)    A
     C                   EXSR      GETNUM
     C                   Z-ADD     ZNUM          aar
     c                   end
     c                   enddo
     c                   endsr
      ********************************************************************
     C     fixpara       BEGSR
      ********************************************************************
      * fakturanummer
     c     retur         cat       fanr:0        retur
     c     retur         cat       ';':0         retur
      * fakturadao
     c     retur         cat       nyda:0        retur
     c     retur         cat       ';':0         retur
      * VALUTAKODE
     c     retur         cat       valu:0        retur
     c     retur         cat       ';':0         retur
      * beløp
     c     retur         cat       belo:0        retur
     c     retur         cat       ';':0         retur
     c                   endsr
