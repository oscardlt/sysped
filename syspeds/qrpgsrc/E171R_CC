     H DATEDIT(*YMD)
      *********************************************************************
      * KONVERTER FAKTURA I FLATFIL TIL KOSTNAD
CRTPGM* CRTPGM SYSPED/E171R_CC MODULE(*LIBL/E171R_CC) ACTGRP(CGI) AUT(*USE)
      **************************************************************
      /copy syspeds/qrpgsrcpy,hspecs
      /copy syspeds/qrpgsrcpy,hspecsbnd
     FARKIVP    O  A E             DISK
     FFIRM      IF   E           K DISK
     FKODTGE    IF   E           K DISK
     FHEADF     IF   E           K DISK
     FEDIM      UF   E           K DISK
     FEDIRE1K   IF   E           K DISK
     FFRISOK    O  A E           K DISK
     FKOSTT     UF   E           K DISK
     FKOSTA     O  A E           K DISK
     FKOSTB     O  A E             DISK
     FE171F     O  A E             DISK
     FE171FGML  IF   E           K DISK    RENAME(E171FR:E171FRGML)
     F                                     PREFIX(GM_)
     FE171P     O    E             PRINTER OFLIND(*IN27)
     FE171PARK  O    E             PRINTER OFLIND(*IN37)
     F                                     RENAME(E171P1:E171P1A)
     F                                     RENAME(E171P2:E171P2A)
     F                                     RENAME(E171P3:E171P3A)
      /copy syspeds/qrpgsrcpy,prototypeb
      /copy syspeds/qrpgsrcpy,usec
      *___________________________
      * Finner username
      *"""""""""""""""""""""""""""
     D                SDS
     D  UUSER                254    263
     D                 DS
     D  RDATA                  1   1024
     D  RD                     1   1024    DIM(1024)
     D                 DS
     D  XAN75                  1     75
     D  XAN751                 1     15
     D  XAN752                16     30
     D  T1                     1     75    DIM(75)
     D                 DS
     D  KAPER                  1      6  0
     D  KAPCC                  1      2  0
     D  KAPÅR                  3      4  0
     D  KAPMN                  5      6  0
     D                 DS
     D  KABDT                  1      8  0
     D  KABA                   3      4  0
     D  KABM                   5      6  0
     D  KABD                   7      8  0
     D                 DS
     D  E171FN                 1     17
     D  E171FNA10              1     10
     D                 DS
     D  E171AN                 1     15
     D  E171ANA10              1     10
     IEDIMR
     I              MMN                         TVIMMN
      */////////////
      * MAIN LOGIC /
      */////////////
      *___________
      * Initiering
      *"""""""""""
     C                   EXSR      INIT
      *________
      * CONVERT
      *""""""""
     C  N20              EXSR      RTVD
      *
     C                   SETON                                        LR
     C                   RETURN
      *////////////////////////////////////////////////////////////
      *                                                      INIT /
      *////////////////////////////////////////////////////////////
     C     INIT          BEGSR
     C     E171FK        KLIST
     C                   KFLD                    E171AVD
     C                   KFLD                    E171OPD
     C     KODTGEK       KLIST
     C                   KFLD                    KGEUNI
     C                   KFLD                    KAVK
      *
     C     *ENTRY        PLIST
     C                   PARM                    UMBR             10
     C                   PARM                    KOPI              1
     C                   PARM                    UINFOP            1
     C                   PARM                    UBANEA           70
     C                   PARM                    UBANEB           70
      *
     C                   READ      FIRM                                   33
      *
     C                   EVAL      UINFOP = 'J'
     C                   EVAL      ARSTAT = 'A'
     C                   EVAL      ARFIRM = FIFIRM
     C                   EVAL      ARUNDE = 'KL:'
     C                   EVAL      ARUSER = UUSER
     C                   CALL      'SYGE15C'
     C                   PARM                    WDT               8
     C                   PARM                    WTM               6
     C                   MOVE      WDT           ARDATE
     C                   MOVE      WTM           ARTIME
      *
     C                   MOVE      X'1A'         WÆ                1
     C                   MOVE      X'14'         WØ                1
     C                   MOVE      X'39'         WØ2               1
     C                   MOVE      X'1B'         WÅ                1
     C                   MOVE      X'06'         WÆLITE            1
     C                   MOVE      X'90'         WØLITE            1
     C                   MOVE      X'34'         WÅLITE            1
      *
     C                   ENDSR
      *////////////////////////////////////////////////////////////
      * RETREIVE INFO FROM EDIFACT DATABASE TO SYSPED400     RTVD /
      *////////////////////////////////////////////////////////////
     C     RTVD          BEGSR
     C                   CALL      'SYGE15C'
     C                   PARM                    WDT               8
     C                   PARM                    WTM               6
     C                   MOVE      WDT           E171DT
     C                   MOVE      WTM           E171TD
     C                   MOVE      UMBR          E171MBR
     C                   MOVE      *ZEROS        XTOTBLN
     C                   MOVE      *ZEROS        XTOTBLB
     C                   MOVE      *ZEROS        XTOTMV
     C                   Z-ADD     1             XSIDE
     C                   Z-ADD     0             XLNR
     C                   CALL      'ARCRAN'
     C                   PARM                    RANTAL           10
      *
      *
     C                   IF        KOPI  <> 'J'
     C     'Ø'           CHAIN     KOSTT                              20
     C     *IN20         IFEQ      '0'
     C                   Z-ADD     KTNR          KABNR
     C                   ADD       1             KTNR
     C                   UPDATE    KOSTTR
     C                   ENDIF
      *___________________
      * HENTE BILAGSNUMMER
      *"""""""""""""""""""
     C     'A'           CHAIN     KOSTT                              20
     C     *IN20         IFEQ      '0'
     C                   Z-ADD     KTNR          KABNR2
     C                   Z-ADD     KTNR          E171BN
     C                   ADD       1             KTNR
     C                   UPDATE    KOSTTR
     C                   ENDIF
      *________________________
      * OPPDATER FELTER I KOSTA
      *""""""""""""""""""""""""
     C                   MOVE      'NOK'         KAVAL
     C                   Z-ADD     100           KAVKU
     C                   Z-ADD     100           KAOMRF
     C                   EVAL      KAFNR = 'FAKT.'
     C                   MOVE      KABNR2        KAFNR
     C                   MOVE      'EDI'         KASG
     C                   MOVE      'P'           KAMVA
     C                   MOVE      'FR2'         KAVK
     C                   MOVE      WDT           KAFDT
     C                   MOVE      WDT           KABDT
     C                   MOVEL     WDT           KAPER
     C                   MOVE      WDT           KAFFDT
     C*                  EVAL      KALKID = 'XXX'
     C                   ENDIF
      *
      * PRINTER HEADING
     C                   WRITE     E171P1
     C                   WRITE     E171P1A
      *
     C     UMBR          SETLL     EDIRE1K
     C     UMBR          READE     EDIRE1K                                33
     C  N33UMBR          READE     EDIRE1K                                33
     C                   DOW       *IN33 = *OFF
      * HENT OPPDRAGSNR
     C                   Z-ADD     1             XN                3 0
     C                   MOVE      *BLANKS       T1
     C                   MOVE      *ZEROS        E171AVD
     C                   MOVE      *ZEROS        E171OPD
     C                   DO        50
     C     RD(XN)        IFEQ      '/'
     C                   LEAVE
     C                   END
     C                   MULT      10            E171AVD
     C                   MOVE      RD(XN)        E171AVD
     C                   ADD       1             XN
     C                   ENDDO
     C                   ADD       1             XN
     C                   DO        50
     C     RD(XN)        IFEQ      '/'
     C     RD(XN)        OREQ      ';'
     C                   LEAVE
     C                   END
     C                   MULT      10            E171OPD
     C                   MOVE      RD(XN)        E171OPD
     C                   ADD       1             XN
     C                   ENDDO
     C                   DO        50
     C     RD(XN)        IFEQ      ';'
     C                   LEAVE
     C                   END
     C                   ADD       1             XN
     C                   ENDDO
      * HENT FRAKTBREVNR
     C                   ADD       1             XN                3 0
     C                   MOVE      *BLANKS       T1
     C                   MOVE      *ZEROS        X2                3 0
     C                   MOVE      'J'           XUPCASE           1
     C                   DO        50
     C     RD(XN)        IFEQ      ';'
     C                   LEAVE
     C                   END
     C     RD(XN)        IFNE      '"'
     C                   ADD       1             X2
     C                   EXSR      FLYTT
     C                   END
     C                   ADD       1             XN
     C                   ENDDO
     C                   MOVEL     XAN751        E171FBN
      * HENT FAKTURANR
     C                   ADD       1             XN                3 0
     C                   MOVE      *BLANKS       T1
     C                   MOVE      *ZEROS        X2                3 0
     C                   DO        50
     C     RD(XN)        IFEQ      ';'
     C                   LEAVE
     C                   END
     C     RD(XN)        IFNE      '"'
     C                   ADD       1             X2
     C                   EXSR      FLYTT
     C                   END
     C                   ADD       1             XN
     C                   ENDDO
     C                   MOVEL     XAN751        E171FN
      * HENT AGENTREF
     C                   ADD       1             XN                3 0
     C                   MOVE      *BLANKS       T1
     C                   MOVE      *ZEROS        X2                3 0
     C                   DO        50
     C     RD(XN)        IFEQ      ';'
     C                   LEAVE
     C                   END
     C     RD(XN)        IFNE      '"'
     C                   ADD       1             X2
     C                   EXSR      FLYTT
     C                   END
     C                   ADD       1             XN
     C                   ENDDO
     C                   MOVEL     XAN751        E171AN
      * HENT FAKTURA TOTAL
     C                   ADD       1             XN                3 0
     C                   MOVE      *BLANKS       T1
     C                   MOVE      *ZEROS        X2                3 0
     C                   DO        50
     C     RD(XN)        IFEQ      ';'
     C                   LEAVE
     C                   END
     C     RD(XN)        IFNE      '"'
     C                   ADD       1             X2
     C                   EXSR      FLYTT
     C                   END
     C                   ADD       1             XN
     C                   ENDDO
     C                   EVAL      E171BLS  = c2n2(XAN751)
      * HENT TRANSPORT
     C                   ADD       1             XN                3 0
     C                   MOVE      *BLANKS       T1
     C                   MOVE      *ZEROS        X2                3 0
     C                   DO        50
     C     RD(XN)        IFEQ      ';'
     C                   LEAVE
     C                   END
     C     RD(XN)        IFNE      '"'
     C                   ADD       1             X2
     C                   EXSR      FLYTT
     C                   END
     C                   ADD       1             XN
     C                   ENDDO
     C                   EVAL      E171BLT  = c2n2(XAN751)
      * HENT DIESEL TILLEGG
     C                   ADD       1             XN                3 0
     C                   MOVE      *BLANKS       T1
     C                   MOVE      *ZEROS        X2                3 0
     C                   DO        50
     C     RD(XN)        IFEQ      ';'
     C                   LEAVE
     C                   END
     C     RD(XN)        IFNE      '"'
     C                   ADD       1             X2
     C                   EXSR      FLYTT
     C                   END
     C                   ADD       1             XN
     C                   ENDDO
     C                   EVAL      E171BLD  = c2n2(XAN751)
      * HENT PRIVAT LEVERING
     C                   ADD       1             XN                3 0
     C                   MOVE      *BLANKS       T1
     C                   MOVE      *ZEROS        X2                3 0
     C                   DO        50
     C     RD(XN)        IFEQ      ';'
     C                   LEAVE
     C                   END
     C     RD(XN)        IFNE      '"'
     C                   ADD       1             X2
     C                   EXSR      FLYTT
     C                   END
     C                   ADD       1             XN
     C                   ENDDO
     C                   EVAL      E171BLP  = c2n2(XAN751)
      * HENT ADVISERING
     C                   ADD       1             XN                3 0
     C                   MOVE      *BLANKS       T1
     C                   MOVE      *ZEROS        X2                3 0
     C                   DO        50
     C     RD(XN)        IFEQ      ';'
     C                   LEAVE
     C                   END
     C     RD(XN)        IFNE      '"'
     C                   ADD       1             X2
     C                   EXSR      FLYTT
     C                   END
     C                   ADD       1             XN
     C                   ENDDO
     C                   EVAL      E171BLA  = c2n2(XAN751)
      * HENT ANDRE GEBYR
     C                   ADD       1             XN                3 0
     C                   MOVE      *BLANKS       T1
     C                   MOVE      *ZEROS        X2                3 0
     C                   DO        50
     C     RD(XN)        IFEQ      ';'
     C                   LEAVE
     C                   END
     C     RD(XN)        IFNE      '"'
     C                   ADD       1             X2
     C                   EXSR      FLYTT
     C                   END
     C                   ADD       1             XN
     C                   ENDDO
     C                   EVAL      E171BLG  = c2n2(XAN751)
      * FAKTURASUM UTEN MVA
     C                   ADD       1             XN                3 0
     C                   MOVE      *BLANKS       T1
     C                   MOVE      *ZEROS        X2                3 0
     C                   DO        50
     C     RD(XN)        IFEQ      ';'
     C                   LEAVE
     C                   END
     C     RD(XN)        IFNE      '"'
     C                   ADD       1             X2
     C                   EXSR      FLYTT
     C                   END
     C                   ADD       1             XN
     C                   ENDDO
     C                   EVAL      E171BLN  = c2n2(XAN751)
      * MOMS
     C                   ADD       1             XN                3 0
     C                   MOVE      *BLANKS       T1
     C                   MOVE      *ZEROS        X2                3 0
     C                   DO        50
     C     RD(XN)        IFEQ      ';'
     C                   LEAVE
     C                   END
     C     RD(XN)        IFNE      '"'
     C                   ADD       1             X2
     C                   EXSR      FLYTT
     C                   END
     C                   ADD       1             XN
     C                   ENDDO
     C                   EVAL      E171BLM  = c2n2(XAN751)
      *
     C                   MOVE      'N'           E171ST
     C     E171FK        CHAIN     E171FGML                           33
     C  N33              IF        KOPI  = 'J'
     C                   MOVE      'K'           E171ST
     C                   ELSE
     C                   MOVE      'C'           E171ST
     C                   END
      *
     C     E171FK        CHAIN     HEADF                              20
     C   20              EVAL      XST = '*'
     C  N20              EVAL      XST = ' '
      *___________________
      * OPPDATER KOSTB
      *"""""""""""""""""""
     C                   IF        KOPI  <> 'J'
     C                   CLEAR                   KOSTBR
     C     KODTGEK       CHAIN     KODTGE                             33
     C                   EVAL      KBBILT = KGENOT
     C                   IF        XST = '*'
     C                   MOVE      *ZEROS        KBAVD
     C                   MOVE      *ZEROS        KBOPD
     C                   ELSE
     C                   MOVE      E171AVD       KBAVD
     C                   MOVE      E171OPD       KBOPD
     C                   END
     C                   Z-ADD     KABNR         KBBNR
     C                   MOVE      'FR2'         KBVK
     C                   MOVE      'F'           KBKDPF
     C                   Z-ADD     E171BLN       KBBLHB
     C                   IF        E171BLM = 0
     C                   MOVE      'F'           KBKDPF
     C                   MOVE      'N'           KBKDMV
     C                   Z-ADD     0             KBKDM
     C                   ELSE
     C                   MOVE      'P'           KBKDPF
     C                   MOVE      'J'           KBKDMV
     C                   Z-ADD     1             KBKDM
     C                   END
     C                   Z-ADD     10            KBKN
     C                   WRITE     KOSTBR
     C                   MOVE      E171AVD       FSAVD
     C                   MOVE      E171OPD       FSOPD
     C                   MOVE      '*IN'         FSKODE
     C                   MOVE      WDT           FSDTOP
     C                   EVAL      FSSOK = E171FN
     C                   WRITE     FRISOKR
     C                   END
      *
     C                   EXSR      OPDARKLIN
     C                   WRITE     E171FR
     C                   ADD       E171BLN       XTOTBLN
     C                   ADD       E171BLS       XTOTBLB
     C                   ADD       E171BLM       XTOTMV
      *
     C   27              WRITE     E171P1
     C   27              EVAL      XSIDE = XSIDE + 1
     C   27              EVAL      *IN37 = *ON
     C   27              EVAL      *IN27 = *OFF
     C                   ADD       1             XLNR
     C                   WRITE     E171P2
     C   37              WRITE     E171P1A
     C   37              EVAL      *IN37 = *OFF
     C                   WRITE     E171P2A
      *
     C     UMBR          READE     EDIRE1K                                33
     C                   ENDDO
      *
      * PRINTER BUNN
     C   27              WRITE     E171P1
     C   27              EVAL      XSIDE = XSIDE + 1
     C   27              EVAL      *IN37 = *ON
     C   27              EVAL      *IN27 = *OFF
     C                   WRITE     E171P3
     C   37              WRITE     E171P1A
     C   37              EVAL      *IN37 = *OFF
     C                   WRITE     E171P3A
      *___________________
      * OPPDATER KOSTA
      *"""""""""""""""""""
     C                   EVAL      KABL = XTOTBLN                               TOTAL NETTO
     C                   WRITE     KOSTAR
     C                   EXSR      OPDARKTOT
      *
     C                   ENDSR
      *
      ****************************************************
     C     OPDARKLIN     begsr
      ****************************************************
      * FAKTURA
     C                   EVAL      ARAVD = E171AVD
     C                   EVAL      AROPD = E171OPD
     C                   MOVE      KABNR         ARUNDE
     C                   EVAL      ARTYPE = 'ZU'
     C                   MOVE      KABNR         XAN07             7
     C                   EVAL      ARLINK = 'ZU' + %SUBST(WDT:1:4)
     C                             + XAN07 + RANTAL + '.pdf'
     C                   WRITE     ARKIVR
     C                   EVAL      UBANEA = '/nas/sca/'
     C                             + %TRIM(ARLINK)
      * KONTROLLISTE
     C*                  EVAL      ARTYPE = 'ZD'
     C*                  EVAL      ARLINK = 'ZD' + %SUBST(WDT:1:4)
     C*                            + XAN04 + XAN07 + RANTAL + '.pdf'
     C*                  WRITE     ARKIVR
     C*                  EVAL      UBANEB = '/nas/sca/'
     C*                            + %TRIM(ARLINK)
      *
     C                   ENDSR
      *
      ****************************************************
     C     OPDARKTOT     begsr
      ****************************************************
      * FAKTURA
     C                   EVAL      ARAVD = 0
     C                   EVAL      AROPD = 0
     C                   MOVE      KABNR         ARUNDE
     C                   EVAL      ARTYPE = 'ZU'
     C                   MOVE      KABNR         XAN07             7
     C                   EVAL      ARLINK = 'ZU' + %SUBST(WDT:1:4)
     C                             + XAN07 + RANTAL + '.pdf'
     C                   WRITE     ARKIVR
     C                   EVAL      UBANEA = '/nas/sca/'
     C                             + %TRIM(ARLINK)
      * KONTROLLISTE
     C*                  EVAL      ARTYPE = 'ZD'
     C*                  EVAL      ARLINK = 'ZD' + %SUBST(WDT:1:4)
     C*                            + XAN07 + RANTAL + '.pdf'
     C*                  WRITE     ARKIVR
     C*                  EVAL      UBANEB = '/nas/sca/'
     C*                            + %TRIM(ARLINK)
      *
     C                   ENDSR
      *
     C***********************************************
     C     FLYTT         BEGSR
     C***********************************************
     C     XUPCASE       IFEQ      'J'
      *
     C                   SELECT
     C     RD(XN)        WHENEQ    WÆ
     C                   MOVE      'Æ'           T1(X2)
     C     RD(XN)        WHENEQ    WØ
     C                   MOVE      'Ø'           T1(X2)
     C     RD(XN)        WHENEQ    WØ2
     C                   MOVE      'Ø'           T1(X2)
     C     RD(XN)        WHENEQ    WÅ
     C                   MOVE      'Å'           T1(X2)
     C     RD(XN)        WHENEQ    WÆLITE
     C                   MOVE      'Æ'           T1(X2)
     C     RD(XN)        WHENEQ    WØLITE
     C                   MOVE      'Ø'           T1(X2)
     C     RD(XN)        WHENEQ    WÅLITE
     C                   MOVE      'Å'           T1(X2)
     C     RD(XN)        WHENEQ    'a'
     C                   MOVE      'A'           T1(X2)
     C     RD(XN)        WHENEQ    'b'
     C                   MOVE      'B'           T1(X2)
     C     RD(XN)        WHENEQ    'c'
     C                   MOVE      'C'           T1(X2)
     C     RD(XN)        WHENEQ    'd'
     C                   MOVE      'D'           T1(X2)
     C     RD(XN)        WHENEQ    'e'
     C                   MOVE      'E'           T1(X2)
     C     RD(XN)        WHENEQ    'f'
     C                   MOVE      'F'           T1(X2)
     C     RD(XN)        WHENEQ    'g'
     C                   MOVE      'G'           T1(X2)
     C     RD(XN)        WHENEQ    'h'
     C                   MOVE      'H'           T1(X2)
     C     RD(XN)        WHENEQ    'i'
     C                   MOVE      'I'           T1(X2)
     C     RD(XN)        WHENEQ    'g'
     C                   MOVE      'G'           T1(X2)
     C     RD(XN)        WHENEQ    'k'
     C                   MOVE      'K'           T1(X2)
     C     RD(XN)        WHENEQ    'l'
     C                   MOVE      'L'           T1(X2)
     C     RD(XN)        WHENEQ    'm'
     C                   MOVE      'M'           T1(X2)
     C     RD(XN)        WHENEQ    'n'
     C                   MOVE      'N'           T1(X2)
     C     RD(XN)        WHENEQ    'o'
     C                   MOVE      'O'           T1(X2)
     C     RD(XN)        WHENEQ    'p'
     C                   MOVE      'P'           T1(X2)
     C     RD(XN)        WHENEQ    'q'
     C                   MOVE      'Q'           T1(X2)
     C     RD(XN)        WHENEQ    'r'
     C                   MOVE      'R'           T1(X2)
     C     RD(XN)        WHENEQ    's'
     C                   MOVE      'S'           T1(X2)
     C     RD(XN)        WHENEQ    't'
     C                   MOVE      'T'           T1(X2)
     C     RD(XN)        WHENEQ    'u'
     C                   MOVE      'U'           T1(X2)
     C     RD(XN)        WHENEQ    'v'
     C                   MOVE      'V'           T1(X2)
     C     RD(XN)        WHENEQ    'w'
     C                   MOVE      'W'           T1(X2)
     C     RD(XN)        WHENEQ    'x'
     C                   MOVE      'X'           T1(X2)
     C     RD(XN)        WHENEQ    'y'
     C                   MOVE      'Y'           T1(X2)
     C     RD(XN)        WHENEQ    'z'
     C                   MOVE      'Z'           T1(X2)
     C     RD(XN)        WHENEQ    'æ'
     C                   MOVE      'Æ'           T1(X2)
     C     RD(XN)        WHENEQ    'ø'
     C                   MOVE      'Ø'           T1(X2)
     C     RD(XN)        WHENEQ    'å'
     C                   MOVE      'Å'           T1(X2)
     C                   OTHER
     C                   MOVE      RD(XN)        T1(X2)
     C                   ENDSL
      *
     C                   ELSE
      *
     C                   SELECT
     C     RD(XN)        WHENEQ    WÆ
     C                   MOVE      'Æ'           T1(X2)
     C     RD(XN)        WHENEQ    WØ
     C                   MOVE      'Ø'           T1(X2)
     C     RD(XN)        WHENEQ    WØ2
     C                   MOVE      'Ø'           T1(X2)
     C     RD(XN)        WHENEQ    WÅ
     C                   MOVE      'Å'           T1(X2)
     C     RD(XN)        WHENEQ    WÆLITE
     C                   MOVE      'Æ'           T1(X2)
     C     RD(XN)        WHENEQ    WØLITE
     C                   MOVE      'Ø'           T1(X2)
     C     RD(XN)        WHENEQ    WÅLITE
     C                   MOVE      'Å'           T1(X2)
     C                   OTHER
     C                   MOVE      RD(XN)        T1(X2)
     C                   ENDSL
      *
     C                   END
      *
     C                   ENDSR
      *
