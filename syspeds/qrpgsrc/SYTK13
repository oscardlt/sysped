      *
      ************************************************************
      *** PROGRAM for å generere importfil for Autoroute       ***
      ***         En bils posisjoner i tidsrom                 ***
      ************************************************************
********************************************************************
      * RETTINGER I DETTE PROGRAM:
PTFnr:*Sek Sig Vers  Beskrivelse...........................
""""""*"""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""
10XXX * 01 JOV PTF10 kode Google = Y svar skal til google maps
10XXX * 02 JOV PTF10 Endrin i JSON-objekt som returneres til Google
      * 03 JOV PTF10 GOOGLE-LOGIKK NÅ FLYTTET TIL ESTK13G-Dvs denne er nå KUN AUTOROUTE
      *              (bruker ikke tid på å rydde her, men fremtidig vedlikehold unødig)
********************************************************************
      *
     FTKGPS     IF   E           K DISK
     FTKUSER    IF   E           K DISK
N01  FUNITL04   IF   E           K DISK
N01  F*URER14   IF   E           K DISK
     FQ1024     O  A F 1024        DISK
     FSYTK13FM  CF   E             WORKSTN USROPN
     D Path            s            100
     D Post1           s              1
     D FeilOmr         s              1
     D Streng          s           1024
     D SJNR            s              1  0
     D Info1           s            100
     D Info2           s            100
     D Info3           s            100
     D Info4           s            100
N01  D SeTur           s            500
     D CurrTime        s               z
     D MinDs           ds
     D  Min                            z
     D  MinYear                       4    overlay(Min:1)
     D  MinMonth                      2    overlay(Min:6)
     D  MinDay                        2    overlay(Min:9)
     D  MinHour                       2    overlay(Min:12)
     D  MinMin                        2    overlay(Min:15)
     D  MinSec                        2    overlay(Min:18)
      *
     D MiniDs          ds
     D MiniDtTi                1     14  0
     D MiniYear                1      4  0
     D MiniMonth               5      6  0
     D MiniDay                 7      8  0
     D Today                   1      8  0
     D MiniHour                9     10  0
     D MiniMin                11     12  0
     D MiniSec                13     14  0
     D TodayA                  1      8
     D TodayHMSA               9     14
      *
     D TkdtDs          ds
     D TKDTTI                  1     14  0
     D TKDT                    1      8  0
     D TKTI                    9     14  0
      *
     D                 ds
     D WSDTTI                  1     14  0
     D WSDTT                   1      8  0
     D WSDTTA                  1      8
     D WSKLT6                  9     14  0
     D WSKLTA                  9     12
     D                 ds
     D WSDTF                   1      8  0
     D WSDTFA                  1      8
     D                 ds
     D WSKLF6                  1      6  0
     D WSKLF                   1      4  0
     D WSKLFA                  1      4
     D                 ds
     D WSTUR                   1      8  0
     D WSTURA                  1      8
      *___________________________
      * Finner username
      *"""""""""""""""""""""""""""
     D                SDS
     D  ZJOB                 244    253
     D  ZUSER                254    263
     D  ZJOBNR               264    269  0
     D                 DS
     D  ES_PATH                1    100
     D  ESPED                  1      5
     D  PATH6_50               6     50
     D  FRADT                 51     58
     D  FRAKL                 59     62
     D  TILDT                 63     70
     D  TILKL                 71     74
     D  SISPOS                75     75
     D  SJNRPDA               76     85
     D  TURNR                 86     93
     D                 DS
     D  TKBRE_GD               1      8  0
     D  TKBRE_G                1      2
     D  TKBRE_D                3      8
     D                 DS
     D  TKLEN_GD               1      9  0
     D  TKLEN_G                1      3
     D  TKLEN_D                4      9
N01   * Definere  hex appostrof
N01  D Ap              c                   x'7D'
      *
      *
     C     *entry        Plist
     C                   Parm                    PATH
     C                   move      Path          ES_PATH
      *
     C     KEY           KLIST
     C                   KFLD                    WSBRID
     C                   KFLD                    WSDTF
     C                   KFLD                    WSKLF6
      *
     C                   MOVE      *ZEROS        WSTUR
     C                   MOVE      *ZEROS        WSDTTI
     C                   MOVE      *ZEROS        WSDTF
     C                   MOVE      *ZEROS        WSKLF6
      *
      * Defaulter
     C     ZUSER         Chain     TKUSER                             33
     C   33'*DFT      '  Chain     TKUSER                             33
     c                   move      MAMAPP        WSMAPP
      * låner MiniDS for å finne "Today"
     C                   time                    Min
     c                   move      MinYear       MiniYear
     c                   move      MinMonth      MiniMonth
     c                   move      MinDay        MiniDay
     c                   move      MinHour       MiniHour
     c                   move      MinMin        MiniMin
     c                   move      MinSec        MiniSec
     c                   eval      WSFIL = 'EnBil_'
     C                   eval      WSDTF = Today
     C                   eval      WSKLF = 0000
     C                   eval      WSDTT = Today
     C                   eval      WSKLT = 2359
     c     ESPED         Ifeq      '*ES* '
n01  c     ESPED         oreq      '*ES*G'
n02  c     ESPED         oreq      '*ES*C'
     c                   eval      WsMapp  = Path6_50
     c                   move      TURNR         WSTUR
     c                   move      SJNRPDA       WSBRID
     c                   move      FRADT         WSDTF
     c                   move      FRAKL         WSKLF
     c                   move      TILDT         WSDTT
     c                   move      TILKL         WSKLT
     c                   move      SISPOS        WSSISP            1
n01  c*    TURNR         ifne      *blanks
n01  c*                  move      Turnr         TUpro
n01  c*    tupro         chain     Turer14                            33
n01  c*                  end
     c                   exsr      TestBi
     c                   else
     c                   open      SYTK13FM
     C*
     C     STBILD        TAG
     C                   EXFMT     BILDE01
     C* Fraktbrev 999 = CHG bekreftet håndtert
     C     *in12         cabeq     *ON           Slutt
     c                   exsr      TestBi
     c     *IN30         cabeq     '1'           STBILD
     c                   close     SYTK13FM
     c                   end
      * Lag fil:
     C                   Exsr      LagFil
     c                   eval      Path = %trim(WSMAPP)+
     c                                    %trim(WSFIL)+
     c                                    %trim(WSTURA)+'_'+
     c                                    %trim(WSDTFA)+'_'+
     c                                    %trim(WSKLFA)+'_'+
     c                                    %trim(WSDTTA)+'_'+
     c                                    %trim(WSKLTA)+'.csv'
      *
     C     Slutt         Tag
     C                   SETON                                        LR
     C                   RETURN
     C*
      ***************************************************************************
     C     TESTBI        BEGSR
      ***************************************************************************
     C                   move      *off          *IN30
      *
     C                   ENDSR
      ***************************************************************************
     C     Lagfil        BEGSR
      ***************************************************************************
      * Manipuler til-klokke over fra 4 sifret / 6-sifret felt
     C                   movel     WSKLT         WSKLT6
     C                   move      59            WSKLT6
      * 1.post - kolonneheadere...
     C                   move      'J'           Post1
      *
     C     StartLes      tag
     C     Key           setll     TKGPS
     C     WSBRID        Reade     TKGPS                                  50
     c     *in50         DOWEQ     '0'
     c     TKDTTI        CABGT     WSDTTI        Sluttles
      * Post funnet,
      ***
N01  c     ESPED         ifne      '*ES*G'
N02  c     ESPED         andne     '*ES*C'
     C                   exsr      EnPost
N01  c                   else
N01  C                   exsr      EnPostG
N01  c                   end
      ***
     C     WSBRID        Reade     TKGPS                                  50
     c                   end
     C     SluttLes      tag
      *
N01  c     ESPED         ifeq      '*ES*G'
N01  c     ESPED         oreq      '*ES*C'
s02  C*    Post1         andeq     'N'                                          minst en skrevet
N02  C     Post1         ifeq      'N'                                          minst en skrevet
N01  C                   eval      Streng = ']}'
N01  C                   EXCEPT    Qdata
N02  C                   end
N01  C                   end
     C                   ENDSR
      ***************************************************************************
     C     EnPost        BEGSR
      ***************************************************************************
      * Name,Address,Latitude,Longitude
     C     Post1         Ifeq      'J'
     C                   eval      Streng = 'Name,Name 2,'+
     C                                      'Latitude,Longitude'
     C                   EXCEPT    Qdata
     C                   move      'N'           Post1
     C                   end
      *
     c                   move      '+'           BreFor            1
     c                   move      '+'           LenFor            1
     c     TKLEN         iflt      0
     c                   mult      -1            TKLEN
     c                   move      '-'           LenFor
     c                   end
     c     TKBRE         iflt      0
     c                   mult      -1            TKBRE
     c                   move      '-'           BreFor
     c                   end
     C                   MOVE      TKLEN         TKLEN_GD
     C                   MOVE      TKBRE         TKBRE_GD
     C                   eval      Streng = TKBRID + ',' +
     C                             %trim(%editw(TKDT:'    .  .  ')) + '_' +
     C                             %trim(%editw(TKTI:'  :  :  ')) + ',' +
     c                             BreFor+TKBRE_G + '.' + TKBRE_D + ',' +
     c                             LenFor+TKLEN_G + '.' + TKLEN_D
     C                   EXCEPT    Qdata
     C                   ENDSR
N01
N01   ***************************************************************************
N01  C     EnPostG       BEGSR
N01   ***************************************************************************
N02  c                   add       1             postID            5 0
N01  c                   move      *blanks       Streng
N01  C     Post1         Ifeq      'J'
N01  C                   eval      Streng = '{"points": [ '
N01  C                   move      'N'           Post1
N01  C                   else
N01  c                   movel     ','           Streng                         komma mellom hver
N01  C                   end
N01   *
N01   *
N01  C                   move      TKBRID        SJNR
N01  c                   move      TKDT          TKDTA             8
N01  C                   move      TKBRID        SJÅFØR            8
N01  C                   eval      UNRETU = 'PDA:'+SJÅFØR
N01  C     UNRETU        chain     UnitL04                            33
N01  c   33              movel     TKBRID        UNBILN
N01
N01  c                   move      '+'           BreFor            1
N01  c                   move      '+'           LenFor            1
N01  c     TKLEN         iflt      0
N01  c                   mult      -1            TKLEN
N01  c                   move      '-'           LenFor
N01  c                   end
N01  c     TKBRE         iflt      0
N01  c                   mult      -1            TKBRE
N01  c                   move      '-'           BreFor
N01  c                   end
N01  C                   MOVE      TKLEN         TKLEN_GD
N01  C                   MOVE      TKBRE         TKBRE_GD
N01   /free
N01    // Ap=Hexavedi for single Appostrof for å kunne bruke inne i tekstkonst.(mellom '       ')
N01
N01    // Definer url i hjelpevariabel som skal inn i Infobobla
N01     SeTur  = '<a href='+Ap+'#'+Ap+' OnClick=\"window.open('+Ap
N01     +'../../sycgip/estk21.pgm?user=NN&SJ='
N01     +%trim(%editc(SJNR:'Z'))+'&DT='+TKDTA
N01    //+Ap+','+Ap+'GMwind'+Ap+','+Ap+'width=1245,height=800,left=15,top=30,' ****MED WIND-NAME??
N01     +Ap+','+Ap+Ap+','+Ap+'width=1245,height=800,left=15,top=30,'
N01     +'scrollbars,resizable'+Ap+')\">Se tur(er)</A>';
N01
N01    // Definer ETT punkt / en boble
N01     //Midlertidig ta høyde for lokal kjøring
N02     If  (ESPED = '*ES*G');
N01     Streng = %trim(Streng)+'{'
N01     +' "timestamp": "' + %trim(%editw(TKTI:'  :  :  ')) + '",'
N01     +' "pos":{"lat": "'+BreFor+TKBRE_G + '.' + TKBRE_D +'", '
N01             +'"lng": "'+LenFor+TKLEN_G + '.' + TKLEN_D +'"},'
N01     +' "icon": {"url":"images/truck.png", '
                   +'"offset": { "X":"3", "Y":"31"},'
                   +'"labeloffset": { "X":"2", "Y":"-22"},'
                   +'"title": "Title linje 1 \n'
                   +'Title linje 2", '
N01                +'"size":{"width":"64", "height":"32"}},'
N01     +' "unit": "'+%trim(UNBILN)+'", '
N01     +' "info":"'
N01     +'<h1>'+%trim(UNBILN)+'</h1>'
N01     +'SjåførID: '+ %trim(TKBRID)+'<br>'
N01     +'GPSTid: '+   %trim(%editw(TKDT:'    .  .  '))  +' '
N01     + %trim(%editw(TKTI:'  :  :  ')) +'<br>'
N01     +%trim(SeTur)
N01     +'"}';
N02     else;
N01      Streng = %trim(Streng)+'{'
N02      +' "id": "' + %trim(%editc(PostID:'Z')) + '",'
N01      +' "timestamp": "' + %trim(%editw(TKTI:'  :  :  ')) + '",'
N01      +' "pos":{"lat": "'+BreFor+TKBRE_G + '.' + TKBRE_D +'", '
N01              +'"lng": "'+LenFor+TKLEN_G + '.' + TKLEN_D +'"},'
N02      +' "address": {"address": "" ,"contrycode":""},'
N02      +' "icon": {"url":"images/truck.png", '
N02                 +'"size": {"width":"64", "height":"32"}, '
N02                 +'"title": "Title linje 1 \n'+'Title linje 2", '
N02                 +'"offset": { "X":"3", "Y":"31"}},'
N02      +' "label": {"text":"'+%trim(UNBILN)+'", '
N02                 +'"offset":{"X":"2","Y":"-22"}},'
N02      +' "info":"'
N02      +'<h1>'+%trim(UNBILN)+'</h1>'
N02      +'SjåførID: '+ %trim(TKBRID)+'<br>'
N02      +'GPSTid: '+   %trim(%editw(TKDT:'    .  .  '))  +' '
N02      + %trim(%editw(TKTI:'  :  :  ')) +'<br>'
N02      +%trim(SeTur) +'" ,'
N02      +' "unit": "'+%trim(UNBILN)+'", '
N02      +' "type":"car", '
N02      +' "group":""'
N02      +'}';
N02     endif;
N01   /end-free
N01  C                   EXCEPT    Qdata
N01  C                   ENDSR
     OQ1024     EADD         Qdata
     O                       STRENG            1024
