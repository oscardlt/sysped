      *********************************************************************
      *
CRTPG+*  CRTPGM SYSPED/TDCE091R MODULE(*LIBL/TDCE091R *LIBL/INCGI)
CRTPGM*        ACTGRP(*NEW) AUT(*USE)
      *
      *********************************************************************
      /copy SYSPEDS/qrpgsrcpy,hspecs
      /copy SYSPEDS/qrpgsrcpy,hspecsbnd
      *********************************************************************
     FBRIDF     IF   E           K DISK    USROPN
      *--------------------------------------------------------------------
      * Variables common to all CGIs
      *--------------------------------------------------------------------
      /copy SYSPEDS/qrpgsrcpy,prototypeb
      /copy SYSPEDS/qrpgsrcpy,usec
      /copy SYSPEDS/qrpgsrcpy,variables3

      * Varible for
     D WSUSER          S             10
     D TVAVD           S              4
     D TVTDN           S              7
     D DKEH_SYAV       S              4
     D DKEH_SYOP       S              7
     D JSONstring      S          32000
     D Error           S            150
      *get input-string
      /copy syspeds/qrpgsrcpy,prolog3

      * Parse input
     C                   EXSR      Parse
      * Open files etc
     C                   EXSR      INIT

     C                   CALLP     gethtmlifs(
     C                             '/syspeddev/html/JSON.html':
     C                             '/CGITAG/')
     C                   CALLP     wrtsection('top')
      * Teste input og utfør
     C                   IF        ERROR=*BLANKS
     C                   EXSR      TEST
     C                   ENDIF

      * ............................................................................................
      * skriv JSON-Object start..(alltid '{' + x ant param. m/komma mellom (IKKE komma etter siste))
      * ............................................................................................
      /free
        JSONstring='{'
        +'¬user¬ : ¬'+%trim(WSUSER)+'¬, '
        +'¬avd¬ : ¬'+%trim(tvavd)+'¬, '
        +'¬opd¬ : ¬'+%trim(tvtdn)+'¬, '
        +'¬dke_syav¬ : ¬'+%trim(dkeh_syav)+'¬, '
        +'¬dkeh_syopd¬ : ¬'+%trim(dkeh_syop)+'¬, '
        +'¬errMsg¬ : ¬'+%trim(Error)+'¬, ';
      /end-free
      * JSONfix escaper " i tekst,  for deretter å bytte ¬->"
     C                   CALL      'JSONFIX'
     C                   PARM                    JSONstring
     C                   CALLP     updHTMLvar('JSONstring':JSONstring)
     C                   CALLP     wrtsection('JSONlin')
      * ............................................................................................
      * Skriv JSON-LISTE Start (en liste er EN parameter(fra [ til   )
      * ............................................................................................
     C                   EVAL      JSONstring ='"kopangexp" : ['
     C                   CALLP     updHTMLvar('JSONstring':JSONstring)
     C                   CALLP     wrtsection('JSONlin')
      * ............................................................................................
      * Skriv JSON-Liste/Array  Avslutning
      * ............................................................................................
     C                   EVAL      JSONstring =']'
     C                   CALLP     updHTMLvar('JSONstring':JSONstring)
     C                   CALLP     wrtsection('JSONlin')
      * ............................................................................................
      * Skriv JSON-string Avsluttning
      * ............................................................................................
     C                   EVAL      JSONstring ='}'
     C                   CALLP     updHTMLvar('JSONstring':JSONstring)
     C                   CALLP     wrtsection('JSONlin')
     C                   EXSR      Exit
      *=====================================================================
      * Close output html and quit
      *=====================================================================
     C     EXIT          BEGSR

     C                   CLOSE     BRIDF

      * Do not delete the CALL to wrtsection with section name *fini.  It is needed
      * to ensure that all output html that has been buffered gets output.
     C                   CALLP     wrtsection('*fini')

     C                   EVAL      *INLR=*ON
     C                   ENDSR
      *********************************************************
     C     Parse         BEGSR
      *********************************************************
      * Get input
     C                   EVAL      WSUSER    = zhbgetvar('USER')
     C                   EVAL      TVAVD     = zhbgetvar('AVD')
     C                   EVAL      TVTDN     = zhbgetvar('OPD')
     C                   EVAL      DKEH_SYAV = zhbgetvar('DKEH_SYAV')
     C                   EVAL      DKEH_SYOP = zhbgetvar('DKEH_SYOP')
     C                   ENDSR
      *********************************************************
     C     INIT          BEGSR
      *********************************************************
     C                   OPEN      BRIDF                                50
      * Test innlogging
     C                   IF        *IN50=*OFF
     C     WSUSER        CHAIN     BRIDF                              50
     C     BILIBL        IFEQ      *blanks
     C                   CALLB     'INCGI'
     C                   PARM                    BISTDL
     C                   ELSE
     C                   CALL      BILIBL
     C                   ENDIF
     C                   ELSE
     C                   EVAL      Error = 'Can not open File'
     C                   ENDIF
     C                   BITON     '123457'      GRAAPP            1
     C                   BITOFF    '06'          GRAAPP

     C                   ENDSR
      *______________________________________________________
      * TEST                                             TEST
      *""""""""""""""""""""""""""""""""""""""""""""""""""""""
     C     TEST          BEGSR
      *  SBMJOB CMD(CALL PGM(TDCE091R2) PARM(TVAVD TVTDN DKEH_SYAV DKEH_SYOP)) JOBQ(SY400JOBQ)
      *
     C                   MOVEL(P)  'SBMJOB'      QCMDR           128
     C                   CAT       ' CMD(C':0    QCMDR
     C                   CAT       'ALL PG':0    QCMDR
     C                   CAT       'M(':0        QCMDR
     C                   CAT       'TDCE091R2':0 QCMDR
     C                   CAT       ') PARM':0    QCMDR
     C                   CAT       '(':0         QCMDR

     C                   CAT       GRAAPP:0      QCMDR
     C                   CAT       TVAVD:0       QCMDR
     C                   CAT       GRAAPP:0      QCMDR

     C                   CAT       GRAAPP:1      QCMDR
     C                   CAT       TVTDN:0       QCMDR
     C                   CAT       GRAAPP:0      QCMDR

     C                   CAT       GRAAPP:1      QCMDR
     C                   CAT       DKEH_SYAV:0   QCMDR
     C                   CAT       GRAAPP:0      QCMDR

     C                   CAT       GRAAPP:1      QCMDR
     C                   CAT       DKEH_SYOP:0   QCMDR
     C                   CAT       GRAAPP:0      QCMDR

     C                   CAT       '))':0        QCMDR
     C                   CAT       ' JOBD(':0    QCMDR
     C                   CAT       'SY400J':0    QCMDR
     C                   CAT       'OBD) J':0    QCMDR
     C                   CAT       'OBQ(SY':0    QCMDR
     C                   CAT       '400QER)':0   QCMDR
     C                   Z-ADD     128           QCMDLE           15 5
     C                   CALL      'QCMDEXC'                            3131
     C                   PARM                    QCMDR
     C                   PARM                    QCMDLE
     C                   ENDSR
