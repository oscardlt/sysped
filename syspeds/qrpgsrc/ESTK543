      *  Obs ! Kompiler med tillat error 20  GENLVL(20)    (decedit angitt 2 ganger-siste ignoreres)
      *********************************************************************
      *
CRTPG+*  CRTPGM SYSPED/ESTK543 MODULE(*LIBL/ESTK543 *LIBL/INCGI)
CRTPGM*         ACTGRP(*NEW) AUT(*USE)
      *
********************************************************************
      * RETTINGER I DETTE PROGRAM:
PTFnr:*Sek Sig Vers  Beskrivelse...........................
""""""*"""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""
10XXX * 01 JOV PTF11 Ved UKJENT USER kan en ikke kalle jsonfix (manglende libl..)
10XXX * 02 JOV PTF11 ta mot melding på Tur/oppdragsnivå
10XXX * 03 JOV PTF11 generell TKGPS
10XXX * 04 JOV PTF11 TKGPS samtidig som statuser   + feil variabel AntKollL=> AntKll
10XXX * 05 JOV PTF11 Konverter bilder  - Teknikken droppet !! 2015.03.16..
10XXX * 06 JOV PTF11 StartTid Lasting/Lossing  - event STL Start Loading./STU Start Unloading.
      * 07 JOV PTF11 Protect på oppdragets tot ved endr av vekt/vol mm (HEADF etter 201502xx)
      * 08 JOV PTF11 ved Avvis/brkreft mm - sjekk at sjåfør er samme(endre på kontoret??)
      * 09 JOV PTF11 Feltlengde terminal utvidet 20-> 50
Pxxxxx* 10 Jov PTF11 event-time&/dato kan ikke være fram i tid
      *%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
Pxxxxx* 11 Jov PTF12 motta sjåførangitt ny ETA
********************************************************************
     H decedit('0.')
TMP  H debug(*yes)
      /copy syspeds/qrpgsrcpy,hspecs
      /copy syspeds/qrpgsrcpy,hspecsbnd
     FBRIDF     IF   E           K DISK    USROPN
     FBRPARF    if   e           k disk    usropn
     FHeadf     UF   E           K DISK    usropn
     FFRISOK    IF A E           K DISK    Usropn
     FTRACKF    O  A E           K DISK    Usropn
N03  FTKGPS     O  A E             DISK    Usropn
     FTRACKT    UF A E           K DISK    Usropn
     FTKSGM     UF   E           K DISK    USROPN
      *********************************************************************
N02  FFREETXT1  IF A E           K DISK    USROPN
N02  FFREETUR1  IF A E           K DISK    USROPN
N02  FTURER14   IF   E           K DISK    USROPN
      *********************************************************************
      *--------------------------------------------------------------------
      * Variables common to all CGIs
      *--------------------------------------------------------------------
      /copy syspeds/qrpgsrcpy,prototypeb
      /copy syspeds/qrpgsrcpy,usec
      /copy syspeds/qrpgsrcpy,variables3
     D EnvString       s          32000
     D JSONstring      s          32000
      * Prototype
     D JSONescape      PR                  ExtPgm('JSONESC')
     D   JSONstr                  32000A
      * Indicators for GetHtmlIfsMult subprocedure
     D IfsMultIndicators...
     D                 ds
     D  NoErrors                       n
     D  NameTooLong                    n
     D  NotAccessible                  n
     D  NoFilesUsable                  n
     D  DupSections                    n
     D  FileIsEmpty                    n

      *
      * Client input variables
     D userId          s             10
     D UsrSpcName      s             10                                         =
     D SJA             s              8
     D SJN             s              8  0
     D VERSJ           s             10
     D Avd             s              4
     D AvdN            s              4  0
     D Opd             s              7
     D OpdN            s              7  0
     D Avd_Opd         s             12
     D Sendingsnr      s             17
     D AvvisningsKode  s             50
     D AvvisningsKomm  s             50
     D AVVIK           s             50
     D KOMM            s             50
     D VERSJON         s             10
     D StatNext        s              2
     D Svar            s              5
s09  D*HenTerm         s             20
s09  D*LevTerm         s             20
N09  D HenTerm         s             50
N09  D LevTerm         s             50
E04  D AntKll          s             10
     D LEVN            s              7  0
     D AntChgd         s              1
     D LM              s             10
     D LMN             s              4  2
     D LMChgd          s              1
     D Volum           s             10
     D VolumN          s              7  3
     D VolChgd         s              1
     D Vekt            s             10
     D VektN           s              9  0
     D VktChgd         s              1
     D Lat             s              9
     D Long            s             10
     D LatN            s              8  6
     D LonN            s              9  6
     D HenAnkLat       s              9
     D HenAnkLong      s             10
     D LevAnkLat       s              9
     D LevAnkLong      s             10
N06  D HenLasLat       s              9
N06  D HenLasLong      s             10
N06  D LevLosLat       s              9
N06  D LevLosLong      s             10
     D LatPos          s              9
     D LongPos         s             10
     D NumBig          s             19  9
     D LinTxt          s            500
     D HenKvit         s             50
     D LevKvit         s             50
     D HenSign         s          32000
     D LevSign         s          32000
N05  D*AvviksBilde     s          32000
N05  D*AntBilde        s              2  0
N05  D*AntBildeA       s              2
N05  D*BildTxt         s              9
N05  D*BildTxtE        s              9
     D GSMnr           s             15
     D GSMtxt          s            150
     D GSMcmd          s            150
     D ErrTxt          s            100
     D KrfChgd         s              1
N11  D gpsHenKl        s             20
N11  D gpsHenKod       s              1
N11  D gpsLevKl        s             20
N11  D gpsLevKod       s              1
     D ItemCount       s             10i 0
     D i               s             10i 0
     D i2              s             10i 0
N02  D MldRef          s             15
N02  D P_              s              5i 0
N02  D                 DS
N02  D  MLD                    1    210
N02  D  MLD1                   1     70
N02  D  MLD2                  71    140
N02  D  MLD3                 141    210
      * Definere  hex 0D / 25 (CRLF)
     D Hex0D           c                   x'0D'
     D Hex25           c                   x'25'
     D Appo            c                   x'7D'
      *
     D Spaces          s             12a   inz('&nbsp;&nbsp;')
     D                 DS
     D  DUP                    1   1100  0
     D                                     DIM(100)
     D                 DS
     D  AvdOpd                 1     11  0
     D   DsAvd                 1      4  0
     D   DsOpd                 5     11  0
     D                 DS
     D  Kunderef               1     20
     D  KR1_3                  1      3
     D  KR1_17                 1     17
     D  KR4_20                 4     20
     D  KR17                  17     17
     D  KR18_20               18     20
     D                 DS
     D  EventTs                1     15
     D    WDsDÅMD              1      8
     D    WDsDÅ                1      4
     D    WDsDM                5      6
     D    WDsDD                7      8
     D    WDsKlokke           10     15
     D    WDsTi               10     11
     D    WDsMi               12     13
     D                 DS
     D  TGIN02                 1     70
     D  TGIN02_9               1      9
     D                 DS
     D  TGIN03                 1     70
     D  TGIN03_9               1      9
     D                 DS
     D  TGIN04                 1     70
     D  TGIN04_9               1      9
     D                 DS
     D  HenAnkDt               1      8
     D  HenAnkKl              10     15
     D  HenAnkTid              1     15
     D                 DS
     D  LevAnkDt               1      8
     D  LevAnkKl              10     15
     D  LevAnkTid              1     15
     D                 DS
     D  PositionDt             1      8
     D  PositionKl            10     15
     D  PositionTS             1     15
N06  D                 DS
N06  D  HenLasDt               1      8
N06  D  HenLasKl              10     15
N06  D  HenLasTid              1     15
N06  D                 DS
N06  D  HenLasPosDt            1      8
N06  D  HenLasPosKl           10     15
N06  D  HenLasPosTS            1     15
N06  D                 DS
N06  D  LevLosDt               1      8
N06  D  LevLosKl              10     15
N06  D  LevLosTid              1     15
N06  D                 DS
N06  D  LevLosPosDt            1      8
N06  D  LevLosPosKl           10     15
N06  D  LevLosPosTS            1     15
     D                 DS
     D  TimeTmp                1     26
     D  TimeTmpÅ               1      4
     D  TimeTmpM               6      7
     D  TimeTmpD               9     10
     D  TimeTmpT              12     16
     D  TimeTmpTT             12     13
     D  TimeTmpTM             15     16
     D  TimeTmpTS             18     19
     D                 DS
     D  Idag                   1      8
     D  IdagTmpÅ               1      4
     D  IdagTmpM               5      6
     D  IdagTmpD               7      8
     D                 DS
     D  IdagTID                1      6
     D  IdagTT                 1      2
     D  IdagTM                 3      4
     D  IdagTTM                3      4
     D  IdagTS                 5      6
     D                 DS
     D  TID                    1     16
     D  Time1D                 1      2
     D  Time1P1                3      3
     D  Time1M                 4      5
     D  Time1P2                6      6
     D  Time1Å                 7     10
     D  Time1B                11     11
     D  Time1T                12     16
     D  Time1P3               14     14
     D                 DS
     D  TTTXTA                 1     70
     D  TXBY                   1     10
     D  XXSGM                 11     40
     D  TXWEBU                41     44
     D  XXWEBU                46     70
      *
      *
      /copy syspeds/qrpgsrcpy,prolog3
      *
      * Parse input / cvt to numeric
     C                   exsr      Parse
      * Read output skeleton html member into memory
     C                   exsr      LoadHtml
      * File open / keys
     C                   EXSR      INIT
      * Set section variables
     C                   exsr      SetAll
      * Quit
     C                   exsr      Exit
      *
     C                   eval      *inlr = *on
     C                   return
      *
      *
      *=====================================================================
      * Parse input / cvt to numeric
      *=====================================================================
     C     Parse         begsr
      * Parse variables from QUERY_STRING environment variable
      * Userid = PD+8 siffer (8 siffer er sjåførid)
     C                   eval      userId = zhbgetvar('userId')
     C                   move      userId        SJA
     C                   eval      SJN     = c2n2(SJA)
     C                   eval      VERSJON = zhbgetvar('V')
     C                   eval      AVD  = zhbgetvar('AVD')
     C                   eval      AVDN    = c2n2(AVD)
     C                   eval      OPD  = zhbgetvar('OPD')
     C                   eval      OPDN    = c2n2(OPD)
     c                   move      AVDN          AVD
     c                   move      OPDN          OPD
     c                   eval      AVD_OPD = AVD+'_'+OPD
      *
     C                   eval      Sendingsnr = ZhbGetVar('Sendingsnr')
     C                   eval      StatNext = ZhbGetVar('StatNext')
      * antall
E04  C                   eval      AntKll  = ZhbGetVar('AntKll')
E04  C                   eval      NumBig  = c2n2(AntKll)
     C     NumBig        ifle      9999999
     C                   eval      LevN    = NumBig
     C                   end
E04  c                   if        ZhbGetVarCnt('AntKll') > 0
     c                   eval      AntChgd = 'Y'
     c                   endif
      * Vekt
     C                   eval      Vekt    = ZhbGetVar('Vekt')
     C     '.':','       xlate     Vekt          Vekt
     C                   eval      NumBig  = c2n2(Vekt)
     C     NumBig        ifle      999999999
     C                   eval      VektN   = NumBig
     C                   end
     c                   if        ZhbGetVarCnt('Vekt') > 0
     c                   eval      VktChgd = 'Y'
     c                   endif
      * Volum
     C                   eval      Volum   = ZhbGetVar('Volum')
     C     '.':','       xlate     Volum         Volum
     C                   eval      NumBig  = c2n2(Volum)
     C     NumBig        ifle      9999.999
     C                   eval      VolumN  = NumBig
     C                   end
     c                   if        ZhbGetVarCnt('Volum') > 0
     c                   eval      VolChgd = 'Y'
     c                   endif
      * Lastemeter
     C                   eval      Lm      = ZhbGetVar('LM')
     C     '.':','       xlate     Lm            Lm
     C                   eval      NumBig  = c2n2(LM)
     C     NumBig        ifle      99.99
     C                   eval      LmN     = NumBig
     c                   end
     c                   if        ZhbGetVarCnt('LM') > 0
     c                   eval      LmChgd = 'Y'
     c                   endif
      * Kvit/ Kvitering (er signatur med karakterer )
     C                   eval      HenKvit  = ZhbGetVar('HenKvit')
     C                   eval      LevKvit  = ZhbGetVar('Levkvit')
      *  Sign/ Sgnatur   (er grafisk signatur med base64)
     C                   eval      HenSign  = ZhbGetVar('HenSign')
     C                   eval      LevSign  = ZhbGetVar('LevSign')
     c                   eval      EventTs = ZhbGetVar('EventTs')
N05  C*                  eval      AvviksBilde = ZhbGetVar('AvviksBilde')
     c                   eval      Svar   = ZhbGetVar('Svar')
     c                   eval      Kunderef= ZhbGetVar('Kunderef')
     c                   if        ZhbGetVarCnt('Kunderef') > 0
     c                   eval      KrfChgd = 'Y'
     c                   endif
      *
     c                   eval      HenTerm   = ZhbGetVar('HenTerm')
     c                   eval      LevTerm   = ZhbGetVar('LevTerm')
      * Timestamp for ankommet hente/lev.sted (evt lat/long knyttet til hendelsen)
     c                   eval      HenAnkTid = ZhbGetVar('HenAnkommetTs')
     c                   eval      HenAnkLat = ZhbGetVar('HenAnkLat')
     c                   eval      HenAnkLong= ZhbGetVar('HenAnkLong')
     c                   eval      LevAnkTid = ZhbGetVar('LevAnkommetTs')
     c                   eval      LevAnkLat = ZhbGetVar('LevAnkLat')
     c                   eval      LevAnkLong= ZhbGetVar('LevAnkLong')
N06   * Timestamp for startet  Lasting/Lossing  (evt lat/long knyttet til hendelsen)
N06  c                   eval      HenLasTid = ZhbGetVar('HenLastingTs')
N06  c                   eval      HenLasLat = ZhbGetVar('HenLastLat')
N06  c                   eval      HenLasLong= ZhbGetVar('HenLastLong')
N06  c                   eval      HenLasPosTS=ZhbGetVar('HenLastPositionTS')   (ubrukt)
N06   *
N06  c                   eval      LevLosTid = ZhbGetVar('LevLossingTs')
N06  c                   eval      LevLosLat = ZhbGetVar('LevLosLat')
N06  c                   eval      LevLosLong= ZhbGetVar('LevLosLong')
N06  c                   eval      LevLosPosTS=ZhbGetVar('LevLosPositionTS')    (ubrukt)
      *posisisjons-data (for TKflåtestyring.. )
     c                   eval      LatPos    = ZhbGetVar('Lat')
     c                   eval      LongPos   = ZhbGetVar('Long')
     c                   eval      PositionTS= ZhbGetVar('PositionTS')          (ubrukt)
      *
     C                   eval      UsrSpcName= zhbgetvar('sessionId')
     C                   eval      AvvisningsKode = zhbgetvar('AvvisningsKode')
     C                   eval      AvvisningsKomm =
     C                                         zhbgetvar('AvvisningsKommentar')
N02   * 'TEKSTMELDING ' KEY MldRef er enten avd_opd eller turnr    Eks=  80_201447
N02  C                   eval      Mld     = zhbgetvar('Mld')
N02  c                   if        Mld <> *blanks
N02  C                   eval      MldRef  = zhbgetvar('MldRef')
N02  c                   eval      P_ = %SCAN ('_' : MldRef)
N02  c                   if        P_ > 0
N02  c                   eval      Avd = %subst(MldRef:1:P_-1)
N02  c                   eval      Opd = %subst(MldRef:P_+1)
N02  C                   eval      AVDN    = c2n2(AVD)
N02  C                   eval      OPDN    = c2n2(OPD)
N02  c                   else
N02  C                   eval      FRTTUR  = c2n2(MldRef)
N02  c                   endif
N02  c                   endif
N02   *
N11  C                   eval      gpsHenKl  = zhbgetvar('gpsHenKl')
N11  C                   eval      gpsHenKod = zhbgetvar('gpsHenKod')
N11  C                   eval      gpsLevKl  = zhbgetvar('gpsHenKl')
N11  C                   eval      gpsLevKod = zhbgetvar('gpsHenKod')
TMP  c                   DUMP
     C                   endsr
      *=====================================================================
      * Close output html and quit
      *=====================================================================
      **************************************************
     C     Exit          begsr
      **************************************************
      * Do not delete the call to wrtsection with section name *fini.  It is needed
      * to ensure that all output html that has been buffered gets output.
     C                   callp     wrtsection('*fini')
      * Quit
     C                   CLOSE     BRIDF
     C                   CLOSE     BRPARF
     C                   CLOSE     HEADF
     C                   CLOSE     FRISOK
     C                   CLOSE     TRACKF
     C                   CLOSE     TRACKT
     C                   CLOSE     TKSGM
     C                   endsr
      *=====================================================================
      * Read output skeleton html member into memory
      *=====================================================================
     C     LoadHtml      begsr
     c                   callp     gethtmlifs(
     C                             '/syspeddev/html/JSON.html':
     C                             '/CGITAG/')
     C                   endsr
      *=====================================================================
      *  Set variable data for section /$top , lin , Bot
      *=====================================================================
     C     SetAll        begsr
      * Handling/loggføring utfra StatNext
n04  C     LatPos        ifne      *blanks                                      Pos til TKGPS
n04  C                   exsr      LATLONSR
n04  C                   endif
n04   *
     C                   select
N02  C     MLD           WHENNE    *blanks                                      Melding
N02  C                   exsr      MELDING
s04  C*    LatPos        WHENNE    *blanks                                      Pos til TKGPS
s04  C*                  exsr      LATLONSR
     C     StatNext      WHENEQ    '45'                                         Henting term
     C     StatNext      oreq      '50'                                         Henting kund
     C                   exsr      TTHent
     C     StatNext      WHENEQ    '60'                                         Levering
     C                   exsr      TTLevert
     C     StatNext      WHENEQ    '10'                                         Bekreft hent
     C     StatNext      oreq      '20'                                         Bekreft lev
     C     Svar          oreq      '*NEI*'                                      Avvis (+fj. fra tur)
     C     Svar          oreq      '*OPD*'                                      Avvis (løst oppdrag)
     C                   exsr      TTBekAvv
     C     StatNext      WHENEQ    '30'                                         Endring Lest hent
     C     StatNext      oreq      '40'                                         Endring Lest lev
     C                   exsr      TTLest
     C                   endsl
      *
      * Send section top
     C                   callp     wrtsection('top')
      *
      *  Resultat  (foreløpig ingen erroe uansett
      /free
        IF ErrTxt <> *blanks;
        JSONstring='{'
        +'¬result¬ : ¬FAILED¬,'
        +'¬error¬ : ¬'+%trim(ErrTxt)+'¬ }';
        callp JSONescape(JSONstring);
        updHTMLvar2('JSONstring':%addr(JSONstring):%len(JSONstring));
        wrtsection('JSONlin');
        else;
        JSONstring='{'
        +'¬result¬ : ¬OK¬ }';
        callp JSONescape(JSONstring);
        updHTMLvar2('JSONstring':%addr(JSONstring):%len(JSONstring));
        wrtsection('JSONlin');
        endif;
      /end-free
     C
     C                   endsr
N02   *=====================================================================******
N02   *  MELDING
N02   *=====================================================================******
N02  C     MELDING       begsr
N02   *
N02  C     TuFTmax       KLIST
N02  C                   KFLD                    FRTAVD
N02  C                   KFLD                    FRTTUR
N02  C                   KFLD                    FRTDT
N02  C                   KFLD                    XXTLI             2 0
N02  c                   z-add     99            XXTLI
N02  C     TuFTmaxE      KLIST
N02  C                   KFLD                    FRTAVD
N02  C                   KFLD                    FRTTUR
N02  C                   KFLD                    FRTDT
N02  C     SnFTmax       KLIST
N02  C                   KFLD                    FRTAVD
N02  C                   KFLD                    FRTOPD
N02  C                   KFLD                    FRTDT
N02  C                   KFLD                    XXTLI
N02  C     SnFTmaxE      KLIST
N02  C                   KFLD                    FRTAVD
N02  C                   KFLD                    FRTOPD
N02  C                   KFLD                    FRTDT
N02   *
N02  C                   movel     timedata1     TimeTmp
N02  C                   MOVE      TimeTmpÅ      IdagTmpÅ
N02  C                   MOVE      TimeTmpM      IdagTmpM
N02  C                   MOVE      TimeTmpD      IdagTmpD
N02   * Fjern evt CRLF
N02  C     Hex0D:' '     XLATE     Mld           Mld
N02  C     Hex25:' '     XLATE     Mld           Mld
N02   * Meld på turnivå
N02  c     FRTTUR        ifne      *zeros
N02  C                   open      Turer14
N02  C                   open      FREETUR1
N02   * finn avd..
N02  c     FRTTUR        Chain     TURER14                            33
N02  C     *IN33         cabeq     '1'           UtMeld
N02  c                   move      TUAVD         FRTAVD
N02  c                   MOVE      Idag          FRTDT
N02  c                   MOVE      *ZEROS        FRTLI
N02  C     TuFTmax       setgt     FREETUR1
N02  C     TuFTmaxE      readpe    FREETUR1                               33
N02  c                   add       1             FRTLI
N02  c                   MOVE      'P'           FRTKOD
N02  c                   MOVE      Idag          FRTDT
N02  c                   MOVE      *ZEROS        FRTFAK
N02  c                   eval      FRTTXT = Mld1
N02  c                   WRITE     FREETURR
N02  c     Mld2          Ifne      *Blanks
N02  c                   add       1             FRTLI
N02  c                   eval      FRTTXT = Mld2
N02  c                   WRITE     FREETURR
N02  c                   end
N02  c     Mld3          Ifne      *Blanks
N02  c                   add       1             FRTLI
N02  c                   eval      FRTTXT = Mld3
N02  c                   WRITE     FREETURR
N02  c                   end
N02  C                   close     FREETUR1
N02  C                   close     Turer14
N02  c                   else
N02   * Meld på sendingsnr
N02  c     Opdn          cabeq     *zeros        UtMeld
N02  c                   move      AvdN          FRTAVD
N02  c                   move      OpdN          FRTOPD
N02  C                   open      FREETXT1
N02  c                   MOVE      *ZEROS        FRTLI
N02  C     SnFTmax       setgt     FREETXT1
N02  C     SnFTmaxE      readpe    FREETXT1                               33
N02  c                   add       1             FRTLI
N02  c                   MOVE      'P'           FRTKOD
N02  c                   MOVE      Idag          FRTDT
N02  c                   MOVE      *ZEROS        FRTFAK
N02  c                   eval      FRTTXT = Mld1
N02  c                   WRITE     FREETXTR
N02  c     Mld2          Ifne      *Blanks
N02  c                   add       1             FRTLI
N02  c                   eval      FRTTXT = Mld2
N02  c                   WRITE     FREETXTR
N02  c                   end
N02  c     Mld3          Ifne      *Blanks
N02  c                   add       1             FRTLI
N02  c                   eval      FRTTXT = Mld3
N02  c                   WRITE     FREETXTR
N02  c                   end
N02  C                   close     FREETXT1
N02  c                   end
N02  C
N02  C     UtMeld        endsr
      *
     C***********************************************
     C     TTLevert      BEGSR
     C***********************************************
     c     HeadKey       Chain     Headf                              30
     c     *in30         ifeq      '0'
     c     Hesgm         IFEQ      *blanks
     c     Hesgm         oreq      'X'
     c     Hesgm         oreq      'LEVERT'
     C                   movel     LevKvit       HESGM
     C                   movel     WDsDÅMD       HEDTMO
     C                   movel     WDsKlokke     HEKLMO
     C                   movel     WDsDÅMD       TRSDTD
     C                   movel     WDsKlokke     TRSDTK
     C                   end
     C                   update    headfr
     C                   end
      * denne SR logger POD (TEI ved term på henting, TE2 ved TERM-annet(til Term på HO/VF))
     C                   MOVE      AvdN          TTAVD
     C                   MOVE      OpdN          TTOPD
     C                   MOVE      *zeros        TTFBNR
     C                   movel     timedata1     TimeTmp
     C                   MOVE      TimeTmpÅ      IdagTmpÅ
     C                   MOVE      TimeTmpM      IdagTmpM
     C                   MOVE      TimeTmpD      IdagTmpD
     C                   MOVE      Idag          TTDATL
     C                   MOVE      TimeTmpTT     IdagTT
     C                   MOVE      TimeTmpTM     IdagTM
     C                   MOVE      TimeTmpTS     IdagTS
     C                   MOVE      IdagTID       TTTIML
     C                   MOVEL     userId        TTUSER
      * Hvis Ank-tid er oppgitt legg det ut som egen datapost..
     c     LevAnkTid     ifne      *blanks
     C                   MOVE      LevAnkDt      TTDATE
     C                   MOVE      *ZEROS        TTTIME
     C                   MOVEL     LevAnkKl      TTTIME
     C                   MOVEL     LevAnkLat     Lat
     C                   MOVEL     LevAnkLong    Long
     C                   MOVE      'ARD'         TTACTI                         Arrived Delivery
     c                   exsr      LATLON
     C                   EVAL      TTTEXT = 'Arrived at delivery place.'
     C                   EVAL      TTTEXL = 'Ankommet leveringssted.'
     c     LatN          Ifne      *zeros
     c     LonN          andne     *zeros
     C                   EVAL      TTTEXT = %trim(TTTEXT) +
     c                             '  Lat: ' + %trim(%editc(LatN:'3')) +
     c                             '  Long: ' + %trim(%editc(LonN:'3'))
     C                   EVAL      TTTEXL = %trim(TTTEXL) +
     c                             '  Lat: ' + %trim(%editc(LatN:'3')) +
     c                             '  Long: ' + %trim(%editc(LonN:'3'))
     C                   end
     c                   move      'S'           TTMANU
     C                   WRITE     TRACKFR
     c                   exsr      DupOppd
     C                   end
N06   * Hvis Starttid Lasting er oppgitt legg det ut som egen datapost..
N06  c     LevLosTid     ifne      *blanks
N06  C                   MOVE      LevLosDt      TTDATE
N06  C                   MOVE      *ZEROS        TTTIME
N06  C                   MOVEL     LevLosKl      TTTIME
N06  C                   MOVEL     LevLosLat     Lat
N06  C                   MOVEL     LevLosLong    Long
N06  C                   MOVE      'STU'         TTACTI                         Started UnLoading
N06  c                   exsr      LATLON
N06  C                   EVAL      TTTEXT = 'Started unloading.'
N06  C                   EVAL      TTTEXL = 'Startet lossing..'
N06  c     LatN          Ifne      *zeros
N06  c     LonN          andne     *zeros
N06  C                   EVAL      TTTEXT = %trim(TTTEXT) +
N06  c                             '  Lat: ' + %trim(%editc(LatN:'3')) +
N06  c                             '  Long: ' + %trim(%editc(LonN:'3'))
N06  C                   EVAL      TTTEXL = %trim(TTTEXL) +
N06  c                             '  Lat: ' + %trim(%editc(LatN:'3')) +
N06  c                             '  Long: ' + %trim(%editc(LonN:'3'))
N06  C                   end
N06  c                   move      'S'           TTMANU
N06  C                   WRITE     TRACKFR
N06  c                   exsr      DupOppd
N06  C                   end
      *
     C                   MOVE      'POD'         TTACTI
     C                   MOVE      WDsDÅMD       TTDATE
     C                   MOVE      *ZEROS        TTTIME
     C                   MOVEL     WDsKlokke     TTTIME
     C                   MOVEL     'Signed by '  TXBY
     C                   MOVEL     LevKvit       XXSGM
     C                   MOVEL     HESGM         TTNAME
     C                   MOVEL     TTTXTA        TTTEXT
     C                   MOVEL     TTTXTA        TTTEXL
     c     LevTerm       ifne      *blanks
     C                   eval      TTTEXT = %trim(TTTEXT) +
     c                             ' at terminal '+LevTerm
     C                   eval      TTTEXL = %trim(TTTEXL) +
     c                             ' på terminal '+LevTerm
     c     HeadKey       Chain(N)  Headf                              30
     c     *in30         ifeq      '0'
     C     TRSLAG        IFEQ      'FF'
     C                   MOVE      'TEI'         TTACTI
     C                   else
     C                   MOVE      'TE2'         TTACTI
     C                   endif
     C                   end
     c                   movel     LevTerm       TTDEPO
     c                   end
      * ved POD legg på merknad hvis TOLLPASS
     c     TTACTI        ifeq      'POD'
     C                   exsr      TSTTP
     c                   endif
     c                   move      'S'           TTMANU
     C                   WRITE     TRACKFR
     c                   exsr      DupOppd
      * konverter base64-basert signatur
     c                   if        LevSign <> *blanks
     c                   if        TTACTI  = 'POD'
     c                   eval      Filename  = AVD_OPD+'.jpg'
     c                   else
     c                   eval      Filename  = TTACTI+'_'+AVD_OPD+'.jpg'
     c                   endif
     c                   eval      base64Inp = LevSign
     c                   eval      rc = docmd('ADDLIBLE LIBHTTP *LAST')
     c                   call      'ESTK543B'
     C                   PARM                    Filename        100
     C                   PARM                    Base64Inp     32000
     c                   endif
      *
N05   * konverter base64-basert avviksBilde
N05  c*                  if        avviksBilde <> *blanks
N05  c*                  eval      Antbilde = ZhbGetVarCnt('avviksBilde')
N05  c*                  move      AntBilde      AntBildeA
N05  c*                  eval      BildTxt  = 'Bilder:'+AntBildeA
N05  c*                  eval      BildTxtE = 'Photos:'+AntBildeA
N05  c*                  if        TTACTI  = 'POD'
N05  c*                  eval      Filename  = AVD_OPD+'_Bilde.jpg'
N05  c*                  else
N05  c*                  eval      Filename  = TTACTI+'_'+AVD_OPD+'_Bilde.jpg'
N05  c*                  endif
N05  c*                  eval      base64Inp = avviksBilde
N05  c*                  eval      rc = docmd('ADDLIBLE LIBHTTP *LAST')
N05  c*                  call      'ESTK543B'
N05  C*                  PARM                    Filename        100
N05  C*                  PARM                    Base64Inp     32000
N05  c*                  endif
      *
      * Actual time of ARRIVAL  i trackt
     c     LevTerm       ifeq      *blanks
     c     HeadKey       chain     Trackt                             33
     C     *in33         Ifeq      *OFF
     c                   move      WDsDÅMD       TXATAD
     c                   movel     WDsKlokke     TXATAK
     c                   update    tracktr
     C                   end
     C                   end
      * Logg evt avvik knyttet til hendelsen
     C                   exsr      AVVIKSR
      *
     C                   ENDSR
     C***********************************************
     C     TTHENT        BEGSR
     C***********************************************
      * denne SR logger COL (TEU ved henting på term)
     C                   MOVE      AvdN          TTAVD
     C                   MOVE      OpdN          TTOPD
     C                   MOVE      *ZEROS        TTFBNR
     C                   movel     timedata1     TimeTmp
     C                   MOVE      TimeTmpÅ      IdagTmpÅ
     C                   MOVE      TimeTmpM      IdagTmpM
     C                   MOVE      TimeTmpD      IdagTmpD
     C                   MOVE      Idag          TTDATL
     C                   MOVE      TimeTmpTT     IdagTT
     C                   MOVE      TimeTmpTM     IdagTM
     C                   MOVE      TimeTmpTS     IdagTS
     C                   MOVE      IdagTID       TTTIML
     C                   MOVEL     userId        TTUSER
     C                   MOVEL     userId        TTNAME
     C                   MOVE      *blanks       TTDEPO
      * Hvis Ank-tid er oppgitt legg det ut som egen datapost..
     c     HenAnkTid     ifne      *blanks
     C                   MOVE      HenAnkDt      TTDATE
     C                   MOVE      *ZEROS        TTTIME
     C                   MOVEL     HenAnkKl      TTTIME
     C                   MOVEL     HenAnkLat     Lat
     C                   MOVEL     HenAnkLong    Long
     C                   MOVE      'ARC'         TTACTI                         Arrived Collection
     c                   exsr      LATLON
     C                   EVAL      TTTEXT = 'Arrived at collection place.'
     C                   EVAL      TTTEXL = 'Ankommet hentestedet.'
     c     LatN          Ifne      *zeros
     c     LonN          andne     *zeros
     C                   EVAL      TTTEXT = %trim(TTTEXT) +
     c                             '  Lat: ' + %trim(%editc(LatN:'3')) +
     c                             '  Long: ' + %trim(%editc(LonN:'3'))
     C                   EVAL      TTTEXL = %trim(TTTEXL) +
     c                             '  Lat: ' + %trim(%editc(LatN:'3')) +
     c                             '  Long: ' + %trim(%editc(LonN:'3'))
     C                   end
     c                   move      'S'           TTMANU
     C                   WRITE     TRACKFR
     c                   exsr      DupOppd
     C                   end
N06   * Hvis Starttid Lasting er oppgitt legg det ut som egen datapost..
N06  c     HenLasTid     ifne      *blanks
N06  C                   MOVE      HenLasDt      TTDATE
N06  C                   MOVE      *ZEROS        TTTIME
N06  C                   MOVEL     HenLasKl      TTTIME
N06  C                   MOVEL     HenLasLat     Lat
N06  C                   MOVEL     HenLasLong    Long
N06  C                   MOVE      'STL'         TTACTI                         Started Loading
N06  c                   exsr      LATLON
N06  C                   EVAL      TTTEXT = 'Started loading.'
N06  C                   EVAL      TTTEXL = 'Startet lasting..'
N06  c     LatN          Ifne      *zeros
N06  c     LonN          andne     *zeros
N06  C                   EVAL      TTTEXT = %trim(TTTEXT) +
N06  c                             '  Lat: ' + %trim(%editc(LatN:'3')) +
N06  c                             '  Long: ' + %trim(%editc(LonN:'3'))
N06  C                   EVAL      TTTEXL = %trim(TTTEXL) +
N06  c                             '  Lat: ' + %trim(%editc(LatN:'3')) +
N06  c                             '  Long: ' + %trim(%editc(LonN:'3'))
N06  C                   end
N06  c                   move      'S'           TTMANU
N06  C                   WRITE     TRACKFR
N06  c                   exsr      DupOppd
N06  C                   end
      *
     C                   MOVE      'COL'         TTACTI
     C                   MOVE      WDsDÅMD       TTDATE
     C                   MOVE      *ZEROS        TTTIME
     C                   MOVEL     WDsKlokke     TTTIME
     c     HenTerm       ifeq      *blanks
     C                   eval      TTTEXT = 'Collected at customer'
     C                   eval      TTTEXL = 'Hentet hos kunden'
     c                   else
     C                   MOVE      'TEU'         TTACTI
     C                   EVAL      TTTEXT = 'Departed terminal ' +%trim(HenTerm)
     C                   EVAL      TTTEXL = 'Avgått terminal ' +%trim(HenTerm)
     C                   MOVEL     HenTerm       TTDEPO
     c                   end
     c                   if        HenKvit <> *blanks
     C                   eval      TTTEXT = %trim(TTTEXT)+ ' Signed by:'+HenKvit
     C                   eval      TTTEXL = %trim(TTTEXL)+ ' Signert av:'
     c                                    +HenKvit
     c                   endif
     c                   move      'S'           TTMANU
     C                   WRITE     TRACKFR
     c                   exsr      DupOppd
      * konverter base64-basert signatur
     c                   if        HenSign <> *blanks
     c                   eval      Filename  = TTACTI+'_'+AVD_OPD+'.jpg'
     c                   eval      base64Inp = HenSign
     c                   eval      rc = docmd('ADDLIBLE LIBHTTP *LAST')
     c                   call      'ESTK543B'
     C                   PARM                    Filename        100
     C                   PARM                    Base64Inp     32000
     c                   endif
      *
      * OPPDATER ACTUAL TIME TIME OF DEPARTURE
     c     HenTerm       ifeq      *blanks
     c     HeadKey       chain     Trackt                             33
     C     *in33         Ifeq      *OFF
     c                   move      WDsDÅMD       TXATDD
     c                   movel     WDsKlokke     TXATDK
     c                   update    tracktr
     c     HeadKey       chain     Headf                              33
     C     *in33         Ifeq      *OFF
     C                   movel     WDsDÅMD       TRSDFD
     C                   movel     WDsKlokke     TRSDFK
     c                   update    headfr
     C                   end
     C                   end
     c                   end
      * Logg evt avvik knyttet til hendelsen
     C                   exsr      AVVIKSR
      *
      *
      * Endringer i antall /vekt volum....
     C                   IF        AntChgd='Y' or VktChgd='Y'
     C                             or VolChgd='Y' or LMChgd='Y'
     C     HeadKey       Chain     Headf                              33
     C     *IN33         IFEQ      *OFF
N07  C                   MOVE      'P'           HESTL4                         Protect Totaler
     C                   MOVE      'CHG'         TTACTI
     C                   eval      TTTEXT = 'Changed'
     C                   eval      TTTEXL = 'Endret'
     C     AntChgd       IFEQ      'Y'
     C                   eval      TTTEXT = %trim(TTTEXT) +' Cll:'+
     C                             %trim(%editc(HENT:'3'))+'->'+
     C                             %trim(%editc(LevN:'3'))
     C                   eval      TTTEXL = %trim(TTTEXL) +' Cll:'+
     C                             %trim(%editc(HENT:'3'))+'->'+
     C                             %trim(%editc(LevN:'3'))
     C                   eval      HENT  = LevN
     C                   END
     C     VktChgd       IFEQ      'Y'
     C                   eval      TTTEXT = %trim(TTTEXT) +' Wt:'+
     C                             %trim(%editc(HEVKT:'3'))+'->'+
     C                             %trim(%editc(VektN:'3'))
     C                   eval      TTTEXL = %trim(TTTEXL) +' Vkt:'+
     C                             %trim(%editc(HEVKT:'3'))+'->'+
     C                             %trim(%editc(VektN:'3'))
     C                   eval      HEVKT = VektN
     C                   END
     C     VolChgd       IFEQ      'Y'
     C                   eval      TTTEXT = %trim(TTTEXT) +' Vol:'+
     C                             %trim(%editc(HEM3:'L'))+'->'+
     C                             %trim(%editc(VolumN:'L'))
     C                   eval      TTTEXL = %trim(TTTEXL) +' Vol:'+
     C                             %trim(%editc(HEM3:'L'))+'->'+
     C                             %trim(%editc(VolumN:'L'))
     C                   eval      HEM3  = VolumN
     C                   END
     C     LMChgd        IFEQ      'Y'
     C                   eval      TTTEXT = %trim(TTTEXT) +' Lm:'+
     C                             %trim(%editc(HELM:'L'))+'->'+
     C                             %trim(%editc(LmN:'L'))
     C                   eval      TTTEXL = %trim(TTTEXL) +' Lm:'+
     C                             %trim(%editc(HELM:'L'))+'->'+
     C                             %trim(%editc(LmN:'L'))
     C                   eval      HELM  = LmN
     C                   END
     C                   WRITE     TRACKFR
      * burde logges også på ande i DUP-kjeden ????
     c*??????            exsr      DupOppd
      *
     C     TKSGMKey      CHAIN     TKSGM                              35
     C     *in35         IFEQ      '0'
     C                   move      HENT          TGNT
     C                   move      HEVKT         TGVKT
     C                   move      HELM          TGLM
     C                   move      HEM3          TGM3
     C  N35              update    TKSGMR
     C                   END
     C                   END
     C                   Update    HEADFR
     C                   END

      * oppdater hentetidspkt dersom det ligger i Fritekst (info2, 3, eller 4 )
      *
     C     TKSGMKey      CHAIN     TKSGM                              35
     C     *in35         IFEQ      '0'
     c                   select
     c                   when      TGIN02_9='H/L-Tid: '
     c                   eval      TGIN02='H/L-Tid: '
     c                             +WDsDD+'.'+WDsDM+' '+WDsTi+':'+WDsMi
     c                             +%subst(TGIN02:21:20)                        fra og med /...
     c
     c                   when      TGIN03_9='H/L-Tid: '
     c                   eval      TGIN03='H/L-Tid: '
     c                             +WDsDD+'.'+WDsDM+' '+WDsTi+':'+WDsMi
     c                             +%subst(TGIN03:21:20)                        fra og med /...
     c
     c                   when      TGIN04_9='H/L-Tid: '
     c                   eval      TGIN04='H/L-Tid: '
     c                             +WDsDD+'.'+WDsDM+' '+WDsTi+':'+WDsMi
     c                             +%subst(TGIN04:21:20)                        fra og med /...
     C                   endsl
     C  N35              update    TKSGMR
     C                   endif
      *KUNDEREF
      * e/02.38 sendes Kunderef alltid fordi avs_opd nå er nøkkel/Tksign kan ikke sammenligne med gm
     C     KundeRef      ifne      *blanks
     C                   Move      *blanks       Snd17            20
     C                   Move      *blanks       FSSOK
     C                   SELECT
     C     KR1_3         WHENEQ    '401'
     C                   Movel     KR4_20        Snd17
     C     KR17          WHENNE    ' '
     C     KR18_20       andeq     *blanks
     C                   Movel     KR1_17        Snd17
     C                   endsl
     c     Snd17         ifeq      *blanks
     C                   move      'ORD'         FSKODE
     C                   movel     KundeRef      FSSOK
     c                   else
     C                   move      'IFB'         FSKODE
     C                   movel     Snd17         FSSOK
     C     IFBkey        Chain     FRISOK                             33
     c     *IN33         cabeq     '0'           UtHent
     c                   end
     C                   move      Heavd         FSAVD
     C                   move      Heopd         FSOPD
     C                   move      HedtOp        FSDtOp
     c                   write     frisokr
     C                   end
     C     Uthent        ENDSR
     C***********************************************
     C     AVVIKSR       BEGSR
     C***********************************************
      * PDA sender kun de avvik som ikke er sendt før..
     c                   if        ZhbGetVarCnt('AvviksKode') > 0
      *
     C                   eval      ItemCount = ZhbGetVarCnt('AvviksKode')
     C                   eval      i = 1
     C     i             DOUGT     ItemCount
     C                   eval      Avvik =  ZhbGetVar('AvviksKode':i)
     C                   eval      KOMM  =  ZhbGetVar('Kommentar':i)
     C                   exsr      AVVIKSR2
     C                   eval      i = i + 1
     c                   enddo
      *
     c                   endif
      *
     C                   endsr
     C***********************************************
     C     AVVIKSR2      BEGSR
     C***********************************************
     C                   MOVE      AvdN          TTAVD
     C                   MOVE      OpdN          TTOPD
     C                   MOVE      *zeros        TTFBNR
     C                   MOVE      'AVV'         TTACTI
     C                   MOVEL     userId        TTUSER
     C                   MOVE      *blanks       TTTEXT
     C                   MOVE      *blanks       TTTEXL
     C     AVVIK         Ifne      *blanks
     C     AVVIK         CAT       '/':1         TTTEXT
     C                   CAT       KOMM:1        TTTEXT
     C     AVVIK         CAT       '/':1         TTTEXL
     C                   CAT       KOMM:1        TTTEXL
     c                   else
     C                   Movel     KOMM          TTTEXT
     C                   Movel     KOMM          TTTEXL
     c                   end
N05  c*                  if        BildTxt<>*blanks
N05  c*                  eval      TTTEXT = %trim(TTTEXT)+BildTxtE
N05  c*                  eval      TTTEXL = %trim(TTTEXL)+BildTxt
N05  c*                  endif
      *
     c                   move      'S'           TTMANU
     C                   WRITE     TRACKFR
     c                   exsr      DupOppd
      *
     C                   ENDSR
      *
     C***********************************************
     C     TTBekAvv      BEGSR
     C***********************************************
      * Type = N (bekrefte Ny eller avvise NY/GML ordre fra PDA)
      * BEKREFTE NY ordre (v/Svar=*JA*), eller avvise-Ny/GML-(v/Svar= *NEI* el *OPD*)
      * Dersom svar=*OPD* er det et LØST OPPDRAG (skal ikke ta av tur...)
     C     HeadKey       Chain(N)  Headf                              33
N08   * sjekk om sjåføren er korrekt sjåfør på turen - hvi sikke har han ikke lov....
N08  C                   open      Turer14
N08  C     HEPRO         chain     Turer14                            33
N08  C                   close     Turer14
N08  C  N33TUSJA1        ifne      SJN
N08  c                   goto      UtBekAvv
N08  c                   endif
     C     TKSGMKey      CHAIN     TKSGM                              35
     C                   MOVE      AvdN          TTAVD
     C                   MOVE      OpdN          TTOPD
     C                   MOVE      *ZEROS        TTFBNR
      * Svar= *JA* = BEKREFTER ny ordre
     C     Svar          Ifeq      '*JA*'
     C  N35              MOVE      'B'           TGKOH                          Bekreftet
     C  N35              UPDATE    TKSGMR
     C                   MOVE      'NJA'         TTACTI
     C                   eval      TTTEXT = 'New order accepted by driver'
     C                   eval      TTTEXL = 'Ny ordre akseptert av sjåfør'
     c                   else
      * Svar= *NEI* eller *OPD*(Løst oppdrag) = Avvis / fjern
     C  N35              DELETE    TKSGMR                                       Fjern også i logg
     C                   MOVE      'NEI'         TTACTI
      * LØST oppdrag på PDA..
     C     Svar          Ifeq      '*OPD*'
     C                   eval      TTTEXT = 'Removed from PDA by driver. '+
     C                             %trim(AvvisningsKode) + ' ' +
     C                             %trim(AvvisningsKomm)
     c                             +' (standalone order)'
     C                   eval      TTTEXL = 'Fjernet fra PDA av sjåfør. '+
     C                             %trim(AvvisningsKode) + ' ' +
     C                             %trim(AvvisningsKomm)
     c                             +' (frittstående opd)'
     C                   else
     c                   MOVE      HEPRO         HEPROA            8
     C                   eval      TTTEXT = 'Rejected by driver: '+
     C                             %trim(AvvisningsKode) + ' ' +
     C                             %trim(AvvisningsKomm) +
     C                             ' Rmvd from ' + HEPROA
     C                   eval      TTTEXL = 'Avvist av sjåfør: '+
     C                             %trim(AvvisningsKode) + ' ' +
     C                             %trim(AvvisningsKomm) +
     C                             ' Fjernet fra ' + HEPROA
     C                   eval      TTDEPO  = 'T:'+ HEPROA                       (v/laaang reason..)
     C                   Call      'SYGE21B'
     C                   PARM                    HEPRO
     C                   PARM                    HEAVD
     C                   PARM                    HEOPD
     C                   PARM                    UFLAGG            1
     C                   end
     c                   end
     C                   movel     timedata1     TimeTmp
     C                   MOVE      TimeTmpÅ      IdagTmpÅ
     C                   MOVE      TimeTmpM      IdagTmpM
     C                   MOVE      TimeTmpD      IdagTmpD
     C                   MOVE      Idag          TTDATL
     C                   MOVE      TimeTmpTT     IdagTT
     C                   MOVE      TimeTmpTM     IdagTM
     C                   MOVE      TimeTmpTS     IdagTS
     C                   MOVE      IdagTID       TTTIML
     C                   MOVE      Idag          TTDATE
     C                   MOVE      *ZEROS        TTTIME
     C                   MOVEL     IdagTID       TTTIME
     C                   MOVEL     userId        TTUSER
     C                   MOVEL     userId        TTNAME
     c                   move      ' '           TTMANU
     C     TTACTI        ifeq      'NEI'
     c                   move      'S'           TTMANU
     c                   end
     C                   WRITE     TRACKFR
      * avvisning av oppdrag logges også på andre i kjeden
     C     TTACTI        ifeq      'NEI'
     c                   exsr      DupOppd
     c                   endif
E08  C     UtBekAvv      ENDSR
      *
     C***********************************************
     C     TTLest        BEGSR
     C***********************************************
     C     HeadKey       Chain(N)  Headf                              33
     C     TKSGMKey      CHAIN     TKSGM                              35
     C  N35              MOVE      'B'           TGKOH
     C  N35              UPDATE    TKSGMR
     C                   MOVE      AvdN          TTAVD
     C                   MOVE      OpdN          TTOPD
     C                   MOVE      *ZEROS        TTFBNR
     C                   MOVE      'CHR'         TTACTI
     C                   eval      TTTEXT = 'Changes on order read by driver'
     C                   eval      TTTEXL = 'Endring på ordre lest av sjåfør'
     C                   movel     timedata1     TimeTmp
     C                   MOVE      TimeTmpÅ      IdagTmpÅ
     C                   MOVE      TimeTmpM      IdagTmpM
     C                   MOVE      TimeTmpD      IdagTmpD
     C                   MOVE      Idag          TTDATL
     C                   MOVE      TimeTmpTT     IdagTT
     C                   MOVE      TimeTmpTM     IdagTM
     C                   MOVE      TimeTmpTS     IdagTS
     C                   MOVE      IdagTID       TTTIML
     C                   MOVE      Idag          TTDATE
     C                   MOVE      *ZEROS        TTTIME
     C                   MOVEL     IdagTID       TTTIME
     C                   MOVEL     userId        TTUSER
     C                   MOVEL     userId        TTNAME
     C                   WRITE     TRACKFR
      * changes read by driver logges IKKE på andre i DUP-kjeden
      *                  exsr      DupOppd
     C                   ENDSR
      *
      **************************************************************************
     C     DupOppd       begsr
      **************************************************************************
     C                   MOVE      'KOP'         TTEDRE                         KOPI FRA ANNET...
     c                   movel     AvdN          AvdOpdN          11 0
     c                   move      OpdN          AvdOpdN
      * Dupliser hendelse til alle oppdrag i "DUP-struktur"
     c     1             do        100           Nr
     c     Dup(Nr)       cabeq     *zeros        UtDupArr
     c                   move      Dup(Nr)       AvdOpd
     c     AvdOpd        ifne      AvdopdN
     C                   MOVE      TTAVD         TmpAVD            4 0
     C                   MOVE      TTOPD         TmpOPD            7 0
     C                   MOVE      DsAvd         TTAVD
     C                   MOVE      DsOpd         TTOPD
     C                   WRITE     TRACKFR
     C                   MOVE      TmpAVD        TTAVD
     C                   MOVE      TmpOPD        TTOPD
      * dersom POD oppdater også oppdrag....
     C                   ENDIF
     c                   enddo
     C     UtDupArr      tag
     C                   MOVE      *BLANKS       TTEDRE                         EVENT PÅ DETTE ..
     C                   ENDSR
      **************************************************
     C     TSTTP         begsr
      **************************************************
     C     TKSGMKey      CHAIN(N)  TKSGM                              35
     c     *IN35         ifeq      '0'
     c                   if        (%subst(TGin01:1:9)='TOLLPASS!')
     c                             or (%subst(TGin02:1:9)='TOLLPASS!')
     c                             or (%subst(TGin03:1:9)='TOLLPASS!')
     c                             or (%subst(TGin04:1:9)='TOLLPASS!')
     c                             or (%subst(TGin05:1:9)='TOLLPASS!')
     c                             or (%subst(TGin06:1:9)='TOLLPASS!')
     c                             or (%subst(TGin07:1:9)='TOLLPASS!')
     c                             or (%subst(TGin08:1:9)='TOLLPASS!')
     c                             or (%subst(TGin09:1:9)='TOLLPASS!')
     c                             or (%subst(TGin10:1:9)='TOLLPASS!')
     c                   eval      TTTEXT = %trim(TTTEXT)+', TOLLPASS!'
     c                   eval      TTTEXL = %trim(TTTEXL)+', TOLLPASS!'
     c                   endif
     c                   endif
      *
     C                   ENDSR
      *
      **************************************************
     C     INIT          begsr
      **************************************************
     C                   time                    timedata1
     C                   movel     timedata1     TimeTmp
      * HTTP_.... = headers , men grier ikke å hente privte headers
     C                   eval      EnvString  =getenv('HTTP_X-Test':
     C                             qusec)
     C                   eval      EnvString  =getenv('HTTP_Content-Type':
     C                             qusec)
     C                   eval      EnvString  =getenv('HTTP_CONTENT-TYPE':
     C                             qusec)
     C                   eval      EnvString  =getenv('HTTP_CONNECTION':
     C                             qusec)
     C                   eval      EnvString  =getenv('HTTP_DATE':
     C                             qusec)
      *
     C                   eval      EnvString  =getenv('REQUEST_METHOD':
     C                             qusec)
     C                   eval      EnvString  =getenv('CONTENT_TYPE':
     C                             qusec)
     C                   eval      EnvString  =getenv('QUERY_STRING':
     C                             qusec)
     C                   OPEN      BRIDF
     C     userId        CHAIN     BRIDF                              50
      * Ukjent UserID
     c     *in50         ifeq      '1'
     C                   close     BRIDF
      /free
        wrtsection('top');

        JSONstring='{'
        +'"userId" : "'+%trim(userId)+'", '
        +'"error" : "UnKnown UserID" ';
        JSONstring='}';
        updHTMLvar2('JSONstring':%addr(JSONstring):%len(JSONstring));
        wrtsection('JSONlin');

        wrtsection('*fini');
      /end-free
     C                   eval      *inlr = *on
     C                   return
     c                   endif
     C* En "standardvariant" libl: call bound (INCGI=*MODULE) med parameter.
     C     BILIBL        ifeq      *blanks
     C                   callb     'INCGI'
     C                   parm                    BISTDL
     C                   else
     C* Helt egen bibl.liste satt på user - normal CALL (BILIBL er "*pgm")
     C                   call      BILIBL
     C                   end
     C                   OPEN      BRPARF
     C                   OPEN      HEADF
     C                   OPEN      FRISOK
     C                   OPEN      TRACKF
     C                   OPEN      TRACKT
     C                   OPEN      TKSGM
     C     HeadKey       KLIST
     C                   KFLD                    AvdN
     C                   KFLD                    OpdN
     C     IFBKey        KLIST
     C                   KFLD                    AvdN
     C                   KFLD                    OpdN
     C                   KFLD                    FSKODE
     C                   KFLD                    FSSOK
      *
     C     TKSGMKey      KLIST
     C                   KFLD                    HEPRO
     C                   KFLD                    Xblank            1
     C                   KFLD                    HEAVD
     C                   KFLD                    HEOPD
     C     FiParKey      klist
     C                   kfld                    FIBRID
     C                   kfld                    PAKUNR
     C                   kfld                    PAID
     C                   movel     '*KUNDFT*'    FIBRID           10
     C                   move      BIFIRM        FIBRID
      *
     C     DsHeaKey      KLIST
     C                   KFLD                    DsAVD
     C                   KFLD                    DsOPD
     C     HEAKY0        KLIST
     C                   KFLD                    TRAVD0
     C                   KFLD                    TROPD0
      * Finn ut om oppdraget er en del av en "DUP-struktur" - legg alle i ARRAY
     C* Hent opp ingangsoppdraget
     C     HeadKey       CHAIN(N)  HEADF                              33
      * FINN TOPP-NIVÅET
     C     TROPD0        DOWNE     0
     C     HEAKY0        CHAIN     HEADF                              33
     C                   ENDDO
     C* Legg inn topp-oppdraget som start i array
     c                   clear                   DUP
     c                   z-add     1             Nr                3 0
     c                   movel     heavd         Dup(Nr)
     c                   move      heopd         Dup(Nr)
     c     1             do        100           Cur               3 0
     c     Dup(Cur)      cabeq     *zeros        UtAdd
     c                   move      Dup(Cur)      AvdOpd
     C     DSHeaKey      CHAIN     HEADF                              33
     C  N33TrOpd1        IFNE      *ZEROS
     C                   add       1             Nr
     c                   movel     TrAvd1        Dup(Nr)
     c                   move      TrOpd1        Dup(Nr)
     C                   ENDIF
     C  N33TrOpd2        IFNE      *ZEROS
     C                   add       1             Nr
     c                   movel     TrAvd2        Dup(Nr)
     c                   move      TrOpd2        Dup(Nr)
     C                   ENDIF
     c                   enddo
     C     UtAdd         tag
      *
     C                   ENDSR
      *
     C***********************************************
     C     LATLON        BEGSR
     C***********************************************
     C     '.':','       xlate     Lat           Lat
     C     '.':','       xlate     Long          Long
     C                   eval      LatN    = 0
     C                   eval      LonN    = 0
     C                   eval      NumBig  = c2n2(Lat)
     c     NumBig        Ifge      -90
     c     NumBig        andle     90
     C                   eval      LatN    = NumBig
     c                   end
     C                   eval      NumBig  = c2n2(Long)
     c     NumBig        Ifge      -180
     c     NumBig        andle     180
     C                   eval      LONN    = NumBig
     c                   end
     C                   ENDSR
      *
N03   *************************************************
N03  C     LATLONSR      begsr
N03   *************************************************
N03   *
N02  C                   movel     timedata1     TimeTmp
N02  C                   MOVE      TimeTmpÅ      IdagTmpÅ
N02  C                   MOVE      TimeTmpM      IdagTmpM
N02  C                   MOVE      TimeTmpD      IdagTmpD
     C                   MOVE      TimeTmpTT     IdagTT
     C                   MOVE      TimeTmpTM     IdagTM
     C                   MOVE      TimeTmpTS     IdagTS
N03   *
N03  C                   open      TKGPS
N03  C                   MOVE      userId        TKBRID
N03  c     PositionDt    ifne      *zeros
N03  C                   MOVE      PositionDt    TKDT
N03  C                   MOVE      PositionKl    TKTI
N03  c                   else
N03  C                   MOVE      Idag          TKDT
N03  C                   MOVE      IdagTid       TKTI
N03  c                   endif
N03  C                   MOVE      Idag          TKDTL
N03  C                   MOVE      IdagTid       TKTIL
N03  C                   MOVEL     LatPos        Lat
N03  C                   MOVEL     LongPos       Long
N03  c                   exsr      LATLON
N03  C                   eval      TKBRE  = LATN
N03  C                   eval      TKLEN  = LONN
N10  C                   IF        TKDT <= TKDTL
N03  C                   write     TKGPSR
N10  C                   ENDIF
N03   *
N03  C                   close     TKGPS
N03  C
N03  C                   endsr
